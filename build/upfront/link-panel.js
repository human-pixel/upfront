(function(e){define(["text!scripts/upfront/templates/link-panel.html"],function(t){var n=Backbone.View.extend({tpl:_.template(t),defaultLinkTypes:{unlink:!0,external:!0,entry:!0,anchor:!0,image:!1,lightbox:!0},events:{"click .js-ulinkpanel-ok":"linkOk","click .js-ulinkpanel-input-entry":"openPostSelector","keydown .js-ulinkpanel-lightbox-input":"checkCreateLightbox"},initialize:function(e){var t=e.linkTypes||{};this.linkTypes=_.extend({},this.defaultLinkTypes,t);if(!this.model||this.model.get("type")===!1||this.model.get("type")===undefined)this.model=new Backbone.Model({type:"unlink",url:""});this.theme=e.theme||"dark",this.button=e.button||!1},render:function(){var e=this,t=this.anchors||this.getAnchors(),n={link:this.model.toJSON(),theme:this.theme,checked:'checked="checked"',lightboxes:this.getLightBoxes(),button:this.button,type:this.model.get("type")};this.setCurrentClass(this.model.get("type")),this.$el.html(this.tpl(n));var r=[];_.each(this.linkTypes,function(e,t){if(!e)return;r.push(this.getLinkTypeValue(t))},this),this.typeSelect=new Upfront.Views.Editor.Field.Select({label:"",values:r,default_value:this.model.get("type")||"unlink",change:function(){e.model.set({url:""}),e.model.set({type:this.get_value()}),this.get_value()=="entry"&&e.openPostSelector(),e.render()}}),this.typeSelect.render(),this.$el.find("form").prepend(this.typeSelect.el);if(this.model.get("type")=="anchor"){var i=[{label:"Choose Anchor...",value:""}];_.each(this.getAnchors(),function(e){i.push({label:e.label,value:e.id})});var s=this.model.get("url");s=s?s:"",s=s.match(/^#/)?s:"",this.anchorSelect=new Upfront.Views.Editor.Field.Select({label:"",values:i,default_value:s,change:function(){e.model.set({url:this.get_value()})}}),this.anchorSelect.render(),this.$el.find(".anchor-selector").append(this.anchorSelect.el)}if(this.model.get("type")=="lightbox"&&this.getLightBoxes()){var o=[{label:"Choose Lightbox...",value:""}];_.each(this.getLightBoxes()||[],function(e){o.push({label:e.label,value:e.id})});var u=this.model.get("url");u=u?u:"",u=u.match(/^#/)?u:"",this.lightboxSelect=new Upfront.Views.Editor.Field.Select({label:"",values:o,default_value:u,change:function(){e.model.set({url:this.get_value()})}}),this.lightboxSelect.render(),this.$el.find(".lightbox-selector").append(this.lightboxSelect.el)}this.delegateEvents()},delegateEvents:function(e){this.typeSelect&&this.typeSelect.delegateEvents(),this.anchorSelect&&this.anchorSelect.delegateEvents(),this.lightboxSelect&&this.lightboxSelect.delegateEvents(),Backbone.View.prototype.delegateEvents.call(this,e)},getLinkTypeValue:function(e){var t=Upfront.Settings.l10n.global.content;switch(e){case"unlink":return{value:"unlink",label:t.no_link};case"external":return{value:"external",label:t.url};case"entry":return{value:"entry",label:t.post_or_page};case"anchor":return{value:"anchor",label:t.anchor};case"image":return{value:"image",label:t.larger_image};case"lightbox":return{value:"lightbox",label:t.lightbox}}},linkOk:function(e){e&&e.preventDefault();var t=this.getCurrentValue();if(t.type=="lightbox"&&this.$(".js-ulinkpanel-new-lightbox").is(":visible"))return this.createLightBox();this.model.set(t,{silent:!0}),this.trigger("link:ok",t)},changeType:function(e){var t=this.getCurrentLinkType();this.$(".js-ulinkpanel-input-url").hide(),t&&this.$(".js-ulinkpanel-input-"+t).show(),this.setCurrentClass(t),e&&(this.trigger("link:typechange",t),t=="entry"&&this.openPostSelector())},getCurrentValue:function(){var e=this.getCurrentLinkType(),t=this.getTypeUrl(e);return{type:e,url:t}},getCurrentLinkType:function(){return this.model.get("type")||"unlink"},getTypeUrl:function(e){var t;switch(e){case"unlink":return"";case"external":case"entry":return t=this.$("#ulinkpanel-link-url").val(),t.match(/https?:\/\//)||t.match(/\/\/:/)?t:"http://"+t;case"anchor":return this.model.get("url");case"image":return"#";case"lightbox":return this.model.get("url")}return this.$("#ulinkpanel-link-url").val()},getAnchors:function(){var e=Upfront.Application.layout.get("regions"),t=[],n=function(e){e.each(function(e){e.get("objects")?e.get("objects").each(function(e){var n=e.get_property_value_by_name("anchor");n&&n.length&&t.push({id:"#"+n,label:n})}):e.get("modules")&&n(e.get("modules"))})};return e.each(function(e){n(e.get("modules"))}),this.anchors=t,t},openPostSelector:function(e){e&&e.preventDefault(),this.trigger("link:postselector");var t=this,n={postTypes:this.postTypes()};Upfront.Views.Editor.PostSelector.open(n).done(function(e){var n={url:e.get("permalink"),type:"entry"};t.model.set(n),t.render(),t.trigger("link:postselected",n,e)})},postTypes:function(){var e=[];return _.each(Upfront.data.ugallery.postTypes,function(t){t.name!="attachment"&&e.push({name:t.name,label:t.label})}),e},getLightBoxes:function(){var e=[],t=Upfront.Application.layout.get("regions");return _.each(t.models,function(t){t.attributes.sub=="lightbox"&&e.push({id:"#"+t.get("name"),label:t.get("title")})}),e},checkCreateLightbox:function(e){e.which==13&&(e.preventDefault(),this.createLightBox())},createLightBox:function(){var t=e.trim(this.$(".js-ulinkpanel-lightbox-input").val());if(!t)return Upfront.Views.Editor.notify(l10n.ltbox_empty_name_nag,"error"),!1;var n=Upfront.Application.LayoutEditor.createLightboxRegion(t),r="#"+n;this.model.set({url:r,type:"lightbox"}),this.render(),this.linkOk()},setCurrentClass:function(e){this.$el.attr("class","ulinkpanel ulinkpanel-"+this.theme+" ulinkpanel-selected-"+e)}});return n})})(jQuery);