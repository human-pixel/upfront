define(["scripts/upfront/settings/modules/base-module","scripts/upfront/settings/fields/show-state","scripts/upfront/preset-settings/state-settings"],function(e,t,s){var i=Upfront.Settings.l10n.preset_manager,n=e.extend({className:"preset_specific",initialize:function(e){this.options=e||{},this.listenTo(this.model,"change",this.onPresetUpdate);var n=this,o=!1,r=!1,a=[];a=Upfront.Application.get_current()!==Upfront.Application.MODE.THEME&&this.options.model.get("theme_preset")===!0||"default"===this.options.model.get("id")||!Upfront.Application.user_can("DELETE_PRESET")?Upfront.Application.get_current()===Upfront.Application.MODE.THEME||"default"!==this.options.model.get("id")&&this.options.model.get("theme_preset")!==!0||!Upfront.Application.user_can("MODIFY_PRESET")?[]:[new Upfront.Views.Editor.Field.Button({model:this.model,label:"Reset",className:"delete_preset",compact:!0,on_click:function(){n.resetPreset()}})]:[new Upfront.Views.Editor.Field.Button({model:this.model,label:i.delete_label,className:"delete_preset",compact:!0,on_click:function(){confirm("Are you sure to delete this preset?")&&n.deletePreset()}})],Upfront.Application.user_can("MODIFY_PRESET")&&(_.each(this.options.stateModules,function(e,t){if("Global"===t){var i=new s({model:this.model,modules:e,state:t});a.push(i)}},this),_.each(this.options.stateModules,function(e,s){if("Global"!==s){var i=new t({state:s});a.push(i),this.listenTo(i,"upfront:presets:state_show",this.showState),o||(o=i)}},this),_.each(this.options.stateModules,function(e,t){if("Global"!==t){var i=new s({model:this.model,modules:e,state:t});a.push(i),r?i.$el.hide():r=i}},this),setTimeout(function(){n.$el.find(".state_settings_button").wrapAll('<div class="state_settings_button_wrapper">');var e=n.$el.find(".state_settings_button_wrapper");e.prev().hasClass("delete_preset")&&e.addClass("move-wrapper-top")},50)),o&&o.$el.addClass("active"),r&&r.$el.show(),this.fields=_(a)},onPresetUpdate:function(){if(!Upfront.Application.user_can("MODIFY_PRESET"))return!1;var e=this.checkRenderRequired();this.trigger("upfront:presets:update",this.model.toJSON(),e)},checkRenderRequired:function(){var e=_.pairs(this.model.changedAttributes())[0],t=[];if("undefined"!=typeof e[0])return"undefined"!=typeof this.panel&&"undefined"!=typeof this.panel.renderRequiredFields&&(t=this.panel.renderRequiredFields),!!_.contains(t,e[0])},deletePreset:function(){return!!Upfront.Application.user_can("DELETE_PRESET")&&void this.trigger("upfront:presets:delete",this.model)},resetPreset:function(){return!!Upfront.Application.user_can("DELETE_PRESET")&&void this.trigger("upfront:presets:reset",this.model)},showState:function(e){this.$el.find(".state_settings_button").removeClass("active"),this.$el.find(".state_settings_button_"+e).addClass("active"),this.$el.find(".state_settings").hide(),this.$el.find(".state_settings_"+e).show(),this.trigger("upfront:presets:state_show",e)}});return n});