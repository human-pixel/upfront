(function(e){define(["elements/upfront-newnavigation/js/menu-util","scripts/upfront/settings/modules/menu-structure/menu-item","text!scripts/upfront/settings/modules/menu-structure/menu-structure.tpl"],function(t,n,r){var i=Upfront.Settings.l10n.preset_manager,s=Backbone.View.extend({className:"settings_module menu_structure_module clearfix",handlesSaving:!0,events:{"mouseenter .menu-item-header":"enableSorting","mouseleave .menu-item-header":"disableSorting","click .add-menu-item":"addItem"},initialize:function(e){var t=this;this.options=e||{},this.listenTo(this.model.get("properties"),"change",function(){t.setup(),t.render()}),this.setup(),this.$el.sortable({axis:"y",items:".menu-structure-module-item",start:function(e,n){t.watchItemDepth(n.item)},stop:function(e,n){t.stopWatchingItemDepth(n.item),t.updateItemsPosition(n.item)}}),this.disableSorting()},setup:function(){var e=this;this.menuId=this.model.get_property_value_by_name("menu_id"),this.menuItems=[],this.menuItemViews=[],this.menu=t.getMenuById(this.menuId);if(this.menuId===!1)return;Upfront.Util.post({action:"upfront_new_load_menu_array",data:this.menuId}).success(function(t){e.menuItems=t.data||[],_.each(e.menuItems,function(t){e.menuItemViews.push(new n({model:new Backbone.Model(t),menuId:e.menuId}))}),e.render()}).error(function(e){Upfront.Util.log("Error loading menu items")})},render:function(){var e=this,t;this.$el.html(r);if(this.menuId===!1)return;t=this.$el.find(".menu-structure-body"),_.each(this.menuItemViews,function(e){t.append(e.render().el)})},enableSorting:function(){this.$el.sortable("enable")},disableSorting:function(){this.$el.sortable("disable")},watchItemDepth:function(e){var t=this,n;this.$el.on("mousemove",function(r){if(_.isUndefined(n)){n=r.pageX;return}t.updateItemDepth(n,r.pageX,e),n=r.pageX})},updateItemDepth:function(e,t,n){var r=n.data("menu-item-depth"),i=n.prev().data("menu-item-depth"),s=n.nextAll().not(".ui-sortable-placeholder").first().data("menu-item-depth"),o=r;e>t&&this.decreaseItemDepth(o-1,r,i,s,n),e<t&&this.increaseItemDepth(o+1,r,i,s,n)},decreaseItemDepth:function(e,t,n,r,i){n<t&&r<t&&(i.data("menu-item-depth",e),i.removeClass("menu-structure-item-depth-"+t),i.addClass("menu-structure-item-depth-"+e)),n===t&&r<t&&(i.data("menu-item-depth",e),i.removeClass("menu-structure-item-depth-"+t),i.addClass("menu-structure-item-depth-"+e))},increaseItemDepth:function(e,t,n,r,i){n>=t&&(i.data("menu-item-depth",e),i.removeClass("menu-structure-item-depth-"+t),i.addClass("menu-structure-item-depth-"+e)),n===t&&r<t&&(i.data("menu-item-depth",e),i.removeClass("menu-structure-item-depth-"+t),i.addClass("menu-structure-item-depth-"+e))},stopWatchingItemDepth:function(){this.$el.off("mousemove")},flattenItem:function(e){var t=this,n=[e];return e.sub&&_.each(e.sub,function(e){n=_.union(n,t.flattenItem(e))}),n},updateItemsPosition:function(t){var n=this,r=[];_.each(this.menuItems,function(e){r=_.union(r,n.flattenItem(e))});var i=this.$el.find(".menu-structure-module-item"),s=[],o=[0],u=0,a=1,f=0;i.each(function(){var t=_.findWhere(r,{"menu-item-object-id":e(this).data("menuItemObjectId")}),n=e(this).data("menuItemDepth");n>f?(o.push(u),f+=1):n!==f&&n<f&&(o=_.initial(o),f-=1),s.push(_.extend(t,{"menu-item-parent-id":_.last(o)||0,"menu-item-position":a})),a+=1,u=t["menu-item-object-id"]}),Upfront.Util.post({action:"upfront_update_menu_items",data:{items:s,menuId:this.menuId}}).fail(function(e){Upfront.Util.log("Failed saving menu items.")})},addItem:function(){var e=this,t={"menu-item-object":"custom","menu-item-parent-id":0,"menu-item-position":1,"menu-item-target":"","menu-item-title":"New Item","menu-item-type":"custom","menu-item-url":""};Upfront.Util.post({action:"upfront_update_single_menu_item",menuId:this.menuId,menuItemData:t}).done(function(r){t["menu-item-db-id"]=r.data.itemId,t["menu-item-object-id"]=r.data.itemId+"",e.menuItemViews.unshift(new n({model:new Backbone.Model(t),menuId:e.menuId})),e.render(),Upfront.Util.post({action:"upfront_update_single_menu_item",menuId:e.menuId,menuItemData:t})}).fail(function(e){Upfront.Util.log("Failed saving menu items.")})},save_fields:function(){}});return s})})(jQuery);