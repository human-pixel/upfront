!function(e,t){var l=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;define(["scripts/upfront/upfront-views-editor/sidebar/sidebar-panel-settings-item","scripts/upfront/upfront-views-editor/fonts","scripts/upfront/upfront-views-editor/commands/command-open-font-manager","scripts/upfront/upfront-views-editor/fields"],function(t,n,i,o){return t.extend({fields:{},current_element:"h1",elements:["h1","h2","h3","h4","h5","h6","p","a","a:hover","ul","ol","blockquote","blockquote.upfront-quote-alternative"],inline_elements:["a","a:hover"],typefaces:{},styles:{},sizes:{},colors:{},line_heights:{},initialize:function(){var l=this;t.prototype.initialize.call(this);var i=n.Google.get_fonts();i&&i.state&&e.when(i).done(function(){l.render()}),this.listenTo(Upfront.Events,"upfront:render_typography_sidebar",this.render),this.listenTo(Upfront.Events,"entity:object:after_render",this.update_typography_elements),this.listenTo(Upfront.Events,"theme_colors:update",this.update_typography_elements,this)},on_render:function(){var t=this,s=e('<div class="upfront-typography-fields-left" />'),a=e('<div class="upfront-typography-fields-right" />'),r=this.model.get_property_value_by_name("typography"),h=_.findWhere(Upfront.Application.current_subapplication.get_layout_data().properties,{name:"typography"}),p={};h=h?h.value:p;var f,c,d;if(_.isEmpty(r))if(_.contains(["tablet","mobile"],this.model.get("id"))||"big-tablet"===this.model.get("name"))switch(d="big-tablet"===this.model.get("name")?"big-tablet":this.model.get("id")){case"big-tablet":r=_.clone(h);break;case"tablet":f=breakpoints_storage.get_breakpoints().findWhere({name:"big-tablet"}),r=_.isUndefined(f)||_.isUndefined(f.get("typography"))||_.isUndefined(f.get("typography").h2)?h:_.clone(f.get("typography"));break;case"mobile":c=breakpoints_storage.get_breakpoints().findWhere({id:"tablet"}),r=_.isUndefined(c)||_.isUndefined(c.get("typography"))||_.isUndefined(c.get("typography").h2)?_.clone(h):_.clone(c.get("typography"))}else r=h||p;this.typography=r,Upfront.mainData.global_typography=r;var u,g=Upfront.Application.get_current(),y=Upfront.Settings.Application.MODE.THEME,m=Upfront.mainData.userDoneFontsIntro,v=g===y&&!m||g!==y&&0===n.theme_fonts_collection.length&&!m;return u=v?new o.Button({label:l.select_fonts_to_use,compact:!0,classname:"open-theme-fonts-manager",on_click:function(e){Upfront.Events.trigger("command:themefontsmanager:open")}}):new i,0===n.theme_fonts_collection.length&&Upfront.mainData.userDoneFontsIntro===!1?(this.$el.html('<p class="sidebar-info-notice upfront-icon">'+l.no_defined_fonts+"</p>"),u.render(),void this.$el.append(u.el)):(_.each(r,function(e,l){t.typefaces[l]=e.font_face,t.colors[l]=e.color,t.styles[l]=n.Model.get_variant(e.weight,e.style),e.size&&(t.sizes[l]=e.size),e.line_height&&(t.line_heights[l]=e.line_height)}),this.fields.length||(this.fields={start_font_manager:u,element:new o.Select({label:l.type_element,default_value:"h1",values:[{label:l.h1,value:"h1"},{label:l.h2,value:"h2"},{label:l.h3,value:"h3"},{label:l.h4,value:"h4"},{label:l.h5,value:"h5"},{label:l.h6,value:"h6"},{label:l.p,value:"p"},{label:l.a,value:"a"},{label:l.ahover,value:"a:hover"},{label:l.ul,value:"ul"},{label:l.ol,value:"ol"},{label:l.bq,value:"blockquote"},{label:l.bqalt,value:"blockquote.upfront-quote-alternative"}],change:function(){var l=this.get_value(),n=_.contains(t.inline_elements,l);t.current_element=l,t.fields.typeface.set_value(t.typefaces[l]),t.update_styles_field(),n?e([t.fields.size.el,t.fields.line_height.el]).hide():(e([t.fields.size.el,t.fields.line_height.el]).show(),t.fields.size.set_value(t.sizes[l]),t.fields.line_height.set_value(t.line_heights[l]||"1.1")),t.fields.color.set_value(t.colors[l]),t.fields.color.update_input_border_color(t.colors[l])}}),typeface:new o.Typeface_Chosen_Select({label:l.typeface,values:n.theme_fonts_collection.get_fonts_for_select(),default_value:t.typefaces.h1,select_width:"225px",change:function(){var e=this.get_value(),l=t.current_element;t.typefaces[l]!=e&&(t.typefaces[l]=e,t.styles[l]=n.Model.get_default_variant(e),t.update_typography(),t.update_styles_field())}}),style:this.get_styles_field(),color:new Upfront.Views.Editor.Field.Color({label:l.color,default_value:t.colors.h1,autoHide:!1,spectrum:{choose:function(e){var l=e.toRgb(),n="rgba("+l.r+","+l.g+","+l.b+","+e.alpha+")",i=t.current_element;n=e.get_is_theme_color()!==!1?e.theme_color:n,t.colors[i]!=n&&(t.colors[i]=n,t.update_typography(e))}}}),size:new o.Number({label:l.size,min:0,max:100,suffix:l.px,default_value:t.sizes.h1,change:function(){var e=this.get_value(),l=t.current_element;t.sizes[l]!=e&&(t.sizes[l]=e,t.update_typography())}}),line_height:new o.Number({label:l.line_height,min:0,max:10,step:.1,default_value:t.line_heights.h1,change:function(){var e=this.get_value(),l=t.current_element;t.line_heights[l]!=e&&(t.line_heights[l]=e,t.update_typography())}})}),this.$el.html(""),this.$el.addClass("typography-panel"),_.each(this.fields,function(e){e.render(),e.delegateEvents()}),this.$el.append([this.fields.start_font_manager.el,this.fields.element.el,this.fields.typeface.el]),e(".upfront-chosen-select",this.$el).chosen({width:"230px"}),s.append([this.fields.style.el,this.fields.size.el]),this.$el.append(s),a.append([this.fields.color.el,this.fields.line_height.el]),this.$el.append(a),void this.update_typography(void 0,!0))},update_styles_field:function(){this.fields.style.remove(),this.fields.style=this.get_styles_field(this.typefaces[this.current_element]),this.fields.style.render(),this.fields.style.delegateEvents(),e(".upfront-typography-fields-left").prepend(this.fields.style.el)},get_styles_field:function(e){var t=this;return new o.Typeface_Style_Chosen_Select({label:l.weight_style,values:this.get_styles(),default_value:t.get_styles_field_default_value(),font_family:e,select_width:"120px",change:function(){var e=this.get_value(),l=t.current_element;t.styles[l]!=e&&(t.styles[l]=e,t.update_typography())},show:function(e){t.fields.style.set_option_font(e)}})},get_styles_field_default_value:function(){var e,t=this.get_styles(),l=this.typefaces[this.current_element],i=this.styles[this.current_element];return e=i?i:l?n.Model.get_default_variant(l):"regular","regular"===e&&!_.findWhere(t,{value:"regular"})&&_.findWhere(t,{value:"400 normal"})?e="400 normal":"400 normal"===e&&!_.findWhere(t,{value:"400 normal"})&&_.findWhere(t,{value:"regular"})&&(e="regular"),"italic"===e&&!_.findWhere(t,{value:"italic"})&&_.findWhere(t,{value:"400 italic"})?e="400 italic":"400 italic"===e&&!_.findWhere(t,{value:"400 italic"})&&_.findWhere(t,{value:"italic"})&&(e="italic"),e},get_styles:function(){var e,t=this.typography,l=this.current_element,i=[];return!1===t&&(t={}),(_.isUndefined(t[l])||_.isUndefined(t[l].font_face))&&(t[l]={font_face:"Arial"}),e=n.theme_fonts_collection.get_variants(t[l].font_face),i=[],_.each(e,function(e){i.push({label:e,value:e})}),i},update_typography:function(t,l){var i=this,o=[],s=[],a={};if(_.each(this.elements,function(t){var l,r,h,p,f=[],c=_.contains(i.inline_elements,t),d=i.typefaces[t],u=!1,g=!1,y=!1,m=!1;e(".upfront-object-content "+t);if(h=n.Model.parse_variant(i.styles[t]||"regular"),y=h.weight,g=h.style,""===d&&(r=n.System.get_fonts().models[0]),_.isUndefined(r)&&(r=n.System.get_fonts().findWhere({family:d})),_.isUndefined(r)&&(r=n.theme_fonts_collection.get_additional_font(d)),_.isUndefined(r)){var v=n.Google.get_fonts();if(v&&v.findWhere&&(r=v.findWhere({family:d})),!r)return!0;l="//fonts.googleapis.com/css?family="+r.get("family").replace(/ /g,"+"),400!==parseInt(""+y,10)&&"inherit"!==y&&(l+=":"+y),e("head").append('<link href="'+l+'" rel="stylesheet" type="text/css" />')}u='"'+r.get("family")+'",'+r.get("category"),"inherit"!==u&&f.push("font-family: "+u),"inherit"!==y&&f.push("font-weight: "+y),"inherit"!==g&&f.push("font-style: "+g),c||(f.push("font-size: "+i.sizes[t]+"px"),f.push("line-height: "+i.line_heights[t]+"em")),!_.isEmpty(i.colors[t])&&Upfront.Views.Theme_Colors.colors.is_theme_color(i.colors[t])?p=Upfront.Views.Theme_Colors.colors.get_css_class(i.colors[t]):f.push("color: "+i.colors[t]),m="blockquote"===t?".upfront-object-content blockquote, .upfront-object-content blockquote p":"a"===t?".upfront-object-content a, .upfront-object-content a:link, .upfront-object-content a:visited":"h1"===t||"h2"===t||"h3"===t||"h4"===t||"h5"===t||"h6"===t?".upfront-object-content "+t+", .upfront-object-content "+t+" a, .upfront-ui "+t+".tag-list-tag":".upfront-object-content "+t+", .upfront-ui "+t+".tag-list-tag",o.push(m+"{ "+f.join("; ")+"; }"),_.contains(["tablet","mobile"],i.model.get("id"))&&s.push(m.replace(/\.upfront-object-content/g,"."+i.model.get("id")+"-breakpoint .upfront-object-content")+" { "+f.join("; ")+"; }"),a[t]={weight:y,style:g,size:c?!1:i.sizes[t],line_height:c?!1:i.line_heights[t]||"1.1",font_face:r.get("family"),font_family:r.get("category"),color:i.colors[t],theme_color_class:p}}),this.update_typography_elements(),l||(this.model.set_property("typography",a),this.typography=a),_.contains(["tablet","mobile"],this.model.get("id"))){var r=this.model.get("id")+"-breakpoint-typography",h=s.join("\n");e("#"+r).length?e("#"+r).html(h):e("body").find("style").first().before('<style id="'+r+'">'+h+"</style>")}else e("head").find("#upfront-default-typography-inline").length?e("head").find("#upfront-default-typography-inline").html(o.join("\n")):e('<style id="upfront-default-typography-inline">'+o.join("\n")+"</style>").insertAfter(e("head").find('link[rel="stylesheet"]').first())},update_typography_elements:function(t){var l=this,n=[],i=!1;i=e("style#typography-colors"),i.length||(e("body").append('<style id="typography-colors" />'),i=e("style#typography-colors")),_.each(this.elements,function(e){l.colors[e]&&n.push(".upfront-object-content "+e+"{ color:"+Upfront.Util.colors.to_color_value(l.colors[e])+"; }")}),i.empty().append(n.join("\n"))}})})}(jQuery,Backbone);