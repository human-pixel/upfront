!function(){var e=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;define(["scripts/upfront/upfront-views-editor/region/region-panel-item","scripts/upfront/upfront-views-editor/fields","text!upfront/templates/region_add_panel.html"],function(t,o,n){return t.extend({width:24,height:24,events:{click:"add_region_modal"},className:"upfront-inline-panel-item upfront-region-panel-item-add-region",icon:function(){var e=this.options.to;if(!e.match(/^(top|bottom)-(left|right)$/))return"add add-"+e},tooltip:function(){var t=this.options.to;switch(t){case"bottom":var o=e.new_region_below;break;case"left":var o=e.new_sidebar_region;break;case"right":var o=e.new_sidebar_region;break;case"top":var o=e.new_region_above;break;case"top-left":case"top-right":case"bottom-left":case"bottom-right":var o=e.add_floating_region}return o},tooltip_pos:function(){var e=this.options.to;switch(e){case"bottom":var t="top";break;case"left":case"top-left":case"bottom-left":var t="right";break;case"right":case"top-right":case"bottom-right":var t="left";break;case"top":var t="bottom"}return t},initialize:function(e){this.options=e,this.options.to||(this.options.to="top"),this.options.width&&(this.width=this.options.width),this.options.height&&(this.height=this.options.height)},add_region_modal:function(t){var i=this.options.to,r=this,a=new Modal({to:this.panel_view.panels_view.$el,button:!0,width:422}),s=("left"==i||"right"==i)&&"global"==r.model.get("scope"),l=r.$el.parents(".upfront-region-center");l.addClass("upfront-region-editing-modal"),l.next().find(".upfront-icon-control-region-resize").hide(),fields={from:new o.Radios({name:"from",default_value:"new",layout:"horizontal-inline",values:[{label:e.new_region,value:"new"},{label:e.choose_global_region,value:"global",disabled:s}],change:function(){var e=this.get_value();r.from=e}}),region_title:new o.Text({name:"name",placeholder:e.region_name_placeholder,focus:function(){fields.from.set_value("new"),fields.from.trigger("changed")},change:function(){var e=this.get_value();r.region_title=e}}),make_global:new o.Checkboxes({name:"make_global",multiple:!1,values:[{label:e.make_this_region_global,value:1}],focus:function(){fields.from.set_value("new"),fields.from.trigger("changed")},change:function(){var e=this.get_value();r.make_global=1==e?!0:!1}}),from_region:new o.Select({name:"from_region",values:[{label:Upfront.Settings.l10n.global.behaviors.loading,value:""}],disabled:s,focus:function(){fields.from.set_value("global"),fields.from.trigger("changed")},change:function(){var e=this.get_value();r.from_region=e}})},from_region_values=function(){var t=[],o="top"==i||"bottom"==i,n="left"==i||"right"==i;return t.push({label:e.select_global_region,value:"",disabled:!0}),_.each(Upfront.data.global_regions,function(e){if(!(o&&e.container&&e.name!=e.container||n&&"left"!=e.sub&&"right"!=e.sub)){var i=r.model.collection,a=i.get_by_name(e.name);t.push({label:e.title,value:e.name,disabled:a!==!1})}}),t},a.render(),this.panel_view.panels_view.$el.append(a.$el),this.from="new",this.region_title="",this.make_global=!1,this.from_region="",Upfront.data.global_regions?fields.from_region.options.values=from_region_values():Upfront.Util.post({action:"upfront_list_scoped_regions",scope:"global",storage_key:_upfront_save_storage_key}).done(function(e){Upfront.data.global_regions=e.data,fields.from_region.options.values=from_region_values(),fields.from_region.render(),fields.from_region.delegateEvents()}),a.open(function(e,t){var o=_.template(n,{});_.each(fields,function(e,t){e.render(),e.delegateEvents()}),t.addClass("upfront-add-region-modal"),e.append(o),e.find(".upfront-add-region-choice").append(fields.from.$el),e.find(".upfront-add-region-new").append(fields.region_title.$el),s||e.find(".upfront-add-region-new").append(fields.make_global.$el),e.find(".upfront-add-region-global").append(fields.from_region.$el)},this).done(function(e){"new"!=r.from&&r.from_region?r.add_region_from_global(r.from_region):r.add_region()}).always(function(e){l.removeClass("upfront-region-editing-modal"),l.next().find(".upfront-icon-control-region-resize").show(),e.remove()}),t.stopPropagation()},add_region:function(){var e=this.options.to,t=this.model.collection,o=(t.size()-1,t.indexOf(this.model)),n=this.model.get("position"),i=this.model.get_sub_regions(),r="top"==e||"bottom"==e,a="top"==e||"left"==e,s=this.region_title?this.region_title.replace(/[^A-Za-z0-9\s_-]/g,""):r?"Region ":this.model.get("title")+" "+e.charAt(0).toUpperCase()+e.slice(1),l=s.toLowerCase().replace(/\s/g,"-"),g=t.get_by_name(l)||!this.region_title&&r?t.get_new_title(s,1):!1,d=g!==!1?g.title:s,f=g!==!1?g.name:l,p=new Upfront.Models.Region(_.extend(_.clone(Upfront.data.region_default_args),{name:f,container:r?f:this.model.get("name"),title:d})),m={},c=function(e){return e&&e.cid?t.indexOf(e):-1};if(r){p.set_property("row",Upfront.Util.height_to_row(300));var h=_.filter(_.map(i,c),function(e){return e>=0}),u=i.fixed.length>0?_.map(i.fixed,c):[];h=_.union(h,u,[o]),h.length>0&&("top"==e?o=_.min(h):"bottom"==e&&(o=_.max(h))),this.make_global&&p.set({scope:"global"})}else p.set_property("col",5),"left"==e||"right"==e?(p.set("sub",a?"left":"right"),p.set("position",a?n-1:n+1),m.sub=a?"left":"right"):("top-left"==e||"top-right"==e||"bottom-left"==e||"bottom-right"==e)&&(p.set("type","fixed"),p.set("sub","fixed"),p.set_property("width",225),p.set_property("height",225),e.match(/^top/)&&p.set_property("top",30),e.match(/^bottom/)&&p.set_property("bottom",30),e.match(/left$/)&&p.set_property("left",30),e.match(/right$/)&&p.set_property("right",30),p.set_property("background_type","color"),p.set_property("background_color","#aeb8c2"),m.sub="fixed"),this.make_global?p.set({scope:"global"}):p.set({scope:this.model.get("scope")});p.get("clip")||!r?(Upfront.Events.once("entity:region:before_render",this.before_animation,this),Upfront.Events.once("entity:region:added",this.run_animation,this)):(Upfront.Events.once("entity:region_container:before_render",this.before_animation,this),Upfront.Events.once("entity:region:added",this.run_animation,this)),p.add_to(t,a?o:o+1,m);var b=t.where({type:"wide"});b.length>0&&$("div.upfront-regions a#no_region_add_one").remove()},add_region_from_global:function(e){var t=this,o=this.options.to,n=this.model.collection,i=(n.size()-1,n.indexOf(this.model)),r=(this.model.get("position"),this.model.get_sub_regions()),a="top"==o||"bottom"==o,s="top"==o||"left"==o,l=function(e){return e&&e.cid?n.indexOf(e):-1};if(a){var g=_.filter(_.map(r,l),function(e){return e>=0}),d=r.fixed.length>0?_.map(r.fixed,l):[];g=_.union(g,d,[i]),g.length>0&&("top"==o?i=_.min(g):"bottom"==o&&(i=_.max(g)))}a?(Upfront.Events.once("entity:region_container:before_render",this.before_animation,this),Upfront.Events.once("entity:region:added",this.run_animation,this)):(Upfront.Events.once("entity:region:before_render",this.before_animation,this),Upfront.Events.once("entity:region:added",this.run_animation,this)),Upfront.Util.post({action:"upfront_get_scoped_regions",scope:"global",name:e,storage_key:_upfront_save_storage_key}).done(function(e){var r=e.data,a=!1,l=[],g=function(){_.each(l,function(e){e.model.add_to(n,e.index,e.options)})};_.each(r,function(e,n){var r=new Upfront.Models.Region(e),g={};r.is_main()?a={model:r,index:s?i:i+1,options:g}:("left"==o||"right"==o?(r.set("container",t.model.get("name")),r.set("sub",s?"left":"right"),g.sub=s?"left":"right"):g.sub=r.get("sub"),l.push({model:r,index:(s?i:i+1)+n,options:g}))}),a!==!1?(Upfront.Events.once("entity:region:added",function(){g()}),a.model.add_to(n,a.index,a.options)):g()})},before_animation:function(e,t){Upfront.Events.trigger("command:region:edit_toggle",!1),Upfront.Events.trigger("command:region:fixed_edit_toggle",!1)},run_animation:function(e,t){function o(){Upfront.Settings.LayoutEditor.Grid.baseline,e.$el.outerHeight();e.$el.removeClass(i),Upfront.Events.trigger("command:region:edit_toggle",!0),Upfront.Events.trigger("command:region:fixed_edit_toggle",!0),e.trigger("activate_region",e)}var n=this.options.to,i="upfront-add-region-ani upfront-add-region-ani-"+n,r=setTimeout(o,500),a="animationstart.region_ani webkitAnimationStart.region_ani MSAnimationStart.region_ani oAnimationStart.region_ani",s="animationend.region_ani webkitAnimationEnd.region_ani MSAnimationEnd.region_ani oAnimationEnd.region_ani";if(e.$el.one(a,function(){clearTimeout(r),e.$el.off(a)}),e.$el.one(s,function(){o(),e.$el.off(s)}),e.$el.addClass(i),"top"==n||"bottom"==n){var l=e.$el.hasClass("upfront-region-container")?e.$el:e.$el.closest(".upfront-region-container"),g=l.offset(),d=$(document).scrollTop(),f=!1,p=l.height(),_=$(window).height();"top"==n&&g.top<d?f=g.top-50:"bottom"==n&&g.top+p>d+_&&(f=g.top+p-_),f!==!1&&$("html,body").animate({scrollTop:f},600)}}})})}();