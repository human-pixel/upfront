!function(t){define(["text!upfront/templates/post-editor/edition-box.html"],function(e){var i=Backbone.View.extend({className:"ueditor-box-wrapper upfront-ui",post:!1,taxSection:!1,offset:{min:0,max:0},position:{min:0,max:0},onScrollFunction:!1,statusSelect:!1,visibilitySelect:!1,taxSections:[],events:{"click .ueditor-action-preview":"navigate_to_preview","click .ueditor-button-cancel-edit":"cancel","click .ueditor-action-publish":"publish","click .ueditor-action-draft":"saveDraft","click .ueditor-action-trash":"trash","click .ueditor-box-title":"toggle_section","click .ueditor-save-post-data":"save_post_data"},initialize:function(i){this.post=i.post,this.statusSection=new r({post:this.post}),this.visibilitySection=new a({post:this.post}),this.scheduleSection=new p({post:this.post}),this.urlEditor=new l({post:this.post}),this.tpl=_.template(t(e).find("#ueditor-box-main").html()),this.datepickerTpl=_.template(t(Upfront.data.tpls.popup).find("#datepicker-tpl").html()),Upfront.Events.trigger("upfront:element:edit:start","write",this.post),Upfront.Events.on("upfront:element:edit:stop",this.element_stop_prop,this)},element_stop_prop:function(){Upfront.Application.mode.current===Upfront.Application.MODE.POSTCONTENT&&Upfront.Application.current_subapplication.contentEditor&&t(".upfront-module").each(function(){t(this).is(".ui-draggable")&&t(this).draggable("disable"),t(this).is(".ui-resizable")&&t(this).resizable("disable")})},render:function(){if(this.destroy(),Upfront.Application.user_can("EDIT")!==!1||parseInt(this.post.get("post_author"),10)===Upfront.data.currentUser.id&&Upfront.Application.user_can("EDIT_OWN")===!0){var t=this,e=this.post.toJSON(),i={},s=t.post.get("guid");return i.rootUrl=s?s.replace(/\?.*$/,""):window.location.origin+"/",e.permalink=this.permalink=i.rootUrl+this.post.get("post_name"),e.previewLink=this.post.get("guid")+"&preview=true",e.buttonText=this.getButtonText(),e.draftButton=-1==["publish","future"].indexOf(this.initialStatus),e.cancelButton=!this.post.is_new,e.cid=this.cid,i.post_type_conditional_box_title=this._post_type_has_taxonomy("post_tag")&&this._post_type_has_taxonomy("category")?Upfront.Settings.l10n.global.content.tags_cats_url:Upfront.Settings.l10n.global.content.no_tax_url,i.url_label="post"===t.post.get("post_type")?Upfront.Settings.l10n.global.content.post_url:Upfront.Settings.l10n.global.content.page_url,this.$el.html(this.tpl(_.extend({},e,i))),this.populateSections(),this}},navigate_to_preview:function(t){return t.preventDefault(),"auto-draft"===this.post.get("post_status")?(this.post.trigger("editor:auto-draft"),this.trigger("auto-draft"),void window.open(this.post.get("guid")+"&preview=true","_blank")):void window.open(this.post.get("guid"),"_blank")},renderTaxonomyEditor:function(t,e){var i=this,e="undefined"==typeof e?"category":e,s=new Upfront.Collections.TermList([],{postId:this.post.id,taxonomy:e});return this._post_type_has_taxonomy(e)?void s.fetch({allTerms:!0}).done(function(l){var r=l.data.taxonomy.hierarchical?n:o,a=i.taxSections[e]=new r({collection:s,tax:e});a.allTerms=new Upfront.Collections.TermList(l.data.allTerms),a.render(),t.html(a.$el)}):(t.hide(),!1)},populateSections:function(){this.$(".misc-pub-post-status").html(this.statusSection.$el),this.$(".misc-pub-visibility").html(this.visibilitySection.$el),this.$(".misc-pub-schedule").html(this.scheduleSection.$el),this.$(".misc-pub-section.misc-pub-post-url").html(this.urlEditor.$el),this.renderTaxonomyEditor(this.$(".misc-pub-post-category"),"category"),this.renderTaxonomyEditor(this.$(".misc-pub-post-tags"),"post_tag")},_post_type_has_taxonomy:function(t){if(!t)return!0;var e=this.post.get("post_type")||"post";return"page"!==e},getButtonText:function(){var t=this.initialStatus,e=this.post.get("post_date"),i=new Date;return e=e?e.getTime():0,i=i.getTime(),!t&&this.post&&this.post.get&&(t=this.post.get("post_status")),e>i?"future"==t?Upfront.Settings.l10n.global.content.update:Upfront.Settings.l10n.global.content.schedule:"publish"==t?Upfront.Settings.l10n.global.content.update:Upfront.Settings.l10n.global.content.publish},setPosition:function(){var e=t(".upost-data-object-post_data, .upfront-output-this_post").length?t(".upost-data-object-post_data, .upfront-output-this_post"):this.$el.closest(".upfront-postcontent-editor"),i=e.map(function(){return{right:t(this).width()+t(this).offset().left,$el:t(this)}}),s=_.max(i,function(t){return t.right}),n=t("body").width()-s.right,o=n>this.$el.width()?n-this.$el.width():10;Upfront.Util.isRTL()?this.$el.css({left:o+10,right:"auto"}):this.$el.css({right:o+10})},toggleRegionClass:function(t){this.$el.closest(".upfront-region-container").toggleClass("upfront-region-container-editing-post",t)},destroy:function(){Upfront.Events.off("upfront:element:edit:stop",this.element_stop_prop)},_stop_overlay:function(){t(".editing-overlay").remove(),t(".upfront-module").removeClass("editing-content"),t(".upfront-module.fadedOut").fadeTo("slow",1).removeClass("fadedOut"),t(".ueditor-display-block").removeClass("ueditor-display-block")},cancel:function(t){t.preventDefault(),confirm(Upfront.Settings.l10n.global.content.discard_changes.replace(/%s/,this.post.get("post_title")))&&(this.toggleRegionClass(!1),this.destroy(),this.post.trigger("editor:cancel"),this.trigger("cancel"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post),this.fadein_other_elements(),this.remove())},fadein_other_elements:function(){t(".editing-overlay").remove(),t(".upfront-module").removeClass("editing-content"),t(".upfront-module.fadedOut").fadeTo("fast",1).removeClass("fadedOut"),t(".ueditor-display-block").removeClass("ueditor-display-block")},publish:function(t){t.preventDefault(),this.destroy(),this.post.trigger("editor:publish"),this.trigger("publish"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post),Upfront.Events.trigger("upfront:post:edit:stop","write",this.post.toJSON()),this.fadein_other_elements(),this._stop_overlay(),this.toggleRegionClass(!1),this.remove()},saveDraft:function(t){t.preventDefault(),this.destroy(),this.post.trigger("editor:draft"),this.trigger("draft"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post,!0),this.remove()},trash:function(t){t.preventDefault(),confirm(Upfront.Settings.l10n.global.content.delete_confirm.replace(/%s/,this.post.get("post_type")))&&(this.destroy(),this.trigger("trash"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post),this.remove())},toggle_section:function(e){e.preventDefault();var i=t(e.target),s=i.closest(".ueditor-box-section"),n=s.find(".ueditor-box-content-wrap");s.toggleClass("show"),n.slideToggle()}}),s=Backbone.View.extend({events:{"click .ueditor-btn-edit":"toggleEditor","click .ueditor-button-cancel":"cancelEdit","click .ueditor-button-small-ok":"update",'change input[type="radio"][name="visibility"]':"visibility_radio_change","change input[name='visibility']":"set_visibility"},toggleEditor:function(e){e.preventDefault();var i=t(e.target),s=i.siblings(".ueditor-togglable"),n=i.closest(".misc-pub-section").find(".ueditor-previous-data-toggle");t(".ueditor-box-content-wrap .ueditor-togglable").not(s).slideUp(),t(".ueditor-box-content-wrap .ueditor-btn-edit").show(),t(".ueditor-previous-data-toggle").not(n).show(),n.hide(),i.hide(),s.slideDown(100)},cancelEdit:function(e){e.preventDefault();var i=t(e.target),s=i.closest(".misc-pub-section").find(".ueditor-previous-data-toggle");s.show(),i.closest(".ueditor-togglable").slideUp(100,function(){i.closest(".ueditor-togglable").siblings(".ueditor-btn-edit").show()})},visibility_radio_change:function(e){var i=t(e.target),s=i.val(),n=t(".ueditor-togglable-child-"+s);i.closest(".ueditor-togglable").find(".ueditor-togglable-child").not(n).hide(),n.show()}}),n=s.extend({termListingTpl:_.template(t(e).find("#upfront-term-list-tpl").html()),termSingleTpl:_.template(t(e).find("#upfront-term-single-tpl").html()),defaults:{title:"Categories"},className:"upfront-taxonomy-hierarchical",events:_.extend({},s.prototype.events,this.events,{"click #upfront-tax-add_term":"handle_new_term","click #add-new-taxonomies-btn":"toggle_add_new","keydown #upfront-add_term":"handle_enter_new_term","change .upfront-taxonomy_item":"handle_terms_update","keydown #upfront-new_term":"handle_enter_new_term","click .ueditor-save-post-hie-tax":"update"}),updateTimer:!1,allTerms:!1,initialize:function(t){this.tax=t.tax},render:function(){var t=this,e=t.collection.pluck("term_id");this.allTerms.sortBy(function(t,i){return-1!==e.indexOf(t.get("term_id"))});this.$el.html(this.termListingTpl(_.extend({},this.defaults,{allTerms:this.allTerms.where({parent:"0"}),postTerms:this.collection,termTemplate:this.termSingleTpl,labels:this.collection.taxonomyObject.labels})))},handle_new_term:function(){var e,i,s=this,n=this.$(".upfront-tax-new_term"),o=n.val();if(!o)return!1;t("#upfront-taxonomy-parents").length&&(e=t("#upfront-taxonomy-parents").val()),i=new Upfront.Models.Term({taxonomy:this.collection.taxonomy,name:o,parent:e}),i.save().done(function(t){s.allTerms.add(i),s.collection.add(i)});var l=this.termSingleTpl({term:i,termTemplate:s.termSingleTpl,termId:i.get("term_id"),postTerms:s.collection,selected:!0});this.$("#upfront-taxonomy-list").prepend(l),this.$("#upfront-taxonomy-list").scrollTop(0),n.val("")},handle_terms_update:function(e){var i=t(e.target),s=i.val();i.is(":checked")?this.collection.add(this.allTerms.get(s)):this.collection.remove(this.allTerms.get(s))},handle_enter_new_term:function(t){13==t.which&&this.handle_new_term(t)},update:function(t){this.collection.save(),Upfront.Events.trigger("editor:post:tax:updated",this.collection,this.tax),this.render()},toggle_add_new:function(){this.$(".ueditor-togglable-child").slideToggle()}}),o=s.extend({className:"upfront-taxonomy-flat",termListTpl:_.template(t(e).find("#upfront-flat-term-list-tpl").html()),termSingleTpl:_.template(t(e).find("#upfront-term-flat-single-tpl").html()),changed:!1,updateTimer:!1,events:_.extend({},s.prototype.events,{"click .ueditor-button-small-flat-tax-add":"handle_new_term","click .upfront-taxonomy_item-flat":"handle_term_click","keydown #upfront-flat-tax-add_term":"handle_enter_new_term","keydown .upfront-flat-tax-new_term":"handle_enter_new_term","click .upfront-taxonomy-list-choose-from-prev":"toggle_prev_used_tax"}),initialize:function(t){this.collection.on("add remove",this.update,this),this.tax=t.tax},render:function(){var t=this,e=new Upfront.Collections.TermList,i=new Upfront.Collections.TermList;this.allTerms.each(function(s,n){s.children=[],t.collection.get(s.get("term_id"))?e.add(s):i.add(s)}),this.$el.html(this.termListTpl({currentTerms:e,otherTerms:i,termTemplate:this.termSingleTpl,labels:this.collection.taxonomyObject.labels}))},handle_term_click:function(e){var i=t(e.currentTarget),s=i.attr("data-term_id");"upfront-taxonomy-list-current"==i.parent().attr("id")?this.collection.remove(s):this.collection.add(this.allTerms.get(s))},handle_new_term:function(t){t.preventDefault();var e,i=this,s=this.$(".upfront-flat-tax-new_term").val();return s?(e=new Upfront.Models.Term({taxonomy:this.collection.taxonomy,name:s}),void e.save().done(function(t){i.allTerms.add(e),i.collection.add(e).save()})):!1},handle_enter_new_term:function(t){13==t.which&&this.handle_new_term(t)},toggle_prev_used_tax:function(t){t.preventDefault(),this.$(".ueditor-togglable-child").slideToggle()},update:function(t){this.collection.save(),Upfront.Events.trigger("editor:post:tax:updated",this.collection,this.tax),this.render()}}),l=s.extend({hasDefinedSlug:!1,className:"upfront-slug_editor-url",tpl:_.template(t(e).find("#post-url-editor").html()),initialize:function(t){this.post=t.post,this.hasDefinedSlug=_.isEmpty(this.post.get("post_name"))?!1:!0,this.render()},render:function(){var t=this,e=this.post.get("guid");e=e?e.replace(/\?.*$/,""):window.location.origin+"/",this.$el.html(this.tpl({rootUrl:e,slug:t.post.get("post_name"),url_label:"post"===t.post.get("post_type")?Upfront.Settings.l10n.global.content.post_url:Upfront.Settings.l10n.global.content.page_url}))},update:function(t){t.preventDefault();var e=this.$(".ueditor-post-url-text").val();e.length>1&&(this.post.set("post_name",e),this.hasDefinedSlug=!0,this.render())}}),r=s.extend({statusOptions:{future:{value:"future",name:Upfront.Settings.l10n.global.content.scheduled},publish:{value:"publish",name:Upfront.Settings.l10n.global.content.published},pending:{value:"pending",name:Upfront.Settings.l10n.global.content.pending_review},draft:{value:"draft",name:Upfront.Settings.l10n.global.content.draft},"private":{value:"private",name:Upfront.Settings.l10n.global.content.private_post},"auto-draft":{value:"auto-draft",name:Upfront.Settings.l10n.global.content.new_post},trash:{value:"trash",name:Upfront.Settings.l10n.global.content.deleted_post}},initialStatus:!1,tpl:_.template(t(e).find("#post-status-tpl").html()),initialize:function(t){this.post=t.post,this.render()},render:function(){return this.initialStatus=this.currentStatus=this.post.get("post_status"),this.status=this.getStatus(),this.options=this.getStatusOptions(),this.$el.html(this.tpl(_.extend({},this.post,{status:this.status},{options:this.options}))),this},getStatusOptions:function(t){var e=[],i=this.initialStatus;return"publish"==i?e.push(this.statusOptions.publish):"future"==i&&e.push(this.statusOptions.future),e.push(this.statusOptions.pending),e.push(this.statusOptions.draft),"private"==i&&(e=[this.statusOptions["private"]]),e},getStatus:function(){var t=this.post.get("post_status");return-1!=["auto-draft","draft","pending"].indexOf(t)?this.statusOptions[t]:this.statusOptions[this.initialStatus]},update:function(t){t.preventDefault();var e=this.$("select").val();_.isEmpty(e)||e===this.initialStatus||(this.post.set("post_status",e),this.trigger("status:change",e),this.render())}}),a=s.extend({tpl:_.template(t(e).find("#post-visibility-tpl").html()),post_password:"",postVisibility:!1,visibilityOptions:{"public":{value:"public",name:Upfront.Settings.l10n.global.content.public_post},sticky:{value:"sticky",name:Upfront.Settings.l10n.global.content.sticky},password:{value:"password",name:Upfront.Settings.l10n.global.content.protected_post},"private":{value:"private",name:Upfront.Settings.l10n.global.content.is_private}},initialize:function(t){this.post=t.post,this.render()},render:function(){return this.postVisibility=this.postVisibility?this.postVisibility:this.post.getVisibility(),this.status=this.visibilityOptions[this.postVisibility],"password"==this.postVisibility&&(this.post_password=this.post.get("post_password")),this.$el.html(this.tpl(_.extend({},this.post,{status:this.status,post_password:this.post_password}))),this},getVisibilityOptions:function(){var t=this.post.getVisibility(),e=this.visibilityOptions;return"password"==t?[{value:"password",name:Upfront.Settings.l10n.global.content.edit_pwd},e["public"],e.sticky,e["private"]]:_.values(e)},set_visibility:function(e){var i=t(e.target).val();this.postVisibility=i},update:function(){var t=this.$(".ueditor-post-pass"),e=t.val();if(this.postVisibility=this.$("input[name='sticky']").is(":checked")?this.postVisibility="sticky":this.postVisibility,this.visibilityOptions.hasOwnProperty(this.postVisibility)){switch(this.postVisibility){case"password":if(""===e)return void t.css("border","1px solid red");t.css("border","1px solid #a3bfd9"),this.post.setVisibility(this.postVisibility),this.post.set("post_password",e),this.trigger("visibility:change","password",e);break;default:this.post.setVisibility(this.postVisibility),this.trigger("visibility:change",this.postVisibility,"")}this.render()}}}),p=s.extend({tpl:_.template(t(e).find("#post-schedule-tpl").html()),initialize:function(t){this.post=t.post,this.render()},render:function(){var t=new Object;return this.initialDate=this.post.get("post_date"),t.currentMonth=this.initialDate.getMonth(),t.currentYear=this.initialDate.getFullYear(),t.currentDay=this.initialDate.getDate(),t.currentHour=this.initialDate.getHours(),t.currentMinute=this.initialDate.getMinutes(),this.schedule=this.getSchedule(),this.$el.html(this.tpl(_.extend({},this.post,t,{schedule:this.schedule}))),this},getSchedule:function(){var t=new Date,e=this.initialDate,i=Upfront.Util.format_date;return e||this.initialDate?e.getTime()==this.initialDate?e.getTime()<t.getTime()?{key:Upfront.Settings.l10n.global.content.published,text:i(e,!0)}:{key:Upfront.Settings.l10n.global.content.scheduled,text:i(e,!0)}:e.getTime()<t.getTime()?{key:Upfront.Settings.l10n.global.content.publish_on,text:i(e,!0)}:{key:Upfront.Settings.l10n.global.content.scheduled_for,text:i(e,!0)}:{key:Upfront.Settings.l10n.global.content.publish,text:Upfront.Settings.l10n.global.content.immediately}},update:function(){var t=new Date,e=this.$("input[name='yy']").val(),i=this.$("select[name='mm']").val(),s=this.$("input[name='jj']").val(),n=this.$("input[name='hh']").val(),o=this.$("input[name='mn']").val();t.setFullYear(e),t.setMonth(i),t.setDate(s),t.setHours(n),t.setMinutes(o),this.post.set("post_date",t),this.trigger("date:updated",t),this.render()}});return{Box:i}})}(jQuery);