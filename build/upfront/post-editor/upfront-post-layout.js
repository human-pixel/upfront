(function(e){define(["upfront/post-editor/upfront-post-content"],function(t){var n,r=Upfront.Views.ObjectView.extend({initialize:function(e){var t=this.model.get_property_value_by_name("postPart");this.postPart=t,console.log("initializing view"),this.listenTo(Upfront.Events,"entity:resize_start",this.close_settings),this.listenTo(Upfront.Events,"entity:drag_start",this.close_settings),this.listenTo(this.model.get("properties"),"change",this.updateOptions),this.postModel=Upfront.Application.PostLayoutEditor.postView.model,this.listenTo(this.postModel,"template:"+t,this.refreshTemplate),_upfront_post_data&&(this.post=Upfront.data.posts[_upfront_post_data.post_id]),this.tpl=this.getTemplate(),this.model.tpl=this.tpl,typeof this.init=="function"&&this.init.apply(this,arguments)},get_content_markup:function(){var e=this.property("postPart"),n=t.getMarkupper(),r=this.getTemplate(),i=Upfront.Application.PostLayoutEditor.partMarkup,s=n.markup(e,i,r);return s?n.markup(e,i,r):(this.updatePartContent(),"Loading")},updateOptions:function(){var e=this.model.get("properties").toJSON(),t={},n=this.postModel.get_property_value_by_name("partOptions"),r=["","row","type","view_class","has_settings","id_slug","postPart","element_id"];_.isArray(n)&&(n={}),_.each(e,function(e){r.indexOf(e.name)==-1&&(t[e.name]=e.value)}),n[this.postPart]=t,this.postModel.set_property("partOptions",n),this.updatePartContent(),this.$el.html("Loading")},updatePartContent:function(){var e=this,t=this.postModel.get_property_value_by_name("partOptions")||{},n={action:"content_part_markup",post_id:this.post.id,parts:JSON.stringify([{slug:this.postPart,options:t[this.postPart]||{}}]),templates:{}};n.templates[this.postPart]=this.getTemplate(),Upfront.Util.post(n).done(function(t){_.extend(Upfront.Application.PostLayoutEditor.partMarkup,t.data.replacements),e.render()})},getTemplate:function(){var e=this.postModel.get_property_value_by_name("templates");return e&&e[this.postPart]?e[this.postPart]:Upfront.data.thisPost.templates[this.postPart]},refreshTemplate:function(){this.model.tpl=this.getTemplate(),this.render()},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}}),i=Upfront.Views.Editor.Sidebar.Element.extend({className:"draggable-element upfront-no-select draggable-post-element",initialize:function(e){console.log("initializing element"),this.options=e,this.title=e.title,this.slug=this.title.toLowerCase().replace(" ","_"),this.Model=d,this.View=r,this.Settings=c[this.slug]?c[this.slug]:u},add_element:function(){var e=new this.Model({properties:{type:"PostPart_"+this.slug+"Model",view_class:"PostPart_"+this.slug+"View",has_settings:1,id_slug:"PostPart_"+this.slug,postPart:this.slug}}),t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c10 post-part"},{name:"has_settings",value:0},{name:"row",value:Upfront.Util.height_to_row(100)}],objects:[e]});this.add_module(t)}}),s=Upfront.Views.Editor.Settings,o=Upfront.Views.Editor.Field,u=s.Settings.extend({initialize:function(e){this.options=e,this.cssEditor=!1,this.postPart=this.model.get_property_value_by_name("postPart"),typeof this.init=="function"&&this.init(e),this.updatePanels()},updatePanels:function(){var e=new Upfront.Views.Editor.Settings.Item({title:"General setup",model:this.model,fields:[new h({model:this.model})]});this.panels?this.panels.first().settings.push(e):this.panels=_([new s.Panel({label:"General",model:this.model,settings:[e]})])}}),a=u.extend({init:function(e){this.panels=_([new s.Panel({title:"Date format",model:this.model,settings:[new Upfront.Views.Editor.Settings.Item({title:"Date setup",model:this.model,fields:[new o.Text({label:"PHP date format",property:"format",model:this.model})]})]})])}}),f=u.extend({init:function(e){this.panels=_([new s.Panel({title:"Tags",model:this.model,settings:[new Upfront.Views.Editor.Settings.Item({title:"Tags settings",model:this.model,fields:[new o.Text({label:"Tags separator",property:"tag_separator",model:this.model})]})]})])}}),l=u.extend({init:function(e){this.panels=_([new s.Panel({title:"Tags",model:this.model,settings:[new Upfront.Views.Editor.Settings.Item({title:"Offset",model:this.model,fields:[new o.Number({label:"Offset ",property:"content_offset",max:24,step:1,model:this.model})]})]})])}}),c={date:a,tags:f,contents:l},h=Upfront.Views.Editor.Field.Field.extend({events:{"click .upfront-template-edit":"prepareTemplateEditor"},render:function(){return this.$el.html('<a href="#" title="Edit template" class="upfront-css-edit upfront-template-edit">Edit HTML template</a>'),this},prepareTemplateEditor:function(){Upfront.Events.trigger("post:edit:templatepart",this.model.tpl,this.model.get_property_value_by_name("postPart"))}}),p=Backbone.View.extend({events:{"click button":"save","click .upfront-css-close":"cancel"},initialize:function(){var t=e("#upfront_code-editor"),n=e.Deferred();t.length||(t=e('<section id="upfront_code-editor" class="upfront-ui upfront_code-editor upfront_code-editor-complex upfront-css-no-sidebar"></section>')),this.setElement(t),this.prepareAce=n.promise(),require(["//cdnjs.cloudflare.com/ajax/libs/ace/1.1.01/ace.js"],function(){n.resolve()}),this.editor=t},open:function(e){var t=this;t.tpl=e.tpl,t.postPart=e.postPart,this.prepareAce.then(function(){t.ace?(t.ace.getSession().setValue(t.tpl),t.$el.show()):t.render()})},render:function(){var t=this,n=e('<div class="upfront-css-resizable"></div>'),r=this.editor;r.detach(),n.html('<div class="upfront-css-top ui-resizable-handle ui-resizable-n"><a class="upfront-css-close" href="#">close</a></div>'),n.append('<div class="upfront-css-body"><div class="upfront_code-editor-section upfront_code-markup active"><div class="upfront-css-ace"></div></div><button>Save</button></div>'),this.resizeHandler=this.resizeHandler||function(){r.width(e(window).width()-e("#sidebar-ui").width()-1)},e(window).on("resize",this.resizeHandler),this.resizeHandler(),e("body").append(r.append(n).show());var i=r.height()-r.find(".upfront-css-top").outerHeight();r.find(".upfront-css-body").height(i);var s=ace.edit(r.find(".upfront-css-ace")[0]),o=s.getSession();o.setUseWorker(!1),s.setShowPrintMargin(!1),o.setMode("ace/mode/html"),s.setTheme("ace/theme/monokai"),s.setShowPrintMargin(!1),o.setValue(this.tpl),s.on("change",function(e){t.timer&&clearTimeout(t.timer),t.timer=setTimeout(function(){console.log("esso")},1e3),t.trigger("change",s)}),s.focus(),this.ace=s,this.startResizable()},startResizable:function(){var t=this.editor,n=this,r=t.find(".upfront-css-body"),i=t.find(".upfront-css-top").outerHeight(),s=t.find(".upfront-css-selectors"),o=t.find(".upfront-css-save-form"),u=function(u,a){var f=a?a.size.height:t.find(".upfront-css-resizable").height(),l=f-i;r.height(l),n.ace&&n.ace.resize(),s.height(l-o.outerHeight()),e("#page").css("padding-bottom",f)};u(),t.find(".upfront-css-resizable").resizable({handles:{n:".upfront-css-top"},resize:u,minHeight:200,delay:100})},save:function(){this.trigger("save",this.ace.getSession().getValue(),this.postPart)},cancel:function(){this.trigger("cancel")},close:function(){this.postPart=!1,this.tpl=!1,this.$el.hide()},destroy:function(){this.ace.destroy(),this.remove()}}),d=Upfront.Models.ObjectModel.extend({initialize:function(e){var t=e.properties;t.element_id||(t.element_id=Upfront.Util.get_unique_id(t.id_slug+"-object")),this.set("properties",new Upfront.Collections.Properties({})),this.init_properties(t),typeof this.init=="function"&&this.init.apply(this,arguments)}});return Upfront.Content||(Upfront.Content={}),_.extend(Upfront.Content,{PostElement:i,TemplateEditor:p,PostPart:d}),{}})})(jQuery);