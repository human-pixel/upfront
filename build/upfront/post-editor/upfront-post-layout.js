(function(e){define(["upfront/post-editor/upfront-post-content","text!upfront/templates/popup.html","text!upfront/templates/image_variants.html"],function(t,n,r){var i=Upfront.Views.ObjectView.extend({initialize:function(e){var t=this,n=this.model.get_property_value_by_name("postPart");this.postPart=n,this.listenTo(Upfront.Events,"entity:resize_start",this.close_settings),this.listenTo(Upfront.Events,"entity:drag_start",this.close_settings),this.postView=Upfront.Application.PostLayoutEditor.postView,this.postView.partOptions&&this.postView.partOptions[this.postPart]&&_.each(this.postView.partOptions[this.postPart],function(e,n){t.model.set_property(n,e,!0)}),this.listenTo(this.model.get("properties"),"change add remove",this.updateOptions),this.listenTo(this.postView.model,"template:"+n,this.refreshTemplate),_upfront_post_data&&(this.post=Upfront.data.posts[_upfront_post_data.post_id]),this.tpl=this.getTemplate(),this.model.tpl=this.tpl,typeof this.init=="function"&&this.init.apply(this,arguments)},get_content_markup:function(){var e=this.property("postPart"),n=t.getMarkupper(),r=this.getTemplate(),i=Upfront.Application.PostLayoutEditor.partMarkup,s=n.markup(e,i,r);return s?s:(this.updatePartContent(),"Loading")},on_render:function(){var e=this.postView.partOptions,t=e[this.property("postPart")]||{};t.extraClasses&&this.$(".upfront-object").addClass(t.extraClasses),Upfront.Events.trigger("post:layout:partrendered",this)},updateOptions:function(){var e=this.model.get("properties").toJSON(),t={},n=this.postView.partOptions,r=["","row","type","view_class","has_settings","id_slug","postPart","element_id"];_.isArray(n)&&(n={}),_.each(e,function(e){r.indexOf(e.name)==-1&&(t[e.name]=e.value)}),n[this.postPart]=t,this.postView.partOptions=n,this.updatePartContent(),this.$(".upfront-object-content").html("Loading")},updatePartContent:function(){var e=this,t=this.postView.partOptions||{},n={action:"content_part_markup",post_id:this.postView.editor.postId?this.postView.editor.postId:this.post.id,parts:JSON.stringify([{slug:this.postPart,options:t[this.postPart]||{}}]),templates:{}};n.templates[this.postPart]=this.getTemplate(),Upfront.Util.post(n).done(function(t){_.extend(Upfront.Application.PostLayoutEditor.partMarkup,t.data.replacements),e.render()})},getTemplate:function(){var e=this.postView.partTemplates,t=this.postPart;return t=="contents"&&this.postView.property("content_type")=="excerpt"&&(t="excerpt"),e&&e[t]?e[t]:Upfront.data.thisPost.templates[t]},refreshTemplate:function(){this.model.tpl=this.getTemplate(),this.render()},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}}),s=Upfront.Views.Editor.Sidebar.Element.extend({className:"draggable-element upfront-no-select draggable-post-element",initialize:function(e){this.options=e,this.title=e.title,this.slug=this.title.toLowerCase().replace(" ","_"),this.Model=S,this.View=b[this.slug]?b[this.slug]:i,this.Settings=y[this.slug]?y[this.slug]:a},add_element:function(){var e=new this.Model({properties:{type:"PostPart_"+this.slug+"Model",view_class:"PostPart_"+this.slug+"View",has_settings:1,id_slug:"PostPart_"+this.slug,postPart:this.slug}}),t=new Upfront.Models.Module({name:"",properties:[{name:"element_id",value:Upfront.Util.get_unique_id("module")},{name:"class",value:"c10 post-part"},{name:"has_settings",value:0},{name:"row",value:Upfront.Util.height_to_row(100)}],objects:[e]});this.add_module(t)}}),o=Upfront.Views.Editor.Settings,u=Upfront.Views.Editor.Field,a=o.Settings.extend({has_tabs:!1,initialize:function(e){this.options=e,this.cssEditor=!1,this.postPart=this.model.get_property_value_by_name("postPart"),typeof this.init=="function"&&this.init(e),this.updatePanels()},updatePanels:function(){var e=new Upfront.Views.Editor.Settings.Item({title:"General setup",model:this.model,fields:[new w({model:this.model})]});this.panels?this.panels.first().settings.push(e):this.panels=_([new o.Panel({label:"General",model:this.model,settings:[e]})])}}),f=a.extend({init:function(e){this.panels=_([new o.Panel({hide_common_fields:!0,title:"Date format",model:this.model,settings:[new Upfront.Views.Editor.Settings.Item({title:"Date setup",model:this.model,fields:[new u.Text({label:"PHP date format",property:"format",model:this.model})]})]})])}}),l=f.extend(),c=a.extend({init:function(e){this.panels=_([new o.Panel({hide_common_fields:!0,title:"Tags",model:this.model,settings:[new Upfront.Views.Editor.Settings.Item({title:"Tags settings",model:this.model,fields:[new u.Text({label:"Tags separator",property:"tag_separator",model:this.model})]})]})])}}),h=a.extend({events:{"keyup .upfront-field-number":"offsetChanged","change .upfront-field-number":"updatePadding"},init:function(e){console.log("this.panels",this.panels),this.panels=_([new o.Panel({hide_common_fields:!0,title:"Tags",model:this.model,settings:[new Upfront.Views.Editor.Settings.Item({title:"Content padding",className:"content-overflow-setting",model:this.model,fields:[new u.Number({label:"Left",property:"padding_left",max:3,min:0,step:1,model:this.model}),new u.Number({label:"Right",property:"padding_right",max:3,min:0,step:1,model:this.model})]})]})])},offsetChanged:function(e){var t=e.target;if(isNaN(parseInt(t.value))||t.value<0||t.value>3)Upfront.Views.Editor.notify("Content padding needs to be an number between 0 and 3.","error"),t.value=0;this.updatePadding()},updatePadding:function(){var e=this.$("input[name=padding_left]").val()||0,t=this.$("input[name=padding_right]").val()||0;this.for_view&&this.for_view.trigger("post:padding:update",e,t)}}),p=i.extend({start_content_styling:function(t){t.preventDefault(),t.stopPropagation(),e(".sidebar-commands-control .command-cancel").show(),e(t.target).closest(".upfront-module").addClass("upfront-disable-surroundings"),new v({contentView:this}),Upfront.Events.trigger("post:content:style:start",this,"single")},updateOptions:function(){var e=this.model.get("properties").toJSON(),t={},n=this.postView.partOptions,r=["","row","type","view_class","has_settings","id_slug","postPart","element_id"];_.isArray(n)&&(n={}),_.each(e,function(e){r.indexOf(e.name)==-1&&(t[e.name]=e.value)});var i=t.overflow_left||0,s=t.overflow_right||0;n[this.postPart]=t,n.colSize=Upfront.Behaviors.GridEditor.col_size,this.postView.partOptions=n,this.updatePartContent(),this.$(".upfront-object-content").html("Loading")},render:function(){var t=this;i.prototype.render.apply(this,arguments),this.paddingChangeHandler||(this.paddingChangeHandler=_.bind(this.refreshPaddings,this),this.on("post:padding:update",this.paddingChangeHandler)),this.refreshPaddingsFromProperties();if(Upfront.Application.is_builder()){var n=e('<div class="upfront_edit_content_style">Style Post Content</div>');n.appendTo(this.$(".upfront-output-PostPart_contents")),n.on("click",function(e){t.start_content_styling.call(t,e)})}},refreshPaddingsFromProperties:function(){this.refreshPaddings(this.property("padding_left")||0,this.property("padding_right")||0)},refreshPaddings:function(t,n){var r=Upfront.Behaviors.GridEditor.col_size,i=n*r,s=t*r,o=e(".upfront-region-postlayouteditor").find(".upfront-post-padding"),u=".upfront-region-postlayouteditor .upfront-output-PostPart_contents {";o.length||(o=e('<style class="upfront-post-padding"></style>'),setTimeout(function(){e(".upfront-region-postlayouteditor").append(o)},200)),u+="padding-left: "+s+"px; padding-right: "+i+"px;}",o.html(u)}}),d=new Upfront.Collections.ImageVariants(Upfront.mainData.postImageVariants),v=Backbone.View.extend({initialize:function(e){this.contentView=e.contentView,this.populate_style_content()},add_new_variant:function(t){t.preventDefault(),t.stopPropagation();var n=new Upfront.Models.ImageVariant;n.set("vid",Upfront.Util.get_unique_id("variant"));var r=new m({model:n});r.render(),r.$el.hide(),e(".ueditor-insert-variant").last().after(r.el),r.$el.fadeIn(),d.add(n)},populate_style_content:function(){var t=this,n=this.contentView.postView.partOptions||{},r={action:"content_part_markup",post_id:"fake_styled_post",parts:JSON.stringify([{slug:this.contentView.postPart,options:n[this.contentView.postPart]||{}}]),templates:{}};r.templates[this.contentView.postPart]=this.contentView.getTemplate();var i=Upfront.Util.post(r);return i.done(function(n){_.extend(Upfront.Application.PostLayoutEditor.partMarkup,n.data.replacements),t.contentView.$el.html(n.data.replacements["%contents%"]);var r=e("#page");r.find(".upfront-module").draggable("disable").resizable("disable"),r.find(".upfront-region-edit-trigger").hide(),d.each(function(e){var n=new m({model:e});n.render(),t.contentView.$el.find("#upfront-image-variants").append(n.el)});if(d.length===0){var i=new Upfront.Models.ImageVariant;i.set("vid",Upfront.Util.get_unique_id("variant"));var s=new m({model:i});d.add(i),s.render(),t.contentView.$el.find("#upfront-image-variants").append(s.el)}e("#upfront-image-variants").append("<div class='upfront-add-image-insert-variant'>Add Image Insert Variant</div>").on("click",t.add_new_variant)}),i}}),m=Backbone.View.extend({tpl:_.template(e(r).find("#upfront-post-image-variant-tpl").html()),se_handle:'<span class="upfront-icon-control upfront-icon-control-resize-se upfront-resize-handle-se ui-resizable-handle ui-resizable-se nosortable"></span>',nw_handle:'<span class="upfront-icon-control upfront-icon-control-resize-nw upfront-resize-handle-nw ui-resizable-handle ui-resizable-nw nosortable"></span>',initialize:function(e){this.opts=e,Upfront.Events.on("post:content:style:stop",function(){})},events:{"click .upfront_edit_image_insert":"start_editing","click .finish_editing_image_insert":"finish_editing","click .upfront-image-variant-delete_trigger":"remove_variant"},render:function(){return this.$el.html(this.tpl(this.model.toJSON())),this.$self=this.$(".ueditor-insert-variant"),this.$self.prepend('<a href="#" class="upfront-icon-button upfront-icon-button-delete upfront-image-variant-delete_trigger"></a>'),this.$image=this.$(".ueditor-insert-variant-image"),this.$caption=this.$(".ueditor-insert-variant-caption"),this.make_resizable(),this.$label=this.$(".image-variant-label"),this},remove_variant:function(e){e.preventDefault(),e.stopPropagation(),d.remove(this.model),this.remove()},start_editing:function(e){e.preventDefault(),e.stopPropagation(),this.$label.show(),this.$(".upfront_edit_image_insert").css({visibility:"hidden"}),this.$self.resizable("option","disabled",!0),this.$self.addClass("editing"),this.$self.find(".upfront-icon-control").hide(),this.$self.css("height",this.$(".ueditor-insert-variant").height()),this.make_items_draggable(),this.make_items_resizable(),this.$self.append("<div class='finish_editing_image_insert'>Finish editing image insert</div>")},finish_editing:function(t){t.preventDefault(),t.stopPropagation(),this.$label.hide(),this.model.set("label",this.$label.val()),this.$(".upfront_edit_image_insert").css({visibility:"visible"}),this.$self.resizable("option","disabled",!1),this.$self.removeClass("editing"),this.$self.find(".upfront-icon-control").show(),this.$image.draggable("option","disabled",!0),this.$image.resizable("option","disabled",!0),this.$image.find(".upfront-icon-control").hide(),this.$caption.draggable("option","disabled",!0),this.$caption.resizable("option","disabled",!0),this.$caption.find(".upfront-icon-control").hide(),e(t.target).remove()},make_items_draggable:function(){var t=this,n=Upfront.Behaviors.GridEditor,r={zIndex:100,containment:"parent",delay:50,helper:"clone",start:function(t,n){t.stopPropagation(),e(this).resizable("option","disabled",!0)},drag:function(e,t){e.stopPropagation()},stop:function(r,i){r.stopPropagation();var s=e(this),o=Upfront.Util.height_to_row(i.position.top>0?i.position.top:0)*n.baseline,u=Upfront.Util.width_to_col(i.position.left)*n.col_size,a=s.is(t.$image)?t.model.get("image"):t.model.get("caption");a.left=u,a.top=o,e(this).css({top:o,left:u,marginLeft:0,marginTop:0}),s.resizable("option","disabled",!1)}};_.isEmpty(this.$image.data("ui-draggable"))?this.$image.draggable(r):this.$image.draggable("option","disabled",!1),_.isEmpty(this.$caption.data("ui-draggable"))?this.$caption.draggable(r):this.$caption.draggable("option","disabled",!1)},make_items_resizable:function(){var t=this,n=Upfront.Behaviors.GridEditor,r={handles:{nw:".upfront-resize-handle-nw",se:".upfront-resize-handle-se"},delay:50,minHeight:50,minWidth:45,containment:"parent",start:function(t,n){t.stopPropagation(),e(this).draggable("option","disabled",!0)},resize:function(e,t){e.stopPropagation()},stop:function(r,i){e(this).draggable("option","disabled",!1),r.stopPropagation();var s=e(this),o=s.is(t.$image)?t.model.get("image"):t.model.get("caption"),u=Upfront.Util.width_to_col(i.position.left)*n.col_size,a=Upfront.Util.height_to_row(i.position.top>0?i.position.top:0)*n.baseline,f=Upfront.Util.grid.normalize_height(i.size.height),l=Upfront.Util.grid.normalize_width(i.size.width),c=Upfront.Util.width_to_col(i.size.width);o.left=u,o.top=a,o.height=f,o.width_cls=n.grid.class+c,Upfront.Util.grid.update_class(s,n.grid.class,c),e(this).css({left:u,top:a,height:f,width:""})}};_.isEmpty(this.$image.data("ui-resizable"))?(this.$image.append(this.nw_handle),this.$image.append(this.se_handle),this.$image.resizable(r)):(this.$image.find(".upfront-icon-control").show(),this.$image.resizable("option","disabled",!1)),_.isEmpty(this.$caption.data("ui-resizable"))?(this.$caption.append(this.nw_handle),this.$caption.append(this.se_handle),this.$caption.resizable(r)):(this.$caption.find(".upfront-icon-control").show(),this.$caption.resizable("option","disabled",!1))},ui_right:function(t,n){var r=e(n),i=r.closest(".upfront-object-view"),s=i.width(),o=t.position.left;return s-o-r.width()},make_resizable:function(){var t=this,n=Upfront.Behaviors.GridEditor;this.$self.append(this.nw_handle),this.$self.append(this.se_handle),this.$self.resizable({delay:50,handles:{nw:".upfront-resize-handle-nw",se:".upfront-resize-handle-se"},minHeight:50,minWidth:45,containment:"parent",start:function(){t.$image.css({left:0,top:0}),t.$caption.css({left:0,top:0}),Upfront.Util.grid.update_class(t.$image,"c24"),Upfront.Util.grid.update_class(t.$caption,"c24"),t.model.get("image").width_cls="c24",t.model.get("caption").width_cls="c24"},resize:function(n,r){r.position.left===0&&t.ui_right(r,this)!==0?(e(this).css({"float":"left",left:0,right:0}),t.model.get("group").float="left"):r.position.left>0&&t.ui_right(r,this)===0&&(e(this).css({"float":"right",left:0,right:0}),t.model.get("group").float="right");if(r.position.left===0&&t.ui_right(r,this)===0||r.position.left!==0&&t.ui_right(r,this)!==0)e(this).css({"float":"none"}),t.model.get("group").float="none"},stop:function(r,i){var s=e(this),o=Upfront.Util.grid.width_to_col(i.size.width),u=i.position.left,a=Math.round(u/n.col_size),f=Upfront.Util.height_to_row(i.size.height)*n.baseline;Upfront.Util.grid.update_class(s,n.grid.class,o),t.model.get("group").height=f,t.model.get("group").width_cls=n.grid.class+o,s.css({height:f,width:"","margin-left":""});var l=f-s.find(".ueditor-insert-variant-caption").height()-60;s.find(".ueditor-insert-variant-image").css("height",l)}})},update_class:function(e,t,n){var r=new RegExp("\\b"+t+"\\d+");e.hasClass(t+n)||(e.attr("class").match(r)?e.attr("class",e.attr("class").replace(r,t+n)):e.addClass(t+n))}}),g=i.extend({init:function(e){this.partOptions=this.postView.partOptions.featured_image||{}},on_render:function(){var t=this,n=this.moduleId||this.parent_module_view.model.get_property_value_by_name("element_id"),r=this.partOptions.height||100,i=this.parent_module_view;this.moduleId=n,this.moduleView=i.$("#"+n),this.placeholder||(this.placeholder=e('<div class="upfront-post-thumb-placeholder upfront-ui"><div>Post Featured Image</div></div>'),r&&this.placeholder.height(r)),this.$(".upfront-content-marker").replaceWith(this.placeholder),r||this.resizePlaceholder(),i.$("#style-"+this.cid).length||i.$el.append('<style id="style-'+this.cid+'">#'+n+" div{ height: 100%; }</style>"),this.resizePlaceholderCallback||(this.resizePlaceholderCallback=_.bind(this.resizePlaceholder,this)),this.moduleView.off("resizestop",t.resizePlaceholderCallback).off("resize",t.resizePlaceholderCallback).on("resize",t.resizePlaceholderCallback).on("resizestop",t.resizePlaceholderCallback)},resizePlaceholder:function(t){this.placeholder.height(this.moduleView.height());if(t&&t.type=="resizestop"){var n=e(".upfront-resize").height();this.model.set_property("height",n,!0),this.model.set_property("attributes",{style:"max-height: "+n+"px"}),this.partOptions.height=n}}}),y={date:f,update:l,tags:c,contents:h},b={contents:p,featured_image:g},w=Upfront.Views.Editor.Field.Field.extend({events:{"click .upfront-template-edit":"prepareTemplateEditor"},render:function(){return this.$el.html('<a href="#" title="Edit template" class="upfront-css-edit upfront-template-edit">Edit HTML template</a>'),this},prepareTemplateEditor:function(e){e.preventDefault(),Upfront.Events.trigger("post:edit:templatepart",this.model.tpl,this.model.get_property_value_by_name("postPart"))}}),E=Backbone.View.extend({events:{"click button":"save","click .upfront-css-close":"cancel"},initialize:function(){var t=e("#upfront_code-editor"),n=e.Deferred();t.length||(t=e('<section id="upfront_code-editor" class="upfront-ui upfront_code-editor upfront_code-editor-complex upfront-css-no-sidebar"></section>')),this.setElement(t),this.prepareAce=n.promise(),require(["//cdnjs.cloudflare.com/ajax/libs/ace/1.1.01/ace.js"],function(){n.resolve()}),this.editor=t},open:function(e){var t=this;t.tpl=e.tpl,t.postPart=e.postPart,this.prepareAce.then(function(){t.ace?(t.ace.getSession().setValue(t.tpl),t.$el.show()):t.render()})},render:function(){var t=this,n=e('<div class="upfront-css-resizable"></div>'),r=this.editor;r.detach(),n.html('<div class="upfront-css-top ui-resizable-handle ui-resizable-n"><span class="upfront-css-type">'+this.postPart+' Part Template</span><a class="upfront-css-close" href="#">close</a></div>'),n.append('<div class="upfront-css-body"><div class="upfront_code-editor-section upfront_code-markup active"><div class="upfront-css-ace"></div></div><button>Save</button></div>'),this.resizeHandler=this.resizeHandler||function(){r.width(e(window).width()-e("#sidebar-ui").width()-1)},e(window).on("resize",this.resizeHandler),this.resizeHandler(),e("body").append(r.append(n).show());var i=r.height()-r.find(".upfront-css-top").outerHeight();r.find(".upfront-css-body").height(i);var s=ace.edit(r.find(".upfront-css-ace")[0]),o=s.getSession();o.setUseWorker(!1),s.setShowPrintMargin(!1),o.setMode("ace/mode/html"),s.setTheme("ace/theme/monokai"),s.setShowPrintMargin(!1),o.setValue(this.tpl),s.on("change",function(e){t.timer&&clearTimeout(t.timer),t.timer=setTimeout(function(){console.log("esso")},1e3),t.trigger("change",s)}),s.focus(),this.ace=s,this.startResizable()},startResizable:function(){var t=this.editor,n=this,r=t.find(".upfront-css-body"),i=t.find(".upfront-css-top").outerHeight(),s=t.find(".upfront-css-selectors"),o=t.find(".upfront-css-save-form"),u=function(u,a){var f=a?a.size.height:t.find(".upfront-css-resizable").height(),l=f-i;r.height(l),n.ace&&n.ace.resize(),s.height(l-o.outerHeight()),e("#page").css("padding-bottom",f)};u(),t.find(".upfront-css-resizable").resizable({handles:{n:".upfront-css-top"},resize:u,minHeight:200,delay:100})},save:function(){this.trigger("save",this.ace.getSession().getValue(),this.postPart)},cancel:function(e){e.preventDefault(),this.trigger("cancel")},close:function(){this.postPart=!1,this.tpl=!1,this.$el.hide()},destroy:function(){this.ace.destroy(),this.remove()}}),S=Upfront.Models.ObjectModel.extend({initialize:function(e){var t=e.properties;t.element_id||(t.element_id=Upfront.Util.get_unique_id(t.id_slug+"-object")),this.set("properties",new Upfront.Collections.Properties({})),this.init_properties(t),typeof this.init=="function"&&this.init.apply(this,arguments)}}),x=Backbone.View.extend({tpl:_.template(e(n).find("#save-dialog-tpl").html()),attributes:{id:"upfront-save-dialog-background"},events:{"click #upfront-save-dialog":"save",click:"close"},initialize:function(e){this.options=e},render:function(){if(e("#upfront-save-dialog-background").length)return;return this.$el.html(this.tpl(this.options)),e("body").append(this.$el),this.$el.width(e(window).width()).height(e(document).height()),this},save:function(t){t.preventDefault();var n=e(t.target),r;if(!n.hasClass("upfront-save-button"))return;this.trigger("save",n.data("save-as"))},close:function(e){if(e&&e.isDefaultPrevented())return;var t=this;this.$el.fadeOut("fast",function(){t.$el.detach(),t.trigger("closed")})},save_dialog:function(t,n){e("body").append("<div id='upfront-save-dialog-background' />"),e("body").append("<div id='upfront-save-dialog' />");var r=e("#upfront-save-dialog"),i=e("#upfront-save-dialog-background"),s=Upfront.Application.layout.get("current_layout"),o="";i.width(e(window).width()).height(e(document).height()),o+="<p>Do you wish to save layout just for this post or apply it to all posts?</p>",e.each(_upfront_post_data.layout,function(e,t){if(e=="type")return;o+='<span class="upfront-save-button" data-save-as="'+t+'">'+Upfront.Settings.LayoutEditor.Specificity[e]+"</span>"}),r.html(o),e("#upfront-save-dialog").on("click",".upfront-save-button",function(){var s=e(this).attr("data-save-as");return i.remove(),r.remove(),t.apply(n,[s]),!1}),e("#upfront-save-dialog-background").on("click",function(){return i.remove(),r.remove(),!1})}});return Upfront.Views.Editor.SaveDialog=x,Upfront.Content||(Upfront.Content={}),_.extend(Upfront.Content,{PostElement:s,TemplateEditor:E,PostPart:S,ImageVariants:d}),{}})})(jQuery);