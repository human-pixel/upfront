(function(e){define(["text!upfront/templates/post-editor/edition-box.html"],function(t){var n=function(){this.parts={title:{replacements:["%title%","%permalink%"],editable:["%title%"]},contents:{replacements:["%contents%","%excerpt%"],editable:["%contents%","%excerpt%"]},excerpt:{replacements:["%excerpt%"],editable:["%excerpt%"]},author:{replacements:["%author%","%author_url%","%author_meta%"],editable:["%author%"],withParameters:["%author_meta_","%avatar_"]},categories:{replacements:["%categories%"],editable:[]},tags:{replacements:["%tags%"],editable:[]},comments_count:{replacements:["%comments_count%"],editable:[]},featured_image:{replacements:["%image%","%permalink%"],editable:["%image%"]},date:{replacements:["%date%","%date_iso%"],editable:["%date%"]},update:{replacements:["%update%","%date_iso%"],editable:["%update%"]},author_gravatar:{replacements:["%avatar_%"],editable:["%avatar%"],withParameters:["%avatar_"]}},this.markup=function(e,t,n,r){var i=this,s=r&&r.extraClasses?r.extraClasses:"",o=r&&r.attributes?r.attributes:{},u="";_.each(o,function(e,t){u+=t+'="'+e+'" '}),this.parts[e]&&this.parts[e].replacements&&_.each(this.parts[e].replacements,function(r){var o=t[r];i.parts[e].editable.indexOf(r)!==-1&&(o='<div class="upfront-content-marker upfront-content-marker-'+e+" "+s+'" '+u+">"+o+"</div>"),n=n.replace(r,o)});if(this.parts[e]&&this.parts[e].withParameters){var a=this.parts[e].withParameters;a&&_.each(a,function(e){var r=new RegExp(e+"[^%]+%","gm"),i=r.exec(n);_.each(i,function(e){n=typeof t[e]=="undefined"?"":n.replace(e,t[e])})})}return n}},r=new n,i=Backbone.View.extend({events:{"click a":"preventLinkNavigation","click .upfront-content-marker-author":"editAuthor","click .upfront-content-marker-date":"editDate","click .upost_thumbnail_changer":"editThumb","click .upfront-postpart-tags":"editTags","click .upfront-postpart-categories":"editCategories","click .ueditor-action-pickercancel":"editDateCancel","click .ueditor-action-pickerok":"editDateOk"},initialize:function(e){this.post=e.post,this.postView=e.postView,this.triggeredBy=e.triggeredBy||this.$(".upfront-content-marker").first(),this.parts={},this.partOptions=e.partOptions,this.postAuthor=this.post.get("post_author"),this.authorTpl=e.authorTpl,this.contentMode=e.content_mode,this.inserts=this.post.meta.getValue("_inserts_data")||{},this.$el.addClass("clearfix").css("padding-bottom","60px"),this.rawContent=e.rawContent,this.rawExcerpt=e.rawExcerpt,this.$("a").data("bypass",!0);var t=this.$el.closest(".ui-draggable");t.length&&(cancel=t.draggable("disable")),this.prepareEditableRegions(),this.prepareBar()},prepareEditableRegions:function(){var t=this;this.parts.titles=this.$(".upfront-content-marker-title");if(this.parts.titles.length){var n=this.parts.titles.parent();n.is("a")&&n.replaceWith(this.parts.titles),this.onTitleEdited=_.bind(this.titleEdited,this),this.parts.titles.attr("contenteditable",!0)}this.parts.contents=this.$(".upfront-content-marker-contents");if(this.parts.contents.length){var r=this.contentMode=="post_excerpt",i=r?this.rawExcerpt:this.rawContent,s=r?this.getExcerptEditorOptions():this.getContentEditorOptions();this.onContentsEdited=_.bind(this.contentEdited,this),this.editors=[],this.parts.contents.html(i).ueditor(s),this.parts.contents.on("keyup",this.onContentsEdited),this.parts.contents.each(function(){t.editors.push(e(this).data("ueditor"))}),this.currentContent=this.parts.contents[0]}this.parts.authors=this.$(".upfront-content-marker-author");if(this.parts.authors.length){var t=this,o=Upfront.data.ueditor.authors,u=[];_.each(o,function(e){u.push({value:e.ID,name:e.display_name})}),this.authorSelect=new a({options:u}),this.authorSelect.on("select",function(e){t.changeAuthor(e)}),this.$el.append(this.authorSelect.$el)}this.parts.author_gravatars=this.$(".upfront-content-marker-author-gravatar");if(this.parts.authors.length){var t=this,o=Upfront.data.ueditor.authors,u=[];_.each(o,function(e){u.push({value:e.ID,name:e.display_name})}),this.authorSelect=new a({options:u}),this.authorSelect.on("select",function(e){t.changeAuthor(e)}),this.$el.append(this.authorSelect.$el)}this.parts.dates=this.$(".upfront-content-marker-date");if(this.parts.dates.length){var t=this,f={},u=[],l=this.post.get("post_date"),c=this.getDateFormat();f.minutes=_.range(0,60),f.hours=_.range(0,24),f.currentHour=l.getHours(),f.currentMinute=l.getHours(),this.datepickerTpl=_.template(e(Upfront.data.tpls.popup).find("#datepicker-tpl").html()),this.$el.prepend(this.datepickerTpl(f)),this.datepicker=this.$(".upfront-bar-datepicker"),this.datepicker.datepicker({changeMonth:!0,changeYear:!0,dateFormat:c,onChangeMonthYear:function(n,r,i){var s=i.selectedDay,o=new Date(t.parts.dates.text()),u=new Date(n,r-1,s,o.getHours(),o.getMinutes());t.parts.dates.html(e.datepicker.formatDate(c,u)),t.post.set("post_date",u),t.datepicker.datepicker("setDate",u)},onSelect:function(e){t.parts.dates.html(e)}})}this.parts.featured=this.$(".upfront-content-marker-featured_image");if(this.parts.featured.length){var h=this.post.meta.getValue("_thumbnail_id"),p=this.partOptions.featured_image&&this.partOptions.featured_image.height?this.partOptions.featured_image.height:60;this.parts.featured.addClass("ueditor_thumb ueditable").css({position:"relative","min-height":p+"px",width:"100%"}).append('<div class="upost_thumbnail_changer" ><div>'+Upfront.Settings.l10n.global.content.trigger_edit_featured_image+"</div></div>").find("img").css({"z-index":"2",position:"relative"})}this.parts.tags=this.$(".upfront-postpart-tags"),this.parts.categories=this.$(".upfront-postpart-categories"),setTimeout(function(){t.triggeredBy.length&&t.focus(t.triggeredBy,!0)},200)},getExcerptEditorOptions:function(){return{linebreaks:!1,autostart:!0,focus:!1,pastePlainText:!0,airButtons:["bold","italic"]}},getContentEditorOptions:function(){return{linebreaks:!1,replaceDivs:!1,autostart:!0,focus:!1,pastePlainText:!1,inserts:this.inserts}},editThumb:function(t){t.preventDefault();var n=this,r=e(t.target),i=this.postId,s=r.parent().find("img"),o=new Upfront.Views.Editor.Loading({loading:Upfront.Settings.l10n.global.content.starting_img_editor,done:Upfront.Settings.l10n.global.content.here_we_are,fixed:!1}),u=this.post.meta.getValue("_thumbnail_id");if(!u)return n.openImageSelector();o.render(),r.parent().append(o.$el),n.getImageInfo(n.post).done(function(e){o.$el.remove(),n.openImageEditor(!1,e,n.post.id)})},getImageInfo:function(t){var n=this,r=t.meta.get("_thumbnail_data"),i=t.meta.get("_thumbnail_id"),s=e.Deferred(),o=this.$(".ueditor_thumb").find("img");if(!r||!_.isObject(r.get("meta_value"))||r.get("meta_value").imageId!=i.get("meta_value")){if(!i)return!1;Upfront.Views.Editor.ImageEditor.getImageData([i.get("meta_value")]).done(function(e){var t=e.data.images,n={},r=0;_.each(t,function(e,t){n=e,r=t}),s.resolve({src:n.medium?n.medium[0]:n.full[0],srcFull:n.full[0],srcOriginal:n.full[0],fullSize:{width:n.full[1],height:n.full[2]},size:{width:o.width(),height:o.height()},position:{top:0,left:0},rotation:0,id:r})})}else{var u=r.get("meta_value"),a=o.width()/u.cropSize.width;s.resolve({src:u.src,srcFull:u.srcFull,srcOriginal:u.srcOriginal,fullSize:u.fullSize,size:{width:u.imageSize.width*a,height:u.imageSize.height*a},position:{top:u.imageOffset.top*a,left:u.imageOffset.left*a},rotation:u.rotation,id:u.imageId})}return s.promise()},openImageSelector:function(t){var n=this;Upfront.Views.Editor.ImageSelector.open().done(function(r){var i={},s=0;_.each(r,function(e,t){i=e,s=t});var o={src:i.medium?i.medium[0]:i.full[0],srcFull:i.full[0],srcOriginal:i.full[0],fullSize:{width:i.full[1],height:i.full[2]},size:i.medium?{width:i.medium[1],height:i.medium[2]}:{width:i.full[1],height:i.full[2]},position:!1,rotation:0,id:s};e("<img>").attr("src",o.srcFull).load(function(){Upfront.Views.Editor.ImageSelector.close(),n.openImageEditor(!0,o,t)})})},openImageEditor:function(t,n,r){var i=this,s=this.$(".ueditor_thumb"),o=_.extend({},n,{maskOffset:s.offset(),maskSize:{width:s.width(),height:s.height()},setImageSize:t,extraButtons:[{id:"image-edit-button-swap",text:Upfront.Settings.l10n.global.content.swap_image,callback:function(e,t){t.cancel(),i.openImageSelector(r)}}]});Upfront.Views.Editor.ImageEditor.open(o).done(function(t){var n=i.post,r=s.find("img"),o=e('<img style="z-index:2;position:relative">');i.post.meta.add([{meta_key:"_thumbnail_id",meta_value:t.imageId},{meta_key:"_thumbnail_data",meta_value:t}],{merge:!0}),r.length?(r.replaceWith(o),r=o):r=o.appendTo(s),r.attr("src",t.src)})},focus:function(t,n){var r="upfront-content-marker-";typeof t.length=="undefined"&&(t=e(t));if(t.hasClass(r+"title")||t.hasClass(r+"contents"))t.get(0).focus(),this.setSelection(t[0],n)},changeAuthor:function(e){var t=this,n=t.getAuthorData(e);this.$(".upfront-content-marker-author").html(n.display_name),this.postAuthor=e},editAuthor:function(t){t.preventDefault();var n=e(t.target);this.authorSelect.open(),this.authorSelect.$el.css({top:t.offsetY+50,left:t.offsetX+n.width(),display:"block"})},editDate:function(t){t.preventDefault();var n=e(t.target);console.log("editDate"),this.datepicker.is(":visible")&&this.datepicker.offset({top:n.offset().top+30,left:n.offset().left+n.width()});var r=this.selectedDate||this.post.get("post_date");this.datepicker.parent().show().offset({top:n.offset().top+30,left:n.offset().left+n.width()});if(r){var i=r.getHours(),s=r.getMinutes();this.datepicker.datepicker("setDate",r),this.$(".ueditor-hours-select").val(i),this.$(".ueditor-minutes-select").val(s)}},getDateFormat:function(){return Upfront.Util.date.php_format_to_js(this.partOptions.date&&this.partOptions.date.format?this.partOptions.date.format:Upfront.data.date.format)},updateDateParts:function(t){this.parts.dates.html(e.datepicker.formatDate(this.getDateFormat(),t))},editDateCancel:function(){this.updateDateParts(this.selectedDate||this.post.get("post_date")),this.$(".upfront-date_picker").hide()},editDateOk:function(){var e=this.datepicker.datepicker("getDate"),t=this.datepicker.parent(),n=t.find(".ueditor-hours-select").val(),r=t.find(".ueditor-minutes-select").val();e.setHours(n),e.setMinutes(r),this.dateOk(e),this.$(".upfront-date_picker").hide()},dateOk:function(e){this.selectedDate=e},updateDateFromBar:function(e){this.updateDateParts(e),this.dateOk(e)},editTags:function(e){this.bar.editTaxonomies(e,"post_tag")},editCategories:function(e){this.bar.editTaxonomies(e,"category")},getAuthorData:function(e){var t=-1,n=!1,r=Upfront.data.ueditor.authors;while(++t<r.length&&!n)r[t].ID==e&&(n=r[t]);return n},updateStatus:function(e){this.postStatus=e},updateVisibility:function(e,t){this.postVisibility=e,this.postPassword=t},setSelection:function(e,t){var n,r;document.createRange?(n=document.createRange(),n.selectNodeContents(e),t||n.collapse(!1),r=window.getSelection(),r.removeAllRanges(),r.addRange(n)):document.selection&&(n=document.body.createTextRange(),n.moveToElementText(e),selectall||n.collapse(!1),n.select())},titleEdited:function(e){var t=e.target.innerHTML;this.parts.titles.each(function(){this!=e.target&&(this.innerHTML=t)})},contentEdited:function(t){var n=t.currentTarget.innerHTML;this.parts.contents.each(function(){this!=t.currentTarget&&e(this).redactor("set",n,!1)}),this.currentContent=t.currentTarget},prepareBar:function(){var e=this;if(this.bar)return;this.bar=new f({post:this.post}),this.bindBarEvents(),this.bar.render(),this.$el.append(this.bar.$el),e.bar.setPosition();return},bindBarEvents:function(){var t=this,n=["cancel","publish","draft","trash"];_.each(n,function(n){t.listenTo(t.bar,n,function(){var r={};if(n=="publish"||n=="draft"){t.parts.titles&&(r.title=e.trim(t.parts.titles.text()));if(t.currentContent){var i=e(t.currentContent).data("ueditor");r.content=e.trim(i.getValue()),r.inserts=i.getInsertsData(),r.author=t.postAuthor}t.selectedDate&&(r.date=t.selectedDate),t.postStatus&&(r.status=t.postStatus),t.postVisibility&&(r.visibility=t.postVisibility),t.postPassword&&(r.pass=t.postPassword)}t.trigger(n,r)})}),this.listenTo(t.bar,"date:updated",t.updateDateFromBar).listenTo(t.bar,"date:cancel",t.editDateCancel).listenTo(t.bar.statusSection,"status:change",t.updateStatus).listenTo(t.bar.visibilitySection,"visibility:change",t.updateVisibility).listenTo(t.bar,"tax:refresh",t.refreshTaxonomies)},refreshTaxonomies:function(){if(!this.parts.tags.length&&!this.parts.categories.length)return;if(this.taxLoading)return;var e=this,t=this.postView.partOptions||{},n=this.postView.partTemplates||{},r={action:"content_part_markup",post_id:this.post.get("ID"),parts:[],templates:{}};this.parts.tags.length&&(r.parts.push({slug:"tags",options:t.tags||{}}),r.templates.tags=n.tags||""),this.parts.categories.length&&(r.parts.push({slug:"categories",options:t.categories||{}}),r.templates.categories=n.categories||""),r.parts=JSON.stringify(r.parts),setTimeout(function(){e.taxLoading=Upfront.Util.post(r).done(function(t){var n=e.postView.partContents;_.extend(n.replacements,t.data.replacements),_.extend(n.tpls,t.data.tpls),e.parts.tags.html(t.data.tpls.tags),e.parts.categories.html(t.data.tpls.categories),e.taxLoading=!1})},300)},stop:function(){Upfront.Events.off("upfront:element:edit:stop",this.element_stop_prop),this.onTitleEdited&&this.parts.titles.off("change",this.onTitleEdited),this.editors&&_.each(this.editors,function(e){e.stop()});var e=this.$el.closest(".ui-draggable");e.length&&(cancel=e.draggable("enable")),this.$("a").data("bypass",!1)},preventLinkNavigation:function(e){e.preventDefault()}}),s=Backbone.View.extend({events:{"click .ueditor-btn-edit":"toggleEditor","click .ueditor-button-cancel":"cancelEdit","click .ueditor-button-small-ok":"update",'change input[type="radio"][name="visibility"]':"visibility_radio_change","change input[name='visibility']":"set_visibility"},toggleEditor:function(t){t.preventDefault();var n=e(t.target),r=n.siblings(".ueditor-togglable"),i=n.closest(".misc-pub-section").find(".ueditor-previous-data-toggle");e(".ueditor-box-content-wrap .ueditor-togglable").not(r).slideUp(),e(".ueditor-box-content-wrap .ueditor-btn-edit").show(),e(".ueditor-previous-data-toggle").not(i).show(),i.hide(),n.hide(),r.slideDown(100)},cancelEdit:function(t){t.preventDefault();var n=e(t.target),r=n.closest(".misc-pub-section").find(".ueditor-previous-data-toggle");r.show(),n.closest(".ueditor-togglable").slideUp(100,function(){n.closest(".ueditor-togglable").siblings(".ueditor-btn-edit").show()})},visibility_radio_change:function(t){var n=e(t.target),r=n.val(),i=e(".ueditor-togglable-child-"+r);n.closest(".ueditor-togglable").find(".ueditor-togglable-child").not(i).hide(),i.show()}}),o=s.extend({termListingTpl:_.template(e(t).find("#upfront-term-list-tpl").html()),termSingleTpl:_.template(e(t).find("#upfront-term-single-tpl").html()),defaults:{title:"Categories"},className:"upfront-taxonomy-hierarchical",events:_.extend({},s.prototype.events,this.events,{"click #upfront-tax-add_term":"handle_new_term","click #add-new-taxonomies-btn":"toggle_add_new","keydown #upfront-add_term":"handle_enter_new_term","change .upfront-taxonomy_item":"handle_terms_update","keydown #upfront-new_term":"handle_enter_new_term","click .ueditor-save-post-hie-tax":"update"}),updateTimer:!1,allTerms:!1,initialize:function(e){},render:function(){var e=this,t=e.collection.pluck("term_id"),n=this.allTerms.sortBy(function(e,n){return t.indexOf(e.get("term_id"))!==-1});this.$el.html(this.termListingTpl(_.extend(this.defaults,{allTerms:this.allTerms.where({parent:"0"}),postTerms:this.collection,termTemplate:this.termSingleTpl,labels:this.collection.taxonomyObject.labels})))},handle_new_term:function(){var t=this,n=this.$(".upfront-tax-new_term"),r=n.val(),i,s;if(!r)return!1;e("#upfront-taxonomy-parents").length&&(i=e("#upfront-taxonomy-parents").val()),s=new Upfront.Models.Term({taxonomy:this.collection.taxonomy,name:r,parent:i}),s.save().done(function(e){t.allTerms.add(s),t.collection.add(s)});var o=this.termSingleTpl({term:s,termTemplate:t.termSingleTpl,termId:s.get("term_id"),postTerms:t.collection,selected:!0});this.$("#upfront-taxonomy-list").prepend(o),this.$("#upfront-taxonomy-list").scrollTop(0),n.val("")},handle_terms_update:function(t){var n=this,r=e(t.target),i=r.val();r.is(":checked")?this.collection.add(this.allTerms.get(i)):this.collection.remove(this.allTerms.get(i))},handle_enter_new_term:function(e){e.which==13&&this.handle_new_term(e)},update:function(e){this.collection.save(),this.render()},toggle_add_new:function(){this.$(".ueditor-togglable-child").slideToggle()}}),u=s.extend({className:"upfront-taxonomy-flat",termListTpl:_.template(e(t).find("#upfront-flat-term-list-tpl").html()),termSingleTpl:_.template(e(t).find("#upfront-term-flat-single-tpl").html()),changed:!1,updateTimer:!1,events:_.extend({},s.prototype.events,{"click .ueditor-button-small-flat-tax-add":"handle_new_term","click .upfront-taxonomy_item-flat":"handle_term_click","keydown #upfront-flat-tax-add_term":"handle_enter_new_term","keydown .upfront-flat-tax-new_term":"handle_enter_new_term","click .upfront-taxonomy-list-choose-from-prev":"toggle_prev_used_tax"}),initialize:function(e){this.collection.on("add remove",this.update,this)},render:function(){var e=this,t=[],n=[];this.allTerms.each(function(r,i){r.children=[],e.collection.get(r.get("term_id"))?t.push(r):n.push(r)}),this.$el.html(this.termListTpl({currentTerms:t,otherTerms:n,termTemplate:this.termSingleTpl,labels:this.collection.taxonomyObject.labels}))},handle_term_click:function(t){var n=this,r=e(t.currentTarget),i=r.attr("data-term_id");r.parent().attr("id")=="upfront-taxonomy-list-current"?this.collection.remove(i):this.collection.add(this.allTerms.get(i))},handle_new_term:function(e){e.preventDefault();var t=this,n=this.$(".upfront-flat-tax-new_term").val(),r;if(!n)return!1;r=new Upfront.Models.Term({taxonomy:this.collection.taxonomy,name:n}),r.save().done(function(e){t.allTerms.add(r),t.collection.add(r).save()})},handle_enter_new_term:function(e){e.which==13&&this.handle_new_term(e)},toggle_prev_used_tax:function(e){e.preventDefault(),this.$(".ueditor-togglable-child").slideToggle()},update:function(e){this.collection.save(),this.render()}}),a=Backbone.View.extend({tpl:!1,className:"ueditor-select ueditor-popup upfront-ui",events:{"blur input":"close","click .ueditor-select-option":"select"},initialize:function(e){this.opts=e.options,this.render()},render:function(){this.tpl||(this.tpl=this.getTpl()),this.tpl&&this.$el.html(this.tpl({options:this.opts}))},open:function(){var t=this;this.tpl||this.render(),this.$el.css("display","inline-block"),this.delegateEvents(),e(document).one("click",function(n){var r=t.$el.parent().length?t.$el.parent():t.$el,i=e(n.target);!i.is(r[0])&&!i.closest(r[0]).length&&t.close()})},close:function(e){var t=this;setTimeout(function(){t.$el.hide()},200)},select:function(t){t.preventDefault();var n=e(t.target).data("id");this.trigger("select",n),this.$("input").val("value"),this.$el.hide()},getTpl:function(){return this.tpl?this.tpl:Upfront.data&&Upfront.data.tpls?_.template(e(Upfront.data.tpls.popup).find("#microselect-tpl").html()):!1}}),f=Backbone.View.extend({className:"ueditor-box-wrapper upfront-ui",post:!1,offset:{min:0,max:0},position:{min:0,max:0},onScrollFunction:!1,statusSelect:!1,visibilitySelect:!1,events:{"click .ueditor-action-preview":"navigate_to_preview","click .ueditor-action-cancel":"cancel","click .ueditor-action-publish":"publish","click .ueditor-action-draft":"saveDraft","click .ueditor-action-trash":"trash","click .ueditor-action-tags":"editTaxonomies","click .ueditor-box-title":"toggle_section","click .ueditor-save-post-data":"save_post_data"},initialize:function(n){var r=this;this.post=n.post,this.statusSection=new c({post:this.post}),this.visibilitySection=new h({post:this.post}),this.scheduleSection=new p({post:this.post}),this.urlEditor=new l({post:this.post}),this.tpl=_.template(e(t).find("#ueditor-box-main").html()),this.datepickerTpl=_.template(e(Upfront.data.tpls.popup).find("#datepicker-tpl").html()),Upfront.Events.trigger("upfront:element:edit:start","write",this.post),Upfront.Events.on("upfront:element:edit:stop",this.element_stop_prop,this)},element_stop_prop:function(){Upfront.Application.mode.current===Upfront.Application.MODE.POSTCONTENT&&Upfront.Application.current_subapplication.contentEditor&&e(".upfront-module").draggable("disable").resizable("disable")},render:function(){this.destroy();if(!Upfront.Settings.Application.MODE.ALLOW.match(Upfront.Settings.Application.MODE.CONTENT))return!1;var e=this,t=this.post.toJSON(),n={},r=e.post.get("guid");n.rootUrl=r?r.replace(/\?.*$/,""):window.location.origin+"/",t.permalink=this.permalink=n.rootUrl+this.post.get("post_name"),t.buttonText=this.getButtonText(),t.draftButton=["publish","future"].indexOf(this.initialStatus)==-1,t.cancelButton=!this.post.is_new,t.cid=this.cid,this.$el.html(this.tpl(_.extend(t,n))),this.populateSections()},navigate_to_preview:function(e){e.preventDefault(),this.post.is_new&&(this.post.trigger("editor:draft"),this.trigger("draft")),window.open(this.permalink,"_blank")},renderTaxonomyEditor:function(e,t){var n=this,t=typeof t=="undefined"?"category":t,r=new Upfront.Collections.TermList([],{postId:this.post.id,taxonomy:t});r.fetch({allTerms:!0}).done(function(t){var n=t.data.taxonomy.hierarchical?o:u,i=new n({collection:r});i.allTerms=new Upfront.Collections.TermList(t.data.allTerms),i.render(),e.html(i.$el)})},populateSections:function(){this.$(".misc-pub-post-status").html(this.statusSection.$el),this.$(".misc-pub-visibility").html(this.visibilitySection.$el),this.$(".misc-pub-schedule").html(this.scheduleSection.$el),this.$(".misc-pub-section.misc-pub-post-url").html(this.urlEditor.$el),this.renderTaxonomyEditor(this.$(".misc-pub-post-category"),"category"),this.renderTaxonomyEditor(this.$(".misc-pub-post-tags"),"post_tag")},getButtonText:function(){var e=this.initialStatus,t=this.post.get("post_date"),n=new Date;return t=t?t.getTime():0,n=n.getTime(),n<t?e=="future"?Upfront.Settings.l10n.global.content.update:Upfront.Settings.l10n.global.content.schedule:e=="publish"?Upfront.Settings.l10n.global.content.update:Upfront.Settings.l10n.global.content.publish},setPosition:function(){var t=this.$el.closest(".upfront-output-this_post"),n=e(".upfront-postpart-contents"),r=e("body").width()-(t.width()+t.offset().left),i=r>this.$el.width()?r-this.$el.width():10;this.$el.css({right:i+10})},destroy:function(){},cancel:function(e){e.preventDefault(),confirm(Upfront.Settings.l10n.global.content.discard_changes.replace(/%s/,this.post.get("post_title")))&&(this.destroy(),this.post.trigger("editor:cancel"),this.trigger("cancel"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post))},publish:function(e){e.preventDefault(),this.post.trigger("editor:publish"),this.trigger("publish"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post),Upfront.Application.sidebar.toggleSidebar()},saveDraft:function(e){e.preventDefault(),this.destroy(),this.post.trigger("editor:draft"),this.trigger("draft"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post)},trash:function(e){e.preventDefault(),confirm(Upfront.Settings.l10n.global.content.delete_confirm.replace(/%s/,this.post.get("post_type")))&&(this.destroy(),this.trigger("trash"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post))},editTaxonomies:function(t,n){t&&t.preventDefault();var r=this,i=e("body").append('<div id="upfront-post_taxonomies" style="display:none" />'),s=e("#upfront-post_taxonomies"),a={},f={category:!1,post_tag:!1},l=n||"category",c={},h=Upfront.Popup.open(function(t,n,r){var i=e(this);i.empty().append('<p class="upfront-popup-placeholder">'+Upfront.Settings.l10n.global.content.popup_loading+"</p>").append(s),a={top:n,content:i,bottom:r}}),p=function(t){var n=e(t),i=n.attr("data-type"),s=n.attr("rel"),h=c[i]?c[i]:!1;return a.top.find(".upfront-tabs li").removeClass("active"),n.addClass("active"),l=i,f[i]?d(f[i]):(h||(h=new Upfront.Collections.TermList([],{postId:r.post.id,taxonomy:i}),c[i]=h),a.content.html('<p class="upfront-popup-placeholder">'+Upfront.Settings.l10n.global.content.popup_loading+"</p>"),h.fetch({allTerms:!0}).done(function(e){var t=e.data.taxonomy.hierarchical?o:u,n=new t({collection:h});n.allTerms=new Upfront.Collections.TermList(e.data.allTerms),f[i]=n,d()}),r.listenToOnce(Upfront.Events,"popup:closed",r.refreshTaxonomies),!1)},d=function(e){var t=f[l];t.render(),a.content.html(t.$el),t.setElement(t.$el)};e(".upfront-popup-placeholder").remove(),a.top.html('<ul class="upfront-tabs"><li data-type="category" class="tax-category">'+Upfront.Settings.l10n.global.content.categories+"</li>"+'<li data-type="post_tag" class="tax-post_tag">'+Upfront.Settings.l10n.global.content.tags+"</li>"+"</ul>"+a.top.html()),a.top.find(".upfront-tabs li").on("click",function(){p(this)}),s.show(),p(a.top.find(".tax-"+l)),Upfront.Events.on("upfront:post:taxonomy_changed",function(){p(a.top.find(".upfront-tabs li.active"))})},refreshTaxonomies:function(){this.trigger("tax:refresh")},toggle_section:function(t){t.preventDefault();var n=e(t.target),r=n.closest(".ueditor-box-section"),i=r.find(".ueditor-box-content-wrap");r.toggleClass("show"),i.slideToggle()}}),l=s.extend({className:"upfront-slug_editor-url",tpl:_.template(e(t).find("#post-url-editor").html()),initialize:function(e){this.post=e.post,this.render()},render:function(){var e=this,t=this.post.get("guid");t=t?t.replace(/\?.*$/,""):window.location.origin+"/",this.$el.html(this.tpl({rootUrl:t,slug:e.post.get("post_name")}))},update:function(e){e.preventDefault();var t=this.$(".ueditor-post-url-text").val();t.length>1&&(this.post.set("post_name",t),this.render())}}),c=s.extend({statusOptions:{future:{value:"future",name:Upfront.Settings.l10n.global.content.scheduled},publish:{value:"publish",name:Upfront.Settings.l10n.global.content.published},pending:{value:"pending",name:Upfront.Settings.l10n.global.content.pending_review},draft:{value:"draft",name:Upfront.Settings.l10n.global.content.draft},"private":{value:"private",name:Upfront.Settings.l10n.global.content.private_post},"auto-draft":{value:"auto-draft",name:Upfront.Settings.l10n.global.content.new_post},trash:{value:"trash",name:Upfront.Settings.l10n.global.content.deleted_post}},initialStatus:!1,tpl:_.template(e(t).find("#post-status-tpl").html()),initialize:function(e){this.post=e.post,this.render()},render:function(){return this.initialStatus=this.currentStatus=this.post.get("post_status"),this.status=this.getStatus(),this.options=this.getStatusOptions(),this.$el.html(this.tpl(_.extend(this.post,{status:this.status},{options:this.options}))),this},getStatusOptions:function(e){var t=[],n=this.initialStatus;return n=="publish"?t.push(this.statusOptions.publish):n=="future"&&t.push(this.statusOptions.future),t.push(this.statusOptions.pending),t.push(this.statusOptions.draft),n=="private"&&(t=[this.statusOptions.private]),t},getStatus:function(){var e=this.post.get("post_status");return["auto-draft","draft","pending"].indexOf(e)!=-1?this.statusOptions[e]:this.statusOptions[this.initialStatus]},update:function(e){e.preventDefault();var t=this.$("select").val();!_.isEmpty(t)&&t!==this.initialStatus&&(this.post.set("post_status",t),this.trigger("status:change",t),this.render())}}),h=s.extend({tpl:_.template(e(t).find("#post-visibility-tpl").html()),post_password:"",postVisibility:!1,visibilityOptions:{"public":{value:"public",name:Upfront.Settings.l10n.global.content.public_post},sticky:{value:"sticky",name:Upfront.Settings.l10n.global.content.sticky},password:{value:"password",name:Upfront.Settings.l10n.global.content.protected_post},"private":{value:"private",name:Upfront.Settings.l10n.global.content.is_private}},initialize:function(e){this.post=e.post,this.render()},render:function(){return this.postVisibility=this.postVisibility?this.postVisibility:this.post.getVisibility(),this.status=this.visibilityOptions[this.postVisibility],this.postVisibility=="password"&&(this.post_password=this.post.get("post_password")),this.$el.html(this.tpl(_.extend({},this.post,{status:this.status,post_password:this.post_password}))),this},getVisibilityOptions:function(){var e=this.post.getVisibility(),t=this.visibilityOptions;return e=="password"?[{value:"password",name:Upfront.Settings.l10n.global.content.edit_pwd},t.public,t.sticky,t.private]:_.values(t)},set_visibility:function(t){var n=e(t.target).val();this.postVisibility=n},update:function(){var e=this.$(".ueditor-post-pass"),t=e.val();this.postVisibility=this.$("input[name='sticky']").is(":checked")?this.postVisibility="sticky":this.postVisibility;if(!this.visibilityOptions.hasOwnProperty(this.postVisibility))return;switch(this.postVisibility){case"password":if(t===""){e.css("border","1px solid red");return}e.css("border","1px solid #a3bfd9"),this.post.setVisibility(this.postVisibility),this.post.set("post_password",t),this.trigger("visibility:change","password",t);break;default:this.post.setVisibility(this.postVisibility),this.trigger("visibility:change",this.postVisibility,"")}this.render()}}),p=s.extend({tpl:_.template(e(t).find("#post-schedule-tpl").html()),initialize:function(e){this.post=e.post,this.render()},render:function(){var e=new Object;return this.initialDate=this.post.get("post_date"),e.currentMonth=this.initialDate.getMonth(),e.currentYear=this.initialDate.getFullYear(),e.currentDay=this.initialDate.getDate(),e.currentHour=this.initialDate.getHours(),e.currentMinute=this.initialDate.getMinutes(),this.schedule=this.getSchedule(),this.$el.html(this.tpl(_.extend({},this.post,e,{schedule:this.schedule}))),this},getSchedule:function(){var e=new Date,t=this.initialDate,n=Upfront.Util.format_date;return!t&&!this.initialDate?{key:Upfront.Settings.l10n.global.content.publish,text:Upfront.Settings.l10n.global.content.immediately}:t.getTime()==this.initialDate?t.getTime()<e.getTime()?{key:Upfront.Settings.l10n.global.content.published,text:n(t,!0)}:{key:Upfront.Settings.l10n.global.content.scheduled,text:n(t,!0)}:t.getTime()<e.getTime()?{key:Upfront.Settings.l10n.global.content.publish_on,text:n(t,!0)}:{key:Upfront.Settings.l10n.global.content.scheduled_for,text:n(t,!0)}},update:function(){var e=new Date,t=this.$("input[name='yy']").val(),n=this.$("select[name='mm']").val(),r=this.$("input[name='jj']").val(),i=this.$("input[name='hh']").val(),s=this.$("input[name='mn']").val();e.setFullYear(t),e.setMonth(n),e.setDate(r),e.setHours(i),e.setMinutes(s),this.post.set("post_date",e),this.render()}});return{PostContentEditor:i,getMarkupper:function(){return r}}})})(jQuery);