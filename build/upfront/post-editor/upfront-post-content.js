(function(e){define([],function(){var t=function(){this.parts={title:{replacements:["%title%","%permalink%"],editable:["%title%"]},contents:{replacements:["%contents%","%excerpt%"],editable:["%contents%","%excerpt%"]},author:{replacements:["%author%","%author_url%","%author_meta%"],editable:["%author%"],withParameters:["%author_meta_","%avatar_"]},categories:{replacements:["%categories%"],editable:[]},tags:{replacements:["%tags%"],editable:[]},comments_count:{replacements:["%comments_count%"],editable:[]},featured_image:{replacements:["%image%","%permalink%"],editable:["%image%"]},date:{replacements:["%date%","%date_iso%"],editable:["%date%"]}},this.markup=function(e,t,n){var r=this,i=t["%offset%"],s=typeof i=="number"&&i!==""?"upfront-content-offset-"+i:"";_.each(this.parts[e].replacements,function(i){var o=t[i];r.parts[e].editable.indexOf(i)!==-1&&(o='<div class="upfront-content-marker '+s+" upfront-content-marker-"+e+'">'+o+"</div>"),n=n.replace(i,o)});var o=this.parts[e].withParameters;return o&&_.each(o,function(e){var r=new RegExp(e+"[^%]+%","gm"),i=r.exec(n);_.each(i,function(e){n=typeof t[e]=="undefined"?"":n.replace(e,t[e])})}),n}},n=new t,r=Backbone.View.extend({events:{"click a":"preventLinkNavigation"},initialize:function(e){this.post=e.post,this.triggeredBy=e.triggeredBy||this.$(".upfront-content-marker").first(),console.log(e),this.parts={},this.$el.addClass("clearfix").css("paddong-bottom","60px"),this.$("a").data("bypass",!0);var t=this.$el.closest(".ui-draggable");t.length&&(cancel=t.draggable("disable")),this.prepareEditableRegions(),this.prepareBar()},prepareEditableRegions:function(){var t=this;this.parts.titles=this.$(".upfront-content-marker-title"),this.parts.titles.length&&(this.onTitleEdited=_.bind(this.titleEdited,this),this.parts.titles.attr("contenteditable",!0).on("keyup",this.onTitleEdited).on("keydown",function(e){if(e.which!=9)return;e.preventDefault(),t.focus(t.$(".upfront-content-marker-contents"),!0)})),this.parts.contents=this.$(".upfront-content-marker-contents"),this.parts.contents.length&&(this.onContentsEdited=_.bind(this.contentEdited,this),this.editors=[],this.parts.contents.ueditor({linebreaks:!1,autostart:!0,pastePlainText:!0}),this.parts.contents.on("keyup",this.onContentsEdited),this.parts.contents.each(function(){t.editors.push(e(this).data("ueditor"))}),this.currentContent=this.parts.contents[0]),setTimeout(function(){t.focus(t.triggeredBy,!1)},200)},focus:function(t,n){var r="upfront-content-marker-";typeof t.length=="undefined"&&(t=e(t)),(t.hasClass(r+"title")||t.hasClass(r+"contents"))&&this.setSelection(t[0],n)},setSelection:function(e,t){var n,r;document.createRange?(n=document.createRange(),n.selectNodeContents(e),t||n.collapse(!1),r=window.getSelection(),r.removeAllRanges(),r.addRange(n)):document.selection&&(n=document.body.createTextRange(),n.moveToElementText(e),selectall||n.collapse(!1),n.select())},titleEdited:function(e){var t=e.target.innerHTML;this.parts.titles.each(function(){this!=e.target&&(this.innerHTML=t)})},contentEdited:function(t){var n=t.currentTarget.innerHTML;this.parts.contents.each(function(){this!=t.currentTarget&&e(this).redactor("set",n,!1)}),this.bar.calculateLimits(),this.currentContent=t.currentTarget},prepareBar:function(){if(this.bar){this.bar.calculateLimits();return}this.bar=new i({post:this.post}),this.bindBarEvents(),this.bar.render(),this.$el.append(this.bar.$el),this.bar.stick();return},bindBarEvents:function(){var t=this,n=["cancel","publish","draft","trash"];_.each(n,function(n){t.listenTo(t.bar,n,function(){var r={};if(n=="publish"||n=="draft")t.parts.titles&&(r.title=e.trim(t.parts.titles.html())),t.currentContent&&(r.content=e.trim(t.currentContent.innerHTML));t.trigger(n,r)})})},stop:function(){this.onTitleEdited&&this.parts.titles.off("change",this.onTitleEdited),this.editors&&_.each(this.editors,function(e){e.stop()});var e=this.$el.closest(".ui-draggable");e.length&&(cancel=e.draggable("enable")),this.$("a").data("bypass",!1)},preventLinkNavigation:function(e){e.preventDefault()}}),i=Backbone.View.extend({className:"ueditor-bar-wrapper upfront-ui",post:!1,offset:{min:0,max:0},position:{min:0,max:0},onScrollFunction:!1,statusOptions:{future:{value:"future",name:"Scheduled"},publish:{value:"publish",name:"Published"},pending:{value:"pending",name:"Pending Review"},draft:{value:"draft",name:"Draft"},"private":{value:"private",name:"Privately Published"},"auto-draft":{value:"auto-draft",name:"New"},trash:{value:"trash",name:"Deleted"}},visibilityOptions:{"public":{value:"public",name:"Public"},sticky:{value:"sticky",name:"Sticky"},password:{value:"password",name:"Protected"},"private":{value:"private",name:"Private"}},statusSelect:!1,visibilitySelect:!1,initialStatus:!1,events:{"click .ueditor-action-cancel":"cancel","click .ueditor-action-publish":"publish","click .ueditor-action-draft":"saveDraft","click .ueditor-action-trash":"trash","click .ueditor-action-url":"editUrl","click .ueditor-action-tags":"editTaxonomies","click .ueditor-select-value":"editSelect","click .ueditor-pass-ok":"changePass","click .ueditor-action-schedule":"openDatepicker","click .ueditor-bar-show_advanced":"toggleAdvanced"},initialize:function(t){var n=this;this.post=t.post,this.initialStatus=this.post.get("post_status"),this.initialDate=this.post.get("post_date"),this.initialDate&&(this.initialDate=this.initialDate.getTime()),this.tpl=_.template(Upfront.data.uposts.barTemplate),this.datepickerTpl=_.template(e(Upfront.data.tpls.popup).find("#datepicker-tpl").html()),Upfront.Events.trigger("upfront:element:edit:start","write",this.post)},render:function(){this.destroy();var t=this,n=this.post.toJSON(),r=this.post.get("post_date"),i={};n.status=this.getBarStatus(),n.visibility=this.visibilityOptions[this.post.getVisibility()],n.schedule=this.getSchedule(),n.buttonText=this.getButtonText(),n.draftButton=["publish","future"].indexOf(this.initialStatus)==-1,n.cancelButton=!this.post.is_new,n.cid=this.cid,i.minutes=_.range(0,60),i.hours=_.range(0,24),i.currentHour=r.getHours(),i.currentMinute=r.getHours(),n.datepicker=this.datepickerTpl(i),this.$el.html(this.tpl(n)),this.$(".upfront-bar-datepicker").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"yy-mm-dd",onChangeMonthYear:function(e,n){var r=t.$(".upfront-bar-datepicker"),i=r.datepicker("getDate").getDate();i=i<10?"0"+i:i,e=e<10?"0"+e:e,t.$(".upfront-bar-datepicker").datepicker("setDate",n+"-"+e+"-"+i)}}),this.prepareSelectBoxes(),e("#ui-datepicker-div").addClass("upfront-date_picker upfront-ui"),e("#"+this.cid).length&&this.stick()},prepareSelectBoxes:function(){var e=this;this.statusSelect=new u({options:this.getStatusOptions()}),this.visibilitySelect=new u({options:this.getVisibilityOptions()}),this.statusSelect.on("select",function(t){e.post.set("post_status",t),e.render()}),this.visibilitySelect.on("select",function(t){t=="password"?e.showPassEditor(e.$(".ueditor-select-visibility")):(e.post.setVisibility(t),e.render())}),this.$(".ueditor-select-visibility").append(this.visibilitySelect.$el),this.$(".ueditor-select-status").append(this.statusSelect.$el)},getBarStatus:function(){var e=this.post.get("post_status");return["auto-draft","draft","pending"].indexOf(e)!=-1?this.statusOptions[e]:this.statusOptions[this.initialStatus]},getSchedule:function(){var e=new Date,t=this.post.get("post_date"),n=Upfront.Util.format_date;return!t&&!this.initialDate?{key:"Publish",text:"Inmediately"}:t.getTime()==this.initialDate?t.getTime()<e.getTime()?{key:"Published",text:n(t,!0)}:{key:"Scheduled",text:n(t,!0)}:t.getTime()<e.getTime()?{key:"Publish on",text:n(t,!0)}:{key:"Schedule",text:n(t,!0)}},openDatepicker:function(e){var t=this.post.toJSON().post_date,n=t?t.split(" ")[0]:!1;this.$(".upfront-date_picker").toggle();if(n){this.$(".upfront-bar-datepicker").datepicker("setDate",n),n=this.post.get("post_date");var r=n.getHours(),i=n.getMinutes();this.$(".ueditor-hours-select").val(r),this.$(".ueditor-minutes-select").val(i)}},getStatusOptions:function(e){var t=[],n=this.initialStatus;return n=="publish"?t.push(this.statusOptions.publish):n=="future"&&t.push(this.statusOptions.future),t.push(this.statusOptions.pending),t.push(this.statusOptions.draft),n=="private"&&(t=[this.statusOptions.private]),t},getVisibilityOptions:function(){var e=this.post.getVisibility(),t=this.visibilityOptions;return e=="password"?[{value:"password",name:"Edit password..."},t.public,t.sticky,t.private]:_.values(t)},getButtonText:function(){var e=this.initialStatus,t=this.post.get("post_date"),n=new Date;return t=t?t.getTime():0,n=n.getTime(),n<t?e=="future"?"Update":"Schedule":e=="publish"?"Update":"Publish"},calculateLimits:function(){var e=this.$(".ueditor-bar-ph"),t=this.$el.parent();if(!t.length)return!1;var n=t.height();if(n==this.containerHeight)return;var r=t.offset().top;this.position={min:100,max:n},this.offset={min:this.position.min+r,max:this.position.max+r+2*this.$el.height()},this.onScroll(null,this.$(".ueditor-bar"))},onScroll:function(t,n){var r=this,i=e(window).scrollTop()+e(window).height(),s=n.css("position");s=="fixed"?i<=r.offset.min?(n.css({position:"absolute",bottom:"auto",top:r.position.min+"px",left:0,width:"100%",opacity:1}).removeClass("floating"),r.calculateLimits()):i>=r.offset.max&&(n.css({position:"absolute",bottom:"auto",top:"100%",left:0,width:"100%",opacity:1}).removeClass("floating"),r.calculateLimits()):s=="absolute"&&i<r.offset.max&&i>r.offset.min&&(n.css({position:"fixed",bottom:"0px",left:n.offset().left+"px",top:"auto",width:n.outerWidth()+"px",opacity:.4}).addClass("floating").removeClass("show-advanced"),r.calculateLimits())},stick:function(){var t=this.$(".ueditor-bar-ph"),n=this.$(".ueditor-bar"),r=this.$el.parent(),i=this;t.height(n.height()),r.css("position","relative"),n.css({position:"absolute",bottom:"0",left:"0",width:"100%"}),this.calculateLimits(),this.onScrollFunction=function(e){i.onScroll(e,n)},e(window).on("scroll",this.onScrollFunction).on("resize",this.onScrollFunction),this.onScroll(null,n)},destroy:function(){e(window).off("scroll",this.onScrollFunction).off("resize",this.onScrollFunction),this.onScrollFunction=!1},cancel:function(e){e.preventDefault(),confirm("Are you sure to discard the changes made to "+this.post.get("post_title")+"?")&&(this.destroy(),this.post.trigger("editor:cancel"),this.trigger("cancel"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post))},publish:function(e){e.preventDefault(),this.destroy(),this.initialStatus=this.post.get("post_status"),this.initialDate=this.post.get("post_date").getTime(),this.post.trigger("editor:publish"),this.trigger("publish"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post)},saveDraft:function(e){e.preventDefault(),this.destroy(),this.initialStatus=this.post.get("post_status"),this.initialDate=this.post.get("post_date").getTime(),this.post.trigger("editor:draft"),this.trigger("draft"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post)},trash:function(e){e.preventDefault(),confirm("Are you sure you want to delete this "+this.post.get("post_type")+"?")&&(this.destroy(),this.post.trigger("editor:trash"),Upfront.Events.trigger("upfront:element:edit:stop","write",this.post))},editUrl:function(t){t.preventDefault();var n=this,r={},i=Upfront.Popup.open(function(t,n,i){var s=e(this);s.empty().append('<p class="upfront-popup-placeholder">No such thing as <q>too many drinks</q>.</p>'),r={top:n,content:s,bottom:i}}),s=function(e){n.post.set("post_name",e),Upfront.Popup.close()},o=_.template(e(Upfront.data.tpls.popup).find("#upfront-slug-tpl").html());r.content.html(o({rootURL:window.location.origin+"/",slug:n.post.get("post_name")})),r.content.off("click","#upfront-post_slug-send").on("click","#upfront-post_slug-send",function(){s(e("#upfront-post_slug").val())}).off("keydown","#upfront-post_slug").on("keydown","#upfront-post_slug",function(t){t.which==13&&(t.preventDefault(),s(e("#upfront-post_slug").attr("disabled",!0).val()))})},editTaxonomies:function(t){t&&t.preventDefault();var n=this,r=e("body").append('<div id="upfront-post_taxonomies" style="display:none" />'),i=e("#upfront-post_taxonomies"),u={},a={category:!1,post_tag:!1},f="category",l={},c=Upfront.Popup.open(function(t,n,r){var s=e(this);s.empty().append('<p class="upfront-popup-placeholder"><q>I enjoy eating cheese.</q></p>').append(i),u={top:n,content:s,bottom:r}}),h=function(t){var r=e(t),i=r.attr("data-type"),c=r.attr("rel"),h=l[i]?l[i]:!1;return u.top.find(".upfront-tabs li").removeClass("active"),r.addClass("active"),f=i,a[i]?p(a[i]):(h||(h=new Upfront.Collections.TermList([],{postId:n.post.id,taxonomy:i}),l[i]=h),u.content.html('<p class="upfront-popup-placeholder"><q>Them frogs chirp really loud today.</q></p>'),h.fetch({allTerms:!0}).done(function(e){var t=e.data.taxonomy.hierarchical?s:o,n=new t({collection:h});n.allTerms=new Upfront.Collections.TermList(e.data.allTerms),a[i]=n,p()}),!1)},p=function(e){var t=a[f];t.render(),u.content.html(t.$el),t.setElement(t.$el)};e(".upfront-popup-placeholder").remove(),u.top.html('<ul class="upfront-tabs"><li data-type="category">Categories</li><li data-type="post_tag">Tags</li></ul>'+u.top.html()),u.top.find(".upfront-tabs li").on("click",function(){h(this)}),i.show(),h(u.top.find(".upfront-tabs li:first")),Upfront.Events.on("upfront:post:taxonomy_changed",function(){h(u.top.find(".upfront-tabs li.active"))})},editSelect:function(t){t.preventDefault();var n=e(t.target).data("id");this[n+"Select"].open()},showPassEditor:function(e){var t=this.visibilityOptions.password,n=this;e.find(".ueditor-select-value").data("id",t.value).text(t.name),e.find(".ueditor-select-options").hide(),e.find(".ueditor-pass-editor").show().find("input").one("blur",function(e){setTimeout(function(){n.render()},300)}).off("keydown").on("keydown",function(e){e.which==13&&n.changePass(e)}).focus()},changePass:function(t){var n=e(t.target).parent().find("input").val();n&&(this.post.setVisibility("password"),this.post.set("post_password",n),this.render())},toggleAdvanced:function(t){t.preventDefault(),e(t.target).closest(".ueditor-bar").toggleClass("show-advanced")}}),s=Backbone.View.extend({className:"upfront-taxonomy-hierarchical",events:{"click #upfront-add_term":"handle_new_term","keydown #upfront-add_term":"handle_enter_new_term","change .upfront-taxonomy_item":"handle_terms_update","keydown #upfront-new_term":"handle_enter_new_term"},termListTpl:!1,termSingleTpl:!1,updateTimer:!1,allTerms:!1,initialize:function(t){this.termListTpl=_.template(e(Upfront.data.tpls.popup).find("#upfront-term-list-tpl").html()),this.termSingleTpl=_.template(e(Upfront.data.tpls.popup).find("#upfront-term-single-tpl").html())},render:function(){this.$el.html(this.termListTpl({allTerms:this.allTerms,postTerms:this.collection,termTemplate:this.termSingleTpl,labels:this.collection.taxonomyObject.labels}))},handle_new_term:function(){var t=this,n=this.$el.find("#upfront-new_term").val(),r,i;if(!n)return!1;e("#upfront-taxonomy-parents").length&&(r=e("#upfront-taxonomy-parents").val()),i=new Upfront.Models.Term({taxonomy:this.collection.taxonomy,name:n,parent:r}),i.save().done(function(e){t.allTerms.add(i),t.collection.add(i).save(),t.render()})},handle_terms_update:function(t){var n=this,r=e(t.target),i=r.val();r.is(":checked")?this.collection.add(this.allTerms.get(i)):this.collection.remove(this.allTerms.get(i)),clearTimeout(this.updateTimer),this.updateTimer=setTimeout(function(){n.collection.save()},2e3)},handle_enter_new_term:function(e){e.which==13&&this.handle_new_term(e)}}),o=Backbone.View.extend({className:"upfront-taxonomy-flat",termListTpl:!1,termSingleTpl:!1,changed:!1,updateTimer:!1,events:{"click #upfront-add_term":"handle_new_term","click .upfront-taxonomy_item-flat":"handle_term_click","keydown #upfront-add_term":"handle_enter_new_term","keydown #upfront-new_term":"handle_enter_new_term"},initialize:function(t){this.collection.on("add remove",this.render,this),this.termListTpl=_.template(e(Upfront.data.tpls.popup).find("#upfront-flat-term-list-tpl").html()),this.termSingleTpl=_.template(e(Upfront.data.tpls.popup).find("#upfront-term-flat-single-tpl").html())},render:function(){var e=this,t=[],n=[];this.allTerms.each(function(r,i){r.children=[],e.collection.get(r.get("term_id"))?t.push(r):n.push(r)}),this.$el.html(this.termListTpl({currentTerms:t,otherTerms:n,termTemplate:this.termSingleTpl,labels:this.collection.taxonomyObject.labels}))},handle_term_click:function(t){var n=this,r=e(t.currentTarget),i=r.attr("data-term_id");r.parent().attr("id")=="upfront-taxonomy-list-current"?this.collection.remove(i):this.collection.add(this.allTerms.get(i)),clearTimeout(this.updateTimer),this.updateTimer=setTimeout(function(){n.collection.save()},2e3)},handle_new_term:function(e){var t=this,n=this.$el.find("#upfront-new_term").val(),r;e.preventDefault();if(!n)return!1;r=new Upfront.Models.Term({taxonomy:this.collection.taxonomy,name:n}),r.save().done(function(e){t.allTerms.add(r),t.collection.add(r).save()})},handle_enter_new_term:function(e){e.which==13&&this.handle_new_term(e)}}),u=Backbone.View.extend({tpl:!1,className:"ueditor-select ueditor-popup upfront-ui",events:{"blur input":"close","click .ueditor-select-option":"select"},initialize:function(e){this.opts=e.options,this.render()},render:function(){this.tpl||(this.tpl=this.getTpl()),this.tpl&&this.$el.html(this.tpl({options:this.opts}))},open:function(){var t=this;this.tpl||this.render(),this.$el.css("display","inline-block"),this.delegateEvents(),e(document).one("click",function(n){var r=t.$el.parent().length?t.$el.parent():t.$el,i=e(n.target);!i.is(r[0])&&!i.closest(r[0]).length&&t.close()})},close:function(e){var t=this;setTimeout(function(){t.$el.hide()},200)},select:function(t){t.preventDefault();var n=e(t.target).data("id");this.trigger("select",n),this.$("input").val("value"),this.$el.hide()},getTpl:function(){return this.tpl?this.tpl:Upfront.data&&Upfront.data.tpls?_.template(e(Upfront.data.tpls.popup).find("#microselect-tpl").html()):!1}});return{PostContentEditor:r,getMarkupper:function(){return n}}})})(jQuery);