!function(e){var t={selection:[],selecting:!1,create_mergeable:function(t,o){var r=this,n=Upfront.Behaviors.LayoutEditor;r.layout.get("regions");t.$el.selectable({distance:10,filter:".upfront-module",cancel:".upfront-module:not(.upfront-module-spacer), .upfront-module-group, .upfront-region-side-fixed, .upfront-entity_meta, .upfront-region-edit-trigger, .upfront-region-edit-fixed-trigger, .upfront-region-finish-edit, .upfront-icon-control-region-resize, .upfront-inline-modal, .upfront-inline-panels",selecting:function(t,o){var r,i=e(o.selecting);if(!(i.closest(".upfront-module-group").length>0)){if(n.selection.length>0){if(r=e(n.selection[0]).closest(".upfront-region"),i.closest(".upfront-region").get(0)!=r.get(0))return;n._add_selections(r.find(".ui-selecting"),r.find(".upfront-module").not(".upfront-ui-selected, .upfront-module-parent-group"),r.find(".upfront-module-group"))}else n._add_selection(o.selecting);n._update_selection_outline()}},unselecting:function(t,o){var r,i,l=e(o.unselecting);if(n.selection.length>1){if(r=e(n.selection[0]).closest(".upfront-region"),l.closest(".upfront-region").get(0)!=r.get(0))return;return e(".upfront-ui-selected").each(function(){n._remove_selection(this)}),i=r.find(".ui-selecting"),i.length>0&&(n._add_selection(i.get(0)),n._add_selections(i,r.find(".upfront-module").not(".upfront-ui-selected, .upfront-module-parent-group"),r.find(".upfront-module-group"))),void n._update_selection_outline()}n._remove_selection(o.unselecting),n._update_selection_outline()},unselected:function(t,o){var r=e(o.unselected);r.find(".upfront-selected-border").remove(),e(".upfront-module-group-group").remove()},start:function(e,t){n.remove_selections(),n.selection=[],n.selecting=!0},stop:function(e,t){n.parse_selections()}})},refresh_mergeable:function(){this.remove_selections(),e(".ui-selectable").each(function(){e(this).selectable("refresh")})},enable_mergeable:function(){this.remove_selections(),e(".ui-selectable").each(function(){e(this).selectable("enable")})},disable_mergeable:function(){this.remove_selections(),e(".ui-selectable").each(function(){e(this).selectable("disable")})},destroy_mergeable:function(){this.remove_selections(),e(".ui-selectable").each(function(){e(this).selectable("destroy")})},parse_selections:function(){if(!e(".upfront-ui-selected").length)return!1;if(!Upfront.Application.user_can_modify_layout())return!1;var t=this,o=Upfront.Application.layout.get("regions"),r=e(".upfront-ui-selected:first").closest(".upfront-region"),n=o.get_by_name(r.data("name")),i=n?n.get("modules"):!1,l=n?n.get("wrappers"):!1,a=e(".upfront-ui-selected");if(a.length<2)return a.each(function(){t._remove_selection(this)}),e("#upfront-group-selection").remove(),!1;e(".upfront-module-group-group").remove();var s=e('<div class="upfront-module-group-toggle upfront-module-group-group">'+Upfront.Settings.l10n.global.behaviors.group+"</div>"),p=sel_left=sel_right=sel_bottom=!1,u=wrap_left=wrap_right=wrap_bottom=!1,d=group_left=0;e("body").append(s),a.each(function(){var t=e(this).offset(),o=e(this).outerWidth(),r=e(this).outerHeight(),n=e(this).closest(".upfront-wrapper"),i=n.offset(),l=n.outerWidth(),a=n.outerHeight();t.right=t.left+o,t.bottom=t.top+r,p=p===!1||t.top<p?t.top:p,sel_bottom=sel_bottom===!1||t.bottom>sel_bottom?t.bottom:sel_bottom,sel_left=sel_left===!1||t.left<sel_left?t.left:sel_left,sel_right=sel_right===!1||t.right>sel_right?t.right:sel_right,i.right=i.left+l,i.bottom=i.top+a,u=u===!1||i.top<u?i.top:u,wrap_bottom=wrap_bottom===!1||i.bottom>wrap_bottom?i.bottom:wrap_bottom,wrap_left=wrap_left===!1||i.left<wrap_left?i.left:wrap_left,wrap_right=wrap_right===!1||i.right>wrap_right?i.right:wrap_right}),d=p+Math.round((sel_bottom-p)/2)-Math.round(s.outerHeight()/2),group_left=sel_left+Math.round((sel_right-sel_left)/2)-Math.round(s.outerWidth()/2),s.css({position:"absolute",zIndex:999999,top:d,left:group_left}),setTimeout(function(){t.selecting=!1},1e3),s.on("click",function(){var o=Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),s=Upfront.Behaviors.GridEditor,p=!1,u=(Math.round((wrap_right-wrap_left)/s.grid.column_width),s.parse_modules_to_lines(i,l,o.id,o.columns)),d=[],c=[],f=[],g=0,h=0,m=0,b=!1;_.each(u,function(t){var o=[],r=[],n=[],i=[],l=[],s=0,u=0,b=0;_.each(t.wrappers,function(t){var d=[],c=[],f=[];_.each(t.modules,function(t){var o=!1;a.each(function(){var r=e(this).attr("id");t.model.get_element_id()==r&&(p===!1&&(p=Upfront.data.module_views[t.model.cid]),d.push(t),o=!0)}),o||(0==d.length?c.push(t):f.push(t))}),d.length>0?(o.push({modules:d,top_modules:c,bottom_modules:f,model:t.model,col:t.col,clear:t.clear,spacer:t.spacer,order:t.order}),s+=t.col,c.length&&i.push({modules:c,model:t.model,col:t.col,clear:t.clear,spacer:t.spacer,order:t.order}),f.length&&l.push({modules:f,model:t.model,col:t.col,clear:t.clear,spacer:t.spacer,order:t.order})):((0==o.length?r:n).push({modules:t.modules,model:t.model,col:t.col,clear:t.clear,spacer:t.spacer,order:t.order}),0==o.length?u+=t.col:b+=t.col)}),o.length>0&&(d.push({wrappers:o,top_wrappers:i,bottom_wrappers:l,col:s}),g=s>g?s:g,r.length>0&&(c.push({wrappers:r,col:u}),h=u>h?u:h),n.length>0&&(f.push({wrappers:n,col:b}),m=b>m?b:m))}),s.start(p,p.model),c.length>1&&(t._do_combine(c,n)||t._do_group(c,n)),0==c.length&&0==f.length&&(b=!0),t._do_group(d,n,!1,b),f.length>1&&(t._do_combine(f,n)||t._do_group(f,n)),s.update_position_data(r.find(".upfront-editable_entities_container:first")),s.update_wrappers(n),e(this).remove(),e("#upfront-group-selection").remove(),t.selection=[]})},_do_group:function(e,t,o,r){var n=this,i=Upfront.Behaviors.GridEditor,l=o===!0,r=r===!0,a=t.get("modules"),s=t.get("wrappers"),p=Upfront.Util.get_unique_id("module-group"),u=new Upfront.Models.ModuleGroup,d=u.get("modules"),c=u.get("wrappers"),f=!1,g=!1,h=!1,m=0,b=!1,v=!1,w=Upfront.Views.breakpoints_storage.get_breakpoints().get_enabled();_.each(e,function(e,o){m=e.col>m?e.col:m,_.each(e.wrappers,function(e,t){var r=new Upfront.Models.Wrapper({}),n=Upfront.Util.get_unique_id("wrapper"),l=Upfront.data.wrapper_views[e.model.cid],p="top_modules"in e&&e.top_modules.length>0,u="bottom_modules"in e&&e.bottom_modules.length>0;r.set_property("wrapper_id",n),r.set_property("class",e.model.get_property_value_by_name("class")),r.replace_class(i.grid["class"]+e.col),0==t&&(r.add_class("clr"),0==o&&(f=e.clear)),c.add(r),_.each(e.modules,function(e,t){var o=a.indexOf(e.model),r=Upfront.data.module_views[e.model.cid];b===!1&&(b=o),e.model.set_property("wrapper_id",n,!0),a.remove(e.model,{silent:!0}),r.$el.detach(),p||u||l.$el.detach(),d.add(e.model)}),0==o&&0==t?(h=e.model.get_wrapper_id(),g=e.model):p||s.remove(e.model)}),"bottom_wrappers"in e&&e.bottom_wrappers.length>1&&(r?n._do_split(e.bottom_wrappers,t):n._do_group([{wrappers:e.bottom_wrappers,col:e.col}],t)),"top_wrappers"in e&&e.top_wrappers.length>1&&(r?(_.each(e.top_wrappers,function(e,t){_.each(e.modules,function(e,t){var o=a.indexOf(e.model);return v===!1?void(v=o):(a.remove(e.model,{silent:!0}),v++,void e.model.add_to(a,v))})}),v!==!1&&(b=v+1),l=!0):n._do_group([{wrappers:e.top_wrappers,col:e.col}],t))}),l&&(g=new Upfront.Models.Wrapper({}),h=Upfront.Util.get_unique_id("wrapper"),s.add(g)),g.set_property("wrapper_id",h),g.replace_class(i.grid["class"]+m),f&&g.add_class("clr"),u.set_property("wrapper_id",h),u.set_property("element_id",p),u.replace_class(i.grid["class"]+m),u.set_property("original_col",m);var y=g&&g.get_property_value_by_name("breakpoint")||{},U=u.get_property_value_by_name("breakpoint")||{};_.each(w,function(e){var t=e.toJSON();t["default"]||y&&y[t.id]&&y[t.id].edited&&(_.isObject(U[t.id])||(U[t.id]={edited:!1}),!U[t.id].edited&&_.isNumber(y[t.id].col)&&(U[t.id].col=y[t.id].col,U[t.id].edited=!0,u.set_property("breakpoint",Upfront.Util.clone(U))))}),u.add_to(a,b),Upfront.Events.trigger("entity:module_group:group",u,t)},_do_combine:function(e,t){var o=(Upfront.Behaviors.GridEditor,t.get("modules")),r=t.get("wrappers"),n=[],i=[],l=!0;if(_.each(e,function(e,t){t in n||(n[t]=[]),_.each(e.wrappers,function(e,o){o in i||(i[o]=[]),n[t][o]=e.col,i[o].push(e)})}),n.length>1)for(var a=1;a<n.length;a++)if(!_.isEqual(n[a-1],n[a])){l=!1;break}return l?(_.each(i,function(e){var t,n=0,i=_.filter(e,function(e){return e.spacer}),l=e.length==i.length;_.each(e,function(e,i){return 0==i?(t=e.model.get_wrapper_id(),n=o.indexOf(_.last(e.modules).model),void(e.spacer&&!l&&(_.each(e.modules,function(e){o.remove(e.model)}),n--))):(r.remove(e.model),void(e.spacer?_.each(e.modules,function(e){o.remove(e.model)}):_.each(e.modules,function(e,r){e.model.set_property("wrapper_id",t,!0),o.remove(e.model,{silent:!0}),n++,e.model.add_to(o,n)})))})}),!0):!1},_do_split:function(e,t){var o=(Upfront.Behaviors.GridEditor,t.get("modules")),r=t.get("wrappers");return _.each(e,function(e,t){var n=new Upfront.Models.Wrapper({}),i=Upfront.Util.get_unique_id("wrapper");n.set_property("wrapper_id",i),n.set_property("class",e.model.get_property_value_by_name("class")),r.add(n),_.each(e.modules,function(e,t){var r=o.indexOf(e.model);e.model.set_property("wrapper_id",i,!0),o.remove(e.model,{silent:!0}),e.model.add_to(o,r)})}),!0},_get_group_position:function(t){var o=sel_left=sel_right=sel_bottom=!1,r=wrap_left=wrap_right=wrap_bottom=!1;return t.each(function(){var t=e(this).offset(),n=Math.round(parseFloat(e(this).css("width"))),i=Math.round(parseFloat(e(this).css("height"))),l=e(this).closest(".upfront-wrapper"),a=l.offset(),s=Math.round(parseFloat(l.css("width"))),p=Math.round(parseFloat(l.css("height")));t.left=Math.round(t.left),t.top=Math.round(t.top),t.right=t.left+n,t.bottom=t.top+i,o=o===!1||t.top<o?t.top:o,sel_bottom=sel_bottom===!1||t.bottom>sel_bottom?t.bottom:sel_bottom,sel_left=sel_left===!1||t.left<sel_left?t.left:sel_left,sel_right=sel_right===!1||t.right>sel_right?t.right:sel_right,a.left=Math.round(a.left),a.top=Math.round(a.top),a.right=a.left+s,a.bottom=a.top+p,r=r===!1||a.top<r?a.top:r,wrap_bottom=wrap_bottom===!1||a.bottom>wrap_bottom?a.bottom:wrap_bottom,wrap_left=wrap_left===!1||a.left<wrap_left?a.left:wrap_left,wrap_right=wrap_right===!1||a.right>wrap_right?a.right:wrap_right}),{element:{top:o,bottom:sel_bottom,left:sel_left,right:sel_right},wrapper:{top:r,bottom:wrap_bottom,left:wrap_left,right:wrap_right}}},_find_affected_el:function(t,o){if(0==this.selection.length)return!1;var r=!1;return t.each(function(){var t=e(this).offset(),n=Math.round(parseFloat(e(this).css("width"))),i=Math.round(parseFloat(e(this).css("height"))),l=Math.round(t.top),a=Math.round(t.left),s=l+i,p=a+n;o.top<s&&o.bottom>l&&o.left<p&&o.right>a&&(r=r!==!1?r.add(e(this)):e(this))}),r},_update_selection_outline:function(){var t=e("#upfront-group-selection"),o=this._get_group_position(e(this.selection));t.length||(t=e('<div id="upfront-group-selection" />'),t.appendTo("body")),t.css({top:o.element.top,left:o.element.left,height:o.element.bottom-o.element.top,width:o.element.right-o.element.left})},_add_selection:function(t){var o=_.find(this.selection,function(e){return e==t});o||(this.selection.push(t),e(t).addClass("upfront-ui-selected"))},_add_selections:function(t,o,r){var n,i,l,a=this,s=[];t.each(function(){var t=this,p=_.find(a.selection,function(e){return e==t}),u=e(o);if(!p){for(s=[],n=a._get_group_position(e(a.selection).add(this)),i=a._find_affected_el(u,n.element);i!==!1;)i.each(function(){s.push(this)}),u=u.not(i),n=a._get_group_position(e(a.selection).add(s)),i=a._find_affected_el(u,n.element);l=a._find_affected_el(r,n.element),l===!1&&_.each(s,function(e){a._add_selection(e)})}})},_remove_selection:function(t){this.selection=_.reject(this.selection,function(e){return e==t}),e(t).find(".upfront-selected-border").remove(),e(t).removeClass("upfront-ui-selected ui-selected")},remove_selections:function(){var t=Upfront.Behaviors.LayoutEditor;e(".upfront-ui-selected").each(function(){t._remove_selection(this)}),t._update_selection_outline(),e(".upfront-module-group-group").remove()},create_undo:function(){this.layout.store_undo_state()},apply_history_change:function(){var e=Upfront.Application.layout.get("regions"),t=e?e.get_by_name("shadow"):!1;e&&t&&(e.remove(t),t=!1),Upfront.Application.layout_view.render()},save_dialog:function(t,o,r,n){e("body").append("<div id='upfront-save-dialog-background' />"),e("body").append("<div id='upfront-save-dialog' />");var i=e("#upfront-save-dialog"),l=e("#upfront-save-dialog-background"),a=(Upfront.Application.layout.get("current_layout"),"");n=!0===n,a+=n?"<p>"+Upfront.Settings.l10n.global.behaviors.this_archive_only+"</p>":"<p>"+Upfront.Settings.l10n.global.behaviors.this_post_only+"</p>",e.each(_upfront_post_data.layout,function(e,t){"type"!=e&&(a+=n?'<span class="upfront-save-button" data-save-as="'+t+'">'+Upfront.Settings.LayoutEditor.ArchiveSpecificity[e]+"</span>":'<span class="upfront-save-button" data-save-as="'+t+'">'+Upfront.Settings.LayoutEditor.Specificity[e]+"</span>")}),!0===Upfront.plugins.isForbiddenByPlugin("show save as dialog")||r!==!0?(l.remove(),i.remove(),t.apply(o,["single-post"])):(i.html(a),e("#upfront-save-dialog").on("click",".upfront-save-button",function(){var r=e(this).attr("data-save-as");return l.remove(),i.remove(),t.apply(o,[r]),Upfront.Events.trigger("command:proceed:save:post"),!1}),e("#upfront-save-dialog-background").on("click",function(){return l.remove(),i.remove(),!1}))},clean_region_css:function(){var t=Upfront.Application.cssEditor,o=(Upfront.Behaviors.LayoutEditor,[t.elementTypes.RegionContainer,t.elementTypes.Region]),r=_upfront_post_data.layout,n=r.specificity||r.item||r.type,i=Upfront.Application.layout.get("regions"),l=[],a=[],s=function(t){if(!a[t])return Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.behaviors.region_css_cleaned),void p.resolve();var o,r=a[t].elementType,n=a[t].styleName,i=Upfront.plugins.call("prepare-delete-element-styles-data",{styleName:n,elementType:r});o=i.status&&"called"===i.status&&i.result?i.result:{action:"upfront_delete_styles",styleName:n,elementType:r},Upfront.Util.post(o).done(function(){var o=Upfront.data.styles[r].indexOf(n);-1!=o&&Upfront.data.styles[r].splice(o,1),e("#upfront-style-"+n).remove(),s(t+1)})},p=new e.Deferred;return i.each(function(e){var o=e.is_main()?t.elementTypes.RegionContainer.id:t.elementTypes.Region.id,r=n+"-"+e.get("name")+"-style";"global"==e.get("scope");_.isArray(Upfront.data.styles[o])&&-1!=Upfront.data.styles[o].indexOf(r)&&l.push(r),r=o+"-"+e.get("name")+"-style",_.isArray(Upfront.data.styles[o])&&-1!=Upfront.data.styles[o].indexOf(r)&&l.push(r)}),Upfront.plugins.call("clean-region-css",{elementTypes:o,layout_id:n,styleExists:l,deleteDatas:a,deleteFunc:s}),p.promise()},_build_query:function(e){return _.map(e,function(e,t){return t+"="+e}).join("&")},clean_global_regions:function(){Upfront.data.global_regions=!1},open_global_region_manager:function(){var t=Upfront.Behaviors.LayoutEditor;Upfront.Popup.open(function(o,r,n){var i=e(this);i.html('<p class="upfront-popup-placeholder">'+Upfront.Settings.l10n.global.behaviors.loading_content+"</p>"),Upfront.data.global_regions?t._render_global_region_manager(i):t._refresh_global_regions().done(function(){t._render_global_region_manager(i)})},{width:600},"global-region-manager")},_refresh_global_regions:function(){return Upfront.Util.post({action:"upfront_list_scoped_regions",scope:"global",storage_key:_upfront_save_storage_key}).done(function(e){Upfront.data.global_regions=e.data})},_render_global_region_manager:function(t){var o=Upfront.Behaviors.LayoutEditor,r=Upfront.Application.layout.get("regions"),n=[{title:Upfront.Settings.l10n.global.behaviors.global_regions,classname:"global",data:_.sortBy(Upfront.data.global_regions,function(e,t,o){return e.container&&e.name!=e.container?3*_.indexOf(o,_.findWhere(o,{name:e.container}))+1:3*t})},{title:Upfront.Settings.l10n.global.behaviors.lightboxes,classname:"lightbox",data:Upfront.Util.model_to_json(r.filter(function(e){return"lightbox"==e.get("sub")}))}];t.html(""),_.each(n,function(r){var n=e('<div class="global-region-manager-wrap global-region-manager-'+r.classname+'"></div>'),i=e('<h3 class="global-region-manager-title">'+r.title+"</h3>"),l=e('<div class="global-region-manager-content upfront-scroll-panel"></div>');n.append([i,l]),o._render_regions(r.data,l),t.append(n),Upfront.Views.Mixins.Upfront_Scroll_Mixin.stop_scroll_propagation(l)}),t.on("click",".region-list-edit",function(e){e.preventDefault()}),t.on("click",".region-list-trash",function(n){n.preventDefault();var i=e(this).attr("data-name");e(this).closest(".global-region-manager-wrap").hasClass("global-region-manager-global")&&confirm("Deleting the global regions will remove it from all layouts. Continue?")&&Upfront.Util.post({action:"upfront_delete_scoped_regions",scope:"global",name:i,storage_key:_upfront_save_storage_key}).done(function(e){e.data&&(_.each(e.data,function(e){var t=r.get_by_name(e);r.remove(t)}),o._refresh_global_regions().done(function(){o._render_global_region_manager(t)}))})})},_render_regions:function(t,o){var r=e('<ul class="global-region-manager-lists"></ul>');_.each(t,function(e){var o=["global-region-manager-list"],n=!1;e.container&&e.name!=e.container?(n=_.find(t,function(t){return t.name==e.container}),o.push("region-list-sub"),o.push("region-list-sub-"+e.sub),n&&o.push("region-list-sub-has-main")):o.push("region-list-main"),r.append('<li class="'+o.join(" ")+'"><span class="region-list-name">'+e.title+'</span><span class="region-list-control">'+(!1===Upfront.plugins.isForbiddenByPlugin("show region list trash")?'<a href="#" class="region-list-trash" data-name="'+e.name+'">'+Upfront.Settings.l10n.global.behaviors.trash+"</a>":"")+"</span></li>")}),o.append(r)}};define(t)}(jQuery);