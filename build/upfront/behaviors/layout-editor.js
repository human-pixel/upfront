!function(e){var t={selection:[],selecting:!1,create_mergeable:function(t,o){var n=this,r=Upfront.Behaviors.LayoutEditor;n.layout.get("regions");t.$el.selectable({distance:10,filter:".upfront-module",cancel:".upfront-module:not(.upfront-module-spacer), .upfront-module-group, .upfront-region-side-fixed, .upfront-entity_meta, .upfront-region-edit-trigger, .upfront-region-edit-fixed-trigger, .upfront-region-finish-edit, .upfront-icon-control-region-resize, .upfront-inline-modal, .upfront-inline-panels",selecting:function(t,o){var n,i=e(o.selecting);if(!(i.closest(".upfront-module-group").length>0)){if(r.selection.length>0){if(n=e(r.selection[0]).closest(".upfront-region"),i.closest(".upfront-region").get(0)!=n.get(0))return;r._add_selections(n.find(".ui-selecting"),n.find(".upfront-module").not(".upfront-ui-selected, .upfront-module-parent-group"),n.find(".upfront-module-group"))}else r._add_selection(o.selecting);r._update_selection_outline()}},unselecting:function(t,o){var n,i,l=e(o.unselecting);if(r.selection.length>1){if(n=e(r.selection[0]).closest(".upfront-region"),l.closest(".upfront-region").get(0)!=n.get(0))return;return e(".upfront-ui-selected").each(function(){r._remove_selection(this)}),i=n.find(".ui-selecting"),i.length>0&&(r._add_selection(i.get(0)),r._add_selections(i,n.find(".upfront-module").not(".upfront-ui-selected, .upfront-module-parent-group"),n.find(".upfront-module-group"))),void r._update_selection_outline()}r._remove_selection(o.unselecting),r._update_selection_outline()},unselected:function(t,o){var n=e(o.unselected);n.find(".upfront-selected-border").remove(),e(".upfront-module-group-group").remove()},start:function(e,t){r.remove_selections(),r.selection=[],r.selecting=!0},stop:function(e,t){r.parse_selections()}})},refresh_mergeable:function(){this.remove_selections(),e(".ui-selectable").each(function(){e(this).selectable("refresh")})},enable_mergeable:function(){this.remove_selections(),e(".ui-selectable").each(function(){e(this).selectable("enable")})},disable_mergeable:function(){this.remove_selections(),e(".ui-selectable").each(function(){e(this).selectable("disable")})},destroy_mergeable:function(){this.remove_selections(),e(".ui-selectable").each(function(){e(this).selectable("destroy")})},parse_selections:function(){if(!e(".upfront-ui-selected").length)return!1;if(!Upfront.Application.user_can_modify_layout())return!1;var t=this,o=Upfront.Application.layout.get("regions"),n=e(".upfront-ui-selected:first").closest(".upfront-region"),r=o.get_by_name(n.data("name")),i=r?r.get("modules"):!1,l=r?r.get("wrappers"):!1,a=e(".upfront-ui-selected");if(a.length<2)return a.each(function(){t._remove_selection(this)}),e("#upfront-group-selection").remove(),!1;e(".upfront-module-group-group").remove();var s=e('<div class="upfront-module-group-toggle upfront-module-group-group">'+Upfront.Settings.l10n.global.behaviors.group+"</div>"),p=sel_left=sel_right=sel_bottom=!1,u=wrap_left=wrap_right=wrap_bottom=!1,c=group_left=0;e("body").append(s),a.each(function(){var t=e(this).offset(),o=e(this).outerWidth(),n=e(this).outerHeight(),r=e(this).closest(".upfront-wrapper"),i=r.offset(),l=r.outerWidth(),a=r.outerHeight();t.right=t.left+o,t.bottom=t.top+n,p=p===!1||t.top<p?t.top:p,sel_bottom=sel_bottom===!1||t.bottom>sel_bottom?t.bottom:sel_bottom,sel_left=sel_left===!1||t.left<sel_left?t.left:sel_left,sel_right=sel_right===!1||t.right>sel_right?t.right:sel_right,i.right=i.left+l,i.bottom=i.top+a,u=u===!1||i.top<u?i.top:u,wrap_bottom=wrap_bottom===!1||i.bottom>wrap_bottom?i.bottom:wrap_bottom,wrap_left=wrap_left===!1||i.left<wrap_left?i.left:wrap_left,wrap_right=wrap_right===!1||i.right>wrap_right?i.right:wrap_right}),c=p+Math.round((sel_bottom-p)/2)-Math.round(s.outerHeight()/2),group_left=sel_left+Math.round((sel_right-sel_left)/2)-Math.round(s.outerWidth()/2),s.css({position:"absolute",zIndex:999999,top:c,left:group_left}),setTimeout(function(){t.selecting=!1},1e3),s.on("click",function(){var o=Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),s=Upfront.Behaviors.GridEditor,p=!1,u=(Math.round((wrap_right-wrap_left)/s.grid.column_width),s.parse_modules_to_lines(i,l,o.id,o.columns)),c=[],d=[],f=[],g=0,m=0,h=0,b=!1;_.each(u,function(t){var o=[],n=[],r=[],i=[],l=[],s=0,u=0,b=0;_.each(t.wrappers,function(t){var c=[],d=[],f=[];_.each(t.modules,function(t){var o=!1;a.each(function(){var n=e(this).attr("id");t.model.get_element_id()==n&&(p===!1&&(p=Upfront.data.module_views[t.model.cid]),c.push(t),o=!0)}),o||(0==c.length?d.push(t):f.push(t))}),c.length>0?(o.push({modules:c,top_modules:d,bottom_modules:f,model:t.model,col:t.col,clear:t.clear,spacer:t.spacer,order:t.order}),s+=t.col,d.length&&i.push({modules:d,model:t.model,col:t.col,clear:t.clear,spacer:t.spacer,order:t.order}),f.length&&l.push({modules:f,model:t.model,col:t.col,clear:t.clear,spacer:t.spacer,order:t.order})):((0==o.length?n:r).push({modules:t.modules,model:t.model,col:t.col,clear:t.clear,spacer:t.spacer,order:t.order}),0==o.length?u+=t.col:b+=t.col)}),o.length>0&&(c.push({wrappers:o,top_wrappers:i,bottom_wrappers:l,col:s}),g=s>g?s:g,n.length>0&&(d.push({wrappers:n,col:u}),m=u>m?u:m),r.length>0&&(f.push({wrappers:r,col:b}),h=b>h?b:h))}),s.start(p,p.model),d.length>1&&(t._do_combine(d,r)||t._do_group(d,r)),0==d.length&&0==f.length&&(b=!0),t._do_group(c,r,!1,b),f.length>1&&(t._do_combine(f,r)||t._do_group(f,r)),s.update_position_data(n.find(".upfront-editable_entities_container:first")),s.update_wrappers(r),e(this).remove(),e("#upfront-group-selection").remove(),t.selection=[]})},_do_group:function(e,t,o,n){var r=this,i=Upfront.Behaviors.GridEditor,l=o===!0,n=n===!0,a=t.get("modules"),s=t.get("wrappers"),p=Upfront.Util.get_unique_id("module-group"),u=new Upfront.Models.ModuleGroup,c=u.get("modules"),d=u.get("wrappers"),f=!1,g=!1,m=!1,h=0,b=!1,v=!1,w=Upfront.Views.breakpoints_storage.get_breakpoints().get_enabled();_.each(e,function(e,o){h=e.col>h?e.col:h,_.each(e.wrappers,function(e,t){var n=new Upfront.Models.Wrapper({}),r=Upfront.Util.get_unique_id("wrapper"),l=Upfront.data.wrapper_views[e.model.cid],p="top_modules"in e&&e.top_modules.length>0,u="bottom_modules"in e&&e.bottom_modules.length>0;n.set_property("wrapper_id",r),n.set_property("class",e.model.get_property_value_by_name("class")),n.replace_class(i.grid["class"]+e.col),0==t&&(n.add_class("clr"),0==o&&(f=e.clear)),d.add(n),_.each(e.modules,function(e,t){var o=a.indexOf(e.model),n=Upfront.data.module_views[e.model.cid];b===!1&&(b=o),e.model.set_property("wrapper_id",r,!0),a.remove(e.model,{silent:!0}),n.$el.detach(),p||u||l.$el.detach(),c.add(e.model)}),0==o&&0==t?(m=e.model.get_wrapper_id(),g=e.model):p||s.remove(e.model)}),"bottom_wrappers"in e&&e.bottom_wrappers.length>1&&(n?r._do_split(e.bottom_wrappers,t):r._do_group([{wrappers:e.bottom_wrappers,col:e.col}],t)),"top_wrappers"in e&&e.top_wrappers.length>1&&(n?(_.each(e.top_wrappers,function(e,t){_.each(e.modules,function(e,t){var o=a.indexOf(e.model);return v===!1?void(v=o):(a.remove(e.model,{silent:!0}),v++,void e.model.add_to(a,v))})}),v!==!1&&(b=v+1),l=!0):r._do_group([{wrappers:e.top_wrappers,col:e.col}],t))}),l&&(g=new Upfront.Models.Wrapper({}),m=Upfront.Util.get_unique_id("wrapper"),s.add(g)),g.set_property("wrapper_id",m),g.replace_class(i.grid["class"]+h),f&&g.add_class("clr"),u.set_property("wrapper_id",m),u.set_property("element_id",p),u.replace_class(i.grid["class"]+h),u.set_property("original_col",h);var y=g&&g.get_property_value_by_name("breakpoint")||{},U=u.get_property_value_by_name("breakpoint")||{};_.each(w,function(e){var t=e.toJSON();t["default"]||y&&y[t.id]&&y[t.id].edited&&(_.isObject(U[t.id])||(U[t.id]={edited:!1}),!U[t.id].edited&&_.isNumber(y[t.id].col)&&(U[t.id].col=y[t.id].col,U[t.id].edited=!0,u.set_property("breakpoint",Upfront.Util.clone(U))))}),u.add_to(a,b),Upfront.Events.trigger("entity:module_group:group",u,t)},_do_combine:function(e,t){var o=(Upfront.Behaviors.GridEditor,t.get("modules")),n=t.get("wrappers"),r=[],i=[],l=!0;if(_.each(e,function(e,t){t in r||(r[t]=[]),_.each(e.wrappers,function(e,o){o in i||(i[o]=[]),r[t][o]=e.col,i[o].push(e)})}),r.length>1)for(var a=1;a<r.length;a++)if(!_.isEqual(r[a-1],r[a])){l=!1;break}return l?(_.each(i,function(e){var t,r=0,i=_.filter(e,function(e){return e.spacer}),l=e.length==i.length;_.each(e,function(e,i){return 0==i?(t=e.model.get_wrapper_id(),r=o.indexOf(_.last(e.modules).model),void(e.spacer&&!l&&(_.each(e.modules,function(e){o.remove(e.model)}),r--))):(n.remove(e.model),void(e.spacer?_.each(e.modules,function(e){o.remove(e.model)}):_.each(e.modules,function(e,n){e.model.set_property("wrapper_id",t,!0),o.remove(e.model,{silent:!0}),r++,e.model.add_to(o,r)})))})}),!0):!1},_do_split:function(e,t){var o=(Upfront.Behaviors.GridEditor,t.get("modules")),n=t.get("wrappers");return _.each(e,function(e,t){var r=new Upfront.Models.Wrapper({}),i=Upfront.Util.get_unique_id("wrapper");r.set_property("wrapper_id",i),r.set_property("class",e.model.get_property_value_by_name("class")),n.add(r),_.each(e.modules,function(e,t){var n=o.indexOf(e.model);e.model.set_property("wrapper_id",i,!0),o.remove(e.model,{silent:!0}),e.model.add_to(o,n)})}),!0},_get_group_position:function(t){var o=sel_left=sel_right=sel_bottom=!1,n=wrap_left=wrap_right=wrap_bottom=!1;return t.each(function(){var t=e(this).offset(),r=Math.round(parseFloat(e(this).css("width"))),i=Math.round(parseFloat(e(this).css("height"))),l=e(this).closest(".upfront-wrapper"),a=l.offset(),s=Math.round(parseFloat(l.css("width"))),p=Math.round(parseFloat(l.css("height")));t.left=Math.round(t.left),t.top=Math.round(t.top),t.right=t.left+r,t.bottom=t.top+i,o=o===!1||t.top<o?t.top:o,sel_bottom=sel_bottom===!1||t.bottom>sel_bottom?t.bottom:sel_bottom,sel_left=sel_left===!1||t.left<sel_left?t.left:sel_left,sel_right=sel_right===!1||t.right>sel_right?t.right:sel_right,a.left=Math.round(a.left),a.top=Math.round(a.top),a.right=a.left+s,a.bottom=a.top+p,n=n===!1||a.top<n?a.top:n,wrap_bottom=wrap_bottom===!1||a.bottom>wrap_bottom?a.bottom:wrap_bottom,wrap_left=wrap_left===!1||a.left<wrap_left?a.left:wrap_left,wrap_right=wrap_right===!1||a.right>wrap_right?a.right:wrap_right}),{element:{top:o,bottom:sel_bottom,left:sel_left,right:sel_right},wrapper:{top:n,bottom:wrap_bottom,left:wrap_left,right:wrap_right}}},_find_affected_el:function(t,o){if(0==this.selection.length)return!1;var n=!1;return t.each(function(){var t=e(this).offset(),r=Math.round(parseFloat(e(this).css("width"))),i=Math.round(parseFloat(e(this).css("height"))),l=Math.round(t.top),a=Math.round(t.left),s=l+i,p=a+r;o.top<s&&o.bottom>l&&o.left<p&&o.right>a&&(n=n!==!1?n.add(e(this)):e(this))}),n},_update_selection_outline:function(){var t=e("#upfront-group-selection"),o=this._get_group_position(e(this.selection));t.length||(t=e('<div id="upfront-group-selection" />'),t.appendTo("body")),t.css({top:o.element.top,left:o.element.left,height:o.element.bottom-o.element.top,width:o.element.right-o.element.left})},_add_selection:function(t){var o=_.find(this.selection,function(e){return e==t});o||(this.selection.push(t),e(t).addClass("upfront-ui-selected"))},_add_selections:function(t,o,n){var r,i,l,a=this,s=[];t.each(function(){var t=this,p=_.find(a.selection,function(e){return e==t}),u=e(o);if(!p){for(s=[],r=a._get_group_position(e(a.selection).add(this)),i=a._find_affected_el(u,r.element);i!==!1;)i.each(function(){s.push(this)}),u=u.not(i),r=a._get_group_position(e(a.selection).add(s)),i=a._find_affected_el(u,r.element);l=a._find_affected_el(n,r.element),l===!1&&_.each(s,function(e){a._add_selection(e)})}})},_remove_selection:function(t){this.selection=_.reject(this.selection,function(e){return e==t}),e(t).find(".upfront-selected-border").remove(),e(t).removeClass("upfront-ui-selected ui-selected")},remove_selections:function(){var t=Upfront.Behaviors.LayoutEditor;e(".upfront-ui-selected").each(function(){t._remove_selection(this)}),t._update_selection_outline(),e(".upfront-module-group-group").remove()},create_undo:function(){this.layout.store_undo_state()},apply_history_change:function(){var e=Upfront.Application.layout.get("regions"),t=e?e.get_by_name("shadow"):!1;e&&t&&(e.remove(t),t=!1),Upfront.Application.layout_view.render()},save_dialog:function(t,o,n,r){e("body").append("<div id='upfront-save-dialog-background' />"),e("body").append("<div id='upfront-save-dialog' />");var i=e("#upfront-save-dialog"),l=e("#upfront-save-dialog-background"),a=(Upfront.Application.layout.get("current_layout"),"");r=!0===r,a+=r?"<p>"+Upfront.Settings.l10n.global.behaviors.this_archive_only+"</p>":"<p>"+Upfront.Settings.l10n.global.behaviors.this_post_only+"</p>",e.each(_upfront_post_data.layout,function(e,t){"type"!=e&&(a+=r?'<span class="upfront-save-button" data-save-as="'+t+'">'+Upfront.Settings.LayoutEditor.ArchiveSpecificity[e]+"</span>":'<span class="upfront-save-button" data-save-as="'+t+'">'+Upfront.Settings.LayoutEditor.Specificity[e]+"</span>")}),!0===Upfront.plugins.isForbiddenByPlugin("show save as dialog")||n!==!0?(l.remove(),i.remove(),t.apply(o,["single-post"])):(i.html(a),e("#upfront-save-dialog").on("click",".upfront-save-button",function(){var n=e(this).attr("data-save-as");return l.remove(),i.remove(),t.apply(o,[n]),Upfront.Events.trigger("command:proceed:save:post"),!1}),e("#upfront-save-dialog-background").on("click",function(){return l.remove(),i.remove(),!1}))},clean_region_css:function(){var t=Upfront.Application.cssEditor,o=(Upfront.Behaviors.LayoutEditor,[t.elementTypes.RegionContainer,t.elementTypes.Region]),n=_upfront_post_data.layout,r=n.specificity||n.item||n.type,i=Upfront.Application.layout.get("regions"),l=[],a=[],s=function(t){if(!a[t])return Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.behaviors.region_css_cleaned),void p.resolve();var o,n=a[t].elementType,r=a[t].styleName,i=Upfront.plugins.call("prepare-delete-element-styles-data",{styleName:r,elementType:n});o=i.status&&"called"===i.status&&i.result?i.result:{action:"upfront_delete_styles",styleName:r,elementType:n},Upfront.Util.post(o).done(function(){var o=Upfront.data.styles[n].indexOf(r);-1!=o&&Upfront.data.styles[n].splice(o,1),e("#upfront-style-"+r).remove(),s(t+1)})},p=new e.Deferred;return i.each(function(e){var o=e.is_main()?t.elementTypes.RegionContainer.id:t.elementTypes.Region.id,n=r+"-"+e.get("name")+"-style";"global"==e.get("scope");_.isArray(Upfront.data.styles[o])&&-1!=Upfront.data.styles[o].indexOf(n)&&l.push(n),n=o+"-"+e.get("name")+"-style",_.isArray(Upfront.data.styles[o])&&-1!=Upfront.data.styles[o].indexOf(n)&&l.push(n)}),Upfront.plugins.call("clean-region-css",{elementTypes:o,layout_id:r,styleExists:l,deleteDatas:a,deleteFunc:s}),p.promise()},_build_query:function(e){return _.map(e,function(e,t){return t+"="+e}).join("&")},clean_global_regions:function(){Upfront.data.global_regions=!1},open_global_region_manager:function(){var t=Upfront.Behaviors.LayoutEditor;Upfront.Popup.open(function(o,n,r){var i=e(this);i.html('<p class="upfront-popup-placeholder">'+Upfront.Settings.l10n.global.behaviors.loading_content+"</p>"),Upfront.data.global_regions?t._render_global_region_manager(i):t._refresh_global_regions().done(function(){t._render_global_region_manager(i)})},{width:600},"global-region-manager")},open_theme_fonts_manager:function(){var t={},o=new Upfront.Views.Editor.Fonts.Text_Fonts_Manager({collection:Upfront.Views.Editor.Fonts.theme_fonts_collection});if(o.render(),Upfront.Application.mode.current===Upfront.Application.MODE.THEME){var n=new Upfront.Views.Editor.Fonts.Icon_Fonts_Manager({collection:Upfront.Views.Editor.Fonts.icon_fonts_collection});n.render()}Upfront.Popup.open(function(o,n,r){var i=e(this);i.empty().append('<p class="upfront-popup-placeholder">'+Upfront.Settings.l10n.global.behaviors.loading_content+"</p>"),t.$popup={top:n,content:i,bottom:r}},{width:750},"font-manager-popup");t.$popup.top.html('<ul class="upfront-tabs"><li id="theme-text-fonts-tab" class="active">'+Upfront.Settings.l10n.global.behaviors.theme_text_fonts+"</li>"+(Upfront.Application.mode.current===Upfront.Application.MODE.THEME?'<li id="theme-icon-fonts-tab">'+Upfront.Settings.l10n.global.behaviors.theme_icon_fonts+"</li>":"")+"</ul>"+t.$popup.top.html()),t.$popup.top.on("click","#theme-text-fonts-tab",function(n){t.$popup.content.html(o.el),e("#theme-icon-fonts-tab").removeClass("active"),e("#theme-text-fonts-tab").addClass("active"),e(".theme-fonts-ok-button").css("margin-top","30px")}),t.$popup.top.on("click","#theme-icon-fonts-tab",function(){t.$popup.content.html(n.el),e("#theme-text-fonts-tab").removeClass("active"),e("#theme-icon-fonts-tab").addClass("active"),e(".theme-fonts-ok-button").css("margin-top",0)}),t.$popup.bottom.append('<a class="theme-fonts-ok-button">'+Upfront.Settings.l10n.global.behaviors.ok+"</a>"),t.$popup.content.html(o.el),o.set_ok_button(t.$popup.bottom.find(".theme-fonts-ok-button")),t.$popup.bottom.find(".theme-fonts-ok-button").on("click",function(){Upfront.Popup.close()})},_refresh_global_regions:function(){return Upfront.Util.post({action:"upfront_list_scoped_regions",scope:"global",storage_key:_upfront_save_storage_key}).done(function(e){Upfront.data.global_regions=e.data})},_render_global_region_manager:function(t){var o=Upfront.Behaviors.LayoutEditor,n=Upfront.Application.layout.get("regions"),r=[{title:Upfront.Settings.l10n.global.behaviors.global_regions,classname:"global",data:_.sortBy(Upfront.data.global_regions,function(e,t,o){return e.container&&e.name!=e.container?3*_.indexOf(o,_.findWhere(o,{name:e.container}))+1:3*t})},{title:Upfront.Settings.l10n.global.behaviors.lightboxes,classname:"lightbox",data:Upfront.Util.model_to_json(n.filter(function(e){return"lightbox"==e.get("sub")}))}];t.html(""),_.each(r,function(n){var r=e('<div class="global-region-manager-wrap global-region-manager-'+n.classname+'"></div>'),i=e('<h3 class="global-region-manager-title">'+n.title+"</h3>"),l=e('<div class="global-region-manager-content upfront-scroll-panel"></div>');r.append([i,l]),o._render_regions(n.data,l),t.append(r),Upfront.Views.Mixins.Upfront_Scroll_Mixin.stop_scroll_propagation(l)}),t.on("click",".region-list-edit",function(e){e.preventDefault()}),t.on("click",".region-list-trash",function(r){r.preventDefault();var i=e(this).attr("data-name");e(this).closest(".global-region-manager-wrap").hasClass("global-region-manager-global")&&confirm("Deleting the global regions will remove it from all layouts. Continue?")&&Upfront.Util.post({action:"upfront_delete_scoped_regions",scope:"global",name:i,storage_key:_upfront_save_storage_key}).done(function(e){e.data&&(_.each(e.data,function(e){var t=n.get_by_name(e);n.remove(t)}),o._refresh_global_regions().done(function(){o._render_global_region_manager(t)}))})})},_render_regions:function(t,o){var n=e('<ul class="global-region-manager-lists"></ul>');_.each(t,function(e){var o=["global-region-manager-list"],r=!1;e.container&&e.name!=e.container?(r=_.find(t,function(t){return t.name==e.container}),o.push("region-list-sub"),o.push("region-list-sub-"+e.sub),r&&o.push("region-list-sub-has-main")):o.push("region-list-main"),n.append('<li class="'+o.join(" ")+'"><span class="region-list-name">'+e.title+'</span><span class="region-list-control">'+(!1===Upfront.plugins.isForbiddenByPlugin("show region list trash")?'<a href="#" class="region-list-trash" data-name="'+e.name+'">'+Upfront.Settings.l10n.global.behaviors.trash+"</a>":"")+"</span></li>")}),o.append(n)}};define(t)}(jQuery);