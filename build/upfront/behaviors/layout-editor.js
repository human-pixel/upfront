!function(e){var t={selection:[],selecting:!1,create_mergeable:function(t,o){var n=this,r=Upfront.Behaviors.LayoutEditor;n.layout.get("regions");t.$el.selectable({distance:10,filter:".upfront-module",cancel:".upfront-module:not(.upfront-module-spacer), .upfront-module-group, .upfront-region-side-fixed, .upfront-entity_meta, .upfront-region-edit-trigger, .upfront-region-edit-fixed-trigger, .upfront-region-finish-edit, .upfront-icon-control-region-resize, .upfront-inline-modal, .upfront-inline-panels",selecting:function(t,o){var n,a=e(o.selecting);if(!(a.closest(".upfront-module-group").length>0)){if(r.selection.length>0){if(n=e(r.selection[0]).closest(".upfront-region"),a.closest(".upfront-region").get(0)!=n.get(0))return;r._add_selections(n.find(".ui-selecting"),n.find(".upfront-module").not(".upfront-ui-selected, .upfront-module-parent-group"),n.find(".upfront-module-group"))}else r._add_selection(o.selecting);r._update_selection_outline()}},unselecting:function(t,o){var n,a,l=e(o.unselecting);if(r.selection.length>1){if(n=e(r.selection[0]).closest(".upfront-region"),l.closest(".upfront-region").get(0)!=n.get(0))return;return e(".upfront-ui-selected").each(function(){r._remove_selection(this)}),a=n.find(".ui-selecting"),a.length>0&&(r._add_selection(a.get(0)),r._add_selections(a,n.find(".upfront-module").not(".upfront-ui-selected, .upfront-module-parent-group"),n.find(".upfront-module-group"))),void r._update_selection_outline()}r._remove_selection(o.unselecting),r._update_selection_outline()},unselected:function(t,o){var n=e(o.unselected);n.find(".upfront-selected-border").remove(),e(".upfront-module-group-group").remove()},start:function(e,t){r.remove_selections(),r.selection=[],r.selecting=!0},stop:function(e,t){r.parse_selections()}})},refresh_mergeable:function(){this.remove_selections(),e(".ui-selectable").each(function(){e(this).selectable("refresh")})},enable_mergeable:function(){this.remove_selections(),e(".ui-selectable").each(function(){e(this).selectable("enable")})},disable_mergeable:function(){this.remove_selections(),e(".ui-selectable").each(function(){e(this).selectable("disable")})},destroy_mergeable:function(){this.remove_selections(),e(".ui-selectable").each(function(){e(this).selectable("destroy")})},parse_selections:function(){if(!e(".upfront-ui-selected").length)return!1;if(!Upfront.Application.user_can_modify_layout())return!1;var t=this,o=Upfront.Application.layout.get("regions"),n=e(".upfront-ui-selected:first").closest(".upfront-region"),r=o.get_by_name(n.data("name")),a=r?r.get("modules"):!1,l=r?r.get("wrappers"):!1,i=e(".upfront-ui-selected");if(i.length<2)return i.each(function(){t._remove_selection(this)}),e("#upfront-group-selection").remove(),!1;e(".upfront-module-group-group").remove();var s=e('<div class="upfront-module-group-toggle upfront-module-group-group">'+Upfront.Settings.l10n.global.behaviors.group+"</div>"),p=sel_left=sel_right=sel_bottom=!1,u=wrap_left=wrap_right=wrap_bottom=!1,d=group_left=0;e("body").append(s),i.each(function(){var t=e(this).offset(),o=e(this).outerWidth(),n=e(this).outerHeight(),r=e(this).closest(".upfront-wrapper"),a=r.offset(),l=r.outerWidth(),i=r.outerHeight();t.right=t.left+o,t.bottom=t.top+n,p=p===!1||t.top<p?t.top:p,sel_bottom=sel_bottom===!1||t.bottom>sel_bottom?t.bottom:sel_bottom,sel_left=sel_left===!1||t.left<sel_left?t.left:sel_left,sel_right=sel_right===!1||t.right>sel_right?t.right:sel_right,a.right=a.left+l,a.bottom=a.top+i,u=u===!1||a.top<u?a.top:u,wrap_bottom=wrap_bottom===!1||a.bottom>wrap_bottom?a.bottom:wrap_bottom,wrap_left=wrap_left===!1||a.left<wrap_left?a.left:wrap_left,wrap_right=wrap_right===!1||a.right>wrap_right?a.right:wrap_right}),d=p+Math.round((sel_bottom-p)/2)-Math.round(s.outerHeight()/2),group_left=sel_left+Math.round((sel_right-sel_left)/2)-Math.round(s.outerWidth()/2),s.css({position:"absolute",zIndex:999999,top:d,left:group_left}),setTimeout(function(){t.selecting=!1},1e3),s.on("click",function(){var o=Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),s=Upfront.Behaviors.GridEditor,p=!1,u=(Math.round((wrap_right-wrap_left)/s.grid.column_width),s.parse_modules_to_lines(a,l,o.id,o.columns)),d=[],c=[],f=[],g=0,m=0,h=0,v=!1;_.each(u,function(t){var o=[],n=[],r=[],a=[],l=[],s=0,u=0,v=0;_.each(t.wrappers,function(t){var d=[],c=[],f=[];_.each(t.modules,function(t){var o=!1;i.each(function(){var n=e(this).attr("id");t.model.get_element_id()==n&&(p===!1&&(p=Upfront.data.module_views[t.model.cid]),d.push(t),o=!0)}),o||(0==d.length?c.push(t):f.push(t))}),d.length>0?(o.push({modules:d,top_modules:c,bottom_modules:f,model:t.model,col:t.col,clear:t.clear,spacer:t.spacer,order:t.order}),s+=t.col,c.length&&a.push({modules:c,model:t.model,col:t.col,clear:t.clear,spacer:t.spacer,order:t.order}),f.length&&l.push({modules:f,model:t.model,col:t.col,clear:t.clear,spacer:t.spacer,order:t.order})):((0==o.length?n:r).push({modules:t.modules,model:t.model,col:t.col,clear:t.clear,spacer:t.spacer,order:t.order}),0==o.length?u+=t.col:v+=t.col)}),o.length>0&&(d.push({wrappers:o,top_wrappers:a,bottom_wrappers:l,col:s}),g=s>g?s:g,n.length>0&&(c.push({wrappers:n,col:u}),m=u>m?u:m),r.length>0&&(f.push({wrappers:r,col:v}),h=v>h?v:h))}),s.start(p,p.model),c.length>1&&(t._do_combine(c,r)||t._do_group(c,r)),0==c.length&&0==f.length&&(v=!0),t._do_group(d,r,!1,v),f.length>1&&(t._do_combine(f,r)||t._do_group(f,r)),s.update_position_data(n.find(".upfront-editable_entities_container:first")),s.update_wrappers(r),e(this).remove(),e("#upfront-group-selection").remove(),t.selection=[]})},_do_group:function(e,t,o,n){var r=this,a=Upfront.Behaviors.GridEditor,l=o===!0,n=n===!0,i=t.get("modules"),s=t.get("wrappers"),p=Upfront.Util.get_unique_id("module-group"),u=new Upfront.Models.ModuleGroup,d=u.get("modules"),c=u.get("wrappers"),f=!1,g=!1,m=!1,h=0,v=!1,b=!1;_.each(e,function(e,o){h=e.col>h?e.col:h,_.each(e.wrappers,function(e,t){var n=new Upfront.Models.Wrapper({}),r=Upfront.Util.get_unique_id("wrapper"),l=Upfront.data.wrapper_views[e.model.cid],p="top_modules"in e&&e.top_modules.length>0,u="bottom_modules"in e&&e.bottom_modules.length>0;n.set_property("wrapper_id",r),n.set_property("class",e.model.get_property_value_by_name("class")),n.replace_class(a.grid["class"]+e.col),0==t&&(n.add_class("clr"),0==o&&(f=e.clear)),c.add(n),_.each(e.modules,function(e,t){var o=i.indexOf(e.model),n=Upfront.data.module_views[e.model.cid];v===!1&&(v=o),e.model.set_property("wrapper_id",r,!0),i.remove(e.model,{silent:!0}),n.$el.detach(),p||u||l.$el.detach(),d.add(e.model)}),0==o&&0==t?(m=e.model.get_wrapper_id(),g=e.model):p||s.remove(e.model)}),"bottom_wrappers"in e&&e.bottom_wrappers.length>1&&(n?r._do_split(e.bottom_wrappers,t):r._do_group([{wrappers:e.bottom_wrappers,col:e.col}],t)),"top_wrappers"in e&&e.top_wrappers.length>1&&(n?(_.each(e.top_wrappers,function(e,t){_.each(e.modules,function(e,t){var o=i.indexOf(e.model);return b===!1?void(b=o):(i.remove(e.model,{silent:!0}),b++,void e.model.add_to(i,b))})}),b!==!1&&(v=b+1),l=!0):r._do_group([{wrappers:e.top_wrappers,col:e.col}],t))}),l&&(g=new Upfront.Models.Wrapper({}),m=Upfront.Util.get_unique_id("wrapper"),s.add(g)),g.set_property("wrapper_id",m),g.replace_class(a.grid["class"]+h),f&&g.add_class("clr"),u.set_property("wrapper_id",m),u.set_property("element_id",p),u.replace_class(a.grid["class"]+h),u.set_property("original_col",h),u.add_to(i,v),Upfront.Events.trigger("entity:module_group:group",u,t)},_do_combine:function(e,t){var o=(Upfront.Behaviors.GridEditor,t.get("modules")),n=t.get("wrappers"),r=[],a=[],l=!0;if(_.each(e,function(e,t){t in r||(r[t]=[]),_.each(e.wrappers,function(e,o){o in a||(a[o]=[]),r[t][o]=e.col,a[o].push(e)})}),r.length>1)for(var i=1;i<r.length;i++)if(!_.isEqual(r[i-1],r[i])){l=!1;break}return l?(_.each(a,function(e){var t,r=0,a=_.filter(e,function(e){return e.spacer}),l=e.length==a.length;_.each(e,function(e,a){return 0==a?(t=e.model.get_wrapper_id(),r=o.indexOf(_.last(e.modules).model),void(e.spacer&&!l&&(_.each(e.modules,function(e){o.remove(e.model)}),r--))):(n.remove(e.model),void(e.spacer?_.each(e.modules,function(e){o.remove(e.model)}):_.each(e.modules,function(e,n){e.model.set_property("wrapper_id",t,!0),o.remove(e.model,{silent:!0}),r++,e.model.add_to(o,r)})))})}),!0):!1},_do_split:function(e,t){var o=(Upfront.Behaviors.GridEditor,t.get("modules")),n=t.get("wrappers");return _.each(e,function(e,t){var r=new Upfront.Models.Wrapper({}),a=Upfront.Util.get_unique_id("wrapper");r.set_property("wrapper_id",a),r.set_property("class",e.model.get_property_value_by_name("class")),n.add(r),_.each(e.modules,function(e,t){var n=o.indexOf(e.model);e.model.set_property("wrapper_id",a,!0),o.remove(e.model,{silent:!0}),e.model.add_to(o,n)})}),!0},_get_group_position:function(t){var o=sel_left=sel_right=sel_bottom=!1,n=wrap_left=wrap_right=wrap_bottom=!1;return t.each(function(){var t=e(this).offset(),r=Math.round(parseFloat(e(this).css("width"))),a=Math.round(parseFloat(e(this).css("height"))),l=e(this).closest(".upfront-wrapper"),i=l.offset(),s=Math.round(parseFloat(l.css("width"))),p=Math.round(parseFloat(l.css("height")));t.left=Math.round(t.left),t.top=Math.round(t.top),t.right=t.left+r,t.bottom=t.top+a,o=o===!1||t.top<o?t.top:o,sel_bottom=sel_bottom===!1||t.bottom>sel_bottom?t.bottom:sel_bottom,sel_left=sel_left===!1||t.left<sel_left?t.left:sel_left,sel_right=sel_right===!1||t.right>sel_right?t.right:sel_right,i.left=Math.round(i.left),i.top=Math.round(i.top),i.right=i.left+s,i.bottom=i.top+p,n=n===!1||i.top<n?i.top:n,wrap_bottom=wrap_bottom===!1||i.bottom>wrap_bottom?i.bottom:wrap_bottom,wrap_left=wrap_left===!1||i.left<wrap_left?i.left:wrap_left,wrap_right=wrap_right===!1||i.right>wrap_right?i.right:wrap_right}),{element:{top:o,bottom:sel_bottom,left:sel_left,right:sel_right},wrapper:{top:n,bottom:wrap_bottom,left:wrap_left,right:wrap_right}}},_find_affected_el:function(t,o){if(0==this.selection.length)return!1;var n=!1;return t.each(function(){var t=e(this).offset(),r=Math.round(parseFloat(e(this).css("width"))),a=Math.round(parseFloat(e(this).css("height"))),l=Math.round(t.top),i=Math.round(t.left),s=l+a,p=i+r;o.top<s&&o.bottom>l&&o.left<p&&o.right>i&&(n=n!==!1?n.add(e(this)):e(this))}),n},_update_selection_outline:function(){var t=e("#upfront-group-selection"),o=this._get_group_position(e(this.selection));t.length||(t=e('<div id="upfront-group-selection" />'),t.appendTo("body")),t.css({top:o.element.top,left:o.element.left,height:o.element.bottom-o.element.top,width:o.element.right-o.element.left})},_add_selection:function(t){var o=_.find(this.selection,function(e){return e==t});o||(this.selection.push(t),e(t).addClass("upfront-ui-selected"))},_add_selections:function(t,o,n){var r,a,l,i=this,s=[];t.each(function(){var t=this,p=_.find(i.selection,function(e){return e==t}),u=e(o);if(!p){for(s=[],r=i._get_group_position(e(i.selection).add(this)),a=i._find_affected_el(u,r.element);a!==!1;)a.each(function(){s.push(this)}),u=u.not(a),r=i._get_group_position(e(i.selection).add(s)),a=i._find_affected_el(u,r.element);l=i._find_affected_el(n,r.element),l===!1&&_.each(s,function(e){i._add_selection(e)})}})},_remove_selection:function(t){this.selection=_.reject(this.selection,function(e){return e==t}),e(t).find(".upfront-selected-border").remove(),e(t).removeClass("upfront-ui-selected ui-selected")},remove_selections:function(){var t=Upfront.Behaviors.LayoutEditor;e(".upfront-ui-selected").each(function(){t._remove_selection(this)}),t._update_selection_outline(),e(".upfront-module-group-group").remove()},create_undo:function(){this.layout.store_undo_state()},apply_history_change:function(){var e=Upfront.Application.layout.get("regions"),t=e?e.get_by_name("shadow"):!1;e&&t&&(e.remove(t),t=!1),Upfront.Application.layout_view.render()},save_dialog:function(t,o){e("body").append("<div id='upfront-save-dialog-background' />"),e("body").append("<div id='upfront-save-dialog' />");var n=e("#upfront-save-dialog"),r=e("#upfront-save-dialog-background"),a=(Upfront.Application.layout.get("current_layout"),"");a+="<p>"+Upfront.Settings.l10n.global.behaviors.this_post_only+"</p>",e.each(_upfront_post_data.layout,function(e,t){"type"!=e&&(a+='<span class="upfront-save-button" data-save-as="'+t+'">'+Upfront.Settings.LayoutEditor.Specificity[e]+"</span>")}),location.pathname.indexOf("create_new")>-1?(r.remove(),n.remove(),t.apply(o,["single-post"])):(n.html(a),e("#upfront-save-dialog").on("click",".upfront-save-button",function(){var a=e(this).attr("data-save-as");return r.remove(),n.remove(),t.apply(o,[a]),!1}),e("#upfront-save-dialog-background").on("click",function(){return r.remove(),n.remove(),!1}))},load_theme:function(e){var t=location.origin;t+=location.pathname.split("create_new")[0],t+="create_new/"+e,location.toString().indexOf("dev=true")>-1&&(t+="?dev=true"),window.location=t},open_theme_fonts_manager:function(){var t={},o=new Upfront.Views.Editor.Fonts.Text_Fonts_Manager({collection:Upfront.Views.Editor.Fonts.theme_fonts_collection});if(o.render(),Upfront.Application.mode.current===Upfront.Application.MODE.THEME){var n=new Upfront.Views.Editor.Fonts.Icon_Fonts_Manager({collection:Upfront.Views.Editor.Fonts.icon_fonts_collection});n.render()}Upfront.Popup.open(function(o,n,r){var a=e(this);a.empty().append('<p class="upfront-popup-placeholder">'+Upfront.Settings.l10n.global.behaviors.loading_content+"</p>"),t.$popup={top:n,content:a,bottom:r}},{width:750},"font-manager-popup");t.$popup.top.html('<ul class="upfront-tabs"><li id="theme-text-fonts-tab" class="active">'+Upfront.Settings.l10n.global.behaviors.theme_text_fonts+"</li>"+(Upfront.Application.mode.current===Upfront.Application.MODE.THEME?'<li id="theme-icon-fonts-tab">'+Upfront.Settings.l10n.global.behaviors.theme_icon_fonts+"</li>":"")+"</ul>"+t.$popup.top.html()),t.$popup.top.on("click","#theme-text-fonts-tab",function(n){t.$popup.content.html(o.el),e("#theme-icon-fonts-tab").removeClass("active"),e("#theme-text-fonts-tab").addClass("active"),e(".theme-fonts-ok-button").css("margin-top","30px")}),t.$popup.top.on("click","#theme-icon-fonts-tab",function(){t.$popup.content.html(n.el),e("#theme-text-fonts-tab").removeClass("active"),e("#theme-icon-fonts-tab").addClass("active"),e(".theme-fonts-ok-button").css("margin-top",0)}),t.$popup.bottom.append('<a class="theme-fonts-ok-button">'+Upfront.Settings.l10n.global.behaviors.ok+"</a>"),t.$popup.content.html(o.el),o.set_ok_button(t.$popup.bottom.find(".theme-fonts-ok-button")),t.$popup.bottom.find(".theme-fonts-ok-button").on("click",function(){Upfront.Popup.close()})},create_layout_dialog:function(){var t=Upfront.Application,o=Upfront.Behaviors.LayoutEditor,n={layout:new Upfront.Views.Editor.Field.Select({name:"layout",values:[{label:Upfront.Settings.l10n.global.behaviors.loading,value:""}],change:function(){var e=this.get_value();"single-page"===e?n.$_page_name_wrap.show():n.$_page_name_wrap.hide()}}),page_name:new Upfront.Views.Editor.Field.Text({name:"page_name",label:Upfront.Settings.l10n.global.behaviors.page_layout_name}),inherit:new Upfront.Views.Editor.Field.Radios({name:"inherit",layout:"horizontal-inline",values:[{label:Upfront.Settings.l10n.global.behaviors.start_fresh,value:""},{label:Upfront.Settings.l10n.global.behaviors.start_from_existing,value:"existing"}]}),existing:new Upfront.Views.Editor.Field.Select({name:"existing",values:[]})};o.available_layouts?n.layout.options.values=_.map(o.available_layouts,function(e,t){return{label:e.label,value:t,disabled:e.saved}}):Upfront.Util.post({action:"upfront_list_available_layout"}).done(function(e){o.available_layouts=e.data,n.layout.options.values=_.map(o.available_layouts,function(e,t){return{label:e.label,value:t,disabled:e.saved}}),n.layout.render(),n.layout.delegateEvents()}),o.all_templates?n.existing.options.values=_.map(o.all_templates,function(e,t){return{label:t,value:e}}):Upfront.Util.post({action:"upfront-wp-model",model_action:"get_post_extra",postId:"fake",allTemplates:!0}).done(function(e){return e.data&&e.data.allTemplates?0===e.data.allTemplates.length?(n.inherit.$el.hide(),n.existing.$el.hide(),!1):(o.all_templates=e.data.allTemplates,n.existing.options.values=[],_.each(e.data.allTemplates,function(e,t){n.existing.options.values.push({label:t,value:e})}),void n.existing.render()):!1}),o.layout_modal||(o.layout_modal=new Upfront.Views.Editor.Modal({to:e("body"),button:!1,top:120,width:540}),o.layout_modal.render(),e("body").append(o.layout_modal.el)),o.layout_modal.open(function(t,r){var a=e('<div style="clear:both"><span class="uf-button">'+Upfront.Settings.l10n.global.behaviors.create+"</span></div>"),l=e('<div class="upfront-modal-select-wrap" />');$page_name_wrap=e('<div class="upfront-modal-select-wrap" />'),n.$_page_name_wrap=$page_name_wrap,_.each(n,function(e){return e.render?(e.render(),void e.delegateEvents()):!0}),t.html('<h1 class="upfront-modal-title">'+Upfront.Settings.l10n.global.behaviors.create_new_layout+"</h1>"),l.append(n.layout.el),t.append(l),$page_name_wrap.hide(),$page_name_wrap.append(n.page_name.el),$page_name_wrap.append(n.inherit.el),$page_name_wrap.append(n.existing.el),t.append($page_name_wrap),t.append(a),a.on("click",function(){o.layout_modal.close(!0)})},o).done(function(){var e=n.layout.get_value(),r=t.layout.get("layout_slug"),a=_.extend({},o.available_layouts[e]),l=n.page_name.get_value();"single-page"===e&&l&&(e="single-page-"+l.replace(/\s/g,"-").toLowerCase(),a={layout:{type:"single",item:"single-page",specificity:e}}),a.use_existing=e.match(/^single-page/)&&l&&"existing"===n.inherit.get_value()?n.existing.get_value():!1,t.create_layout(a.layout,{layout_slug:r,use_existing:a.use_existing}).done(function(){t.layout.set("current_layout",e),o._export_layout()})})},browse_layout_dialog:function(){var t=Upfront.Application,o=Upfront.Behaviors.LayoutEditor,n={layout:new Upfront.Views.Editor.Field.Select({name:"layout",values:[{label:Upfront.Settings.l10n.global.behaviors.loading,value:""}],default_value:t.layout.get("current_layout")})};o.browse_modal||(o.browse_modal=new Upfront.Views.Editor.Modal({to:e("body"),button:!1,top:120,width:540}),o.browse_modal.render(),e("body").append(o.browse_modal.el)),o._get_saved_layout().done(function(e){e&&0!=e.length?n.layout.options.values=_.map(o.saved_layouts,function(e,t){return{label:e.label,value:t}}):n.layout.options.values=[{label:Upfront.Settings.l10n.global.behaviors.no_saved_layout,value:""}],n.layout.render(),n.layout.delegateEvents()}),o.browse_modal.open(function(t,r){var a=e('<span class="uf-button">'+Upfront.Settings.l10n.global.behaviors.edit+"</span>"),l=e('<div class="upfront-modal-select-wrap" />');_.each(n,function(e){e.render(),e.delegateEvents()}),t.html('<h1 class="upfront-modal-title">'+Upfront.Settings.l10n.global.behaviors.edit_saved_layout+"</h1>"),l.append(n.layout.el),t.append(l),t.append(a),a.on("click",function(){o.browse_modal.close(!0)})},o).done(function(){var e=n.layout.get_value(),r=t.layout.get("layout_slug"),a=o.saved_layouts[e];a.latest_post&&(_upfront_post_data.post_id=a.latest_post),t.layout.set("current_layout",e),t.load_layout(a.layout,{layout_slug:r})})},is_exporter_start_page:function(){return"upfront"===Upfront.themeExporter.currentTheme},export_dialog:function(){var t,o,n=(Upfront.Application,Upfront.Behaviors.LayoutEditor);o=new Upfront.Views.Editor.Loading({loading:Upfront.Settings.l10n.global.behaviors.checking_layouts,done:Upfront.Settings.l10n.global.behaviors.layout_exported,fixed:!0}),n.is_exporter_start_page()?(t={theme:new Upfront.Views.Editor.Field.Select({name:"theme",default_value:"upfront"===Upfront.themeExporter.currentTheme?"":Upfront.themeExporter.currentTheme,label:Upfront.Settings.l10n.global.behaviors.select_theme,values:[{label:Upfront.Settings.l10n.global.behaviors.new_theme,value:""}],change:function(){var o=this.get_value(),n=e([t.name.el,t.directory.el,t.author.el,t.author_uri.el]);""!=o?n.hide():n.show()}}),name:new Upfront.Views.Editor.Field.Text({name:"name",label:Upfront.Settings.l10n.global.behaviors.theme_name}),directory:new Upfront.Views.Editor.Field.Text({name:"directory",label:Upfront.Settings.l10n.global.behaviors.directory}),author:new Upfront.Views.Editor.Field.Text({name:"author",label:Upfront.Settings.l10n.global.behaviors.author}),author_uri:new Upfront.Views.Editor.Field.Text({name:"author_uri",label:Upfront.Settings.l10n.global.behaviors.author_uri}),activate:new Upfront.Views.Editor.Field.Checkboxes({name:"activate",default_value:!0,multiple:!1,values:[{label:Upfront.Settings.l10n.global.behaviors.activate_upon_creation,value:1}]}),with_images:new Upfront.Views.Editor.Field.Checkboxes({name:"with_images",default_value:!0,multiple:!1,values:[{label:Upfront.Settings.l10n.global.behaviors.export_theme_images,value:1}]})},n.export_modal||(n.export_modal=new Upfront.Views.Editor.Modal({to:e("body"),button:!1,top:120,width:540}),n.export_modal.render(),e("body").append(n.export_modal.el)),n._get_themes().done(function(e){t.theme.options.values=_.union([{label:Upfront.Settings.l10n.global.behaviors.new_theme,value:""}],_.map(e,function(e,t){return{label:e.name,value:e.directory}})),t.theme.render(),t.theme.delegateEvents(),t.theme.$el.find("input").trigger("change")}),n.export_modal.open(function(r,a){var l=e('<span class="uf-button">'+Upfront.Settings.l10n.global.behaviors.export_button+"</span>");_.each(t,function(e){e.render(),e.delegateEvents()}),r.html('<h1 class="upfront-modal-title">'+Upfront.Settings.l10n.global.behaviors.export_theme+"</h1>"),r.append(t.theme.el),r.append(t.name.el),r.append(t.directory.el),r.append(t.author.el),r.append(t.author_uri.el),r.append(t.activate.el),r.append(t.with_images.el),r.append(l),l.on("click",function(){var r,a;r=t.theme.get_value()?t.theme.get_value():t.directory.get_value(),a=function(){var e={"thx-theme-name":t.name.get_value(),"thx-theme-slug":t.directory.get_value(),"thx-author":t.author.get_value(),"thx-author-uri":t.author_uri.get_value(),"thx-theme-template":"upfront","thx-activate_theme":t.activate.get_value()||"","thx-export_with_images":t.with_images.get_value()||"",add_global_regions:"blank"!==Upfront.Application.current_subapplication.layout.get("layout_slug")};return o.update_loading_text(Upfront.Settings.l10n.global.behaviors.creating_theme),n._create_theme(e)},o.render(),e("body").append(o.el),a().done(function(){n.export_single_layout(o,r).done(function(){n.load_theme(r)})})})},n)):(o.render(),e("body").append(o.el),n.export_single_layout(o,Upfront.themeExporter.currentTheme))},export_single_layout:function(e,t){var o=(Upfront.Application,Upfront.Behaviors.LayoutEditor),n=_upfront_post_data.layout.specificity||_upfront_post_data.layout.item||_upfront_post_data.layout.type;return e.update_loading_text(Upfront.Settings.l10n.global.behaviors.exporting_layout+n),o._export_layout({theme:t}).done(function(){e.done(function(){o.export_modal&&o.export_modal.close(!0),o.clean_region_css()})})},first_save_dialog:function(e){var t=Upfront.Application,o=Upfront.Behaviors.LayoutEditor,n=t.layout.get("current_layout");!e||n&&"archive-home"!=n||o.message_dialog(Upfront.Settings.l10n.global.behaviors.excellent_start,Upfront.Settings.l10n.global.behaviors.homepage_created)},message_dialog:function(t,o){var n=(Upfront.Application,Upfront.Behaviors.LayoutEditor);n.message_modal||(n.message_modal=new Upfront.Views.Editor.Modal({to:e("body"),button:!0,top:120,width:540}),n.message_modal.render(),e("body").append(n.message_modal.el)),n.message_modal.open(function(e,n){n.addClass("upfront-message-modal"),e.html('<h1 class="upfront-modal-title">'+t+"</h1>"),e.append(o)},n)},_get_saved_layout:function(){var t=this,o=new e.Deferred;return Upfront.Application.is_builder()?Upfront.Util.post({action:"upfront_list_theme_layouts"}).success(function(e){t.saved_layouts=e.data,o.resolve(e.data)}).error(function(){o.reject()}):setTimeout(o.reject),o.promise()},_get_themes:function(){var t=this,o=new e.Deferred;return Upfront.Application.is_builder()?Upfront.Util.post({action:"upfront_thx-get-themes"}).success(function(e){t.themes=e,o.resolve(e)}).error(function(){o.reject()}):setTimeout(o.reject),o.promise()},_create_theme:function(t){var o=new e.Deferred;return Upfront.Application.is_builder()?Upfront.Util.post({action:"upfront_thx-create-theme",form:this._build_query(t)}).success(function(e){e&&e.error?o.reject(e.error):o.resolve()}).error(function(){o.reject()}):setTimeout(o.reject),o.promise()},export_element_styles:function(e){return Upfront.Application.is_builder()?void Upfront.Util.post({action:"upfront_thx-export-element-styles",data:e}).success(function(t){return t&&t.error?void Upfront.Views.Editor.notify(t.error):(Upfront.data.styles[e.elementType]||(Upfront.data.styles[e.elementType]=[]),-1===Upfront.data.styles[e.elementType].indexOf(e.stylename)&&Upfront.data.styles[e.elementType].push(e.stylename),void Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.behaviors.style_exported))}).error(function(){Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.behaviors.style_export_fail)}):!1},_export_layout:function(t){var o,n,r,a=new e.Deferred,l={};return Upfront.Application.is_builder()?(o=_.findWhere(Upfront.Application.current_subapplication.get_layout_data().properties,{name:"typography"}),r=_.findWhere(Upfront.Application.current_subapplication.get_layout_data().properties,{name:"layout_style"}),n=_.extend({},Upfront.Util.model_to_json(Upfront.Application.current_subapplication.get_layout_data().properties)),n=_.reject(n,function(e){return _.contains(["typography","layout_style","global_regions"],e.name)}),l={typography:o?JSON.stringify(o.value):"",regions:JSON.stringify(Upfront.Application.current_subapplication.get_layout_data().regions),template:_upfront_post_data.layout.specificity||_upfront_post_data.layout.item||_upfront_post_data.layout.type,layout_properties:JSON.stringify(n),theme:Upfront.themeExporter.currentTheme,layout_style:r?r.value:"",theme_colors:{colors:Upfront.Views.Theme_Colors.colors.toJSON(),range:Upfront.Views.Theme_Colors.range},post_image_variants:Upfront.Content.ImageVariants.toJSON()},Upfront.themeExporter.layoutStyleDirty&&(l.layout_style=e("#layout-style").html(),Upfront.themeExporter.layoutStyleDirty=!1),t&&(l=_.extend(l,t)),Upfront.Util.post({action:"upfront_thx-export-layout",data:l}).success(function(e){e&&e.error?a.reject(e.error):a.resolve()}).error(function(){a.reject()}),a.promise()):(setTimeout(a.reject),a.promise())},clean_region_css:function(){var t=Upfront.Application.cssEditor,o=Upfront.Behaviors.LayoutEditor,n=[t.elementTypes.RegionContainer,t.elementTypes.Region],r=_upfront_post_data.layout,a=r.specificity||r.item||r.type,l=Upfront.Application.layout.get("regions"),i=[],s=[],p=function(t){if(!s[t])return Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.behaviors.region_css_cleaned),void u.resolve();var o=s[t].elementType,n=s[t].styleName;Upfront.Application.get_current()===Upfront.Settings.Application.MODE.THEME?data={action:"upfront_thx-delete-element-styles",data:{stylename:n,elementType:o}}:data={action:"upfront_delete_styles",styleName:n,elementType:o},Upfront.Util.post(data).done(function(){var r=Upfront.data.styles[o].indexOf(n);-1!=r&&Upfront.data.styles[o].splice(r,1),e("#upfront-style-"+n).remove(),p(t+1)})},u=new e.Deferred;return l.each(function(e){var o=e.is_main()?t.elementTypes.RegionContainer.id:t.elementTypes.Region.id,n=a+"-"+e.get("name")+"-style";"global"==e.get("scope");_.isArray(Upfront.data.styles[o])&&-1!=Upfront.data.styles[o].indexOf(n)&&i.push(n),n=o+"-"+e.get("name")+"-style",_.isArray(Upfront.data.styles[o])&&-1!=Upfront.data.styles[o].indexOf(n)&&i.push(n)}),o._get_saved_layout().done(function(e){_.each(n,function(t){_.each(Upfront.data.styles[t.id],function(o){var n=!1;_.each(e,function(e,t){if(t!=a){var r=a.match(new RegExp("^"+t+"-"));o.match(new RegExp("^"+t))&&(!r||r&&!o.match(new RegExp("^"+a)))&&(n=!0)}}),_.contains(i,o)||!o.match(new RegExp("^"+a))||n||s.push({elementType:t.id,styleName:o})})}),s.length>0&&(Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.behaviors.cleaning_region_css),p(0))}),u.promise()},_build_query:function(e){return _.map(e,function(e,t){return t+"="+e}).join("&")},clean_global_regions:function(){Upfront.data.global_regions=!1},open_global_region_manager:function(){var t=Upfront.Behaviors.LayoutEditor;Upfront.Popup.open(function(o,n,r){var a=e(this);a.html('<p class="upfront-popup-placeholder">'+Upfront.Settings.l10n.global.behaviors.loading_content+"</p>"),Upfront.data.global_regions?t._render_global_region_manager(a):t._refresh_global_regions().done(function(){t._render_global_region_manager(a)})},{width:600},"global-region-manager")},_refresh_global_regions:function(){return Upfront.Util.post({action:"upfront_list_scoped_regions",scope:"global",storage_key:_upfront_save_storage_key}).done(function(e){Upfront.data.global_regions=e.data})},_render_global_region_manager:function(t){var o=Upfront.Behaviors.LayoutEditor,n=Upfront.Application.layout.get("regions"),r=[{title:Upfront.Settings.l10n.global.behaviors.global_regions,classname:"global",data:_.sortBy(Upfront.data.global_regions,function(e,t,o){return e.container&&e.name!=e.container?3*_.indexOf(o,_.findWhere(o,{name:e.container}))+1:3*t})},{title:Upfront.Settings.l10n.global.behaviors.lightboxes,classname:"lightbox",data:Upfront.Util.model_to_json(n.filter(function(e){return"lightbox"==e.get("sub")}))}];t.html(""),_.each(r,function(n){var r=e('<div class="global-region-manager-wrap global-region-manager-'+n.classname+'"></div>'),a=e('<h3 class="global-region-manager-title">'+n.title+"</h3>"),l=e('<div class="global-region-manager-content upfront-scroll-panel"></div>');r.append([a,l]),o._render_regions(n.data,l),t.append(r),Upfront.Views.Mixins.Upfront_Scroll_Mixin.stop_scroll_propagation(l)}),t.on("click",".region-list-edit",function(e){e.preventDefault()}),t.on("click",".region-list-trash",function(r){r.preventDefault();var a=e(this).attr("data-name");e(this).closest(".global-region-manager-wrap").hasClass("global-region-manager-global")&&confirm("Deleting the global regions will remove it from all layouts. Continue?")&&Upfront.Util.post({action:"upfront_delete_scoped_regions",scope:"global",name:a,storage_key:_upfront_save_storage_key}).done(function(e){e.data&&(_.each(e.data,function(e){var t=n.get_by_name(e);n.remove(t)}),o._refresh_global_regions().done(function(){o._render_global_region_manager(t)}))})})},_render_regions:function(t,o){var n=e('<ul class="global-region-manager-lists"></ul>');_.each(t,function(e){var o=["global-region-manager-list"],r=!1;e.container&&e.name!=e.container?(r=_.find(t,function(t){return t.name==e.container}),o.push("region-list-sub"),o.push("region-list-sub-"+e.sub),r&&o.push("region-list-sub-has-main")):o.push("region-list-main"),n.append('<li class="'+o.join(" ")+'"><span class="region-list-name">'+e.title+'</span><span class="region-list-control">'+(Upfront.Application.get_current()!=Upfront.Settings.Application.MODE.THEME?'<a href="#" class="region-list-trash" data-name="'+e.name+'">'+Upfront.Settings.l10n.global.behaviors.trash+"</a>":"")+"</span></li>")}),o.append(n)}};define(t)}(jQuery);