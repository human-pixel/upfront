!function($){var l10n=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;define(["text!scripts/upfront/templates/map-editor.html"],function(editorTpl){var MapEditorView=Upfront.Views.ObjectView.extend({is_editing:!1,script_error:!1,SYNTAX_TYPES:{script:"json"},MIN_HEIGHT:200,editorTpl:_.template(editorTpl),content_editable_selector:".editable",initialize:function(){var t=this.fallback("script");this.checkJSon(t)},on_render:function(){this.start_json_editor()},start_json_editor:function(){if(this.is_editing)return!1;this.is_editing=!0;var t=$("#upfront_map-editor"),e=this;t.length||(t=$('<section id="upfront_map-editor" class="upfront-ui upfront_map-editor upfront_map-editor-complex"></section>'),$("body").append(t)),require([Upfront.Settings.ace_url],function(){e.createEditor(t)})},on_edit:function(){if(this.is_editing)return!1;var t=this.$el.find(".upfront_map-element "+this.content_editable_selector);if(t.length)return this.bootContentEditors(t);this.is_editing=!0;var e=$("#upfront_map-editor");e.length||(e=$('<section id="upfront_map-editor" class="upfront-ui upfront_map-editor upfront_map-editor-complex"></section>'),$("body").append(e)),this.createEditor(e)},bootContentEditors:function(t){if(!t||!t.length)return!1;var e=$(this.fallback("markup")),i=this;t.each(function(t){var r=$(this),n=0>=t;return r.data("ueditor")?!0:void r.ueditor({autostart:n,placeholder:"",disableLineBreak:!0}).on("start",function(){i.is_editing=!0}).on("stop",function(){i.is_editing=!1}).on("syncAfter",function(){var n=$(e.find(i.content_editable_selector)[t]);return n.length?(n.html(r.html()),void i.property("markup",$("<div />").append(e).html())):!1})})},startResizable:function(t){var e=this,i=t.find(".upfront-css-body"),r=0,n=t.find(".upfront_map-editor-complex-wrapper"),o=function(o,s){var a=s?s.size.height:t.find(".upfront_map-editor-complex-wrapper").height(),d=a-r;i.height(d),_.each(e.editors,function(t){t.resize()}),n.css({width:"",height:"",left:"",top:""})};n.find(".upfront-css-top").removeClass("ui-resizable-handle").addClass("ui-resizable-handle").removeClass("ui-resizable-n").addClass("ui-resizable-n"),r=t.find(".upfront-css-top").outerHeight(),o(),n.resizable({handles:{n:".upfront-css-top"},resize:o,minHeight:200,delay:100})},createEditor:function(t){var e=this;t.html(this.editorTpl({markup:this.fallback("markup"),style:this.fallback("style"),script:this.fallback("script"),l10n:l10n.template})),$("#page").css("padding-bottom","200px"),t.show(),this.resizeHandler=this.resizeHandler||function(){t.width($(window).width()-$("#sidebar-ui").width()-1)},$(window).on("resize",this.resizeHandler),this.resizeHandler(),this.editors={},this.timers={},t.find(".upfront_map-ace").each(function(){var i=$(this),r=i.html(),n=ace.edit(this),o=i.data("type");n.getSession().setUseWorker(!1),n.setTheme("ace/theme/monokai"),n.getSession().setMode("ace/mode/"+e.SYNTAX_TYPES[o]),n.setShowPrintMargin(!1),"markup"===o&&r&&n.getSession().setValue(r),n.on("change",function(){e.timers[o]&&clearTimeout(e.timers[o]),e.timers[o]=setTimeout(function(){var i=n.getValue();"script"==o&&e.checkJSon(i),e.script_error?t.find(".upfront_map-jsalert").show().find("i").attr("title",l10n.create.js_error+" "+e.script_error):t.find(".upfront_map-jsalert").hide(),e.property(o,i,!1)},1e3)}),n.renderer.scrollBar.width=5,n.renderer.scroller.style.right="5px",e.editors[o]=n}),this.currentEditor=this.editors.markup;var i=t.find(".upfront-css-top"),r=t.find(".upfront-css-body");r.height(this.MIN_HEIGHT-i.outerHeight()),this.startResizable(t),t.find("button").on("click",function(t){_.each(e.editors,function(t,i){e.property(i,t.getValue())}),e.property("map_styles",e.fallback("script"),!1),e.is_editing=!1,e.destroyEditor()}),t.on("click",".upfront-css-type",function(t){e.hiliteElement(t)}).on("click",".upfront-css-close",function(t){t.preventDefault(),e.destroyEditor(),$("#page").css("padding-bottom",0)})},destroyEditor:function(){var t=this;this.editors&&this.editors.length&&(_.each(this.editors,function(t){t.destroy()}),t.editors=!1),this.currentEditor=!1,$("#upfront_map-editor").html("").hide(),$(window).off("resize",this.resizeHandler),this.is_editing=!1},hiliteElement:function(t){t.preventDefault();var e=this.$el.find(".upfront-object-content"),i=e.offset().top-50;$(document).scrollTop(i>0?i:0),this.blink(e,4)},blink:function(t,e){var i=this;t.css("outline","3px solid #3ea"),setTimeout(function(){t.css("outline","none"),e--,e>0&&setTimeout(function(){i.blink(t,e-1)},100)},100)},checkJSon:function(json){this.script_error=!1;try{eval(json)}catch(e){this.script_error=e.message}},fallback:function(t){return this.model.get_property_value_by_name(t)||Upfront.data.upfront_code.defaults.fallbacks[t]},property:function(t,e,i){return"undefined"!=typeof e?("undefined"==typeof i&&(i=!0),this.model.set_property(t,e,i)):this.model.get_property_value_by_name(t)}});return MapEditorView})}(jQuery);