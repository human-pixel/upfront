//     Underscore.js 1.6.0
//     http://underscorejs.org
//     (c) 2009-2014 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Underscore may be freely distributed under the MIT license.
(function(){var n=this,t=n._,r={},e=Array.prototype,u=Object.prototype,i=Function.prototype,a=e.push,o=e.slice,c=e.concat,l=u.toString,f=u.hasOwnProperty,s=e.forEach,p=e.map,h=e.reduce,v=e.reduceRight,g=e.filter,d=e.every,m=e.some,y=e.indexOf,b=e.lastIndexOf,x=Array.isArray,w=Object.keys,_=i.bind,j=function(n){return n instanceof j?n:this instanceof j?void(this._wrapped=n):new j(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=j),exports._=j):n._=j,j.VERSION="1.6.0";var A=j.each=j.forEach=function(n,t,e){if(null==n)return n;if(s&&n.forEach===s)n.forEach(t,e);else if(n.length===+n.length){for(var u=0,i=n.length;i>u;u++)if(t.call(e,n[u],u,n)===r)return}else for(var a=j.keys(n),u=0,i=a.length;i>u;u++)if(t.call(e,n[a[u]],a[u],n)===r)return;return n};j.map=j.collect=function(n,t,r){var e=[];return null==n?e:p&&n.map===p?n.map(t,r):(A(n,function(n,u,i){e.push(t.call(r,n,u,i))}),e)};var O="Reduce of empty array with no initial value";j.reduce=j.foldl=j.inject=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),h&&n.reduce===h)return e&&(t=j.bind(t,e)),u?n.reduce(t,r):n.reduce(t);if(A(n,function(n,i,a){u?r=t.call(e,r,n,i,a):(r=n,u=!0)}),!u)throw new TypeError(O);return r},j.reduceRight=j.foldr=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),v&&n.reduceRight===v)return e&&(t=j.bind(t,e)),u?n.reduceRight(t,r):n.reduceRight(t);var i=n.length;if(i!==+i){var a=j.keys(n);i=a.length}if(A(n,function(o,c,l){c=a?a[--i]:--i,u?r=t.call(e,r,n[c],c,l):(r=n[c],u=!0)}),!u)throw new TypeError(O);return r},j.find=j.detect=function(n,t,r){var e;return k(n,function(n,u,i){return t.call(r,n,u,i)?(e=n,!0):void 0}),e},j.filter=j.select=function(n,t,r){var e=[];return null==n?e:g&&n.filter===g?n.filter(t,r):(A(n,function(n,u,i){t.call(r,n,u,i)&&e.push(n)}),e)},j.reject=function(n,t,r){return j.filter(n,function(n,e,u){return!t.call(r,n,e,u)},r)},j.every=j.all=function(n,t,e){t||(t=j.identity);var u=!0;return null==n?u:d&&n.every===d?n.every(t,e):(A(n,function(n,i,a){return(u=u&&t.call(e,n,i,a))?void 0:r}),!!u)};var k=j.some=j.any=function(n,t,e){t||(t=j.identity);var u=!1;return null==n?u:m&&n.some===m?n.some(t,e):(A(n,function(n,i,a){return u||(u=t.call(e,n,i,a))?r:void 0}),!!u)};j.contains=j.include=function(n,t){return null==n?!1:y&&n.indexOf===y?n.indexOf(t)!=-1:k(n,function(n){return n===t})},j.invoke=function(n,t){var r=o.call(arguments,2),e=j.isFunction(t);return j.map(n,function(n){return(e?t:n[t]).apply(n,r)})},j.pluck=function(n,t){return j.map(n,j.property(t))},j.where=function(n,t){return j.filter(n,j.matches(t))},j.findWhere=function(n,t){return j.find(n,j.matches(t))},j.max=function(n,t,r){if(!t&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.max.apply(Math,n);var e=-1/0,u=-1/0;return A(n,function(n,i,a){var o=t?t.call(r,n,i,a):n;o>u&&(e=n,u=o)}),e},j.min=function(n,t,r){if(!t&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.min.apply(Math,n);var e=1/0,u=1/0;return A(n,function(n,i,a){var o=t?t.call(r,n,i,a):n;u>o&&(e=n,u=o)}),e},j.shuffle=function(n){var t,r=0,e=[];return A(n,function(n){t=j.random(r++),e[r-1]=e[t],e[t]=n}),e},j.sample=function(n,t,r){return null==t||r?(n.length!==+n.length&&(n=j.values(n)),n[j.random(n.length-1)]):j.shuffle(n).slice(0,Math.max(0,t))};var E=function(n){return null==n?j.identity:j.isFunction(n)?n:j.property(n)};j.sortBy=function(n,t,r){return t=E(t),j.pluck(j.map(n,function(n,e,u){return{value:n,index:e,criteria:t.call(r,n,e,u)}}).sort(function(n,t){var r=n.criteria,e=t.criteria;if(r!==e){if(r>e||r===void 0)return 1;if(e>r||e===void 0)return-1}return n.index-t.index}),"value")};var F=function(n){return function(t,r,e){var u={};return r=E(r),A(t,function(i,a){var o=r.call(e,i,a,t);n(u,o,i)}),u}};j.groupBy=F(function(n,t,r){j.has(n,t)?n[t].push(r):n[t]=[r]}),j.indexBy=F(function(n,t,r){n[t]=r}),j.countBy=F(function(n,t){j.has(n,t)?n[t]++:n[t]=1}),j.sortedIndex=function(n,t,r,e){r=E(r);for(var u=r.call(e,t),i=0,a=n.length;a>i;){var o=i+a>>>1;r.call(e,n[o])<u?i=o+1:a=o}return i},j.toArray=function(n){return n?j.isArray(n)?o.call(n):n.length===+n.length?j.map(n,j.identity):j.values(n):[]},j.size=function(n){return null==n?0:n.length===+n.length?n.length:j.keys(n).length},j.first=j.head=j.take=function(n,t,r){return null==n?void 0:null==t||r?n[0]:0>t?[]:o.call(n,0,t)},j.initial=function(n,t,r){return o.call(n,0,n.length-(null==t||r?1:t))},j.last=function(n,t,r){return null==n?void 0:null==t||r?n[n.length-1]:o.call(n,Math.max(n.length-t,0))},j.rest=j.tail=j.drop=function(n,t,r){return o.call(n,null==t||r?1:t)},j.compact=function(n){return j.filter(n,j.identity)};var M=function(n,t,r){return t&&j.every(n,j.isArray)?c.apply(r,n):(A(n,function(n){j.isArray(n)||j.isArguments(n)?t?a.apply(r,n):M(n,t,r):r.push(n)}),r)};j.flatten=function(n,t){return M(n,t,[])},j.without=function(n){return j.difference(n,o.call(arguments,1))},j.partition=function(n,t){var r=[],e=[];return A(n,function(n){(t(n)?r:e).push(n)}),[r,e]},j.uniq=j.unique=function(n,t,r,e){j.isFunction(t)&&(e=r,r=t,t=!1);var u=r?j.map(n,r,e):n,i=[],a=[];return A(u,function(r,e){(t?e&&a[a.length-1]===r:j.contains(a,r))||(a.push(r),i.push(n[e]))}),i},j.union=function(){return j.uniq(j.flatten(arguments,!0))},j.intersection=function(n){var t=o.call(arguments,1);return j.filter(j.uniq(n),function(n){return j.every(t,function(t){return j.contains(t,n)})})},j.difference=function(n){var t=c.apply(e,o.call(arguments,1));return j.filter(n,function(n){return!j.contains(t,n)})},j.zip=function(){for(var n=j.max(j.pluck(arguments,"length").concat(0)),t=new Array(n),r=0;n>r;r++)t[r]=j.pluck(arguments,""+r);return t},j.object=function(n,t){if(null==n)return{};for(var r={},e=0,u=n.length;u>e;e++)t?r[n[e]]=t[e]:r[n[e][0]]=n[e][1];return r},j.indexOf=function(n,t,r){if(null==n)return-1;var e=0,u=n.length;if(r){if("number"!=typeof r)return e=j.sortedIndex(n,t),n[e]===t?e:-1;e=0>r?Math.max(0,u+r):r}if(y&&n.indexOf===y)return n.indexOf(t,r);for(;u>e;e++)if(n[e]===t)return e;return-1},j.lastIndexOf=function(n,t,r){if(null==n)return-1;var e=null!=r;if(b&&n.lastIndexOf===b)return e?n.lastIndexOf(t,r):n.lastIndexOf(t);for(var u=e?r:n.length;u--;)if(n[u]===t)return u;return-1},j.range=function(n,t,r){arguments.length<=1&&(t=n||0,n=0),r=arguments[2]||1;for(var e=Math.max(Math.ceil((t-n)/r),0),u=0,i=new Array(e);e>u;)i[u++]=n,n+=r;return i};var R=function(){};j.bind=function(n,t){var r,e;if(_&&n.bind===_)return _.apply(n,o.call(arguments,1));if(!j.isFunction(n))throw new TypeError;return r=o.call(arguments,2),e=function(){if(!(this instanceof e))return n.apply(t,r.concat(o.call(arguments)));R.prototype=n.prototype;var u=new R;R.prototype=null;var i=n.apply(u,r.concat(o.call(arguments)));return Object(i)===i?i:u}},j.partial=function(n){var t=o.call(arguments,1);return function(){for(var r=0,e=t.slice(),u=0,i=e.length;i>u;u++)e[u]===j&&(e[u]=arguments[r++]);for(;r<arguments.length;)e.push(arguments[r++]);return n.apply(this,e)}},j.bindAll=function(n){var t=o.call(arguments,1);if(0===t.length)throw new Error("bindAll must be passed function names");return A(t,function(t){n[t]=j.bind(n[t],n)}),n},j.memoize=function(n,t){var r={};return t||(t=j.identity),function(){var e=t.apply(this,arguments);return j.has(r,e)?r[e]:r[e]=n.apply(this,arguments)}},j.delay=function(n,t){var r=o.call(arguments,2);return setTimeout(function(){return n.apply(null,r)},t)},j.defer=function(n){return j.delay.apply(j,[n,1].concat(o.call(arguments,1)))},j.throttle=function(n,t,r){var e,u,i,a=null,o=0;r||(r={});var c=function(){o=r.leading===!1?0:j.now(),a=null,i=n.apply(e,u),e=u=null};return function(){var l=j.now();o||r.leading!==!1||(o=l);var f=t-(l-o);return e=this,u=arguments,0>=f?(clearTimeout(a),a=null,o=l,i=n.apply(e,u),e=u=null):a||r.trailing===!1||(a=setTimeout(c,f)),i}},j.debounce=function(n,t,r){var e,u,i,a,o,c=function(){var l=j.now()-a;t>l?e=setTimeout(c,t-l):(e=null,r||(o=n.apply(i,u),i=u=null))};return function(){i=this,u=arguments,a=j.now();var l=r&&!e;return e||(e=setTimeout(c,t)),l&&(o=n.apply(i,u),i=u=null),o}},j.once=function(n){var t,r=!1;return function(){return r?t:(r=!0,t=n.apply(this,arguments),n=null,t)}},j.wrap=function(n,t){return j.partial(t,n)},j.compose=function(){var n=arguments;return function(){for(var t=arguments,r=n.length-1;r>=0;r--)t=[n[r].apply(this,t)];return t[0]}},j.after=function(n,t){return function(){return--n<1?t.apply(this,arguments):void 0}},j.keys=function(n){if(!j.isObject(n))return[];if(w)return w(n);var t=[];for(var r in n)j.has(n,r)&&t.push(r);return t},j.values=function(n){for(var t=j.keys(n),r=t.length,e=new Array(r),u=0;r>u;u++)e[u]=n[t[u]];return e},j.pairs=function(n){for(var t=j.keys(n),r=t.length,e=new Array(r),u=0;r>u;u++)e[u]=[t[u],n[t[u]]];return e},j.invert=function(n){for(var t={},r=j.keys(n),e=0,u=r.length;u>e;e++)t[n[r[e]]]=r[e];return t},j.functions=j.methods=function(n){var t=[];for(var r in n)j.isFunction(n[r])&&t.push(r);return t.sort()},j.extend=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]=t[r]}),n},j.pick=function(n){var t={},r=c.apply(e,o.call(arguments,1));return A(r,function(r){r in n&&(t[r]=n[r])}),t},j.omit=function(n){var t={},r=c.apply(e,o.call(arguments,1));for(var u in n)j.contains(r,u)||(t[u]=n[u]);return t},j.defaults=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]===void 0&&(n[r]=t[r])}),n},j.clone=function(n){return j.isObject(n)?j.isArray(n)?n.slice():j.extend({},n):n},j.tap=function(n,t){return t(n),n};var S=function(n,t,r,e){if(n===t)return 0!==n||1/n==1/t;if(null==n||null==t)return n===t;n instanceof j&&(n=n._wrapped),t instanceof j&&(t=t._wrapped);var u=l.call(n);if(u!=l.call(t))return!1;switch(u){case"[object String]":return n==String(t);case"[object Number]":return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case"[object Date]":case"[object Boolean]":return+n==+t;case"[object RegExp]":return n.source==t.source&&n.global==t.global&&n.multiline==t.multiline&&n.ignoreCase==t.ignoreCase}if("object"!=typeof n||"object"!=typeof t)return!1;for(var i=r.length;i--;)if(r[i]==n)return e[i]==t;var a=n.constructor,o=t.constructor;if(a!==o&&!(j.isFunction(a)&&a instanceof a&&j.isFunction(o)&&o instanceof o)&&"constructor"in n&&"constructor"in t)return!1;r.push(n),e.push(t);var c=0,f=!0;if("[object Array]"==u){if(c=n.length,f=c==t.length)for(;c--&&(f=S(n[c],t[c],r,e)););}else{for(var s in n)if(j.has(n,s)&&(c++,!(f=j.has(t,s)&&S(n[s],t[s],r,e))))break;if(f){for(s in t)if(j.has(t,s)&&!c--)break;f=!c}}return r.pop(),e.pop(),f};j.isEqual=function(n,t){return S(n,t,[],[])},j.isEmpty=function(n){if(null==n)return!0;if(j.isArray(n)||j.isString(n))return 0===n.length;for(var t in n)if(j.has(n,t))return!1;return!0},j.isElement=function(n){return!(!n||1!==n.nodeType)},j.isArray=x||function(n){return"[object Array]"==l.call(n)},j.isObject=function(n){return n===Object(n)},A(["Arguments","Function","String","Number","Date","RegExp"],function(n){j["is"+n]=function(t){return l.call(t)=="[object "+n+"]"}}),j.isArguments(arguments)||(j.isArguments=function(n){return!(!n||!j.has(n,"callee"))}),"function"!=typeof/./&&(j.isFunction=function(n){return"function"==typeof n}),j.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},j.isNaN=function(n){return j.isNumber(n)&&n!=+n},j.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"==l.call(n)},j.isNull=function(n){return null===n},j.isUndefined=function(n){return n===void 0},j.has=function(n,t){return f.call(n,t)},j.noConflict=function(){return n._=t,this},j.identity=function(n){return n},j.constant=function(n){return function(){return n}},j.property=function(n){return function(t){return t[n]}},j.matches=function(n){return function(t){if(t===n)return!0;for(var r in n)if(n[r]!==t[r])return!1;return!0}},j.times=function(n,t,r){for(var e=Array(Math.max(0,n)),u=0;n>u;u++)e[u]=t.call(r,u);return e},j.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))},j.now=Date.now||function(){return(new Date).getTime()};var T={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};T.unescape=j.invert(T.escape);var I={escape:new RegExp("["+j.keys(T.escape).join("")+"]","g"),unescape:new RegExp("("+j.keys(T.unescape).join("|")+")","g")};j.each(["escape","unescape"],function(n){j[n]=function(t){return null==t?"":(""+t).replace(I[n],function(t){return T[n][t]})}}),j.result=function(n,t){if(null==n)return void 0;var r=n[t];return j.isFunction(r)?r.call(n):r},j.mixin=function(n){A(j.functions(n),function(t){var r=j[t]=n[t];j.prototype[t]=function(){var n=[this._wrapped];return a.apply(n,arguments),z.call(this,r.apply(j,n))}})};var N=0;j.uniqueId=function(n){var t=++N+"";return n?n+t:t},j.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var q=/(.)^/,B={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},D=/\\|'|\r|\n|\t|\u2028|\u2029/g;j.template=function(n,t,r){var e;r=j.defaults({},r,j.templateSettings);var u=new RegExp([(r.escape||q).source,(r.interpolate||q).source,(r.evaluate||q).source].join("|")+"|$","g"),i=0,a="__p+='";n.replace(u,function(t,r,e,u,o){return a+=n.slice(i,o).replace(D,function(n){return"\\"+B[n]}),r&&(a+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'"),e&&(a+="'+\n((__t=("+e+"))==null?'':__t)+\n'"),u&&(a+="';\n"+u+"\n__p+='"),i=o+t.length,t}),a+="';\n",r.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{e=new Function(r.variable||"obj","_",a)}catch(o){throw o.source=a,o}if(t)return e(t,j);var c=function(n){return e.call(this,n,j)};return c.source="function("+(r.variable||"obj")+"){\n"+a+"}",c},j.chain=function(n){return j(n).chain()};var z=function(n){return this._chain?j(n).chain():n};j.mixin(j),A(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=e[n];j.prototype[n]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!=n&&"splice"!=n||0!==r.length||delete r[0],z.call(this,r)}}),A(["concat","join","slice"],function(n){var t=e[n];j.prototype[n]=function(){return z.call(this,t.apply(this._wrapped,arguments))}}),j.extend(j.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof define&&define.amd&&define("underscore",[],function(){return j})}).call(this);

(function(t,e){if(typeof define==="function"&&define.amd){define('backbone',["underscore","jquery","exports"],function(i,r,s){t.Backbone=e(t,s,i,r)})}else if(typeof exports!=="undefined"){var i=require("underscore");e(t,exports,i)}else{t.Backbone=e(t,{},t._,t.jQuery||t.Zepto||t.ender||t.$)}})(this,function(t,e,i,r){var s=t.Backbone;var n=[];var a=n.push;var o=n.slice;var h=n.splice;e.VERSION="1.1.2";e.$=r;e.noConflict=function(){t.Backbone=s;return this};e.emulateHTTP=false;e.emulateJSON=false;var u=e.Events={on:function(t,e,i){if(!c(this,"on",t,[e,i])||!e)return this;this._events||(this._events={});var r=this._events[t]||(this._events[t]=[]);r.push({callback:e,context:i,ctx:i||this});return this},once:function(t,e,r){if(!c(this,"once",t,[e,r])||!e)return this;var s=this;var n=i.once(function(){s.off(t,n);e.apply(this,arguments)});n._callback=e;return this.on(t,n,r)},off:function(t,e,r){var s,n,a,o,h,u,l,f;if(!this._events||!c(this,"off",t,[e,r]))return this;if(!t&&!e&&!r){this._events=void 0;return this}o=t?[t]:i.keys(this._events);for(h=0,u=o.length;h<u;h++){t=o[h];if(a=this._events[t]){this._events[t]=s=[];if(e||r){for(l=0,f=a.length;l<f;l++){n=a[l];if(e&&e!==n.callback&&e!==n.callback._callback||r&&r!==n.context){s.push(n)}}}if(!s.length)delete this._events[t]}}return this},trigger:function(t){if(!this._events)return this;var e=o.call(arguments,1);if(!c(this,"trigger",t,e))return this;var i=this._events[t];var r=this._events.all;if(i)f(i,e);if(r)f(r,arguments);return this},stopListening:function(t,e,r){var s=this._listeningTo;if(!s)return this;var n=!e&&!r;if(!r&&typeof e==="object")r=this;if(t)(s={})[t._listenId]=t;for(var a in s){t=s[a];t.off(e,r,this);if(n||i.isEmpty(t._events))delete this._listeningTo[a]}return this}};var l=/\s+/;var c=function(t,e,i,r){if(!i)return true;if(typeof i==="object"){for(var s in i){t[e].apply(t,[s,i[s]].concat(r))}return false}if(l.test(i)){var n=i.split(l);for(var a=0,o=n.length;a<o;a++){t[e].apply(t,[n[a]].concat(r))}return false}return true};var f=function(t,e){var i,r=-1,s=t.length,n=e[0],a=e[1],o=e[2];switch(e.length){case 0:while(++r<s)(i=t[r]).callback.call(i.ctx);return;case 1:while(++r<s)(i=t[r]).callback.call(i.ctx,n);return;case 2:while(++r<s)(i=t[r]).callback.call(i.ctx,n,a);return;case 3:while(++r<s)(i=t[r]).callback.call(i.ctx,n,a,o);return;default:while(++r<s)(i=t[r]).callback.apply(i.ctx,e);return}};var d={listenTo:"on",listenToOnce:"once"};i.each(d,function(t,e){u[e]=function(e,r,s){var n=this._listeningTo||(this._listeningTo={});var a=e._listenId||(e._listenId=i.uniqueId("l"));n[a]=e;if(!s&&typeof r==="object")s=this;e[t](r,s,this);return this}});u.bind=u.on;u.unbind=u.off;i.extend(e,u);var p=e.Model=function(t,e){var r=t||{};e||(e={});this.cid=i.uniqueId("c");this.attributes={};if(e.collection)this.collection=e.collection;if(e.parse)r=this.parse(r,e)||{};r=i.defaults({},r,i.result(this,"defaults"));this.set(r,e);this.changed={};this.initialize.apply(this,arguments)};i.extend(p.prototype,u,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(t){return i.clone(this.attributes)},sync:function(){return e.sync.apply(this,arguments)},get:function(t){return this.attributes[t]},escape:function(t){return i.escape(this.get(t))},has:function(t){return this.get(t)!=null},set:function(t,e,r){var s,n,a,o,h,u,l,c;if(t==null)return this;if(typeof t==="object"){n=t;r=e}else{(n={})[t]=e}r||(r={});if(!this._validate(n,r))return false;a=r.unset;h=r.silent;o=[];u=this._changing;this._changing=true;if(!u){this._previousAttributes=i.clone(this.attributes);this.changed={}}c=this.attributes,l=this._previousAttributes;if(this.idAttribute in n)this.id=n[this.idAttribute];for(s in n){e=n[s];if(!i.isEqual(c[s],e))o.push(s);if(!i.isEqual(l[s],e)){this.changed[s]=e}else{delete this.changed[s]}a?delete c[s]:c[s]=e}if(!h){if(o.length)this._pending=r;for(var f=0,d=o.length;f<d;f++){this.trigger("change:"+o[f],this,c[o[f]],r)}}if(u)return this;if(!h){while(this._pending){r=this._pending;this._pending=false;this.trigger("change",this,r)}}this._pending=false;this._changing=false;return this},unset:function(t,e){return this.set(t,void 0,i.extend({},e,{unset:true}))},clear:function(t){var e={};for(var r in this.attributes)e[r]=void 0;return this.set(e,i.extend({},t,{unset:true}))},hasChanged:function(t){if(t==null)return!i.isEmpty(this.changed);return i.has(this.changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?i.clone(this.changed):false;var e,r=false;var s=this._changing?this._previousAttributes:this.attributes;for(var n in t){if(i.isEqual(s[n],e=t[n]))continue;(r||(r={}))[n]=e}return r},previous:function(t){if(t==null||!this._previousAttributes)return null;return this._previousAttributes[t]},previousAttributes:function(){return i.clone(this._previousAttributes)},fetch:function(t){t=t?i.clone(t):{};if(t.parse===void 0)t.parse=true;var e=this;var r=t.success;t.success=function(i){if(!e.set(e.parse(i,t),t))return false;if(r)r(e,i,t);e.trigger("sync",e,i,t)};q(this,t);return this.sync("read",this,t)},save:function(t,e,r){var s,n,a,o=this.attributes;if(t==null||typeof t==="object"){s=t;r=e}else{(s={})[t]=e}r=i.extend({validate:true},r);if(s&&!r.wait){if(!this.set(s,r))return false}else{if(!this._validate(s,r))return false}if(s&&r.wait){this.attributes=i.extend({},o,s)}if(r.parse===void 0)r.parse=true;var h=this;var u=r.success;r.success=function(t){h.attributes=o;var e=h.parse(t,r);if(r.wait)e=i.extend(s||{},e);if(i.isObject(e)&&!h.set(e,r)){return false}if(u)u(h,t,r);h.trigger("sync",h,t,r)};q(this,r);n=this.isNew()?"create":r.patch?"patch":"update";if(n==="patch")r.attrs=s;a=this.sync(n,this,r);if(s&&r.wait)this.attributes=o;return a},destroy:function(t){t=t?i.clone(t):{};var e=this;var r=t.success;var s=function(){e.trigger("destroy",e,e.collection,t)};t.success=function(i){if(t.wait||e.isNew())s();if(r)r(e,i,t);if(!e.isNew())e.trigger("sync",e,i,t)};if(this.isNew()){t.success();return false}q(this,t);var n=this.sync("delete",this,t);if(!t.wait)s();return n},url:function(){var t=i.result(this,"urlRoot")||i.result(this.collection,"url")||M();if(this.isNew())return t;return t.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(t,e){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(t){return this._validate({},i.extend(t||{},{validate:true}))},_validate:function(t,e){if(!e.validate||!this.validate)return true;t=i.extend({},this.attributes,t);var r=this.validationError=this.validate(t,e)||null;if(!r)return true;this.trigger("invalid",this,r,i.extend(e,{validationError:r}));return false}});var v=["keys","values","pairs","invert","pick","omit"];i.each(v,function(t){p.prototype[t]=function(){var e=o.call(arguments);e.unshift(this.attributes);return i[t].apply(i,e)}});var g=e.Collection=function(t,e){e||(e={});if(e.model)this.model=e.model;if(e.comparator!==void 0)this.comparator=e.comparator;this._reset();this.initialize.apply(this,arguments);if(t)this.reset(t,i.extend({silent:true},e))};var m={add:true,remove:true,merge:true};var y={add:true,remove:false};i.extend(g.prototype,u,{model:p,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return e.sync.apply(this,arguments)},add:function(t,e){return this.set(t,i.extend({merge:false},e,y))},remove:function(t,e){var r=!i.isArray(t);t=r?[t]:i.clone(t);e||(e={});var s,n,a,o;for(s=0,n=t.length;s<n;s++){o=t[s]=this.get(t[s]);if(!o)continue;delete this._byId[o.id];delete this._byId[o.cid];a=this.indexOf(o);this.models.splice(a,1);this.length--;if(!e.silent){e.index=a;o.trigger("remove",o,this,e)}this._removeReference(o,e)}return r?t[0]:t},set:function(t,e){e=i.defaults({},e,m);if(e.parse)t=this.parse(t,e);var r=!i.isArray(t);t=r?t?[t]:[]:i.clone(t);var s,n,a,o,h,u,l;var c=e.at;var f=this.model;var d=this.comparator&&c==null&&e.sort!==false;var v=i.isString(this.comparator)?this.comparator:null;var g=[],y=[],_={};var b=e.add,w=e.merge,x=e.remove;var E=!d&&b&&x?[]:false;for(s=0,n=t.length;s<n;s++){h=t[s]||{};if(h instanceof p){a=o=h}else{a=h[f.prototype.idAttribute||"id"]}if(u=this.get(a)){if(x)_[u.cid]=true;if(w){h=h===o?o.attributes:h;if(e.parse)h=u.parse(h,e);u.set(h,e);if(d&&!l&&u.hasChanged(v))l=true}t[s]=u}else if(b){o=t[s]=this._prepareModel(h,e);if(!o)continue;g.push(o);this._addReference(o,e)}o=u||o;if(E&&(o.isNew()||!_[o.id]))E.push(o);_[o.id]=true}if(x){for(s=0,n=this.length;s<n;++s){if(!_[(o=this.models[s]).cid])y.push(o)}if(y.length)this.remove(y,e)}if(g.length||E&&E.length){if(d)l=true;this.length+=g.length;if(c!=null){for(s=0,n=g.length;s<n;s++){this.models.splice(c+s,0,g[s])}}else{if(E)this.models.length=0;var k=E||g;for(s=0,n=k.length;s<n;s++){this.models.push(k[s])}}}if(l)this.sort({silent:true});if(!e.silent){for(s=0,n=g.length;s<n;s++){(o=g[s]).trigger("add",o,this,e)}if(l||E&&E.length)this.trigger("sort",this,e)}return r?t[0]:t},reset:function(t,e){e||(e={});for(var r=0,s=this.models.length;r<s;r++){this._removeReference(this.models[r],e)}e.previousModels=this.models;this._reset();t=this.add(t,i.extend({silent:true},e));if(!e.silent)this.trigger("reset",this,e);return t},push:function(t,e){return this.add(t,i.extend({at:this.length},e))},pop:function(t){var e=this.at(this.length-1);this.remove(e,t);return e},unshift:function(t,e){return this.add(t,i.extend({at:0},e))},shift:function(t){var e=this.at(0);this.remove(e,t);return e},slice:function(){return o.apply(this.models,arguments)},get:function(t){if(t==null)return void 0;return this._byId[t]||this._byId[t.id]||this._byId[t.cid]},at:function(t){return this.models[t]},where:function(t,e){if(i.isEmpty(t))return e?void 0:[];return this[e?"find":"filter"](function(e){for(var i in t){if(t[i]!==e.get(i))return false}return true})},findWhere:function(t){return this.where(t,true)},sort:function(t){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");t||(t={});if(i.isString(this.comparator)||this.comparator.length===1){this.models=this.sortBy(this.comparator,this)}else{this.models.sort(i.bind(this.comparator,this))}if(!t.silent)this.trigger("sort",this,t);return this},pluck:function(t){return i.invoke(this.models,"get",t)},fetch:function(t){t=t?i.clone(t):{};if(t.parse===void 0)t.parse=true;var e=t.success;var r=this;t.success=function(i){var s=t.reset?"reset":"set";r[s](i,t);if(e)e(r,i,t);r.trigger("sync",r,i,t)};q(this,t);return this.sync("read",this,t)},create:function(t,e){e=e?i.clone(e):{};if(!(t=this._prepareModel(t,e)))return false;if(!e.wait)this.add(t,e);var r=this;var s=e.success;e.success=function(t,i){if(e.wait)r.add(t,e);if(s)s(t,i,e)};t.save(null,e);return t},parse:function(t,e){return t},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(t,e){if(t instanceof p)return t;e=e?i.clone(e):{};e.collection=this;var r=new this.model(t,e);if(!r.validationError)return r;this.trigger("invalid",this,r.validationError,e);return false},_addReference:function(t,e){this._byId[t.cid]=t;if(t.id!=null)this._byId[t.id]=t;if(!t.collection)t.collection=this;t.on("all",this._onModelEvent,this)},_removeReference:function(t,e){if(this===t.collection)delete t.collection;t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,r){if((t==="add"||t==="remove")&&i!==this)return;if(t==="destroy")this.remove(e,r);if(e&&t==="change:"+e.idAttribute){delete this._byId[e.previous(e.idAttribute)];if(e.id!=null)this._byId[e.id]=e}this.trigger.apply(this,arguments)}});var _=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample"];i.each(_,function(t){g.prototype[t]=function(){var e=o.call(arguments);e.unshift(this.models);return i[t].apply(i,e)}});var b=["groupBy","countBy","sortBy","indexBy"];i.each(b,function(t){g.prototype[t]=function(e,r){var s=i.isFunction(e)?e:function(t){return t.get(e)};return i[t](this.models,s,r)}});var w=e.View=function(t){this.cid=i.uniqueId("view");t||(t={});i.extend(this,i.pick(t,E));this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};var x=/^(\S+)\s*(.*)$/;var E=["model","collection","el","id","attributes","className","tagName","events"];i.extend(w.prototype,u,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();this.stopListening();return this},setElement:function(t,i){if(this.$el)this.undelegateEvents();this.$el=t instanceof e.$?t:e.$(t);this.el=this.$el[0];if(i!==false)this.delegateEvents();return this},delegateEvents:function(t){if(!(t||(t=i.result(this,"events"))))return this;this.undelegateEvents();for(var e in t){var r=t[e];if(!i.isFunction(r))r=this[t[e]];if(!r)continue;var s=e.match(x);var n=s[1],a=s[2];r=i.bind(r,this);n+=".delegateEvents"+this.cid;if(a===""){this.$el.on(n,r)}else{this.$el.on(n,a,r)}}return this},undelegateEvents:function(){this.$el.off(".delegateEvents"+this.cid);return this},_ensureElement:function(){if(!this.el){var t=i.extend({},i.result(this,"attributes"));if(this.id)t.id=i.result(this,"id");if(this.className)t["class"]=i.result(this,"className");var r=e.$("<"+i.result(this,"tagName")+">").attr(t);this.setElement(r,false)}else{this.setElement(i.result(this,"el"),false)}}});e.sync=function(t,r,s){var n=T[t];i.defaults(s||(s={}),{emulateHTTP:e.emulateHTTP,emulateJSON:e.emulateJSON});var a={type:n,dataType:"json"};if(!s.url){a.url=i.result(r,"url")||M()}if(s.data==null&&r&&(t==="create"||t==="update"||t==="patch")){a.contentType="application/json";a.data=JSON.stringify(s.attrs||r.toJSON(s))}if(s.emulateJSON){a.contentType="application/x-www-form-urlencoded";a.data=a.data?{model:a.data}:{}}if(s.emulateHTTP&&(n==="PUT"||n==="DELETE"||n==="PATCH")){a.type="POST";if(s.emulateJSON)a.data._method=n;var o=s.beforeSend;s.beforeSend=function(t){t.setRequestHeader("X-HTTP-Method-Override",n);if(o)return o.apply(this,arguments)}}if(a.type!=="GET"&&!s.emulateJSON){a.processData=false}if(a.type==="PATCH"&&k){a.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")}}var h=s.xhr=e.ajax(i.extend(a,s));r.trigger("request",r,h,s);return h};var k=typeof window!=="undefined"&&!!window.ActiveXObject&&!(window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent);var T={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};e.ajax=function(){return e.$.ajax.apply(e.$,arguments)};var $=e.Router=function(t){t||(t={});if(t.routes)this.routes=t.routes;this._bindRoutes();this.initialize.apply(this,arguments)};var S=/\((.*?)\)/g;var H=/(\(\?)?:\w+/g;var A=/\*\w+/g;var I=/[\-{}\[\]+?.,\\\^$|#\s]/g;i.extend($.prototype,u,{initialize:function(){},route:function(t,r,s){if(!i.isRegExp(t))t=this._routeToRegExp(t);if(i.isFunction(r)){s=r;r=""}if(!s)s=this[r];var n=this;e.history.route(t,function(i){var a=n._extractParameters(t,i);n.execute(s,a);n.trigger.apply(n,["route:"+r].concat(a));n.trigger("route",r,a);e.history.trigger("route",n,r,a)});return this},execute:function(t,e){if(t)t.apply(this,e)},navigate:function(t,i){e.history.navigate(t,i);return this},_bindRoutes:function(){if(!this.routes)return;this.routes=i.result(this,"routes");var t,e=i.keys(this.routes);while((t=e.pop())!=null){this.route(t,this.routes[t])}},_routeToRegExp:function(t){t=t.replace(I,"\\$&").replace(S,"(?:$1)?").replace(H,function(t,e){return e?t:"([^/?]+)"}).replace(A,"([^?]*?)");return new RegExp("^"+t+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(t,e){var r=t.exec(e).slice(1);return i.map(r,function(t,e){if(e===r.length-1)return t||null;return t?decodeURIComponent(t):null})}});var N=e.History=function(){this.handlers=[];i.bindAll(this,"checkUrl");if(typeof window!=="undefined"){this.location=window.location;this.history=window.history}};var R=/^[#\/]|\s+$/g;var O=/^\/+|\/+$/g;var P=/msie [\w.]+/;var C=/\/$/;var j=/#.*$/;N.started=false;i.extend(N.prototype,u,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root},getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,e){if(t==null){if(this._hasPushState||!this._wantsHashChange||e){t=decodeURI(this.location.pathname+this.location.search);var i=this.root.replace(C,"");if(!t.indexOf(i))t=t.slice(i.length)}else{t=this.getHash()}}return t.replace(R,"")},start:function(t){if(N.started)throw new Error("Backbone.history has already been started");N.started=true;this.options=i.extend({root:"/"},this.options,t);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var r=this.getFragment();var s=document.documentMode;var n=P.exec(navigator.userAgent.toLowerCase())&&(!s||s<=7);this.root=("/"+this.root+"/").replace(O,"/");if(n&&this._wantsHashChange){var a=e.$('<iframe src="javascript:0" tabindex="-1">');this.iframe=a.hide().appendTo("body")[0].contentWindow;this.navigate(r)}if(this._hasPushState){e.$(window).on("popstate",this.checkUrl)}else if(this._wantsHashChange&&"onhashchange"in window&&!n){e.$(window).on("hashchange",this.checkUrl)}else if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval)}this.fragment=r;var o=this.location;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){this.fragment=this.getFragment(null,true);this.location.replace(this.root+"#"+this.fragment);return true}else if(this._hasPushState&&this.atRoot()&&o.hash){this.fragment=this.getHash().replace(R,"");this.history.replaceState({},document.title,this.root+this.fragment)}}if(!this.options.silent)return this.loadUrl()},stop:function(){e.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl);if(this._checkUrlInterval)clearInterval(this._checkUrlInterval);N.started=false},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(t){var e=this.getFragment();if(e===this.fragment&&this.iframe){e=this.getFragment(this.getHash(this.iframe))}if(e===this.fragment)return false;if(this.iframe)this.navigate(e);this.loadUrl()},loadUrl:function(t){t=this.fragment=this.getFragment(t);return i.any(this.handlers,function(e){if(e.route.test(t)){e.callback(t);return true}})},navigate:function(t,e){if(!N.started)return false;if(!e||e===true)e={trigger:!!e};var i=this.root+(t=this.getFragment(t||""));t=t.replace(j,"");if(this.fragment===t)return;this.fragment=t;if(t===""&&i!=="/")i=i.slice(0,-1);if(this._hasPushState){this.history[e.replace?"replaceState":"pushState"]({},document.title,i)}else if(this._wantsHashChange){this._updateHash(this.location,t,e.replace);if(this.iframe&&t!==this.getFragment(this.getHash(this.iframe))){if(!e.replace)this.iframe.document.open().close();this._updateHash(this.iframe.location,t,e.replace)}}else{return this.location.assign(i)}if(e.trigger)return this.loadUrl(t)},_updateHash:function(t,e,i){if(i){var r=t.href.replace(/(javascript:|#).*$/,"");t.replace(r+"#"+e)}else{t.hash="#"+e}}});e.history=new N;var U=function(t,e){var r=this;var s;if(t&&i.has(t,"constructor")){s=t.constructor}else{s=function(){return r.apply(this,arguments)}}i.extend(s,r,e);var n=function(){this.constructor=s};n.prototype=r.prototype;s.prototype=new n;if(t)i.extend(s.prototype,t);s.__super__=r.prototype;return s};p.extend=g.extend=$.extend=w.extend=N.extend=U;var M=function(){throw new Error('A "url" property or function must be specified')};var q=function(t,e){var i=e.error;e.error=function(r){if(i)i(t,r,e);t.trigger("error",t,r,e)}};return e});

(function ($) {

define('models',['backbone'], function(Backbone) {

Upfront.Events = _.isEmpty(Upfront.Events) ? _.extend(Upfront.Events, Backbone.Events) : Upfront.Events;
var _alpha = "alpha",

/* ----- Logic mixins ----- */

	_Upfront_ModelMixin = {

	},

/* ----- Core model definitions ----- */

	// Basic behavior/appearance dataset building block
	Property = Backbone.Model.extend({
		"defaults": {
			"name": "",
			"value": ""
		},
		idAttribute: 'name'
	}),

	// Basic behavior/appearance dataset
	Properties = Backbone.Collection.extend({
		"model": Property
	}),

	// Basic interface dataset container
	ObjectModel = Backbone.Model.extend({
		"defaults": {
			"name": "",
			"element_id": "",
			"properties":  new Properties()
		},
		initialize: function () {
			var args = arguments;
			if (args && args[0] && args[0]["properties"]) {
				args[0]["properties"] = args[0]["properties"] instanceof Properties
					? args[0]["properties"]
					: new Properties(args[0]["properties"])
				;
				this.set("properties", args[0].properties);
			} else this.set("properties", new Properties([]));
			if (this.init) this.init();

			// Take care of old preset API
			if (this.get_property_value_by_name('currentpreset')) {
			// Unset currentpreset property and set preset to correct value
				this.set_property('preset', this.get_property_value_by_name('currentpreset'), true);
				this.set_property('currentpreset', false, true);
			}
		},
	// ----- Object interface ----- */
		get_view_class: function () {
			return Upfront.Views.ObjectView;
		},
		get_property_by_name: function (name) {
			var prop = this.get("properties").where({"name": name});
			return prop.length ? prop[0] : false;
		},
		get_property_value_by_name: function (name) {
			var prop = this.get_property_by_name(name);
			return prop && prop.get ? prop.get("value") : false;
		},
		has_property: function (name) {
			return !!this.get_property_value_by_name(name);
		},
		has_property_value: function (property, value) {
			return (value == this.get_property_value_by_name(property));
		},

		/**
		 * Resolve the preset value from wherever we might be having it stored
		 *
		 * Resolves the preset and, as a side-effect, sets the `preset` property
		 * to the resolved value.
		 * This way the `preset` property is now more of a transient, contextyally
		 * dependent value - not fixed and given once by the mighty hand of god.
		 *
		 *  The value is resolved by first checking the passed breakpoint ID
		 *  (which will default to currently active one) and, if that fails,
		 *  will default to whatever the `preset` property says it should be.
		 *  Failing all of that, it'll fall back to "default"
		 *
		 * @param {String} breakpoint_id Breakpoint ID used to resolve the preset from storage
		 * *                               - will default to current one
		 *
		 * @return {String} Decoded preset ID
		 */
		decode_preset: function (breakpoint_id) {
			breakpoint_id = breakpoint_id || (Upfront.Views.breakpoints_storage.get_breakpoints().get_active() || {}).id;
			var current = this.get_property_value_by_name('preset') || 'default',
				model = this.get_property_value_by_name("breakpoint_presets") || {},
				breakpoint_preset = (model[breakpoint_id] || {}).preset,
				actual = breakpoint_preset || current
			;
			this.set_property('preset', actual, false); // Do *not* be silent here, we do want repaint
			return actual;
		},

		/**
		 * Pack up the breakpoint preset values.
		 *
		 * The packed values will be decoded later on using the `decode_preset` method.
		 * As a side-effect, we also update the model `breakpoint_presets` property.
		 * As a side-effect #2, we also set whatever the current preset is (or default) as 
		 * default breakpoint preset, if it's not already set.
		 *
		 * @param {String} preset_id Preset ID to pack
		 * @param {String} breakpoint_id Breakpoint ID used to resolve the preset in storage 
		 *                               - will default to current one
		 *
		 * @return {Object} Packed breakpoint presets
		 */
		encode_preset: function (preset_id, breakpoint_id) {
			breakpoint_id = breakpoint_id || (Upfront.Views.breakpoints_storage.get_breakpoints().get_active() || {}).id;
			var	data = this.get_property_value_by_name("breakpoint_presets") || {};
				current = (this.get_property_by_name('preset').previousAttributes() || {value: 'default'}).value,
				default_bp_id = (Upfront.Views.breakpoints_storage.get_breakpoints().findWhere({'default': true}) || {}).id
			;
			
			data[breakpoint_id] = {preset: preset_id};
			if (!data[default_bp_id]) data[default_bp_id] = {preset: current};

			this.set_property("breakpoint_presets", data, true);

			return data;
		},

		add_property: function (name, value, silent) {
			if (!silent) silent = false;
			this.get("properties").add(new Upfront.Models.Property({"name": name, "value": value}), {"silent": silent});
			Upfront.Events.trigger("model:property:add", name, value, silent);
		},
		set_property: function (name, value, silent) {
			if (!name) return false;
			if (!silent) silent = false;
			var prop = this.get_property_by_name(name);
			if (!prop || !prop.set) return this.add_property(name, value, silent);
			prop.set({"value": value}, {"silent": silent});
			Upfront.Events.trigger("model:property:set", name, value, silent);
		},
		remove_property: function (name, silent) {
			if (!name) return false;
			if (!silent) silent = false;
			var prop = this.get_property_by_name(name);
			if (!prop || !prop.set) return;
			this.get("properties").remove(prop, {"silent": silent});
			Upfront.Events.trigger("model:property:remove", name, silent);
		},
		init_property: function (name, value) {
			if (!this.has_property(name)) this.add_property(name, value);
		},
		init_properties: function (hash) {
			var me = this;
			_(hash).each(function (value, name) {
				me.init_property(name, value);
			});
		},
	// ----- Magic properties manipulation ----- */
		get_content: function () {
			return this.get_property_value_by_name("content");
		},
		set_content: function (content, options) {
			var prop = this.get_property_by_name("content");
			var options = typeof options != 'undefined' ? options: {};
			if (prop) return prop.set("value", content, options);
			return this.get("properties").add(new Upfront.Models.Property({"name": "content", "value": content}));
		},
		get_element_id: function () {
			return this.get_property_value_by_name("element_id");
		},
		get_wrapper_id: function () {
			return this.get_property_value_by_name("wrapper_id");
		},
		replace_class: function (value) {
			var prop = this.get_property_by_name("class"),
				old = prop ? prop.get("value") : false
			;
			if (prop && old){
				 // Have class
				var values = value.split(" "),
					new_val = old;
				for ( var i = 0; i < values.length; i++ ){
					var val_esc = values[i].replace(/-?\d+/, '-?\\d+'),
						val_rx = new RegExp(val_esc);
					if ( new_val.match(val_rx) )
						new_val = new_val.replace(val_rx, values[i]);
					else
						new_val += " " + values[i];
				}
				return prop.set("value", new_val);
			}
			else if (!prop) this.get("properties").add(new Property({"name": "class", "value": value})); // No class property
			return false;
		},
		add_class: function (value) {
			var val_rx = new RegExp(value),
				prop = this.get_property_by_name("class"),
				old = prop ? prop.get("value") : false;
			if (prop && !old.match(val_rx)) return prop.set("value", old + " " + value);
			else if (!prop) this.get("properties").add(new Property({"name": "class", "value": value}));
			return false;
		},
		remove_class: function (value) {
			var val_rx = new RegExp(value),
				prop = this.get_property_by_name("class"),
				old = prop ? prop.get("value") : false;
			if (prop && old.match(val_rx)) return prop.set("value", old.replace(val_rx, ""));
			return false;
		},
		is_visible: function () {
			return this.get_property_value_by_name("visibility");
		},
		get_breakpoint_property_value: function (property, return_default, default_value) {
			var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint;
			default_value = typeof default_value === "undefined" ? false : default_value;

			if ( !breakpoint || breakpoint.default )
				return this.get_property_value_by_name(property);
			var data = this.get_property_value_by_name('breakpoint');
			if ( _.isObject(data) && _.isObject(data[breakpoint.id]) && property in data[breakpoint.id] )
				return data[breakpoint.id][property];
			if ( return_default )
				return this.get_property_value_by_name(property);
			return default_value;
		},
		set_breakpoint_property: function (property, value, silent) {
			var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint;
			if ( !breakpoint || breakpoint.default ) {
				this.set_property(property, value, silent);
			}
			else {
				var data = Upfront.Util.clone(this.get_property_value_by_name('breakpoint') || {});
				if ( !_.isObject(data[breakpoint.id]) )
					data[breakpoint.id] = {};
				data[breakpoint.id][property] = value;
				data.current_property = property;
				this.set_property('breakpoint', data, silent);
			}
		},
		add_to: function (collection, index, options) {
			var me = this,
				models = [],
				added = false,
				options = _.isObject(options) ? options : {};
			collection.each(function(each, i){
				if ( i == index ){
					models.push(me);
					added = true;
				}
				models.push(each);
			});
			if ( added ){
				collection.reset(models, {silent: true});
				collection.trigger('add', this, collection, _.extend(options, {index: index}));
			}
			else {
				collection.add(this, _.extend(options, {index: index}));
			}
		}
	}),

		// Basic interface dataset
	Objects = Backbone.Collection.extend({
		/*"model": ObjectModel,
		initialize: function (raw_models) {
			var models = [];
			if (!raw_models || !raw_models.length) return false;
			_(raw_models).each(function (model) {
				var type_prop = model["properties"] ? _(model["properties"]).where({"name": "type"}) : model.get("properties").where({"name": "type"}),
					type = type_prop.length ? type_prop[0].value : "ObjectModel",
					instance = Upfront.Models[type] ? new Upfront.Models[type](model) : false
				;
				if (Upfront.Models[type] && instance) models.push(instance);
			});
			this.reset(models);
		},*/
		model: function (attrs, options) {
			var type_prop = attrs["properties"] ? _(attrs["properties"]).where({"name": "type"}) : attrs.get("properties").where({"name": "type"}),
				type = type_prop.length ? type_prop[0].value : '';
			if (Upfront.Models[type]) return new Upfront.Models[type](attrs, options);
			return new ObjectModel(attrs, options);
		},
		get_by_element_id: function (element_id) {
			var found = false;
			this.each(function (model) {
				if (model.get_element_id() == element_id) found = model;
			});
			return found;
		}
	}),

	// Module interface dataset container
	Module = ObjectModel.extend({
		"defaults": {
			"name": "",
			"objects": new Objects(),
			"properties": new Properties()
		},
		initialize: function () {
			var args = arguments;
			if (args && args[0] && args[0]["objects"]) {
				args[0]["objects"] = args[0]["objects"] instanceof Objects
					? args[0]["objects"]
					: new Objects(args[0]["objects"])
				;
				this.set("objects", args[0].objects);
			} else this.set("objects", new Objects([]));
			if (args && args[0] && args[0]["properties"]) {
				args[0]["properties"] = args[0]["properties"] instanceof Properties
					? args[0]["properties"]
					: new Properties(args[0]["properties"])
				;
				this.set("properties", args[0]["properties"]);
			} else this.set("properties", new Properties([]));
			if (this.init) this.init();
		}
	}),

	ModuleGroup = ObjectModel.extend({
		"defaults": function(){
			return {
				"name": "",
				"modules": new Modules(),
				"wrappers": new Wrappers(),
				"properties": new Properties()
			};
		},
		initialize: function () {
			var args = arguments;
			if (args && args[0] && args[0]["modules"]) {
				args[0]["modules"] = args[0]["modules"] instanceof Modules
					? args[0]["modules"]
					: new Modules(args[0]["modules"])
				;
				this.set("modules", args[0]["modules"]);
			} else this.set("modules", new Modules([]));
			if (args && args[0] && args[0]["wrappers"]) {
				args[0]["wrappers"] = args[0]["wrappers"] instanceof Wrappers
					? args[0]["wrappers"]
					: new Wrappers(args[0]["wrappers"])
				;
				this.set("wrappers", args[0].wrappers)
			} else this.set("wrappers", new Wrappers([]));
			if (args && args[0] && args[0]["properties"]) {
				args[0]["properties"] = args[0]["properties"] instanceof Properties
					? args[0]["properties"]
					: new Properties(args[0]["properties"])
				;
				this.set("properties", args[0]["properties"]);
			} else this.set("properties", new Properties([]));

			this.init_property('has_settings', 1);
			this.init_property('type', 'ModuleGroup');
			if (this.init) this.init();
		}
	}),

	Modules = Backbone.Collection.extend({
		/*
		"model": Module,
		initialize: function () {
			if (!arguments.length) return false;
			var _modules = [],
				me = this,
				args = arguments[0]
			;
			_(args).each(function (arg) {
				var self_class = _(arg.properties).where({"name": "type"}),
					self_instance =  (self_class.length && self_class[0].value && Upfront.Models[self_class[0].value])
						? new Upfront.Models[self_class[0].value](arg)
						: new Upfront.Models.Module(arg)
				;
				me.add(self_instance);
				//_modules.push(self_instance);
			});
			//this.reset(_modules);
			//console.log(this);
		},
		*/

		model: function (attrs, options) {
			if ( attrs.modules )
				return new ModuleGroup(attrs, options);
			return new Module(attrs, options);
		},

		get_by_element_id: function (element_id) {
			var found = false;
			this.each(function (model) {
				if (model.get_element_id() == element_id) found = model;
			});
			return found;
		}
	}),

	Region = ObjectModel.extend({
		defaults: function(){
			return {
				"name": "",
				"properties": new Properties(),
				"wrappers": new Wrappers(),
				"modules": new Modules()
			};
		},
		initialize: function () {
			var args = arguments;
			if (args && args[0] && args[0]["modules"]) {
				args[0]["modules"] = args[0]["modules"] instanceof Modules
					? args[0]["modules"]
					: new Modules(args[0]["modules"])
				;
				this.set("modules", args[0].modules)
			} else this.set("modules", new Modules([]));
			if (args && args[0] && args[0]["wrappers"]) {
				args[0]["wrappers"] = args[0]["wrappers"] instanceof Wrappers
					? args[0]["wrappers"]
					: new Wrappers(args[0]["wrappers"])
				;
				this.set("wrappers", args[0].wrappers)
			} else this.set("wrappers", new Wrappers([]));
			if (args && args[0] && args[0]["properties"]) {
				args[0]["properties"] = args[0]["properties"] instanceof Properties
					? args[0]["properties"]
					: new Properties(args[0]["properties"])
				;
				this.set("properties", args[0].properties);
			} else this.set("properties", new Properties([]));
		},
		is_main: function () {
			var container = this.get('container'),
				name = this.get('name');
			return ( !container || container == name );
		},
		get_sub_regions: function () {
			if ( ! this.collection )
				return false;
			var collection = this.collection,
				index = collection.indexOf(this),
				total = collection.size()-1, // total minus shadow region
				container = this.get('container') || this.get('name'),
				ref_models = collection.filter(function(model){ return model.get('container') == container || model.get('name') == container; }),
				ref_models2 = [],
				ret = {
					fixed: [],
					lightbox: [],
					top: false,
					left: false,
					right: false,
					bottom: false
				};
			if ( ref_models.length > 1 ){
				_.each(ref_models, function(model, index){
					var sub = model.get('sub');
					if ( sub == 'fixed' )
						ret.fixed.push(model);
					else if ( sub == 'lightbox' )
						ret.lightbox.push(model);
					else if ( sub && sub.match(/^(top|left|bottom|right)$/) )
						ret[sub] = model;
					else
						ref_models2.push(model);
				});
			}
			if ( ref_models2.length > 1 ){
				var index = _.indexOf(ref_models2, this);
				if ( index == 0 )
					ret.right = ref_models2[1];
				else if ( index == 1 ){
					ret.left = ref_models2[0];
					ret.right = ref_models2.length > 2 ? ref_models2[2] : false;
				}
			}
			return ret;
		},
		get_sub_region: function (sub) {
			return this.get_sub_regions()[sub];
		},
		has_sub_region: function () {
			return _.find( this.get_sub_regions(), function(each){ return ( each !== false ); } );
		},
		get_side_region: function (right) {
			return this.get_sub_region( right ? 'right' : 'left' );
		},
		has_side_region: function () {
			var sub = this.get_sub_regions();
			return ( sub.left || sub.right );
		}
	}),

	Regions = Backbone.Collection.extend({
		"model": Region,

		get_by_name: function (name) {
			var found = false,
				name = name.toLowerCase();
			this.each(function (model) {
				if (model.get("name").toLowerCase() == name) found = model;
			});
			return found;
		},

		at_container: function (index) {
			var i = 0;
			return this.find(function(m){
				if ( m.is_main() ){
					if ( i == index )
						return true;
					else
						i++;
				}
				return false;
			});
		},

		index_container: function (model, excludes) {
			var excludes = _.isArray(excludes) ? excludes : [excludes],
				collection = this.filter(function(m){
					return m.is_main() && ! _.contains(excludes, m.get('name'));
				}),
				index = collection.indexOf(model);
			return index;
		},

		total_container: function (excludes) {
			var excludes = _.isArray(excludes) ? excludes : [excludes],
				collection = this.filter(function(m){
					return m.is_main() && ! _.contains(excludes, m.get('name'));
				});
			return collection.length;
		},

		get_new_title: function (prefix, start) {
			var title = (prefix + start).replace(/[^A-Za-z0-9\s_-]/g, ''),
				name = title.toLowerCase().replace(/\s/g, '-');
			if ( this.get_by_name(name) )
				return this.get_new_title(prefix, start+1);
			return {
				title: title,
				name: name
			};
		}
	}),

	Wrapper = ObjectModel.extend({
		"defaults": {
			"name": "",
			"properties": new Properties()
		},
		initialize: function () {
			var args = arguments;
			if (args && args[0] && args[0]["properties"]) {
				args[0]["properties"] = args[0]["properties"] instanceof Properties
					? args[0]["properties"]
					: new Properties(args[0]["properties"])
				;
				this.set("properties", args[0].properties)
			} else this.set("properties", new Properties([]));
		},
	}),

	Wrappers = Backbone.Collection.extend({
		"model": Wrapper,

		get_by_wrapper_id: function (wrapper_id) {
			var found = false;
			this.each(function (model) {
				if (model.get_wrapper_id() == wrapper_id) found = model;
			});
			return found;
		}
	}),


	Layout = ObjectModel.extend({
		"defaults": {
			"name": "",
			"properties": new Properties(),
			"regions": new Regions(),
			"wrappers": new Wrappers()
		},
		initialize: function () {
			var typography;
			var args = arguments;
			if (args && args[0] && args[0]["regions"]) {
				args[0]["regions"] = args[0]["regions"] instanceof Regions
					? args[0]["regions"]
					: new Regions(args[0]["regions"])
				;
				this.set("regions", args[0].regions)
			}
			if (args && args[0] && args[0]["properties"]) {
				args[0]["properties"] = args[0]["properties"] instanceof Properties
					? args[0]["properties"]
					: new Properties(args[0]["properties"])
				;
				this.set("properties", args[0].properties)
			}
			if (args && args[0] && args[0]["wrappers"]) {
				args[0]["wrappers"] = args[0]["wrappers"] instanceof Wrappers
					? args[0]["wrappers"]
					: new Wrappers(args[0]["wrappers"])
				;
				this.set("wrappers", args[0].wrappers)
			}
		},
		get_current_state: function () {
			return Upfront.PreviewUpdate.get_revision();
		},
		has_undo_states: function () {
			return !!Upfront.Util.Transient.length("undo");
		},
		has_redo_states: function () {
			return !!Upfront.Util.Transient.length("redo");
		},
		store_undo_state: function () {
			var state = this.get_current_state(),
				all = Upfront.Util.Transient.get_all()
			;
			if (all.indexOf(state) >= 0) return false;

			Upfront.Util.Transient.push("undo", state);

			Upfront.Events.trigger("upfront:undo:state_stored");
		},
		restore_undo_state: function () {
			if (!this.has_undo_states()) return false;
			return this.restore_state_from_stack("undo");
		},
		restore_redo_state: function () {
			if (!this.has_redo_states()) return false;
			return this.restore_state_from_stack("redo");
		},
		restore_state_from_stack: function (stack) {
			var other = ("undo" == stack ? "redo" : "undo"),
				revision = Upfront.Util.Transient.pop(stack)
			;
			if (!revision) {
				Upfront.Util.log("Invalid " + revision + " state");
				return false;
			}
			Upfront.Util.Transient.push(other, this.get_current_state());
			// ... 1. get the state that corresponds to this revision
			var me = this,
				dfr = new $.Deferred()
			;
			Upfront.Util.post({
				action: 'upfront_get_revision',
				revision: revision
			}).done(function (response) {
				if ("revision" in response.data) {
					// ... 2. do this:
					me.get("regions").reset(Upfront.Util.model_to_json(response.data.revision.regions));
					dfr.resolve();
				}
			});

			return dfr.promise();
		}
	}),

	Taxonomy = Backbone.Model.extend({
		initialize: function () {
			var args = arguments,
				data = args[0] || {}
			;
			this.taxonomy = data.taxonomy ? new Backbone.Model(data.taxonomy) : Backbone.Model({});
			this.all_terms = data.all_terms ? new Backbone.Collection(data.all_terms) : new Backbone.Collection([]);
			this.post_terms = data.post_terms ? new Backbone.Collection(data.post_terms) : new Backbone.Collection([]);

		}
	}),

	/**
	 * Represents a WP object. Extending WPModel it is easy to communicate with the server
	 * to fetch a Post, User or Comment, and let the user update them easily.
	 */
	WPModel = Backbone.Model.extend({
		action: 'upfront-wp-model',
		fetchAttributes: [],
		saveAttributes: [],

		/**
		 * Loads the model from the db data. Uses the attribute modelName, implemented in a children class, to
		 * know what to fecth. When finished it trigger the change event if there have been any change in the Model.
		 * @param  {Object} data Aditional data to be sent with the fetch request.
		 * @return {jQuery.Deferred}	A promise for the fetching. The server response will be passed as argument to the done function.
		 */
		fetch: function(data) {
			var me = this;
				postdata = {
					action: 'fetch_' + this.modelName,
					id: this.id
				}
			;

			_.each(this.fetchAttributes, function(attr){
				postdata[attr] = me[attr];
			});

			postdata = _.extend(postdata, data);

			return this.post(postdata)
				.done(function(response){
					me.set(response.data);
				}
			);
		},

		/**
		 * Update, or create if no model id given, the model in the database.
		 * Uses the attribute modelName, implemented in a children class, to
		 * know what to save.
		 * @return {jQuery.Deferred}	A promise for the saving. The server response will be passed as argument to the done function.
		 */
		save: function(){
			var me = this,
				data = this.toJSON()
			;

			_.each(this.saveAttributes, function(attr){
				data[attr] = me[attr];
			});

			data.action = 'save_' + this.modelName;
			return this.post(data)
				.done(function(response){
					me.changed = {};
				}
			);
		},

		/**
		 * Send a POST request to the server setting all the parameters needed to communicate with
		 * the models endpoint.
		 * @param  {Object} data Data to be sent with the request.
		 * @return {jQuery.Deferred}	A promise for the response. The server response will be passed as argument to the done function.
		 */
		post: function(data){
			data = _.isObject(data) ? _.clone(data) : {};
			data.model_action = data.action;
			data.action = this.action;

			return Upfront.Util.post(data);
		},
		/**
		 * Overrides Backbone.Model.get to convert the PHP dates in javascript ones.
		 * @param  {String} attr The attribute name to get.
		 * @return {Mixed}      The attribute value or false if not found.
		 */
		get: function(attr){
			var value = this.attributes[attr],
                dates = [
                    "post_date",
                    "post_date_gmt",
                    'post_modified',
                    "post_modified_gmt"
                ];
//			if(_.isString(value) && value.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/)) {
//				return new Date(Date.parse(value.replace(/ /, 'T')));
//			}

            if( _.indexOf(dates, attr) !== -1 ){
                //return new Date( value  ); // <-- Breaks in FF
                var raw_offset = (new Date()).getTimezoneOffset(), 
                	tz_offset = raw_offset / 60,
                	offset = tz_offset > 0 ? '-' : '+', // Reversed because Date.getTimezoneOffset() returns reversed values...
                	hours = parseInt(Math.abs(tz_offset), 10),
                	mins = parseInt((Math.abs(tz_offset) - hours) * 60, 10),
                	timestamp = value.replace(/ /, 'T')
                ;
                hours = hours >= 10 ? '' + hours : '0' + hours;
                mins = mins >= 10 ? '' + mins : '0' + mins;
                if (timestamp && hours.length && mins.length) timestamp += offset + hours + mins;

                return new Date(Date.parse(timestamp)); // <-- We need this to instantiate Date object in Firefox. @See "batman bug" in Asana.
            }
			return this.attributes[attr];
		},
		/**
		 * Overrides Backbone.Model.set to convert javascript dates in PHP format.
		 * @param  {String} key     Attribute name
		 * @param  {Mixed} val     The value for the attribute
		 * @param  {Object} options Extended options for set. See http://backbonejs.org/#Model-set
		 * @return {WPModel}         This object
		 */
		set: function(key, val, options){
			var newval = val,
				parsedAttrs = {};

			if(_.isObject(key)){
				for(var attr in key){
					var value = key[attr];
					if(val instanceof Date)
						parsedAttrs[attr] = Upfront.Util.format_date(value, true, true).replace(/\//g, '-');
					else
						parsedAttrs[attr] = value;
				}
				Backbone.Model.prototype.set.call(this, parsedAttrs, options);
			}
			else{
				if(val instanceof Date)
					newval = Upfront.Util.format_date(val, true, true).replace(/\//g, '-');

				Backbone.Model.prototype.set.call(this, key, newval, options);
			}

			return this;
		}
	}),


	/**
	 * Represent a collection of WPModels, to fetch and save Posts, Comments or metadata list.
	 * It handle pagination, sorting and hierarchical lists out of the box.
	 */
	WPCollection = Backbone.Collection.extend({
		//WP ajax action
		action: 'upfront-wp-model',
		// Collection's attributes to be sent with their values in every fetch request.
		fetchAttributes: [],
		// Collection's attributes to be sent with their values in every save request.
		saveAttributes: [],

		// These are used to know what has changed since the last save.
		changedModels: [],
		addedModels: [],
		removedModels: [],
		isNew: true,

		// Model attribute where the parent id is stored.
		parentAttribute: false,
		// Attribute to store the collection of children.
		childrenAttribute: false,

		// Used to store the store the models without parents. (Only when parentAttribute and childrenAttribute are set)
		orphans: {},

		// Attribute to sort the collection. Use the reSort methods to change it properly.
		orderby: false,
		order: 'desc',

		// Pagination default parameters. Set pageSize to -1 to deactivate pagination.
		pagination: {
			pages: 1,
			pageSize: 10,
			currentPage:1,
			totalElements: 0,
			loaded: {}
		},

		// Used to keep the last fetch options and be able to fetch more pages.
		lastFetchOptions: {},

		/**
		 * Loads the Collection with models from the database. Uses the collectionName attribute to know what to fetch.
		 * @param  {Object} data Extra data to be sent with the fetch request
		 * @return {jQuery.Deferred}      Promise for the fetch request. The server response will be passed as argument to the done function.
		 */
		fetch: function(data) {
			var me = this,
				postdata = {
					action: 'fetch_' + this.collectionName,
					id: this.id
				}
			;

			if(this.orderby){
				postdata['orderby'] = this.orderby;
				postdata['order'] = this.order;
			}

			_.each(this.fetchAttributes, function(attr){
				postdata[attr] = me[attr];
			});

			postdata = this.checkPostFlush(_.extend(postdata, data));




			// Set change observers here, so we leave the initialize method
			// easily overridable.
			this.changedModels = [];
			this.addedModels = [];
			this.removedModels = [];
			this.off('change', this.updateChanged, this);
			this.on('change', this.updateChanged, this);
			this.off('add', this.updateAdded, this);
			this.on('add', this.updateAdded, this);
			this.off('remove', this.updateRemoved, this);
			this.on('remove', this.updateRemoved, this);

			this.isNew = false;

			return this.post(postdata)
				.done(function(response){
					if(response.data.pagination){
						var pagination = response.data.pagination,
							models = [];
						if(postdata.flush || me.pagination.totalElements != pagination.total){
							me.pagination = {
								totalElements: pagination.total,
								pageSize: pagination.page_size,
								pages: Math.ceil(pagination.total / pagination.page_size),
								currentPage: pagination.page,
								loaded: postdata.flush ? {} : me.pagination.loaded
							}
							me.pagination.loaded[pagination.page] = true;
							_.each(response.data.results, function(modelData){
								var model = new me.model(modelData);
								model.belongsToPage = pagination.page;
								models.push(model);
							});
							me.reset(models);
						}
						else {
							me.pagination.currentPage = pagination.page;
							me.pagination.loaded[pagination.page] = true;
							_.each(response.data.results, function(modelData){
								var model = new me.model(modelData);
								model.belongsToPage = pagination.page;
								me.add(model, {silent: true, merge: true});
							});
							me.trigger('reset', me);
						}
					}
					else
						me.reset(response.data.results);
				}
			);
		},

		/**
		 * Send a POST request to the server setting all the parameters needed to communicate with
		 * the models endpoint.
		 * @param  {Object} data Data to be sent with the request.
		 * @return {jQuery.Deferred}	A promise for the response. The server response will be passed as argument to the done function.
		 */
		post: function(data){
			data = _.isObject(data) ? _.clone(data) : {};
			data.model_action = data.action;
			data.action = this.action;

			return Upfront.Util.post(data);
		},

		/**
		 * Store the data base. Different lists are sent to the server with all, added, changed and removed models
		 * for making easy to store the changes.
		 * @return {jQuery.Deferred} A promise for the response. The server response will be passed as argument to the done function.
		 */
		save: function(){
			var me = this,
				data = {
					all: this.toJSON(),
					added: [],
					changed: [],
					removed: [],
					action: 'save_' + this.collectionName
				}
			;
			if(this.isNew){
				data.added = data.all;
			}
			else{
				this.each(function(model){
					if(me.addedModels.indexOf(model.id) != -1)
						data.added.push(model.toJSON());

					if(me.changedModels.indexOf(model.id) != -1)
						data.changed.push(model.toJSON());

					if(me.removedModels.indexOf(model.id) != -1)
						data.removed.push(model.toJSON());
				});
			}

			this.isNew = false;

			_.each(this.saveAttributes, function(attr){
				data[attr] = me[attr];
			});

			return this.post(data)
				.done(function(response){
					me.reset(response.data);
					me.addedModels = [];
					me.changedModels = [];
					me.removedModels = [];
				});
		},
		/**
		 * Used to synchro the changed model list.
		 * @param  {WPModel} model The model to add to the changed list.
		 * @return {null}
		 */
		updateChanged: function(model){
			var id = model.id,
				addedIndex = _.indexOf(this.addedModels, id)
			;
			if(addedIndex != -1)
				this.addedModels[addedIndex] = id;

			else if(!_.contains(this.changedModels, id))
				this.changedModels.push(id);
		},

		/**
		 * Used to synchro the added model list.
		 * @param  {WPModel} model The model to add to the added list.
		 * @return {null}
		 */
		updateAdded: function(model){
			var id = model.id,
				removedIndex = _.indexOf(this.removedModels, id)
			;
			if(removedIndex != -1){
				this.removedModels.splice(removedIndex, 1);
				this.changedModels.push(id);
			}
			else if(!_.contains(this.addedModels, id))
				this.addedModels.push(id);
		},

		/**
		 * Used to synchro the removed model list.
		 * @param  {WPModel} model The model to add to the removed list.
		 * @return {null}
		 */
		updateRemoved: function(model){
			var id = model.id,
				addedIndex = _.indexOf(this.addedModels, id),
				changedIndex = _.indexOf(this.changedModels, id)
			;
			if(addedIndex != -1)
				this.addedModels.splice(addedIndex, 1);
			else if(!_.contains(this.removedModels, id))
				this.removedModels.push(id);

			if(changedIndex != -1)
				this.changedModels.splice(changedIndex, 1);
		},

		/**
		 * Override the Backbone.Collection function to handle hierarchical data when the
		 * parentAttribute and childrenAttribute are set for the collection.
		 * @param  {Array} models  Array of data for the new models
		 * @param  {Object} options Options for the adding. See http://backbonejs.org/#Collection-add
		 */
		add: function(models, options){
			//Check for hierarchy
			if(!this.parentAttribute || !this.childrenAttribute)
				return Backbone.Collection.prototype.add.call(this, models, options);

			var me = this;
			if(_.isArray(models)){
				_.each(models, function(model){
					me.add(model, options);
				});
			}
			else {
				var parent_id = 0,
					model = models;
				if(this.model && model instanceof this.model){
					parent_id = model.get(this.parentAttribute);
				}
				else if(_.isObject(model)){
					parent_id = model[this.parentAttribute];
					if(this.model)
						model = new this.model(models);
				}
				else
					return Backbone.Collection.prototype.add.call(this, model, options);

				// We got the model to add
				// Add the children
				if(this.orphans[model.id]){
					if(!model[this.childrenAttribute])
						model[this.childrenAttribute] = new this.constructor(this.orphans[model.id], options);
					else
						model[this.childrenAttribute].add(this.orphans[model.id], options);
					delete this.orphans[model.id];
				}
				else if(!model[this.childrenAttribute])
					model[this.childrenAttribute] = new this.constructor([], options);



				if(parent_id){
					// Is it a child?
					var parent = this.get(parent_id);
					if(parent){
						parent[this.childrenAttribute].add(model, options);
					}
					else{ //An orphan
						var parentOrphans = this.orphans[parent_id];
						if(parentOrphans)
							parentOrphans.push(model);
						else
							this.orphans[parent_id] = [model];
					}
				}
				// Add the model to the collection
				return Backbone.Collection.prototype.add.call(this, model, options);
			}
		},

		/**
		 * Overrides Backbone.Collection.remove to handle hierarchical data when the
		 * parentAttribute and childrenAttribute are set for the collection.
		 *
		 * @param  {Array|Model} models  Models to remove.
		 * @param  {Object} options Options for removing elements. See http://backbonejs.org/#Collection-remove
		 * @return {WPCollection}        this
		 */
		remove: function(models, options){
			//Check for hierarchy
			if(!this.parentAttribute || !this.childrenAttribute)
				return Backbone.Collection.prototype.remove.call(this, models, options);

			var me = this;

			models = _.isArray(models) ? models.slice() : [models];

			// Delete the children
			for (i = 0, l = models.length; i < l; i++) {
				var model = this.get(models[i]);
				if(model){
					model[this.childrenAttribute].each(function(child){
						me.remove(child, options);
					});
				}
			}
			return Backbone.Collection.prototype.remove.call(this, models, options);
		},
		/**
		 * Get a page from the collection using the pagination parameters. The model must be fetched before
		 * using this function. A page is known to be loaded checking the WPCollection.pagination.loaded[pageNumber]
		 * attribute.
		 *
		 * @param  {Number} pageNumber The page number
		 * @return {Array}            Models that belongs to the requested paged
		 */
		getPage: function(pageNumber){
			var me = this;

			return this.filter(function(model){
				return model.belongsToPage == pageNumber;
			});
		},

		/**
		 * Load the models of the given page from the database.
		 * @param  {Number} pageNumber The number of the page to fetch.
		 * @return {jQuery.Deferred} A promise for the fetching. The server response will be passed as arguments for the done function.
		 */
		fetchPage: function(pageNumber, options){
			if(!options)
				options = {};

			if(!options.flush && this.pagination.loaded[pageNumber]){
				this.pagination.currentPage = pageNumber;
				/*
				//All elements loaded, return them following the current order (sorting without fetch)
				if(this.pagination.totalElements == this.length){
					var start = this.pagination.currentPage * this.pagination.pageSize,
						end = start + this.pagination.pageSize
						results = []
					;

					this.each(function(result, idx){
						if(idx >= start && idx < end)
							results.push(result);
					});

					return jQuery.Deferred().resolve({results: results});
				}
				*/

				var models = this.getPage(pageNumber),
					results = [];
				_.each(models, function(model){
					results.push(model.toJSON());
				});
				this.pagination.currentPage = pageNumber;
				return jQuery.Deferred().resolve({results: results});
			}



			return this.fetch(_.extend({page: pageNumber, limit: this.pagination.pageSize}, options));
		},

		/**
		 * Re-Sort the collection based on the model attribute. This always flush the collection elements.
		 * @param  {String} attribute Model attribute for using to sort.
		 * @param  {String} asc       asc|desc Order of the sorting.
		 * @return {[type]}           [description]
		 */
		reSort: function(attribute, asc){
			var direction = asc == 'asc' ? 'asc' : 'desc';

			this.orderby = attribute;
			this.order = direction;

			return this.fetch({page: 0, sort: attribute, direction: direction});


			/* // Possible changes to not reload when fetched all elements
			if(this.pagination.totalElements > this.length)
				return this.fetch({page: 0, sort: attribute, direction: direction});

			this.comparator = function(a, b){
				var factor = asc ? 1 : -1;
				return a.get(attribute) < b.get(attribute) ? 1 * factor : -1 * factor;
			}

			this.sort();

			return jQuery.Deferred().resolve(this.toJSON());
			*/
		},

		/**
		 * Check if the fetch options must be flushed.
		 */
		checkPostFlush: function(fetchOptions){
			var me = this,
				flush = false,
				newOptions = _.clone(fetchOptions)
			;

			if(fetchOptions.flush){
				delete newOptions.flush;
				this.lastFetchOptions = newOptions;
				return fetchOptions;
			}

			_.each(fetchOptions, function(value, key){
				if(['limit', 'page'].indexOf(key) == -1)
					flush = flush || me.lastFetchOptions[key] != value;
			});


			if(flush){
				me.lastFetchOptions = _.clone(fetchOptions);
				newOptions.flush = true;
			}
			else
				newOptions = _.extend(this.lastFetchOptions, newOptions);

			return newOptions;
		}
	}),

	Post = WPModel.extend({
		modelName: 'post',
		defaults: {
			ID: 0,
			post_author: 0,
			post_date: new Date(),
			post_date_gmt: new Date(),
			post_content: '',
			post_title: '',
			post_excerpt: '',
			post_status: '',
			comment_status: '',
			ping_status: '',
			post_password: '',
			post_name: '',
			to_ping: [], // To do initialize
			pinged: [], // To do initialize
			post_modified: new Date(),
			post_modified_gmt: new Date(),
			post_content_filtered: '',
			post_parent: 0,
			guid: '',
			menu_order: 0,
			post_type: 'post',
			post_mime_type: '',
			comment_count: 0,
			permalink: ''
		},

		saveAttributes: ['sticky'],

		author: false,
		comments: false,
		parent: false,
		terms: false,
		meta: false,

		initialize: function(model, options){
			var me = this;
			if(model){
				if(model['id'])
					this.set(this.idAttribute, model['id']);
				if(model['author'])
					this.author = new Upfront.Models.User(model['author']);

				if(model['meta'])
					this.meta = new Upfront.Collections.MetaList(model['meta'], {objectId: this.id, metaType: 'post'});

			}
		},

		getVisibility: function(){
			if(this.get('post_status') == 'private')
				return 'private';
			if(this.get('post_password'))
				return 'password';
			if(this.sticky)
				return 'sticky';
			return 'public';
		},

		setVisibility: function(visibility){
			this.sticky = 0;
			if(visibility == 'password'){
				this.set('post_status', 'publish');
			} else {
				this.set('post_password', '');
				if(visibility == 'private')
					this.set('post_status', 'private');
				else if(visibility == 'sticky')
					this.sticky = 1;
				else if(visibility == 'public')
					this.set('post_status', 'publish');
			}
		},

		fetch: function(data) {
			var me = this;
			return WPModel.prototype.fetch.call(this, data)
				.done(function(response){
					if(response.data.author)
						me.author = new Upfront.Models.User(response.data.author);
					if(response.data.meta)
						me.meta = new Upfront.Collections.MetaList(response.data.meta, {objectId: me.id, metaType: 'post'});

					me.sticky = response.data.sticky;
				})
			;
		},

		idAttribute: 'ID',

		fetch_comments: function(data){
			var  me = this;
			data = _.isObject(data) ? data : {};

			this.comments = new Upfront.Collections.CommentList([], {postId: this.id});

			return this.comments.fetch();
		},

		fetch_parent: function() {
			if(!this.get('post_parent'))
				return false;

			var me = this,
				data = {
					action: 'fetch_post',
					id: this.get('post_parent')
				}
			;

			return this.post(data)
				.done(function(response){
						me.parent = new Post(response.data);
				});
		},

		fetch_author: function() {
			console.log('Fetch author not yet implemented.');
		},

		fetch_terms: function(type){
			if(!type)
				return false;
			return this.post({
				taxonomy: type,
				post_id: this.get('ID'),
				action: 'get_terms'
			});
		},

		fetch_meta: function(){
			this.meta = new Upfront.Collection.MetaList([], {objectId: this.id, metaType: 'post'});
			return this.meta.fetch();
		}
	}),

	PostList = WPCollection.extend({
		collectionName: 'post_list',
		model: Post,
		parentAttribute: 'post_parent',
		childrenAttribute: 'children',
		postId: false,
		postType: 'post',
		withMeta: false,
		withAuthor: false,
		fetchAttributes: ['postId', 'postType', 'withMeta', 'withAuthor'],
		initialize: function(models, options){
			if(options){
				if(options.postId)
					this.postId = options.postId;
				if(options.postType)
					this.postType = options.postType;
				if(options.withMeta)
					this.withMeta = options.withMeta;
				if(options.withAuthor)
					this.withAuthor = options.withAuthor;
			}
		}
	});

	var Comment = WPModel.extend({
		modelName: 'comment',
		defaults: {
			comment_ID: 0,
			comment_post_id: 0,
			comment_author: '',
			comment_author_email: '',
			comment_author_url: '',
			comment_author_IP: '0.0.0.0',
			comment_date: new Date(),
			comment_date_gmt: new Date(),
			comment_content: '',
			comment_karma: '',
			comment_agent: '',
			comment_type: '',
			comment_approved: '0',
			comment_parent: 0,
			user_id: 0
		},

		idAttribute: 'comment_ID',

		initialize: function(options){
			if(options && options['id'])
				this.set(this.idAttribute, options['id']);
		},

		trash: function(trashed){
			if(trashed)
				this.set('comment_approved', 'trash');
			else if(!trashed && this.get('comment_approved') == 'trash')
				this.set('comment_approved', '0');
			return this;
		},

		spam: function(spammed){
			if(spammed)
				this.set('comment_approved', 'spam');
			else if(!spammed && this.get('comment_approved') == 'spam')
				this.set('comment_approved', '0');
			return this;
		},

		approve: function(approved){
			if(approved)
				this.set('comment_approved', '1');
			else if(!approved && this.get('comment_approved') == '1')
				this.set('comment_approved', '0');
			return this;
		},
		isTrash: function(){
			return this.get('comment_approved') == 'trash';
		},
		isApproved: function(){
			return this.get('comment_approved') == '1';
		},
		isSpam: function(){
			return this.get('comment_approved') == 'spam';
		}
	}),

	CommentList = WPCollection.extend({
		model: Comment,
		collectionName: 'comment_list',
		postId: false,
		fetchAttributes: ['postId', 'commentType'],
		parentAttribute: 'comment_parent',
		childrenAttribute: 'replies',
		commentType: 'comment', // all, comment, trackback, pingback

		initialize: function(models, options){
			if(options.postId)
				this.postId = options.postId;
		},
		save: function(){
			console.error('CommentList save: Use single comment save instead.');
		}

	}),

	Meta = Backbone.Model.extend({
		defaults: {
			meta_key: '',
			meta_value: ''
		},
		idAttribute: 'meta_key'
	}),

	MetaList = WPCollection.extend({
		model: Meta,
		collectionName: 'meta_list',
		metaType: 'post',
		objectId: 0,
		fetchAttributes: ['objectId', 'metaType'],
		saveAttributes: ['objectId', 'metaType'],
		initialize: function(models, options){
			var metaModels = [];
			if(options.objectId)
				this.objectId = options.objectId;
			if(options.metaType)
				this.metaType = options.metaType;
		},
		getValue: function(key){
			var meta = this.get(key);
			if(!meta)
				return undefined;
			return meta.get('meta_value');
		},
		setValue: function(key, value){
			var meta = this.get(key);
			if(!meta){
				meta = new Meta({meta_key: key, meta_value: value});
				this.add(meta);
			}
			else{
				meta.set('meta_value', value);
				this.changedModels.push(meta.id);
			}
			return meta;
		}
	}),

	Term =  WPModel.extend({
		modelName: 'term',
		defaults: {
			term_id: 0,
			name: '',
			slug: '',
			term_group: '',
			term_taxonomy_id: 0,
			taxonomy: '',
			description: '',
			parent: '',
			count: 0
		},
		idAttribute: 'term_id',
		taxonomy: false,
		fetchAttributes: ['taxonomy'],
		saveAttributes: ['taxonomy'],
		initialize: function(model, options){
			if(model && model.taxonomy)
				this.taxonomy = model.taxonomy;
		},
		save: function(data){
			var me = this;
			return WPModel.prototype.save.call(this, data).
				done(function(response){
					me.set('term_id', response.data.term_id);
				})
			;
		}
	}),

	TermList = WPCollection.extend({
		collectionName: 'term_list',
		model: Term,
		taxonomy: false,
		taxonomyObject: false,
		postId: false,
		fetchAttributes: ['taxonomy', 'postId'],
		saveAttributes: ['taxonomy', 'postId'],
		parentAttribute: 'parent',
		childrenAttribute: 'children',
		initialize: function(models, options){
			if(options){
				if(options.taxonomy){
					this.taxonomy = options.taxonomy;
				}

				if(options.postId)
					this.postId = options.postId;
			}
		},
		fetch: function(options){
			var me = this;
			 return WPCollection.prototype.fetch.call(this, options)
				.done(function(response){
					me.taxonomyObject = response.data.taxonomy;
				})
			;
		}
	}),

	User = WPModel.extend({
		modelName: 'user',
		defaults: {
			ID: 0,
			caps: [],
			cap_key: '',
			roles: [],
			allcaps: [],
			data: {}
		},
		idAttribute: 'ID'
	}),


	Posts = Backbone.Model.extend({
		initialize: function () {
			var args = arguments,
				data = args[0] || {}
			;
			this.posts = data.posts ? new Backbone.Collection(data.posts) : new Backbone.Collection([]);
			this.pagination = data.pagination ? new Backbone.Model(data.pagination) : new Backbone.Model([]);
		}
	}),

	Pages = Posts.extend({}),

	Comments = Backbone.Model.extend({
		initialize: function () {
			var args = arguments,
				data = args[0] || {}
			;
			this.comments = data.comments ? new Backbone.Collection(data.comments) : new Backbone.Collection([]);
			this.pagination = data.pagination ? new Backbone.Model(data.pagination) : new Backbone.Model([]);
		}
	}),

		ImageVariant = Backbone.Model.extend({
			defaults : function () {
				return {
					vid   : "",
					label : "Variant Label",
					group : {
						margin_left: 0,
						margin_right: 0,
						col: 24,
						row: 50,
						left: 0,
						float: "none"
					},
					image : {
						order: 0,
						col: 24,
						top: 0,
						left: 0,
						row: 40,
						clear: true
					},
					caption : {
						show: 1,
						order: 1,
						col: 24,
						top: 0,
						left: 0,
						row: 10,
						clear: true
					}
				};
			}
		}),
		ImageVariants = Backbone.Collection.extend({
			model : ImageVariant
		}),
	_omega = 'omega';

	return {
		"Models": {
			"Property": Property,
			"ObjectModel": ObjectModel,
			"Module": Module,
			"ModuleGroup": ModuleGroup,
			"Region": Region,
			"Wrapper": Wrapper,
			"Layout": Layout,
			"Taxonomy": Taxonomy,
			"Post": Post,
			"Posts": Posts,
			"Pages": Pages,
			"Comment": Comment,
			"Comments": Comments,
			"Meta": Meta,
			"Term": Term,
			"User": User,
			"ImageVariant" : ImageVariant
		},
		"Collections": {
			"Properties": Properties,
			"Objects": Objects,
			"Modules": Modules,
			"Regions": Regions,
			"Wrappers": Wrappers,
			"CommentList": CommentList,
			"MetaList": MetaList,
			"PostList": PostList,
			"TermList": TermList,
			"ImageVariants" : ImageVariants
		}
	};
});

})(jQuery);


/**
 * @license RequireJS text 2.0.3 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */
/*jslint regexp: true */
/*global require: false, XMLHttpRequest: false, ActiveXObject: false,
  define: false, window: false, process: false, Packages: false,
  java: false, location: false */

define('text',['module'], function (module) {
    'use strict';

    var text, fs,
        progIds = ['Msxml2.XMLHTTP', 'Microsoft.XMLHTTP', 'Msxml2.XMLHTTP.4.0'],
        xmlRegExp = /^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,
        bodyRegExp = /<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,
        hasLocation = typeof location !== 'undefined' && location.href,
        defaultProtocol = hasLocation && location.protocol && location.protocol.replace(/\:/, ''),
        defaultHostName = hasLocation && location.hostname,
        defaultPort = hasLocation && (location.port || undefined),
        buildMap = [],
        masterConfig = (module.config && module.config()) || {};

    text = {
        version: '2.0.3',

        strip: function (content) {
            //Strips <?xml ...?> declarations so that external SVG and XML
            //documents can be added to a document without worry. Also, if the string
            //is an HTML document, only the part inside the body tag is returned.
            if (content) {
                content = content.replace(xmlRegExp, "");
                var matches = content.match(bodyRegExp);
                if (matches) {
                    content = matches[1];
                }
            } else {
                content = "";
            }
            return content;
        },

        jsEscape: function (content) {
            return content.replace(/(['\\])/g, '\\$1')
                .replace(/[\f]/g, "\\f")
                .replace(/[\b]/g, "\\b")
                .replace(/[\n]/g, "\\n")
                .replace(/[\t]/g, "\\t")
                .replace(/[\r]/g, "\\r")
                .replace(/[\u2028]/g, "\\u2028")
                .replace(/[\u2029]/g, "\\u2029");
        },

        createXhr: masterConfig.createXhr || function () {
            //Would love to dump the ActiveX crap in here. Need IE 6 to die first.
            var xhr, i, progId;
            if (typeof XMLHttpRequest !== "undefined") {
                return new XMLHttpRequest();
            } else if (typeof ActiveXObject !== "undefined") {
                for (i = 0; i < 3; i += 1) {
                    progId = progIds[i];
                    try {
                        xhr = new ActiveXObject(progId);
                    } catch (e) {}

                    if (xhr) {
                        progIds = [progId];  // so faster next time
                        break;
                    }
                }
            }

            return xhr;
        },

        /**
         * Parses a resource name into its component parts. Resource names
         * look like: module/name.ext!strip, where the !strip part is
         * optional.
         * @param {String} name the resource name
         * @returns {Object} with properties "moduleName", "ext" and "strip"
         * where strip is a boolean.
         */
        parseName: function (name) {
            var strip = false, index = name.indexOf("."),
                modName = name.substring(0, index),
                ext = name.substring(index + 1, name.length);

            index = ext.indexOf("!");
            if (index !== -1) {
                //Pull off the strip arg.
                strip = ext.substring(index + 1, ext.length);
                strip = strip === "strip";
                ext = ext.substring(0, index);
            }

            return {
                moduleName: modName,
                ext: ext,
                strip: strip
            };
        },

        xdRegExp: /^((\w+)\:)?\/\/([^\/\\]+)/,

        /**
         * Is an URL on another domain. Only works for browser use, returns
         * false in non-browser environments. Only used to know if an
         * optimized .js version of a text resource should be loaded
         * instead.
         * @param {String} url
         * @returns Boolean
         */
        useXhr: function (url, protocol, hostname, port) {
            var uProtocol, uHostName, uPort,
                match = text.xdRegExp.exec(url);
            if (!match) {
                return true;
            }
            uProtocol = match[2];
            uHostName = match[3];

            uHostName = uHostName.split(':');
            uPort = uHostName[1];
            uHostName = uHostName[0];

            return (!uProtocol || uProtocol === protocol) &&
                   (!uHostName || uHostName.toLowerCase() === hostname.toLowerCase()) &&
                   ((!uPort && !uHostName) || uPort === port);
        },

        finishLoad: function (name, strip, content, onLoad) {
            content = strip ? text.strip(content) : content;
            if (masterConfig.isBuild) {
                buildMap[name] = content;
            }
            onLoad(content);
        },

        load: function (name, req, onLoad, config) {
            //Name has format: some.module.filext!strip
            //The strip part is optional.
            //if strip is present, then that means only get the string contents
            //inside a body tag in an HTML string. For XML/SVG content it means
            //removing the <?xml ...?> declarations so the content can be inserted
            //into the current doc without problems.

            // Do not bother with the work if a build and text will
            // not be inlined.
            if (config.isBuild && !config.inlineText) {
                onLoad();
                return;
            }

            masterConfig.isBuild = config.isBuild;

            var parsed = text.parseName(name),
                nonStripName = parsed.moduleName + '.' + parsed.ext,
                url = req.toUrl(nonStripName),
                useXhr = (masterConfig.useXhr) ||
                         text.useXhr;

            //Load the text. Use XHR if possible and in a browser.
            if (!hasLocation || useXhr(url, defaultProtocol, defaultHostName, defaultPort)) {
                text.get(url, function (content) {
                    text.finishLoad(name, parsed.strip, content, onLoad);
                }, function (err) {
                    if (onLoad.error) {
                        onLoad.error(err);
                    }
                });
            } else {
                //Need to fetch the resource across domains. Assume
                //the resource has been optimized into a JS module. Fetch
                //by the module name + extension, but do not include the
                //!strip part to avoid file system issues.
                req([nonStripName], function (content) {
                    text.finishLoad(parsed.moduleName + '.' + parsed.ext,
                                    parsed.strip, content, onLoad);
                });
            }
        },

        write: function (pluginName, moduleName, write, config) {
            if (buildMap.hasOwnProperty(moduleName)) {
                var content = text.jsEscape(buildMap[moduleName]);
                write.asModule(pluginName + "!" + moduleName,
                               "define(function () { return '" +
                                   content +
                               "';});\n");
            }
        },

        writeFile: function (pluginName, moduleName, req, write, config) {
            var parsed = text.parseName(moduleName),
                nonStripName = parsed.moduleName + '.' + parsed.ext,
                //Use a '.js' file name so that it indicates it is a
                //script that can be loaded across domains.
                fileName = req.toUrl(parsed.moduleName + '.' +
                                     parsed.ext) + '.js';

            //Leverage own load() method to load plugin value, but only
            //write out values that do not have the strip argument,
            //to avoid any potential issues with ! in file names.
            text.load(nonStripName, req, function (value) {
                //Use own write() method to construct full module value.
                //But need to create shell that translates writeFile's
                //write() to the right interface.
                var textWrite = function (contents) {
                    return write(fileName, contents);
                };
                textWrite.asModule = function (moduleName, contents) {
                    return write.asModule(moduleName, fileName, contents);
                };

                text.write(pluginName, nonStripName, textWrite, config);
            }, config);
        }
    };

    if (masterConfig.env === 'node' || (!masterConfig.env &&
            typeof process !== "undefined" &&
            process.versions &&
            !!process.versions.node)) {
        //Using special require.nodeRequire, something added by r.js.
        fs = require.nodeRequire('fs');

        text.get = function (url, callback) {
            var file = fs.readFileSync(url, 'utf8');
            //Remove BOM (Byte Mark Order) from utf8 files if it is there.
            if (file.indexOf('\uFEFF') === 0) {
                file = file.substring(1);
            }
            callback(file);
        };
    } else if (masterConfig.env === 'xhr' || (!masterConfig.env &&
            text.createXhr())) {
        text.get = function (url, callback, errback) {
            var xhr = text.createXhr();
            xhr.open('GET', url, true);

            //Allow overrides specified in config
            if (masterConfig.onXhr) {
                masterConfig.onXhr(xhr, url);
            }

            xhr.onreadystatechange = function (evt) {
                var status, err;
                //Do not explicitly handle errors, those should be
                //visible via console output in the browser.
                if (xhr.readyState === 4) {
                    status = xhr.status;
                    if (status > 399 && status < 600) {
                        //An http 4xx or 5xx error. Signal an error.
                        err = new Error(url + ' HTTP status: ' + status);
                        err.xhr = xhr;
                        errback(err);
                    } else {
                        callback(xhr.responseText);
                    }
                }
            };
            xhr.send(null);
        };
    } else if (masterConfig.env === 'rhino' || (!masterConfig.env &&
            typeof Packages !== 'undefined' && typeof java !== 'undefined')) {
        //Why Java, why is this so awkward?
        text.get = function (url, callback) {
            var stringBuffer, line,
                encoding = "utf-8",
                file = new java.io.File(url),
                lineSeparator = java.lang.System.getProperty("line.separator"),
                input = new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(file), encoding)),
                content = '';
            try {
                stringBuffer = new java.lang.StringBuffer();
                line = input.readLine();

                // Byte Order Mark (BOM) - The Unicode Standard, version 3.0, page 324
                // http://www.unicode.org/faq/utf_bom.html

                // Note that when we use utf-8, the BOM should appear as "EF BB BF", but it doesn't due to this bug in the JDK:
                // http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4508058
                if (line && line.length() && line.charAt(0) === 0xfeff) {
                    // Eat the BOM, since we've already found the encoding on this file,
                    // and we plan to concatenating this buffer with others; the BOM should
                    // only appear at the top of a file.
                    line = line.substring(1);
                }

                stringBuffer.append(line);

                while ((line = input.readLine()) !== null) {
                    stringBuffer.append(lineSeparator);
                    stringBuffer.append(line);
                }
                //Make sure we return a JavaScript string and not a Java string.
                content = String(stringBuffer.toString()); //String
            } finally {
                input.close();
            }
            callback(content);
        };
    }

    return text;
});


define('text!upfront/templates/object.html',[],function () { return '<div class="upfront-editable_entity upfront-object {{properties.class}} {{properties.preset}}" id="{{properties.element_id}}" {[ if (height > 0){ ]}style="min-height: {{height}}px;"{[ } ]}>\r\n\t<b class="upfront-entity_meta upfront-ui">\r\n\t\t<!-- {[ if (parseInt(properties.has_settings, 10)) { ]} <a href="#" class="upfront-icon-button upfront-icon-button-setting upfront-entity-settings_trigger"></a> {[ } ]} -->\r\n        {{extra_buttons}}\r\n\t\t<!--<a href="#" class="upfront-icon-button upfront-icon-button-delete upfront-entity-delete_trigger"></a>-->\r\n\t</b>\r\n\t{[ if (buttons){ ]}\r\n\t<b class="upfront-entity_meta upfront-ui upfront-entity_meta_extra">{{buttons}}</b>\r\n\t{[ } ]}\r\n\t<div class="upfront-object-content upfront-output-{{properties.id_slug}}">\r\n\t\t{{content}}\r\n\t</div>\r\n</div>\r\n';});


define('text!upfront/templates/module.html',[],function () { return '<div class="upfront-editable_entity upfront-module {{parent_group_class}} {{properties.class}}" id="{{properties.element_id}}" style="{[ if (height > 0){ ]}min-height: {{height}}px;{[ } ]} {[ if (hide == 1) { ]}display: none;{[ } ]}" data-row="{{properties.row}}">\r\n\t<b class="upfront-entity_meta upfront-ui">\r\n\t\t{{name}} \r\n\t\t{[ if (parseInt(properties.has_settings, 10)) { ]} <a href="#" class="upfront-icon-button upfront-icon-button-setting upfront-entity-settings_trigger"></a> {[ } ]}\r\n\t\t{[ if (!properties.sticky) { ]} <a href="#" class="upfront-icon-button upfront-icon-button-delete upfront-entity-delete_trigger"></a> {[ } ]}\r\n\t\t<a href="#" class="upfront-icon-button upfront-icon-button-hide upfront-entity-hide_trigger" style="display:none;"></a> \r\n\t</b>\r\n\t<div class="upfront-objects_container"></div>\r\n</div>\r\n<div class="upfront-module-hidden-toggle upfront-ui" style="display:none;"><a class="upfront-entity-hide_trigger">{{Upfront.Settings.l10n.global.views.show_element}}</a></div>\r\n';});


define('text!upfront/templates/module_group.html',[],function () { return '<b class="upfront-entity_meta upfront-ui">\r\n\t<!--<a href="#" class="upfront-icon-button upfront-icon-button-setting upfront-entity-settings_trigger"></a>-->\r\n\t<a href="#" class="upfront-icon-button upfront-icon-button-hide upfront-entity-hide_trigger" style="display:none;"></a>\r\n</b>\r\n<div class="upfront-selected-border"></div>\r\n<div class="upfront-module-group-toggle-container upfront-module-group-toggle-edit-container">\r\n\t<div class="upfront-module-group-toggle upfront-module-group-ungroup">{{Upfront.Settings.l10n.global.views.ungroup}}</div><br />\r\n\t<div class="upfront-module-group-toggle upfront-module-group-edit">{{Upfront.Settings.l10n.global.views.edit_elements}}</div>\r\n</div>\r\n<div class="upfront-module-group-toggle-container upfront-module-group-toggle-reorder-container">\r\n\t<div class="upfront-module-group-toggle upfront-module-group-reorder">{{Upfront.Settings.l10n.global.views.reorder}}</div>\r\n</div>\r\n<div class="upfront-module-group-finish-edit upfront-ui"><i class="upfront-field-icon upfront-field-icon-tick"></i> {{Upfront.Settings.l10n.global.views.done}}</div>\r\n\r\n<div class="upfront-module-hidden-toggle upfront-ui" style="display:none;"><a class="upfront-entity-hide_trigger">{{Upfront.Settings.l10n.global.views.show_group}}</a></div>\r\n\r\n<div class="upfront-module-group-bg"></div>\r\n<div class="upfront-modules_container"></div>\r\n';});


define('text!upfront/templates/region_container.html',[],function () { return '<div class="upfront-region-container-bg">\r\n\t<div class="upfront-grid-layout {{size_class}}{{max_col}}">\r\n\t\t<div class="upfront-grid-layout-gutter">\r\n\t\t\t<div class="upfront-grid-layout-gutter-left"></div>\r\n\t\t\t<div class="upfront-grid-layout-gutter-right"></div>\r\n\t\t</div>\r\n\t</div>\r\n</div>';});


define('text!upfront/templates/region.html',[],function () { return '<b class="upfront-entity_meta upfront-ui">\r\n\t<a href="#" class="upfront-icon-button upfront-icon-button-delete upfront-entity-delete_trigger"></a>\r\n\t<a href="#" class="upfront-icon-button upfront-icon-button-hide upfront-entity-hide_trigger" style="display:none;"></a> \r\n\t<a href="#" class="upfront-icon-button upfront-icon-button-setting upfront-entity-settings_trigger"></a>\r\n</b>\r\n<div class="upfront-region-title">{{title}}</div>\r\n<div class="upfront-region-wrapper"><div class="upfront-modules_container"></div></div>\r\n<div class="upfront-region-hidden-toggle upfront-ui" style="display:none;"><a class="upfront-entity-hide_trigger">{{Upfront.Settings.l10n.global.views.show_region}}</a></div>';});


define('text!upfront/templates/wrapper.html',[],function () { return '<b class="upfront-wrapper-meta upfront-wrapper-meta-left upfront-ui upfront-resize-handle-wrapper upfront-resize-handle-wrapper-w ui-resizable-handle ui-resizable-w">\r\n\t<a href="#" class="upfront-icon-button upfront-icon-button-add-spacer upfront-add-spacer" data-position="left" title="Add spacer"></a>\r\n</b>\r\n<b class="upfront-wrapper-meta upfront-wrapper-meta-right upfront-ui upfront-resize-handle-wrapper upfront-resize-handle-wrapper-e ui-resizable-handle ui-resizable-e">\r\n\t<a href="#" class="upfront-icon-button upfront-icon-button-add-spacer upfront-add-spacer" data-position="right" title="Add spacer"></a>\r\n</b>\r\n';});


define('text!upfront/templates/layout.html',[],function () { return '<section class="upfront-layout">\r\n\r\n</section>';});

(function ($) {

var l10n = Upfront.Settings && Upfront.Settings.l10n
	? Upfront.Settings.l10n.global.views
	: Upfront.mainData.l10n.global.views
;

define('views',[
	"text!upfront/templates/object.html",
	"text!upfront/templates/module.html",
	"text!upfront/templates/module_group.html",
	"text!upfront/templates/region_container.html",
	"text!upfront/templates/region.html",
	"text!upfront/templates/wrapper.html",
	"text!upfront/templates/layout.html"
], function () {
  var _template_files = [
    "text!upfront/templates/object.html",
    "text!upfront/templates/module.html",
    "text!upfront/templates/module_group.html",
    "text!upfront/templates/region_container.html",
    "text!upfront/templates/region.html",
    "text!upfront/templates/wrapper.html",
    "text!upfront/templates/layout.html"
];

	// Auto-assign the template contents to internal variable
	var _template_args = arguments,
		_Upfront_Templates = {}
	;
	_(_template_files).each(function (file, idx) {
		_Upfront_Templates[file.replace(/text!upfront\/templates\//, '').replace(/\.html/, '')] = _template_args[idx];
	});

	var
		_dispatcher = _.clone(Backbone.Events),

		_Upfront_ViewMixin = {
			"dispatcher": _dispatcher
		},

	/* ----- Core View Mixins ----- */

		FixedObject_Mixin = {
			activate_condition: function () {
				return false;
			}
		},

		FixedObjectInAnonymousModule_Mixin = {
			activate_condition: function () {
				var parent_view = this.parent_module_view,
					parent_model = parent_view && parent_view.model ? parent_view.model : false
				;
				if (!parent_model) return true; // Something went wrong, assume we're not in anonymos module
				return !!parent_model.get("name").length; // Anonymous parent check
			}
		},

		Anchorable_Mixin = {
			anchor: {
				is_target: true,
				is_trigger: false
			}
		},

	/* ----- Core views ----- */

		_Upfront_SingularEditor = Backbone.View.extend(_.extend({}, _Upfront_ViewMixin, {
			initialize: function (opts) {
				// this.model.bind("change", this.render, this);
				this.options = opts;
				this.listenTo(this.model, "change", this.render);
				if (this.init) this.init();

				this.listenTo(Upfront.Events, "upfront:paddings:top:updated", this.adjust_top_settings_panel_position);
			},
			_get_full_size_el: function ($el, ratio, inside) {
				var width = $el.width(),
					height = $el.height();
				return this._get_full_size(width, height, ratio, inside);
			},
			_get_full_size: function (width, height, ratio, inside) {
				if ( !inside ) {
					if ( Math.round(height/width*100)/100 > ratio ) {
						var w = (height/ratio);
						return [ w, height, (width-w)/2, 0 ];
					} else {
						var h = (width*ratio);
						return [ width, h, 0, (height-h)/2 ];
					}
				} else {
					if ( Math.round(height/width*100)/100 < ratio ) {
						var w = (height/ratio);
						return [ w, height, (width-w)/2, 0 ];
					} else {
						var h = (width*ratio);
						return [ width, h, 0, (height-h)/2 ];
					}
				}
			},
			update_background: function () {
				var me = this,
					is_layout = ( this instanceof Layout ),
					$bg = typeof this.$bg != 'undefined' ? this.$bg : this.$el,
					type = this.model.get_breakpoint_property_value('background_type', true),
					$overlay = $bg.children('.upfront-region-bg-overlay');

				if ( type != 'featured' && me.$el.children('.feature_image_selector').length > 0 ) {
					me.$el.children('.feature_image_selector').remove();
				}
				// Destroy parallax first if exists
				if ( $overlay.data('uparallax') ) {
					$overlay.uparallax('destroy');
				}
				if ( !type || type == 'color') {
					this.update_background_color();
					if ( $overlay.length ) {
						$overlay.hide();
					}
				} else {
					if ( ! $overlay.length ) {
						$overlay = $('<div class="upfront-region-bg-overlay" />');
						$bg.append($overlay);
					} else {
						$overlay.show();
					}
					var $type = $overlay.find('.upfront-region-bg-'+type);
					if ( ! $type.length ) {
						$type = $('<div class="upfront-region-bg upfront-region-bg-' + type + '" />');
						$overlay.append($type);
					} else {
						$type.show();
					}
					$overlay.find('.upfront-region-bg').not($type).hide();
					$bg.css({
						backgroundColor: "",
						backgroundImage: "none",
						backgroundSize: "",
						backgroundRepeat: "",
						backgroundPosition: ""
					});
					switch ( type ) {
						case 'image':
							this.update_background_image($type, $overlay);
							break;
						case 'featured':
							this.update_background_featured($type, $overlay);
							break;
						case 'map':
							this.update_background_map($type, $overlay);
							break;
						case 'slider':
							this.update_background_slider($type, $overlay);
							break;
						case 'video':
							this.update_background_video($type, $overlay);
							break;
					}
				}
				Upfront.Events.trigger("entity:background:update", this, this.model);
			},
			update_background_color: function () {
				var $bg = typeof this.$bg != 'undefined' ? this.$bg : this.$el,
					color = this.model.get_breakpoint_property_value('background_color', true)
				;
				if ( color ) {
					$bg.css('background-color', color);
				} else {
					$bg.css('background-color', '');
				}
			},
			_update_background_image_from_data: function (data, $type, $overlay) {
				var is_layout = ( this instanceof Layout ),
					repeat = this.model.get_breakpoint_property_value('background_repeat', true),
					position = this.model.get_breakpoint_property_value('background_position', true),
					style = this.model.get_breakpoint_property_value('background_style', true)
				;
				if ( data.image ){
					$type.css('background-image', "url('" + data.image + "')");
					// If parallax, then run parallax first so it applies correct background size
					if ( style == 'parallax' ) {
						$overlay.uparallax({
							element: $type,
							overflowTop: 0,
							overflowBottom: 0
						});
					}
					if ( style == 'full' || style == 'parallax' ){
						var size = this._get_full_size_el((is_layout ? $(window) : $type), data.ratio, false);
						$type.data('bg-position-y', size[3]);
						$type.data('bg-position-x', size[2]);
						$type.css({
							backgroundSize: size[0] + "px " + size[1] + "px", // "auto 100%",
							backgroundRepeat: "no-repeat",
							backgroundPosition: size[2] + "px " + size[3] + "px"
						});
					} else {
						$type.css({
							backgroundSize: "auto auto",
							backgroundRepeat: repeat,
							backgroundPosition: position
						});
					}
					if ( is_layout ) {
						$type.css('background-attachment', 'fixed');
					}
				} else {
					$type.css({
						backgroundImage: "none",
						backgroundSize: "",
						backgroundRepeat: "",
						backgroundPosition: "",
						backgroundAttachment: ""
					});
				}
			},
			update_background_image: function ($type, $overlay) {
				var $bg = typeof this.$bg != 'undefined' ? this.$bg : this.$el,
					image = this.model.get_breakpoint_property_value('background_image', true),
					ratio = parseFloat(this.model.get_breakpoint_property_value('background_image_ratio', true))
				;
				this.update_background_color();
				this._update_background_image_from_data({
					image: image,
					ratio: ratio
				}, $type, $overlay);
			},
			update_background_featured: function ($type, $overlay) {
				var me = this;
				var $bg = typeof this.$bg != 'undefined' ? this.$bg : this.$el;
				this.update_background_color();

				if(me.$el.children('.feature_image_selector').length < 1) {
					var feature_selector = $('<a href="#" class="feature_image_selector"></a>');
					feature_selector.bind('click', function() {
							Upfront.Views.Editor.ImageSelector.open().done(function(images){
								var sizes = {},
									imageId = 0
								;
								_.each(images, function(image, id){
									sizes = image;
									imageId = id;
								});
								var imageInfo = {
										src: sizes.medium ? sizes.medium[0] : sizes.full[0],
										srcFull: sizes.full[0],
										srcOriginal: sizes.full[0],
										fullSize: {width: sizes.full[1], height: sizes.full[2]},
										size: sizes.medium ? {width: sizes.medium[1], height: sizes.medium[2]} : {width: sizes.full[1], height: sizes.full[2]},
										position: false,
										rotation: 0,
										id: imageId
									}
								;
								$('<img>').attr('src', imageInfo.srcFull).load(function(){
									var post = Upfront.data.posts[_upfront_post_data.post_id];
									post.meta.setValue('_thumbnail_id', imageInfo.id);
									post.meta.setValue('_thumbnail_data', imageInfo);

									post.meta.save().done(function(){
										$('<img>').attr('src', imageInfo.srcOriginal).load(function() {
											me.update_background();
											Upfront.Views.Editor.ImageSelector.close();
										});
									});
								});
							});
						});
					me.$el.append(feature_selector);
				}

				Upfront.Util.post({action: 'this_post-get_thumbnail', post_id: _upfront_post_data.post_id})
					.done(function(response){
						if(typeof(response.data.featured_image) != 'undefined') {

							if (response.data.featured_image != '') {
								me.$el.children('.feature_image_selector').addClass('change_feature_image');
							} else {
								me.$el.children('.feature_image_selector').removeClass('change_feature_image');
							}

							image = response.data.featured_image;
							var temp_image = $('<img>').attr('src', response.data.featured_image);
							temp_image.load(function(){
								ratio = parseFloat(Math.round(this.height/this.width*100)/100);
								$bg.data('bg-featured-image-ratio', ratio);

								me._update_background_image_from_data({
									image: image,
									ratio: ratio
								}, $type, $overlay);

							});
						} else {
							me._update_background_image_from_data({
								image: false,
								ratio: 0
							}, $type, $overlay);
						}
					})
				;
			},
			postpone_map_init: function ($type, $overlay) {
				var me = this;
				$(document).one("upfront-google_maps-loaded", function () {
					me.update_background_map($type, $overlay);
				});
			},
			update_background_map: function ($type, $overlay) {
				try {
					if (!window.google.maps.Map) return this.postpone_map_init($type, $overlay);
				} catch (e) {
					return this.postpone_map_init($type, $overlay);
				}
				var me = this,
					center = this.model.get_breakpoint_property_value('background_map_center', true),
					zoom = this.model.get_breakpoint_property_value('background_map_zoom', true),
					style = this.model.get_breakpoint_property_value('background_map_style', true),
					controls = this.model.get_breakpoint_property_value('background_map_controls', true),
					show_markers = this.model.get_breakpoint_property_value('background_show_markers', true),
					styles = (this.model.get_breakpoint_property_value("background_use_custom_map_code", true) ? JSON.parse(this.model.get_breakpoint_property_value("map_styles", true)) : false),
					options = {
						center: new google.maps.LatLng(center[0], center[1]),
						zoom: parseInt(zoom),
						mapTypeId: google.maps.MapTypeId[style],
						panControl: (controls.indexOf("pan") >= 0),
						zoomControl: (controls.indexOf("zoom") >= 0),
						mapTypeControl: (controls.indexOf("map_type") >= 0),
						scaleControl: (controls.indexOf("scale") >= 0),
						streetViewControl: (controls.indexOf("street_view") >= 0),
						overviewMapControl: (controls.indexOf("overview_map") >= 0),
						scrollwheel: false,
						styles: styles
					}
				;
				if ( !this.bg_map ) {
					this.bg_map = new google.maps.Map($type.get(0), options);
					if (styles) {
						this.bg_map.setOptions({styles: styles});
					}
				} else {
					$type.show();
					this.bg_map.setOptions(options);
					if (styles) {
						this.bg_map.setOptions({styles: styles});
					}
					setTimeout(function(){
						me.bg_map.setCenter(options.center);
					}, 500);
				}
				if (!!show_markers) {
					var mrk = new google.maps.Marker({
						position: options.center,
						draggable: false,
						map: this.bg_map
					});
				}
			},
			update_background_slider: function ($type, $overlay) {
				var me = this,
					slide_images = this.model.get_breakpoint_property_value('background_slider_images', true),
					rotate = this.model.get_breakpoint_property_value('background_slider_rotate', true),
					rotate_time = this.model.get_breakpoint_property_value('background_slider_rotate_time', true),
					control = this.model.get_breakpoint_property_value('background_slider_control', true),
					transition = this.model.get_breakpoint_property_value('background_slider_transition', true);
				if ( slide_images ) {
					if ( rotate ) {
						$type.attr('data-slider-auto', 1);
						$type.attr('data-slider-interval', rotate_time*1000);
					} else {
						$type.attr('data-slider-auto', 0);
					}
					$type.attr('data-slider-show-control', control);
					$type.attr('data-slider-effect', transition);
					if (!_.isUndefined(Upfront.themeExporter)) {
						// In builder always replace slide_images with server response
						Upfront.Views.Editor.ImageEditor.getImageData(slide_images).done(function(response){
							var images = response.data.images;
							// Rewrite slide images because in builder mode they will be just paths of theme images
							// and slider needs image objects to work.
							//slide_images = images;
							_.each(slide_images, function(id){
								var image = _.isNumber(id) || id.match(/^\d+$/) ? images[id] : _.find(images, function(img){
										return img.full[0].split(/[\\/]/).pop() == id.split(/[\\/]/).pop();
									}),
									$image = $('<div class="upfront-default-slider-item" />');
								if (image && image.full) $image.append('<img src="' + image.full[0] + '" />');
								$type.append($image);
							});
							me.slide_images = slide_images;
							$type.trigger('refresh');
						});
						return;
					}
					if ( (this.slide_images != slide_images) && slide_images.length > 0 ) {
						Upfront.Views.Editor.ImageEditor.getImageData(slide_images).done(function(response){
							var images = response.data.images;
							_.each(slide_images, function(id){
								var image = images[id],
									$image = $('<div class="upfront-default-slider-item" />');
								if (image && image.full) $image.append('<img src="' + image.full[0] + '" />');
								$type.append($image);
							});
							me.slide_images = slide_images;
							$type.trigger('refresh');
						});
					} else {
						$type.trigger('refresh');
					}

					//If all images deleted remove content
					if(slide_images.length == 0) {
						$type.find('.upfront-default-slider-wrap').html('');
						$type.trigger('refresh');
					}
				}
			},
			update_background_video: function ($type, $overlay) {
				var me = this,
					is_layout = ( this instanceof Layout ),
					$bg = typeof this.$bg != 'undefined' ? this.$bg : this.$el,
					color = this.model.get_breakpoint_property_value('background_color', true),
					video = this.model.get_breakpoint_property_value('background_video', true),
					embed = this.model.get_breakpoint_property_value('background_video_embed', true),
					width = this.model.get_breakpoint_property_value('background_video_width', true),
					height = this.model.get_breakpoint_property_value('background_video_height', true),
					style = this.model.get_breakpoint_property_value('background_video_style', true) || 'crop',
					ratio, $embed;
				if ( style == 'inside' && color ) {
					$bg.css('background-color', color);
				} else {
					$bg.css('background-color', '');
				}
				if ( is_layout ) {
					$overlay.css('position', 'fixed');
				}
				if ( video && embed && ( this._prev_video && this._prev_video != video || !this._prev_video ) ) {
					ratio = height/width;
					$embed = $(embed);
					$embed.css('position', 'absolute').appendTo($type);
					if ( style == 'crop' || style == 'inside' ) {
						var size = this._get_full_size_el( ( is_layout ? $(window) : $type ), ratio, (style == 'inside') );
						$embed.css({
							width: size[0],
							height: size[1],
							left: size[2],
							top: size[3]
						});
					} else if ( style == 'full' ) {
						$embed.css({
							width: is_layout ? $(window).width() : $type.width(),
							height: is_layout ? $(window).height() : $type.height(),
							left: 0,
							top: 0
						});
					}
					this._prev_video = video;
				} else if ( !video || !embed ) {
					this.remove_background();
				} else {
					this.refresh_background();
				}
			},
			refresh_background: function () {
				var $bg = typeof this.$bg != 'undefined' ? this.$bg : this.$el,
					type = this.model.get_breakpoint_property_value('background_type', true),
					$overlay = $bg.children('.upfront-region-bg-overlay'),
					$type = $overlay.find('.upfront-region-bg-' + type)
				;
				switch ( type ) {
					case 'image':
						this.refresh_background_image($type, $overlay);
						break;
					case 'featured':
						this.refresh_background_featured($type, $overlay);
						break;
					case 'map':
						this.refresh_background_map($type, $overlay);
						break;
					case 'slider':
						this.refresh_background_slider($type, $overlay);
						break;
					case 'video':
						this.refresh_background_video($type, $overlay);
						break;
				}
			},
			_refresh_background_image_from_data: function (data, $type, $overlay) {
				var style = this.model.get_breakpoint_property_value('background_style', true);
				// If parallax, then run parallax first so it applies correct background size
				if ( style == 'parallax' && $overlay.data('uparallax') ) {
					$overlay.uparallax('refresh');
					setTimeout(function(){
						// Do another refresh later to make sure it renders properly
						if ( $overlay.data('uparallax') ) $overlay.uparallax('refresh');
					}, 2000);
				}
				if ( style == 'full' || style == 'parallax' ) {
					var size = this._get_full_size_el($type, data.ratio, false);
					$type.data('bg-position-y', size[3]);
					$type.data('bg-position-x', size[2]);
					$type.css({
						backgroundSize: size[0] + "px " + size[1] + "px", // "auto 100%",
						backgroundRepeat: "no-repeat",
						backgroundPosition: size[2] + "px " + size[3] + "px"
					});
				}
			},
			refresh_background_image: function ($type, $overlay) {
				var ratio = this.model.get_breakpoint_property_value('background_image_ratio', true);
				this._refresh_background_image_from_data({
					ratio: ratio
				}, $type, $overlay);
			},
			refresh_background_featured: function ($type, $overlay) {
				var ratio = $type.data('bg-featured-image-ratio');
				this._refresh_background_image_from_data({
					ratio: ratio
				}, $type, $overlay);
			},
			refresh_background_map: function ($type, $overlay) {
				if ( !this.bg_map ) return;
				google.maps.event.trigger(this.bg_map, 'resize');
			},
			refresh_background_video: function ($type, $overlay) {
				var video = this.model.get_breakpoint_property_value('background_video', true),
					embed = this.model.get_breakpoint_property_value('background_video_embed', true),
					width = this.model.get_breakpoint_property_value('background_video_width', true),
					height = this.model.get_breakpoint_property_value('background_video_height', true),
					style = this.model.get_breakpoint_property_value('background_video_style', true) || 'crop',
					ratio,
					$embed = $type.children('iframe');
				if ( video && embed ) {
					ratio = height/width;
					if ( style == 'crop' || style == 'inside' ){
						var size = this._get_full_size_el($type, ratio, (style == 'inside'));
						$embed.css({
							width: size[0],
							height: size[1],
							left: size[2],
							top: size[3]
						});
					} else if ( style == 'full' ){
						$embed.css({
							width: $type.width(),
							height: $type.height(),
							left: 0,
							top: 0
						});
					}
				}
			},
			refresh_background_slider: function ($type, $overlay) {
				$type.trigger('refresh');
			},
			remove_background: function () {
				var $bg = typeof this.$bg != 'undefined' ? this.$bg : this.$el,
					$overlay = this.$el.find('.upfront-region-bg-overlay');
				if ( $overlay.length ) {
					$overlay.hide();
				}
				$bg.css({
					backgroundColor: "",
					backgroundImage: "none",
					backgroundSize: "",
					backgroundRepeat: "",
					backgroundPosition: ""
				});
			},
			on_window_resize: function (e) {
				if ( e.target != window || !e.data.model) return;

				var me = e.data;
				me.refresh_background();
			},
			/**
			 * Adjusts inline control panel top position when top padding is changed or element dropped
			 * Makes sure the top control panel is always visible and is not covering smaller elements
			 *
			 * @param model, either passed or existing in 'this'
             * @param current_el, either passed or existing in 'this'
			 *
			 * @return void
             */
			adjust_top_settings_panel_position: function( model, current_el ){
				var _model = model && ( model instanceof Backbone.Model ) ? model : this.model,
					_current_el = current_el ? current_el : this,
					_$control_el = current_el && current_el.$control_el ? current_el.$control_el : this.$control_el;
					;

				if( !_current_el || !_$control_el || _$control_el.$el ) return;
				// if top padding is less than 30 and element has at least 30px margin from top of window
				if(  parseInt( _model.get_breakpoint_property_value("top_padding_num", false, 0), 10 ) < 30 && _current_el.$el.offset().top >=30 ){
					_$control_el.find(".upfront-inline-panel-top").first().css("top", "-30px");
				}else{
					_$control_el.find(".upfront-inline-panel-top").first().css("top", "0px");
				}
			}
		})),

		_Upfront_EditableEntity = _Upfront_SingularEditor.extend({
			/*events: {
				"click .upfront-entity_meta a": "on_settings_click",
				"click .upfront-entity_meta": "on_meta_click",
				"click": "on_click",
			},*/
			// Propagate collection sorting event
			resort_bound_collection: function () {
				this.$el.trigger("resort", [this]);
			},
			get_settings: function () {
				return '';
			},
			on_click: function (e) {
				// We don't want to activate the element when Settings sidebar is open
				if ($('#element-settings-sidebar').html() !== '' || $('#settings').html() !== '') return false;
				// Let's not activate if shift key is hold
				if (e && e.shiftKey) return;
				this.activate();
				Upfront.Events.trigger("entity:contextmenu:deactivate", this);
				//return false;
			},
			deactivate: function () {
				this.$el.removeClass("upfront-active_entity");
				this.check_deactivated();
				this.trigger("upfront:entity:deactivate", this);
			},
			activate: function () {
				var me= this,
					currentEntity = Upfront.data.currentEntity
				;
				if (this.activate_condition && !this.activate_condition()) return false;
				if (currentEntity && currentEntity == this) return false;
				if (!(this instanceof ObjectView)) return;
				if (currentEntity && currentEntity != this) {
					//If the current entity is my child we are ok
					if(Upfront.data.currentEntity.$el.closest(me.$el).length)
						return;
					Upfront.data.currentEntity.trigger('deactivated');
				}

				Upfront.data.currentEntity = this;
				this.trigger("upfront:entity:activate", this);
				this.trigger("activated", this);
				this.listenToOnce(this, 'deactivated', this.deactivate);

				this.$el.addClass("upfront-active_entity");
				this.adjust_top_settings_panel_position();
			},
			// Stub handlers
			on_meta_click: function () {},
			on_delete_click: function () {
				this.$el.trigger("upfront:entity:remove", [this]);
				return false; // Stop propagation in order not to cause error with missing sortables etc
			},
			on_context_menu: function(e) {

				if($(e.target).closest('.redactor-editor').length > 0) {
					e.stopPropagation();
					return;
				}

				if (Upfront.Settings.Application.no_context_menu) return;

				e.stopPropagation();
				// disable context menu if the element is in text edit mode, in order to enable spell check
				if ($(e.target).closest('.redactor_box').length > 0) return;

				e.preventDefault();

				this.event = e;
				Upfront.Events.trigger("entity:contextmenu:activate", this);
			},
			on_settings_click: function (e) {
				if( typeof e !== "undefined" ) {
					e.preventDefault();
				}
				Upfront.Events.trigger("entity:settings:activate", this);
			},
			on_hide_click: function (e) {
				e.preventDefault();
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					data = Upfront.Util.clone(this.model.get_property_value_by_name('breakpoint') || {});
				if ( !_.isObject(data[breakpoint.id]) )
					data[breakpoint.id] = {};
				if ( data[breakpoint.id].hide == 1 )
					data[breakpoint.id].hide = 0;
				else
					data[breakpoint.id].hide = 1;
				this.model.set_property('breakpoint', data);
			},
			check_deactivated: function () {
				if (Upfront.data.currentEntity == this) Upfront.data.currentEntity = false;
			},
			create_size_hint: function ($el) {
				var me = this,
					$el = $el ? $el : this.$el.find('.upfront-editable_entity:first');
				if ( !$el.children('.upfront-entity-size-hint').length ) {
					this.$size_hint = $('<div class="upfront-entity-size-hint upfront-ui"></div>');
					$el.append(this.$size_hint);
				}
				setTimeout(function(){ me.update_size_hint(); }, 500);
			},
			update_size_hint: function (width, height) {
				if ( !this.$size_hint ) return;

				var $el = this.$size_hint.parent(),
					column_padding = Upfront.Settings.LayoutEditor.Grid.column_padding,
					hPadding = parseInt( this.model.get_breakpoint_property_value('left_padding_num') || column_padding ) + parseInt( this.model.get_breakpoint_property_value('right_padding_num') || column_padding ),
					vPadding = parseInt( this.model.get_breakpoint_property_value('top_padding_num') || column_padding ) + parseInt( this.model.get_breakpoint_property_value('bottom_padding_num') || column_padding ),
					width = width ? width - hPadding : $el.width() - hPadding,
					height = height ? height - vPadding : $el.height() - vPadding,
					hint = '<b>w:</b>' + width + 'px <b>h:</b>' + height + 'px';
				this.$size_hint.html(hint);
			},
			apply_breakpoint_position: function ($el, $toggle, exceptions) {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					grid = Upfront.Settings.LayoutEditor.Grid;
				if ( !breakpoint ) return;
				var me = this,
					exceptions = _.isArray(exceptions) ? exceptions : [],
					data = this.model.get_property_value_by_name('breakpoint'),
					row = this.model.get_property_value_by_name('row'),
					default_hide = this.model.get_property_value_by_name('default_hide'),
					toggle_hide = this.model.get_property_value_by_name('toggle_hide'),
					hide = this.model.get_property_value_by_name('hide'),
					breakpoint_data = data[breakpoint.id],
					$wrapper = this.$el.parent('.upfront-wrapper'),
					has_sibling = $wrapper.length > 0 ? ( $wrapper.children(':not(.upfront-wrapper-meta)').length > 1 ) : false,
					width_col = breakpoint_data ? breakpoint_data.left+breakpoint_data.col : 0
				;
				if ( has_sibling ) {
					width_col = Upfront.Util.width_to_col($wrapper.width());
				}
				if ( !_.contains(exceptions, 'hide') ) {
					if ( breakpoint_data && "hide" in breakpoint_data ) {
						hide = breakpoint_data.hide;
					}
					else {
						if ( !breakpoint.default || hide === false ) hide = default_hide;
					}
					if ( !hide ) $el.show();
					else $el.hide();
					if ( $toggle && $toggle.length > 0 ) {
						if ( ( toggle_hide !== false && toggle_hide == 0 )|| !hide ) $toggle.hide();
						else if ( hide ) $toggle.show();
					}
				}
				if ( !_.contains(exceptions, 'col') ) {
					if ( breakpoint_data && typeof breakpoint_data.col == 'number' ) {
						$el.css('width', (breakpoint_data.col/width_col*100) + '%');
						$el.data('breakpoint_col', breakpoint_data.col);
					}
					else {
						$el.css('width', '');
						$el.removeData('breakpoint_col');
					}
				}
				if ( !_.contains(exceptions, 'left') ) {
					if ( breakpoint_data && typeof breakpoint_data.left == 'number' ) {
						$el.css('margin-left', (breakpoint_data.left/width_col*100) + '%');
						$el.data('breakpoint_left', breakpoint_data.left);
					}
					else {
						$el.css('margin-left', '');
						$el.removeData('breakpoint_left');
					}
				}
				if ( !_.contains(exceptions, 'top') ) {
					if ( breakpoint_data && typeof breakpoint_data.top == 'number' ) {
						$el.css('margin-top', (breakpoint_data.top*grid.baseline) + 'px');
						$el.data('breakpoint_top', breakpoint_data.top);
					}
					else {
						$el.css('margin-top', '');
						$el.removeData('breakpoint_top');
					}
				}
				if ( !_.contains(exceptions, 'row') ) {
					if ( breakpoint_data && typeof breakpoint_data.row == 'number' ) {
						$el.css('min-height', (breakpoint_data.row*grid.baseline) + 'px');
						$el.data('breakpoint_row', breakpoint_data.row);
					}
					else {
						$el.css('min-height', (row*grid.baseline) + 'px');
						$el.removeData('breakpoint_row');
					}
				}
				if ( !_.contains(exceptions, 'order') ) {
					// order is applied to the view.$el
					if ( breakpoint_data && typeof breakpoint_data.order == 'number' ) {
						this.$el.css('order', breakpoint_data.order);
						$el.data('breakpoint_order', breakpoint_data.order);
					}
					else {
						this.$el.css('order', '');
						$el.removeData('breakpoint_order');
					}
				}
				//this.apply_paddings($el);
			},
			apply_paddings: function ($el) {
				var top_padding_use = this.model.get_breakpoint_property_value('top_padding_use', true),
					bottom_padding_use = this.model.get_breakpoint_property_value('bottom_padding_use', true),
					left_padding_use = this.model.get_breakpoint_property_value('left_padding_use', true),
					right_padding_use = this.model.get_breakpoint_property_value('right_padding_use', true),
					top_padding_num = this.model.get_breakpoint_property_value('top_padding_num', true),
					bottom_padding_num = this.model.get_breakpoint_property_value('bottom_padding_num', true),
					left_padding_num = this.model.get_breakpoint_property_value('left_padding_num', true),
					right_padding_num = this.model.get_breakpoint_property_value('right_padding_num', true)
				;
				$el.css({
					paddingTop: top_padding_use && top_padding_num !== false ? top_padding_num + 'px' : '',
					paddingBottom: bottom_padding_use && bottom_padding_num !== false ? bottom_padding_num + 'px' : '',
					paddingLeft: left_padding_use && left_padding_num !== false ? left_padding_num + 'px' : '',
					paddingRight: right_padding_use && right_padding_num !== false ? right_padding_num + 'px' : ''
				});

			},
			show_top_padding_hint: function (value) {
				var me               = this,
					top_padding_hint = this.$el.parents('.upfront-module').find('.upfront-entity-top-padding-hint')
				;
				if(!this.top_padding_hint_flag) {
					this.top_padding_hint_flag = true;
					return;
				}
				if(!top_padding_hint.length) {
					top_padding_hint = $('<div class="upfront-ui upfront-entity-padding-hint upfront-entity-top-padding-hint"></div>').appendTo(this.$el.parents('.upfront-module'));
				}
				top_padding_hint.css({
					height: value + 'px',
					opacity: 1
				});
				clearTimeout(this.top_padding_hint_timer);
				this.top_padding_hint_timer = setTimeout(function() {
					me.hide_top_padding_hint();
				}, 1000);
			},
			hide_top_padding_hint: function () {
				if(!this.padding_hint_locked) {
					this.$el.parents('.upfront-module').find('.upfront-entity-top-padding-hint').css({
						opacity: 0
					});
				}
			},
			show_bottom_padding_hint: function (value) {
				var me                  = this,
					bottom_padding_hint = this.$el.parents('.upfront-module').find('.upfront-entity-bottom-padding-hint')
				;
				if(!this.bottom_padding_hint_flag) {
					this.bottom_padding_hint_flag = true;
					return;
				}
				if(!bottom_padding_hint.length) {
					bottom_padding_hint = $('<div class="upfront-ui upfront-entity-padding-hint upfront-entity-bottom-padding-hint"></div>').appendTo(this.$el.parents('.upfront-module'));
				}
				bottom_padding_hint.css({
					height: value + 'px',
					opacity: 1
				});
				clearTimeout(this.bottom_padding_hint_timer);
				this.bottom_padding_hint_timer = setTimeout(function() {
					me.hide_bottom_padding_hint();
				}, 1000);
			},
			hide_bottom_padding_hint: function () {
				if(!this.padding_hint_locked) {
					this.$el.parents('.upfront-module').find('.upfront-entity-bottom-padding-hint').css({
						opacity: 0
					});
				}
			},
			updateControls: function() {
				var elementControlsTpl = '<div class="upfront-element-controls upfront-ui"></div>';
				if(this.paddingControl && typeof this.paddingControl.isOpen !== 'undefined' && this.paddingControl.isOpen)	return;

				if (!this.controls) {
					this.controls = this.createControls();
				}

				if (this.controls === false) return;

				this.controls.render();
				if (!this.$control_el || this.$control_el.length === 0) {
					this.$control_el = this.$el;
				}
				if (this.$control_el.find('>.upfront-element-controls').length === 0) {
					this.$control_el.append(elementControlsTpl);
					this.$control_el.find('>.upfront-element-controls').html('').append(this.controls.$el);
				}
				this.controls.delegateEvents();

			},
			createControls: function() {
				var me = this,
					panel = new Upfront.Views.Editor.InlinePanels.Panel()
					;

				panel.items = this.getControlItems();

				return panel;
			},
			createControl: function(icon, tooltip, click){
				var me = this,
					item = new Upfront.Views.Editor.InlinePanels.Control();
				item.icon = icon;
				item.tooltip = tooltip;
				if(click){
					this.listenTo(item, 'click', function(e){
						me[click](e);
					});
				}

				return item;
			},
			createPaddingControl: function(){
				this.paddingControl = new Upfront.Views.Editor.InlinePanels.PaddingControl({
					model: this.model
				});

				this.paddingControl.icon = 'padding';
				this.paddingControl.tooltip = l10n.padding_settings;
				return this.paddingControl;
			},
			getControlItems: function(){
				return _([
					this.createPaddingControl(),
					this.createControl('settings', l10n.settings, 'on_settings_click')
				]);
			}
		}),

		_Upfront_EditableContentEntity = _Upfront_EditableEntity.extend({
			events: {
				"click": "on_click",
				"dblclick": "on_edit"
			},
			on_edit: function () {
				// We don't want to activate the Entity when Settings sidebar is open
				if($('#element-settings-sidebar').html() !== '' || $('#settings').html() !== '') return false;
				var contentEditable = this.$el.find('[contenteditable]');
				if (contentEditable.length > 0) {
					contentEditable[0].focus();
				} else {
					// Trigger settings popup
					Upfront.Events.trigger("entity:settings:activate", this);
				}
				return false;
			}
        }),

		_Upfront_PluralEditor = Backbone.View.extend(_.extend({}, _Upfront_ViewMixin, {
			initialize: function () {
				// this.model.bind("change", this.render, this);
				// this.model.bind("add", this.render, this);
				// this.model.bind("remove", this.render, this);
				this.listenTo(this.model, 'change', this.render);
				this.listenTo(this.model, 'add', this.render);
				this.listenTo(this.model, 'remove', this.render);

				if (this.init) this.init();
			},
		})),

		_Upfront_EditableEntities = _Upfront_PluralEditor.extend({
			"events": {
				"resort": "on_resort_collection",
				"upfront:entity:remove": "on_entity_remove"
			},

			on_resort_collection: function () {
				var models = [],
					collection = this.model
				;
				this.$el.find(".upfront-editable_entity, .upfront-module-group").each(function () {
					var element_id = $(this).attr("id"),
						model = collection.get_by_element_id(element_id)
					;
					model && models.push(model);
				});
				this.model.reset(models);
				return false; // Don't bubble up
			},
			on_entity_remove: function (e,view) {
				view.remove();
				this.model.remove(view.model);
			},
			on_activate: function (view) {
				this.model.active_entity = view.model;
				//Upfront.data.currentEntity = view;
				Upfront.Events.trigger("entity:activated", view, view.model);
				this.trigger('activated');
			},
			deactivate: function (removed) {
				if (removed == this.model.active_entity) this.model.active_entity = false;
				//this.check_deactivated();
				Upfront.Events.trigger("entity:deactivated", removed);
				this.trigger('deactivated');
			},

			fix_flexbox_clear: function ($el) {
				// @TODO Experiment: don't need flexbox clearing workaround as elements will always take the whole width!
				/*var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					off = $el.offset(),
					width = $el.width(),
					$prev;
				$el.children().each(Upfront.Util.normalize_sort_elements_cb).sort(Upfront.Util.sort_elements_cb).filter(function(){
					return $(this).children().size() > 0;
				}).each(function(){
					var order = $(this).data('breakpoint_order') || 0,
						clear = $(this).data('breakpoint_clear'),
						prev_off, margin;
					$(this).css('margin-right', 0);
					if ( $prev && ( ( ( !breakpoint || breakpoint.default ) && $(this).hasClass('clr') ) || ( breakpoint && !breakpoint.default && clear) ) ) {
						prev_off = $prev.offset();
						margin = Math.floor( (off.left+width) - (prev_off.left+$prev.width()) );
						$prev.css('margin-right', (margin/width*100-1) + '%' ); // Add -1 to prevent rounding error
					}
					$prev = $(this);
				});*/
			},

			fix_wrapper_height: function (modules, wrappers, col) {
				Upfront.Behaviors.GridEditor.time_start('fn fix_wrapper_height');
				var me = this,
					ed = Upfront.Behaviors.GridEditor,
					breakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),
					lines = ed.parse_modules_to_lines(modules, wrappers, breakpoint.id, _.isNumber(col) ? col : breakpoint.columns)
				;
				Upfront.Events.trigger('upfront:wrappers:before_fix_height', this);
				// Reset height first
				wrappers.each(function (wrapper) {
					var wrapper_view = Upfront.data.wrapper_views[wrapper.cid];
					if ( !wrapper_view ) return;
					wrapper_view.$el.css('min-height', '');
				});
				_.each(lines, function (l) {
					var wraps = [];
					_.each(l.wrappers, function (w) {
						var wrapper_view = Upfront.data.wrapper_views[w.model.cid];
						if ( !wrapper_view ) return;
						wraps.push(wrapper_view.$el);
					});
					me._apply_wrapper_height(wraps);
				});
				Upfront.Events.trigger('upfront:wrappers:after_fix_height', this);
				Upfront.Behaviors.GridEditor.time_end('fn fix_wrapper_height');
			},
			_apply_wrapper_height: function (wraps) {
				// Find max height and apply to all
				var wraps_height = _.map(wraps, function($wrap){
						return parseFloat($wrap.css('height'));
					}),
					height = _.max(wraps_height, function(h){
						return h;
					})
				;
				_.each(wraps, function ($wrap, index) {
					var prev_is_spacer = index > 0 ? wraps[index-1].hasClass('upfront-wrapper-spacer') : false,
						next_is_spacer = index < wraps.length-1 ? wraps[index+1].hasClass('upfront-wrapper-spacer') : false
					;
					$wrap.removeAttr('data-first-in-row');
					$wrap.removeAttr('data-last-in-row');
					$wrap.removeAttr('data-prev-spacer');
					$wrap.removeAttr('data-next-spacer');
					if ( index == 0 ) $wrap.attr('data-first-in-row', '1');
					if ( index == wraps.length-1 ) $wrap.attr('data-last-in-row', '1');
					if ( prev_is_spacer ) $wrap.attr('data-prev-spacer', '1');
					if ( next_is_spacer ) $wrap.attr('data-next-spacer', '1');
					$wrap.css('min-height', height);
				});
			}
		}),

		ContextMenuItem = Backbone.View.extend({
			tagName: 'li',
			initialize: function(opts){
				this.options = opts;
				this.label = this.options.get_label;
				this.action = this.options.action;

				if ( typeof this.options.in_context == 'function' ) {
					this.in_context = this.options.in_context;
				}
			},
			render: function () {
				var me = this,
					cls = 'upfront-ctx-' + this.label().replace(/[^a-z0-9]/ig, '_').toLowerCase()
				;
				this.$el.empty().addClass(cls);
				this.$el.append(this.label);

				this.$el.bind('click', function(e) {
					e.preventDefault();
					me.action(this.for_view, e);
					Upfront.Events.trigger("entity:contextmenu:deactivate", this);
				});
			},
			remove: function(){
				this.parent_view = false;
				this.for_view = false;
				Backbone.View.prototype.remove.call(this);
			},
			in_context: function(){
				// Allow additional context for individual menuitem
				return true;
			}
		}),

		ContextMenuList = Backbone.View.extend({
			tagName: 'ul',
			initialize: function (opts) {
				this.options = opts;
				this.for_view = this.options.for_view;
			},

			render: function () {
				var me = this;
				this.$el.empty();
				this.menuitems.each(function(menuitem) {
					if ( ! menuitem.menulist ) menuitem.menulist = me;
					menuitem.for_view = me.for_view;
					if ( !menuitem.in_context() ) // Don't render if the item is not in context
						return;
					menuitem.render();
					menuitem.parent_view = me;
					me.$el.append(menuitem.el);
				});
			},
			remove: function(){
				if (this.menuitems) {
					this.menuitems.each(function(itemView){
						itemView.remove();
					});
				}
				this.for_view = false;
				this.parent_view = false;
				this.options = false;
				Backbone.View.prototype.remove.call(this);
			}

		}),
		DefaultMenuList = ContextMenuList.extend({
			className: 'upfront-default_ctx_list',
			initialize: function() {
				var menuitems = [];

				if (Upfront.Application.get_current() != "theme") {
					if (!Upfront.Settings.Application.NO_SAVE) {
						menuitems.push(new Upfront.Views.ContextMenuItem({
							get_label: function() {
								return l10n.save;
							},
							action: function() {
								var savelayout = new Upfront.Views.Editor.Command_SaveLayout();
								savelayout.on_click();
							}
						}));
					}
					menuitems.push(new Upfront.Views.ContextMenuItem({
						get_label: function() {
							return l10n.undo;
						},
						action: function(for_view) {
							var undo = new Upfront.Views.Editor.Command_Undo({"model": Upfront.Application.layout});
							undo.on_click();
						}
					}));
				}

				menuitems.push(new Upfront.Views.ContextMenuItem({
					get_label: function() {
						return Upfront.Application.get_gridstate() ? l10n.hide_grid: l10n.show_grid;
					},
					action: function() {
						var togglegrid = new Upfront.Views.Editor.Command_ToggleGrid();
						togglegrid.on_click();
					}
				}));

				menuitems.push(new Upfront.Views.ContextMenuItem({
					get_label: function() {
						return l10n.clone;
					},
					in_context: function() {
						// Only show this menu on ObjectView instance
						return this.for_view instanceof Upfront.Views.ObjectView;
					},
					action: function(for_view, e) {
						var module_view = this.for_view.parent_module_view,
							module = module_view.model,
							parent_region_view = module_view.group_view ? module_view.group_view : module_view.region_view,
							modules = parent_region_view.model.get('modules'),
							wrappers = parent_region_view.model.get('wrappers'),
							wrap_model = wrappers.get_by_wrapper_id(module.get_property_value_by_name('wrapper_id')),
							data = Upfront.Util.model_to_json(module),
							new_model = new Upfront.Models.Module(data),
							wrapper_id = Upfront.Util.get_unique_id("wrapper"),
							wrap_data = Upfront.Util.model_to_json(wrap_model),
							new_wrap_model = new Upfront.Models.Wrapper(wrap_data),
							index = modules.indexOf(module),
							models = [];

						// Make sure new model element ids and wrapper id is unique
						new_wrap_model.set_property('wrapper_id', wrapper_id);
						new_model.set_property('wrapper_id', wrapper_id);
						new_model.set_property('element_id', Upfront.Util.get_unique_id('module'));
						new_model.get('objects').each(function(obj){
							obj.set_property('element_id', Upfront.Util.get_unique_id('object'));
						});
						// Add to layout now
						wrappers.add(new_wrap_model);
						//new_model.add_to(modules, index+1);
						modules.add(new_model);
						// Normalize layout
						var ed = Upfront.Behaviors.GridEditor,
							new_module_view =  Upfront.data.module_views[new_model.cid],
							$new_module_view = new_module_view.$el,
							$new_module = $new_module_view.find(".upfront-module"),
							off = $new_module.offset(),
							pos = $new_module.position(),
							h = $new_module.outerHeight(),
							w = $new_module.outerWidth();
						ed.start(new_module_view, new_model);
						ed.normalize(ed.els, ed.wraps);

						// properly position the new module and show it under the cursor
						$new_module.css({
							position: "relative",
							top: ( e.pageY-off.top-(h/2) ),
							left: ( e.pageX-off.left-(w/2) )
						});

						// Simulate and mousedown and actually trigger drag
					    $new_module.simulate("mousedown", {
					        clientX: e.clientX,
					        clientY: e.clientY
					    });

					}
				}));
				this.menuitems = _(menuitems);
			}

		}),
		ContextMenu = Backbone.View.extend({
			initialize: function(opts) {
				this.options = opts;
				this.for_view = this.options.for_view;
				this.menulists = _([]);
			},
			render: function () {

				var me = this;

				this.$el
					.empty()
					.show()
				;

				this.menulists.each(function (menulist) {
					menulist.for_view = me.for_view;
					menulist.render();
					menulist.parent_view = me;
					me.$el.append(menulist.el);
				});

				var defaultmenulist = new DefaultMenuList();
				defaultmenulist.for_view = me.for_view;
				defaultmenulist.render();
				defaultmenulist.parent_view = me;
				me.$el.append(defaultmenulist.el);

				this.$el
				.css({
					"position": "absolute",
					"z-index": 10000000,
					"display": "block"
				})
				.offset({
					"top":me.for_view.event.pageY,
					"left": me.for_view.event.pageX-(($(document).width()-me.for_view.event.pageX <= this.$el.width() )?this.$el.width():0)
				})
				.addClass('uf-context-menu')
				;

			},

			remove: function(){
				if (this.menulists) {
					this.menulists.each(function(list){
						list.remove();
					});
				}
				Backbone.View.prototype.remove.call(this);
				if (!$('#contextmenu').length) {
					$('body').append('<div id="contextmenu">');
				}
			}

		}),

		ObjectView = _Upfront_EditableContentEntity.extend({
			className: "upfront-object-view",
			display_size_hint: true,
			events: {
				// "click .upfront-object > .upfront-entity_meta > a.upfront-entity-settings_trigger": "on_settings_click",
                "click .upfront-object > .upfront-entity_meta > a.upfront-entity-delete_trigger": "on_delete_click",
				"click .upfront-object > .upfront-entity_meta": "on_meta_click",
				"click": "on_click",
				//"dblclick": "on_edit",
				"contextmenu": "on_context_menu"
			},
			initialize: function () {
				var callback = this.update || this.render;
				this.listenTo(this.model.get("properties"), 'change', callback);
				this.listenTo(this.model.get("properties"), 'add', callback);
				this.listenTo(this.model.get("properties"), 'remove', callback);

				this.listenTo(Upfront.Events, 'entity:resize_start', this.close_settings);
				this.listenTo(Upfront.Events, 'entity:drag_start', this.close_settings);
				this.listenTo(Upfront.Events, 'upfront:element:edit:start', this.on_element_edit_start);
				this.listenTo(Upfront.Events, 'upfront:element:edit:stop', this.on_element_edit_stop);
				this.listenTo(Upfront.Events, 'entity:module:update', this.on_module_update);
				this.listenTo(Upfront.Events, 'layout:after_render', this.on_after_layout_render);
				this.listenTo(Upfront.Events, 'layout:after_render', this.checkUiOffset);

				this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.on_change_breakpoint);

				if (this.init) this.init();
			},
			close_settings: function () {
				Upfront.Events.trigger("entity:settings:deactivate");
			},
			render: function () {
				var props = {},
					me = this,
					buttons = (this.get_buttons ? this.get_buttons() : ''),
					extra_buttons = (this.get_extra_buttons ? this.get_extra_buttons() : ''),
					content = (this.get_content_markup ? this.get_content_markup() : ''),
					column_padding = Upfront.Settings.LayoutEditor.Grid.column_padding,
					height, model, template
				;
				// Force add upfront-object-view class as element object can override the view and left without this class
				this.$el.addClass('upfront-object-view');

				// Id the element by anchor, if anchor is defined
				var the_anchor = this.model.get_property_value_by_name("anchor");
				if (the_anchor && the_anchor.length) {
					this.el.id = the_anchor;
				}

				this.model.get("properties").each(function (prop) {
					props[prop.get("name")] = prop.get("value");
				});

				// Check if theme_style was removed and remove class from element,
				// this happens when element style is migrated to preset
				var oldThemeStyle = '';
				_.each(this.model._previousAttributes.properties, function(property) {
					if (typeof property === 'undefined') return;
					if (property.name === 'theme_style') {
						oldThemeStyle = property.value;
					}
				});
				// And now update classes properly (because template re-render does not affect this)
				if (oldThemeStyle && props.theme_style === '') {
					this.$el.removeClass(oldThemeStyle);
					this.$el.addClass(props.preset);
				}


				var row = this.model.get_breakpoint_property_value('row', true);
				height = ( row ) ? row * Upfront.Settings.LayoutEditor.Grid.baseline : 0;

				var theme_style = this.model.get_breakpoint_property_value('theme_style', true);
				if (theme_style) {
					props.class += ' ' + theme_style.toLowerCase();
					this._theme_style = theme_style;
				}
				props.preset = props.preset || '';

				model = _.extend(this.model.toJSON(), {"properties": props, "buttons": buttons, "content": content, "height": height, "extra_buttons": extra_buttons});
				template = _.template(_Upfront_Templates["object"], model);

				Upfront.Events.trigger("entity:object:before_render", this, this.model);
				// Listen to module resize and drop event
				if ( this.parent_module_view ){
					this.stopListening((this._previous_parent_module_view || this.parent_module_view), 'entity:resize_start');
					this.listenTo(this.parent_module_view, 'entity:resize_start', this.on_element_resize_start);
					this.stopListening((this._previous_parent_module_view || this.parent_module_view), 'entity:resizing');
					this.listenTo(this.parent_module_view, 'entity:resizing', this.on_element_resizing);
					this.stopListening((this._previous_parent_module_view || this.parent_module_view), 'entity:resize_stop');
					this.listenTo(this.parent_module_view, 'entity:resize_stop', this.on_element_resize);

					this.stopListening((this._previous_parent_module_view || this.parent_module_view), 'entity:drop');
					this.listenTo(this.parent_module_view, 'entity:drop', this.on_element_drop);
					this.listenTo(this.parent_module_view, 'entity:drop', this.adjust_top_settings_panel_position);
				}

				this.$el.html(template);

				// render subview if it exists
				if (typeof this.subview != 'undefined') {
					this.subview.setElement(this.$('.upfront-object-content')).render();
				}

				this.apply_paddings(this.$el.find('> .upfront-editable_entity:first'));

				//this.init_ckeditor_on_focus();

				Upfront.Events.trigger("entity:object:after_render", this, this.model);

				// Run checkUiOffset on after layout render instead (see initialize)
				//setTimeout(function() {
				//	me.checkUiOffset();
				//}, 300);

				if ( this.display_size_hint ) {
					this.create_size_hint(this.$el);
				}
				if ( this.on_render ) this.on_render();

				// Put this here because initialize gets overriden by child classes
				this.ensure_breakpoint_change_is_listened();
				this.ensureUiOffsetCalls();

				if ( this.parent_module_view ) {
					this.$control_el = this.parent_module_view.$('.upfront-module');
					this.updateControls();
					setTimeout(function() {
						if(me.paddingControl && typeof me.paddingControl.isOpen !== 'undefined' && !me.paddingControl.isOpen)	me.paddingControl.refresh();
					}, 300);
				}

				///**
				// * Make sure it's rendered and then adjust top panel position
				// */
				//setTimeout(function() {
				//	me.adjust_top_settings_panel_position();
				//}, 150);

			},
			update: function (prop, options) {
				if (typeof prop === 'undefined') return this.render();

				// var prev_value = prop._previousAttributes.value,
				var value = prop.get('value'),
					$me = this.$el.find('.upfront-editable_entity:first'),
					grid = Upfront.Settings.LayoutEditor.Grid
				;
				if ( prop.id == 'row' ){
					// row change
					var height = value * grid.baseline;
					$me.css('min-height', height).attr('data-row', value);
				}
				else if ( prop.id == 'class' ){
					// column and margin changes
					var classes = $me.attr('class');
					_.each([grid.class, grid.left_margin_class, grid.top_margin_class, grid.bottom_margin_class, grid.right_margin_class], function(class_name){
						var rx = new RegExp('\\b' + class_name + '(\\d+)'),
							val = value.match(rx);
						if ( val && val[1] )
							Upfront.Behaviors.GridEditor.update_class($me, class_name, val[1]);
					});
				}
				else if ( prop.id == 'breakpoint' ){
					this.update_position();

					var current_property = value.current_property,
						breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
						val = value[breakpoint.id] && value[breakpoint.id][current_property] ? value[breakpoint.id][current_property] : false;
					;

					if( current_property && val ) {
						if( current_property === 'top_padding_num' ) this.show_top_padding_hint(val);
						if( current_property === 'bottom_padding_num' ) this.show_bottom_padding_hint(val);
					}

				}
				else if ( prop.id.match(/(top|bottom|left|right)_padding_(use|num|slider)/) ) {
					this.apply_paddings($me);
					this.handle_visual_padding_hint(prop);
				}
				else if ( prop.id.match(/padding_slider/) ) {
					this.render();
					this.handle_visual_padding_hint(prop);
				}
				else {
					this.render();
				}
				Upfront.Events.trigger('entity:object:update', this, this.model);

			},
			handle_visual_padding_hint: function (prop) {
				if (typeof prop === 'undefined') return;

				var value = prop.get('value');

				if ( prop.id.match(/(top|bottom)_padding_(num|slider)/) ) {
					if ( prop.id.match(/top_padding_(num|slider)/) ) {
						this.show_top_padding_hint(value);
					}
					if ( prop.id.match(/bottom_padding_(num|slider)/) ) {
						this.show_bottom_padding_hint(value);
					}
				}
				else if ( prop.id.match(/padding_slider/) ) {
					this.show_top_padding_hint(value);
					this.show_bottom_padding_hint(value);
				}

			},
			update_position: function () {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint;
				if ( !breakpoint ) return;
				var $object = this.$el.find('> .upfront-editable_entity:first'),
					$toggle = this.$el.find('> .upfront-object-hidden-toggle')
				;
				this.apply_paddings($object);
				this.apply_breakpoint_position($object, $toggle);
				if ( this.display_size_hint ) {
					this.update_size_hint();
				}
				Upfront.Events.trigger('entity:object:update_position', this, this.model);
			},
			ensure_breakpoint_change_is_listened: function() {
				if (this.breakpoint_change_is_setup) {
					return;
				}

				this.listenTo(Upfront.Events, 'upfront:layout_size:change_breakpoint', this.on_change_breakpoint);
				this.breakpoint_change_is_setup = true;
			},
			ensureUiOffsetCalls: function() {
				var me = this;
				if (this.parent_module_view && this.parent_module_view.$el && !this.offset_check_set_for_parent) {
					this.offset_check_set_for_parent = true;
					this.listenTo(this.parent_module_view, 'entity:drop', function(){
						me.checkUiOffset();
					});
				}
				if (this.window_resize_offset_check_set) {
					return;
				}
				// This is not so important visually so throttle to 1 second
				this.lazyCheckUiOffset = _.throttle(this.checkUiOffset, 1000);
				$(window).on('resize', $.proxy(this.lazyCheckUiOffset, me));
				this.window_resize_offset_check_set = true;
			},
			checkUiOffset: function() {
				if (!this.parent_module_view) return;
				var $parentRegionEl = this.parent_module_view.region_view && this.parent_module_view.region_view.$el;

				if (!$parentRegionEl) {
					return;
				}

				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					is_responsive = breakpoint && !breakpoint.default,
					$container = $parentRegionEl.closest('.upfront-region-container'),
					containerOffset = is_responsive ? $parentRegionEl.offset() : $container.offset(),
					offset = this.$el.offset(),
					topOffsetTooClose = containerOffset && offset.top - containerOffset.top < 50,
					// $.offset does not have right side so calculate it
					rightOffset = offset.left + this.$el.width(),
					containerRightOffset = (containerOffset || {left: 0}).left + ( is_responsive ? $parentRegionEl.width() : $container.width() ),
					rightOffsetTooClose = containerRightOffset - rightOffset < 30;

				if (topOffsetTooClose && rightOffsetTooClose) {
					this.parent_module_view.$el.addClass('offset-ui-from-right-top');
				} else {
					this.parent_module_view.$el.removeClass('offset-ui-from-right-top');
				}
			},
			on_element_edit_start: function (edit, post) {
				if ( ( edit == 'text' || edit == 'write' ) && this.parent_module_view ){
					this.parent_module_view.$el.find('>.upfront-module').addClass('upfront-module-editing')
					this.parent_module_view.disable_interaction(false);
				}
			},
			on_element_edit_stop: function (edit, post, saving_draft) {
				if (this.parent_module_view && this.parent_module_view.enable_interaction && saving_draft !== true){
					this.parent_module_view.$el.find('>.upfront-module').removeClass('upfront-module-editing')
					this.parent_module_view.enable_interaction(false);
				}
			},
			on_element_resize_start: function (attr) {

			},
			on_element_resizing: function (attr) {
				if ( this.display_size_hint ) {
					this.update_size_hint(attr.width, attr.height);
				}
			},
			on_element_resize: function (attr) {

			},
			on_element_drop: function (attr) {

			},
			on_after_layout_render: function () {

			},
			on_module_update: function (view) {
				if ( !this.parent_module_view || this.parent_module_view != view ) return;
				if ( this.display_size_hint ) {
					this.update_size_hint();
				}
			},
			on_change_breakpoint: function (breakpoint) {
				var theme_style = this.model.get_breakpoint_property_value('theme_style', true),
					$obj = this.$el.find('.upfront-object');
				if ( this._theme_style ) {
					$obj.removeClass(this._theme_style.toLowerCase());
				}
				if ( theme_style ) {
					$obj.addClass(theme_style.toLowerCase());
					this._theme_style = theme_style;
				}
				
				// Deal with the preset classes change on breakpoint change
				this.model.decode_preset(breakpoint.id);
				
				this.update_position();
				this.checkUiOffset();
			},

			activate: function () {
				// Deactivate previous ObjectView
				if(typeof(Upfront.data.prevEntity) !== 'undefined' && Upfront.data.prevEntity !== false) {
					Upfront.data.prevEntity.deactivate();
				}
				Upfront.data.prevEntity = this;
				_Upfront_EditableEntity.prototype.activate.call(this);
				if ( !this.parent_module_view ) return;
				this.parent_module_view.$el.find('>.upfront-module').addClass('upfront-module-active');
				if ( !this.parent_module_view.wrapper_view ) return;
				this.parent_module_view.wrapper_view.$el.addClass('upfront-wrapper-active');
			},
			deactivate: function () {
				// We don't want to deactivate the element when Settings sidebar is open
				if($('#element-settings-sidebar').html() !== '' || $('#settings').html() !== '') return false;
				Upfront.data.prevEntity = false;
				_Upfront_EditableEntity.prototype.deactivate.call(this);
				if ( !this.parent_module_view ) return;
				this.parent_module_view.$el.find('>.upfront-module').removeClass('upfront-module-active');
				if ( !this.parent_module_view.wrapper_view ) return;
				this.parent_module_view.wrapper_view.$el.removeClass('upfront-wrapper-active');
			},

			toggle_region_class: function (classname, add, container) {
				var region_view = ( this.parent_module_view && this.parent_module_view.region_view ) ? this.parent_module_view.region_view : false,
					container_view = ( region_view ) ? region_view.parent_view.get_container_view(region_view.model) : false,
					container = ( true === container )
				;
				if ( !region_view ) return;
				if ( container ) {
					if ((container_view || {}).$el) container_view.$el.toggleClass(classname, add); // Make sure we have actual .$el to work with - `container_view` could be a boolean
				} else {
					region_view.$el.toggleClass(classname, add);
				}
			},

			add_region_class: function (classname, container) {
				this.toggle_region_class(classname, true, container);
			},

			remove_region_class: function (classname, container) {
				this.toggle_region_class(classname, false, container);
			},

			/* Getting dimension and resize element */
			get_element_size: function (real) {
				var ed = Upfront.Behaviors.GridEditor,
					real = typeof real == 'undefined' ? true : real;
				ed.start(this.parent_module_view, this.parent_module_view.model);
				var element = ed.get_position( this.parent_module_view.$el.find('.upfront-module') );
				return {
					col: element.col,
					row: real ? element.row : this.model.get_property_value_by_name('row')
				};
			},
			get_element_columns: function () {
				return this.get_element_size().col;
			},
			get_element_rows: function () {
				return this.get_element_size().row;
			},
			get_element_size_px: function (real) {
				var ed = Upfront.Behaviors.GridEditor,
					real = typeof real == 'undefined' ? true : real,
					size = this.get_element_size(real);
				return {
					col: size.col * ed.col_size,
					row: size.row * ed.baseline
				};
			},
			get_element_columns_px: function () {
				return this.get_element_size_px().col;
			},
			get_element_rows_px: function () {
				return this.get_element_size_px().row;
			},
			get_element_max_size: function ( axis ) {
				var ed = Upfront.Behaviors.GridEditor,
					$el = this.parent_module_view.$el.find('.upfront-module'),
					$region = this.$el.closest('.upfront-region'); //this.parent_module_view.region_view.$el; // @TODO parent_module_view.region_view didn't updated when changing region
				ed.start(this.parent_module_view, this.parent_module_view.model);
				return ed.get_max_size(ed.get_el($el), ed.els, ed.get_region($region), axis);
			},
			get_element_max_columns: function ( axis ) {
				return this.get_element_max_size(axis).col;
			},
			get_element_max_rows: function ( axis ) {
				return this.get_element_max_size(axis).row;
			},
			get_element_max_size_px: function ( axis ) {
				var ed = Upfront.Behaviors.GridEditor,
					max = this.get_element_max_size(axis);
				return {
					col: max.col * ed.col_size,
					row: max.row * ed.baseline
				};
			},
			get_element_max_columns_px: function ( axis ) {
				return this.get_element_max_size_px(axis).col;
			},
			get_element_max_rows_px: function ( axis ) {
				return this.get_element_max_size_px(axis).row;
			},
			set_element_size: function (col, row, axis, force) {
				return Upfront.Behaviors.GridEditor.resize(this.parent_module_view, this.parent_module_view.model, col, row, axis, force);
			},

			cleanup: function(){
				//Override this method to clean any subview on remove
			},

			remove: function(){
				this.cleanup();
				$(window).off('resize', this.lazyCheckUiOffset);
				this.parent_view = false;
				this.parent_module_view = false;
				Backbone.View.prototype.remove.call(this);
			},
			on_settings_click: function(event) {
				if ( typeof event !== "undefined" ) {
					event.preventDefault();
				}
				Upfront.Events.trigger("element:settings:activate", this);
			}
		}),

		Objects = _Upfront_EditableEntities.extend({
			"attributes": {
				"class": "upfront-editable_entities_container"
			},

			render: function () {
				var $el = this.$el,
					me = this
				;
				$el.html('');
				if ( typeof Upfront.data.object_views == 'undefined' ) {
					Upfront.data.object_views = {};
				}
				this.model.each(function (obj) {
					var view_class_prop = obj.get("properties").where({"name": "view_class"}),
						view_class = view_class_prop.length ? view_class_prop[0].get("value") : "ObjectView",
						local_view = Upfront.Views[view_class] ? Upfront.data.object_views[obj.cid] || new Upfront.Views[view_class]({model: obj}) : false
					;
					if (local_view) {
						local_view.parent_view = me;
						local_view._previous_parent_module_view = local_view.parent_module_view;
						local_view.parent_module_view = me.parent_view;
						local_view.render();
						$el.append(local_view.el);
						if ( ! Upfront.data.object_views[obj.cid] ) {
							me.listenTo(local_view, 'upfront:entity:activate', me.on_activate);
							me.listenTo(local_view.model, 'remove', me.deactivate);
							//local_view.bind("upfront:entity:activate", me.on_activate, me);
							//local_view.model.bind("remove", me.deactivate, me);
							//local_view.listenTo(local_view.model, "remove", me.deactivate);
							Upfront.data.object_views[obj.cid] = local_view;
						} else {
							local_view.delegateEvents();
						}
					}
				});
			},
			remove: function() {
				if (this.model) {
					this.model.each(function(model){
						var view = Upfront.data.object_views[model.cid];
						if(	view ){
							view.remove();
							delete Upfront.data.object_views[model.cid];
						}
					});
				}
				this.parent_view = false;
				Backbone.View.prototype.remove.call(this);
				if (this.model) {
					this.model.reset([], {silent:true});
					this.model = false;
				}
			}
		}),

		Module = _Upfront_EditableEntity.extend({
			interaction: true,
			lock_interaction: false,
			className: "upfront-module-view",
			events: {
				"click .upfront-module > .upfront-entity_meta > a.upfront-entity-settings_trigger": "on_settings_click",
				"click .upfront-module > .upfront-entity_meta > a.upfront-entity-delete_trigger": "on_delete_click",
				"click .upfront-module > .upfront-entity_meta > a.upfront-entity-hide_trigger": "on_hide_click",
				"click .upfront-module-hidden-toggle > a.upfront-entity-hide_trigger": "on_hide_click",
				"click .upfront-module > .upfront-entity_meta": "on_meta_click",
				"click": "on_click"
			},
			initialize: function () {
				var callback = this.update || this.render;
				// this.model.get("properties").bind("change", callback, this);
				// this.model.get("properties").bind("add", callback, this);
				// this.model.get("properties").bind("remove", callback, this);
				this.listenTo(this.model.get("properties"), 'change', callback);
				this.listenTo(this.model.get("properties"), 'add', callback);
				this.listenTo(this.model.get("properties"), 'remove', callback);

				this.listenTo(Upfront.Events, 'command:region:edit_toggle', this.on_region_edit);
				this.listenTo(Upfront.Events, 'command:region:fixed_edit_toggle', this.on_region_edit);

				this.on('on_layout', this.render_new_object, this);
				//this.on('entity:resize_stop', this.on_resize, this);
				//this.on('entity:drop', this.on_drop, this);
				this.on('region:updated', this.on_region_update, this);

				this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.on_change_breakpoint);
				this.listenTo(Upfront.Events, "entity:wrapper:update_position", this.on_wrapper_update);

				this.listenTo(Upfront.Events, "layout:render", this.on_after_layout_render);
			},
			render: function () {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					props = {},
					is_parent_group = ( typeof this.group_view != 'undefined' ),
					run = this.model.get("properties").each(function (prop) {
						props[prop.get("name")] = prop.get("value");
					}),
					height = ( props.row ) ? props.row * Upfront.Settings.LayoutEditor.Grid.baseline : 0,
					default_hide = "default_hide" in props ? props.default_hide : 0,
					hide = "hide" in props ? props.hide : default_hide,
					model = _.extend(this.model.toJSON(), {"properties": props, "height": height, "hide": hide, "parent_group_class": is_parent_group ? 'upfront-module-parent-group' : ''}),
					template = _.template(_Upfront_Templates["module"], model)
				;
				Upfront.Events.trigger("entity:module:before_render", this, this.model);

				this.$el.html(template);
				if ( breakpoint && !breakpoint.default ) {
					this.update_position();
				}

				if ( this.model.get("shadow") ) {
					this.$el.find('.upfront-editable_entity:first').attr("data-shadow", this.model.get("shadow"));
				} else {
					this.render_object();
				}

				if (this.$el.is(".upfront-active_entity")) {
					this.$el.trigger("upfront-editable_entity-selected", [this.model, this]);
				}
				Upfront.Events.trigger("entity:module:after_render", this, this.model);
			},
			update: function (prop, options) {
				var prev_value = prop._previousAttributes.value,
					value = prop.get('value'),
					$me = this.$el.find('.upfront-editable_entity:first'),
					grid = Upfront.Settings.LayoutEditor.Grid
				;
				if ( prop.id == 'row' ) {
					// row change
					var height = value * grid.baseline;
					$me.css('min-height', height).attr('data-row', value);
				} else if ( prop.id == 'class' ) {
					// column and margin changes
					var classes = $me.attr('class');
					_.each([grid.class, grid.left_margin_class, grid.top_margin_class, grid.bottom_margin_class, grid.right_margin_class], function(class_name){
						var rx = new RegExp('\\b' + class_name + '(\\d+)'),
							val = value.match(rx);
						if ( val && val[1] )
							Upfront.Behaviors.GridEditor.update_class($me, class_name, val[1]);
					});
				} else if ( prop.id == 'breakpoint' ) {
					this.update_position();
				}
				Upfront.Events.trigger('entity:module:update', this, this.model);
			},
			update_position: function () {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					grid = Upfront.Settings.LayoutEditor.Grid;
				if ( ! breakpoint ) return;
				var $module = this.$el.find('> .upfront-module'),
					$toggle = this.$el.find('> .upfront-module-hidden-toggle')
				;
				this.apply_breakpoint_position($module, $toggle);
				Upfront.Events.trigger('entity:module:update_position', this, this.model);
			},
			render_object: function () {
				var objects_view = this._objects_view || new Objects({"model": this.model.get("objects")});
				objects_view.parent_view = this;
				objects_view.render();
				this.$(".upfront-objects_container").append(objects_view.el);
				if ( ! this._objects_view ) {
					this._objects_view = objects_view;
				} else {
					this._objects_view.delegateEvents();
				}
			},
			render_new_object: function() {
				this.render_object();
				
				//Add usingNewAppearance property
				this.model.get('objects').each(function(object) { 
					object.set_property('usingNewAppearance', true); 
				})
			},
			disable_interaction: function (prevent_edit, prevent_button, resize, drag, lock) {
				var $el = this.$el.find('.upfront-editable_entity:first');

				if ( prevent_edit && prevent_button ) $el.addClass('upfront-module-disabled-all');

				if ( prevent_edit ) $el.addClass('upfront-module-disabled-edit');

				if ( prevent_button ) $el.addClass('upfront-module-disabled-button');

				if ( !resize && $el.data('ui-resizable') ) $el.resizable('option', 'disabled', true);

				if ( !drag && $el.data('ui-draggable') ) $el.draggable('option', 'disabled', true);

				this.interaction = false;

				if ( lock ) this.lock_interaction = true;
			},
			enable_interaction: function (unlock) {
				if ( this.lock_interaction && !unlock ) return;

				var $el = this.$el.find('.upfront-editable_entity:first');
				$el.removeClass('upfront-module-disabled-all upfront-module-disabled-edit upfront-module-disabled-button');

				if ( $el.data('ui-resizable') ) $el.resizable('option', 'disabled', false);

				if ( $el.data('ui-draggable') ) $el.draggable('option', 'disabled', false);

				this.interaction = true;
				this.lock_interaction = false;
			},
			on_click: function (e) {
				var me = this,
					ed = Upfront.Behaviors.LayoutEditor,
					clean_selection = false,
					$module = this.$el.find('>.upfront-module'),
					currentEntity = Upfront.data.currentEntity,
					$current = currentEntity ? currentEntity.$el.closest('.upfront-module') : false,
					$selected, $selectable, $restricted
				;
				if ( this.interaction ) {
					// Check if shift key is pressed, if it does, try to do selection
					if ( e && e.shiftKey && this.region_view ) {
						// Clean selection if any of the selection is on different region
						// We can't group element that wasn't in the same region
						_.each(ed.selection, function (sel) {
							if ( !clean_selection ) {
								clean_selection = ( $(sel).closest('.upfront-region').get(0) != me.region_view.$el.get(0) );
							}
						});
						if ( clean_selection ) ed.remove_selections();
						// Do selecting
						// We'll add our module to existing selection
						// If no existing selection, we select the active module + this module
						// Or just this module if no active, or active is the same as this module
						$selectable = this.region_view.$el.find('.upfront-module').not('.upfront-ui-selected, .upfront-module-parent-group');
						$restricted = this.region_view.$el.find('.upfront-module-group');
						if ( ed.selection.length > 0 ) {
							$selected = this.region_view.$el.find('.upfront-ui-selected');
							ed._add_selections($selected.add($module), $selectable, $restricted);
						}
						else {
							if ( $current !== false && $current.length > 0 ) {
								ed._add_selection($current.get(0));
								$selected = $current;
								if ( $current.get(0) != $module.get(0) ) {
									$selected = $selected.add($module);
								}
								if ( $selected.length > 1 ) {
									ed._add_selections($selected, $selectable, $restricted);
								}
							}
							else {
								ed._add_selection($module.get(0));
							}
						}
						ed._update_selection_outline();
						if ( ed.selection.length > 1 ) {
							ed.parse_selections();
						}
						// Let's deactivate active element too
						if ( currentEntity ){
							currentEntity.trigger('deactivated', e);
							currentEntity.$el.removeClass("upfront-active_entity");
							Upfront.Events.trigger("entity:deactivated", e);
							Upfront.data.currentEntity = false;
						}
						e.stopPropagation();
					}
					else {
						ed.remove_selections();
						this.constructor.__super__.on_click.call(this, e);
					}
				} else {
					e.stopPropagation();
				}
			},
			on_hide_click: function (e) {
				_Upfront_EditableEntity.prototype.on_hide_click.call(this, e);
				Upfront.Events.trigger("entity:module:hide_toggle", this, this.model);
			},
			on_resize: function (attr) {
				// on resize
			},
			on_drop: function (attr) {
				// on drop
			},
			on_region_update: function(){
				if ( this._objects_view ) {
					this._objects_view.model.each(function(view){
						view.trigger('region:updated');
					});
				}
			},
			on_region_edit: function (edit) {
				if (Upfront.Application.PostContentEditor == Upfront.Application.current_subapplication) {
					return;
				}

				if ( edit ) {
					this.disable_interaction(true, true, false, false, true);
				} else {
					this.enable_interaction(true);
				}
			},
			on_wrapper_update: function (wrapper, wrapper_model) {
				if ( wrapper != this.wrapper_view ) return;
				this.update_position();
			},
			on_change_breakpoint: function (breakpoint) {
				var $delete = this.$el.find('.upfront-module > .upfront-entity_meta > a.upfront-entity-delete_trigger'),
					$hide = this.$el.find('.upfront-module > .upfront-entity_meta > a.upfront-entity-hide_trigger');
				if ( !breakpoint.default ) {
					this.disable_interaction(true, false, true, true, true);
					$delete.hide();
					$hide.show();
				} else {
					this.enable_interaction(true);
					$delete.show();
					$hide.hide();
				}
				//this.update_position();
			},
			on_after_layout_render: function () {
			},
			remove: function(){
				if(this._objects_view)
					this._objects_view.remove();
				Backbone.View.prototype.remove.call(this);
			}
		}),

		ModuleGroup = _Upfront_EditableEntity.extend({
			className: "upfront-editable_entity upfront-module-group",
			id: function(){ return this.model.get_property_value_by_name('element_id'); },
			cssSelectors: {
				'.upfront-module-group': {label: l10n.mg_label, info: l10n.mg_info},
				'.upfront-module-group-bg': {label: l10n.mgbg_label, info: l10n.mgbg_info},
				'.upfront-object, .upfront-output-object': {label: l10n.mgel_label, info: l10n.mgel_info}
			},
			events: {
				"click > .upfront-entity_meta > a.upfront-entity-settings_trigger": "on_settings_click",
				"click > .upfront-module-group-toggle-container > .upfront-module-group-ungroup": "on_ungroup",
				"click > .upfront-module-group-toggle-container > .upfront-module-group-reorder": "on_reorder",
				"click > .upfront-module-group-toggle-container > .upfront-module-group-edit": "on_edit",
				"click > .upfront-entity_meta > a.upfront-entity-hide_trigger": "on_hide_click",
				"click > .upfront-module-hidden-toggle > a.upfront-entity-hide_trigger": "on_hide_click",
				//"click a.redactor_act": "onOpenPanelClick",
				//"click .upfront-save_settings": "onOpenPanelClick",
				"click .open-item-controls": "onOpenItemControlsClick",
				"click > .upfront-module-group-finish-edit": "on_finish",
				"click": "on_click",
				"dblclick": "on_dblclick"
			},
			initialize: function () {
				var callback = this.update || this.render;
				this.listenTo(this.model.get("properties"), 'change', callback);
				this.listenTo(this.model.get("properties"), 'change', this.handle_visual_padding_hint);
				this.listenTo(this.model.get("properties"), 'add', callback);
				this.listenTo(this.model.get("properties"), 'remove', callback);
				this._prev_class = this.model.get_property_value_by_name('class');

				this.listenTo(Upfront.Events, 'layout:after_render', this.refresh_background);
				this.listenTo(Upfront.Events, 'layout:after_render', this.update_size_hint);

				this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.on_change_breakpoint);
				this.listenTo(Upfront.Events, "command:module_group:finish_edit", this.on_finish);
				this.listenTo(Upfront.Events, "command:module_group:close_panel", this.closeControlPanel);


				this.editing = false;
				this.hidden = false;
				this.on('entity:resize_stop', this.on_resize, this);
			},
			handle_visual_padding_hint: function (prop) {
				if (typeof prop === 'undefined') return;

				var value = prop.get('value');

				if ( prop.id.match(/(top|bottom)_padding_(num|slider)/) ) {
					if ( prop.id.match(/top_padding_(num|slider)/) ) {
						this.show_top_padding_hint(value);
					}
					if ( prop.id.match(/bottom_padding_(num|slider)/) ) {
						this.show_bottom_padding_hint(value);
					}
				}

			},
			show_top_padding_hint: function (value) {
				var me               = this,
					top_padding_hint = this.$el.find('.upfront-entity-top-padding-hint')
				;
				if(!this.top_padding_hint_flag) {
					this.top_padding_hint_flag = true;
					return;
				}
				if(!top_padding_hint.length) {
					top_padding_hint = $('<div class="upfront-ui upfront-entity-padding-hint upfront-entity-top-padding-hint"></div>').appendTo(this.$el);
				}
				top_padding_hint.css({
					height: value + 'px',
					opacity: 1
				});
				clearTimeout(this.top_padding_hint_timer);
				this.top_padding_hint_timer = setTimeout(function() {
					me.hide_top_padding_hint();
				}, 1000);
			},
			hide_top_padding_hint: function () {
				if(!this.padding_hint_locked) {
					this.$el.find('.upfront-entity-top-padding-hint').css({
						opacity: 0
					});
				}
			},
			show_bottom_padding_hint: function (value) {
				var me                  = this,
					bottom_padding_hint = this.$el.find('.upfront-entity-bottom-padding-hint')
				;
				if(!this.bottom_padding_hint_flag) {
					this.bottom_padding_hint_flag = true;
					return;
				}
				if(!bottom_padding_hint.length) {
					bottom_padding_hint = $('<div class="upfront-ui upfront-entity-padding-hint upfront-entity-bottom-padding-hint"></div>').appendTo(this.$el);
				}
				bottom_padding_hint.css({
					height: value + 'px',
					opacity: 1
				});
				clearTimeout(this.bottom_padding_hint_timer);
				this.bottom_padding_hint_timer = setTimeout(function() {
					me.hide_bottom_padding_hint();
				}, 1000);
			},
			hide_bottom_padding_hint: function () {
				if(!this.padding_hint_locked) {
					this.$el.find('.upfront-entity-bottom-padding-hint').css({
						opacity: 0
					});
				}
			},

			createPaddingControl: function(){
				this.paddingControl = new Upfront.Views.Editor.InlinePanels.PaddingControl({
					model: this.model
				});

				this.paddingControl.icon = 'padding';
				this.paddingControl.tooltip = l10n.padding_settings;
				this.paddingControl.default_padding.top = 0;
				this.paddingControl.default_padding.bottom = 0;

				return this.paddingControl;
			},

			onOpenPanelClick: function(event) {
				event.preventDefault();
				this.toggleLinkPanel();
			},

			onOpenItemControlsClick: function() {
				if (this.$el.hasClass('controls-visible')) {
					this.closeControlPanel();
				} else {
					this.openControlPanel();
				}
			},

			openControlPanel: function () {
				this.$el.addClass('controls-visible');
				this.controlsVisible = true;
				this.disable_interaction(false, false, false);
			},

			closeControlPanel: function(enable) {
				var enable = ( enable !== false );
				this.$el.removeClass('controls-visible');
				this.controlsVisible = false;
				if (enable) {
					this.enable_interaction();
				}
			},

			createInlineControlPanel: function() {
				var property_url = this.model.get_property_value_by_name('href');

				if(!property_url) {
					property_url = "";
				}

				var me = this,
					panel = new Upfront.Views.Editor.InlinePanels.ControlPanel(),
					visitLinkControl = new Upfront.Views.Editor.InlinePanels.Controls.VisitLink({
						url: property_url,
						hideIfUnlink: true,
						linkLabel: {
							external: l10n.visit_link
						}
					}),
					linkPanelControl = new Upfront.Views.Editor.InlinePanels.Controls.GroupLinkPanel({
						linkUrl: property_url,
						linkType: Upfront.Util.guessLinkType(property_url),
						linkTarget: this.model.get_property_value_by_name("linkTarget"),
						button: false
					}),
					ungroupControl = new Upfront.Views.Editor.InlinePanels.Control({
						label: l10n.ungroup,
						className: 'upfront-inline-panel-item ungroup-control'
					}),
					editControl = new Upfront.Views.Editor.InlinePanels.Control({
						label: l10n.edit_elements,
						className: 'upfront-inline-panel-item edit-elements-control'
					})
				;

				this.listenTo(linkPanelControl, 'change change:target', function(data) {
					visitLinkControl.setLink(data.url);
					this.model.set_property('href', data.url);
					this.model.set_property('linkTarget', data.target);
				});
				this.listenTo(linkPanelControl, 'panel:open panel:close', function() {
					me.toggleLinkPanel();
				});
				this.listenTo(ungroupControl, 'click', function (e) {
					me.on_ungroup();
				});
				this.listenTo(editControl, 'click', function (e) {
					me.closeControlPanel(false);
					me.on_edit();
				});

				panel.items = _([
					linkPanelControl,
					visitLinkControl,
					editControl,
					ungroupControl
				]);

				var $imageControlsTpl = $('<div class="upfront-module-group-controls upfront-ui"></div>');
				this.$el.append($imageControlsTpl);
				panel.render();
				$imageControlsTpl.append(panel.el);
				panel.delegateEvents();

				this.panel = panel;
			},

			toggleLinkPanel: function() {
				this.$el.toggleClass('control-dialog-open');
			},

			render: function () {
				var me = this,
					props = {},
					run = this.model.get("properties").each(function (prop) {
						props[prop.get("name")] = prop.get("value");
					}),
					height = ( props.row ) ? props.row * Upfront.Settings.LayoutEditor.Grid.baseline : 0,
					model = _.extend(this.model.toJSON(), {"properties": props, "height": height, "href": ""}),
					template = _.template(_Upfront_Templates["module_group"], model);

				Upfront.Events.trigger("entity:module_group:before_render", this, this.model);


				// Id the element by anchor, if anchor is defined
				var the_anchor = this.model.get_property_value_by_name("anchor");
				if (the_anchor && the_anchor.length)
					this.el.id = the_anchor;

				var theme_style = this.model.get_breakpoint_property_value('theme_style', true);
				if(theme_style){
					this.$el.addClass( theme_style.toLowerCase() );
					this._theme_style = theme_style;
				}

				this.$el.html(template + '<span class="open-item-controls"></span>');
				this.$bg = this.$el.find('.upfront-module-group-bg');
				this.update();
				var local_view = this._modules_view || new Modules({"model": this.model.get("modules")});
				local_view.region_view = this.region_view;
				local_view.group_view = this;
				this.$el.find('> .upfront-modules_container').append(local_view.el);
				local_view.render();

				this.apply_paddings(this.$el.find('> .upfront-modules_container'));

				if ( ! this._modules_view ) {
					this._modules_view = local_view;
				}
				else {
					this._modules_view.delegateEvents();
				}

				this.createInlineControlPanel();

				this.create_size_hint(this.$el);
				this.$control_el = this.$el;
				this.updateControls();

				setTimeout(function() {
					if(me.paddingControl && typeof me.paddingControl.isOpen !== 'undefined' && !me.paddingControl.isOpen)	me.paddingControl.refresh();
				}, 300);

				Upfront.Events.trigger("entity:module_group:after_render", this, this.model);
			},
			update: function (prop) {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					prop_class = this.model.get_property_value_by_name('class'),
					row = this.model.get_property_value_by_name('row'),
					use_padding = this.model.get_breakpoint_property_value('use_padding', true),
					theme_style = this.model.get_breakpoint_property_value('theme_style', true),
					grid = Upfront.Settings.LayoutEditor.Grid,
					ed = Upfront.Behaviors.GridEditor,
					prev_col, col
				;
				if ( Upfront.Application.layout_ready ) {
					prev_col = ( !breakpoint || breakpoint.default ) ? ed.get_class_num(this._prev_class, grid.class) : this.$el.data('breakpoint_col');
					col = ( !breakpoint || breakpoint.default ) ? ed.get_class_num(prop_class, grid.class) : this.model.get_breakpoint_property_value('col');
				}
				this.$el.removeClass(this._prev_class).addClass(prop_class);
				this._prev_class = prop_class;
				if(theme_style){
					this.$el.removeClass(this._theme_style).addClass( theme_style.toLowerCase() );
					this._theme_style = theme_style;
				}
				this.$el.css('min-height', (row*grid.baseline) + 'px').attr('data-row', row);

				this.$bg.toggleClass('upfront-module-group-bg-padding', use_padding ? true : false);

				this.update_position();
				this.update_background();
				// Check if width is changed, if it did, let's normalize child modules
				if ( Upfront.Application.layout_ready && prop && ( prop.id == 'class' || prop.id == 'breakpoint' ) && prev_col != col ) {
					this.normalize_child_modules(prev_col);
				}
				Upfront.Events.trigger('entity:module_group:update', this, this.model);
			},
			update_position: function () {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					grid = Upfront.Settings.LayoutEditor.Grid
				;

				this.apply_paddings(this.$el.find('> .upfront-modules_container'));

				if ( ! breakpoint ) return;

				var $toggle = this.$el.find('> .upfront-module-hidden-toggle'),
					hide = this.model.get_breakpoint_property_value('hide', true)
				;

				this.apply_breakpoint_position(this.$el, $toggle, ['hide']);

				if ( hide ) {
					this.hidden = true;
					this.$el.addClass('upfront-module-group-hidden');
					$toggle.show();
					this.disable_interaction(true, false, false);
				}
				else {
					this.hidden = false;
					this.$el.removeClass('upfront-module-group-hidden');
					$toggle.hide();
					this.enable_interaction();
					this.model.get('modules').each(function(module){
						var module_view = Upfront.data.module_views ? Upfront.data.module_views[module.cid] : false;
						if ( !module_view ) return;
						module_view.update_position();
					});
				}

				var theme_style = this.model.get_breakpoint_property_value('theme_style', true);
				if ( this._theme_style ) {
					this.$el.removeClass(this._theme_style.toLowerCase());
				}
				if ( theme_style ) {
					this.$el.addClass(theme_style.toLowerCase());
					this._theme_style = theme_style;
				}
				this.update_size_hint();
				Upfront.Events.trigger('entity:module_group:update_position', this, this.model);
			},
			normalize_child_modules: function (prev_col) {
				if ( !this._modules_view ) return;
				var breakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),
					ed = Upfront.Behaviors.GridEditor,
					col = ( !breakpoint || breakpoint.default ) ? ed.get_class_num(this.$el, ed.grid.class) : this.$el.data('breakpoint_col')
				;
				this._modules_view.normalize_child_modules(col, prev_col, this.model.get('wrappers'));
			},
			on_settings_click: function (e) {
				if( typeof e !== "undefined" ){
					e.preventDefault();
				}
				var BgSettings = Upfront.Views.Editor.BgSettings.Settings.extend({
					bg_title: l10n.group_settings,
					enable_types: ['color', 'image'/*, 'slider', 'video', 'map'*/]
				});
				Upfront.Events.trigger("entity:settings:activate", this, BgSettings);
			},
			on_ungroup: function () {
				var me = this,
					ed = Upfront.Behaviors.GridEditor,
					breakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),
					col = ed.get_class_num(this.$el, ed.grid.class),
					top_padding_use = this.model.get_breakpoint_property_value('top_padding_use', true),
					top_padding_num = this.model.get_breakpoint_property_value('top_padding_num', true),
					top = top_padding_use && top_padding_num !== false ? top_padding_num : 0,
					$wrap = this.$el.closest('.upfront-wrapper'),
					$wraps = Upfront.Util.find_sorted($wrap.parent(), '> .upfront-wrapper:visible'),
					is_clr = $wrap.hasClass('clr'),
					group_wrapper_id = this.model.get_wrapper_id(),
					modules = this.model.get('modules'),
					wrappers = this.model.get('wrappers'),
					region = this.region,
					region_modules = this.region_view.model.get('modules'),
					region_wrappers = this.region_view.model.get('wrappers'),
					group_wrapper = region_wrappers.get_by_wrapper_id(group_wrapper_id),
					group_wrapper_view = Upfront.data.wrapper_views[group_wrapper.cid],
					index = region_modules.indexOf(this.model),
					region_lines = ed.parse_modules_to_lines(region_modules, region_wrappers, breakpoint.id, breakpoint.columns),
					group_lines = ed.parse_modules_to_lines(modules, wrappers, breakpoint.id, col),
					modules_arr = modules.map(function(module){ return module; }),
					line_spacers = [],
					line,
					my_wrapper, prev_wrapper, next_wrapper,
					module_index = 0,
					add_spacer_queue = [],
					is_combine_wrap = false,
					combine_left_spacers = [],
					combine_right_spacers = [],
					combine_left_spacer = 0,
					combine_right_spacer = 0
				;
				// Make sure module interaction is enabled first to prevent issue after ungroup
				this.toggle_modules_interaction(true, true);
				ed.start(this, this.model);
				// Find previous and next wrapper
				_.each(region_lines, function (l) {
					if ( line ) return;
					prev_wrapper = false;
					next_wrapper = false;
					_.each(l.wrappers, function (w) {
						if ( my_wrapper && !next_wrapper ) next_wrapper = w;
						_.each(w.modules, function (m) {
							if ( me.model == m.model ) {
								my_wrapper = w;
								line = l;
							}
						});
						if ( !my_wrapper ) prev_wrapper = w;
					});
				});
				if ( !line ) return;
				// Find how many spacer is in the line
				_.each(line.wrappers, function (w) {
					if ( w.spacer ) {
						line_spacers.push(w);
					}
				});
				// Let's check if we need to combine wrapper
				// Do that when group is trapped between elements or when there is other element in the same wrapper
				if ( my_wrapper.modules.length > 1 || ( line.wrappers.length - line_spacers.length > 1 ) ) {
					is_combine_wrap = true;
					if ( my_wrapper.modules.length == 1 && group_lines.length == 1 ) {
						is_combine_wrap = false;
					}
				}
				// Find left/right spacer if combined
				if ( is_combine_wrap && my_wrapper.modules.length == 1 ) {
					_.each(group_lines, function (l, li) {
						_.each(l.wrappers, function (w, wi) {
							if ( wi == 0 ) {
								if ( w.spacer ) combine_left_spacers.push(w.col);
								else combine_left_spacers.push(0);
							}
							if ( wi == l.wrappers.length-1 ) {
								if ( w.spacer ) combine_right_spacers.push(w.col);
								else combine_right_spacers.push(0);
							}
						});
					});
					combine_left_spacer = _.min(combine_left_spacers);
					combine_right_spacer = _.min(combine_right_spacers);
				}
				// Iterate through group
				_.each(group_lines, function (l, li) {
					_.each(l.wrappers, function (w, wi) {
						var wrapper_view = Upfront.data.wrapper_views[w.model.cid],
							remove_modules = [],
							move_modules = []
						;
						_.each(w.modules, function (m, mi) {
							var view = Upfront.data.module_views[m.model.cid],
								$view_el = view.$el.find('> .upfront-editable_entity'),
								is_visible = $view_el.is(':visible'),
								object = m.model.get('objects').first(),
								module_col = col,
								remove_module = false
							;
							// If not visible, let's remove it
							if ( !is_visible ) {
								remove_module = true;
							}
							else {
								// If combine wrap, remove all spacer and set the group wrapper_id
								if ( is_combine_wrap ) {
									if ( m.spacer ) {
										remove_module = true;
									}
									else {
										if ( combine_left_spacer > 0 && prev_wrapper && prev_wrapper.spacer ) {
											module_col -= combine_left_spacer;
										}
										if ( combine_right_spacer > 0 && next_wrapper && next_wrapper.spacer ) {
											module_col -= combine_right_spacer;
										}
										ed.update_model_margin_classes( $view_el, [ed.grid.class + module_col] );
										m.model.set_property('wrapper_id', group_wrapper_id);
									}
								}
								if ( li == 0 && mi == 0 && !m.spacer ) {
									me._update_padding('top', object, top);
								}
							}
							delete view.group_view;
							if ( remove_module ) {
								remove_modules.push({
									model: m.model
								});
							}
							else {
								move_modules.push({
									model: m.model,
									index: index+module_index
								});
								module_index++;
							}
						});

						// If combined, try to see spacer we can add
						// Otherwise, normalize spacers and add needed class
						if ( !is_combine_wrap ) {
							if ( wi == 0 ){
								// Add/remove clr class as this is the first in row
								if ( is_clr ) w.model.add_class('clr');
								else w.model.remove_class('clr');
								// Add previous spacer
								if ( prev_wrapper && prev_wrapper.spacer ) {
									if ( w.spacer ) {
										w.modules[0].model.replace_class(ed.grid.class + (w.col+prev_wrapper.col));
										w.model.replace_class(ed.grid.class + (w.col+prev_wrapper.col));
									}
									else {
										add_spacer_queue.push({
											view: wrapper_view,
											position: 'left',
											col: prev_wrapper.col,
											wrapper_col: w.col+prev_wrapper.col
										});
									}
								}
							}
							if ( wi == l.wrappers.length-1 ) {
								// Add next spacer
								if ( next_wrapper && next_wrapper.spacer ) {
									if ( w.spacer ) {
										w.modules[0].model.replace_class(ed.grid.class + (w.col+next_wrapper.col));
										w.model.replace_class(ed.grid.class + (w.col+next_wrapper.col));
									}
									else {
										add_spacer_queue.push({
											view: wrapper_view,
											position: 'right',
											col: next_wrapper.col,
											wrapper_col: w.col+next_wrapper.col
										});
									}
								}
							}
						}

						_.each(remove_modules, function (m) {
							modules.remove(m.model);
						});

						wrappers.remove(w.model, {silent: true});

						if ( move_modules.length > 0 ) {
							if ( !is_combine_wrap ) {
								region_wrappers.add(w.model, {silent: true});
							}
							_.each(move_modules, function(m){
								modules.remove(m.model, {silent: true});
								m.model.add_to(region_modules, m.index, {update: false});
							});
						}
					});
				});

				if ( is_combine_wrap ) {
					// Let's add the left and right spacer
					if ( combine_left_spacer > 0 ) {
						if ( prev_wrapper && prev_wrapper.spacer ) {
							prev_wrapper.modules[0].model.replace_class(ed.grid.class + (prev_wrapper.col+combine_left_spacer));
							prev_wrapper.model.replace_class(ed.grid.class + (prev_wrapper.col+combine_left_spacer));
						}
						else {
							group_wrapper_view.add_spacer('left', combine_left_spacer, col);
						}
					}
					if ( combine_right_spacer > 0 ) {
						if ( next_wrapper && next_wrapper.spacer ) {
							next_wrapper.modules[0].model.replace_class(ed.grid.class + (next_wrapper.col+combine_right_spacer));
							next_wrapper.model.replace_class(ed.grid.class + (next_wrapper.col+combine_right_spacer));
						}
						else {
							group_wrapper_view.add_spacer('right', combine_right_spacer, col-combine_left_spacer);
						}
					}
				}
				else {
					// Also remove prev/next spacer if exists
					if ( prev_wrapper && prev_wrapper.spacer ) {
						region_wrappers.remove(prev_wrapper.model);
						region_modules.remove(prev_wrapper.modules[0].model, {update: false});
					}
					if ( next_wrapper && next_wrapper.spacer ) {
						region_wrappers.remove(next_wrapper.model);
						region_modules.remove(next_wrapper.modules[0].model, {update: false});
					}
					// Add the queued spacers
					_.each(add_spacer_queue, function(add){
						add.view.add_spacer(add.position, add.col, add.wrapper_col);
					});
					// As this isn't combined, we remove the group wrapper
					region_wrappers.remove(group_wrapper);
				}
				region_modules.remove(this.model);
				//this.remove();
				ed.update_position_data($wrap.closest('.upfront-editable_entities_container'));
				ed.update_wrappers(region);
				Upfront.Events.trigger("entity:module_group:ungroup", modules_arr, region);
			},
			_update_padding: function (dir, object, add) {
				var padding_use = object.get_breakpoint_property_value(dir+'_padding_use', true),
					padding_num = object.get_breakpoint_property_value(dir+'_padding_num', true),
					column_padding = Upfront.Views.breakpoints_storage.get_breakpoints().get_active().get('column_padding')
				;
				if ( add === 0 ) return;
				object.set_breakpoint_property(dir+'_padding_use', 'yes');
				if ( padding_num !== false) {
					object.set_breakpoint_property(dir+'_padding_num', parseInt(padding_num, 10) + parseInt(add, 10));
				}
				else {
					object.set_breakpoint_property(dir+'_padding_num', parseInt(column_padding, 10) + parseInt(add, 10));
				}

			},
			on_reorder: function () {
				Upfront.Events.trigger("command:module_group:finish_edit"); // close other reorder first
				var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
				$main.addClass('upfront-module-group-editing');
				this.$el.addClass('upfront-module-group-on-edit');
				this.editing = true;
				this.disable_interaction(false, false);
				this.toggle_modules_interaction(true, false);
				Upfront.Events.trigger('entity:module_group:edit', this, this.model);
			},
			on_edit: function () {
				Upfront.Events.trigger("command:module_group:finish_edit"); // close other reorder first
				var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
				$main.addClass('upfront-module-group-editing');
				this.$el.addClass('upfront-module-group-on-edit');
				this.trigger('deactivated');
				this.editing = true;
				this.disable_interaction(false, false, false);
				this.toggle_modules_interaction(true, true);
				Upfront.Events.trigger('entity:module_group:edit', this, this.model);
			},
			on_finish: function () {
				if ( !this.editing ){
					return;
				}
				var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
				$main.removeClass('upfront-module-group-editing');
				this.$el.removeClass('upfront-module-group-on-edit');
				this.editing = false;
				this.enable_interaction();
				this.toggle_modules_interaction(false);
			},
			on_resize: function (attr) {
				var wrappers = this.model.get('wrappers');
				wrappers.each(function(wrapper){
					var view = Upfront.data.wrapper_views[wrapper.cid];
					if ( !view )
						return;
					view.update_position();
				});
				this.update_size_hint();
			},
			on_dblclick: function (e) {
				// We don't want to activate the Group when Settings sidebar is open
				if($('#element-settings-sidebar').html() !== '' || $('#settings').html() !== '') return false;
				if ( this.$el.hasClass('upfront-module-group-on-edit') || this.$el.hasClass('upfront-module-group-disabled') ) return;
				this.closeControlPanel(false);
				this.on_edit();
			},
			on_hide_click: function (e) {
				_Upfront_EditableEntity.prototype.on_hide_click.call(this, e);
				this.closeControlPanel(false);
				this.deactivate();
				e.stopPropagation();
				Upfront.Events.trigger("entity:module_group:hide_toggle", this, this.model);
			},
			disable_interaction: function (prevent_edit, resize, drag) {
				if ( prevent_edit ) {
					this.$el.addClass('upfront-module-group-disabled');
				}
				if ( !resize && this.$el.data('ui-resizable') ) {
					this.$el.resizable('option', 'disabled', true);
				}
				if ( !drag && this.$el.data('ui-draggable') ) {
					this.$el.draggable('option', 'disabled', true);
				}
			},
			enable_interaction: function () {
				if ( this.editing || this.hidden ) return; // Don't enable interaction if it's on editing/hidden
				this.$el.removeClass('upfront-module-group-disabled');
				if ( this.$el.data('ui-resizable') ) {
					this.$el.resizable('option', 'disabled', false);
				}
				if ( this.$el.data('ui-draggable') ) {
					this.$el.draggable('option', 'disabled', false);
				}
			},
			toggle_modules_interaction: function (enable, can_edit) {
				var can_edit = can_edit === true ? true : false;
				this.model.get('modules').each(function(module){
					var module_view = Upfront.data.module_views ? Upfront.data.module_views[module.cid] : false;
					if ( module_view ) {
						if ( enable ) {
							module_view.enable_interaction(true);
							module_view.disable_interaction(!can_edit, false, true, true, !can_edit);
						}
						else {
							module_view.disable_interaction(true, false, false, false, true);
						}
					}
				});
			},
			on_change_breakpoint: function (breakpoint) {
				var $hide = this.$el.find('> .upfront-entity_meta > a.upfront-entity-hide_trigger');
				if ( !breakpoint.default ){
					this.$el.addClass('upfront-module-group-reorder-mode');
					$hide.show();
				}
				else {
					this.$el.removeClass('upfront-module-group-reorder-mode');
					$hide.hide();
				}
				this.on_finish(); // make sure to close editing
				this.update_position();
				this.update_background();
			},
			deactivate: function () {
				// We don't want to deactivate the Group when Settings sidebar is open
				if($('#element-settings-sidebar').html() !== '' || $('#settings').html() !== '') return false;
				Upfront.data.prevEntity = false;
				this.$el.removeClass("upfront-module-group-active");
				this.check_deactivated();
				this.trigger("upfront:entity:deactivate", this);
			},
			activate: function () {
				var me= this,
					currentEntity = Upfront.data.currentEntity
				;
				if (this.hidden) return false;
				// Deactivate previous ObjectView
				if(typeof(Upfront.data.prevEntity) !== 'undefined' && Upfront.data.prevEntity !== false) {
					Upfront.data.prevEntity.deactivate();
				}
				Upfront.data.prevEntity = this;
				if (this.activate_condition && !this.activate_condition()) return false;
				if (currentEntity && currentEntity == this) return false;
				if (currentEntity && currentEntity != this) {
					currentEntity.trigger('deactivated');
				}

				Upfront.data.currentEntity = this;
				this.trigger("activated", this);
				this.trigger("upfront:entity:activate", this);
				this.listenToOnce(this, 'deactivated', this.deactivate);
				this.$el.addClass("upfront-module-group-active");
			},
			remove: function(){
				if (this._modules_view) {
					this._modules_view.remove();
				}
				var wrappers = this.model.get('wrappers');
				if (wrappers) {
					wrappers.each(function(wrapper){
						var wrapperView = Upfront.data.wrapper_views[wrapper.cid];
						if(wrapperView){
							wrapperView.remove();
							delete Upfront.data.wrapper_views[wrapper.cid];
						}
					});
				}
				if (this.panel) {
					this.panel.remove();
					this.panel = false;
				}
				this.region_view = false;
				this.region = false;
				Backbone.View.prototype.remove.call(this);
				this.model.get('wrappers').reset([], {silent:true});
				this.model = false;
			}
		}),

		Modules = _Upfront_EditableEntities.extend({
			className: "upfront-editable_entities_container",
			init: function () {
				// this.model.unbind('add', this.render, this);
				// this.model.bind('add', this.on_add, this);
				// this.model.unbind('remove', this.render, this);
				// this.model.bind('remove', this.on_remove, this);
				// this.model.bind('reset', this.on_reset, this);
				this.stopListening(this.model, 'add', this.render);
				this.listenTo(this.model, 'add', this.on_add);
				this.stopListening(this.model, 'remove', this.render);
				this.listenTo(this.model, 'remove', this.on_remove);
				this.listenTo(this.model, 'reset', this.on_reset);

				this.listenTo(Upfront.Events, "entity:drag_stop", this.on_drop);
				this.listenTo(Upfront.Events, "entity:resized", this.on_resize);
				this.listenTo(Upfront.Events, "entity:wrapper:resized", this.on_wrapper_resize);
				this.listenTo(Upfront.Events, "entity:wrappers:update", this.on_wrappers_update);
				this.listenTo(Upfront.Events, "entity:module:hide_toggle", this.on_module_hide);
				this.listenTo(Upfront.Events, "entity:module_group:hide_toggle", this.on_module_hide);
				this.listenTo(Upfront.Events, "entity:object:refresh", this.on_object_refresh);
				this.listenTo(Upfront.Events, "entity:module_group:group", this.on_group);
				this.listenTo(Upfront.Events, "entity:module_group:ungroup", this.on_ungroup);
				this.listenTo(Upfront.Events, "layout:after_render", this.on_after_layout_render);
				this.listenTo(Upfront.Events, "upfront:csseditor:ready", this.on_csseditor_ready);
				this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.on_change_breakpoint);
			},
			on_entity_remove: function(e, view) {
				Upfront.Events.trigger("entity:removed:before");
				var wrapper_id = view.model.get_wrapper_id(),
					me = this;
				if ( wrapper_id ){
					var wrappers = this.region_view.model.get('wrappers'),
						wrapper = wrappers.get_by_wrapper_id(wrapper_id),
						wrapper_module = 0;
					if ( wrapper ){
						// check if this wrapper has another module
						this.model.each(function(module){
							if ( module.get_wrapper_id() == wrapper_id )
								wrapper_module++;
						});
						if ( wrapper_module == 1 ){
							Upfront.Behaviors.GridEditor.normalize_module_remove(view, view.model, this.model, wrapper, wrappers);
							wrappers.remove(wrapper);
						}
					}
				}
				view.remove();
				this.model.remove(view.model);
				Upfront.Events.trigger("entity:removed:after");
			},
			render: function () {
				this.$el.html('');
				var $el = this.$el,
					me = this;
				this.current_wrapper_id = this.current_wrapper_el = null;
				Upfront.Events.trigger("entity:modules:before_render", this, this.model);
				if ( typeof Upfront.data.module_views == 'undefined' )
					Upfront.data.module_views = {};
				if ( typeof Upfront.data.wrapper_views == 'undefined' )
					Upfront.data.wrapper_views = {};
				this.model.each(function (module) {
					me.render_module(module);
				});
				this.apply_flexbox_clear();
				this.apply_wrapper_height();
				Upfront.Events.trigger("entity:modules:after_render", this, this.model);
			},
			render_module: function (module, options) {
				var $el = this.$el,
					index = options && typeof options.index != 'undefined' ? options.index-1 : -2,
					$el_index = index >= 0 ? $el.find('> .upfront-wrapper > .upfront-module-view, > .upfront-wrapper > .upfront-module-group').eq(index) : false,
					default_view_class = module.get('modules') ? "ModuleGroup" : "Module",
					view_class_prop = module.get("properties").where({"name": "view_class"}),
					view_class = view_class_prop.length ? view_class_prop[0].get("value") : default_view_class,
					//view_class = Upfront.Views[view_class] ? view_class : "Module",
					local_view = Upfront.Views[view_class] ? Upfront.data.module_views[module.cid] || new Upfront.Views[view_class]({model: module}): false,
					wrappers = (typeof this.group_view != 'undefined' ? this.group_view : this.region_view).model.get('wrappers'),
					wrapper_id = module.get_wrapper_id(),
					wrapper = wrappers && wrapper_id ? wrappers.get_by_wrapper_id(wrapper_id) : false,
					wrapper_view, wrapper_el
				;
				if(local_view){
					local_view.parent_view = this;
					local_view.region_view = this.region_view;
					local_view.region = this.region_view.model;
					if ( this.group_view ) {
						local_view.group_view = this.group_view;
					}
					if ( !wrapper ){
						local_view.render();
						if ( index === -2 ) {
							$el.append(local_view.el);
						}
						else if ( index === -1 ) {
							$el.prepend(local_view.el);
						}
						else {
							$el_index.parent().after(local_view.el);
						}
					}
					else {
						if ( this.current_wrapper_id == wrapper_id ){
							wrapper_el = this.current_wrapper_el;
						}
						else {
							wrapper_view = Upfront.data.wrapper_views[wrapper.cid];
							if ( !wrapper_view ) {
								wrapper_view = new Upfront.Views.Wrapper({model: wrapper})
								wrapper_view.parent_view = this;
								wrapper_view.render();
							}
							else {
								wrapper_view.parent_view = this;
							}
							wrapper_el = wrapper_view.el;
							local_view.wrapper_view = wrapper_view;
						}
						this.current_wrapper_id = wrapper_id;
						this.current_wrapper_el = wrapper_el;
						if ( wrapper_view ){
							if ( index === -2 ) {
								$el.append(wrapper_el);
							}
							else if ( index === -1 ) {
								$el.prepend(wrapper_el);
							}
							else {
								$el_index.closest('.upfront-wrapper').after(wrapper_el);
							}
							if ( ! Upfront.data.wrapper_views[wrapper.cid] ) {
								Upfront.data.wrapper_views[wrapper.cid] = wrapper_view;
							}
						}
						if ( $el_index !== false ){
							if ( $el_index.closest('.upfront-wrapper').get(0) == wrapper_el ) {
								$el_index.after(local_view.el);
							}
							else {
								$(wrapper_el).prepend(local_view.el);
							}
						}
						else if ( index === -1 ) {
							$(wrapper_el).prepend(local_view.el);
						}
						else {
							$(wrapper_el).append(local_view.el);
						}
						local_view.render();
					}
					if ( ! Upfront.data.module_views[module.cid] ){
						//local_view.bind("upfront:entity:activate", this.on_activate, this);
						//local_view.model.bind("remove", this.deactivate, this);
						//local_view.listenTo(local_view.model, 'remove', this.deactivate);

						this.listenTo(local_view, 'upfront:entity:activate', this.on_activate);
						this.listenTo(local_view.model, 'remove', this.deactivate);
						Upfront.data.module_views[module.cid] = local_view;
					}
					else {
						local_view.delegateEvents();
					}
				}
				Upfront.Events.trigger('entity:modules:render_module', local_view, local_view.model, this, this.model);
			},
			on_wrappers_update: function (parent_model) {
				if ( _.isObject(parent_model) && parent_model.get('modules') != this.model ) return;
				this.model.each(function(module){
					var local_view = Upfront.data.module_views[module.cid];
					if ( ! local_view ) return;
					local_view.update_position();
				});
				this.apply_flexbox_clear();
				this.apply_wrapper_height();
			},
			on_drop: function (view, model) {
				if ( view.parent_view && view.parent_view != this ) return;
				//this.apply_flexbox_clear();
				this.apply_wrapper_height();
				this.apply_adapt_to_breakpoints();
			},
			on_resize: function (view, model) {
				if ( view.parent_view && view.parent_view != this ) return;
				//this.apply_flexbox_clear();
				this.apply_wrapper_height();
				this.apply_adapt_to_breakpoints();
			},
			on_wrapper_resize: function (view, model) {
				if ( view.parent_view && view.parent_view != this ) return;
				//this.apply_flexbox_clear();
				this.apply_wrapper_height();
				this.apply_adapt_to_breakpoints();
			},
			on_module_hide: function (view, model) {
				if ( view.parent_view && view.parent_view != this ) return;
				//this.apply_flexbox_clear();
				this.apply_wrapper_height();
				this.apply_adapt_to_breakpoints();
			},
			on_object_refresh: function (view) {
				if ( !view.parent_module_view ) return;
				if ( view.parent_module_view.parent_view && view.parent_module_view.parent_view != this ) return;
				this.apply_wrapper_height();
			},
			on_add: function (model, collection, options) {
				var update = typeof options.update != 'undefined' ? options.update : true;
				this.current_wrapper_id = this.current_wrapper_el = null;
				this.render_module(model, options);
				if ( update ) {
					//this.apply_flexbox_clear();
					this.apply_wrapper_height();
					this.apply_adapt_to_breakpoints();
				}
				Upfront.Events.trigger("entity:added:after");
			},
			on_remove: function (model, collection, options) {
				var update = typeof options.update != 'undefined' ? options.update : true;
				this.remove_model(model);
				if ( update ) {
					this.apply_wrapper_height();
					this.apply_adapt_to_breakpoints();
				}
			},
			remove_model: function (model) {
				var view = Upfront.data.module_views[model.cid];
				if ( !view ) return;
				view.unbind();
				view.remove();
				delete Upfront.data.module_views[model.cid];
			},
			on_reset: function (collection, options) {
				var me = this;
				if ( options && options.call_render ){
					_.each(options.call_render, function(module){
						var index = collection.indexOf(module);
						me.render_module(module, {index: index});
					});
					this.apply_flexbox_clear();
					this.apply_wrapper_height();
					this.apply_adapt_to_breakpoints();
				}
			},
			on_after_layout_render: function () {
				this.apply_flexbox_clear();
				this.apply_adapt_to_breakpoints();
				var me = this;
				setTimeout(function(){
					me.apply_wrapper_height();
				}, 1000); // Wait for other positioning finished
			},
			on_csseditor_ready: function () {
				//this.apply_wrapper_height();
			},
			normalize_child_modules: function (col, prev_col, wrappers) {
				var breakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),
					me = this,
					ed = Upfront.Behaviors.GridEditor,
					modules = this.model,
					use_col = _.isNumber(prev_col) ? prev_col : col,
					lines = ed.parse_modules_to_lines(modules, wrappers, ( breakpoint ? breakpoint.id : 'desktop' ), use_col)
				;
				_.each(lines, function (line) {
					var diff_col = col - line.col,
						total_diff = 0,
						outstanding_diff = 0,
						prev_outstanding_diff = 0,
						outstanding_col = 0,
						all_wrappers = [],
						spacer_wrappers = [],
						el_wrappers = []
					;
					if ( diff_col == 0 ) return;
					_.each(line.wrappers, function (w) {
						w.ratio = w.col/use_col;
						w.apply_diff = Math.round(w.ratio * diff_col);
						if ( w.col + w.apply_diff <= 0 ) w.apply_diff = 0;
						total_diff += w.apply_diff;
						all_wrappers.push(w);
						if ( w.spacer ) spacer_wrappers.push(w);
						else el_wrappers.push(w);
					});
					if ( all_wrappers.length == spacer_wrappers.length ) {
						// everything is spacer, remove it
						_.each(spacer_wrappers, function (w) {
							_.each(w.modules, function (m) {
								modules.remove(m.model);
							});
							wrappers.remove(w.model);
						});
						return;
					}
					outstanding_diff = total_diff - diff_col;
					if ( outstanding_diff != 0 ) {
						outstanding_col = outstanding_diff > 0 ? -1 : 1;
						while ( outstanding_diff != 0 ) {
							prev_outstanding_diff = outstanding_diff;
							_.each(diff_col > 0 ? _.union(el_wrappers, spacer_wrappers) : _.union(spacer_wrappers, el_wrappers), function (w) {
								if ( outstanding_diff == 0 ) return;
								if ( w.col + w.apply_diff + outstanding_col <= 0 ) return;
								w.apply_diff += outstanding_col;
								outstanding_diff += outstanding_col;
							});
							// No changes? Somethings wrong, let's break
							if ( prev_outstanding_diff == outstanding_diff ) break;
						}
					}
					_.each(all_wrappers, function (w) {
						var apply_col = w.col + w.apply_diff,
							w_breakpoint = w.model.get_property_value_by_name('breakpoint'),
							w_breakpoint_data = ( w_breakpoint && breakpoint.id in w_breakpoint ) ? w_breakpoint[breakpoint.id] : {}
						;
						if ( !breakpoint || breakpoint.default ) {
							w.model.replace_class(ed.grid.class + apply_col);
							_.each(w.modules, function (m) {
								m.model.replace_class(ed.grid.class + apply_col);
							});
						}
						else {
							w_breakpoint_data.col = apply_col;
							w.model.set_property('breakpoint', Upfront.Util.clone(w_breakpoint));
							_.each(w.modules, function (m) {
								var m_breakpoint = m.model.get_property_value_by_name('breakpoint'),
									m_breakpoint_data = ( m_breakpoint && breakpoint.id in m_breakpoint ) ? m_breakpoint[breakpoint.id] : {}
									;
								m_breakpoint_data.col = apply_col;
								m.model.set_property('breakpoint', Upfront.Util.clone(m_breakpoint));
							});
						}
					});
				});
			},
			apply_flexbox_clear: function () {
				this.fix_flexbox_clear(this.$el);
			},
			apply_wrapper_height: function () {
				if ( !Upfront.Application.layout_ready ) return;
				if ( !this.region_view || this.region_view.model.get('name') == 'shadow' ) return;
				var ed = Upfront.Behaviors.GridEditor,
					breakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),
					is_group = !_.isUndefined(this.group_view),
					wrappers = ( is_group ? this.group_view : this.region_view ).model.get('wrappers'),
					col = breakpoint.default
						? ed.get_class_num(( is_group ? this.group_view : this.region_view ).$el, ed.grid.class)
						: ( is_group ? this.group_view : this.region_view ).model.get_breakpoint_property_value('col')
				;
				this.model.each(function (module) {
					var local_view = Upfront.data.module_views[module.cid];
					if ( !local_view || !local_view._modules_view ) return;
					local_view._modules_view.apply_wrapper_height();
				});
				this.fix_wrapper_height(this.model, wrappers, col);
			},
			apply_adapt_to_breakpoints: function () {
				var current_breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint;
				if ( current_breakpoint && !current_breakpoint.default )
					return;
				// Don't do anything on shadow region
				if ( this.region_view && this.region_view.model.get('name') == 'shadow' )
					return;
				var me = this,
					ed = Upfront.Behaviors.GridEditor,
					is_group = ( typeof this.group_view != 'undefined' ),
					wrappers = ( is_group ? this.group_view : this.region_view ).model.get('wrappers'),
					breakpoints = Upfront.Views.breakpoints_storage.get_breakpoints().get_enabled();
				_.each(breakpoints, function(each){
					var breakpoint = each.toJSON();
					if ( breakpoint.default )
						return;
					if ( is_group ) {
						var group_col = ed.get_class_num(me.group_view.$el, ed.grid.class),
							breakpoint_data = me.group_view.model.get_property_value_by_name('breakpoint');
						if ( _.isObject(breakpoint_data) && _.isObject(breakpoint_data[breakpoint.id]) && !_.isUndefined(breakpoint_data[breakpoint.id].col) )
							group_col = breakpoint_data[breakpoint.id].col;
					}
					var col = is_group ? group_col : breakpoint.columns;
					ed.adapt_to_breakpoint(me.model, wrappers, breakpoint.id, col, true);
				});
			},
			on_group: function (group) {
				if ( typeof this.group_view == 'undefined' || group.cid != this.group_view.model.cid )
					return;
				this.reset_breakpoints(this.model.map(function(module){ return module; }));
			},
			on_ungroup: function (modules) {
				if ( modules && modules[0] && !this.model.find(function(module){ return module.cid == modules[0].cid }) )
					return;
				this.reset_breakpoints(modules);
			},
			reset_breakpoints: function (modules) {
				_.each(modules, function(module){
					var breakpoint = Upfront.Util.clone( module.get_property_value_by_name('breakpoint') || {} );
					_.each(breakpoint, function(data, id){
						breakpoint[id].edited = false;
					});
					module.set_property('breakpoint', breakpoint, true);
				});
				this.apply_adapt_to_breakpoints();
			},
			on_change_breakpoint: function (breakpoint) {
				var me = this;
				// Make sure clearing flexbox is applied, set a timeout to let other positioning finish
				setTimeout(function(){
					me.apply_flexbox_clear();
					me.apply_wrapper_height();
				}, 1000);
			},
			remove: function() {
				var me = this;
				this.model.each(function(model){
					me.remove_model(model);
				});
				this.region_view = false;
				this.group_view = false;
				Backbone.View.prototype.remove.call(this);
				this.model.reset([], {silent:true});
				this.model = false;
			}
		}),

		RegionContainer = _Upfront_SingularEditor.extend({
			cssSelectors: {
				'.upfront-region-container-bg': {label: l10n.region_container_label, info: l10n.region_container_info},
				'.upfront-region-center': {label: l10n.main_content_label, info: l10n.main_content_info},
				'.upfront-region-side-left': {label: l10n.lsr_label, info: l10n.lsr_info},
				'.upfront-region-side-right': {label: l10n.rsr_label, info: l10n.rsr_info}
			},
			events: {
				"click > .upfront-region-edit-trigger": "trigger_edit",
				"click > .upfront-region-edit-fixed-trigger": "trigger_edit_fixed",
				"click > .upfront-region-finish-edit": "finish_edit" ,
				"contextmenu": "on_context_menu",
				"mouseover": "on_mouse_over"
			},
			attributes: function(){
				var name = ( this.model.get("container") || this.model.get("name") ).toLowerCase().replace(/\s/g, "-"),
					classes = [];
				classes.push('upfront-region-container');
				classes.push('upfront-region-container-' + name);
				classes.push('upfront-region-container-' + this._get_region_type() );
				if ( _.isObject(this.model.collection) && this.model.collection.active_region == this.model ){
					classes.push('upfront-region-container-active');
				}
				return {
					"class": classes.join(' '),
					"id": 'region-container-' + name
				};
			},
			_get_region_type: function () {
				return this.model.get('type') || ( this.model.get('clip') ? 'clip' : 'wide' );
			},
			_get_previous_region_type: function () {
				return this.model.previous('type') || ( this.model.previous('clip') ? 'clip' : 'wide' );
			},
			/*_get_full_size_el: function ($el, ratio, inside) {
				var is_full_screen = ( this._get_region_type() == 'full' ),
					width = $el.width(),
					win_height = $(window).height(),
					height = is_full_screen ? win_height : $el.height();
				return this._get_full_size(width, height, ratio, inside);
			},*/
			on_mouse_over: function () {
				var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
				if ( $main.hasClass('upfront-region-fixed-editing') )
					this.trigger('activate_region', this);
				//this.update_pos();
			},
			remove_context_menu: function(e) {
				if (!this.context_menu_view) return false;
				$(Upfront.Settings.LayoutEditor.Selectors.contextmenu).html('').hide();
				this.context_menu_view = false;

			},
			on_context_menu: function(e) {
				if($(e.target).closest('.upfront-inline-modal-content').length > 0) {
					e.stopPropagation();
					return;
				}
				if (Upfront.Settings.Application.no_context_menu) return;

				e.preventDefault();
				this.event = e;
				//Upfront.Events.trigger("entity:contextmenu:activate", this);
				if(this.context_menu_view) {
					return this.context_menu_view.render();
				}

				var context_menu_view = new this.ContextMenu({
					model: this.model,
					el: $(Upfront.Settings.LayoutEditor.Selectors.contextmenu)
				});

				context_menu_view.for_view = this;
				this.context_menu_view = context_menu_view;

				return this.context_menu_view.render();

			},
			init: function () {
				var me = this;
				var ContextMenuList = Upfront.Views.ContextMenuList.extend({
					initialize: function() {

						this.menuitems = _([
						  new Upfront.Views.ContextMenuItem({
							  get_label: function() {
								  var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
				 				  if($main.hasClass('upfront-region-editing'))
								  	return l10n.finish_editing;
								  else
								  	return l10n.edit_background;
							  },
							  action: function() {
							  		var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
				 				  if($main.hasClass('upfront-region-editing'))
								  	me.close_edit();
								  else
								  	me.trigger_edit(me.event);

							  }
						  }),

						  new Upfront.Views.ContextMenuItem({
							  get_label: function() {
								  	return l10n.add_floating_region;
							  },
							  action: function(view, e) {
							  		var $main = $(Upfront.Settings.LayoutEditor.Selectors.main),
							  			collection = me.model.collection,
							  			index = collection.indexOf(me.model),
							  			fixed = me.model.get_sub_region('fixed'),
							  			title = me.model.get('title') + " Floating " + (fixed.length+1),
							  			name = title.toLowerCase().replace(/\s/g, '-'),
								  		new_region = new Upfront.Models.Region(_.extend(_.clone(Upfront.data.region_default_args), {
											"name": name,
											"container": me.model.get('name'),
											"title": title,
											"type": 'fixed',
											"sub": 'fixed',
											"scope": me.model.get('scope')
										})),
							  			offset = me.$el.offset(),
							  			width = me.$el.width(),
							  			height = me.$el.height(),
							  			window_h = $(window).height(),
							  			new_region_w = 225,
							  			new_region_h = 225,
										end_t, pos_x, pos_y, prop_x, prop_y;
									new_region.set_property('width', new_region_w);
									new_region.set_property('height', new_region_h);
									if ( e.pageX > offset.left + (width/2) ){
										pos_x = offset.left + width - e.pageX - Math.floor(new_region_w/2);
										prop_x = 'right';
									}
									else {
										pos_x = e.pageX - offset.left - Math.floor(new_region_w/2);
										prop_x = 'left';
									}
									if ( height >= window_h && e.clientY > window_h/2 ){
										pos_y = window_h - e.clientY - Math.floor(new_region_h/2);
										prop_y = 'bottom';
									}
									else {
										pos_y = e.clientY - Math.floor(new_region_h/2);
										prop_y = 'top';
									}
									pos_x = pos_x > 0 ? pos_x : 0;
									pos_y = pos_y > 0 ? pos_y : 0;
									new_region.set_property(prop_x, pos_x);
									new_region.set_property(prop_y, pos_y);
									new_region.set_property('background_type', 'color');
									new_region.set_property('background_color', '#aeb8c2');
									Upfront.Events.once('entity:region:added', run_animation, this);
									new_region.add_to(collection, index+1, {sub: 'fixed'});
				 				 	if(!$main.hasClass('upfront-region-fixed-editing'))
								  		me.trigger_edit_fixed(me.event);
								  	function run_animation(view, model){
										var ani_event_end = 'animationend.fixed_region_ani webkitAnimationEnd.fixed_region_ani MSAnimationEnd.fixed_region_ani oAnimationEnd.fixed_region_ani';
								  		end_t = setTimeout(end, 2000);
								  		view.$el.addClass("upfront-add-region-ani upfront-add-region-ani-" + prop_y + '-' + prop_x);
										view.$el.one(ani_event_end, function () {
											end(view);
											clearTimeout(end_t);
											view.$el.off(ani_event_end); // Make sure to remove any remaining unfired event
										});
								  	}
									function end (view) {
										view.$el.removeClass("upfront-add-region-ani upfront-add-region-ani-" + prop_y + '-' + prop_x);
										Upfront.Events.trigger('command:region:fixed_edit_toggle', true);
									}
							  }
						  })
						]);
					}
				});

				this.ContextMenu = Upfront.Views.ContextMenu.extend({
					initialize: function() {
						this.menulists = _([
						  new ContextMenuList()
						]);
					}
				});


				var grid = Upfront.Settings.LayoutEditor.Grid,
					width = this.model.get_property_value_by_name('width');
				this.sub_model = [];
				this.max_col = width ? Upfront.Util.width_to_col(width) : grid.size;
				this.available_col = this.max_col;

				// this.model.get("properties").bind("change", this.update, this);
				// this.model.get("properties").bind("add", this.update, this);
				// this.model.get("properties").bind("remove", this.update, this);
				this.listenTo(this.model.get("properties"), 'change', this.update);
				this.listenTo(this.model.get("properties"), 'add', this.update);
				this.listenTo(this.model.get("properties"), 'remove', this.update);
				this.listenTo(Upfront.Events, "entity:region:activated", this.update_pos);
				this.listenTo(Upfront.Events, "entity:region:activated", this.update_overlay);
				this.listenTo(Upfront.Events, "entity:region:deactivated", this.close_edit);
				this.listenTo(Upfront.Events, "layout:after_render", this.fix_height);
				this.listenTo(Upfront.Events, "entity:resize_stop", this.fix_height);
				this.listenTo(Upfront.Events, "entity:region:resize_stop", this.fix_height);
				this.listenTo(Upfront.Events, "entity:region_container:resize_stop", this.fix_height);
				this.listenTo(Upfront.Events, "entity:region_container:resize_stop", this.update_overlay);
				this.listenTo(Upfront.Events, "entity:drag_stop", this.fix_height);
				this.listenTo(Upfront.Events, "entity:drag:drop_change", this.refresh_background);
				this.listenTo(Upfront.Events, "sidebar:toggle:done", this.refresh_background);
				this.listenTo(Upfront.Events, "entity:navigation:responsive_open", this.refresh_background);
				this.listenTo(Upfront.Events, "entity:navigation:responsive_close", this.refresh_background);
				this.listenTo(Upfront.Events, "entity:region:added", this.fix_height);
				this.listenTo(Upfront.Events, "entity:region:removed", this.on_region_remove);
				this.listenTo(Upfront.Events, "entity:region:hide_toggle", this.on_region_hide);
				this.listenTo(Upfront.Events, "entity:module_group:group", this.fix_height);
				this.listenTo(Upfront.Events, "entity:module_group:ungroup", this.fix_height);
				this.listenTo(Upfront.Events, "upfront:layout:contained_region_width", this.on_contained_width_change);
				this.listenTo(Upfront.Events, 'layout:after_render', this.update_pos);
				this.listenTo(Upfront.Events, "sidebar:toggle:done", this.update_pos);
				this.listenTo(Upfront.Events, "application:mode:after_switch", this.update_pos);
				$(window).on('scroll.region_container_' + this.model.get('name'), this, this.on_scroll);
				$(window).on('resize.region_container_' + this.model.get('name'), this, this.on_window_resize);

				// breakpoint changes
				this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.on_change_breakpoint);

				this.listenTo(Upfront.Events, "entity:contextmenu:deactivate", this.remove_context_menu);

				this.lazyFixHeight = _.debounce(this.fix_height, 1000);
			},
			render: function () {
				var grid = Upfront.Settings.LayoutEditor.Grid,
					type = this._get_region_type(),
					data = _.extend(this.model.toJSON(), {size_class: grid.class, max_col: this.max_col, available_col: this.available_col}),
					template = _.template(_Upfront_Templates["region_container"], data),
					$edit = $('<div class="upfront-region-edit-trigger upfront-ui" title="' + l10n.change_background + '"><i class="upfront-icon upfront-icon-region-edit"></i></div>'),
					$finish = $('<div class="upfront-region-finish-edit upfront-ui"><i class="upfront-field-icon upfront-field-icon-tick"></i> ' + l10n.finish_edit_bg + '</div>');
				Upfront.Events.trigger("entity:region_container:before_render", this, this.model);
				this.$el.html(template);
				this.$bg = this.$el.find('.upfront-region-container-bg');
				this.$layout = this.$el.find('.upfront-grid-layout');
				$edit.appendTo(this.$el);
				//$edit_fixed.appendTo(this.$el);
				$finish.appendTo(this.$el);
				//this.render_fixed_panel();
				this.update();
				//if ( type != 'clip' )
					this.$el.append('<div class="upfront-region-active-overlay" />');
				Upfront.Events.trigger("entity:region_container:after_render", this, this.model);
			},
			update: function () {
				var me = this,
					grid = Upfront.Settings.LayoutEditor.Grid,
					name = ( this.model.get("container") || this.model.get("name") ).toLowerCase().replace(/\s/g, "-"),
					previous_name = ( this.model.previous("container") || this.model.previous("name") ).toLowerCase().replace(/\s/g, "-"),
					expand_lock = this.model.get_property_value_by_name('expand_lock'),
					type = this._get_region_type(),
					previous_type = this._get_previous_region_type(),
					default_breakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_default().toJSON(),
					contained_width = Upfront.Application.layout.get_property_value_by_name('contained_region_width') || (default_breakpoint.columns * grid.column_width);
				if ( type == 'clip' )
					this.$bg.css('max-width', contained_width + 'px');
				else
					this.$bg.css('max-width', '');
				this.update_background();
				if ( previous_type != type ){
					this.$el.removeClass('upfront-region-container-' + previous_type);
					this.$el.addClass('upfront-region-container-' + type);
					_.delay(function(){
						me.fix_height();
						me.update_overlay();
					}, 500)
				}
				if ( previous_name != name ){
					this.$el.removeClass('upfront-region-container-' + previous_name);
					this.$el.addClass('upfront-region-container-' + name);
					this.$el.attr('id', 'region-container-' + name);
				}
			},
			render_fixed_panel: function () {
				this.region_fixed_panels = new Upfront.Views.Editor.RegionFixedPanels({model: this.model});
				this.region_fixed_panels.render();
				this.$el.append(this.region_fixed_panels.el);
			},
			on_change_breakpoint: function (breakpoint) {
				var grid = Upfront.Settings.LayoutEditor.Grid,
					me = this;
				this.$layout.removeClass(grid.class + this.max_col);
				this.max_col = breakpoint.columns;
				this.$layout.addClass(grid.class + this.max_col);
				this.update_background();
				setTimeout(function(){ me.fix_height(); }, 500);
			},
			on_contained_width_change: function (width) {
				var type = this._get_region_type();
				if ( type == 'clip' ) {
					this.$bg.css('max-width', width + 'px');
				}
				else {
					this.$bg.css('max-width', '');
				}
				this.refresh_background();
			},
			trigger_edit: function (e) {
				if ( Upfront.Application.get_current() == Upfront.Settings.Application.MODE.CONTENT )
					return false;
				var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
				$main.addClass('upfront-region-editing');
				this.update_overlay();
				Upfront.Events.trigger("command:region:edit_toggle", true);
				this.trigger("activate_region", this);
				this.listenTo(Upfront.Events, "command:newpage:start", this.close_edit);
				this.listenTo(Upfront.Events, "command:newpost:start", this.close_edit);
				this.$el.find('.upfront-region-edit-fixed-trigger').show();
				if ( Upfront.Application.sidebar.visible )
					Upfront.Application.sidebar.toggleSidebar();
				e.stopPropagation();
			},
			finish_edit: function (e) {
				Upfront.Events.trigger("entity:region:deactivated");
			},
			close_edit: function () {
				var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
				if ( !$main.hasClass('upfront-region-editing') && !$main.hasClass('upfront-region-fixed-editing') && !$main.hasClass('upfront-region-lightbox-editing') )
					return;
				$main.removeClass('upfront-region-editing');
				$main.removeClass('upfront-region-fixed-editing');
				$main.removeClass('upfront-region-lightbox-editing');
				this.remove_overlay();
				Upfront.Events.trigger("command:region:edit_toggle", false);
				Upfront.Events.trigger("command:region:fixed_edit_toggle", false);
				Upfront.Events.off("command:newpage:start", this.close_edit, this);
				Upfront.Events.off("command:newpost:start", this.close_edit, this);
				this.$el.find('.upfront-region-edit-fixed-trigger').hide();
				this.$el.find('.upfront-region-edit-lightbox-trigger').hide();
				if ( !Upfront.Application.sidebar.visible )
					Upfront.Application.sidebar.toggleSidebar();
				$('.upfront-region-container > .upfront-region-finish-edit').css({
					position: '',
					left: '',
					right: ''
				});
			},
			trigger_edit_lightbox: function(e) {
				if ( Upfront.Application.get_current() == Upfront.Settings.Application.MODE.CONTENT )
					return false;
				var me = this,
					$main = $(Upfront.Settings.LayoutEditor.Selectors.main);

				if ( $main.hasClass('upfront-region-editing') )
					this.close_edit();

				$main.addClass('upfront-region-lightbox-editing');

				this.trigger('activate_region', this);
				Upfront.Events.trigger("command:region:fixed_edit_toggle", true);
				//if ( Upfront.Application.sidebar.visible )
					//Upfront.Application.sidebar.toggleSidebar();
				setTimeout(function(){
					$('.upfront-region-container > .upfront-region-finish-edit').each(function(){
						$(this).css({
							position: 'fixed',
							left: (me.$layout.offset().left + me.$layout.width()) - $(this).width(),
							right: 'auto'
						});
					});
				}, 350);

			},
			trigger_edit_fixed: function () {
				if ( Upfront.Application.get_current() == Upfront.Settings.Application.MODE.CONTENT )
					return false;
				var me = this,
					$main = $(Upfront.Settings.LayoutEditor.Selectors.main);
				if ( $main.hasClass('upfront-region-editing') )
					this.close_edit();
				$main.addClass('upfront-region-fixed-editing');
				this.trigger('activate_region', this);
				Upfront.Events.trigger("command:region:fixed_edit_toggle", true);
				if ( Upfront.Application.sidebar.visible )
					Upfront.Application.sidebar.toggleSidebar();
				setTimeout(function(){
					$('.upfront-region-container > .upfront-region-finish-edit').each(function(){
						$(this).css({
							position: 'fixed',
							left: (me.$layout.offset().left + me.$layout.width()) - $(this).width(),
							right: 'auto'
						});
					});
				}, 350);
			},
			update_overlay: function () {
				var $main = $(Upfront.Settings.LayoutEditor.Selectors.main),
					pos = this.$el.position(),
					$before_overlay = $('<div class="upfront-region-editing-overlay" />'),
					$after_overlay = $('<div class="upfront-region-editing-overlay" />');
				if ( ! $main.hasClass('upfront-region-editing') )
					return;
				if ( this.parent_view.model.active_region != this.model )
					return;
				this.$el.siblings('.upfront-region-editing-overlay').remove();
				this.$el.before($before_overlay);
				$before_overlay.css({
					bottom: 'auto',
					height: pos.top
				});
				this.$el.after($after_overlay);
				$after_overlay.css({
					top: pos.top + this.$el.height()
				});
			},
			remove_overlay: function () {
				this.$el.siblings('.upfront-region-editing-overlay').remove();
			},
			add_sub_model: function (model) {
				this.sub_model.push(model);
			},
			on_scroll: function (e) {
				var me = e.data;
				me.update_pos();
			},
			on_region_render: function (region) {
			},
			on_region_update: function (region) {
				// Update flexible region column
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					col = this.max_col;
				_.each(this.sub_model, function (sub) {
					var sub_type = sub.get('sub');
					if ( !sub_type || sub_type == 'left' || sub_type == 'right' )
						col -= sub.get_property_value_by_name('col');
				});
				if ( !breakpoint || breakpoint.default ) {
					this.trigger("region_resize", col);
					this.available_col = col;
				}
				this.fix_height();
				this.update_overlay();
			},
			on_region_changed: function () {
				this.fix_height();
			},
			on_region_remove: function (view, model) {
				var sub = model.get('sub');
				this.fix_height();
				if ( !sub || !sub.match(/(top|bottom|left|right)/) )
					this.close_edit();
			},
			on_region_hide: function (hide, view) {
				var container = view.parent_view.get_container_view(view.model);
				if ( this != container )
					return;
				if ( hide && this.$el.find('.upfront-region-center, .upfront-region-side-left, .upfront-region-side-right').not('.upfront-region-hidden').length == 0 )
					this.close_edit();
			},
			on_window_resize: function (e) {
				if ( e.target != window || !e.data.model)
					return;
				var me = e.data;
				me.lazyFixHeight();
			},
			fix_height: function () {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint;
				// Don't need to adapt height if breakpoint isn't default or that flexbox is supported
				// Make sure to test with non-flexbox browser whenever possible
				if ( ( breakpoint && !breakpoint.default ) || this.$layout.css('display').indexOf('flex') != -1 ){
					this.set_full_screen();
					this.refresh_background();
					this.update_pos();
					return;
				}
				var $regions = this.$el.find('.upfront-region-center, .upfront-region-side-left, .upfront-region-side-right'),
					$sub = this.$el.find('.upfront-region-side-top, .upfront-region-side-bottom'),
					$container = $regions.find('> .upfront-region-wrapper > .upfront-modules_container'),
					height = 0;
				$regions.add($container).css({
					minHeight: "",
					height: "",
					maxHeight: ""
				});
				this.set_full_screen();
				$sub.each(function(){
					$(this).find('> .upfront-region-wrapper > .upfront-modules_container').css('min-height', $(this).outerHeight());
				});
				$regions.each(function(){
					var h = $(this).outerHeight();
					height = h > height ? h : height;
				});
				$regions.add($container).css('min-height', height);
				this.refresh_background();
				this.update_pos();
			},
			set_full_screen: function () {
				var $region = this.$layout.find('.upfront-region-center'),
					$sub = this.$bg.find('.upfront-region-side-top, .upfront-region-side-bottom'),
					row = this.model.get_breakpoint_property_value('row', true),
					min_height = row ? row * Upfront.Settings.LayoutEditor.Grid.baseline : 0,
					height = $(window).height();
				if ( this._get_region_type() == 'full' ) {
					this.$bg.children('.upfront-region-bg-overlay').css('height', height);
					$sub.each(function(){
						height -= $(this).outerHeight();
					});
					$region.css({
						minHeight: height
					});
					this.model.set_property('original_height', height, true);
				}
				else {
					this.$bg.children('.upfront-region-bg-overlay').css('height', '');
					$region.css({
						minHeight: ''
					});
					if ( min_height > 0 )
						$region.css('min-height', min_height);
					this.model.remove_property('original_height', true);
				}
			},
			update_pos: function () {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					$main = $(Upfront.Settings.LayoutEditor.Selectors.main),
					offset = this.$el.offset(),
					top = offset.top,
					height = this.$el.outerHeight(),
					bottom = top + height,
					scroll_top = $(document).scrollTop(),
					win_height = $(window).height(),
					scroll_bottom = scroll_top + win_height,
					main_off = $main.offset(),
					rel_top = main_off.top,
					$trig = this.$el.find('> .upfront-region-edit-trigger'),
					trig_offset = $trig.offset(),
					sticky = this.model.get('sticky'),
					sticky_top = this.$el.data('sticky-top');
				// Normalize scroll top value
				scroll_top = scroll_top < 0 ? 0 : scroll_top;
				// Sticky behavior
				// @TODO Need to have a proper behavior for responsive view, disable for now
				if ( breakpoint && !breakpoint.default )
					sticky = false;
				if ( sticky ) {
					if ( !_.isNumber(sticky_top) && scroll_top > top-rel_top ) {
						this.$el.css({
							position: 'fixed',
							top: rel_top,
							left: main_off.left,
							right: 0,
							bottom: 'auto'
						});
						this.$el.addClass('upfront-region-container-sticky');
						this.$el.data('sticky-top', top-rel_top);
						this.$el.nextAll('.upfront-region-container:first').css('margin-top', this.$el.height());
					}
				}
				if ( this.$el.css('position') == 'fixed' && ( !sticky || ( _.isNumber(sticky_top) && scroll_top <= sticky_top ) ) ) {
					this.$el.css({
						position: '',
						top: '',
						left: '',
						right: '',
						bottom: ''
					});
					this.$el.removeClass('upfront-region-container-sticky');
					this.$el.removeData('sticky-top');
					this.$el.nextAll('.upfront-region-container:first').css('margin-top', '');
				}

				// Keep background position on scroll for full screen region
				if ( this._get_region_type() == 'full' ) {
					var bg_type = this.model.get_breakpoint_property_value('background_type', true),
						full_screen_height = parseInt(this.$layout.find('.upfront-region-center').css('min-height'));
					if ( scroll_top >= top-rel_top && scroll_bottom <= bottom ) {
						this.$bg.children('.upfront-region-bg-overlay').css('top', ( scroll_top - rel_top ))
					}
					else {
						this.$bg.children('.upfront-region-bg-overlay').css('top', ( height - win_height ));
					}
				}


				if ( scroll_top > top-rel_top && scroll_top < bottom-rel_top ) {
					if ( $trig.css('position') != 'fixed' )
						$trig.css({
							position: 'fixed',
							top: rel_top,
							left: trig_offset.left,
							right: 'auto'
						});
				}
				else {
					$trig.css({
						position: '',
						top: '',
						left: '',
						right: ''
					});
				}
				if ( $main.hasClass('upfront-region-editing') && this.$el.hasClass('upfront-region-container-active') ){
					var $fin = this.$el.find('.upfront-region-finish-edit'),
						fin_offset = $fin.offset();
					if ( bottom+$fin.outerHeight() > scroll_bottom && top < scroll_bottom ){
						if ( $fin.css('position') != 'fixed' )
							$fin.css({
								position: 'fixed',
								bottom: 0,
								left: fin_offset.left,
								right: 'auto'
							});
					}
					else {
						$fin.css({
							position: '',
							bottom: '',
							left: '',
							right: ''
						});
					}
				}
			},
			remove: function(){
				$(window).off('scroll.region_container_' + this.model.get('name'));
				$(window).off('resize.region_container_' + this.model.get('name'));

				if(this.context_menu_view){
					this.context_menu_view.remove();
				}
				this.parent_view = false;
				this.event = false;
				Backbone.View.prototype.remove.call(this);
			}
		}),

		RegionSubContainer = _Upfront_SingularEditor.extend({
			attributes: function () {
				var name = this.model.get("container") || this.model.get("name"),
					sub = this.model.get('sub'),
					classes = [];
				classes.push('upfront-region-sub-container');
				classes.push('upfront-region-sub-container-' + name.toLowerCase().replace(/ /, "-"));
				classes.push('upfront-region-sub-container-' + sub);
				return {
					"class": classes.join(' ')
				};
			},
			init: function () {
				this.listenTo(this.model.get("properties"), 'change', this.update);
				this.listenTo(this.model.get("properties"), 'add', this.update);
				this.listenTo(this.model.get("properties"), 'remove', this.update);
				this.listenTo(Upfront.Events, 'layout:after_render', this.refresh_background);
				this.listenTo(Upfront.Events, "entity:resize_stop", this.refresh_background);
				this.listenTo(Upfront.Events, "entity:region:resize_stop", this.refresh_background);
				this.listenTo(Upfront.Events, "entity:region_container:resize_stop", this.update_pos);
				this.listenTo(Upfront.Events, "entity:region_container:resize_stop", this.refresh_background);
				this.listenTo(Upfront.Events, "entity:drag_stop", this.refresh_background);
				this.listenTo(Upfront.Events, "entity:drag:drop_change", this.refresh_background);
				this.listenTo(Upfront.Events, 'layout:after_render', this.update_pos);
				this.listenTo(Upfront.Events, "entity:region:added", this.update_pos);
				this.listenTo(Upfront.Events, "entity:region:removed", this.update_pos);
				this.listenTo(Upfront.Events, "sidebar:toggle:done", this.update_pos);
				this.listenTo(Upfront.Events, "application:mode:after_switch", this.update_pos);
				this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.on_change_breakpoint);
				$(window).on('scroll.region_subcontainer_' + this.model.get('name'), this, this.on_scroll);
				$(window).on('resize.region_subcontainer_' + this.model.get('name'), this, this.on_window_resize);
			},
			_get_region_type: function () {
				return this.model.get('type') || ( this.model.get('clip') ? 'clip' : 'wide' );
			},
			render: function () {
				var grid = Upfront.Settings.LayoutEditor.Grid,
					container_view = this.parent_view.get_container_view(this.model),
					data = _.extend(this.model.toJSON(), {size_class: grid.class, max_col: container_view.max_col, available_col: container_view.available_col}),
					template = _.template(_Upfront_Templates["region_container"], data);
				Upfront.Events.trigger("entity:region_sub_container:before_render", this, this.model);
				this.$el.html(template);
				this.$layout = this.$el.find('.upfront-grid-layout');
				this.update();
				Upfront.Events.trigger("entity:region_sub_container:after_render", this, this.model);
			},
			update: function () {
				var container_view = this.parent_view.get_container_view(this.model);
				if ( container_view && container_view._get_region_type() == 'full' ){
					this.update_background();
					this.$el.show();
				}
				else{
					this.$el.hide();
				}
				this.update_pos();
			},
			on_scroll: function (e) {
				var me = e.data;
				me.update_pos();
			},
			on_window_resize: function (e) {
				var me = e.data;
				me.update_pos();
			},
			on_change_breakpoint:  function () {
				this.update_pos();
				//_.delay(this.update_pos.bind(this), 200);
			},
			update_pos: function () {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					$main = $(Upfront.Settings.LayoutEditor.Selectors.main),
					offset = this.$el.offset(),
					top = offset.top,
					scroll_top = $(document).scrollTop(),
					win_height = $(window).height(),
					scroll_bottom = scroll_top + win_height,
					main_off = $main.offset(),
					rel_top = main_off.top,
					container_view = this.parent_view.get_container_view(this.model),
					container_height = container_view.$el.outerHeight(),
					container_offset = container_view.$el.offset(),
					container_bottom = container_offset.top + container_height,
					height = this.$el.height(),
					sticky = this.model.get('sticky'),
					sticky_top = this.$el.data('sticky-top'),
					sub = this.model.get('sub'),
					is_sticky = false,
					css = {};
				if ( this.$el.css('display') == 'none' ) {
					this.$el.css({
						position: '',
						top: '',
						left: '',
						right: '',
						bottom: ''
					});
					this.$el.removeClass('upfront-region-container-sticky');
					this.$el.removeData('sticky-top');
					if ( sub == 'top' )
						this.$el.closest('.upfront-region-container-bg').css('padding-top', '');
					else
						this.$el.closest('.upfront-region-container-bg').css('padding-bottom', '');
					return;
				}
				// Normalize scroll top value
				scroll_top = scroll_top < 0 ? 0 : scroll_top;
				// @TODO Need to have a proper behavior for responsive view, disable for now
				if ( breakpoint && !breakpoint.default )
					sticky = false;
				// Sticky behavior
				if ( sticky ) {
					if ( !_.isNumber(sticky_top) && scroll_top >= top-rel_top ) {
						css.position = 'fixed';
						css.top = rel_top;
						css.left = main_off.left;
						css.right = 0;
						css.bottom = 'auto';
						is_sticky = true;
						this.$el.data('sticky-top', top-rel_top);
					}
				}



				// Sub-container behavior to stick when scroll
				if ( scroll_top+rel_top >= container_offset.top && scroll_bottom <= container_bottom ){
					css.position = 'fixed';
					if ( sub == 'top' ) {
						css.top = rel_top;
						css.bottom = 'auto';
					}
					else {
						css.top = 'auto';
						css.bottom = 0;
					}
					css.left = main_off.left;
					css.right = 0;
					is_sticky = false;

					var ref = $('.upfront-regions');//this.$el.closest('.upfront-region-container-bg');
					var targ = this.$el.children('.upfront-region-container-bg').children('.upfront-grid-layout');
					css.width = ref.width();
					if(ref.offset())
						css.left = ref.offset().left-$(document).scrollLeft();
					/*console.log(ref.offset());
					console.log($(document).scrollLeft());
					if(ref.offset()) {
						css.left-=(2*($(document).scrollLeft())-60);
						//ref.offset().left-targ.offset({top: targ.offset().top, left: ref.offset.left});
					}*/
				}
				if ( css.position && css.position == 'fixed' ) {
					if ( this.$el.css('position') != css.position || this.$el.css('left') != css.left || this.$el.css('top') != css.top ) {
						this.$el.css(css);
						if ( sub == 'top' )
							this.$el.closest('.upfront-region-container-bg').css('padding-top', height);
						else
							this.$el.closest('.upfront-region-container-bg').css('padding-bottom', height);
					}
					if ( is_sticky )
						this.$el.addClass('upfront-region-container-sticky');
					else
						this.$el.removeClass('upfront-region-container-sticky');
				}
				else if (
					this.$el.css('position') == 'fixed' &&
					(
						!sticky ||
						( _.isNumber(sticky_top) && scroll_top <= sticky_top ) ||
						( !_.isNumber(sticky_top) && ( scroll_top+rel_top < container_offset.top || scroll_bottom > container_bottom ) )
					)
				) {
					this.$el.css({
						position: '',
						top: '',
						left: '',
						right: '',
						bottom: ''
					});
					if ( sub == 'top' ) {
						this.$el.css('top', container_height - win_height + rel_top)
					}
					this.$el.removeClass('upfront-region-container-sticky');
					this.$el.removeData('sticky-top');
					if ( sub == 'top' )
						this.$el.closest('.upfront-region-container-bg').css('padding-top', '');
					else
						this.$el.closest('.upfront-region-container-bg').css('padding-bottom', '');
				}

			},
			remove: function () {
				var sub = this.model.get('sub');
				if ( sub == 'top' )
					this.$el.closest('.upfront-region-container-bg').css('padding-top', '');
				else
					this.$el.closest('.upfront-region-container-bg').css('padding-bottom', '');
				this.event = false;
				$(window).off('scroll.region_subcontainer_' + this.model.get('name'));
				$(window).off('resize.region_subcontainer_' + this.model.get('name'));
				Backbone.View.prototype.remove.call(this);
			}
		}),

		Region = _Upfront_SingularEditor.extend({
			cssSelectors: {
				'.upfront-region-wrapper': {label: l10n.rw_label, info: l10n.rw_info}
			},
			events: {
				"mouseup": "on_mouse_up", // Bound on mouseup because "click" prevents bubbling (for module/object activation)
				"mouseover": "on_mouse_over",
				"click": "on_click",
				"click > .upfront-entity_meta > a.upfront-entity-settings_trigger": "on_settings_click",
				"click > .upfront-entity_meta > a.upfront-entity-delete_trigger": "on_delete_click",
				"click > .upfront-entity_meta > a.upfront-entity-hide_trigger": "on_hide_click",
				"click > .upfront-region-hidden-toggle > a.upfront-entity-hide_trigger": "on_hide_click",
				"click > .upfront-region-edit-trigger": "trigger_edit"
			},
			attributes: function(){
				var grid = Upfront.Settings.LayoutEditor.Grid,
					container = this.model.get("container"),
					name = this.model.get("name").toLowerCase().replace(/\s/, "-"),
					classes = [],
					col, width;
				if ( ! this.col ){
					col = this.model.get_property_value_by_name('col');
					width = this.model.get_property_value_by_name('width');
					this.col = col || ( width ? Upfront.Util.width_to_col(width) : grid.size );
					if ( this.col > grid.size ) this.col = grid.size;
				}
				classes.push('upfront-region');
				classes.push('upfront-region-' + name);
				classes.push(grid.class + this.col);
				if ( ! this.model.is_main() ){
					var index = this.model.collection.indexOf(this.model),
						sub = this.model.get('sub'),
						next = this.model.collection.at(index+1),
						is_left = ( next && ( next.get('name') == container || next.get('container') == container) );
					classes.push('upfront-region-side');
					classes.push('upfront-region-side-' + ( sub ? sub : (is_left ? 'left' : 'right') ));
				}
				else {
					classes.push('upfront-region-center');
				}
				if ( this.model.collection && this.model.collection.active_region == this.model ){
					classes.push('upfront-region-active');
				}
				return {
					"class": classes.join(' '),
					"id": 'region-' + name
				};
			},
			init: function () {
				var container = this.model.get("container"),
					name = this.model.get("name");
				this.listenTo(this.dispatcher, 'plural:propagate_activation', this.on_mouse_up);
				//this.dispatcher.on("plural:propagate_activation", this.on_mouse_up, this);
				// this.model.get("properties").bind("change", this.update, this);
				// this.model.get("properties").bind("add", this.update, this);
				// this.model.get("properties").bind("remove", this.update, this);
				// this.model.get("modules").bind("change", this.on_module_update, this);
				// this.model.get("modules").bind("add", this.on_module_update, this);
				this.listenTo(this.model.get("properties"), 'change', this.update);
				this.listenTo(this.model.get("properties"), 'add', this.update);
				this.listenTo(this.model.get("properties"), 'remove', this.update);
				this.listenTo(this.model.get("modules"), 'change', this.on_module_update);
				this.listenTo(this.model.get("modules"), 'add', this.on_module_update);
				this.listenTo(this.model.get("modules"), 'remove', this.on_module_update);
				this.listenTo(this.model.get("modules"), 'reset', this.on_module_update);
				this.listenTo(Upfront.Events, 'entity:added:after', this.display_region_hint);
				this.listenTo(Upfront.Events, 'layout:after_render', this.on_layout_render);
				this.listenTo(Upfront.Events, "entity:resize_stop", this.refresh_background);
				this.listenTo(Upfront.Events, "entity:region:resize_stop", this.refresh_background);
				this.listenTo(Upfront.Events, "entity:region_container:resize_stop", this.refresh_background);
				this.listenTo(Upfront.Events, "entity:drag_stop", this.refresh_background);
				this.listenTo(Upfront.Events, "entity:drag:drop_change", this.refresh_background);
				this.listenTo(Upfront.Events, "entity:navigation:responsive_open", this.refresh_background);
				this.listenTo(Upfront.Events, "entity:navigation:responsive_close", this.refresh_background);
				this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.on_change_breakpoint);
				this.listenTo(Upfront.Events, "entity:region:hide_toggle", this.update_hide_toggle);
				this.listenTo(Upfront.Events, "command:region:edit_toggle", this.update_buttons);
				this.listenTo(Upfront.Events, "entity:region:removed", this.update_buttons);
				$(window).on('resize.region_' + this.model.get('name'), this, this.on_window_resize);
			},
			on_click: function (e) {

			},
			on_mouse_up: function () {
				this.trigger("activate_region", this);
			},
			on_mouse_over: function () {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					container = this.parent_view.get_container_view(this.model),
					$main = $(Upfront.Settings.LayoutEditor.Selectors.main);
				if ( ! $main.hasClass('upfront-region-editing') )
					return;
				if ( container && container.$el.hasClass('upfront-region-container-active') && !container.$el.hasClass('upfront-region-bg-setting-open') )
					this.trigger("activate_region", this);
			},
			_is_clipped: function () {
				var type = this.model.get('type'),
					sub = this.model.get('sub');
				return ( !this.model.is_main() && ( !sub || (sub != 'top' && sub != 'bottom') ) );
			},
			render: function () {
				var container = this.model.get("container"),
					name = this.model.get("name"),
					template = _.template(_Upfront_Templates["region"], this.model.toJSON()),
					$edit = $('<div class="upfront-region-edit-trigger upfront-region-edit-trigger-small upfront-ui" title="Edit region"><i class="upfront-icon upfront-icon-region-edit"></i></div>'),
					$size = $('<div class="upfront-region-size-hint upfront-ui"></div>')
				;
				Upfront.Events.trigger("entity:region:before_render", this, this.model);
				this.$el.html(template);
				this.$el.append('<div class="upfront-debug-info"/>');
				$edit.appendTo(this.$el);
				$size.appendTo(this.$el);

				this.update();

				var local_view = this._modules_view || new Modules({"model": this.model.get("modules")});
				local_view.region_view = this;
				this.$el.find('> .upfront-region-wrapper > .upfront-modules_container').append(local_view.el);
				local_view.render();
				this.render_panels();
				this.render_bg_setting();
				//if ( this._is_clipped() )
				//	this.$el.append('<div class="upfront-region-active-overlay" />');
				this.display_region_hint();
				Upfront.Events.trigger("entity:region:after_render", this, this.model);
				this.trigger("region_render", this);
				if ( ! this._modules_view )
					this._modules_view = local_view;
				else
					this._modules_view.delegateEvents();
			},
			render_panels: function () {
				this.region_panels = new Upfront.Views.Editor.RegionPanels({model: this.model});
				this.region_panels.render();
				this.$el.append(this.region_panels.el);
			},
			render_bg_setting: function () {
				var container_view = this.parent_view.get_container_view(this.model),
					opts = {
						model: this.model,
						to: this.$el,
						width: 420,
						top: 52,
						right:43,
						keep_position: false
					};
				this.bg_setting = new Upfront.Views.Editor.ModalBgSetting(opts);
				this.bg_setting.for_view = this;
				this.bg_setting.render();
				this.$el.append(this.bg_setting.el);
				this.listenTo(this.bg_setting, "modal:open", this.on_modal_open);
				this.listenTo(this.bg_setting, "modal:close", this.on_modal_close);
			},
			update: function () {
				var grid = Upfront.Settings.LayoutEditor.Grid,
					breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					container = this.model.get("container"),
					name = this.model.get("name").toLowerCase().replace(/\s/g, "-"),
					previous_name = this.model.previous("name"),
					col = this.model.get_property_value_by_name('col'),
					row = this.model.get_property_value_by_name('row'),
					height = row ? row * Upfront.Settings.LayoutEditor.Grid.baseline : 0,
					expand_lock = this.model.get_property_value_by_name('expand_lock')
				;
				this.$el.data('name', name);
				this.$el.attr('data-title', this.model.get("title"));
				this.$el.data('type', this.model.get("type"));
				this.$el.find('.upfront-region-title').html(this.model.get("title"));
				if ( !breakpoint || breakpoint.default ){
					if ( col && col != this.col ) {
						this.region_resize(col);
					}
				}
				if ( height > 0 ) {
					this.$el.css('min-height', height + 'px');
				}
				if ( expand_lock ) {
					this.$el.addClass('upfront-region-expand-lock');
				}
				else {
					this.$el.removeClass('upfront-region-expand-lock');
				}
				if ( previous_name != name ){
					this.$el.removeClass('upfront-region-' + previous_name.toLowerCase().replace(/\s/g, "-"));
					this.$el.addClass('upfront-region-' + name);
					this.$el.attr('id', 'region-' + name);
				}
				if ( this._is_clipped() ){
					// This region is inside another region container
					this.update_background(); // Allow background applied
				}
				else {
					this.remove_background();
				}
				this.update_position();
				this.update_buttons();
				this.update_size_hint(this.col * grid.column_width, parseInt(this.$el.css('height'), 10));
				this.trigger("region_update", this);
			},
			update_position: function () {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					grid = Upfront.Settings.LayoutEditor.Grid,
					$edit = this.$el.find('> .upfront-region-edit-trigger');
				if ( ! breakpoint ) return;
				var data = this.model.get_property_value_by_name('breakpoint'),
					row = this.model.get_property_value_by_name('row'),
					breakpoint_data = data[breakpoint.id],
					container_view = this.parent_view.get_container_view(this.model),
					$container = this.$el.find('> .upfront-region-wrapper > .upfront-modules_container'),
					$toggle = this.$el.find('.upfront-region-hidden-toggle'),
					$regions = container_view.$el.find('.upfront-region-center, .upfront-region-side-left, .upfront-region-side-right'),
					$hide_trigger = this.$el.find('> .upfront-entity_meta > a.upfront-entity-hide_trigger'),
					height = 0,
					width = 0,
					top_padding = 0,
					bottom_padding = 0
				;
				if ( ! breakpoint_data || ! breakpoint_data.hide ){
					$container.show();
					$toggle.hide();
					this.$el.removeClass('upfront-region-hidden');
					if ( !breakpoint.default )
						$hide_trigger.show();
				}
				else if ( breakpoint_data.hide ){
					$container.hide();
					$toggle.show();
					this.$el.addClass('upfront-region-hidden');
					$hide_trigger.hide();
					this.update_hide_toggle();
				}
				if ( $regions.length > 0 && $regions.length == container_view.$el.find('.upfront-region-hidden').length )
					container_view.$el.addClass('upfront-region-container-hidden');
				else
					container_view.$el.removeClass('upfront-region-container-hidden');
				if ( breakpoint_data && typeof breakpoint_data.col == 'number' ){
					width = (breakpoint_data.col/(breakpoint.columns)*100);
					this.$el.css('width', ( width > 100 ? 100 : width ) + '%');
					this.$el.data('breakpoint_col', breakpoint_data.col);
				}
				else {
					this.$el.css('width', '');
					this.$el.removeData('breakpoint_col');
				}
				if ( !breakpoint.default ) {
					if ( this.model.is_main() )
						$edit.css('right', (breakpoint.width - (breakpoint.columns*grid.column_width)) / 2 * -1);
					else
						$edit.css('right', '');
					$toggle.css('left', (breakpoint.width - (breakpoint.columns*grid.column_width)) / 2);
				}
				else {
					$edit.css('right', '');
					$toggle.css('left', '');
				}
				if ( breakpoint_data && typeof breakpoint_data.row == 'number' ) {
					height = (breakpoint_data.row*grid.baseline);
					this.$el.data('breakpoint_row', breakpoint_data.row);
				}
				else {
					height = (row*grid.baseline);
					this.$el.removeData('breakpoint_row');
				}
				if ( height > 0 ){
					top_padding = parseInt(this.$el.css('padding-top'), 10);
					bottom_padding = parseInt(this.$el.css('padding-bottom'), 10);
					this.$el.css('min-height', height + 'px');
					height -= top_padding + bottom_padding;
					height = height > 0 ? height : 0;
					$container.css('min-height', height + 'px');
				}
				else {
					this.$el.css('min-height', '');
					$container.css('min-height', '');
				}
				this.trigger("region_changed", this);
			},
			update_buttons: function () {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					$delete_trigger = this.$el.find('> .upfront-entity_meta > a.upfront-entity-delete_trigger');
				if ( !breakpoint || breakpoint.default ){
					if (
						( this.model.is_main() && this.model.has_side_region() ) ||
						( this.model.get('sub') == 'top' || this.model.get('sub') == 'bottom' )
					)
						$delete_trigger.hide();
					else
						$delete_trigger.css('display', 'block');
				}
				else {
					$delete_trigger.hide();
				}
				this.update_size_hint(parseInt(this.$el.css('width'), 10), parseInt(this.$el.css('height'), 10));
			},
			update_size_hint: function (width, height, $helper) {
				var hint = '<b>w:</b>' + width + 'px <b>h:</b>' + height + 'px';
				( $helper ? $helper : this.$el ).find('.upfront-region-size-hint').html(hint);
			},
			region_resize: function (col) {
				var grid = Upfront.Settings.LayoutEditor.Grid,
					prev_col = this.col
				;
				this.col = col;
				this.$el.removeClass(grid.class + prev_col);
				this.$el.addClass(grid.class + this.col);
				if ( Upfront.Application.layout_ready ) {
					this.normalize_child_modules(prev_col);
				}
			},
			on_module_update: function () {
				this.trigger("region_changed", this);
				this.display_region_hint();
			},
			display_region_hint: function() {

				if(Upfront.Application.get_current() != "theme" || this.$el.hasClass('upfront-region-floating') || this.$el.hasClass('upfront-region-lightbox') || this.$el.attr('id')=='region-shadow')
					return

				if(this.$el.find('> .upfront-region-wrapper > .upfront-modules_container .upfront-wrapper').size() < 1) {
					this.$el.addClass('empty_in_theme_mode');
				}
				else {
					this.$el.removeClass('empty_in_theme_mode');
				}
			},
			on_layout_render: function () {
				this.update_size_hint(parseInt(this.$el.css('width'), 10), parseInt(this.$el.css('height'), 10));
				this.refresh_background();
			},
			normalize_child_modules: function (prev_col) {
				if ( !this._modules_view ) return;
				var breakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),
					ed = Upfront.Behaviors.GridEditor,
					col = ( !breakpoint || breakpoint.default ) ? ed.get_class_num(this.$el, ed.grid.class) : this.$el.data('breakpoint_col')
				;
				this._modules_view.normalize_child_modules(col, prev_col, this.model.get('wrappers'));
			},
			remove: function() {
				if(this._modules_view)
					this._modules_view.remove();
				$(window).off('resize.region_' + this.model.get('name'));
				var wrappers = this.model.get('wrappers');
				if(wrappers)
					wrappers.each(function(wrapper){
						var wrapperView = Upfront.data.wrapper_views[wrapper.cid];
						if(wrapperView){
							wrapperView.remove();
							delete Upfront.data.wrapper_views[wrapper.cid];
						}
					});
				this.parent_view = false;
				Backbone.View.prototype.remove.call(this);
				this.model.get('wrappers').reset([], {silent:true});
				this.model = false;
			},
			on_delete_click: function (e) {
				var main, main_view;

				if(typeof(e) != 'undefined')
					e.preventDefault();


				if ( confirm(l10n.section_delete_nag) ){
					var parent_view = this.parent_view; // reserve parent_view before removal as we use it later
					// if ( this.model.get('container') ){
						// main = this.model.collection.get_by_name(this.model.get('container'));
						// main_view = Upfront.data.region_views[main.cid];
					// }
					if(this.model.get('type') == 'lightbox')
						this.hide();

					var thecollection = this.model.collection;

					// Make sure sub-regions is also removed if it's main region
					if ( this.model.is_main() ) {
						var sub_regions = this.model.get_sub_regions();
						_.each(sub_regions, function(sub_model, sub){
							if ( _.isArray(sub_model) )
								_.each(sub_model, function(sub_model2){ thecollection.remove(sub_model2) });
							else if ( _.isObject(sub_model) )
								thecollection.remove(sub_model);
						});
					}
					this.model.collection.remove(this.model);

					var total_container = thecollection.total_container(['shadow', 'lightbox']); // don't include shadow and lightbox region
					if ( total_container == 0 ) {
						if ( parent_view.$el.find('#no_region_add_one').length < 1 ) {
							parent_view.$el.append($('<a>').attr('id', 'no_region_add_one').text(l10n.no_region_add).one('click', function() {
								var new_title = false,
									name = 'main',
									title = l10n.main_area;
								if ( thecollection.get_by_name(name) ) {
									new_title = thecollection.get_new_title("Main ", 2);
									title = new_title.title;
									name = new_title.name;
								}
								var new_region = new Upfront.Models.Region(_.extend(_.clone(Upfront.data.region_default_args), {
									"name": name,
									"container": name,
									"title": title
								}));

								var options = {};
								new_region.set_property('row', Upfront.Util.height_to_row($(window).height())); // default to screen height worth of row
								new_region.add_to(thecollection, 0, options);

								$(this).remove();
							}));

						}

					}

					// if ( main_view ){
						// Upfront.Events.trigger('command:region:edit_toggle', true);
						// main_view.trigger('activate_region', main_view);
					// }
				}
			},
			on_settings_click: function (e) {

				if(typeof(e) != 'undefined') {
					e.preventDefault();
					e.stopPropagation();
				}

				var me = this,
					container_view = this.parent_view.get_container_view(this.model);
				this.listenToOnce(Upfront.Events, "entity:region:deactivated", function(deac){
					if(e && !this.$el.is($(e.target).closest('div.upfront-region'))) {
						me.bg_setting.close(false);
					}
				});

				// Make sure all other instance is closed
				_.each(_.flatten([container_view.model, container_view.sub_model]), function(each){
					var each_view = Upfront.data.region_views[each.cid];
					if ( each == me.model ) {
						each_view.$el.find('.upfront-inline-modal-wrap').draggable({
							delay: 300,
							addClasses: false,
							cancel: '.upfront-field-select, input,textarea,button,select,option'
						});
						return;
					}
					if ( each_view && each_view.bg_setting )
						each_view.bg_setting.close(false);
				});

				var $settings_trigger = this.$el.find('> .upfront-entity_meta > a.upfront-entity-settings_trigger'),
					setting_offset = $settings_trigger.offset(),
					offset = this.$el.offset(),
					width = this.$el.width();



				if(this.model.get('type') == 'lightbox') {
					this.bg_setting.right =  80;
					this.bg_setting.top = setting_offset.top;

					var container_view = this.parent_view.get_container_view(this.model);
					container_view.trigger_edit_lightbox(e);
				}
				else {
					if ( this.bg_setting.width < setting_offset.left - 10 ) {
						this.bg_setting.right = ( offset.left + width - setting_offset.left ) + 10;
						this.bg_setting.left = -1;
					}
					else {
						this.bg_setting.right = -1;
						this.bg_setting.left = width;
					}
					this.bg_setting.top = setting_offset.top - offset.top;
				}

				container_view.$el.addClass('upfront-region-bg-setting-open');
				this.bg_setting.open().always(function(){
					container_view.$el.removeClass('upfront-region-bg-setting-open');
				});
			},
			on_hide_click: function (e) {
				e.preventDefault();
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					data = Upfront.Util.clone(this.model.get_property_value_by_name('breakpoint') || {});
				if ( !_.isObject(data[breakpoint.id]) )
					data[breakpoint.id] = {};
				if ( data[breakpoint.id].hide == 1 )
					data[breakpoint.id].hide = 0;
				else
					data[breakpoint.id].hide = 1;
				this.model.set_property('breakpoint', data);
				Upfront.Events.trigger('entity:region:hide_toggle', data[breakpoint.id].hide, this);
			},
			update_hide_toggle: function () {
				if ( ! this.$el.hasClass('upfront-region-hidden') )
					return;
				var $toggle = this.$el.find('.upfront-region-hidden-toggle'),
					$regions = $('.upfront-region-center, .upfront-region-side-left, .upfront-region-side-right'),
					$hidden = Upfront.Util.find_from_elements($regions, this.$el, '.upfront-region', true, ':not(.upfront-region-hidden)');
				$toggle.css('margin-top', ( $hidden.length * 20 ) + 'px');
			},
			trigger_edit: function (e) {
				var container_view = this.parent_view.get_container_view(this.model);
				container_view.trigger_edit(e);
				e.stopPropagation();
			},
			close_edit: function (e) {
				var container_view = this.parent_view.get_container_view(this.model);
				container_view.close_edit();
				e.stopPropagation();
			},
			on_modal_open: function () {
				var container_view = this.parent_view.get_container_view(this.model);
				container_view.$el.find('.upfront-region-finish-edit').css('display', 'none'); // hide finish edit button
			},
			on_modal_close: function () {
				var container_view = this.parent_view.get_container_view(this.model);
				container_view.$el.find('.upfront-region-finish-edit').css('display', ''); // reset hide finish edit button
			},
			on_change_breakpoint: function (breakpoint) {
				var $delete = this.$el.find('> .upfront-entity_meta > a.upfront-entity-delete_trigger'),
					$settings = this.$el.find('> .upfront-entity_meta > a.upfront-entity-settings_trigger'),
					$hide = this.$el.find('> .upfront-entity_meta > a.upfront-entity-hide_trigger');
				if ( !breakpoint.default ){
					$delete.hide();
					//$settings.hide();
					$hide.show();
				}
				else {
					$delete.show();
					//$settings.show();
					$hide.hide();
				}
				this.update_position();
				this.update_size_hint(parseInt(this.$el.css('width'), 10), parseInt(this.$el.css('height'), 10));
				if ( this._is_clipped() )
					this.update_background();
			}
		}),

		RegionFixed = Region.extend({
			events: {
				//"mouseup": "on_mouse_up", // Bound on mouseup because "click" prevents bubbling (for module/object activation)
				"mouseover": "on_mouse_over",
				"click": "on_click",
				"click > .upfront-entity_meta > a.upfront-entity-settings_trigger": "on_settings_click",
				"click > .upfront-entity_meta > a.upfront-entity-delete_trigger": "on_delete_click",
				"click > .upfront-region-edit-trigger": "trigger_edit",
				"click > .upfront-region-finish-edit-fixed": "close_edit",
			},
			init: function () {
				this.constructor.__super__.init.call(this);
				this.listenTo(Upfront.Events, 'sidebar:toggle:done', this.update_region_position);
				this.listenTo(Upfront.Events, "entity:drag_stop", this.update_region_position);
				this.listenTo(Upfront.Events, "entity:drag_stop", this.check_modules);
				this.listenTo(Upfront.Events, "layout:after_render", this.check_modules);
				this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.on_change_breakpoint);
				this.listenTo(this.model, "restrict_to_container", this.update_position_on_restrict);
				$(window).on('scroll.region_' + this.model.get('name'), this, this.on_scroll);
			},
			render: function () {
				this.constructor.__super__.render.call(this);
				var	$edit = $('<div class="upfront-region-edit-trigger upfront-region-edit-trigger-small upfront-ui" title="' + l10n.change_background + '"><i class="upfront-icon upfront-icon-region-edit"></i></div>'),
					$edit_full = $('<div class="upfront-region-edit-trigger upfront-region-edit-trigger-full upfront-ui"><div class="upfront-region-edit-text">' + l10n.click_to_edit_floating_region + '</div></div>'),
					$ok = $('<div class="upfront-region-finish-edit-fixed upfront-ui">' + l10n.ok + '</div>'),
					$size = $('<div class="upfront-region-size-hint upfront-ui"></div>'),
					$position = $('<div class="upfront-region-position-hint upfront-ui"></div>');
				$size.appendTo(this.$el);
				$position.appendTo(this.$el);
				$edit.appendTo(this.$el);
				$edit_full.appendTo(this.$el);
				$ok.appendTo(this.$el);
				//this.render_edit_position();
			},
			render_bg_setting: function () {
				var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
				this.bg_setting = new Upfront.Views.Editor.ModalBgSetting({model: this.model, to: $main, width: 420});
				this.bg_setting.render();
				$main.append(this.bg_setting.el);
				this.listenTo(this.bg_setting, "modal:open", this.on_modal_open);
				this.listenTo(this.bg_setting, "modal:close", this.on_modal_close);
			},
			update: function() {
				this.constructor.__super__.update.call(this);
				this.check_modules();
				this.update_region_position();
			},
			update_region_position: function () {
				var $main = $(Upfront.Settings.LayoutEditor.Selectors.main),
					grid = Upfront.Settings.LayoutEditor.Grid,
					restrict = this.model.get('restrict_to_container'),
					width = this.model.get_property_value_by_name('width'),
					col = this.model.get_property_value_by_name('col'),
					height = this.model.get_property_value_by_name('height'),
					top = this.model.get_property_value_by_name('top'),
					is_top = ( typeof top == 'number' ),
					left = this.model.get_property_value_by_name('left'),
					is_left = ( typeof left == 'number' ),
					bottom = this.model.get_property_value_by_name('bottom'),
					is_bottom = ( typeof bottom == 'number' ),
					right = this.model.get_property_value_by_name('right'),
					is_right = ( typeof right == 'number' ),
					css = {
						width: width || 225,
						minHeight: height || 225
					};
				if ( !width ) {
					this.model.set_property('width', 225, true);
				}
				if ( !col ) {
					col = Upfront.Util.width_to_col(css.width);
					col = ( col <= grid.size ) ? col : grid.size;
					this.model.set_property('col', col, true)
				}
				else {
					col = ( col <= grid.size ) ? col : grid.size;
				}
				if ( !height ) {
					this.model.set_property('height', 225, true);
				}
				if ( is_top || !is_bottom ){
					css.top = is_top ? top : 30;
					css.bottom = '';
					if ( !is_top ) {
						this.model.set_property('top', 30, true);
					}
				}
				else {
					css.bottom = bottom;
					css.top = '';
				}
				if ( is_left || !is_right ){
					css.left = ( is_left ? left : 30 ) + ( restrict ? 0 : $main.offset().left );
					css.right = '';
					if ( !is_left ) {
						this.model.set_property('left', 30, true);
					}
				}
				else {
					css.right = right;
					css.left = '';
				}
				this.$el.find('> .upfront-region-wrapper > .upfront-modules_container').css( {
					width: ( col * grid.column_width ),
					minHeight: css.minHeight
				});
				this.$el.css(css);
				if ( this.edit_position ) {
					this.edit_position.update_fields();
				}
				this.update_size_hint(css.width, css.minHeight);
				this.update_position_hint(css);
				this.update_position_scroll();
			},
			update_position_hint: function (pos, $helper) {
				var hint = '';
				if ( typeof pos.top == 'number' )
					hint += '<b>top:</b>' + pos.top;
				else if ( typeof pos.bottom == 'number' )
					hint += '<b>bottom:</b>' + pos.bottom;
				if ( typeof pos.left == 'number' )
					hint += ' <b>left:</b>' + pos.left;
				else if ( typeof pos.right == 'number' )
					hint += ' <b>right:</b>' + pos.right;
				( $helper ? $helper : this.$el ).find('.upfront-region-position-hint').html(hint);
			},
			update_position_on_restrict: function (value) {
				var scroll_top = $(window).scrollTop(),
					win_height = $(window).height(),
					scroll_bottom = scroll_top + win_height,
					container_view = this.parent_view.get_container_view(this.model),
					container_height = container_view.$el.height(),
					container_offset = container_view.$el.offset(),
					container_bottom = container_offset.top + container_height,
					height = this.model.get_property_value_by_name('height'),
					top = this.model.get_property_value_by_name('top'),
					is_top = ( typeof top == 'number' ),
					bottom = this.model.get_property_value_by_name('bottom'),
					is_bottom = ( typeof bottom == 'number' );
				if ( value ){
					if ( ( is_top || !is_bottom ) && scroll_top <= container_offset.top ){
						top = top - ( container_offset.top - scroll_top );
						if ( top + height > container_height )
							top = container_height - height;
						else if ( top < 0 )
							top = 0;
					}
					else if ( is_bottom && ( scroll_bottom >= container_bottom ) ){
						bottom = bottom - ( scroll_bottom - container_bottom );
						if ( bottom + height > container_height )
							bottom = container_height - height;
						else if ( bottom < 0 )
							bottom = 0;
					}
				}
				else {
					if ( is_top || !is_bottom ){
						top = ( container_offset.top >= scroll_top ) ? container_offset.top - scroll_top + top : top;
					}
					else {
						bottom = ( scroll_bottom >= container_bottom ) ? scroll_bottom - container_bottom + bottom : bottom;
					}
				}
				if ( is_top || !is_bottom ) {
					this.model.set_property('top', top, true);
					// let's automatically scroll to avoid confusion with the correct absolute positioning
					if ( container_height > win_height && scroll_bottom > container_bottom )
						$('html,body').animate({scrollTop: container_bottom - win_height}, 600);
				}
				else {
					this.model.set_property('bottom', bottom, true);
					// let's automatically scroll to avoid confusion with the correct absolute positioning
					if ( container_height > win_height && scroll_top < container_offset.top )
						$('html,body').animate({scrollTop: container_offset.top}, 600);
				}
			},
			update_position_scroll: function () {
				var $main = $(Upfront.Settings.LayoutEditor.Selectors.main),
					scroll_top = $(window).scrollTop(),
					win_height = $(window).height(),
					scroll_bottom = scroll_top + win_height,
					container_view = this.parent_view.get_container_view(this.model),
					container_height = container_view.$el.height(),
					container_offset = container_view.$el.offset(),
					container_bottom = container_offset.top + container_height,
					restrict = this.model.get('restrict_to_container'),
					height = this.model.get_property_value_by_name('height'),
					top = this.model.get_property_value_by_name('top'),
					is_top = ( typeof top == 'number' ),
					left = this.model.get_property_value_by_name('left'),
					right = this.model.get_property_value_by_name('right'),
					is_left = ( typeof left == 'number' ),
					bottom = this.model.get_property_value_by_name('bottom'),
					is_bottom = ( typeof bottom == 'number' ),
					css = {};

				if((scroll_bottom < container_view.$el.offset().top || scroll_top > container_view.$el.offset().top + container_view.$el.outerHeight()) !== true) {
					if(right == 0) {
						this.$el.find('.upfront-region-edit-trigger').css({
							right: 30
						})
					}
				} else {
					this.$el.find('.upfront-region-edit-trigger').css({
						right: 0
					})
				}

				if ( restrict ){
					if ( scroll_top >= container_offset.top && scroll_bottom <= container_bottom ){
						css.position = 'fixed';
						if ( is_top )
							css.top = top;
						else
							css.bottom = bottom;
					}
					else {
						css.position = 'absolute';
						if ( is_top ) {
							if ( container_height > win_height && scroll_top >= ( container_offset.top + container_height - win_height ) )
								css.top = container_height - win_height + top;
							else
								css.top = top;
						}
						else {
							if ( container_height > win_height && scroll_bottom <= ( container_offset.top + win_height ) )
								css.bottom =  container_height - win_height + bottom;
							else
								css.bottom = bottom;
						}
					}
				}
				else {
					css.position = 'fixed';
					if ( is_top )
						css.top = top;
					else
						css.bottom = bottom;
				}
				if ( is_left )
					css.left = left + ( css.position == 'fixed' ? $main.offset().left : 0 );
				this.$el.css(css);

				if ( ( css.position == 'fixed' && css.bottom < 35 ) || ( css.position == 'absolute' && this.$el.offset().top+this.$el.height() > scroll_bottom-35 ) )
					this.$el.find('.upfront-region-finish-edit-fixed').css('bottom', 0);
				else
					this.$el.find('.upfront-region-finish-edit-fixed').css('bottom', '');
			},
			on_scroll: function (e) {
				var me = e.data;
				me.update_position_scroll();
			},
			render_panels: function () {
			},
			render_edit_position: function () {
				this.edit_position = new Upfront.Views.Editor.RegionFixedEditPosition({model: this.model});
				this.edit_position.render();
				this.$el.append(this.edit_position.el);
			},
			trigger_edit: function (e) {
				var container_view = this.parent_view.get_container_view(this.model);
				container_view.trigger_edit_fixed();
				e.stopPropagation();
			},
			close_edit: function (e) {
				var container_view = this.parent_view.get_container_view(this.model);
				container_view.close_edit();
				e.stopPropagation();
			},
			check_modules: function () {
				var total = this.$el.find('> .upfront-region-wrapper > .upfront-modules_container > .upfront-editable_entities_container').find('.upfront-module').size();
				if ( total == 0 ){
					this.$el.removeClass('upfront-region-has-modules');
					this.$el.addClass('upfront-region-empty');
				}
				else {
					this.$el.removeClass('upfront-region-empty');
					this.$el.addClass('upfront-region-has-modules');
				}
			},
			remove: function() {
				$(window).off('scroll.region_' + this.model.get('name'));
				this.constructor.__super__.remove.call(this);
			},
			on_change_breakpoint: function (breakpoint) {
				if ( !breakpoint.default )
					this.$el.hide();
				else
					this.$el.show();
			}
		}),

/*  Lightbox is extended from Region */
		RegionLightbox = Region.extend({
			cssSelectors: {
				'.upfront-region-side-lightbox': {label: l10n.ltbox_area_label, info: l10n.ltbox_area_info},
				'.close_lightbox > .upfront-icon-popup-close': {label: l10n.ltbox_close_icon_label, info: l10n.ltbox_close_icon_info}
			},
			$bg: $('<div class="upfront-lightbox-bg"></div>'),
			$close: $('<div class="upfront-ui close_lightbox"></div>'),
			$close_icon: $('<div class="upfront-icon-popup-close"></div>'),
			events: {
				//"mouseup": "on_mouse_up", // Bound on mouseup because "click" prevents bubbling (for module/object activation)
				"mouseover": "on_mouse_over",
				"click": "on_click",
				"click > .upfront-entity_meta > a.upfront-entity-settings_trigger": "on_settings_click",
				"click > .upfront-entity_meta > a.upfront-entity-delete_trigger": "on_delete_click",
				"click > .upfront-region-edit-trigger": "trigger_edit",
				"click > .upfront-region-finish-edit-lightbox": "close_edit",
				"click > .close_lightbox": "hide",
			},
			init: function () {
				this.constructor.__super__.init.call(this);

				this.listenTo(Upfront.Events, 'sidebar:toggle:done', this.update_region_position);
				this.listenTo(Upfront.Events, "entity:drag_stop", this.update_region_position);
				this.listenTo(Upfront.Events, "entity:drag_stop", this.check_modules);
				this.listenTo(Upfront.Events, "layout:after_render", this.check_modules);
				this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.on_change_breakpoint);
			},
			render: function () {
				this.constructor.__super__.render.call(this);
				this.hide();

					//var	$edit = $('<div class="upfront-region-edit-trigger upfront-region-edit-trigger-small upfront-ui" title="' + l10n.edit_ltbox + '"><i class="upfront-icon upfront-icon-region-edit"></i></div>');
					//$ok = $('<div class="upfront-region-finish-edit-lightbox upfront-ui">Finish Editing</div>');


				//this.$el.prepend(this.$bg);
				this.$close.appendTo(this.$el);

				//$edit.appendTo(this.$el);
				//$ok.appendTo(this.$el);
			},
			render_bg_setting: function () {
				var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
				this.bg_setting = new Upfront.Views.Editor.ModalBgSetting({model: this.model, to: $main, width: 420});
				this.bg_setting.for_view = this;
				this.bg_setting.render();
				$main.append(this.bg_setting.el);
				this.listenTo(this.bg_setting, "modal:open", this.on_modal_open);
				this.listenTo(this.bg_setting, "modal:close", this.close_edit);
			},
			show:function () {
				Upfront.Events.trigger('upfront:element:edit:stop');
				var me = this;
				this.$bg.insertBefore(this.$el);
				if(this.model.get_property_value_by_name('click_out_close') == 'yes') {
					this.$bg.unbind('click');
					this.$bg.bind('click', function() {
						me.hide();
					});
				}

				this.$el.show();

				/** Because it is a lightbox, the following rendering specific function
					should be applied on the modules once the contents of the lightbox show up
				**/
				this._modules_view.apply_flexbox_clear();
				this._modules_view.apply_wrapper_height();

				Upfront.Events.trigger('upfront:lightbox:show');

			},
			hide:function () {
				this.$el.hide();
				this.$bg.remove();
			},
			refresh_background: function () {
				this.constructor.__super__.refresh_background.call(this);

			},
			update: function() {
				this.constructor.__super__.update.call(this);
				this.check_modules();
				this.update_region_position();

				if(this.model.get_property_value_by_name('show_close') == 'yes' || this.model.get_property_value_by_name('add_close_text') == 'yes') {

					this.$el.find('.close_lightbox').css('display', 'block');


					if(this.model.get_property_value_by_name('add_close_text') == 'yes') {

						this.$close.html('<h3>'+this.model.get_property_value_by_name('close_text')+'</h3>');
						if(this.model.get_property_value_by_name('show_close') == 'yes')
							this.$close.children('h3').css('margin-right', '40px');
					}
					else {
						this.$close.html('');
					}

					if(this.model.get_property_value_by_name('show_close') == 'yes') {
						this.$close.append(this.$close_icon);
					}
				}
				else
					this.$el.find('.close_lightbox').css('display', 'none');

				var me = this;

				if(this.model.get_property_value_by_name('click_out_close') == 'yes') {
					this.$bg.unbind('click');
					this.$bg.bind('click', function() {
						me.hide();
					});
				} else {
					this.$bg.unbind('click');
				}

				this.$bg.css('background-color', this.model.get_property_value_by_name('overlay_color') );
				this.$el.css('background-color', this.model.get_property_value_by_name('lightbox_color') );

				/*if(this.$el.hasClass('init_state')) {
					this.$el.find('.upfront-region-edit-trigger-small').trigger('click');
				}*/
				this.$el.removeClass('init_state');

				if(this.model.get_property_value_by_name('delete')) {
					this.model.set_property('delete', false);
					this.on_delete_click();
				}


			},
			update_region_position: function () {
				var $main = $(Upfront.Settings.LayoutEditor.Selectors.main),
					grid = Upfront.Settings.LayoutEditor.Grid,
					col = this.model.get_property_value_by_name('col'),
					height = this.model.get_property_value_by_name('height');



				if ( !col )
					this.model.set_property('col', 10, true);
				if ( !height )
					this.model.set_property('height', 225, true);

				width =  col*grid.column_width

				var css = {
						width: width || 225,
						minHeight: parseInt(height) || 225
					};

				css['margin-left'] = parseInt(-(width/2)+$('#sidebar-ui').width()/2);
				css['margin-top'] = parseInt(-(height/2));

				this.$el.find('> .upfront-region-wrapper > .upfront-modules_container').css( {
					width: Math.floor(css.width/grid.column_width) * grid.column_width,
					'minHeight': css.minHeight
				});
				this.$el.css(css);

			},
			/*update_position_hint: function (pos, $helper) {
				var hint = '';
				if ( typeof pos.top == 'number' )
					hint += '<b>top:</b>' + pos.top;
				else if ( typeof pos.bottom == 'number' )
					hint += '<b>bottom:</b>' + pos.bottom;
				if ( typeof pos.left == 'number' )
					hint += ' <b>left:</b>' + pos.left;
				else if ( typeof pos.right == 'number' )
					hint += ' <b>right:</b>' + pos.right;
				( $helper ? $helper : this.$el ).find('.upfront-region-position-hint').html(hint);
			},*/
			render_edit_position: function () {
				this.edit_position = new Upfront.Views.Editor.RegionFixedEditPosition({model: this.model});
				this.edit_position.render();
				this.$el.append(this.edit_position.el);
			},
			trigger_edit: function (e) {
				this.on_settings_click();
				e.stopPropagation();

			},
			close_edit: function (e) {
				var container_view = this.parent_view.get_container_view(this.model);
				container_view.close_edit();
				if(typeof(e) !== 'undefined')
					e.stopPropagation();
			},
			check_modules: function () {
				var total = this.$el.find('> .upfront-region-wrapper > .upfront-modules_container > .upfront-editable_entities_container').find('.upfront-module').size();
				if ( total == 0 ){
					this.$el.removeClass('upfront-region-has-modules');
					this.$el.addClass('upfront-region-empty');
				}
				else {
					this.$el.removeClass('upfront-region-empty');
					this.$el.addClass('upfront-region-has-modules');
				}
			},
			on_change_breakpoint: function (breakpoint) {
					this.hide();
			}
		}),


		Regions = _Upfront_PluralEditor.extend({
			className: "upfront-regions",
			allow_edit: true,
			init: function () {
				this.stopListening(this.model, 'add', this.render);
				this.listenTo(this.model, 'add', this.on_add);
				this.stopListening(this.model, 'remove', this.render);
				this.listenTo(this.model, 'remove', this.on_remove);
				this.listenTo(this.model, 'reset', this.on_reset);
				//this.listenTo(Upfront.Events, 'command:region:edit_toggle', this.on_edit_toggle);
				//this.listenTo(Upfront.Events, 'command:region:fixed_edit_toggle', this.on_edit_toggle);
				this.listenTo(Upfront.Events, 'entity:region:resize_start', this.pause_edit);
				this.listenTo(Upfront.Events, 'entity:region:resize_stop', this.resume_edit);
				this.listenTo(Upfront.Events, "entity:region:deactivated", this.deactivate_region);
				this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.on_change_breakpoint);
			},
			render: function () {
				this.$el.html('');
				var me = this;
				if ( typeof this.container_views != 'object' )
					this.container_views = {};
				if ( typeof this.sub_container_views != 'object' )
					this.sub_container_views = {};
				if ( typeof Upfront.data.region_views != 'object' )
					Upfront.data.region_views = {};
				this.model.each(function (region) {
					me.render_container(region);
				});
				this.model.each(function (region, index) {
					me.render_region(region);
				});
				this.apply_adapt_region_to_breakpoints();
			},
			render_container: function (region, index) {
				var container = region.get("container"),
					name = region.get("name");
				if ( region.is_main() || (container == 'lightbox' && !this.container_views[region.cid])) {
					var container_view = this.container_views[region.cid] || this.create_container_instance(region);
					container_view.parent_view = this;
					this.listenTo(container_view, "activate_region", this.activate_region_container);
					if ( index >= 0 ){
						this.$el.find('.upfront-region').eq(index).closest('.upfront-region-container').before(container_view.el);
					}
					else {
						this.$el.append(container_view.el);
					}
					container_view.render();
					if ( !this.container_views[region.cid] ){
						this.container_views[region.cid] = container_view;
					}
					else {
						container_view.delegateEvents();
					}
					Upfront.Events.trigger("entity:regions:render_container", container_view, container_view.model);
					return container_view;
				}
			},
			render_region: function (region, sub) {
				var local_view = Upfront.data.region_views[region.cid] || this.create_region_instance(region),
					container_view = this.get_container_view(region),
					sub = sub ? sub : region.get('sub'),
					sub_container_view
				;
				if ( !container_view ) return;

				if ( sub == 'top' || sub == 'bottom' ){
					sub_container_view = this.sub_container_views[region.cid] || new RegionSubContainer({"model": region});
					if ( sub == 'top' ) {
						container_view.$layout.before(sub_container_view.el);
					}
					else {
						container_view.$layout.after(sub_container_view.el);
					}
					sub_container_view.parent_view = this;
					sub_container_view.listenTo(container_view.model.get('properties'), 'change', sub_container_view.update);
					sub_container_view.render();
					local_view.sub_container_view = sub_container_view;
					sub_container_view.$layout.append(local_view.el);
					if ( !this.sub_container_views[region.cid] ){
						this.sub_container_views[region.cid] = sub_container_view;
					}
					else {
						sub_container_view.delegateEvents();
					}
				}
				else if ( sub == 'left' ) {
					container_view.$layout.prepend(local_view.el);
				}
				else if ( sub == 'fixed' ) {
					container_view.$el.append(local_view.el);
				}
				else {
					container_view.$layout.append(local_view.el);
				}

				if ( !Upfront.data.region_views[region.cid] ){
					local_view.parent_view = this;
					container_view.listenTo(local_view, "region_render", container_view.on_region_render);
					container_view.listenTo(local_view, "region_update", container_view.on_region_update);
					container_view.listenTo(local_view, "region_changed", container_view.on_region_changed);
/*
					local_view.bind("region_render", container_view.on_region_render, container_view);
					local_view.bind("region_update", container_view.on_region_update, container_view);
					local_view.bind("region_changed", container_view.on_region_changed, container_view);
					*/
					if ( region.is_main() )
						//container_view.bind("region_resize", local_view.region_resize, local_view);
						local_view.listenTo(container_view, 'region_resize', local_view.region_resize);
					else
						container_view.add_sub_model(region);
					local_view.render();
					//local_view.bind("activate_region", this.activate_region, this);
					this.listenTo(local_view, 'activate_region', this.activate_region);
					Upfront.data.region_views[region.cid] = local_view;
				}
				else {
					local_view.render();
					local_view.delegateEvents();
				}
				if ( region.get("default") ) {
					local_view.trigger("activate_region", local_view);
				}
				Upfront.Events.trigger("entity:regions:render_region", local_view, local_view.model);
				return local_view;
			},
			create_container_instance: function (model) {
				return new RegionContainer({"model": model});
			},
			create_region_instance: function (model) {
				var type = model.get('type');
				if ( type == 'fixed' )
					return new RegionFixed({"model": model});
				else if ( type == 'lightbox')
					return new RegionLightbox({"model": model});
				else
					return new Region({"model": model});
			},
			get_container_view: function (region) {
				return _.find(this.container_views, function (container) {
					var name = container.model.get("container") || container.model.get("name");
					if ( region.get("container") == name || region.get("name") == name )
						return true;
				});
			},
			activate_region: function (region) {
				if ( ! this.allow_edit )
					return;
				var region = region.model ? region : Upfront.data.region_views[region.cid],
					new_active_region = region.model;
				if ( this.model.active_region == new_active_region )
					return;
				this.model.active_region = new_active_region;
				if ( region.$el ){
					$('.upfront-region-active').removeClass('upfront-region-active');
					region.$el.addClass('upfront-region-active');
					var container = this.get_container_view(region.model);
					if ( container ){
						$('.upfront-region-container-active').removeClass('upfront-region-container-active');
						container.$el.addClass('upfront-region-container-active');
					}
					$('.upfront-region-sub-container-active').removeClass('upfront-region-sub-container-active');
					if ( region.sub_container_view ){
						region.sub_container_view.$el.addClass('upfront-region-sub-container-active');
					}
					Upfront.Events.trigger("entity:region:activated", region);
				}
			},
			deactivate_region: function () {
				if ( ! this.allow_edit || ! this.model.active_region )
					return;
				$('.upfront-region-active').removeClass('upfront-region-active');
				$('.upfront-region-container-active').removeClass('upfront-region-container-active');
				this.model.active_region = null;
			},
			activate_region_container: function (container) {
				var region_view = Upfront.data.region_views[container.model.cid];
				if ( region_view )
					region_view.trigger("activate_region", region_view);
			},
			pause_edit: function () {
				this.allow_edit = false;
			},
			resume_edit: function () {
				this.allow_edit = true;
			},
			on_edit_toggle: function (edit) {
				this.allow_edit = edit;
			},
			on_add: function (model, collection, options) {
				var container_view = this.get_container_view(model),
					index = typeof options.index != 'undefined' ? options.index : -1,
					sub = options.sub ? options.sub : false,
					region_view;
				if ( ! container_view ){
					this.render_container(model, index);
					region_view  = this.render_region(model);
				}
				else {
					region_view = this.render_region(model, sub);
				}
				this.apply_adapt_region_to_breakpoints();

				Upfront.Events.trigger("entity:region:added", region_view, region_view.model);
			},
			on_remove: function (model) {
				var view = Upfront.data.region_views[model.cid];
				if ( !view )
					return;
				var container_view = this.get_container_view(model),
					sub_container_view = this.sub_container_views[model.cid];
				delete Upfront.data.region_views[model.cid];
				if ( view.region_panels ){
					view.region_panels.unbind();
					view.region_panels.remove();
				}
				if ( view.bg_setting ){
					view.bg_setting.unbind();
					view.bg_setting.remove();
				}
				if ( view.edit_position ){
					view.edit_position.unbind();
					view.edit_position.remove();
				}
				view.unbind();
				view.remove();
				if ( container_view){
					if ( container_view.sub_model.length > 0 ) {
						var main_view = Upfront.data.region_views[container_view.model.cid];
						_.each(container_view.sub_model, function(sub, i){
							if ( sub == model ){
								container_view.sub_model.splice(i, 1);
							}
							else {
								var sub_view = Upfront.data.region_views[sub.cid];
								if ( sub_view ) sub_view.update();
							}
						});
						if ( main_view ) main_view.update();
					}
					if ( container_view.sub_model.length == 0 ){
						delete this.container_views[container_view.model.cid];
						if ( container_view.region_fixed_panels ){
							container_view.region_fixed_panels.unbind();
							container_view.region_fixed_panels.remove();
						}
						container_view.unbind();
						container_view.remove();
					}
				}
				if ( sub_container_view ){
					delete this.sub_container_views[model.cid];
					sub_container_view.unbind();
					sub_container_view.remove();
				}
				Upfront.Events.trigger("entity:region:removed", view, model);
			},
			on_reset: function (collection, options) {
				var me = this;
				// Properly remove old views
				if (options.previousModels) {
					_.each(options.previousModels, function(model){
						me.on_remove(model);
					});
				}
			},
			apply_adapt_region_to_breakpoints: function () {
				var current_breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint;
				if ( current_breakpoint && !current_breakpoint.default )
					return;
				var me = this,
					ed = Upfront.Behaviors.GridEditor,
					breakpoints = Upfront.Views.breakpoints_storage.get_breakpoints().get_enabled();
				_.each(breakpoints, function(each){
					var breakpoint = each.toJSON();
					if ( breakpoint.default )
						return;
					ed.adapt_region_to_breakpoint(me.model, breakpoint.id, breakpoint.columns, true);
				});
			},
			on_change_breakpoint: function (breakpoint) {

			},
			remove: function(){
				var me = this;
				this.model.each(function(model){
					me.on_remove(model);
				});
				Backbone.View.prototype.remove.call(this);
				// Remove container views
				_.each(this.container_views, function(view, index){
					view.remove();
					delete me.container_views[index];
				});
				this.container_views = null;
				// Remove sub container views
				_.each(this.sub_container_views, function(view, index){
					view.remove();
					delete me.sub_container_views[index];
				});
				this.sub_container_views = null;
				this.model.reset([], {silent:true});
				this.model = false;
				this.options = false;
			}
		}),

		Wrapper = _Upfront_SingularEditor.extend({
			events: {
				"mouseup": "on_mouse_up",
				"click > .upfront-wrapper-meta > .upfront-add-spacer": "on_add_spacer"
			},
			attributes: function(){
				var cls = "upfront-wrapper",
					model_cls = this.model.get_property_value_by_name('class');
				return {
					"class": cls + " " + model_cls,
					"id": this.model.get_wrapper_id()
				}
			},
			init: function () {
				// this.model.get("properties").bind("change", this.update, this);
				this.listenTo(this.model.get("properties"), 'change', this.update);
				// this.model.bind("remove", this.on_remove, this);
				this.listenTo(this.model, 'remove', this.on_remove);

				this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.on_change_breakpoint);
				this.listenTo(Upfront.Events, 'entity:module:update_position', this.on_module_update);
				this.listenTo(Upfront.Events, 'entity:modules:render_module', this.on_module_update);
				this.listenTo(Upfront.Events, 'layout:after_render', this.on_layout_after_render);

				// this one to do fix the wrapper visibility for elements inside a lightbox
				this.listenTo(Upfront.Events, 'upfront:lightbox:show', this.on_lightbox_show);
			},
			render: function () {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					template = _.template(_Upfront_Templates["wrapper"])
				;
				Upfront.Events.trigger('entity:wrapper:before_render', this, this.model);
				this.$el.html(template);
				if ( breakpoint && !breakpoint.default ) {
					this.update_position();
				}
				Upfront.Events.trigger('entity:wrapper:after_render', this, this.model);
			},
			update: function (prop, options) {
				if ( prop.id == 'class' ){
					this.$el.attr('class', this.attributes().class);
				}
				else if ( prop.id == 'breakpoint' ){
					this.update_position();
				}
			},
			update_position: function () {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint;
				if ( ! breakpoint )
					return;
				var grid = Upfront.Settings.LayoutEditor.Grid,
					data = this.model.get_property_value_by_name('breakpoint'),
					breakpoint_data = data[breakpoint.id],
					parent_width = this.$el.parent().width(),
					parent_col = Math.round(parent_width/grid.column_width)
				;
				this.$el.css({
					minHeight: '',
					marginRight: 0
				});
				if ( breakpoint_data && typeof breakpoint_data.col == 'number' ){
					this.$el.css('width', (breakpoint_data.col/parent_col*100) + '%');
					this.$el.data('breakpoint_col', breakpoint_data.col);
				}
				else {
					this.$el.css('width', '');
					this.$el.removeData('breakpoint_col');
				}
				if ( breakpoint_data && typeof breakpoint_data.order == 'number' ){
					this.$el.css('order', breakpoint_data.order);
					this.$el.data('breakpoint_order', breakpoint_data.order);
				}
				else {
					this.$el.css('order', '');
					this.$el.removeData('breakpoint_order');
				}
				if ( breakpoint_data && breakpoint_data.clear ) {
					this.$el.data('breakpoint_clear', breakpoint_data.clear);
				}
				else {
					this.$el.removeData('breakpoint_clear');
				}
				Upfront.Events.trigger('entity:wrapper:update_position', this, this.model);
			},
			on_add_spacer: function (e) {
				var $target = $(e.target),
					position = $target.attr('data-position');
				e.preventDefault();
				this.add_spacer(position);
			},
			add_spacer: function (position, spacer_col, current_col) {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					ed = Upfront.Behaviors.GridEditor,
					col_class = Upfront.Settings.LayoutEditor.Grid.class,
					spacer_col = spacer_col > 0 ? spacer_col : 1,
					current_col = _.isNumber(current_col) && current_col > spacer_col
						? current_col
						: Upfront.Util.width_to_col(this.$el.width()),
					min_col = this._find_child_min_col(),
					new_col = current_col-spacer_col,
					$rsz_wrapper = ( new_col >= min_col ? this.$el : ( this._find_closest_wrapper(position == 'left', spacer_col) ) )
				;
				if ( !$rsz_wrapper.length ) return;
				if ( new_col < min_col ) {
					current_col = Upfront.Util.width_to_col($rsz_wrapper.width());
					new_col = current_col-spacer_col;
				}
				var rsz_model = this.model.collection.get_by_wrapper_id($rsz_wrapper.attr('id')),
					model_cls = this.model.get_property_value_by_name('class'),
					is_clr = ( breakpoint && !breakpoint.default ? this.model.get_breakpoint_property_value('clear') : model_cls.match(/clr/) ),
					object = new Upfront.Models.UspacerModel({
						"name": "",
						"properties": []
					}),
					wrapper_id = Upfront.Util.get_unique_id("wrapper"),
					module = new Upfront.Models.Module({
						"name": "",
						"properties": [
							{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
							{"name": "wrapper_id", "value": wrapper_id},
							{"name": "class", "value": col_class+spacer_col + " upfront-module-spacer"},
							{"name": "has_settings", "value": 0},
							{"name": "default_hide", "value": 1},
							{"name": "toggle_hide", "value": 0},
							{"name": "hide", "value": ( breakpoint && !breakpoint.default ? 1 : 0 )}
						],
						"objects": [
							object
						]
					}),
					wrapper = new Upfront.Models.Wrapper({
						"name": "",
						"properties": [
							{"name": "wrapper_id", "value": wrapper_id},
							{"name": "class", "value": col_class+spacer_col + ( is_clr && position == 'left' ? ' clr' : '' )}
						]
					}),
					$child = this.$el.find("> .upfront-module-view > .upfront-module, > .upfront-module-group"),
					$target_child = ( position == 'right' ? $child.last() : $child.first() ),
					target_model = ed.get_el_model($target_child),
					index = target_model.collection.indexOf(target_model)
				;

				if ( !rsz_model ) return;

				// Change the columns of current/closest wrapper and the containing models
				$rsz_wrapper.find("> .upfront-module-view > .upfront-module, > .upfront-module-group").each(function () {
					var child = ed.get_el_model($(this));
					if ( breakpoint && !breakpoint.default ) {
						child.set_breakpoint_property('edited', true, true);
						child.set_breakpoint_property('col', new_col);
					}
					else {
						child.replace_class(col_class+new_col);
					}
				});
				if ( is_clr && position == 'left' ) {
					if ( breakpoint && !breakpoint.default ) {
						this.model.set_breakpoint_property('clear', false);
					}
					else {
						this.model.remove_class('clr');
					}
				}
				if ( breakpoint && !breakpoint.default ) {
					rsz_model.set_breakpoint_property('edited', true, true);
					rsz_model.set_breakpoint_property('col', new_col);
				}
				else {
					rsz_model.replace_class(col_class+new_col);
				}

				// Add the spacer element
				if ( breakpoint && !breakpoint.default ) {
					wrapper.set_breakpoint_property('edited', true, true);
					wrapper.set_breakpoint_property('clear', ( is_clr && position == 'left' ), true);
					wrapper.set_breakpoint_property('order', this.model.get_breakpoint_property_value('order'));
					module.set_breakpoint_property('edited', true, true);
					module.set_breakpoint_property('hide', 0, true);
					module.set_breakpoint_property('left', 0, true);
					module.set_breakpoint_property('col', spacer_col);
				}
				this.model.collection.add(wrapper);
				module.add_to(target_model.collection, ( position == 'right' ? index+1 : index ));
			},
			_find_closest_wrapper: function (reverse, min_col) {
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					$wrappers = this.$el.parent()
						.children('.upfront-wrapper:visible')
						.filter(function(){
							return ( $(this).height() > 0 )
						})
						.each(Upfront.Util.normalize_sort_elements_cb)
						.sort(Upfront.Util.sort_elements_cb),
					index = $wrappers.index(this.$el),
					is_clr = function ($each) {
						return ( !breakpoint || breakpoint.default ? $each.hasClass('clr') : $each.data('breakpoint_clear') )
					},
					find_cb = function ($each) {
						return ( Upfront.Util.width_to_col($each.width()) > min_col )
					},
					$start = is_clr(this.$el) ? this.$el : Upfront.Util.find_from_elements($wrappers, this.$el, is_clr, true),
					$nexts = Upfront.Util.find_from_elements($wrappers, $start, '.upfront-wrapper', false, is_clr),
					$all = $( _.union( [$start.get(0)], $nexts.map(function(){ return this; }).get() ) ),
					find_1 = Upfront.Util.find_from_elements($all, this.$el, find_cb, reverse),
					find_2 = ( !find_1.length ? Upfront.Util.find_from_elements($all, this.$el, find_cb, !reverse) : find_1 )
				;
				return find_2.first();
			},
			_find_child_min_col: function () {
				var ed = Upfront.Behaviors.GridEditor,
					min_col = 1
				;
				this.parent_view.model.each(function(module){
					if ( !module.get('modules') ) return; // Not group, no min_col change
					var module_view = Upfront.data.module_views[module.cid],
						mod_min_col = module_view ? ed.get_group_min_col(module_view) : 1
					;
					min_col = Math.max(min_col, mod_min_col);
				});
				return min_col;
			},
			toggle_wrapper_visibility: function () {
				var visible = ( parseInt(this.$el.css('height'), 10) > 0 );
				if ( !visible && this.$el.css('display') != 'none' ) {
					this.$el.css('display', 'none');
				}
				else if ( visible ) {
					this.$el.css('display', '');
				}
			},
			on_change_breakpoint: function () {
				this.$el.css({
					display: ''
				});
				this.update_position();
			},
			on_module_update: function (from_view) {
				if ( !from_view.wrapper_view || from_view.wrapper_view != this ) return;
				if ( from_view instanceof Upfront.Views.ModuleGroup ) return;
				this.toggle_wrapper_visibility();
			},
			on_layout_after_render: function () {
				if ( this.$el.find('> .upfront-module-group').length > 0 ) return; // Don't update for group
				this.toggle_wrapper_visibility();
			},
			on_lightbox_show: function () {
				if ( this.$el.find('> .upfront-module-group').length > 0 ) return; // Don't update for group
				this.toggle_wrapper_visibility();
			},
			on_remove: function () {
				this.unbind();
				this.remove();
			}
		}),

		Layout = _Upfront_SingularEditor.extend({
			tpl: _.template(_Upfront_Templates.layout),
			events: {
				"click": "on_click"
			},
			initialize: function (opts) {
				this._has_ruler = false;
				this.listenTo(this.model.get("properties"), 'change', this.update);
				this.listenTo(this.model.get("properties"), 'add', this.update);
				this.listenTo(this.model.get("properties"), 'remove', this.update);
				this.listenTo(Upfront.Events, "command:layout:edit_background", this.open_edit_background);
				this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.on_change_breakpoint);
				this.listenTo(Upfront.Events, "application:mode:after_switch", this.on_mode_switch);
				$(window).on('resize.upfront_layout', this, this.on_window_resize);
				$(window).on('scroll.upfront_layout', this, this.on_window_scroll);
				$(window).on('keydown.upfront_layout', this, this.on_keydown);
				this.render();
			},
			update: function () {
				this.update_background();
			},
			render: function () {
				this.$el.addClass('upfront-layout-view');
				this.$el.html(this.tpl(this.model.toJSON()));
				this.$layout = this.$(".upfront-layout");
				this.remove_selections();

				if (!this.local_view) {
					this.local_view = new Regions({"model": this.model.get("regions")});
					this.$layout.append(this.local_view.el);
					this.local_view.render();
				}
				else {
					this.$layout.append(this.local_view.el);
					this.local_view.render();
					this.local_view.delegateEvents();
				}

				this.update();

				this.bg_setting = new Upfront.Views.Editor.ModalBgSetting({model: this.model, to: this.$el, width: 420});
				this.bg_setting.render();
				this.$el.append(this.bg_setting.el);

				this.fix_height();

				// Use flexbox when we can
				if ( Upfront.Util.css_support('flex') )
					$('html').addClass('flexbox-support');

				Upfront.Events.trigger("layout:after_render");
			},
			on_click: function (e) {
				//Check we are not selecting text
				//var selection = document.getSelection ? document.getSelection() : document.selection;
				//if(selection && selection.type == 'Range')
				//	return;
				var currentEntity = Upfront.data.currentEntity;
				// Deactivate settings on clicking anywhere in layout, but the settings button
				if(!$(e.target).closest('.upfront-entity_meta').length && !$(e.target).closest('#upfront-csseditor').length){
					Upfront.Events.trigger("entity:settings:deactivate");
				}
				Upfront.Events.trigger("entity:contextmenu:deactivate");
				if(currentEntity){
					//If the click has been made outside the currentEntity, deactivate it
					if(!$(e.target).closest(currentEntity.el).length){
						currentEntity.trigger('deactivated', e);
						currentEntity.$el.removeClass("upfront-active_entity");
						Upfront.Events.trigger("entity:deactivated", e);
						Upfront.data.currentEntity = false;
					}
				}
				// Deactivate if clicked on blank area of region
				if($(e.target).hasClass('upfront-editable_entities_container')){
					Upfront.Events.trigger("entity:deactivated");
				}

				// Close region editing on click anywhere out the region
				if ( $(e.target).hasClass('upfront-region-editing-overlay') && !$('.upfront-region-bg-setting-open').length ){
					Upfront.Events.trigger("entity:region:deactivated");
				}
				this.remove_selections();
				// Deactiving group reorder on clicking anywhere
				if ( !$(e.target).closest('.upfront-module-group-on-edit').length ){
					Upfront.Events.trigger("command:module_group:finish_edit");
				}
				// Close group inline panel on clicking anywhere
				if ( !$(e.target).closest('.upfront-module-group.controls-visible').length ){
					Upfront.Events.trigger("command:module_group:close_panel");
				}
			},
			on_keydown: function (e) {
				var currentEntity = Upfront.data.currentEntity;

				if (
					typeof currentEntity === 'undefined' ||
					!currentEntity ||
					!currentEntity instanceof ObjectView ||
					currentEntity.$el.find( '.redactor-box' ).length > 0 ||
					!currentEntity.paddingControl
				) {
					return;
				}

				if (e.keyCode === 38 || e.keyCode === 40) {
					e.preventDefault();
					e.stopPropagation();

					switch (e.keyCode) {
						case 38:
							currentEntity.paddingControl.on_up_arrow_click();
							break;
						case 40:
							currentEntity.paddingControl.on_down_arrow_click();
							break;
					}
				}
			},
			on_mode_switch: function () {
				if ( Upfront.Application.get_current() !== Upfront.Settings.Application.MODE.RESPONSIVE )
					this.remove_ruler();
				else
					this.render_ruler(true);
			},
			on_change_breakpoint: function (breakpoint) {
				var grid = Upfront.Settings.LayoutEditor.Grid;
				Upfront.Settings.LayoutEditor.CurrentBreakpoint = breakpoint;
				grid.size = breakpoint.columns;
				if ( breakpoint.default ){
					this.$layout.css('width', '');
					this.render_ruler(true);
					this.remove_gutter();
					Upfront.Behaviors.LayoutEditor.enable_mergeable();
				}
				else {
					this.$layout.width(breakpoint.width);
					this.render_ruler(false, breakpoint.width);
					this.render_gutter(breakpoint.width);
					Upfront.Behaviors.LayoutEditor.disable_mergeable();
				}
				this.update_grid_css();
			},
			render_gutter: function (width) {
				var $gutter = this.$el.find('.upfront-layout-gutter');
				if ( ! $gutter.length ){
					$gutter = $('<div class="upfront-layout-gutter"><div class="upfront-layout-gutter-left"></div><div class="upfront-layout-gutter-right"></div></div>');
					this.$el.prepend($gutter);
				}
				$gutter.find('.upfront-layout-gutter-left').css('margin-right', Math.ceil(width/2));
				$gutter.find('.upfront-layout-gutter-right').css('margin-left', Math.ceil(width/2));
			},
			remove_gutter: function () {
				this.$el.find('.upfront-layout-gutter').remove();
			},
			render_ruler: function (follow_grid, width) {
				var grid = Upfront.Settings.LayoutEditor.Grid,
					width = follow_grid ? grid.size*grid.column_width : width,
					$ruler_container = this.$el.find('.upfront-ruler-container'),
					$ruler = $ruler_container.find('.upfront-ruler'),
					create_mark = function (at, size, show_num) {
						return '<div class="upfront-ruler-mark" style="width:' + size + 'px;">' +
									( show_num ? '<div class="upfront-ruler-mark-num">' +  at + '</div>' : '' ) +
								'</div>';
					},
					mark;
				if ( !$ruler_container.length ) {
					$ruler_container = $('<div class="upfront-ruler-container"></div>');
					$ruler = $('<div class="upfront-ruler upfront-ui"></div>');
					this.$el.prepend($ruler_container);
					$ruler_container.prepend($ruler);
				}
				$ruler.empty();
				$ruler.css('width', width);
				for ( mark = 0; mark < width; mark+=100 ){
					$ruler.append( create_mark(mark, 100, (mark+40 > width ? false : true)) );
				}
				if ( width > (mark-100) )
					$ruler.append( create_mark(width, width-(mark-100), true) );
				this._has_ruler = true;
			},
			remove_ruler: function () {
				this.$el.find('.upfront-ruler-container').remove();
				this._has_ruler = false;
			},
			update_ruler: function () {
				if ( !this._has_ruler )
					return;
				var scroll_top = $(window).scrollTop(),
					$ruler_container = this.$el.find('.upfront-ruler-container'),
					ruler_position = $ruler_container.css('position');
				if ( scroll_top > 0 && ruler_position != 'fixed' ){
					var offset = this.$el.offset(),
						ruler_container_off = $ruler_container.offset();
					$ruler_container.css({
						position: 'fixed',
						top: offset.top,
						left: ruler_container_off.left,
						right: 0,
						width: 'auto'
					});
				}
				else if ( scroll_top <= 0 && ruler_position == 'fixed' ) {
					$ruler_container.css({
						position: '',
						top: '',
						left: '',
						right: '',
						width: ''
					});
				}
			},
			on_window_scroll: function (e) {
				var me = e.data;
				me.update_ruler();
			},
			update_grid_css: function () {
				var grid = Upfront.Settings.LayoutEditor.Grid,
					styles = [],
					selector = '#page.upfront-layout-view';
				styles.push(selector + ' .upfront-grid-layout { width: ' + grid.column_width*grid.size + 'px; }');
				styles.push(selector + ' .upfront-object { padding: ' + grid.column_padding + 'px; }');
				styles.push(selector + ' .upfront-overlay-grid {background-size: 100% ' + grid.baseline + 'px; }');
				styles.push(selector + ' .plaintxt_padding {padding: ' + grid.type_padding + 'px; }');
				styles.push(selector + ' .upfront-inserted_image-wrapper .wp-caption-text, ' + selector + ' .uinsert-image-wrapper { padding: ' + grid.column_padding + 'px; }');
				styles.push(selector + ' .upfront-module-group-bg-padding { margin: ' + grid.column_padding + 'px; }');

				if ( $('#upfront-grid-style-inline').length )
					$('#upfront-grid-style-inline').html( styles.join("\n") );
				else
					$('body').append('<style id="upfront-grid-style-inline">' + styles.join("\n") + '</style>');
			},
			remove: function(){
				if(this.local_view)
					this.local_view.remove();
				this.local_view = null;
				$(window).off('resize.upfront_layout');
				$(window).off('scroll.upfront_layout');
				if (this.bg_setting)
					this.bg_setting.remove();
				this.bg_setting = null;

				Backbone.View.prototype.remove.call(this);
				this.model = false;
				this.options = false;
			},
			open_edit_background: function () {
				this.bg_setting.open().always(function(){

				});
			},
			fix_height: function () {
				this.$('.upfront-layout').css('min-height', $(window).height());
			},
			remove_selections: function () {
				// Unselect selection
				if ( !Upfront.Behaviors.LayoutEditor.selecting ){
					Upfront.Events.trigger("command:selection:remove");
				}
			}
		})
	;

	return {
		"Views": {
			"ObjectView": ObjectView,
			"Module": Module,
			"ModuleGroup": ModuleGroup,
			"Wrapper": Wrapper,
			"Layout": Layout,
			"ContextMenu": ContextMenu,
			"ContextMenuList": ContextMenuList,
			"ContextMenuItem": ContextMenuItem,
			"RegionView": Region,
			"RegionLightboxView": RegionLightbox,
			"RegionContainerView": RegionContainer,
			"RegionsView": Regions
		},
		"Mixins": {
			"FixedObject": FixedObject_Mixin,
			"FixedObjectInAnonymousModule": FixedObjectInAnonymousModule_Mixin,
			Anchorable: Anchorable_Mixin,
		}
	};
});

})(jQuery);
//@ sourceURL=upfront-views.js
;
/* Chosen v1.1.0 | (c) 2011-2013 by Harvest | MIT License, https://github.com/harvesthq/chosen/blob/master/LICENSE.md */
!function(){var a,AbstractChosen,Chosen,SelectParser,b,c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};SelectParser=function(){function SelectParser(){this.options_index=0,this.parsed=[]}return SelectParser.prototype.add_node=function(a){return"OPTGROUP"===a.nodeName.toUpperCase()?this.add_group(a):this.add_option(a)},SelectParser.prototype.add_group=function(a){var b,c,d,e,f,g;for(b=this.parsed.length,this.parsed.push({array_index:b,group:!0,label:this.escapeExpression(a.label),children:0,disabled:a.disabled}),f=a.childNodes,g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(this.add_option(c,b,a.disabled));return g},SelectParser.prototype.add_option=function(a,b,c){return"OPTION"===a.nodeName.toUpperCase()?(""!==a.text?(null!=b&&(this.parsed[b].children+=1),this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,value:a.value,text:a.text,html:a.innerHTML,selected:a.selected,disabled:c===!0?c:a.disabled,group_array_index:b,classes:a.className,style:a.style.cssText})):this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,empty:!0}),this.options_index+=1):void 0},SelectParser.prototype.escapeExpression=function(a){var b,c;return null==a||a===!1?"":/[\&\<\>\"\'\`]/.test(a)?(b={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},c=/&(?!\w+;)|[\<\>\"\'\`]/g,a.replace(c,function(a){return b[a]||"&amp;"})):a},SelectParser}(),SelectParser.select_to_array=function(a){var b,c,d,e,f;for(c=new SelectParser,f=a.childNodes,d=0,e=f.length;e>d;d++)b=f[d],c.add_node(b);return c.parsed},AbstractChosen=function(){function AbstractChosen(a,b){this.form_field=a,this.options=null!=b?b:{},AbstractChosen.browser_is_supported()&&(this.is_multiple=this.form_field.multiple,this.set_default_text(),this.set_default_values(),this.setup(),this.set_up_html(),this.register_observers())}return AbstractChosen.prototype.set_default_values=function(){var a=this;return this.click_test_action=function(b){return a.test_active_click(b)},this.activate_action=function(b){return a.activate_field(b)},this.active_field=!1,this.mouse_on_container=!1,this.results_showing=!1,this.result_highlighted=null,this.allow_single_deselect=null!=this.options.allow_single_deselect&&null!=this.form_field.options[0]&&""===this.form_field.options[0].text?this.options.allow_single_deselect:!1,this.disable_search_threshold=this.options.disable_search_threshold||0,this.disable_search=this.options.disable_search||!1,this.enable_split_word_search=null!=this.options.enable_split_word_search?this.options.enable_split_word_search:!0,this.group_search=null!=this.options.group_search?this.options.group_search:!0,this.search_contains=this.options.search_contains||!1,this.single_backstroke_delete=null!=this.options.single_backstroke_delete?this.options.single_backstroke_delete:!0,this.max_selected_options=this.options.max_selected_options||1/0,this.inherit_select_classes=this.options.inherit_select_classes||!1,this.display_selected_options=null!=this.options.display_selected_options?this.options.display_selected_options:!0,this.display_disabled_options=null!=this.options.display_disabled_options?this.options.display_disabled_options:!0},AbstractChosen.prototype.set_default_text=function(){return this.default_text=this.form_field.getAttribute("data-placeholder")?this.form_field.getAttribute("data-placeholder"):this.is_multiple?this.options.placeholder_text_multiple||this.options.placeholder_text||AbstractChosen.default_multiple_text:this.options.placeholder_text_single||this.options.placeholder_text||AbstractChosen.default_single_text,this.results_none_found=this.form_field.getAttribute("data-no_results_text")||this.options.no_results_text||AbstractChosen.default_no_result_text},AbstractChosen.prototype.mouse_enter=function(){return this.mouse_on_container=!0},AbstractChosen.prototype.mouse_leave=function(){return this.mouse_on_container=!1},AbstractChosen.prototype.input_focus=function(){var a=this;if(this.is_multiple){if(!this.active_field)return setTimeout(function(){return a.container_mousedown()},50)}else if(!this.active_field)return this.activate_field()},AbstractChosen.prototype.input_blur=function(){var a=this;return this.mouse_on_container?void 0:(this.active_field=!1,setTimeout(function(){return a.blur_test()},100))},AbstractChosen.prototype.results_option_build=function(a){var b,c,d,e,f;for(b="",f=this.results_data,d=0,e=f.length;e>d;d++)c=f[d],b+=c.group?this.result_add_group(c):this.result_add_option(c),(null!=a?a.first:void 0)&&(c.selected&&this.is_multiple?this.choice_build(c):c.selected&&!this.is_multiple&&this.single_set_selected_text(c.text));return b},AbstractChosen.prototype.result_add_option=function(a){var b,c;return a.search_match?this.include_option_in_results(a)?(b=[],a.disabled||a.selected&&this.is_multiple||b.push("active-result"),!a.disabled||a.selected&&this.is_multiple||b.push("disabled-result"),a.selected&&b.push("result-selected"),null!=a.group_array_index&&b.push("group-option"),""!==a.classes&&b.push(a.classes),c=document.createElement("li"),c.className=b.join(" "),c.style.cssText=a.style,c.setAttribute("data-option-array-index",a.array_index),c.innerHTML=a.search_text,this.outerHTML(c)):"":""},AbstractChosen.prototype.result_add_group=function(a){var b;return a.search_match||a.group_match?a.active_options>0?(b=document.createElement("li"),b.className="group-result",b.innerHTML=a.search_text,this.outerHTML(b)):"":""},AbstractChosen.prototype.results_update_field=function(){return this.set_default_text(),this.is_multiple||this.results_reset_cleanup(),this.result_clear_highlight(),this.results_build(),this.results_showing?this.winnow_results():void 0},AbstractChosen.prototype.reset_single_select_options=function(){var a,b,c,d,e;for(d=this.results_data,e=[],b=0,c=d.length;c>b;b++)a=d[b],a.selected?e.push(a.selected=!1):e.push(void 0);return e},AbstractChosen.prototype.results_toggle=function(){return this.results_showing?this.results_hide():this.results_show()},AbstractChosen.prototype.results_search=function(){return this.results_showing?this.winnow_results():this.results_show()},AbstractChosen.prototype.winnow_results=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;for(this.no_results_clear(),e=0,g=this.get_search_text(),a=g.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),d=this.search_contains?"":"^",c=new RegExp(d+a,"i"),j=new RegExp(a,"i"),m=this.results_data,k=0,l=m.length;l>k;k++)b=m[k],b.search_match=!1,f=null,this.include_option_in_results(b)&&(b.group&&(b.group_match=!1,b.active_options=0),null!=b.group_array_index&&this.results_data[b.group_array_index]&&(f=this.results_data[b.group_array_index],0===f.active_options&&f.search_match&&(e+=1),f.active_options+=1),(!b.group||this.group_search)&&(b.search_text=b.group?b.label:b.html,b.search_match=this.search_string_match(b.search_text,c),b.search_match&&!b.group&&(e+=1),b.search_match?(g.length&&(h=b.search_text.search(j),i=b.search_text.substr(0,h+g.length)+"</em>"+b.search_text.substr(h+g.length),b.search_text=i.substr(0,h)+"<em>"+i.substr(h)),null!=f&&(f.group_match=!0)):null!=b.group_array_index&&this.results_data[b.group_array_index].search_match&&(b.search_match=!0)));return this.result_clear_highlight(),1>e&&g.length?(this.update_results_content(""),this.no_results(g)):(this.update_results_content(this.results_option_build()),this.winnow_results_set_highlight())},AbstractChosen.prototype.search_string_match=function(a,b){var c,d,e,f;if(b.test(a))return!0;if(this.enable_split_word_search&&(a.indexOf(" ")>=0||0===a.indexOf("["))&&(d=a.replace(/\[|\]/g,"").split(" "),d.length))for(e=0,f=d.length;f>e;e++)if(c=d[e],b.test(c))return!0},AbstractChosen.prototype.choices_count=function(){var a,b,c,d;if(null!=this.selected_option_count)return this.selected_option_count;for(this.selected_option_count=0,d=this.form_field.options,b=0,c=d.length;c>b;b++)a=d[b],a.selected&&(this.selected_option_count+=1);return this.selected_option_count},AbstractChosen.prototype.choices_click=function(a){return a.preventDefault(),this.results_showing||this.is_disabled?void 0:this.results_show()},AbstractChosen.prototype.keyup_checker=function(a){var b,c;switch(b=null!=(c=a.which)?c:a.keyCode,this.search_field_scale(),b){case 8:if(this.is_multiple&&this.backstroke_length<1&&this.choices_count()>0)return this.keydown_backstroke();if(!this.pending_backstroke)return this.result_clear_highlight(),this.results_search();break;case 13:if(a.preventDefault(),this.results_showing)return this.result_select(a);break;case 27:return this.results_showing&&this.results_hide(),!0;case 9:case 38:case 40:case 16:case 91:case 17:break;default:return this.results_search()}},AbstractChosen.prototype.clipboard_event_checker=function(){var a=this;return setTimeout(function(){return a.results_search()},50)},AbstractChosen.prototype.container_width=function(){return null!=this.options.width?this.options.width:""+this.form_field.offsetWidth+"px"},AbstractChosen.prototype.include_option_in_results=function(a){return this.is_multiple&&!this.display_selected_options&&a.selected?!1:!this.display_disabled_options&&a.disabled?!1:a.empty?!1:!0},AbstractChosen.prototype.search_results_touchstart=function(a){return this.touch_started=!0,this.search_results_mouseover(a)},AbstractChosen.prototype.search_results_touchmove=function(a){return this.touch_started=!1,this.search_results_mouseout(a)},AbstractChosen.prototype.search_results_touchend=function(a){return this.touch_started?this.search_results_mouseup(a):void 0},AbstractChosen.prototype.outerHTML=function(a){var b;return a.outerHTML?a.outerHTML:(b=document.createElement("div"),b.appendChild(a),b.innerHTML)},AbstractChosen.browser_is_supported=function(){return"Microsoft Internet Explorer"===window.navigator.appName?document.documentMode>=8:/iP(od|hone)/i.test(window.navigator.userAgent)?!1:/Android/i.test(window.navigator.userAgent)&&/Mobile/i.test(window.navigator.userAgent)?!1:!0},AbstractChosen.default_multiple_text="Select Some Options",AbstractChosen.default_single_text="Select an Option",AbstractChosen.default_no_result_text="No results match",AbstractChosen}(),a=jQuery,a.fn.extend({chosen:function(b){return AbstractChosen.browser_is_supported()?this.each(function(){var c,d;c=a(this),d=c.data("chosen"),"destroy"===b&&d?d.destroy():d||c.data("chosen",new Chosen(this,b))}):this}}),Chosen=function(c){function Chosen(){return b=Chosen.__super__.constructor.apply(this,arguments)}return d(Chosen,c),Chosen.prototype.setup=function(){return this.form_field_jq=a(this.form_field),this.current_selectedIndex=this.form_field.selectedIndex,this.is_rtl=this.form_field_jq.hasClass("chosen-rtl")},Chosen.prototype.set_up_html=function(){var b,c;return b=["chosen-container"],b.push("chosen-container-"+(this.is_multiple?"multi":"single")),this.inherit_select_classes&&this.form_field.className&&b.push(this.form_field.className),this.is_rtl&&b.push("chosen-rtl"),c={"class":b.join(" "),style:"width: "+this.container_width()+";",title:this.form_field.title},this.form_field.id.length&&(c.id=this.form_field.id.replace(/[^\w]/g,"_")+"_chosen"),this.container=a("<div />",c),this.is_multiple?this.container.html('<ul class="chosen-choices"><li class="search-field"><input type="text" value="'+this.default_text+'" class="default" autocomplete="off" style="width:25px;" /></li></ul><div class="chosen-drop"><ul class="chosen-results"></ul></div>'):this.container.html('<a class="chosen-single chosen-default" tabindex="-1"><span>'+this.default_text+'</span><div><b></b></div></a><div class="chosen-drop"><div class="chosen-search"><input type="text" autocomplete="off" /></div><ul class="chosen-results"></ul></div>'),this.form_field_jq.hide().after(this.container),this.dropdown=this.container.find("div.chosen-drop").first(),this.search_field=this.container.find("input").first(),this.search_results=this.container.find("ul.chosen-results").first(),this.search_field_scale(),this.search_no_results=this.container.find("li.no-results").first(),this.is_multiple?(this.search_choices=this.container.find("ul.chosen-choices").first(),this.search_container=this.container.find("li.search-field").first()):(this.search_container=this.container.find("div.chosen-search").first(),this.selected_item=this.container.find(".chosen-single").first()),this.results_build(),this.set_tab_index(),this.set_label_behavior(),this.form_field_jq.trigger("chosen:ready",{chosen:this})},Chosen.prototype.register_observers=function(){var a=this;return this.container.bind("mousedown.chosen",function(b){a.container_mousedown(b)}),this.container.bind("mouseup.chosen",function(b){a.container_mouseup(b)}),this.container.bind("mouseenter.chosen",function(b){a.mouse_enter(b)}),this.container.bind("mouseleave.chosen",function(b){a.mouse_leave(b)}),this.search_results.bind("mouseup.chosen",function(b){a.search_results_mouseup(b)}),this.search_results.bind("mouseover.chosen",function(b){a.search_results_mouseover(b)}),this.search_results.bind("mouseout.chosen",function(b){a.search_results_mouseout(b)}),this.search_results.bind("mousewheel.chosen DOMMouseScroll.chosen",function(b){a.search_results_mousewheel(b)}),this.search_results.bind("touchstart.chosen",function(b){a.search_results_touchstart(b)}),this.search_results.bind("touchmove.chosen",function(b){a.search_results_touchmove(b)}),this.search_results.bind("touchend.chosen",function(b){a.search_results_touchend(b)}),this.form_field_jq.bind("chosen:updated.chosen",function(b){a.results_update_field(b)}),this.form_field_jq.bind("chosen:activate.chosen",function(b){a.activate_field(b)}),this.form_field_jq.bind("chosen:open.chosen",function(b){a.container_mousedown(b)}),this.form_field_jq.bind("chosen:close.chosen",function(b){a.input_blur(b)}),this.search_field.bind("blur.chosen",function(b){a.input_blur(b)}),this.search_field.bind("keyup.chosen",function(b){a.keyup_checker(b)}),this.search_field.bind("keydown.chosen",function(b){a.keydown_checker(b)}),this.search_field.bind("focus.chosen",function(b){a.input_focus(b)}),this.search_field.bind("cut.chosen",function(b){a.clipboard_event_checker(b)}),this.search_field.bind("paste.chosen",function(b){a.clipboard_event_checker(b)}),this.is_multiple?this.search_choices.bind("click.chosen",function(b){a.choices_click(b)}):this.container.bind("click.chosen",function(a){a.preventDefault()})},Chosen.prototype.destroy=function(){return a(this.container[0].ownerDocument).unbind("click.chosen",this.click_test_action),this.search_field[0].tabIndex&&(this.form_field_jq[0].tabIndex=this.search_field[0].tabIndex),this.container.remove(),this.form_field_jq.removeData("chosen"),this.form_field_jq.show()},Chosen.prototype.search_field_disabled=function(){return this.is_disabled=this.form_field_jq[0].disabled,this.is_disabled?(this.container.addClass("chosen-disabled"),this.search_field[0].disabled=!0,this.is_multiple||this.selected_item.unbind("focus.chosen",this.activate_action),this.close_field()):(this.container.removeClass("chosen-disabled"),this.search_field[0].disabled=!1,this.is_multiple?void 0:this.selected_item.bind("focus.chosen",this.activate_action))},Chosen.prototype.container_mousedown=function(b){return this.is_disabled||(b&&"mousedown"===b.type&&!this.results_showing&&b.preventDefault(),null!=b&&a(b.target).hasClass("search-choice-close"))?void 0:(this.active_field?this.is_multiple||!b||a(b.target)[0]!==this.selected_item[0]&&!a(b.target).parents("a.chosen-single").length||(b.preventDefault(),this.results_toggle()):(this.is_multiple&&this.search_field.val(""),a(this.container[0].ownerDocument).bind("click.chosen",this.click_test_action),this.results_show()),this.activate_field())},Chosen.prototype.container_mouseup=function(a){return"ABBR"!==a.target.nodeName||this.is_disabled?void 0:this.results_reset(a)},Chosen.prototype.search_results_mousewheel=function(a){var b;return a.originalEvent&&(b=-a.originalEvent.wheelDelta||a.originalEvent.detail),null!=b?(a.preventDefault(),"DOMMouseScroll"===a.type&&(b=40*b),this.search_results.scrollTop(b+this.search_results.scrollTop())):void 0},Chosen.prototype.blur_test=function(){return!this.active_field&&this.container.hasClass("chosen-container-active")?this.close_field():void 0},Chosen.prototype.close_field=function(){return a(this.container[0].ownerDocument).unbind("click.chosen",this.click_test_action),this.active_field=!1,this.results_hide(),this.container.removeClass("chosen-container-active"),this.clear_backstroke(),this.show_search_field_default(),this.search_field_scale()},Chosen.prototype.activate_field=function(){return this.container.addClass("chosen-container-active"),this.active_field=!0,this.search_field.val(this.search_field.val()),this.search_field.focus()},Chosen.prototype.test_active_click=function(b){var c;return c=a(b.target).closest(".chosen-container"),c.length&&this.container[0]===c[0]?this.active_field=!0:this.close_field()},Chosen.prototype.results_build=function(){return this.parsing=!0,this.selected_option_count=null,this.results_data=SelectParser.select_to_array(this.form_field),this.is_multiple?this.search_choices.find("li.search-choice").remove():this.is_multiple||(this.single_set_selected_text(),this.disable_search||this.form_field.options.length<=this.disable_search_threshold?(this.search_field[0].readOnly=!0,this.container.addClass("chosen-container-single-nosearch")):(this.search_field[0].readOnly=!1,this.container.removeClass("chosen-container-single-nosearch"))),this.update_results_content(this.results_option_build({first:!0})),this.search_field_disabled(),this.show_search_field_default(),this.search_field_scale(),this.parsing=!1},Chosen.prototype.result_do_highlight=function(a){var b,c,d,e,f;if(a.length){if(this.result_clear_highlight(),this.result_highlight=a,this.result_highlight.addClass("highlighted"),d=parseInt(this.search_results.css("maxHeight"),10),f=this.search_results.scrollTop(),e=d+f,c=this.result_highlight.position().top+this.search_results.scrollTop(),b=c+this.result_highlight.outerHeight(),b>=e)return this.search_results.scrollTop(b-d>0?b-d:0);if(f>c)return this.search_results.scrollTop(c)}},Chosen.prototype.result_clear_highlight=function(){return this.result_highlight&&this.result_highlight.removeClass("highlighted"),this.result_highlight=null},Chosen.prototype.results_show=function(){return this.is_multiple&&this.max_selected_options<=this.choices_count()?(this.form_field_jq.trigger("chosen:maxselected",{chosen:this}),!1):(this.container.addClass("chosen-with-drop"),this.results_showing=!0,this.search_field.focus(),this.search_field.val(this.search_field.val()),this.winnow_results(),this.form_field_jq.trigger("chosen:showing_dropdown",{chosen:this}))},Chosen.prototype.update_results_content=function(a){return this.search_results.html(a)},Chosen.prototype.results_hide=function(){return this.results_showing&&(this.result_clear_highlight(),this.container.removeClass("chosen-with-drop"),this.form_field_jq.trigger("chosen:hiding_dropdown",{chosen:this})),this.results_showing=!1},Chosen.prototype.set_tab_index=function(){var a;return this.form_field.tabIndex?(a=this.form_field.tabIndex,this.form_field.tabIndex=-1,this.search_field[0].tabIndex=a):void 0},Chosen.prototype.set_label_behavior=function(){var b=this;return this.form_field_label=this.form_field_jq.parents("label"),!this.form_field_label.length&&this.form_field.id.length&&(this.form_field_label=a("label[for='"+this.form_field.id+"']")),this.form_field_label.length>0?this.form_field_label.bind("click.chosen",function(a){return b.is_multiple?b.container_mousedown(a):b.activate_field()}):void 0},Chosen.prototype.show_search_field_default=function(){return this.is_multiple&&this.choices_count()<1&&!this.active_field?(this.search_field.val(this.default_text),this.search_field.addClass("default")):(this.search_field.val(""),this.search_field.removeClass("default"))},Chosen.prototype.search_results_mouseup=function(b){var c;return c=a(b.target).hasClass("active-result")?a(b.target):a(b.target).parents(".active-result").first(),c.length?(this.result_highlight=c,this.result_select(b),this.search_field.focus()):void 0},Chosen.prototype.search_results_mouseover=function(b){var c;return c=a(b.target).hasClass("active-result")?a(b.target):a(b.target).parents(".active-result").first(),c?this.result_do_highlight(c):void 0},Chosen.prototype.search_results_mouseout=function(b){return a(b.target).hasClass("active-result")?this.result_clear_highlight():void 0},Chosen.prototype.choice_build=function(b){var c,d,e=this;return c=a("<li />",{"class":"search-choice"}).html("<span>"+b.html+"</span>"),b.disabled?c.addClass("search-choice-disabled"):(d=a("<a />",{"class":"search-choice-close","data-option-array-index":b.array_index}),d.bind("click.chosen",function(a){return e.choice_destroy_link_click(a)}),c.append(d)),this.search_container.before(c)},Chosen.prototype.choice_destroy_link_click=function(b){return b.preventDefault(),b.stopPropagation(),this.is_disabled?void 0:this.choice_destroy(a(b.target))},Chosen.prototype.choice_destroy=function(a){return this.result_deselect(a[0].getAttribute("data-option-array-index"))?(this.show_search_field_default(),this.is_multiple&&this.choices_count()>0&&this.search_field.val().length<1&&this.results_hide(),a.parents("li").first().remove(),this.search_field_scale()):void 0},Chosen.prototype.results_reset=function(){return this.reset_single_select_options(),this.form_field.options[0].selected=!0,this.single_set_selected_text(),this.show_search_field_default(),this.results_reset_cleanup(),this.form_field_jq.trigger("change"),this.active_field?this.results_hide():void 0},Chosen.prototype.results_reset_cleanup=function(){return this.current_selectedIndex=this.form_field.selectedIndex,this.selected_item.find("abbr").remove()},Chosen.prototype.result_select=function(a){var b,c;return this.result_highlight?(b=this.result_highlight,this.result_clear_highlight(),this.is_multiple&&this.max_selected_options<=this.choices_count()?(this.form_field_jq.trigger("chosen:maxselected",{chosen:this}),!1):(this.is_multiple?b.removeClass("active-result"):this.reset_single_select_options(),c=this.results_data[b[0].getAttribute("data-option-array-index")],c.selected=!0,this.form_field.options[c.options_index].selected=!0,this.selected_option_count=null,this.is_multiple?this.choice_build(c):this.single_set_selected_text(c.text),(a.metaKey||a.ctrlKey)&&this.is_multiple||this.results_hide(),this.search_field.val(""),(this.is_multiple||this.form_field.selectedIndex!==this.current_selectedIndex)&&this.form_field_jq.trigger("change",{selected:this.form_field.options[c.options_index].value}),this.current_selectedIndex=this.form_field.selectedIndex,this.search_field_scale())):void 0},Chosen.prototype.single_set_selected_text=function(a){return null==a&&(a=this.default_text),a===this.default_text?this.selected_item.addClass("chosen-default"):(this.single_deselect_control_build(),this.selected_item.removeClass("chosen-default")),this.selected_item.find("span").text(a)},Chosen.prototype.result_deselect=function(a){var b;return b=this.results_data[a],this.form_field.options[b.options_index].disabled?!1:(b.selected=!1,this.form_field.options[b.options_index].selected=!1,this.selected_option_count=null,this.result_clear_highlight(),this.results_showing&&this.winnow_results(),this.form_field_jq.trigger("change",{deselected:this.form_field.options[b.options_index].value}),this.search_field_scale(),!0)},Chosen.prototype.single_deselect_control_build=function(){return this.allow_single_deselect?(this.selected_item.find("abbr").length||this.selected_item.find("span").first().after('<abbr class="search-choice-close"></abbr>'),this.selected_item.addClass("chosen-single-with-deselect")):void 0},Chosen.prototype.get_search_text=function(){return this.search_field.val()===this.default_text?"":a("<div/>").text(a.trim(this.search_field.val())).html()},Chosen.prototype.winnow_results_set_highlight=function(){var a,b;return b=this.is_multiple?[]:this.search_results.find(".result-selected.active-result"),a=b.length?b.first():this.search_results.find(".active-result").first(),null!=a?this.result_do_highlight(a):void 0},Chosen.prototype.no_results=function(b){var c;return c=a('<li class="no-results">'+this.results_none_found+' "<span></span>"</li>'),c.find("span").first().html(b),this.search_results.append(c),this.form_field_jq.trigger("chosen:no_results",{chosen:this})},Chosen.prototype.no_results_clear=function(){return this.search_results.find(".no-results").remove()},Chosen.prototype.keydown_arrow=function(){var a;return this.results_showing&&this.result_highlight?(a=this.result_highlight.nextAll("li.active-result").first())?this.result_do_highlight(a):void 0:this.results_show()},Chosen.prototype.keyup_arrow=function(){var a;return this.results_showing||this.is_multiple?this.result_highlight?(a=this.result_highlight.prevAll("li.active-result"),a.length?this.result_do_highlight(a.first()):(this.choices_count()>0&&this.results_hide(),this.result_clear_highlight())):void 0:this.results_show()},Chosen.prototype.keydown_backstroke=function(){var a;return this.pending_backstroke?(this.choice_destroy(this.pending_backstroke.find("a").first()),this.clear_backstroke()):(a=this.search_container.siblings("li.search-choice").last(),a.length&&!a.hasClass("search-choice-disabled")?(this.pending_backstroke=a,this.single_backstroke_delete?this.keydown_backstroke():this.pending_backstroke.addClass("search-choice-focus")):void 0)},Chosen.prototype.clear_backstroke=function(){return this.pending_backstroke&&this.pending_backstroke.removeClass("search-choice-focus"),this.pending_backstroke=null},Chosen.prototype.keydown_checker=function(a){var b,c;switch(b=null!=(c=a.which)?c:a.keyCode,this.search_field_scale(),8!==b&&this.pending_backstroke&&this.clear_backstroke(),b){case 8:this.backstroke_length=this.search_field.val().length;break;case 9:this.results_showing&&!this.is_multiple&&this.result_select(a),this.mouse_on_container=!1;break;case 13:a.preventDefault();break;case 38:a.preventDefault(),this.keyup_arrow();break;case 40:a.preventDefault(),this.keydown_arrow()}},Chosen.prototype.search_field_scale=function(){var b,c,d,e,f,g,h,i,j;if(this.is_multiple){for(d=0,h=0,f="position:absolute; left: -1000px; top: -1000px; display:none;",g=["font-size","font-style","font-weight","font-family","line-height","text-transform","letter-spacing"],i=0,j=g.length;j>i;i++)e=g[i],f+=e+":"+this.search_field.css(e)+";";return b=a("<div />",{style:f}),b.text(this.search_field.val()),a("body").append(b),h=b.width()+25,b.remove(),c=this.container.outerWidth(),h>c-10&&(h=c-10),this.search_field.css({width:h+"px"})}},Chosen}(AbstractChosen)}.call(this);
define("chosen", function(){});

(function ($) {
define('scripts/upfront/global-event-handlers',[],function() {

	// Close select dropdown on outside click
	$('body').on('mouseup', function() {
		$('.upfront-field-select').removeClass('upfront-field-select-expanded');
	});


  // Allow focus on click for inputs and textareas - draggable hijacks it
	var nonDraggableSelectors = '#page input[type="text"], #page input[type="email"], #page input[type="password"], #page textarea, #page select, #page .upfront-field-select';
	$('body').on('mouseover', nonDraggableSelectors, function(event) {
		try {
			$(event.target).closest('.ui-draggable').draggable('disable');
		} catch (event) {
			// We don't do anything but have to guard here
		}
	});
	$('body').on('mouseout', nonDraggableSelectors, function(event) {
		try {
			$(event.target).closest('.ui-draggable').draggable('enable');
		} catch (event) {
			// We don't do anything but have to guard here
		}
	});

	/**
	 * Hide color picker when clicked outside of it
	 */
	$(document).on("click", function(e){
		if( $(".sp-container").length === $(".sp-container.sp-hidden").length ) return;

		$(".sp-container").not(".sp-hidden").each(function(){
			var $this = $(this),
				options = $this.data("sp-options");
			if( !options || !options.flat  ){
				var $replacer = $this.parent().find(".sp-replacer");
				$replacer.removeClass("sp-active");
				$this.addClass("sp-hidden");
				setTimeout(function(){
					$replacer.removeClass("sp-active");
					$this.addClass("sp-hidden");
				}, 10);
			}
		});
	});

	/**
	 * re-Resize Magnific Popup on window resize (iPhone issue) 
	 */
	if(/i(Pad|Phone|Pod)/g.test(navigator.userAgent))
		$(window).on("resize", function(e){
			setTimeout(function(){
				$.magnificPopup.instance.updateSize();
			}, 500);
		});

	/**
	 * Handle navigation
	 */
	// Should only run after Upfront instance load
	$(document).one('upfront-load', function () {
		Upfront.Events.once('Upfront:loaded', function(){
			$(document)
				.on('click', 'a', function(e){
					var bypass, href, a, pathname, search;
		
					if(e.isDefaultPrevented()) return;
		
					bypass = $(e.currentTarget).data('bypass');
					if(bypass) return;
		
					a = e.target;
					pathname = a.pathname;
					href = a.getAttribute('href');
					search = a.search;
		
					if(href == '#' || a.origin != window.location.origin ||
						(pathname == window.location.pathname && search == window.location.search)) return;
		
					//If we are editing text, don't follow the link
					if($(e.target).closest('.redactor_box').length || $(e.target).parents('.redactor-editor').length) {
						return;
					}
		
					// Prevent crazy double url navigation
					if (Upfront.mainData.site.indexOf('localhost') > -1
						&& Upfront.mainData.site + '/' === a.origin + pathname) pathname = '/';
		
					// Make dev=true remain in arguments
					if (window.location.search.indexOf('dev=true') > -1
							&& search.indexOf('dev=true') === -1) {
								if (search === '') search = '?';
								search += 'dev=true';
							}
		
					e.preventDefault();
		
					if(!Upfront.PreviewUpdate._is_dirty || confirm(Upfront.Settings.l10n.global.application.navigation_confirm))
						Upfront.Application.navigate(pathname + search, {trigger: true});
				})
				.on('keydown', function(e){
					//Don't let the backspace go back in history
					if(e.which == 8){
						var tag = e.target.tagName.toUpperCase();
						if(tag != 'INPUT' && tag != 'TEXTAREA' && !$(e.target).closest('.redactor_box').length && !e.target.contentEditable)
					e.preventDefault();
					}
				});
		});
	});
});
})(jQuery);

(function ($) {
define('scripts/upfront/inline-panels/panels',[], function () {
	var Panels = Backbone.View.extend({
		className: 'upfront-inline-panels upfront-ui',
		initialize: function () {
			this.panels = _([]);
		},
		render: function () {
			var me = this,
				panels = typeof this.panels === 'function' ? this.panels() : this.panels,
				$wrap = $('<div class="upfront-inline-panels-wrap" />');
			this.$el.html('');
			panels.each(function(panel){
				if ( !panel ) {
					return;
				}
				panel.panels_view = me;
				panel.render();
				panel.delegateEvents();
				$wrap.append(panel.el);
			});
			this.$el.append($wrap);
			if ( typeof this.on_render === 'function' ) {
				this.on_render();
			}
		},
		on_active: function () {
			$('.upfront-inline-panels-active').removeClass('upfront-inline-panels-active');
			this.$el.addClass('upfront-inline-panels-active');
		},
		remove: function() {
			var panels = typeof this.panels === 'function' ? this.panels() : this.panels;
			if(panels) {
				panels.each(function(panel){
					panel.remove();
				});
			}
			Backbone.View.prototype.remove.call(this);
		}
	});

	return Panels;
});
})(jQuery);

define('scripts/upfront/inline-panels/panel',[], function () {
	var Panel = Backbone.View.extend({
		className: 'upfront-inline-panel upfront-no-select',
		position_v: 'top',
		position_h: 'center',

		initialize: function () {
			this.items = _([]);
		},

		render: function() {
			var items = typeof this.items === 'function' ? this.items() : this.items,
				classes = [
					'upfront-inline-panel-'+this.position_v,
					'upfront-inline-panel-'+this.position_v+'-'+this.position_h
				],
				width = 0,
				height = 0;

			this.$el.html('');
			this.collapsedParent = false;

			items.each(function(item){
				item.panel_view = this;
				item.render();
				item.delegateEvents();

				this.$el.append(item.el);

				if (item.collapsed) {
					classes.push('upfront-inline-panel-collapsed-parent');
					this.collapsedParent = true;
				}

				if ( this.position_v === 'center' ) {
					width = item.width > width ? item.width : width;
					height += item.height;
				} else {
					width += item.width;
					height = item.height > height ? item.height : height;
				}

				if( typeof item.active  === "function" && item.active() == 1 ){
					item.$el.addClass("active");
				}else if(typeof item.active  === "function" && item.active() == 0){
					item.$el.removeClass("active");
				}
			}, this);

			this.$el.addClass(this.className + ' ' + classes.join(' '));

			if (this.collapsedParent) {
				height = 13;
			}

			this.$el.css({
				width: width,
				height: height
			});


		},

		remove: function() {
			var items = typeof this.items === 'function' ? this.items() : this.items;

			if(items) {
				items.each(function(item){
					item.remove();
				});
			}
			Backbone.View.prototype.remove.call(this);
		}
	});

	return Panel;
});

define('scripts/upfront/inline-panels/item',[], function () {
	var Item = Backbone.View.extend({
		className: 'upfront-inline-panel-item',
		width: 30,
		height: 30,
		icon_class: 'upfront-icon-region',

		initialize: function(options) {
			this.options = options || {};
			this.label = this.options.label;
		},

		render_icon: function () {
			var icon = typeof this.icon === 'function' ? this.icon() : this.icon;
			if ( !icon ) {
				return;
			}
			var me = this,
				icons = icon.split(' '),
				icons_class = ['upfront-icon'],
				$icon = this.$el.find('.upfront-icon');
			_.each(icons, function(each){
				icons_class.push(me.icon_class + '-' + each);
			});
			if ( !$icon.length ) {
				this.$el.append('<i class="' + icons_class.join(' ') + '" />');
			} else {
				$icon.attr('class', icons_class.join(' '));
			}
		},

		render_label: function () {
			var label = typeof this.label === 'function' ? this.label() : this.label;
			if ( !label ) {
				return;
			}
			var $label = this.$el.find('.upfront-inline-panel-item-label');
			this.$el.addClass('labeled');
			if ( !$label.length ) {
				this.$el.append('<span class="upfront-inline-panel-item-label">' + label + '</span>');
			} else {
				$label.html(label);
			}
		},

		render_tooltip: function () {
			var tooltip = typeof this.tooltip === 'function' ? this.tooltip() : this.tooltip;
			if ( ! tooltip ) {
				return;
			}
			this.$el.attr('title', tooltip);
		},

		render: function () {
			this.render_icon();
			this.render_label();
			this.render_tooltip();
			this.$el.css({
				width: this.width,
				height: this.height
			});
			this.$el.attr('id', this.id);
			if ( typeof this.on_render === 'function' ) {
				this.on_render();
			}
		},

		open_modal: function (render_callback, button) {
			if ( ! this.modal ){
				var me = this;
				var $region_container = this.$el.closest('.upfront-region-container');
				this.modal = new Upfront.Views.Editor.Modal({ to: $region_container, top: 60 });
				this.modal.render();
				$region_container.append(this.modal.$el);
			}
			this.listenToOnce(Upfront.Events, 'entity:region:deactivated', function(){
				 me.close_modal(false);
			});
			return this.modal.open(render_callback, this, button);
		},

		close_modal: function (save) {
			return this.modal.close(save);
		},

		remove: function(){
			this.panel_view = false;
		}
	});

	return Item;
});

(function ($) {
define('scripts/upfront/inline-panels/item-multi',[
	'scripts/upfront/inline-panels/item'
], function (Item) {
	var ItemMulti = Item.extend({
		events: {
			'click >.upfront-icon': 'toggle_subitem'
		},
		initialize: function () {
			this.sub_items = {};
			this.listenTo(Upfront.Events, 'entity:region:activated', this.on_region_change);
		},
		get_selected_item: function () {},
		get_default_item: function () {},
		get_selected_icon: function (selected) {
			return selected + '-active';
		},
		set_selected_item: function () {},
		select_item: function (selected) {
			this.set_selected_item(selected);
			this.render();
		},
		render: function () {
			var me = this,
				selected = this.get_selected_item() || this.get_default_item(),
				$sub_items = $('<div class="upfront-inline-panel-subitem" />');
			this.$el.html('');
			this.icon = this.get_selected_icon(selected);
			this.render_icon();
			this.render_tooltip();
			_.each(this.sub_items, function(item, id){
				item.panel_view = me.panel_view;
				item.parent_view = me;
				item.render();
				item.delegateEvents();
				if ( selected != id ) {
					$sub_items.append(item.el);
				}
			});
			$sub_items.append(this.sub_items[selected].el);
			this.$el.append($sub_items);
		},
		toggle_subitem: function () {
			if ( this.$el.hasClass('upfront-inline-panel-subitem-active') ) {
				this.close_subitem();
			} else {
				this.open_subitem();
			}
		},
		open_subitem: function () {
			this.$el.addClass('upfront-inline-panel-subitem-active');
			this.$el.removeClass('upfront-inline-panel-subitem-inactive');
		},
		close_subitem: function () {
			this.$el.addClass('upfront-inline-panel-subitem-inactive');
			this.$el.removeClass('upfront-inline-panel-subitem-active');
		},
		on_region_change: function (region) {
			if ( region.model != this.model ) {
				this.close_subitem();
			}
		},
		remove: function(){
			if (this.sub_items) {
				_.each(this.sub_items, function(item){
					item.remove();
				});
			}
			this.panel_view = false;
			Backbone.View.prototype.remove.call(this);
		}
	});

	return ItemMulti;
});
})(jQuery);

(function ($) {
define('scripts/upfront/inline-panels/control',[
	'scripts/upfront/inline-panels/item'
], function (Item) {
	var Control = Item.extend({
		events: {
			'click': 'clicked'
		},

		initialize: function(options) {
			this.options = options || {};
			this.label = this.options.label;
			this.icon = this.options.icon;
		},

		clicked: function(e){
			var target = $(e.target);

			e.preventDefault();
			e.stopPropagation();
			this.$el
				.siblings('.upfront-inline-panel-subitem-active')
				.removeClass('upfront-inline-panel-subitem-active');

			if(!target.hasClass('upfront-icon-region-settings')){			
				if(!target.closest('.upfront-inline-panel-item').hasClass('upfront-control-dialog-open'))	target.closest('.upfront-wrapper').addClass('upfront-inline-panel-item-open');
				else	target.closest('.upfront-wrapper').removeClass('upfront-inline-panel-item-open');
			}

			this.trigger('click', e);
		},

		setIsSelected: function(isSelected) {
			if (isSelected) {
				this.$el.addClass('inline-panel-item-selected');
				return;
			}

			this.$el.removeClass('inline-panel-item-selected');
		}
	});

	return Control;
});
})(jQuery);

(function ($) {
define('scripts/upfront/inline-panels/multi-control',[
	'scripts/upfront/inline-panels/item-multi'
], function (ItemMulti) {
	var MultiControl = ItemMulti.extend({
	events: {
		'click': 'clicked',
		'click .upfront-inline-panel-item': 'selectItem'
	},
	render: function(){
		ItemMulti.prototype.render.call(this, arguments);
	},
	clicked: function(e){
		var $subitem = this.$el.children('.upfront-inline-panel-subitem');
		if ( $(e.target).closest($subitem).length > 0 )
			return;
		this.trigger('click', e);
		this.toggle_subitem();
	},
	get_selected_item: function () {
		return this.selected;
	},
	selectItem: function(e){
		var found = false,
			target = $(e.target).is('i') ? $(e.target) : $(e.target).find('i')
		;
		_.each(this.sub_items, function(item, key){
			if(target.hasClass('upfront-icon-region-' + item.icon)) {
				found = key;
			}
		});

		if(found){
			this.selected = found;
			this.render();
			this.trigger('select', found);
		}
	}

	});

	return MultiControl;
});
})(jQuery);

(function ($) {
define('scripts/upfront/inline-panels/tooltip-control',[
	'scripts/upfront/inline-panels/item',
	'scripts/upfront/inline-panels/control'
], function (Item, Control) {
	var l10n = Upfront.mainData.l10n.image_element;

	var TooltipControl = Control.extend({
		multiControl: true,

		events: {
			'click': 'onClickControl',
			'click .upfront-inline-panel-item': 'selectItem'
		},

		initialize: function() {
			var me = this;
			$(document).click(function(e){
				var	target = $(e.target);

				if(target.closest('#page').length && target[0] !== me.el && !target.closest(me.el).length && me.isOpen) {
					me.close();
				}
			});
		},

		onClickControl: function(e){
			if (this.isDisabled) {
				return;
			}

			e.preventDefault();

			this.clicked(e);

			this.$el.siblings('.upfront-control-dialog-open').removeClass('upfront-control-dialog-open');

			if (this.isOpen) {
				this.close();
			} else {
				this.open();
			}
		},

		open: function() {
			this.isOpen = true;
			this.$el.addClass('upfront-control-dialog-open');
		},

		close: function() {
			this.isOpen = false;
			this.$el.removeClass('upfront-control-dialog-open');
		},

		render: function() {
			Item.prototype.render.call(this, arguments);
			var captionControl = this.$('.uimage-caption-control'),
				me = this,
				selectedItem
			;

			if(!this.$el.hasClass('uimage-caption-control-item')) {
				this.$el.addClass('uimage-caption-control-item');
			}

			if(!captionControl.length){
				captionControl = $('<div class="uimage-caption-control inline-panel-control-dialog"></div>');
				this.$el.append(captionControl);
			}
			_.each(this.sub_items, function(item, key){
				if(key === me.selected){
					item.setIsSelected(true);
				} else {
					item.setIsSelected(false);
				}
				item.render();
				item.$el.find('i').addClass('upfront-icon-region-caption');
				captionControl.append(item.$el);
				me.listenTo(item, 'click', me.selectItem);
			});

			selectedItem = this.sub_items[this.selected];
					if(selectedItem){
							if( typeof selectedItem.icon !== 'undefined' ){
									this.$el.children('i').addClass('upfront-icon-region-' + selectedItem.icon);
							}else if( typeof selectedItem.label !== 'undefined' ){
									this.$el.find('.tooltip-content').append( ': ' +  selectedItem.label );
							}
					}
		},

		get_selected_item: function () {
			return this.selected;
		},

		selectItem: function(e){
			var found = false,
				target = $(e.target).is('i') ? $(e.target) : $(e.target).find('i');

			_.each(this.sub_items, function(item, key){
				if(target.hasClass('upfront-icon-region-' + item.icon)) {
					found = key;
				}

				if( !found && $(e.target).closest('.upfront-inline-panel-item').attr('id') === item.id ){
					found = key;
				}

			});

			if(found){
				this.selected = found;
				this.render();
				this.trigger('select', found);
			}
		},

		setDisabled: function(isDisabled) {
			this.isDisabled = isDisabled;
			if (isDisabled) {
				this.tooltip = l10n.ctrl.caption_position_disabled;
			} else {
				this.tooltip = l10n.ctrl.caption_display;
			}
		}
	});

	return TooltipControl;
});
})(jQuery);

(function ($) {
define('scripts/upfront/inline-panels/padding-control',[
	'scripts/upfront/inline-panels/item',
	'scripts/upfront/inline-panels/control'
], function (Item, Control) {
	var l10n = Upfront.mainData.l10n.global.views;

	var PaddingControl = Control.extend({
		multiControl: true,

		events: {
			'click': 'onClickControl'
		},

		initialize: function() {
			var me = this;
			$(document).click(function(e){
				var	target = $(e.target);

				if (target.closest('#page').length && target[0] !== me.el && !target.closest(me.el).length && me.isOpen) {
					me.close();
				}
			});
			$(document).mouseup(function(e){
				var	target = $(e.target),
					currentEntity = Upfront.data.currentEntity;

				if (target.closest('#page').length && target[0] !== me.el && !target.closest(me.el).length && typeof(currentEntity) !== 'undefined' && typeof(currentEntity.padding_hint_locked) !== 'undefined' && currentEntity.padding_hint_locked) {
					currentEntity.padding_hint_locked = false;
					currentEntity.top_padding_hint_timer = setTimeout(function() {
						if(typeof(currentEntity.hide_top_padding_hint) === 'function'){
							currentEntity.hide_top_padding_hint();
						}
					}, 1000);
					currentEntity.bottom_padding_hint_timer = setTimeout(function() {
						if(typeof(currentEntity.hide_bottom_padding_hint) === 'function'){
							currentEntity.hide_bottom_padding_hint();
						}
					}, 1000);
				}
			});

			this.default_padding = {
				top: false,
				bottom: false
			}

			this.listenTo(Upfront.Events, "upfront:paddings:updated", this.refresh);
		},

		onClickControl: function(e){
			var	target = $(e.target);

			if (this.isDisabled) 	return;

			e.preventDefault();

			if (!target.closest('.upfront-icon-region-padding').length) {
				e.stopPropagation();
				return;
			}

			this.clicked(e);

			this.$el.siblings('.upfront-control-dialog-open').removeClass('upfront-control-dialog-open');

			if (this.isOpen) {
				this.close();
			} else {
				this.open();
			}
		},

		open: function() {
			this.isOpen = true;
			this.refresh();
			this.$el.addClass('upfront-control-dialog-open');
		},

		close: function() {
			this.isOpen = false;
			this.$el.removeClass('upfront-control-dialog-open');
			this.$el.closest('.upfront-inline-panel-item-open').removeClass('upfront-inline-panel-item-open');
		},

		on_render: function() {
			var me = this,
				$paddingControl = me.$('.upfront-padding-control'),
				$paddingTopContainer = $('<div class="upfront-padding-container">' + l10n.top_padding_short + '<span class="upfront-padding-value"></span></div>'),
				$paddingBottomContainer = $('<div class="upfront-padding-container">' + l10n.bottom_padding_short + '<span class="upfront-padding-value"></span></div>'),
				column_padding = Upfront.Settings.LayoutEditor.Grid.column_padding
			;

			if(!me.$el.hasClass('upfront-padding-control-item')) {
				me.$el.addClass('upfront-padding-control-item');
			}

			if($paddingControl.length === 0){
				$paddingControl = $('<div class="upfront-padding-control inline-panel-control-dialog"></div>');
				me.$el.append($paddingControl);
			}

			if(me.default_padding.top === false) {
				me.default_padding.top = column_padding;
			}
			if(me.default_padding.bottom === false){
				me.default_padding.bottom = column_padding;
			}

			me.paddingTop = new Upfront.Views.Editor.Field.Slider({
				model: this.model,
				use_breakpoint_property: true,
				property: 'top_padding_num',
				label: '',
				default_value: this.model.get_breakpoint_property_value('top_padding_num') || me.default_padding.top,
				min: 0,
				max: 200,
				step: 5,
				valueTextFilter: function (valueText) {
					me.paddingTop.$el.parent('.upfront-padding-container').find('.upfront-padding-value').html(valueText);
					return '';
				},
				change: function () {
					var value = this.get_value();

					this.model.set_breakpoint_property('use_padding', 'yes', true);
					this.model.set_breakpoint_property('lock_padding', '', true);
					this.model.set_breakpoint_property('top_padding_use', 'yes', true);
					this.model.set_breakpoint_property('top_padding_slider', value, true); // silent, don't need to trigger update again
					this.model.set_breakpoint_property('top_padding_num', value);
					Upfront.Events.trigger("upfront:paddings:updated", this.model, Upfront.data.currentEntity);
					Upfront.Events.trigger("upfront:paddings:top:updated", this.model, Upfront.data.currentEntity);
				}
			});

			me.paddingBottom = new Upfront.Views.Editor.Field.Slider({
				model: this.model,
				use_breakpoint_property: true,
				property: 'bottom_padding_num',
				label: '',
				default_value: this.model.get_breakpoint_property_value('bottom_padding_num') || me.default_padding.bottom,
				min: 0,
				max: 200,
				step: 5,
				valueTextFilter: function (valueText) {
					me.paddingBottom.$el.parent('.upfront-padding-container').find('.upfront-padding-value').html(valueText);
					return '';
				},
				change: function () {
					var value = this.get_value();

					this.model.set_breakpoint_property('use_padding', 'yes', true);
					this.model.set_breakpoint_property('lock_padding', '', true);
					this.model.set_breakpoint_property('bottom_padding_use', 'yes', true);
					this.model.set_breakpoint_property('bottom_padding_slider', value, true); // silent, don't need to trigger update again
					this.model.set_breakpoint_property('bottom_padding_num', value);
					Upfront.Events.trigger("upfront:paddings:updated", this.model, Upfront.data.currentEntity);
					Upfront.Events.trigger("upfront:paddings:bottom:updated", this.model, Upfront.data.currentEntity);
				}
			});

			$paddingControl.html('');
			me.paddingTop.render();
			$paddingTopContainer.append(me.paddingTop.$el);
			$paddingControl.append($paddingTopContainer);
			me.paddingBottom.render();
			$paddingBottomContainer.append(me.paddingBottom.$el);
			$paddingControl.append($paddingBottomContainer);

			$paddingTopContainer.on('mousedown', function() {
				Upfront.data.currentEntity.padding_hint_locked = true;
			}).on('mouseup', function() {
				var currentEntity = Upfront.data.currentEntity;

				currentEntity.padding_hint_locked = false;
				currentEntity.top_padding_hint_timer = setTimeout(function() {
					if(typeof(currentEntity.hide_top_padding_hint) === 'function'){
						currentEntity.hide_top_padding_hint();
					}
				}, 1000);
			});

			$paddingBottomContainer.on('mousedown', function() {
				Upfront.data.currentEntity.padding_hint_locked = true;
			}).on('mouseup', function() {
				var currentEntity = Upfront.data.currentEntity;

				currentEntity.padding_hint_locked = false;
				currentEntity.bottom_padding_hint_timer = setTimeout(function() {
					if(typeof(currentEntity.hide_bottom_padding_hint) === 'function'){
						currentEntity.hide_bottom_padding_hint();
					}
				}, 1000);
			});
		},

		refresh: function(model) {
			if ( model && model !== this.model ) return;
			var column_padding = Upfront.Settings.LayoutEditor.Grid.column_padding,
				top_padding_use = this.model.get_breakpoint_property_value('top_padding_use', true),
				bottom_padding_use = this.model.get_breakpoint_property_value('bottom_padding_use', true),
				padding_top_val, padding_bottom_val
			;

			if(this.default_padding.top === false) {
				this.default_padding.top = column_padding;
			}
			if(this.default_padding.bottom === false){
				this.default_padding.bottom = column_padding;
			}
			padding_top_val = top_padding_use ? this.model.get_breakpoint_property_value('top_padding_num', true) : this.default_padding.top;
			padding_bottom_val = bottom_padding_use ? this.model.get_breakpoint_property_value('bottom_padding_num', true) : this.default_padding.bottom;


			if(typeof this.paddingTop !== 'undefined') {
				this.paddingTop.get_field().val(padding_top_val);
				if(typeof this.paddingTop.$el.find('#'+this.paddingTop.get_field_id()).slider('instance') !== 'undefined') 	this.paddingTop.$el.find('#'+this.paddingTop.get_field_id()).slider('value', padding_top_val);
				this.paddingTop.$el.parent('.upfront-padding-container').find('.upfront-padding-value').html(padding_top_val);
			}
			if(typeof this.paddingBottom !== 'undefined') {
				this.paddingBottom.get_field().val(padding_bottom_val);
				if(typeof this.paddingBottom.$el.find('#'+this.paddingBottom.get_field_id()).slider('instance') !== 'undefined') 	this.paddingBottom.$el.find('#'+this.paddingBottom.get_field_id()).slider('value', padding_bottom_val);
				this.paddingBottom.$el.parent('.upfront-padding-container').find('.upfront-padding-value').html(padding_bottom_val);
			}
		},
		on_up_arrow_click: function() {
			if(typeof this.paddingTop !== 'undefined') {
				var padding_top_val = parseInt(this.model.get_breakpoint_property_value('top_padding_num', true)) - 5;

				padding_top_val = padding_top_val < 0 ? 0 : padding_top_val;

				this.model.set_breakpoint_property('top_padding_use', 'yes');
				this.model.set_breakpoint_property('top_padding_num', padding_top_val);
				this.model.set_breakpoint_property('top_padding_slider', padding_top_val);

				this.refresh();
			}
		},
		on_down_arrow_click: function() {
			if(typeof this.paddingTop !== 'undefined') {
				var padding_top_val = parseInt(this.model.get_breakpoint_property_value('top_padding_num', true)) + 5;

				this.model.set_breakpoint_property('top_padding_use', 'yes');
				this.model.set_breakpoint_property('top_padding_num', padding_top_val);
				this.model.set_breakpoint_property('top_padding_slider', padding_top_val);

				this.refresh();
			}
		}
	});

	return PaddingControl;
});
})(jQuery);

(function ($) {
define('scripts/upfront/inline-panels/collapsed-multi-control',[
	'scripts/upfront/inline-panels/control',
	'scripts/upfront/inline-panels/multi-control'
], function (Control, MultiControl) {
	var CollapsedMultiControl = MultiControl.extend({
		collapsed: true,
		className: 'upfront-inline-panel-item inline-panel-collapsed-control',
		render: function(){
			if(!this.sub_items.collapsedControl){
				var control = new Control();
				control.icon = 'collapsedControl';
				control.tooltip = 'More tools';
				this.sub_items.collapsedControl = control;
			}
			this.selected = 'collapsedControl';

			this.constructor.__super__.render.call(this, arguments);
		},

		selectItem: function(e){
			var found = false,
				foundKey = false,
				target = $(e.target).is('i') ? $(e.target) : $(e.target).find('i')
			;

			_.each(this.sub_items, function(item, key){
				if(target.hasClass('upfront-icon-region-' + item.icon)){
					found = item;
					foundKey = key;
				}
			});

			if(found){
				if(found instanceof MultiControl || found.multiControl === true){
					return false;
				}
				else {
					this.render();
					this.trigger('select', foundKey);
				}
			}
		},

		open_subitem: function () {
			_.each(this.sub_items, function(item){
				if(item instanceof MultiControl){
					item.close_subitem();
				}
			});
			this.constructor.__super__.open_subitem.call(this, arguments);
		}
	});

	return CollapsedMultiControl;
});
})(jQuery);

define('scripts/upfront/inline-panels/control-panel',[
	'scripts/upfront/inline-panels/panel',
	'scripts/upfront/inline-panels/collapsed-multi-control',
	'scripts/upfront/inline-panels/tooltip-control'
], function (Panel, CollapsedMultiControl, TooltipControl) {
	var l10n = Upfront.mainData.l10n.image_element;

	var ControlPanel = Panel.extend({
		position_v: 'none', // Image view will handle this
		position_h: 'none',

		setWidth: function(optionsArg) {
			var items = this.items._wrapped,
				collapsedControl,
				options = _.extend({
					widthThreshold: 100,
					width: 101,
					heightThreshold: 100,
					height: 101
				}, optionsArg);


			if(options.width < options.widthThreshold || options.height < options.heightThreshold){
				if (this.collapsed !== true) {
					collapsedControl = new CollapsedMultiControl();

				_.each(items, function(item) {
					if (item instanceof TooltipControl) {
						item.setDisabled(true);
					}
					collapsedControl.sub_items[item.icon] = item;
				});

				collapsedControl.icon = 'collapsedControl';
				collapsedControl.tooltip = l10n.ctrl.more_tools;
				collapsedControl.position = 'left';

					this.items = _([collapsedControl]);
					this.collapsed = true;
				}
			} else {
				// Uncolapse
				if (this.collapsed) {
					this.items = _([]);
					_.each(items[0].sub_items, function(item, index) {
						if (index !== 'collapsedControl') {
							this.items.push(item);
						}
						if (item instanceof TooltipControl) {
							item.setDisabled(false);
						}
					}, this);
				}
				this.collapsed = false;
			}
		},

		delegateEvents: function(){
			Backbone.View.prototype.delegateEvents.call(this, arguments);
			this.items.each(function(item){
				item.delegateEvents();
			});
		}
	});

	return ControlPanel;
});


define('text!scripts/upfront/inline-panels/templates/panel-control-template.html',[],function () { return '<div class="uimage-control-panel upfront-ui">\r\n\t<div class="uimage-control-panel-content"></div>\r\n\t{[ if (!hideOkButton) { ]}\r\n\t<button type="button" class="upfront-save_settings"><i class="icon-ok"></i> {{ l10n.ok }}</button>\r\n\t{[ } ]}\r\n</div>\r\n';});

(function ($) {
define('scripts/upfront/inline-panels/dialog-control',[
	'scripts/upfront/inline-panels/control',
	'text!scripts/upfront/inline-panels/templates/panel-control-template.html'
], function (Control, panelControlTemplate) {
	var l10n = Upfront.mainData.l10n.image_element;

	var DialogControl = Control.extend({
		multiControl: true,
		hideOnClick: true,

		events: {
			'click': 'onClickControl',
			'click button': 'onClickOk'
		},

		initialize: function(options) {
			var me = this;
			this.options = options || {};

			// Allow only one control to be open at a time
			this.listenTo(Upfront.Events, 'dialog-control:open', function(dialogControl) {
				if (me === dialogControl) {
					return;
				}

				me.close();
			});
		},

		render: function(){
			Control.prototype.render.call(this, arguments);
			var me = this,
				panel;

			if(!this.$el.hasClass('uimage-control-panel-item')) {
				this.$el.addClass('uimage-control-panel-item');
			}

			if(this.view){
				this.view.render();
				this.view.delegateEvents();
			}

			if(!this.panel){
				//this is like initialize
				panel = $(_.template(panelControlTemplate, {l10n: l10n.template, hideOkButton: this.hideOkButton}));
				panel.addClass('inline-panel-control-dialog');
				panel.addClass('inline-panel-control-dialog-' + this.id);
				this.$el.append(panel);
				panel.find('.uimage-control-panel-content').html('').append(this.view.$el);
				this.panel = panel;
				$(document).on('click.dialog-control.'+me.cid, me, me.onDocumentClick);
			}

			return this;
		},

		remove: function() {
			$(document).off('click.dialog-control.'+this.cid);
		},

		onDocumentClick: function(e) {
			var	target = $(e.target),
				me = e.data;

			if(target.closest('#page').length && target[0] !== me.el && !target.closest(me.el).length && me.isopen) {
				me.close();
			}
		},

		onClickControl: function(e){
			
			this.$el.siblings('.upfront-control-dialog-open').removeClass('upfront-control-dialog-open');

			if(!$(e.target).closest('.upfront-icon').length || $(e.target).closest('upfront-icon-media-label-delete').length) {
				e.stopPropagation();
				return;
			}

			e.preventDefault();

			this.clicked(e);

			this.$el.siblings('.upfront-control-dialog-open').removeClass('upfront-control-dialog-open');

			if(this.isopen) {
				this.close();
			} else {
				this.open();
			}
		},

		onClickOk: function(e){
			e.preventDefault();
			this.trigger('panel:ok', this.view);
		},

		bindEvents: function(){
			this.panel.find('button').on('click', function(){
			});
		},

		open: function() {
			this.isopen = true;
			this.$el.addClass('upfront-control-dialog-open');
			this.trigger('panel:open');
			Upfront.Events.trigger('dialog-control:open', this);
			return this;
		},
		close: function() {
			this.isopen = false;
			this.$el.removeClass('upfront-control-dialog-open');
			this.trigger('panel:close');
			return this;
		}
	});

	return DialogControl;
});
})(jQuery);

define('scripts/upfront/inline-panels/controls/visit-link',[
	'scripts/upfront/inline-panels/control'
], function (Control) {
	var l10n = Upfront.Settings && Upfront.Settings.l10n
		? Upfront.Settings.l10n.global.content
		: Upfront.mainData.l10n.global.content
	;

	var VisitLinkControl = Control.extend({
		className: 'upfront-inline-panel-item visit-link-control',
		initialize: function(options) {
			this.options = options || {};
			this.constructor.__super__.initialize.call(this, options);
			this.linkLabel = _.extend({
				unlink: l10n.not_linked,
				lightbox: l10n.open_lightbox,
				anchor: l10n.scroll_to_anchor,
				entry: l10n.go_to_post,
				external: l10n.open_ext_link,
				email: l10n.send_email
			}, (options.linkLabel || {}));
			this.setOptions(this.options.url, this.options.type);
			this.hideIfUnlink = ( options.hideIfUnlink === true );
			this.setOptions(this.options.url);
		},

		setOptions: function(url, type) {
			var theType = type ? type : Upfront.Util.guessLinkType(url);
			this.url = url;
			this.icon = 'visit-link-' + theType,
			this.label = this.getTextByLinkType(theType);
		},

		clicked: function(event) {
			this.constructor.__super__.clicked.call(this, event);
			if(this.url !== "") {
				Upfront.Util.visitLink(this.url);
			}
		},

		setLink: function(url, type) {
			this.setOptions(url, type);
			this.render();
		},

		on_render: function () {
			if (this.hideIfUnlink && Upfront.Util.guessLinkType(this.url) == 'unlink') {
				this.$el.hide();
			}
			else if (!this.$el.is(':visible')) {
				this.$el.show();
			}
		},

		getTextByLinkType: function(linktype) {
			return this.linkLabel[linktype];
		},

	});

	return VisitLinkControl;
});

define('scripts/upfront/inline-panels/controls/link-panel',[
	'scripts/upfront/inline-panels/dialog-control'
], function (DialogControl) {
	var LinkPanelControl = DialogControl.extend({
		initialize: function(options) {
			this.options = options || {};
			this.constructor.__super__.initialize.call(this, options);

			this.icon = this.options.icon;
			this.tooltip = this.options.tooltip;
			this.id = this.options.id;

			this.view = new Upfront.Views.Editor.LinkPanel({
				model: this.model,
				button: false
			});
		},

		onClickOk: function(event){
			event.preventDefault();
			if (this.view.model.get('type') === 'lightbox' && this.view.$el.find('.js-ulinkpanel-lightbox-input').val() !== '')
				this.view.createLightBox();
			this.close();
		}
	});

	return LinkPanelControl;
});

define('scripts/upfront/link-model',[], function() {
	var LinkModel = Backbone.Model.extend({
		defaults: {
			type: 'unlink',
			url: '',
			target: '_self'
		},

		initialize: function() {
			this.on('change:type', this.updateTarget, this);
		},

		updateTarget: function() {
			// Ensure that we do _self for anchors and lightboxes
			if (_.contains(['lightbox', 'anchor'], this.get('type'))) {
				console.log('we have an anchor or a lightbox');
				this.set({'target': '_self'}, {silent: true});
			}
		}
	});

	return LinkModel;
});

(function ($) {
define('scripts/upfront/inline-panels/controls/group-link-panel',[
	'scripts/upfront/inline-panels/controls/link-panel',
	"scripts/upfront/link-model"
], function (LinkPanelControl, LinkModel) {

	var l10n = Upfront.Settings && Upfront.Settings.l10n ?
		Upfront.Settings.l10n.global.views
		: Upfront.mainData.l10n.global.views
	;

	var GroupLinkPanelControl = LinkPanelControl.extend({
		className: 'upfront-inline-panel-item group-link-control',
		initialize: function(options) {
			var me = this;
			this.options = options || {};
			this.constructor.__super__.constructor.__super__.initialize.call(this, options);

			this.icon = this.options.icon;
			this.tooltip = this.options.tooltip;
			this.id = this.options.id;

			this.link = new LinkModel({
				type: this.options.linkType,
				url: this.options.linkUrl,
				target: this.options.linkTarget,
				object: this.options.linkObject,
				object_id: this.options.linkObjectId,
			});
			this.view = new Upfront.Views.Editor.LinkPanel({
				model: this.link,
				button: false,
				title: l10n.link_group_to
			});
			this.listenTo(this.link, 'change change:target change:type', function(link) {
				me.render_label();
				this.trigger('change', {
					url: link.get('url'),
					target: link.get('target'),
					type: link.get('type')
				});
			});
		},

		label: function () {
			return ( this.link.get('type') != 'unlink' ? l10n.edit_link : l10n.not_linked );
		},

		onClickControl: function(e){
			this.$el.siblings('.upfront-control-dialog-open').removeClass('upfront-control-dialog-open');

			if($(e.target).closest('.inline-panel-control-dialog').length) {
				return;
			}

			e.preventDefault();

			if(this.isopen) {
				this.close();
			} else {
				this.open();
			}
		},
	});

	return GroupLinkPanelControl;
});
})(jQuery);

define('scripts/upfront/inline-panels/inline-panels',[
	'scripts/upfront/inline-panels/panels',
	'scripts/upfront/inline-panels/panel',
	'scripts/upfront/inline-panels/item',
	'scripts/upfront/inline-panels/item-multi',
	'scripts/upfront/inline-panels/control',
	'scripts/upfront/inline-panels/multi-control',
	'scripts/upfront/inline-panels/tooltip-control',
	'scripts/upfront/inline-panels/padding-control',
	'scripts/upfront/inline-panels/control-panel',
	'scripts/upfront/inline-panels/dialog-control',
	'scripts/upfront/inline-panels/collapsed-multi-control',
	'scripts/upfront/inline-panels/controls/visit-link',
	'scripts/upfront/inline-panels/controls/link-panel',
	'scripts/upfront/inline-panels/controls/group-link-panel'
], function (Panels, Panel, Item, ItemMulti, Control, MultiControl, TooltipControl, PaddingControl,
	ControlPanel, DialogControl, CollapsedMultiControl, VisitLinkControl, LinkPanelControl, GroupLinkPanelControl) {

	return {
		Panels: Panels,
		Panel: Panel,
		Item: Item,
		ItemMulti: ItemMulti,
		Control: Control,
		MultiControl: MultiControl,
		TooltipControl: TooltipControl,
		PaddingControl: PaddingControl,
		ControlPanel: ControlPanel,
		DialogControl: DialogControl,
		CollapsedMultiControl: CollapsedMultiControl,
		Controls: {
			VisitLink: VisitLinkControl,
			LinkPanel: LinkPanelControl,
			GroupLinkPanel: GroupLinkPanelControl
		}
	};
});

(function ($) {
define('scripts/upfront/element-settings/sidebar',[], function () {
	// Setup basics
	$('body').append('<div id="element-settings-sidebar" />');
	$('#element-settings-sidebar').width(0);
	var the_settings_view;
	var model;
	var oldData;

	var destroySettings = function() {
		//If settings are opened, destroy
		if (the_settings_view) {
			the_settings_view.cleanUp();
			the_settings_view = false;
			$('#element-settings-sidebar').width(0).html('');
			Upfront.Events.off('element:settings:saved', destroySettings);
			Upfront.Events.off('element:settings:cancel', resetModel);
		}
	};

	var resetModel = function() {
		var newProperties = new Upfront.Collections.Properties(oldData.properties);
		newProperties._events = model.get('properties')._events;
		model.set('properties', newProperties);
		destroySettings();
	};

	var showSettings = function(view) {
		var current_object_proto, settings_obj_view;

		if (the_settings_view) {
			/** triggering the event instead of directly calling the destroy function,
				so that elements can subscribe to this event even when executed by virtue
				of toggling the settings button **/
			Upfront.Events.trigger("element:settings:canceled");
			return;
		}

		current_object_proto = _(Upfront.Application.LayoutEditor.Objects).reduce(function (obj, current) {
			if (view instanceof current.View) {
				return current;
			}
			return obj;
		}, false);

		current_object_proto = (current_object_proto && current_object_proto.Settings ? current_object_proto : Upfront.Views.Editor.Settings);
		settings_obj_view = current_object_proto.Settings;

		the_settings_view = new settings_obj_view({
			model: view.model,
			anchor: ( current_object_proto ? current_object_proto.anchor : false )
		});
		the_settings_view.for_view = view;
		the_settings_view.render();
		$('#element-settings-sidebar').html(the_settings_view.el);
		$('#element-settings-sidebar').width(260);
		$('.uf-settings-panel--expanded:not(:first)').toggleClass('uf-settings-panel--expanded').find('.uf-settings-panel__body').toggle();

		Upfront.Events.on('element:settings:saved', destroySettings);

		model = view.model;
		oldData = Upfront.Util.model_to_json(view.model);
		Upfront.Events.once('element:settings:canceled', resetModel);
		setTimeout(function() { // Remove collapsed class, but allow a bit time for some animation handled elsewhere that does not work always
			$('#element-settings-sidebar').removeClass('collapsed');
		}, 500);
	};

	Upfront.Events.on('element:settings:activate', showSettings);

	//Destroy settings when element is removed
	Upfront.Events.on("entity:removed:after", destroySettings);

	// Also destroy settings when breakpoint is toggled
	Upfront.Events.on('upfront:layout_size:change_breakpoint', destroySettings);
});
})(jQuery);


define('text!scripts/upfront/templates/link-panel.html',[],function () { return '<div class="ulinkpanel-title">{{title}}</div>\r\n<form>\r\n{[if(type == \'external\') { ]}\r\n<div class="upfront-field-wrap ulinkpanel-external-wrap">\r\n\t<input type="text" value="{{link.url}}" placeholder="Type link URL" class="upfront-field-text js-ulinkpanel-input-url js-ulinkpanel-input-external">\r\n</div>\r\n{[ } ]}\r\n{[if(type == \'email\') { ]}\r\n<div class="upfront-field-wrap ulinkpanel-external-wrap">\r\n\t<input type="text" value="{{link.url}}" placeholder="johnsmith@example.com" class="upfront-field-text js-ulinkpanel-input-url js-ulinkpanel-input-external">\r\n</div>\r\n{[ } ]}\r\n{[if(type == \'entry\') { ]}\r\n<div class="upfront-field-wrap ulinkpanel-entry-wrap">\r\n\t<a title="{{Upfront.Settings.l10n.global.content.change_link}}" class="ulinkpanel-entry-url js-ulinkpanel-input-url js-ulinkpanel-input-entry" href="#">{{(!link.url || link.url==\'\' || link.url==\'http://\')?\'Select\':link.url}}</a>\r\n</div>\r\n{[ } ]}\r\n{[if(type == \'anchor\') { ]}\r\n<div class="anchor-selector">\r\n</div>\r\n{[ } ]}\r\n{[if(type == \'lightbox\') { ]}\r\n<div class="js-ulinkpanel-input-url js-ulinkpanel-input-lightbox clearfix">\r\n\t{[ if(lightboxes.length) { ]}\r\n\t\t<div class="lightbox-selector">\r\n\t\t</div>\r\n\t\t<a href="{{link.url}}" class="link-panel-lightbox-trigger">Open lightbox</a>\r\n\t{[ } else { ]}\r\n\r\n\t{[ } ]}\r\n\r\n    <div class="js-ulinkpanel-new-lightbox ulinkpanel-new-lightbox">\r\n        <div class="ulinkpanel-title">Create lightbox</div>\r\n        <input type="text" name="new_lightbox" class="upfront-field upfront-field-text upfront-field-empty ulinkpanel-lightbox-input js-ulinkpanel-lightbox-input" value="" placeholder="{{Upfront.Settings.l10n.global.content.lightbox_name}}" />\r\n    </div>\r\n</div>\r\n{[ } ]}\r\n</form>\r\n{[if(button) { ]}\r\n<div class="upfront-settings-button_panel">\r\n\t<button type="button" class="upfront-save_settings js-ulinkpanel-ok"><i class="icon-ok"></i> {{Upfront.Settings.l10n.global.content.ok}}</button>\r\n</div>\r\n{[ } ]}\r\n';});

(function ($) {
define('scripts/upfront/link-panel',[
	"scripts/upfront/link-model",
	"text!scripts/upfront/templates/link-panel.html",
], function(LinkModel, linkPanelTpl) {

	var getAnchors = function() {
		var regions = Upfront.Application.layout.get("regions"),
			anchors = [{id: '#page', label: Upfront.Settings.l10n.global.views.back_to_top}],
			find;

		find = function (modules) {
			modules.each(function(module) {
				var group_anchor = module.get_property_value_by_name("anchor");
				if (group_anchor && group_anchor.length) {
					anchors.push({id: '#' + group_anchor, label: group_anchor});
				}
				if (module.get("objects")) {
					module.get("objects").each(function (object) {
						var anchor = object.get_property_value_by_name("anchor");
						if (anchor && anchor.length) {
							anchors.push({id: '#' + anchor, label: anchor});
						}
					});
				} else if ( module.get("modules") ) {
					find(module.get("modules"));
				}
			});
		};

		regions.each(function(r) {
			find(r.get("modules"));
		});

		return anchors;
	};

	var getPostTypes = function(){
		var types = [];

		_.each(Upfront.data.ugallery.postTypes, function(type){
			if(type.name != 'attachment') {
				types.push({name: type.name, label: type.label});
			}
		});

		return types;
	};

	var getLightBoxes = function() {
		var lightboxes = [],
			regions = Upfront.Application.layout.get('regions');

		_.each(regions.models, function(model) {
			if(model.attributes.sub == 'lightbox') {
				lightboxes.push({id: '#' + model.get('name'), label: model.get('title')});
			}
		});

		return lightboxes;
	};


	var LinkPanel = Backbone.View.extend({
		tpl: _.template(linkPanelTpl),

		defaultLinkTypes: {
			unlink: true,
			external: true,
			entry: true,
			anchor: true,
			image: false,
			lightbox: true,
			email: true,
			homepage: true
		},

		events: {
			'click .js-ulinkpanel-input-entry': 'openPostSelector',
			'keydown .js-ulinkpanel-lightbox-input': 'onLightboxNameInputChange',
			'blur .js-ulinkpanel-input-external': 'onUrlInputBlur',
			//'click .js-ulinkpanel-ok': 'onOkClick',
			'click .upfront-save_settings': 'onOkClick',
			'click .link-panel-lightbox-trigger': 'visit_lightbox'
		},

		className: 'ulinkpanel-dark',

		visit_lightbox: function(e) {
			e.preventDefault();
			var url = $(e.target).attr('href');
			
			// if there is no url defined, no point going forward
			if(!url || url==='')
				return;

			var regions = Upfront.Application.layout.get('regions');
			region = regions ? regions.get_by_name(this.getUrlanchor(url)) : false;
			if(region){
				//hide other lightboxes
				_.each(regions.models, function(model) {
					if(model.attributes.sub == 'lightbox')
						Upfront.data.region_views[model.cid].hide();
				});
				var regionview = Upfront.data.region_views[region.cid];
				regionview.show();
			}
			
		},
		getUrlanchor: function(url) {
			if(typeof(url) == 'undefined') var url = $(location).attr('href');

			if(url.indexOf('#') >=0) {
				var tempurl = url.split('#');
				return tempurl[1];
			} else return false;
		},
		initialize: function(options) {
			// Make sure we have large image url if 'image' is one of link types
			if (options.linkTypes && options.linkTypes.image && options.linkTypes.image === true && _.isUndefined(options.imageUrl)) {
				throw 'Provide "imageUrl" if "linkTypes" option has { image: true } when initializing LinkPanel.';
			}


			var me = this;
			this.options = options || {};
			this.linkTypes = _.extend({}, this.defaultLinkTypes, options.linkTypes || {});
			this.theme = options.theme || 'dark';
			this.button = options.button || false;
			this.title = options.title || Upfront.Settings.l10n.global.content.links_to;

			if (typeof options.model === 'undefined') {
				// Make sure app does not fail if there is no model.
				Upfront.Util.log('There was no link model, use new linking.');
				return;
			}

			// Rewrite anchor url to new style (to include full url)
			var pageUrl = document.location.origin + document.location.pathname;
			if (this.model.get('type') === 'anchor' && this.model.get('url').match(/^#/) !== null) {
				this.model.set({'url' : pageUrl + this.model.get('url')}, {silent:true});
			}

			this.listenTo(this.model, 'change:type', this.handleTypeChange);
		},

		onOkClick: function() {
			if (this.model.get('type') == 'lightbox' && this.$el.find('.js-ulinkpanel-lightbox-input').val() !== '') {
				this.createLightBox();
			} else {
				this.close();
				this.model.trigger("change")
			}
			//this.trigger('change', this.model);
		},

		close: function() {
			this.trigger('linkpanel:close');
		},

		handleTypeChange: function() {
			if (this.model.get('type') === 'homepage') {
				this.model.set({'url': Upfront.mainData.site}, {silent: true});
			} else {
				// Reset url property
				// We don't want funny results when changing from one type to another.
				this.model.set({'url': ''}, {silent: true});
			}
			this.render();

			if (this.model.get('type') === 'entry') {
				this.openPostSelector();
			}
			if (this.model.get('type') === 'image') {
				this.model.set({'url': this.options.imageUrl});
			}
		},

		/**
		 * Determine proper link type select value/label based on link type. Used
		 * to populate link type select field.
		 */
		getLinkTypeValue: function(type) {
			var contentL10n = Upfront.Settings.l10n.global.content;
			switch(type) {
				case 'homepage':
					return { value: 'homepage', label: contentL10n.homepage };
				case 'unlink':
					return { value: 'unlink', label: contentL10n.no_link };
				case 'external':
					return { value: 'external', label: contentL10n.url };
				case 'email':
					return { value: 'email', label: contentL10n.email };
				case 'entry':
					return { value: 'entry', label: contentL10n.post_or_page };
				case 'anchor':
					return { value: 'anchor', label: contentL10n.anchor };
				case 'image':
					return { value: 'image', label: contentL10n.larger_image };
				case 'lightbox':
					return { value: 'lightbox', label: contentL10n.lightbox };
			}
		},

		/* Handle entry link type. (post or page) */
		/**
		 * Open post selector for entry type url and set link url when done.
		 */
		openPostSelector: function(event) {
			if (event) {
				event.preventDefault();
			}

			var me = this,
				selectorOptions = {
					postTypes: getPostTypes()
				};

			Upfront.Views.Editor.PostSelector.open(selectorOptions).done(function(post){
				me.model.set({url: post.get('permalink'), object: post.get('post_type'), object_id: post.get('ID')});
				me.render();
			});
		},

		/* Handle lightbox link type. */
		/**
		 * Check input for lightbox name for enter key.
		 */
		onLightboxNameInputChange: function(event) {
			if (event.which == 13) {
				event.preventDefault();
				this.createLightBox();
			}
		},

		createLightBox: function() {
			var name = $.trim(this.$('.js-ulinkpanel-lightbox-input').val());
			if (!name) {
				Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.views.ltbox_empty_name_nag, 'error');
				return false;
			}

			this.model.set({
				url: '#' + Upfront.Application.LayoutEditor.getLightboxSafeName(name)
			});

			Upfront.Application.LayoutEditor.createLightboxRegion(name);
			// this is required to send a 'dontflag' to the editor, 
			// because the lightbox is created
			// after the link is saved in the text.
			// triggering the change again will refresh the editor's state 
			// and get rid of missing link flag
			this.model.trigger("change", true); 
			this.render();
		},

		/* Handle manually entered urls: external and email */
		onUrlInputBlur: function(event) {
			var userInput = $(event.currentTarget).val().trim();
			if (this.model.get('type') === 'external' && !userInput.match(/https?:\/\//)) {
				userInput = 'http://' + userInput;
			}
			if (this.model.get('type') === 'email' && !userInput.match(/^mailto:/)) {
				userInput = 'mailto:' + userInput;
			}

			this.model.set({'url': userInput});
			this.render();
		},

		/* Rendering stuff below */
		render: function() {

			var me = this;

			if (!this.model) {
			this.$el.html('Error occurred, link panel switch to new style.');
				return;
			}
			var tplData = {
				title: this.title,
				link: this.model.toJSON(),
				checked: 'checked="checked"',
				lightboxes: getLightBoxes(),
				button: this.button,
				type: this.model.get('type')
			};

			this.$el.html(this.tpl(tplData));

			this.renderTypeSelect();

			if (this.model.get('type') == 'anchor') {
				this.renderAnchorSelect();
			}

			if (this.model.get('type') == 'lightbox' && getLightBoxes()) {
				this.renderLightBoxesSelect();
			}

			if (_.contains(['external', 'entry', 'homepage'], this.model.get('type'))) {
				this.renderTargetRadio();
			}

			this.delegateEvents();
		},

		renderTypeSelect: function() {
			var me = this;

			var typeSelectValues = [];
			_.each(this.linkTypes, function(use, type) {
				if (!use) {
					return;
				}
				typeSelectValues.push(this.getLinkTypeValue(type));
			}, this);

			this.typeSelect = new Upfront.Views.Editor.Field.Select({
				label: '',
				values: typeSelectValues,
				default_value: this.model.get('type'),
				change: function () {
					me.model.set({'type': this.get_value()});
				}
			});

			this.typeSelect.render();
			this.$el.find('form').prepend(this.typeSelect.el);
		},

		renderTargetRadio: function() {
			var me = this;

			this.targetRadio = new Upfront.Views.Editor.Field.Radios({
				label: 'Target:',
				default_value: this.model.get('target') || '_self',
				layout: 'horizontal-inline',
				values: [
					{ label: 'blank', value: '_blank' },
					{ label: 'self', value: '_self' }
				],
				change: function () {
					me.model.set({'target': this.get_value()});
				}
			});

			this.targetRadio.render();
			this.$el.find('form').append(this.targetRadio.el);
		},

		renderAnchorSelect: function() {
			var model = this.model,
				pageUrl = document.location.origin + document.location.pathname;

			var anchorValues = [{label: 'Choose Anchor...', value: ''}];
			_.each(getAnchors(), function(anchor) {
				anchorValues.push({label: anchor.label, value: pageUrl + anchor.id});
			});

			var anchorValue = this.model.get('url');
			anchorValue = anchorValue ? anchorValue : '';
			anchorValue = anchorValue.indexOf('#') !== -1 ? anchorValue : '';

			this.anchorSelect = new Upfront.Views.Editor.Field.Select({
				label: '',
				values: anchorValues,
				default_value: anchorValue,
				change: function () {
					model.set({'url': this.get_value()});
				}
			});
			this.anchorSelect.render();
			this.$el.find('.anchor-selector').append(this.anchorSelect.el);
		},

		renderLightBoxesSelect: function() {
			var model = this.model;
			var lightboxValues = [{label: 'Choose Lightbox...', value: ''}];
			_.each(getLightBoxes() || [], function(lightbox) {
				lightboxValues.push({label: lightbox.label, value: lightbox.id});
			});

			var lightboxValue = this.model.get('url');
			lightboxValue = lightboxValue ? lightboxValue : '';
			lightboxValue = lightboxValue.match(/^#/) ? lightboxValue : '';

			this.lightboxSelect = new Upfront.Views.Editor.Field.Select({
				label: '',
				values: lightboxValues,
				default_value: lightboxValue,
				change: function () {
					model.set({'url': this.get_value()});
					$('.link-panel-lightbox-trigger').attr('href', this.get_value());
				}
			});
			this.lightboxSelect.render();
			this.$el.find('.lightbox-selector').append(this.lightboxSelect.el);
		},

		delegateEvents: function(events) {
			if (this.typeSelect) {
				this.typeSelect.delegateEvents();
			}
			if (this.anchorSelect) {
				this.anchorSelect.delegateEvents();
			}
			if (this.lightboxSelect) {
				this.lightboxSelect.delegateEvents();
			}
			Backbone.View.prototype.delegateEvents.call(this, events);
		}
	});

	return LinkPanel;

});
})(jQuery);


define('text!upfront/templates/property.html',[],function () { return '<dt class="upfront-property">{{name}}</dt>\r\n<dd class="upfront-property">\r\n\t{{value}}\r\n\t<div class="upfront-property-actions">\r\n\t\t<a href="#" class="upfront-property-change">{{Upfront.Settings.l10n.global.views.edit}}</a>\r\n\t\t<a href="#" class="upfront-property-remove">{{Upfront.Settings.l10n.global.views.remove}}</a>\r\n\t</div>\r\n</dd>';});


define('text!upfront/templates/properties.html',[],function () { return '<h3>{{name}}</h3>\r\n\r\n<dl class="upfront-properties_collection">\r\n</dl>\r\n\r\n<button type="button" id="add-property">{{Upfront.Settings.l10n.global.views.add_new}}</button>\r\n\r\n<div id="upfront-new_property" style="display:none">\r\n\t<input type="text" id="upfront-new_property-name" placeholder="name" />\r\n\t<input type="text" id="upfront-new_property-value" placeholder="value" />\r\n\t<button type="button" id="done-adding-property">{{Upfront.Settings.l10n.global.views.add}}</button>\r\n</div>';});


define('text!upfront/templates/property_edit.html',[],function () { return '<input type="text" id="upfront-new_property-name" placeholder="name" value="{{name}}" />\r\n<input type="text" id="upfront-new_property-value" placeholder="value" value="{{value}}" />\r\n<button type="button" class="upfront-property-save">{{Upfront.Settings.l10n.global.views.save}}</button>';});


define('text!upfront/templates/overlay_grid.html',[],function () { return '<div class="upfront-overlay-grid upfront-overlay-grid-{{style}}">\r\n\t{[ _(columns).times(function(i){ var c = i+1; ]}<div class="c1 t1 m1 upfront-grid-border">{{c}}</div>{[ }) ]}\r\n</div>\r\n';});


define('text!upfront/templates/edit_background_area.html',[],function () { return '<div class="command-edit-label">{{Upfront.Settings.l10n.global.views.edit_bg_areas}}</div>\r\n<div class="command-edit-switcher">\r\n\t<span class="switch switch-off">{{Upfront.Settings.l10n.global.views.off}}</span>\r\n\t<span class="switch switch-on">{{Upfront.Settings.l10n.global.views.on}}</span>\r\n\t<span class="knob"></span>\r\n</div>';});


define('text!upfront/templates/sidebar_settings_lock_area.html',[],function () { return '<div class="panel-setting-item">\r\n\t<div class="region-lock-switch upfront-icon upfront-icon-unlock {{lock_class}}">{{Upfront.Settings.l10n.global.views.lock_areas}}</div>\r\n</div>\r\n<div class="panel-setting-dialog panel-setting-dialog-info">{{Upfront.Settings.l10n.global.views.unlock_areas}}</div>';});


define('text!upfront/templates/sidebar_settings_background.html',[],function () { return '<div class="panel-setting-item">\r\n\t<div class="panel-setting-sub-label">{{Upfront.Settings.l10n.global.views..background}}:</div>\r\n\t<div class="panel-setting-background clearfix">\r\n\t\t<input type="text" id="region-bg-color" name="color" />\r\n\t\t<a href="#" id="region-bg-image-upload" class="panel-setting-button upfront-icon upfront-icon-edit thickbox">{{Upfront.Settings.l10n.global.views..upload_image}}</a>\r\n\t\t<a href="#" id="region-bg-image-edit" class="panel-setting-button upfront-icon upfront-icon-edit" style="display: none;">{{Upfront.Settings.l10n.global.views..edit_image}}</a>\r\n\t</div>\r\n\t<div class="panel-setting-background-more">\r\n\t\t<div class="background-image-wrap"></div>\r\n\t\t<div class="panel-setting-sub-label">{{Upfront.Settings.l10n.global.views..edit_image_position}}:</div>\r\n\t\t<div class="panel-setting-background-position">\r\n\t\t\t<div class="background-position-select">\r\n\t\t\t\t<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="left top" /></span>\r\n\t\t\t\t<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="center top" /></span>\r\n\t\t\t\t<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="right top" /></span>\r\n\t\t\t\t<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="left center" /></span>\r\n\t\t\t\t<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="center" /></span>\r\n\t\t\t\t<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="right center" /></span>\r\n\t\t\t\t<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="left bottom" /></span>\r\n\t\t\t\t<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="center bottom" /></span>\r\n\t\t\t\t<span class="position-select-wrap"><input type="radio" class="position-select" name="position" value="right bottom" /></span>\r\n\t\t\t</div>\r\n\t\t\t<div class="or-round">or</div>\r\n\t\t\t<div class="background-tile-select">\r\n\t\t\t\t<label class="tile-select-wrap"><input type="checkbox" class="upfront-field-checkbox tile-select" name="tile" value="repeat-x" />{{Upfront.Settings.l10n.global.views..tile_horizontally}}</label>\r\n\t\t\t\t<label class="tile-select-wrap"><input type="checkbox" class="upfront-field-checkbox tile-select" name="tile" value="repeat-y" />{{Upfront.Settings.l10n.global.views..tile_vertically}}</label>\r\n\t\t\t\t<label class="tile-select-wrap"><input type="checkbox" class="upfront-field-checkbox tile-select" name="tile" value="fill" />{{Upfront.Settings.l10n.global.views..fill_space}}</label>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>';});


define('text!upfront/templates/popup.html',[],function () { return '<div>\r\n<!--\r\n\tWrap everything in a div to convert this file\'s content in a jquery element\r\n\tso it is possible to use $.find.\r\n-->\r\n<script type="text/template" id="upfront-post-list-tpl">\r\n<div id="upfront-list">\r\n\t<div id="upfront-list-meta" class="upfront-list_item clearfix">\r\n\t\t<div class="upfront-list_item-component upfront-date upfront-header {{ orderby == \'post_date\' ? \'active ordered-\' + order : \'\' }}" data-sortby="post_date">Date <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n\t\t<div class="upfront-list_item-component upfront-title upfront-header {{ orderby == \'post_title\' ? \'active ordered-\' + order : \'\' }}"  data-sortby="post_title">Post Title <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n\t\t<div class="upfront-list_item-component upfront-author upfront-header {{ orderby == \'post_author\' ? \'active ordered-\' + order : \'\' }}" data-sortby="post_author">Author <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n\t\t<div class="upfront-list_item-component upfront-comments-count upfront-header {{ orderby == \'post_comments\' ? \'active ordered-\' + order : \'\' }}" data-sortby="post_comments"><i class="icon-post-comments"></i> <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n\t</div>\r\n\t<div class="upfront-list-items upfront-scroll-panel">\r\n\t{[ if(!posts.length){ ]}\r\n\t\t<p class="upfront-no-results">{{Upfront.Settings.l10n.global.content.no_posts}}</p>\r\n\t{[ } else { ]}\r\n\t{[ _.each(posts, function (post, idx){ ]}\r\n\t\t<div class="upfront-list_item-post upfront-list_item clearfix status-{{ post.get("post_status") }}" data-post_id="{{ post.get("ID") }}">\r\n\t\t\t<div class="upfront-list_item-component upfront-date post-status-{{ post.get("post_status") }}" title="{[ if(post.get("post_status") == "publish") { ]}Published{[ } else if(post.get("post_status") == "future") { ]}Scheduled{[ } else { ]}Draft{[ } ]}">{[ if(post.get("post_status") == "future") { ]}sched. for{[ } ]}\r\n\t\t\t{{ Upfront.Util.format_date(post.get("post_date")) }}</div>\r\n\t\t\t<div class="upfront-list_item-component upfront-title upfront-list_item-main">{{ post.get("post_title") }}</div>\r\n\t\t\t<div class="upfront-list_item-component upfront-author">{[ if(post.author.get(\'data\')){ ]} {{ post.author.get(\'data\').display_name }} {[ } ]}</div>\r\n\t\t\t<div class="upfront-list_item-component upfront-comments-count">{{ post.get("comment_count") }}</div>\r\n\t\t\t<div class="upfront-list_item-component upfront-editactions"><a href="{{ post.get("permalink") }}" class="editaction edit">Edit</a><a href="{{ post.get("permalink") }}" class="editaction view">View</a><a href="#" class="editaction trash">Trash</a></div>\r\n\t\t</div>\r\n\t{[ }); } ]}\r\n\t</div>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" type="text/template" id="upfront-post-single-tpl">\r\n<div id="upfront-list-page" style="display:none">\r\n\t<div id="upfront-list-page-path">\r\n\t\t<a href="#" class="upfront-path-back">{{Upfront.Settings.l10n.global.content.posts}}</a> &nbsp;&raquo;&nbsp;\r\n\t\t<a href="#" class="last">{{ post.get(\'post_title\') }}</a>\r\n\t</div>\r\n\t<div id="upfront-list-page-preview">\r\n\t\t<div id="upfront-page_preview-wrapper">\r\n\t\t\t<div id="upfront-page_preview-featured_image" class="upfront-page_preview-item">\r\n\t\t\t\t<h4>Featured Image: </h4>\r\n\t\t\t\t<div class="upfront-thumbnailinfo">{{Upfront.Settings.l10n.global.content.loading}}</div>\r\n\t\t\t\t<img src="{{post.featuredImage }}" style="{{post.featuredImage ? \'\' : \'display:none\'}}" />\r\n\t\t\t<div class="upfront-page_preview-edit_feature"><a href="#">{{Upfront.Settings.l10n.global.content.edit}} <i class="icon-pencil"></i></a></div>\r\n\t\t\t</div>\r\n\t\t\t<div class="upfront-page_preview-bottom" id="upfront-page_preview-edit">\r\n\t\t\t\t<button type="button"><i class="icon-pencil"></i> {{Upfront.Settings.l10n.global.content.edit_post}}</button>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div id="upfront-list-page-tree" class="upfront-scroll-panel">\r\n\t\t<div class="upfront-post_content-wrapper">\r\n\t\t\t<div class="upfront-post_content">\r\n\t\t\t\t<h3>{{ post.get(\'post_title\') }}</h3>\r\n\t\t\t\t{{ post.get(\'post_content\') }}\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-page-list-old-tpl">\r\n<div id="upfront-list-page" class="bordered-bottom clearfix">\r\n\t<div id="upfront-list-page-path"></div>\r\n\t<div id="upfront-list-page-preview">\r\n\t\t<div id="upfront-page_preview-wrapper">\r\n\t\t\t<h4>{{Upfront.Settings.l10n.global.content.select_page}}</h4>\r\n\t\t</div>\r\n\t</div>\r\n\t<div id="upfront-list-page-tree" class="upfront-list-items upfront-scroll-panel">\r\n\t{[ _.each(pages, function (page){ ]}\r\n\t\t{{ pageItemTemplate({page: page, pageItemTemplate: pageItemTemplate}) }}\r\n\t{[ }); ]}\r\n\t</div>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template"  id="upfront-page-list-item-tpl">\r\n\t<div class="upfront-list-page_item {{ page.children.length ? \'has_children closed\' : \'\' }}" id="upfront-list-page_item-{{ page.get("ID") }}" data-post_id="{{ page.get("ID") }}">\r\n\t\t{[if(page.children.length){ ]}\r\n\t\t<i class="icon-caret-right"></i>\r\n\t\t<i class="icon-caret-down"></i>\r\n\t\t{[ } ]}\r\n\t\t{{ page.get("post_title") }}\r\n\t\t{[if(page.children.length){ page.children.each(function(child, idx) { ]}\r\n\t\t\t{{ pageItemTemplate({page: child, pageItemTemplate: pageItemTemplate}) }}\r\n\t\t{[ })}; ]}\r\n\t</div>\r\n</script>\r\n\r\n\r\n<script type="text/template" id="upfront-page-list-tpl">\r\n<div id="upfront-list">\r\n\t<div id="upfront-list-meta" class="upfront-list_item clearfix">\r\n\t\t<div class="upfront-list_item-component upfront-date upfront-header {{ orderby == \'post_date\' ? \'active ordered-\' + order : \'\' }}" data-sortby="post_date">Date <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n\t\t<div class="upfront-list_item-component upfront-title upfront-header {{ orderby == \'post_title\' ? \'active ordered-\' + order : \'\' }}"  data-sortby="post_title">Page Title <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n\t\t<div class="upfront-list_item-component upfront-author upfront-header {{ orderby == \'post_author\' ? \'active ordered-\' + order : \'\' }}" data-sortby="post_author">Author <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n\t\t<div class="upfront-list_item-component upfront-comments-count upfront-header {{ orderby == \'post_comments\' ? \'active ordered-\' + order : \'\' }}" data-sortby="post_comments"><i class="icon-post-comments"></i> <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n\t</div>\r\n\t<div class="upfront-list-items upfront-scroll-panel">\r\n\t{[ if(!pages.length){ ]}\r\n\t\t<p class="upfront-no-results">{{Upfront.Settings.l10n.global.content.no_posts}}</p>\r\n\t{[ } else { ]}\r\n\t{[ _.each(pages, function (post){ ]}\r\n\t\t<div class="upfront-list_item-post upfront-list_item clearfix status-{{ post.get("post_status") }}" data-post_id="{{ post.get("ID") }}">\r\n\t\t\t<div class="upfront-list_item-component upfront-date post-status-{{ post.get("post_status") }}" title="{[ if(post.get("post_status") == "publish") { ]}Published{[ } else if(post.get("post_status") == "future") { ]}Scheduled{[ } else { ]}Draft{[ } ]}">{[ if(post.get("post_status") == "future") { ]}sched. for{[ } ]}\r\n\t\t\t{{ Upfront.Util.format_date(post.get("post_date")) }}</div>\r\n\t\t\t<div class="upfront-list_item-component upfront-title upfront-list_item-main">{{ post.get("post_title") }}</div>\r\n\t\t\t<div class="upfront-list_item-component upfront-author">{[ if(post.author.get(\'data\')){ ]} {{ post.author.get(\'data\').display_name }} {[ } ]}</div>\r\n\t\t\t<div class="upfront-list_item-component upfront-comments-count">{{ post.get("comment_count") }}</div>\r\n\t\t\t<div class="upfront-list_item-component upfront-editactions"><a href="{{ post.get("permalink") }}" class="editaction edit">Edit</a><a href="{{ post.get("permalink") }}" class="editaction view">View</a><a href="#" class="editaction trash">Trash</a></div>\r\n\t\t</div>\r\n\t{[ }); } ]}\r\n\t</div>\r\n</div>\r\n</script>\r\n\r\n\r\n\r\n<script type="text/template" id="upfront-page-preview-tpl">\r\n\t<div id="upfront-page_preview-wrapper" class="upfront-scroll-panel">\r\n\t\t<div id="upfront-page_preview-featured_image" class="upfront-page_preview-item">\r\n\t\t\t<h4>{{Upfront.Settings.l10n.global.content.featured_image}}: </h4>\r\n\t\t\t<div class="upfront-thumbnailinfo" style="{{page.thumbnail ? \'display:none\' : \'\'}}">Loading...</div>\r\n\t\t\t<img src="{{page.thumbnail }}" style="{{page.thumbnail ? \'\' : \'display:none\'}}" />\r\n\t\t\t<div class="upfront-page_preview-edit_feature"><a href="#">Edit <i class="icon-pencil"></i></a></div>\r\n\t\t</div>\r\n\t\t<div id="upfront-page_preview-template" class="upfront-page_preview-item">\r\n\t\t\t<h4>{{Upfront.Settings.l10n.global.content.template}}: </h4>\r\n\t\t\t<select id="upfront-page_template-select">\r\n\t\t\t\t<option value="0">{{Upfront.Settings.l10n.global.content.default_opt}}</option>\r\n\t\t\t\t{[ _.each(allTemplates, function(tpl, name){ var selected = tpl == template ? \'selected="selected"\' : ""; ]}\r\n\t\t\t\t<option value="{{tpl}}" {{selected}}>{{name}}</option>\r\n\t\t\t\t{[ }) ]}\r\n\t\t\t</select>\r\n\t\t</div>\r\n\t\t<div id="upfront-page_preview-edit">\r\n\t\t\t<button type="button"><i class="icon-pencil"></i> {{Upfront.Settings.l10n.global.content.edit_page}}</button>\r\n\t\t</div>\r\n\t</div>\r\n</script>\r\n\r\n<script type="text/template"  id="upfront-comments-tpl">\r\n<div id="upfront-list" class="upfront-list-comments clearfix bordered-bottom">\r\n\t{[ if(!comments.length){ ]}\r\n\t\t<p class="upfront-no-results">{{Upfront.Settings.l10n.global.content.no_comments}}</p>\r\n\t{[ } else { ]}\r\n\t<div id="upfront-list-meta" class="upfront-list_item">\r\n\t\t<div class="upfront-list_item-component upfront-comment_author upfront-header {{ orderby == \'comment_author\' ? \'active ordered-\' + order : \'\' }}" data-sortby="comment_author">{{Upfront.Settings.l10n.global.content.author}} <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n\t\t<div class="upfront-list_item-component upfront-date upfront-header {{ orderby == \'comment_date\' ? \'active ordered-\' + order : \'\' }}" data-sortby="comment_date">{{Upfront.Settings.l10n.global.content.date}} <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n\t\t<div class="upfront-list_item-component upfront-comment_content upfront-header {{ orderby == \'comment_content\' ? \'active ordered-\' + order : \'\' }}" data-sortby="comment_content">{{Upfront.Settings.l10n.global.content.comment}} <i class="icon-caret-down"></i><i class="icon-caret-up"></i></div>\r\n\t</div>\r\n\t<div class="upfront-list-items upfront-list-comment-items upfront-scroll-panel">\r\n\r\n\t\t{[ _.each(comments, function(comment){ ]}\r\n\t\t<div class="upfront-list_item-comment upfront-list_item clearfix" id="upfront-list_item-comment-{{ comment.get("comment_ID") }}" data-comment_id="{{ comment.get("comment_ID") }}">\r\n\t\t\t\t{{ commentTpl({comment:comment, excerptLength: excerptLength}) }}\r\n\t\t</div>\r\n\t\t{[ }) ]}\r\n\t</div>\r\n\t{[ } ]}\r\n</div>\r\n</script>\r\n\r\n<script type="text/template"  id="upfront-comment-single-tpl">\r\n\t{[ var excerpt = jQuery(\'<div></div>\').html(comment.get(\'comment_content\')).text(); ]}\r\n\t\t<div class="upfront-comment-approved">\r\n\t\t\t{[ if(comment.get("comment_approved") === \'0\'){ ]}\r\n\t\t\t<i class="upfront-comments-approve icon-circle-blank" data-comment_id="{{ comment.get("comment_ID") }}"></i>\r\n\t\t\t{[ } ]}\r\n\t\t</div>\r\n\t\t<div class="upfront-list_item-component upfront-comment_author">\r\n\t\t\t<img src="{{ Upfront.Util.get_avatar(comment) }}" title="{{comment.get("comment_author")}}" class="avatar" /> {{comment.get("comment_author")}}</div>\r\n\t\t<div class="upfront-list_item-component upfront-date">{{ Upfront.Util.format_date(comment.get("comment_date")) }}</div>\r\n\t\t<div class="upfront-list_item-component upfront-comment_content upfront-comment_excerpt upfront-list_item-main upfront-post_content">{{ excerpt.length > excerptLength ? excerpt.substring(0, excerptLength) + \' [...]\' : excerpt }}</div>\r\n\t\t<div class="upfront-list_item-component upfront-comment_content upfront-comment_content-full-wrapper upfront-list_item-main upfront-post_content  upfront-scroll-panel">\r\n\t\t\t<div class="upfront-comment_content-full upfront-comment_togglable">{{ comment.get("comment_content") }}</div>\r\n\t\t\t<div class="upfront-comment_edit upfront-comment_togglable" data-comment_id="{{ comment.get(\'comment_ID\') }}">\r\n\t\t\t\t<textarea class="comment-edit-box" class="edit" rows="16">{{ comment.get("comment_content") }}</textarea>\r\n\t\t\t\t<button type="button" class="comment-edit-ok">{{Upfront.Settings.l10n.global.content.ok}}</button>\r\n\t\t\t\t<button type="button" class="comment-edit-cancel">{{Upfront.Settings.l10n.global.content.cancel}}</button>\r\n\t\t\t</div>\r\n\t\t\t<div class="upfront-comment_reply upfront-comment_togglable" data-comment_id="{{ comment.get(\'comment_ID\') }}">\r\n\t\t\t\t<textarea class="comment-edit-box" class="edit" rows="16" placeholder="Reply here..."></textarea>\r\n\t\t\t\t<button type="button" class="comment-reply-ok">{{Upfront.Settings.l10n.global.content.ok}}</button>\r\n\t\t\t\t<button type="button" class="comment-reply-cancel">{{Upfront.Settings.l10n.global.content.cancel}}</button>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<div class="upfront-comment_actions-wrapper">\r\n\t\t\t{[ if(comment.get("comment_approved") !== \'trash\'){ ]}\r\n\t\t\t<a href="#reply" class="reply"><i class="icon-reply"></i> {{Upfront.Settings.l10n.global.content.reply}}</a>\r\n\t\t\t{[ } ]}\r\n\t\t\t<a href="#edit" class="edit"><i class="icon-pencil"></i> {{Upfront.Settings.l10n.global.content.edit}}</a>\r\n\t\t\t{[ if(comment.get("comment_approved") === \'0\'){ ]}\r\n\t\t\t<a href="#approve" class="approve"><i class="icon-ok"></i> {{Upfront.Settings.l10n.global.content.approve}}</a>\r\n\t\t\t{[ } else if(comment.get("comment_approved") === \'1\'){ ]}\r\n\t\t\t<a href="#unapprove" class="unapprove"><i class="icon-circle-blank"></i> {{Upfront.Settings.l10n.global.content.unapprove}}</a>\r\n\t\t\t{[ } if(comment.get("comment_approved") === \'spam\'){ ]}\r\n\t\t\t<a href="#unspam" class="unspam"><i class="icon-comment-alt"></i> {{Upfront.Settings.l10n.global.content.unspam}}</a>\r\n\t\t\t{[ } else if(comment.get("comment_approved") !== \'trash\') { ]}\r\n\t\t\t<a href="#spam" class="spam"><i class="icon-ban-circle"></i> {{Upfront.Settings.l10n.global.content.spam}}</a>\r\n\t\t\t{[ } if(comment.get("comment_approved") === \'trash\'){ ]}\r\n\t\t\t<a href="#unthrash" class="unthrash"><i class="icon-comment"></i> {{Upfront.Settings.l10n.global.content.untrash}}</a>\r\n\t\t\t{[ } else { ]}\r\n\t\t\t<a href="#thrash" class="thrash"><i class="icon-remove"></i> {{Upfront.Settings.l10n.global.content.trash}}</a>\r\n\t\t\t{[ } ]}\r\n\t\t</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-slug-tpl">\r\n<div class="upfront-slug_editor">\r\n\t<div class="upfront-slug_editor-title">{{Upfront.Settings.l10n.global.content.edit_post_url}}</div>\r\n\t<p class="upfront-slug_editor-info">{{Upfront.Settings.l10n.global.content.post_url_info}}</p>\r\n\t<p class="upfront-slug_editor-url">\r\n\t\t{{ rootURL }}\r\n\t\t<input type="text" id="upfront-post_slug" value\t="{{ slug }}" />\r\n\t\t<button id="upfront-post_slug-send" value="{{Upfront.Settings.l10n.global.content.ok}}"><i class="icon-ok"></i> {{Upfront.Settings.l10n.global.content.ok}}</button>\r\n\t</p>\r\n</div>\r\n</script>\r\n<script type="text/template" id="upfront-pagination-tpl">\r\n\t<div id="upfront-entity_list-pagination">\r\n\t\t<a class="upfront-pagination_item upfront-pagination_item-skip upfront-pagination_item-prev"></a>\r\n\r\n\r\n\t\t<div class="upfront-pagination_navigation">\r\n\t\t\t<input type="text" class="upfront-pagination_page-current" value="{{currentPage+1}}" /> of <a class="upfront-pagination_page-item" data-idx="{{pages}}">{{pages}}</a>\r\n\t\t</div>\r\n\r\n\t\t<a class="upfront-pagination_item upfront-pagination_item-skip upfront-pagination_item-next"></a>\r\n\r\n\t\t<small>{{totalElements}} items</small>\r\n\t\t</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-pagination-tpl-old">\r\n<div id="upfront-entity_list-pagination" data-total="{{ pages }}" data-page_size="{{pageSize}}">\r\n\t{[ if(pages > 1) { ]}\r\n\t<div class="upfront-pagination_item upfront-pagination_item-skip upfront-pagination_item-prev">\r\n\r\n\t</div>\r\n\r\n\t{[ _.each(_.range(pages), function(i){ ]}\r\n\t<div class="upfront-pagination_item upfront-pagination_page-item {{ i == currentPage ? \'current\' : \'\' }}" data-page_idx="{{ i }}">{{ i + 1}}</div>\r\n\t{[ }) ]}\r\n\r\n\t<div class="upfront-pagination_item upfront-pagination_item-skip upfront-pagination_item-next">\r\n\r\n\t</div>\r\n\t{[ } ]}\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-tabs-tpl">\r\n<ul class="upfront-tabs">\r\n\t{[ _.each(tabs, function(tab){ ]}\r\n\t<li data-type="{{tab.id}}" class="{{ tab.id == active ? \'active\' : \'\' }}">{{tab.text}}</li>\r\n\t{[ }); ]}\r\n</ul>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-search-tpl">\r\n\t<div class="search_container clearfix">\r\n\t\t<div id="upfront-search_action" class="search upfront-icon upfront-icon-popup-search"></div>\r\n\t\t<div id="upfront-search_container" style="display:{{ query ? \'block\' : \'none\' }}">\r\n\t\t\t<input type="text" id="upfront-list-search_input" value="{{ query ? query : \'\' }}" />\r\n\t\t</div>\r\n\t</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-notifier-tpl">\r\n\t<div id="upfront-notifier">\r\n   \t\t<div id="upfront-notice"></div>\r\n\t</div>\r\n</script>\r\n\r\n<script type="text/template" id="selector-post_type-tpl">\r\n{[if(postTypes.length > 1){ ]}\r\n<div id="upfront-selector-post_type">\r\n\t{{Upfront.Settings.l10n.global.views.select_post_type}}\r\n\t<div class="upfront-field-select">\r\n\t\t<div class="upfront-field-select-value">{{postTypes[0].label}}</div>\r\n\t\t<ul class="upfront-field-select-options">\r\n\t\t{[ _.each(postTypes, function(type){ ]}\r\n\t\t\t<li class="upfront-field-select-option upfront-selector-option" rel="{{ type.name }}">\r\n\t\t\t\t{{ type.label }}\r\n\t\t\t</li>\r\n\t\t{[ }); ]}\r\n\t\t</ul>\r\n\t</div>\r\n</div>\r\n{[ } ]}\r\n<div id="upfront-selector-posts" class="upfront-scroll-panel">\r\n\r\n</div>\r\n</script>\r\n<script type="text/template" id="selector-post-tpl">\r\n<table id="upfront-list" class="upfront-list-items">\r\n{[ _.each(posts, function(post){ ]}\r\n<tr class="upfront-selector-post upfront-list_item" rel="{{post.id}}">\r\n\t<td class="upfront-selector-post-checked upfront-list_item-component"></td>\r\n\t<td class="upfront-selector-post-title upfront-list_item-component upfront-list_item-main">{{post.get(\'post_title\')}}</td>\r\n\t<td class="upfront-selector-post-date upfront-list_item-component">{{ Upfront.Util.format_date(post.get(\'post_date\'), false) }}</td>\r\n</tr>\r\n{[ }) ]}\r\n</table>\r\n</script>\r\n\r\n\r\n<script type="text/template" id="datepicker-tpl">\r\n<div class="upfront-date_picker upfront-ui">\r\n\t<div class="upfront-bar-datepicker">\r\n\t</div>\r\n\t<div class="upfront-time_picker">\r\n\t\tTime:\r\n\t\t<select class="ueditor-hours-select">\r\n\t\t\t{[ _.each(hours, function(h){ ]}\r\n\t\t\t<option value="{{h}}" {{h == currentHour ? \'selected=\\\'selected\\\'\' : \'\'}} >{{h}}</option>\r\n\t\t\t{[ }); ]}\r\n\t\t</select>:\r\n\t\t<select class="ueditor-minutes-select">\r\n\t\t\t{[ _.each(minutes, function(m){ ]}\r\n\t\t\t<option value="{{m}}" {{m == currentMinute ? \'selected=\\\'selected\\\'\' : \'\'}} >{{m}}</option>\r\n\t\t\t{[ }); ]}\r\n\t\t</select>\r\n\t</div>\r\n\t<div class="ueditor-datepicker-buttons">\r\n\t\t<a class="ueditor-action-pickercancel">Cancel</a>\r\n\t\t<a class="ueditor-action-pickerok button small-button">Ok</a>\r\n\t</div>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="microselect-tpl">\r\n\t\t<div class="ueditor-select-options">\r\n\t\t\t{[ _.each(options, function(option){ ]}\r\n\t\t\t\t<a class="ueditor-select-option ueditor-action-status" data-id="{{option.value}}">{{option.name}}</a>\r\n\t\t\t{[ }); ]}\r\n\t\t</div>\r\n\t\t<input type="text" class="ueditor-select-focus">\r\n</script>\r\n\r\n<script id="csseditor-tpl" type="text/template">\r\n\t<div class="upfront-css-resizable">\r\n\t\t<div class="upfront-css-top">\r\n      {[ if (elementType) { ]}\r\n\t\t\t<span class="upfront-css-type">{{ elementType }} Element</span>\r\n      {[ } ]}\r\n\t\t\t{[ if (showToolbar) { ]}\r\n\t\t\t<div id="insert-font-widget" class="upfront-icon">\r\n\t\t\t\t<a class="upfront-css-font" href="#">{{Upfront.Settings.l10n.global.content.insert_font}}</a>\r\n\t\t\t</div>\r\n\t\t\t<a class="upfront-css-theme_image upfront-css-image" href="#">{{Upfront.Settings.l10n.global.content.insert_theme_image}}</a>\r\n\t\t\t<a class="upfront-css-media_image upfront-css-image" href="#">{{Upfront.Settings.l10n.global.content.insert_image}}</a>\r\n\t\t\t<span class="upfront-css-color"></span>\r\n      {[ } ]}\r\n\t\t\t<a class="upfront-css-close" href="#">close</a>\r\n\t\t</div>\r\n\t\t<div class="upfront-css-body">\r\n\t\t\t<div class="upfront-css-ace"></div>\r\n\t\t\t<div class="upfront-css-sidebar">\r\n        {[ if (selectors) { ]}\r\n\t\t\t\t<div class="upfront-css-selectors upfront-scroll-panel">\r\n\t\t\t\t\t<p>{{Upfront.Settings.l10n.global.content.available_element_selectors}}</p>\r\n\t\t\t\t\t{[ _.each(selectors, function(data, s){ ]}\r\n\t\t\t\t\t<span class="upfront-css-selector" title="{{ data.info }}" data-selector="{{ s }}">{{data.label}}</span>\r\n\t\t\t\t\t{[ }); ]}\r\n          {[ if (elementType) { ]}\r\n\t\t\t\t\t{{ _.size(selectors) ? \'\' : \'No selectors available for the \' + elementType.toLowerCase() + \' element.\'}}\r\n          {[ } ]}\r\n\t\t\t\t</div>\r\n        {[ } ]}\r\n\t\t\t\t<div class="upfront-css-save-form">\r\n        \t\t{[ if (show_style_name) { ]}\r\n\t\t\t\t\t<p>{{Upfront.Settings.l10n.global.views.style_name}}</p>\r\n\t\t\t\t\t<input type="text" class="upfront-css-save-name-field" value="{{ name }}">\r\n        \t\t{[ } ]}\r\n          \t\t\t<button class="upfront-css-save-ok">{{Upfront.Settings.l10n.global.content.save}}</button>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</script>\r\n\r\n<script id="icon-fonts-manager-tpl" type="text/template">\r\n\t<div class="manage-icon-fonts">\r\n\t\t<div class="fonts-manager-panel-title">\r\n\t\t\t{{Upfront.Settings.l10n.global.content.choose_icon_fonts}}\r\n\t\t</div>\r\n\t\t<div class="icon-fonts-list">\r\n\t\t\t{[ _.each(fonts, function(font) { ]}\r\n\t\t\t<div data-family="{{ font.get(\'family\') }}" class="icon-fonts-list-item {[ if (font.get(\'active\')) { ]}icon-fonts-list-item-active{[ } ]}">\r\n\t\t\t\t{{ font.get(\'name\') }}{[ if (font.getUploadStatus() !== true) { ]} <span class="icon-font-upload-status" title="{{ font.getUploadStatus() }}">*</span>{[ } ]}\r\n\t\t\t</div>\r\n\t\t\t{[ }); ]}\r\n\t\t</div>\r\n\t\t{[ if(Upfront.themeExporter && location.pathname.match(/\\/create_new\\/theme/) === null) { ]}\r\n\t\t<div class="upload-icon-font">{{Upfront.Settings.l10n.global.views.upload_icon_font}}</div>\r\n\t\t<form style="display: none" id="upfront-upload-icon-font" name="upfront-upload-icon-font" enctype="multipart/form-data" method="post" action="{{url}}" data-url="{{url}}?action=upfront-upload-icon-font">\r\n\t\t\t<input type="file" name="media" id="upfront-icon-font-input">\r\n\t\t\t<input type="hidden" name="action" value="upfront-upload-icon-font">\r\n\t\t\t<input type="submit" value="Upload">\r\n\t\t</form>\r\n\t\t{[ } ]}\r\n\t</div>\r\n\t<div class="preview-icon-fonts">\r\n\t\t<div class="fonts-manager-panel-title">\r\n\t\t\t{{Upfront.Settings.l10n.global.content.icon_font_icons_preview}}\r\n\t\t</div>\r\n\t\t<div class="icon-font-icons-preview">\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="A">A</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="B">B</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="C">C</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="D">D</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="E">E</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="F">F</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="G">G</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="H">H</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="I">I</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="J">J</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="K">K</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="L">L</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="M">M</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="N">N</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="O">O</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="P">P</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="Q">Q</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="R">R</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="S">S</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="T">T</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="U">U</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="V">V</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="W">W</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="X">X</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="Y">Y</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="Z">Z</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="a">a</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="b">b</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="c">c</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="d">d</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="e">e</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="f">f</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="g">g</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="h">h</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="i">i</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="j">j</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="k">k</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="l">l</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="m">m</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="n">n</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="o">o</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="p">p</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="q">q</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="r">r</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="s">s</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="t">t</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="u">u</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="v">v</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="w">w</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="x">x</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="y">y</div>\r\n\t\t\t<div class="icon-font-icon-preview uf_font_icon" title="z">z</div>\r\n\t\t</div>\r\n\t</div>\r\n</script>\r\n\r\n<script id="text-fonts-manager-tpl" type="text/template">\r\n  <div class="add-font-panel panel">\r\n    <div class="loading-fonts">{{Upfront.Settings.l10n.global.content.loading_fonts}}</div>\r\n    <div class="font-weights-list">\r\n      <div class="font-weights-list-wrapper">\r\n\t\t\t\t<div class="fonts-manager-panel-title">\r\n\t\t\t\t\t{{Upfront.Settings.l10n.global.content.choose_typeface}}\r\n\t\t\t\t</div>\r\n\t\t\t\t{[ if (show_no_styles_notice) { ]}\r\n\t\t\t\t<div class="fonts-weights-notice-text">\r\n\t\t\t\t\t{{Upfront.Settings.l10n.global.content.typeface_info_text}}\r\n\t\t\t\t</div>\r\n\t\t\t\t{[ } ]}\r\n\t\t\t</div>\r\n    </div>\r\n    <span class="add-font-button">Add &raquo;</span>\r\n  </div>\r\n</script>\r\n\r\n<script id="theme-fonts-panel" type="text/template">\r\n    <h3 class="panel-title">{{Upfront.Settings.l10n.global.content.theme_font_styles}}</h3>\r\n\t\t<div class="font-list">\r\n\t\t\t{[ if (show_no_styles_notice) { ]}\r\n\t\t\t<div class="fonts-manager-panel-title">{{Upfront.Settings.l10n.global.content.no_fonts_added}}</div>\r\n\t\t\t{[ } ]}\r\n\t\t</div>\r\n    <div class="font-stats">\r\n    </div>\r\n</script>\r\n\r\n<script id="theme-font-list-item" type="text/template">\r\n{{ family }} ({{ variant }})<span class="delete upfront-icon"></span>\r\n</script>\r\n\r\n<script id="save-dialog-tpl" type="text/template">\r\n\t<div id="upfront-save-dialog">\r\n\t\t<p>{{ question }}</p>\r\n\t\t<span class="upfront-save-button" data-save-as="this-post">{{ thisPostButton }}</span>\r\n\t\t<span class="upfront-save-button" data-save-as="all-posts">{{ allPostsButton }}</span>\r\n\t</div>\r\n</script>\r\n\r\n\r\n<!-- end of the wrap div -->\r\n</div>\r\n';});


define('text!upfront/templates/region_add_panel.html',[],function () { return '<div class="upfront-add-region-choice"></div>\r\n<div class="upfront-add-region-new"></div>\r\n<div class="upfront-add-region-global"></div>\r\n\r\n';});


define('text!upfront/templates/region_edit_panel.html',[],function () { return '<div>\r\n<!--\r\n\tWrap everything in a div to convert this file\'s content in a jquery element\r\n\tso it is possible to use $.find.\r\n-->\r\n<script type="text/template" id="upfront-region-bg-setting">\r\n\t<div class="upfront-region-bg-setting-header clearfix">\r\n\t\t<div class="upfront-region-bg-setting-auto-resize"></div>\r\n\t\t\r\n\t\t<div class="upfront-region-bg-setting-name">\r\n\t\t\t<div class="upfront-region-bg-setting-name-wrap">\r\n\t\t\t\t<span class="upfront-region-name-edit-value"></span>\r\n\t\t\t\t<span class="upfront-region-bg-setting-is-global">{{Upfront.Settings.l10n.global.views.global}}</span>\r\n\t\t\t\t<a href="#" class="upfront-region-name-edit-trigger">{{Upfront.Settings.l10n.global.views.edit}}</a>\r\n\t\t\t</div>\r\n\t\t\t<div class="upfront-region-bg-setting-name-edit"></div>\r\n\t\t</div>\r\n\t</div>\r\n\t\r\n\t<div class="upfront-region-bg-setting-fixed-region clearfix">\r\n\t\t<div class="upfront-region-bg-setting-label">{{Upfront.Settings.l10n.global.views.floating_region_settings}}:</div>\r\n\r\n\t</div>\r\n\r\n\t<div class="upfront-region-bg-setting-lightbox-region clearfix">\r\n\r\n\t</div>\r\n\r\n\t<div class="upfront-region-bg-setting-theme-body">\r\n\t\t<div class="upfront-region-bg-setting-heading">{{Upfront.Settings.l10n.global.views.global_bg_settings}}</div>\r\n\r\n\t</div>\r\n\r\n\t<div class="upfront-region-bg-setting-region-global"></div>\r\n\t<div class="upfront-region-bg-setting-add-global-region"></div>\r\n\r\n\t<div class="upfront-region-bg-setting-region-type">\r\n\t\t<!-- <div class="upfront-region-bg-setting-label">{{Upfront.Settings.l10n.global.views.area_type}}</div> -->\r\n\t</div>\r\n\t<div class="upfront-region-bg-setting-region-behavior">\r\n\t\t<div class="upfront-region-bg-setting-label">{{Upfront.Settings.l10n.global.views.element_behavior}}</div>\r\n\t</div>\r\n\t<div class="upfront-region-bg-setting-region-nav">\r\n\t\t<div class="upfront-region-bg-setting-label">{{Upfront.Settings.l10n.global.views.add_sub_region}}</div>\r\n\t</div>\r\n\t<div class="upfront-region-bg-setting-type">\r\n\t\t<div class="upfront-region-bg-setting-label">{{Upfront.Settings.l10n.global.views.bg_type}}</div>\r\n\t</div>\r\n\t<div class="upfront-region-bg-setting-tab upfront-region-bg-setting-tab-color"></div>\r\n\t<div class="upfront-region-bg-setting-tab upfront-region-bg-setting-tab-image"></div>\r\n\t<div class="upfront-region-bg-setting-tab upfront-region-bg-setting-tab-featured"></div>\r\n\t<div class="upfront-region-bg-setting-tab upfront-region-bg-setting-tab-slider"></div>\r\n\t<div class="upfront-region-bg-setting-tab upfront-region-bg-setting-tab-map"></div>\r\n\t<div class="upfront-region-bg-setting-tab upfront-region-bg-setting-tab-video"></div>\r\n\t<div class="upfront-region-bg-setting-padding">\r\n\t\t<div class="upfront-region-bg-setting-padding-type"></div>\r\n\t\t<div class="upfront-region-bg-setting-equal-padding"></div>\r\n\t\t<div class="upfront-region-bg-setting-varied-padding">\r\n\t\t\t<div class="upfront-region-bg-setting-padding-top">\r\n\t\t\t\t<div class="upfront-region-bg-setting-label">{{Upfront.Settings.l10n.global.views.top_padding}}</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="upfront-region-bg-setting-padding-bottom">\r\n\t\t\t\t<div class="upfront-region-bg-setting-label">{{Upfront.Settings.l10n.global.views.bottom_padding}}</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div class="upfront-region-bg-setting-footer clearfix">\r\n\t\t<!-- <div class="upfront-region-bg-setting-change-image">\r\n\t\t\t{{Upfront.Settings.l10n.global.views.change_image}}\r\n\t\t</div> -->\r\n\t\t<div class="upfront-region-bg-setting-floating-restrict"></div>\r\n\t\t<div class="upfront-region-bg-setting-sticky"></div>\r\n\t\t<div class="upfront-region-bg-setting-edit-css upfront-icon upfront-icon-edit-css">\r\n\t\t\t<span>{{Upfront.Settings.l10n.global.views.edit_region_css}}</span>\r\n\t\t</div>\r\n\t</div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-region-bg-setting-tab">\r\n\t<div class="upfront-region-bg-setting-tab-primary"></div>\r\n\t<div class="upfront-region-bg-setting-tab-secondary"></div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-region-bg-setting-tab-color">\r\n\t<div class="upfront-region-bg-setting-tab-primary">\r\n\t\t<div class="upfront-region-bg-setting-label">{{Upfront.Settings.l10n.global.views.pick_color}}</div>\r\n\t</div>\r\n\t<div class="upfront-region-bg-setting-tab-secondary"></div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-region-bg-setting-tab-image">\r\n\t<div class="upfront-region-bg-setting-tab-primary">\r\n\t\t<div class="upfront-region-bg-setting-label">{{Upfront.Settings.l10n.global.views.image_variation}}</div>\r\n\t</div>\r\n\t<div class="upfront-region-bg-setting-tab-secondary"></div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-region-bg-setting-tab-featured">\r\n\t<div class="upfront-region-bg-setting-tab-primary">\r\n\t\t<div class="upfront-region-bg-setting-label">{{Upfront.Settings.l10n.global.views.image_variation}}</div>\r\n\t</div>\r\n\t<div class="upfront-region-bg-setting-tab-secondary"></div>\r\n</script>\r\n\r\n<script type="text/template" id="upfront-region-bg-setting-tab-slider">\r\n\t<div class="upfront-region-bg-setting-tab-primary">\r\n\t\t<div class="upfront-region-bg-setting-label">{{Upfront.Settings.l10n.global.views.slider_transition}}</div>\r\n\t</div>\r\n\t<div class="upfront-region-bg-setting-tab-secondary"></div>\r\n</script>\r\n\r\n\r\n<script type="text/template" id="upfront-region-bg-setting-tab-video">\r\n\t<div class="upfront-region-bg-setting-tab-primary">\r\n\t\t<div class="upfront-region-bg-setting-label">&nbsp;</div>\r\n\t</div>\r\n\t<div class="upfront-region-bg-setting-tab-secondary"></div>\r\n</script>\r\n\r\n\r\n</div>\r\n';});


define('text!upfront/templates/sidebar_settings_theme_colors.html',[],function () { return '<div class="panel-setting-theme-colors">\r\n    <div class="pabel-setting-theme-colors-top">\r\n        <div id="panel-setting-theme-colors-pane">\r\n            {[ if (!colors.length){ ]}\r\n            <div id="theme-colors-no-color-notice" class="upfront-icon">\r\n                {{Upfront.Settings.l10n.global.views.no_colors_click_plus}}\r\n            </div>\r\n            {[ } ]}\r\n            <div id="theme-colors-swatches">\r\n                <span class="theme-colors-swatch"></span>\r\n                <p class="theme-colors-explanation">{{Upfront.Settings.l10n.global.views.theme_colors_explanation}} <span class="theme-colors-eg-attribute">color:</span> <span class="theme-colors-eg-sharp">#</span><span class="theme-colors-eg-value">ufc2</span><span class="theme-colors-eg-semicolon">;</span></p>\r\n                {[ _.each(colors, function (color, idx){ ]}\r\n                                <span class="theme-colors-color-picker color-{{idx}}" data-index="{{idx}}" data-color="{{color.color}}"></span>\r\n                {[ }); ]}\r\n                {[ if (colors.length < 10){ ]}\r\n                 <span class="theme_colors_empty_picker"></span>\r\n                {[ } ]}\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <!--<div class="panel-setting-theme-colors-bottom">-->\r\n        <!--<div class="panel-setting-theme-colors-shades-wrap">-->\r\n            <!--{[ if( colors.length ){ ]}-->\r\n                        <!--{{Upfront.Settings.l10n.global.views.define_swatch_hovers}}-->\r\n            <!--<label id="panel-setting-theme-colors-shades-label"  for="panel-setting-theme-colors-shades-range">-->\r\n                            <!--Color change value (<span class="panel-setting-theme-colors-shades-range-number">{{range}}</span>)-->\r\n                        <!--</label>-->\r\n                        <!--<div class="upfront-field upfront-field-slider panel-setting-theme-colors-shades-range"></div>-->\r\n                        <!--<ul class="panel-setting-theme-colors-shades-range-labels">-->\r\n                                <!--<li>0</li>-->\r\n                                <!--<li>50</li>-->\r\n                        <!--</ul>-->\r\n            <!--<div class="panel-setting-theme-colors-meta">-->\r\n                <!--{{Upfront.Settings.l10n.global.views.click_hilite_shade}}-->\r\n                                <!--<p class="swatch-title">{{Upfront.Settings.l10n.global.views.hilite}}:</p>-->\r\n                <!--<div class="panel-setting-theme-colors-highlights">-->\r\n                    <!--{[ _.each(colors, function (color, idx){ ]}-->\r\n                                        <!--<span class="theme-colors-color-box theme-colors-highlight{[ if(color.selected === \'highlight\') { ]} theme-colors-color-box-selected{[ } ]} {{color.luminance}} color-{{idx}}" style="background-color: {{color.highlight}}" data-color="{{color.highlight}}" data-index="{{idx}}" data-type="highlight"></span>-->\r\n                    <!--{[ }); ]}-->\r\n                <!--</div>-->\r\n                <!--<p class="swatch-title">Shade:</p>-->\r\n                <!--<div class="panel-setting-theme-colors-shades">-->\r\n                    <!--{[ _.each(colors, function (color, idx){ ]}-->\r\n                                        <!--<span class="theme-colors-color-box theme-colors-shade{[ if(color.selected === \'shade\') { ]} theme-colors-color-box-selected{[ } ]} {{color.luminance}} color-{{idx}}"  style="background-color: {{color.shade}}" data-index="{{idx}}" data-color="{{color.shade}}" data-type="shade"></span>-->\r\n                    <!--{[ }); ]}-->\r\n                <!--</div>-->\r\n            <!--</div>-->\r\n            <!--{[ } ]}-->\r\n        <!--</div>-->\r\n    <!--</div>-->\r\n</div>\r\n';});


define('text!upfront/templates/color_picker.html',[],function () { return '<ul class="upfront_color_picker_rgba">\r\n\t<li class="upfront_color_picker_rgba_r">\r\n\t\tR:\r\n\t\t<input type="text" value="{{r}}" data-type=\'r\' name="upfront_color_picker_rgba_r">\r\n\t</li>\r\n\t<li class="upfront_color_picker_rgba_g">\r\n\t\tG:\r\n\t\t<input type="text" value="{{g}}" data-type=\'g\' name="upfront_color_picker_rgba_g">\r\n\t</li>\r\n\t<li class="upfront_color_picker_rgba_b">\r\n\t\tB:\r\n\t\t<input type="text" value="{{b}}" data-type=\'b\'  name="upfront_color_picker_rgba_b">\t\t\r\n\t</li>\r\n\t<li class="upfront_color_picker_rgba_a">\r\n\t\tA:\r\n\t\t<input type="text" value="{{a}}" data-type=\'a\' name="upfront_color_picker_rgba_a">\t\t\t\r\n\t</li>\r\n</ul>\r\n<span class="upfront_color_picker_reset noColor"></span>';});

// Spectrum Colorpicker v1.3.2
// https://github.com/bgrins/spectrum
// Author: Brian Grinstead
// License: MIT

(function (window, $, undefined) {
    var defaultOpts = {

            // Callbacks
            beforeShow: noop,
            move: noop,
            change: noop,
            show: noop,
            hide: noop,

            // Options
            color: false,
            flat: false,
            showInput: false,
            allowEmpty: false,
            showButtons: true,
            clickoutFiresChange: false,
            showInitial: false,
            showPalette: false,
            showPaletteOnly: false,
            showSelectionPalette: true,
            localStorageKey: false,
            appendTo: "body",
            maxSelectionSize: 7,
            cancelText: "cancel",
            chooseText: "choose",
            clearText: "Clear Color Selection",
            preferredFormat: false,
            className: "",
            showAlpha: false,
            theme: "sp-light",
            palette: [["#ffffff", "#000000", "#ff0000", "#ff8000", "#ffff00", "#008000", "#0000ff", "#4b0082", "#9400d3"]],
            selectionPalette: [],
            disabled: false
        },
        spectrums = [],
        IE = !!/msie/i.exec( window.navigator.userAgent ),
        rgbaSupport = (function() {
            function contains( str, substr ) {
                return !!~('' + str).indexOf(substr);
            }

            var elem = document.createElement('div');
            var style = elem.style;
            style.cssText = 'background-color:rgba(0,0,0,.5)';
            return contains(style.backgroundColor, 'rgba') || contains(style.backgroundColor, 'hsla');
        })(),
        inputTypeColorSupport = (function() {
            var colorInput = $("<input type='color' value='!' />")[0];
            return colorInput.type === "color" && colorInput.value !== "!";
        })(),
        replaceInput = [
            "<div class='sp-replacer'>",
            "<div class='sp-preview'><div class='sp-preview-inner'></div></div>",
            "<div class='sp-dd'>&#9660;</div>",
            "</div>"
        ].join(''),
        markup = (function () {

            // IE does not support gradients with multiple stops, so we need to simulate
            //  that for the rainbow slider with 8 divs that each have a single gradient
            var gradientFix = "";
            if (IE) {
                for (var i = 1; i <= 6; i++) {
                    gradientFix += "<div class='sp-" + i + "'></div>";
                }
            }

            return [
                "<div class='sp-container sp-hidden'>",
                "<div class='sp-palette-container'>",
                "<div class='sp-palette sp-thumb sp-cf'></div>",
                "</div>",
                "<div class='sp-picker-container'>",
                "<div class='sp-top sp-cf'>",
                "<div class='sp-fill'></div>",
                "<div class='sp-top-inner'>",
                "<div class='sp-color'>",
                "<div class='sp-sat'>",
                "<div class='sp-val'>",
                "<div class='sp-dragger'></div>",
                "</div>",
                "</div>",
                "</div>",
                "<div class='sp-clear sp-clear-display'>",
                "</div>",
                "<div class='sp-hue'>",
                "<div class='sp-slider'></div>",
                gradientFix,
                "</div>",
                "</div>",
                "<div class='sp-alpha'><div class='sp-alpha-inner'><div class='sp-alpha-handle'></div></div></div>",
                "</div>",
                "<div class='sp-input-container sp-cf'>",
                "<input class='sp-input' type='text' spellcheck='false'  />",
                "</div>",
                "<div class='sp-initial sp-thumb sp-cf'></div>",
                "<div class='sp-button-container sp-cf'>",
                "<a class='sp-cancel' href='#'></a>",
                "<button class='sp-choose'></button>",
                "</div>",
                "</div>",
                "</div>"
            ].join("");
        })();

    function paletteTemplate (p, color, className) {
        var html = [];
        for (var i = 0; i < p.length; i++) {
            var current = p[i];
            if(current) {
                var tiny = tinycolor(current);
                var c = tiny.toHsl().l < 0.5 ? "sp-thumb-el sp-thumb-dark" : "sp-thumb-el sp-thumb-light";
                c += (tinycolor.equals(color, current)) ? " sp-thumb-active" : "";

                var swatchStyle = rgbaSupport ? ("background-color:" + tiny.toRgbString()) : "filter:" + tiny.toFilter();
                html.push('<span title="' + tiny.toRgbString() + '" data-color="' + tiny.toRgbString() + '" class="' + c + '"><span class="sp-thumb-inner" style="' + swatchStyle + ';" /></span>');
            } else {
                var cls = 'sp-clear-display';
                html.push('<span title="No Color Selected" data-color="" style="background-color:transparent;" class="' + cls + '"></span>');
            }
        }
        return "<div class='sp-cf " + className + "'>" + html.join('') + "</div>";
    }

    function hideAll() {
        for (var i = 0; i < spectrums.length; i++) {
            if (spectrums[i]) {
                spectrums[i].hide();
            }
        }
    }

    function instanceOptions(o, callbackContext) {
        var opts = $.extend({}, defaultOpts, o);
        opts.callbacks = {
            'move': bind(opts.move, callbackContext),
            'change': bind(opts.change, callbackContext),
            'show': bind(opts.show, callbackContext),
            'hide': bind(opts.hide, callbackContext),
            'beforeShow': bind(opts.beforeShow, callbackContext)
        };

        return opts;
    }

    function spectrum(element, o) {

        var opts = instanceOptions(o, element),
            flat = opts.flat,
            showSelectionPalette = opts.showSelectionPalette,
            localStorageKey = opts.localStorageKey,
            theme = opts.theme,
            callbacks = opts.callbacks,
            resize = throttle(reflow, 10),
            visible = false,
            dragWidth = 0,
            dragHeight = 0,
            dragHelperHeight = 0,
            slideHeight = 0,
            slideWidth = 0,
            alphaWidth = 0,
            alphaSlideHelperWidth = 0,
            slideHelperHeight = 0,
            currentHue = 0,
            currentSaturation = 0,
            currentValue = 0,
            currentAlpha = 1,
            palette = [],
            paletteArray = [],
            paletteLookup = {},
            selectionPalette = opts.selectionPalette.slice(0),
            maxSelectionSize = opts.maxSelectionSize,
            draggingClass = "sp-dragging",
            shiftMovementDirection = null;

        var doc = element.ownerDocument,
            body = doc.body,
            boundElement = $(element),
            disabled = false,
            container = $(markup, doc).addClass(theme),
            dragger = container.find(".sp-color"),
            dragHelper = container.find(".sp-dragger"),
            slider = container.find(".sp-hue"),
            slideHelper = container.find(".sp-slider"),
            alphaSliderInner = container.find(".sp-alpha-inner"),
            alphaSlider = container.find(".sp-alpha"),
            alphaSlideHelper = container.find(".sp-alpha-handle"),
            textInput = container.find(".sp-input"),
            paletteContainer = container.find(".sp-palette"),
            initialColorContainer = container.find(".sp-initial"),
            cancelButton = container.find(".sp-cancel"),
            clearButton = container.find(".sp-clear"),
            chooseButton = container.find(".sp-choose"),
            isInput = boundElement.is("input"),
            isInputTypeColor = isInput && inputTypeColorSupport && boundElement.attr("type") === "color",
            shouldReplace = isInput && !flat,
            replacer = (shouldReplace) ? $(replaceInput).addClass(theme).addClass(opts.className) : $([]),
            offsetElement = (shouldReplace) ? replacer : boundElement,
            previewElement = replacer.find(".sp-preview-inner"),
            initialColor = opts.color || (isInput && boundElement.val()),
            colorOnShow = false,
            preferredFormat = opts.preferredFormat,
            currentPreferredFormat = preferredFormat,
            clickoutFiresChange = !opts.showButtons || opts.clickoutFiresChange,
            isEmpty = !initialColor,
            allowEmpty = opts.allowEmpty && !isInputTypeColor;

        function applyOptions() {

            if (opts.showPaletteOnly) {
                opts.showPalette = true;
            }

            if (opts.palette) {
                palette = opts.palette.slice(0);
                paletteArray = $.isArray(palette[0]) ? palette : [palette];
                paletteLookup = {};
                for (var i = 0; i < paletteArray.length; i++) {
                    for (var j = 0; j < paletteArray[i].length; j++) {
                        var rgb = tinycolor(paletteArray[i][j]).toRgbString();
                        paletteLookup[rgb] = true;
                    }
                }
            }

            container.toggleClass("sp-flat", flat);
            container.toggleClass("sp-input-disabled", !opts.showInput);
            container.toggleClass("sp-alpha-enabled", opts.showAlpha);
            container.toggleClass("sp-clear-enabled", allowEmpty);
            container.toggleClass("sp-buttons-disabled", !opts.showButtons);
            container.toggleClass("sp-palette-disabled", !opts.showPalette);
            container.toggleClass("sp-palette-only", opts.showPaletteOnly);
            container.toggleClass("sp-initial-disabled", !opts.showInitial);
            container.addClass(opts.className);

            reflow();
        }

        function initialize() {

            if (IE) {
                container.find("*:not(input)").attr("unselectable", "on");
            }

            applyOptions();

            if (shouldReplace) {
                boundElement.after(replacer).hide();
            }

            if (!allowEmpty) {
                clearButton.hide();
            }

            if (flat) {
                boundElement.after(container).hide();
            }
            else {

                var appendTo = opts.appendTo === "parent" ? boundElement.parent() : $(opts.appendTo);
                if (appendTo.length !== 1) {
                    appendTo = $("body");
                }

                appendTo.append(container);
            }

            updateSelectionPaletteFromStorage();

            offsetElement.bind("click.spectrum touchstart.spectrum", function (e) {
                if (!disabled) {
                    toggle();
                }

                e.stopPropagation();

                if (!$(e.target).is("input")) {
                    e.preventDefault();
                }
            });

            if(boundElement.is(":disabled") || (opts.disabled === true)) {
                disable();
            }

            // Prevent clicks from bubbling up to document.  This would cause it to be hidden.
            container.click(stopPropagation);

            // Handle user typed input
            textInput.change(setFromTextInput);
            textInput.bind("paste", function () {
                setTimeout(setFromTextInput, 1);
            });
            textInput.keydown(function (e) { if (e.keyCode == 13) { setFromTextInput(); } });

            cancelButton.text(opts.cancelText);
            cancelButton.bind("click.spectrum", function (e) {
                e.stopPropagation();
                e.preventDefault();
                hide("cancel");
            });

            clearButton.attr("title", opts.clearText);
            clearButton.bind("click.spectrum", function (e) {
                e.stopPropagation();
                e.preventDefault();
                isEmpty = true;
                move();

                if(flat) {
                    //for the flat style, this is a change event
                    updateOriginalInput(true);
                }
            });

            chooseButton.text(opts.chooseText);
            chooseButton.bind("click.spectrum", function (e) {
                e.stopPropagation();
                e.preventDefault();

                if (isValid()) {
                    updateOriginalInput(true);
                    hide();
                }
            });

            draggable(alphaSlider, function (dragX, dragY, e) {
                currentAlpha = (dragX / alphaWidth);
                isEmpty = false;
                if (e.shiftKey) {
                    currentAlpha = Math.round(currentAlpha * 10) / 10;
                }

                move();
            }, dragStart, dragStop);

            draggable(slider, function (dragX, dragY) {
                currentHue = parseFloat(dragY / slideHeight);
                isEmpty = false;
                if (!opts.showAlpha) {
                    currentAlpha = 1;
                }
                move();
            }, dragStart, dragStop);

            draggable(dragger, function (dragX, dragY, e) {

                // shift+drag should snap the movement to either the x or y axis.
                if (!e.shiftKey) {
                    shiftMovementDirection = null;
                }
                else if (!shiftMovementDirection) {
                    var oldDragX = currentSaturation * dragWidth;
                    var oldDragY = dragHeight - (currentValue * dragHeight);
                    var furtherFromX = Math.abs(dragX - oldDragX) > Math.abs(dragY - oldDragY);

                    shiftMovementDirection = furtherFromX ? "x" : "y";
                }

                var setSaturation = !shiftMovementDirection || shiftMovementDirection === "x";
                var setValue = !shiftMovementDirection || shiftMovementDirection === "y";

                if (setSaturation) {
                    currentSaturation = parseFloat(dragX / dragWidth);
                }
                if (setValue) {
                    currentValue = parseFloat((dragHeight - dragY) / dragHeight);
                }

                isEmpty = false;
                if (!opts.showAlpha) {
                    currentAlpha = 1;
                }

                move();

            }, dragStart, dragStop);

            if (!!initialColor) {
                set(initialColor);

                // In case color was black - update the preview UI and set the format
                // since the set function will not run (default color is black).
                updateUI();
                currentPreferredFormat = preferredFormat || tinycolor(initialColor).format;

                addColorToSelectionPalette(initialColor);
            }
            else {
                updateUI();
            }

            if (flat) {
                show();
            }

            function palletElementClick(e) {
                if (e.data && e.data.ignore) {
                    set($(this).data("color"));
                    move();
                }
                else {
                    set($(this).data("color"));
                    move();
                    updateOriginalInput(true);
                    hide();
                }

                return false;
            }

            var paletteEvent = IE ? "mousedown.spectrum" : "click.spectrum touchstart.spectrum";
            paletteContainer.delegate(".sp-thumb-el", paletteEvent, palletElementClick);
            initialColorContainer.delegate(".sp-thumb-el:nth-child(1)", paletteEvent, { ignore: true }, palletElementClick);
        }

        function updateSelectionPaletteFromStorage() {

            if (localStorageKey && window.localStorage) {

                // Migrate old palettes over to new format.  May want to remove this eventually.
                try {
                    var oldPalette = window.localStorage[localStorageKey].split(",#");
                    if (oldPalette.length > 1) {
                        delete window.localStorage[localStorageKey];
                        $.each(oldPalette, function(i, c) {
                            addColorToSelectionPalette(c);
                        });
                    }
                }
                catch(e) { }

                try {
                    selectionPalette = window.localStorage[localStorageKey].split(";");
                }
                catch (e) { }
            }
        }

        function addColorToSelectionPalette(color) {
            if (showSelectionPalette) {
                var rgb = tinycolor(color).toRgbString();
                if (!paletteLookup[rgb] && selectionPalette.indexOf(rgb) === -1) {
                    selectionPalette.push(rgb);
                    while(selectionPalette.length > maxSelectionSize) {
                        selectionPalette.shift();
                    }
                }

                if (localStorageKey && window.localStorage) {
                    try {
                        window.localStorage[localStorageKey] = selectionPalette.join(";");
                    }
                    catch(e) { }
                }
            }
        }

        function getUniqueSelectionPalette() {
            var unique = [];
            if (opts.showPalette) {
                for (i = 0; i < selectionPalette.length; i++) {
                    var rgb = tinycolor(selectionPalette[i]).toRgbString();

                    if (!paletteLookup[rgb]) {
                        unique.push(selectionPalette[i]);
                    }
                }
            }

            return unique.reverse().slice(0, opts.maxSelectionSize);
        }

        function drawPalette() {

            var currentColor = get();

            var html = $.map(paletteArray, function (palette, i) {
                return paletteTemplate(palette, currentColor, "sp-palette-row sp-palette-row-" + i);
            });

            updateSelectionPaletteFromStorage();

            if (selectionPalette) {
                html.push(paletteTemplate(getUniqueSelectionPalette(), currentColor, "sp-palette-row sp-palette-row-selection"));
            }

            paletteContainer.html(html.join(""));
        }

        function drawInitial() {
            if (opts.showInitial) {
                var initial = colorOnShow;
                var current = get();
                initialColorContainer.html(paletteTemplate([initial, current], current, "sp-palette-row-initial"));
            }
        }

        function dragStart() {
            if (dragHeight <= 0 || dragWidth <= 0 || slideHeight <= 0) {
                reflow();
            }
            container.addClass(draggingClass);
            shiftMovementDirection = null;
            boundElement.trigger('dragstart.spectrum', [ get() ]);
        }

        function dragStop() {
            container.removeClass(draggingClass);
            boundElement.trigger('dragstop.spectrum', [ get() ]);
        }

        function setFromTextInput() {

            var value = textInput.val();

            if ((value === null || value === "") && allowEmpty) {
                set(null);
                updateOriginalInput(true);
            }
            else {
                var tiny = tinycolor(value);
                if (tiny.ok) {
                    set(tiny);
                    updateOriginalInput(true);
                }
                else {
                    textInput.addClass("sp-validation-error");
                }
            }
        }

        function toggle() {
            if (visible) {
                hide();
            }
            else {
                show();
            }
        }

        function show() {
            var event = $.Event('beforeShow.spectrum');

            if (visible) {
                reflow();
                return;
            }

            boundElement.trigger(event, [ get() ]);

            if (callbacks.beforeShow(get()) === false || event.isDefaultPrevented()) {
                return;
            }

            hideAll();
            visible = true;

            $(doc).bind("click.spectrum", hide);
            $(window).bind("resize.spectrum", resize);
            replacer.addClass("sp-active");
            container.removeClass("sp-hidden");

            reflow();
            updateUI();

            colorOnShow = get();

            drawInitial();
            callbacks.show(colorOnShow);
            boundElement.trigger('show.spectrum', [ colorOnShow ]);
        }

        function hide(e) {
            // Return on right click
            if (e && e.type == "click" && e.button == 2) { return; }

            // Return if hiding is unnecessary
            if (!visible || flat) { return; }
            visible = false;

            $(doc).unbind("click.spectrum", hide);
            $(window).unbind("resize.spectrum", resize);

            replacer.removeClass("sp-active");
            container.addClass("sp-hidden");

            var colorHasChanged = !tinycolor.equals(get(), colorOnShow);

            if (colorHasChanged) {
                if (clickoutFiresChange && e !== "cancel") {
                    updateOriginalInput(true);
                }
                else {
                    revert();
                }
            }

            callbacks.hide(get());
            boundElement.trigger('hide.spectrum', [ get() ]);
        }

        function revert() {
            set(colorOnShow, true);
        }

        function set(color, ignoreFormatChange) {
            if (tinycolor.equals(color, get())) {
                // Update UI just in case a validation error needs
                // to be cleared.
                updateUI();
                return;
            }

            var newColor, newHsv;
            if (!color && allowEmpty) {
                isEmpty = true;
            } else {
                isEmpty = false;
                newColor = tinycolor(color);
                newHsv = newColor.toHsv();

                currentHue = (newHsv.h % 360) / 360;
                currentSaturation = newHsv.s;
                currentValue = newHsv.v;
                currentAlpha = newHsv.a;
            }
            updateUI();

            if (newColor && newColor.ok && !ignoreFormatChange) {
                currentPreferredFormat = preferredFormat || newColor.format;
            }
        }

        function get(opts) {
            opts = opts || { };

            if (allowEmpty && isEmpty) {
                return null;
            }

            return tinycolor.fromRatio({
                h: currentHue,
                s: currentSaturation,
                v: currentValue,
                a: Math.round(currentAlpha * 100) / 100
            }, { format: opts.format || currentPreferredFormat });
        }

        function isValid() {
            return !textInput.hasClass("sp-validation-error");
        }

        function move() {
            updateUI();

            callbacks.move(get());
            boundElement.trigger('move.spectrum', [ get() ]);
        }

        function updateUI() {

            textInput.removeClass("sp-validation-error");

            updateHelperLocations();

            // Update dragger background color (gradients take care of saturation and value).
            var flatColor = tinycolor.fromRatio({ h: currentHue, s: 1, v: 1 });
            dragger.css("background-color", flatColor.toHexString());

            // Get a format that alpha will be included in (hex and names ignore alpha)
            var format = currentPreferredFormat;
            if (currentAlpha < 1 && !(currentAlpha === 0 && format === "name")) {
                if (format === "hex" || format === "hex3" || format === "hex6" || format === "name") {
                    format = "rgb";
                }
            }

            var realColor = get({ format: format }),
                displayColor = '';

            //reset background info for preview element
            previewElement.removeClass("sp-clear-display");
            previewElement.css('background-color', 'transparent');

            if (!realColor && allowEmpty) {
                // Update the replaced elements background with icon indicating no color selection
                previewElement.addClass("sp-clear-display");
            }
            else {
                var realHex = realColor.toHexString(),
                    realRgb = realColor.toRgbString();

                // Update the replaced elements background color (with actual selected color)
                if (rgbaSupport || realColor.alpha === 1) {
                    previewElement.css("background-color", realRgb);
                }
                else {
                    previewElement.css("background-color", "transparent");
                    previewElement.css("filter", realColor.toFilter());
                }

                if (opts.showAlpha) {
                    var rgb = realColor.toRgb();
                    rgb.a = 0;
                    var realAlpha = tinycolor(rgb).toRgbString();
                    var gradient = "linear-gradient(left, " + realAlpha + ", " + realHex + ")";

                    if (IE) {
                        alphaSliderInner.css("filter", tinycolor(realAlpha).toFilter({ gradientType: 1 }, realHex));
                    }
                    else {
                        alphaSliderInner.css("background", "-webkit-" + gradient);
                        alphaSliderInner.css("background", "-moz-" + gradient);
                        alphaSliderInner.css("background", "-ms-" + gradient);
                        // Use current syntax gradient on unprefixed property.
                        alphaSliderInner.css("background",
                            "linear-gradient(to right, " + realAlpha + ", " + realHex + ")");
                    }
                }

                displayColor = realColor.toString(format);
            }

            // Update the text entry input as it changes happen
            if (opts.showInput) {
                textInput.val(displayColor);
            }

            if (opts.showPalette) {
                drawPalette();
            }

            drawInitial();
        }

        function updateHelperLocations() {
            var s = currentSaturation;
            var v = currentValue;

            if(allowEmpty && isEmpty) {
                //if selected color is empty, hide the helpers
                alphaSlideHelper.hide();
                slideHelper.hide();
                dragHelper.hide();
            }
            else {
                //make sure helpers are visible
                alphaSlideHelper.show();
                slideHelper.show();
                dragHelper.show();

                // Where to show the little circle in that displays your current selected color
                var dragX = s * dragWidth;
                var dragY = dragHeight - (v * dragHeight);
                dragX = Math.max(
                    -dragHelperHeight,
                    Math.min(dragWidth - dragHelperHeight, dragX - dragHelperHeight)
                );
                dragY = Math.max(
                    -dragHelperHeight,
                    Math.min(dragHeight - dragHelperHeight, dragY - dragHelperHeight)
                );
                dragHelper.css({
                    "top": dragY + "px",
                    "left": dragX + "px"
                });

                var alphaX = currentAlpha * alphaWidth;
                alphaSlideHelper.css({
                    "left": (alphaX - (alphaSlideHelperWidth / 2)) + "px"
                });

                // Where to show the bar that displays your current selected hue
                var slideY = (currentHue) * slideHeight;
                slideHelper.css({
                    "top": (slideY - slideHelperHeight) + "px"
                });
            }
        }

        function updateOriginalInput(fireCallback) {
            var color = get(),
                displayColor = '',
                hasChanged = !tinycolor.equals(color, colorOnShow);

            if (color) {
                displayColor = color.toString(currentPreferredFormat);
                // Update the selection palette with the current color
                addColorToSelectionPalette(color);
            }

            if (isInput) {
                boundElement.val(displayColor);
            }

            colorOnShow = color;

            if (fireCallback && hasChanged) {
                callbacks.change(color);
                boundElement.trigger('change', [ color ]);
            }
        }

        function reflow() {
            dragWidth = dragger.width();
            dragHeight = dragger.height();
            dragHelperHeight = dragHelper.height();
            slideWidth = slider.width();
            slideHeight = slider.height();
            slideHelperHeight = slideHelper.height();
            alphaWidth = alphaSlider.width();
            alphaSlideHelperWidth = alphaSlideHelper.width();

            if (!flat) {
                container.css("position", "absolute");
                container.offset(getOffset(container, offsetElement));
            }

            updateHelperLocations();

            if (opts.showPalette) {
                drawPalette();
            }

            boundElement.trigger('reflow.spectrum');
        }

        function destroy() {
            boundElement.show();
            offsetElement.unbind("click.spectrum touchstart.spectrum");
            container.remove();
            replacer.remove();
            spectrums[spect.id] = null;
        }

        function option(optionName, optionValue) {
            if (optionName === undefined) {
                return $.extend({}, opts);
            }
            if (optionValue === undefined) {
                return opts[optionName];
            }

            opts[optionName] = optionValue;
            applyOptions();
        }

        function enable() {
            disabled = false;
            boundElement.attr("disabled", false);
            offsetElement.removeClass("sp-disabled");
        }

        function disable() {
            hide();
            disabled = true;
            boundElement.attr("disabled", true);
            offsetElement.addClass("sp-disabled");
        }

        initialize();

        var spect = {
            show: show,
            hide: hide,
            toggle: toggle,
            reflow: reflow,
            option: option,
            enable: enable,
            disable: disable,
            set: function (c) {
                set(c);
                updateOriginalInput();
            },
            get: get,
            destroy: destroy,
            container: container
        };

        spect.id = spectrums.push(spect) - 1;

        return spect;
    }

    /**
     * checkOffset - get the offset below/above and left/right element depending on screen position
     * Thanks https://github.com/jquery/jquery-ui/blob/master/ui/jquery.ui.datepicker.js
     */
    function getOffset(picker, input) {
        var extraY = 0;
        var dpWidth = picker.outerWidth();
        var dpHeight = picker.outerHeight();
        var inputHeight = input.outerHeight();
        var doc = picker[0].ownerDocument;
        var docElem = doc.documentElement;
        var viewWidth = docElem.clientWidth + $(doc).scrollLeft();
        var viewHeight = docElem.clientHeight + $(doc).scrollTop();
        var offset = input.offset();
        offset.top += inputHeight;

        offset.left -=
            Math.min(offset.left, (offset.left + dpWidth > viewWidth && viewWidth > dpWidth) ?
                Math.abs(offset.left + dpWidth - viewWidth) : 0);

        offset.top -=
            Math.min(offset.top, ((offset.top + dpHeight > viewHeight && viewHeight > dpHeight) ?
                Math.abs(dpHeight + inputHeight - extraY) : extraY));

        return offset;
    }

    /**
     * noop - do nothing
     */
    function noop() {

    }

    /**
     * stopPropagation - makes the code only doing this a little easier to read in line
     */
    function stopPropagation(e) {
        e.stopPropagation();
    }

    /**
     * Create a function bound to a given object
     * Thanks to underscore.js
     */
    function bind(func, obj) {
        var slice = Array.prototype.slice;
        var args = slice.call(arguments, 2);
        return function () {
            return func.apply(obj, args.concat(slice.call(arguments)));
        };
    }

    /**
     * Lightweight drag helper.  Handles containment within the element, so that
     * when dragging, the x is within [0,element.width] and y is within [0,element.height]
     */
    function draggable(element, onmove, onstart, onstop) {
        onmove = onmove || function () { };
        onstart = onstart || function () { };
        onstop = onstop || function () { };
        var doc = element.ownerDocument || document;
        var dragging = false;
        var offset = {};
        var maxHeight = 0;
        var maxWidth = 0;
        var hasTouch = ('ontouchstart' in window);

        var duringDragEvents = {};
        duringDragEvents["selectstart"] = prevent;
        duringDragEvents["dragstart"] = prevent;
        duringDragEvents["touchmove mousemove"] = move;
        duringDragEvents["touchend mouseup"] = stop;

        function prevent(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.returnValue = false;
        }

        function move(e) {
            if (dragging) {
                // Mouseup happened outside of window
                if (IE && document.documentMode < 9 && !e.button) {
                    return stop();
                }

                var touches = e.originalEvent.touches;
                var pageX = touches ? touches[0].pageX : e.pageX;
                var pageY = touches ? touches[0].pageY : e.pageY;

                var dragX = Math.max(0, Math.min(pageX - offset.left, maxWidth));
                var dragY = Math.max(0, Math.min(pageY - offset.top, maxHeight));

                if (hasTouch) {
                    // Stop scrolling in iOS
                    prevent(e);
                }

                onmove.apply(element, [dragX, dragY, e]);
            }
        }

        function start(e) {
            var rightclick = (e.which) ? (e.which == 3) : (e.button == 2);
            var touches = e.originalEvent.touches;

            if (!rightclick && !dragging) {
                if (onstart.apply(element, arguments) !== false) {
                    dragging = true;
                    maxHeight = $(element).height();
                    maxWidth = $(element).width();
                    offset = $(element).offset();

                    $(doc).bind(duringDragEvents);
                    $(doc.body).addClass("sp-dragging");

                    if (!hasTouch) {
                        move(e);
                    }

                    prevent(e);
                }
            }
        }

        function stop() {
            if (dragging) {
                $(doc).unbind(duringDragEvents);
                $(doc.body).removeClass("sp-dragging");
                onstop.apply(element, arguments);
            }
            dragging = false;
        }

        $(element).bind("touchstart mousedown", start);
    }

    function throttle(func, wait, debounce) {
        var timeout;
        return function () {
            var context = this, args = arguments;
            var throttler = function () {
                timeout = null;
                func.apply(context, args);
            };
            if (debounce) clearTimeout(timeout);
            if (debounce || !timeout) timeout = setTimeout(throttler, wait);
        };
    }

    function log(){/* jshint -W021 */if(window.console){if(Function.prototype.bind)log=Function.prototype.bind.call(console.log,console);else log=function(){Function.prototype.apply.call(console.log,console,arguments);};log.apply(this,arguments);}}

    /**
     * Define a jQuery plugin
     */
    var dataID = "spectrum.id";
    $.fn.spectrum = function (opts, extra) {

        if (typeof opts == "string") {

            var returnValue = this;
            var args = Array.prototype.slice.call( arguments, 1 );

            this.each(function () {
                var spect = spectrums[$(this).data(dataID)];
                if (spect) {
                    var method = spect[opts];
                    if (!method) {
                        throw new Error( "Spectrum: no such method: '" + opts + "'" );
                    }

                    if (opts == "get") {
                        returnValue = spect.get();
                    }
                    else if (opts == "container") {
                        returnValue = spect.container;
                    }
                    else if (opts == "option") {
                        returnValue = spect.option.apply(spect, args);
                    }
                    else if (opts == "destroy") {
                        spect.destroy();
                        $(this).removeData(dataID);
                    }
                    else {
                        method.apply(spect, args);
                    }
                }
            });

            return returnValue;
        }

        // Initializing a new instance of spectrum
        return this.spectrum("destroy").each(function () {
            var options = $.extend({}, opts, $(this).data());
            var spect = spectrum(this, options);
            $(this).data(dataID, spect.id);
        });
    };

    $.fn.spectrum.load = true;
    $.fn.spectrum.loadOpts = {};
    $.fn.spectrum.draggable = draggable;
    $.fn.spectrum.defaults = defaultOpts;

    $.spectrum = { };
    $.spectrum.localization = { };
    $.spectrum.palettes = { };

    $.fn.spectrum.processNativeColorInputs = function () {
        if (!inputTypeColorSupport) {
            $("input[type=color]").spectrum({
                preferredFormat: "hex6"
            });
        }
    };

    // TinyColor v0.9.17
    // https://github.com/bgrins/TinyColor
    // 2013-08-10, Brian Grinstead, MIT License

    (function() {

        var trimLeft = /^[\s,#]+/,
            trimRight = /\s+$/,
            tinyCounter = 0,
            math = Math,
            mathRound = math.round,
            mathMin = math.min,
            mathMax = math.max,
            mathRandom = math.random;

        function tinycolor (color, opts) {

            color = (color) ? color : '';
            opts = opts || { };

            // If input is already a tinycolor, return itself
            if (typeof color == "object" && color.hasOwnProperty("_tc_id")) {
                return color;
            }

            var rgb = inputToRGB(color);
            var r = rgb.r,
                g = rgb.g,
                b = rgb.b,
                a = rgb.a,
                roundA = mathRound(100*a) / 100,
                format = opts.format || rgb.format;

            // Don't let the range of [0,255] come back in [0,1].
            // Potentially lose a little bit of precision here, but will fix issues where
            // .5 gets interpreted as half of the total, instead of half of 1
            // If it was supposed to be 128, this was already taken care of by `inputToRgb`
            if (r < 1) { r = mathRound(r); }
            if (g < 1) { g = mathRound(g); }
            if (b < 1) { b = mathRound(b); }

            return {
                ok: rgb.ok,
                format: format,
                _tc_id: tinyCounter++,
                alpha: a,
                getAlpha: function() {
                    return a;
                },
                get_is_theme_color : function(){ //Todo Sam: remove this function from here and place it in a relevant place
                    //return false; // Let's not deal with this right now...
                    var theme_color_index = Upfront.Views.Theme_Colors.colors.is_theme_color(this);
                    if( theme_color_index !== false ){
                        this.is_theme_color = true;
                        theme_color_index -= 1; // This is because the method returns result incremented by 1 to get true-ish value
                        this.theme_color = "#ufc" + theme_color_index;
                        this.theme_color_code = Upfront.Util.colors.convert_string_ufc_to_color(this.theme_color);
                    }else{
                        this.is_theme_color = false;
                    }
                    return theme_color_index;
                },
                setAlpha: function(value) {
                    a = boundAlpha(value);
                    roundA = mathRound(100*a) / 100;
                },
                toHsv: function() {
                    var hsv = rgbToHsv(r, g, b);
                    return { h: hsv.h * 360, s: hsv.s, v: hsv.v, a: a };
                },
                toHsvString: function() {
                    var hsv = rgbToHsv(r, g, b);
                    var h = mathRound(hsv.h * 360), s = mathRound(hsv.s * 100), v = mathRound(hsv.v * 100);
                    return (a == 1) ?
                    "hsv("  + h + ", " + s + "%, " + v + "%)" :
                    "hsva(" + h + ", " + s + "%, " + v + "%, "+ roundA + ")";
                },
                toHsl: function() {
                    var hsl = rgbToHsl(r, g, b);
                    return { h: hsl.h * 360, s: hsl.s, l: hsl.l, a: a };
                },
                toHslString: function() {
                    var hsl = rgbToHsl(r, g, b);
                    var h = mathRound(hsl.h * 360), s = mathRound(hsl.s * 100), l = mathRound(hsl.l * 100);
                    return (a == 1) ?
                    "hsl("  + h + ", " + s + "%, " + l + "%)" :
                    "hsla(" + h + ", " + s + "%, " + l + "%, "+ roundA + ")";
                },
                toHex: function(allow3Char) {
                    return rgbToHex(r, g, b, allow3Char);
                },
                toHexString: function(allow3Char) {
                    return '#' + this.toHex(allow3Char);
                },
                toHex8: function() {
                    return rgbaToHex(r, g, b, a);
                },
                toHex8String: function() {
                    return '#' + this.toHex8();
                },
                toRgb: function() {
                    return { r: mathRound(r), g: mathRound(g), b: mathRound(b), a: a };
                },
                toRgbString: function() {
                    return (a == 1) ?
                    "rgb("  + mathRound(r) + ", " + mathRound(g) + ", " + mathRound(b) + ")" :
                    "rgba(" + mathRound(r) + ", " + mathRound(g) + ", " + mathRound(b) + ", " + roundA + ")";
                },
                toPercentageRgb: function() {
                    return { r: mathRound(bound01(r, 255) * 100) + "%", g: mathRound(bound01(g, 255) * 100) + "%", b: mathRound(bound01(b, 255) * 100) + "%", a: a };
                },
                toPercentageRgbString: function() {
                    return (a == 1) ?
                    "rgb("  + mathRound(bound01(r, 255) * 100) + "%, " + mathRound(bound01(g, 255) * 100) + "%, " + mathRound(bound01(b, 255) * 100) + "%)" :
                    "rgba(" + mathRound(bound01(r, 255) * 100) + "%, " + mathRound(bound01(g, 255) * 100) + "%, " + mathRound(bound01(b, 255) * 100) + "%, " + roundA + ")";
                },
                toName: function() {
                    if (a === 0) {
                        return "transparent";
                    }

                    return hexNames[rgbToHex(r, g, b, true)] || false;
                },
                toFilter: function(secondColor) {
                    var hex8String = '#' + rgbaToHex(r, g, b, a);
                    var secondHex8String = hex8String;
                    var gradientType = opts && opts.gradientType ? "GradientType = 1, " : "";

                    if (secondColor) {
                        var s = tinycolor(secondColor);
                        secondHex8String = s.toHex8String();
                    }

                    return "progid:DXImageTransform.Microsoft.gradient("+gradientType+"startColorstr="+hex8String+",endColorstr="+secondHex8String+")";
                },
                toString: function(format) {
                    var formatSet = !!format;
                    format = format || this.format;

                    var formattedString = false;
                    var hasAlphaAndFormatNotSet = !formatSet && a < 1 && a > 0;
                    var formatWithAlpha = hasAlphaAndFormatNotSet && (format === "hex" || format === "hex6" || format === "hex3" || format === "name");

                    if (format === "rgb") {
                        formattedString = this.toRgbString();
                    }
                    if (format === "prgb") {
                        formattedString = this.toPercentageRgbString();
                    }
                    if (format === "hex" || format === "hex6") {
                        formattedString = this.toHexString();
                    }
                    if (format === "hex3") {
                        formattedString = this.toHexString(true);
                    }
                    if (format === "hex8") {
                        formattedString = this.toHex8String();
                    }
                    if (format === "name") {
                        formattedString = this.toName();
                    }
                    if (format === "hsl") {
                        formattedString = this.toHslString();
                    }
                    if (format === "hsv") {
                        formattedString = this.toHsvString();
                    }

                    if (formatWithAlpha) {
                        return this.toRgbString();
                    }

                    return formattedString || this.toHexString();
                }
            };
        }

        // If input is an object, force 1 into "1.0" to handle ratios properly
        // String input requires "1.0" as input, so 1 will be treated as 1
        tinycolor.fromRatio = function(color, opts) {
            if (typeof color == "object") {
                var newColor = {};
                for (var i in color) {
                    if (color.hasOwnProperty(i)) {
                        if (i === "a") {
                            newColor[i] = color[i];
                        }
                        else {
                            newColor[i] = convertToPercentage(color[i]);
                        }
                    }
                }
                color = newColor;
            }

            return tinycolor(color, opts);
        };

        // Given a string or object, convert that input to RGB
        // Possible string inputs:
        //
        //     "red"
        //     "#f00" or "f00"
        //     "#ff0000" or "ff0000"
        //     "#ff000000" or "ff000000"
        //     "rgb 255 0 0" or "rgb (255, 0, 0)"
        //     "rgb 1.0 0 0" or "rgb (1, 0, 0)"
        //     "rgba (255, 0, 0, 1)" or "rgba 255, 0, 0, 1"
        //     "rgba (1.0, 0, 0, 1)" or "rgba 1.0, 0, 0, 1"
        //     "hsl(0, 100%, 50%)" or "hsl 0 100% 50%"
        //     "hsla(0, 100%, 50%, 1)" or "hsla 0 100% 50%, 1"
        //     "hsv(0, 100%, 100%)" or "hsv 0 100% 100%"
        //
        function inputToRGB(color) {

            var rgb = { r: 0, g: 0, b: 0 };
            var a = 1;
            var ok = false;
            var format = false;

            if (typeof color == "string") {
                color = stringInputToObject(color);
            }

            if (typeof color == "object") {
                if (color.hasOwnProperty("r") && color.hasOwnProperty("g") && color.hasOwnProperty("b")) {
                    rgb = rgbToRgb(color.r, color.g, color.b);
                    ok = true;
                    format = String(color.r).substr(-1) === "%" ? "prgb" : "rgb";
                }
                else if (color.hasOwnProperty("h") && color.hasOwnProperty("s") && color.hasOwnProperty("v")) {
                    color.s = convertToPercentage(color.s);
                    color.v = convertToPercentage(color.v);
                    rgb = hsvToRgb(color.h, color.s, color.v);
                    ok = true;
                    format = "hsv";
                }
                else if (color.hasOwnProperty("h") && color.hasOwnProperty("s") && color.hasOwnProperty("l")) {
                    color.s = convertToPercentage(color.s);
                    color.l = convertToPercentage(color.l);
                    rgb = hslToRgb(color.h, color.s, color.l);
                    ok = true;
                    format = "hsl";
                }

                if (color.hasOwnProperty("a")) {
                    a = color.a;
                }
            }

            a = boundAlpha(a);

            return {
                ok: ok,
                format: color.format || format,
                r: mathMin(255, mathMax(rgb.r, 0)),
                g: mathMin(255, mathMax(rgb.g, 0)),
                b: mathMin(255, mathMax(rgb.b, 0)),
                a: a
            };
        }


        // Conversion Functions
        // --------------------

        // `rgbToHsl`, `rgbToHsv`, `hslToRgb`, `hsvToRgb` modified from:
        // <http://mjijackson.com/2008/02/rgb-to-hsl-and-rgb-to-hsv-color-model-conversion-algorithms-in-javascript>

        // `rgbToRgb`
        // Handle bounds / percentage checking to conform to CSS color spec
        // <http://www.w3.org/TR/css3-color/>
        // *Assumes:* r, g, b in [0, 255] or [0, 1]
        // *Returns:* { r, g, b } in [0, 255]
        function rgbToRgb(r, g, b){
            return {
                r: bound01(r, 255) * 255,
                g: bound01(g, 255) * 255,
                b: bound01(b, 255) * 255
            };
        }

        // `rgbToHsl`
        // Converts an RGB color value to HSL.
        // *Assumes:* r, g, and b are contained in [0, 255] or [0, 1]
        // *Returns:* { h, s, l } in [0,1]
        function rgbToHsl(r, g, b) {

            r = bound01(r, 255);
            g = bound01(g, 255);
            b = bound01(b, 255);

            var max = mathMax(r, g, b), min = mathMin(r, g, b);
            var h, s, l = (max + min) / 2;

            if(max == min) {
                h = s = 0; // achromatic
            }
            else {
                var d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch(max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }

                h /= 6;
            }

            return { h: h, s: s, l: l };
        }

        // `hslToRgb`
        // Converts an HSL color value to RGB.
        // *Assumes:* h is contained in [0, 1] or [0, 360] and s and l are contained [0, 1] or [0, 100]
        // *Returns:* { r, g, b } in the set [0, 255]
        function hslToRgb(h, s, l) {
            var r, g, b;

            h = bound01(h, 360);
            s = bound01(s, 100);
            l = bound01(l, 100);

            function hue2rgb(p, q, t) {
                if(t < 0) t += 1;
                if(t > 1) t -= 1;
                if(t < 1/6) return p + (q - p) * 6 * t;
                if(t < 1/2) return q;
                if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                return p;
            }

            if(s === 0) {
                r = g = b = l; // achromatic
            }
            else {
                var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                var p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }

            return { r: r * 255, g: g * 255, b: b * 255 };
        }

        // `rgbToHsv`
        // Converts an RGB color value to HSV
        // *Assumes:* r, g, and b are contained in the set [0, 255] or [0, 1]
        // *Returns:* { h, s, v } in [0,1]
        function rgbToHsv(r, g, b) {

            r = bound01(r, 255);
            g = bound01(g, 255);
            b = bound01(b, 255);

            var max = mathMax(r, g, b), min = mathMin(r, g, b);
            var h, s, v = max;

            var d = max - min;
            s = max === 0 ? 0 : d / max;

            if(max == min) {
                h = 0; // achromatic
            }
            else {
                switch(max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: h, s: s, v: v };
        }

        // `hsvToRgb`
        // Converts an HSV color value to RGB.
        // *Assumes:* h is contained in [0, 1] or [0, 360] and s and v are contained in [0, 1] or [0, 100]
        // *Returns:* { r, g, b } in the set [0, 255]
        function hsvToRgb(h, s, v) {

            h = bound01(h, 360) * 6;
            s = bound01(s, 100);
            v = bound01(v, 100);

            var i = math.floor(h),
                f = h - i,
                p = v * (1 - s),
                q = v * (1 - f * s),
                t = v * (1 - (1 - f) * s),
                mod = i % 6,
                r = [v, q, p, p, t, v][mod],
                g = [t, v, v, q, p, p][mod],
                b = [p, p, t, v, v, q][mod];

            return { r: r * 255, g: g * 255, b: b * 255 };
        }

        // `rgbToHex`
        // Converts an RGB color to hex
        // Assumes r, g, and b are contained in the set [0, 255]
        // Returns a 3 or 6 character hex
        function rgbToHex(r, g, b, allow3Char) {

            var hex = [
                pad2(mathRound(r).toString(16)),
                pad2(mathRound(g).toString(16)),
                pad2(mathRound(b).toString(16))
            ];

            // Return a 3 character hex if possible
            if (allow3Char && hex[0].charAt(0) == hex[0].charAt(1) && hex[1].charAt(0) == hex[1].charAt(1) && hex[2].charAt(0) == hex[2].charAt(1)) {
                return hex[0].charAt(0) + hex[1].charAt(0) + hex[2].charAt(0);
            }

            return hex.join("");
        }
        // `rgbaToHex`
        // Converts an RGBA color plus alpha transparency to hex
        // Assumes r, g, b and a are contained in the set [0, 255]
        // Returns an 8 character hex
        function rgbaToHex(r, g, b, a) {

            var hex = [
                pad2(convertDecimalToHex(a)),
                pad2(mathRound(r).toString(16)),
                pad2(mathRound(g).toString(16)),
                pad2(mathRound(b).toString(16))
            ];

            return hex.join("");
        }

        // `equals`
        // Can be called with any tinycolor input
        tinycolor.equals = function (color1, color2) {
            if (!color1 || !color2) { return false; }
            return tinycolor(color1).toRgbString() == tinycolor(color2).toRgbString();
        };
        tinycolor.random = function() {
            return tinycolor.fromRatio({
                r: mathRandom(),
                g: mathRandom(),
                b: mathRandom()
            });
        };


        // Modification Functions
        // ----------------------
        // Thanks to less.js for some of the basics here
        // <https://github.com/cloudhead/less.js/blob/master/lib/less/functions.js>

        tinycolor.desaturate = function (color, amount) {
            amount = (amount === 0) ? 0 : (amount || 10);
            var hsl = tinycolor(color).toHsl();
            hsl.s -= amount / 100;
            hsl.s = clamp01(hsl.s);
            return tinycolor(hsl);
        };
        tinycolor.saturate = function (color, amount) {
            amount = (amount === 0) ? 0 : (amount || 10);
            var hsl = tinycolor(color).toHsl();
            hsl.s += amount / 100;
            hsl.s = clamp01(hsl.s);
            return tinycolor(hsl);
        };
        tinycolor.greyscale = function(color) {
            return tinycolor.desaturate(color, 100);
        };
        tinycolor.lighten = function(color, amount) {
            amount = (amount === 0) ? 0 : (amount || 10);
            var hsl = tinycolor(color).toHsl();
            hsl.l += amount / 100;
            hsl.l = clamp01(hsl.l);
            return tinycolor(hsl);
        };
        tinycolor.darken = function (color, amount) {
            amount = (amount === 0) ? 0 : (amount || 10);
            var hsl = tinycolor(color).toHsl();
            hsl.l -= amount / 100;
            hsl.l = clamp01(hsl.l);
            return tinycolor(hsl);
        };
        tinycolor.complement = function(color) {
            var hsl = tinycolor(color).toHsl();
            hsl.h = (hsl.h + 180) % 360;
            return tinycolor(hsl);
        };


        // Combination Functions
        // ---------------------
        // Thanks to jQuery xColor for some of the ideas behind these
        // <https://github.com/infusion/jQuery-xcolor/blob/master/jquery.xcolor.js>

        tinycolor.triad = function(color) {
            var hsl = tinycolor(color).toHsl();
            var h = hsl.h;
            return [
                tinycolor(color),
                tinycolor({ h: (h + 120) % 360, s: hsl.s, l: hsl.l }),
                tinycolor({ h: (h + 240) % 360, s: hsl.s, l: hsl.l })
            ];
        };
        tinycolor.tetrad = function(color) {
            var hsl = tinycolor(color).toHsl();
            var h = hsl.h;
            return [
                tinycolor(color),
                tinycolor({ h: (h + 90) % 360, s: hsl.s, l: hsl.l }),
                tinycolor({ h: (h + 180) % 360, s: hsl.s, l: hsl.l }),
                tinycolor({ h: (h + 270) % 360, s: hsl.s, l: hsl.l })
            ];
        };
        tinycolor.splitcomplement = function(color) {
            var hsl = tinycolor(color).toHsl();
            var h = hsl.h;
            return [
                tinycolor(color),
                tinycolor({ h: (h + 72) % 360, s: hsl.s, l: hsl.l}),
                tinycolor({ h: (h + 216) % 360, s: hsl.s, l: hsl.l})
            ];
        };
        tinycolor.analogous = function(color, results, slices) {
            results = results || 6;
            slices = slices || 30;

            var hsl = tinycolor(color).toHsl();
            var part = 360 / slices;
            var ret = [tinycolor(color)];

            for (hsl.h = ((hsl.h - (part * results >> 1)) + 720) % 360; --results; ) {
                hsl.h = (hsl.h + part) % 360;
                ret.push(tinycolor(hsl));
            }
            return ret;
        };
        tinycolor.monochromatic = function(color, results) {
            results = results || 6;
            var hsv = tinycolor(color).toHsv();
            var h = hsv.h, s = hsv.s, v = hsv.v;
            var ret = [];
            var modification = 1 / results;

            while (results--) {
                ret.push(tinycolor({ h: h, s: s, v: v}));
                v = (v + modification) % 1;
            }

            return ret;
        };


        // Readability Functions
        // ---------------------
        // <http://www.w3.org/TR/AERT#color-contrast>

        // `readability`
        // Analyze the 2 colors and returns an object with the following properties:
        //    `brightness`: difference in brightness between the two colors
        //    `color`: difference in color/hue between the two colors
        tinycolor.readability = function(color1, color2) {
            var a = tinycolor(color1).toRgb();
            var b = tinycolor(color2).toRgb();
            var brightnessA = (a.r * 299 + a.g * 587 + a.b * 114) / 1000;
            var brightnessB = (b.r * 299 + b.g * 587 + b.b * 114) / 1000;
            var colorDiff = (
            Math.max(a.r, b.r) - Math.min(a.r, b.r) +
            Math.max(a.g, b.g) - Math.min(a.g, b.g) +
            Math.max(a.b, b.b) - Math.min(a.b, b.b)
            );

            return {
                brightness: Math.abs(brightnessA - brightnessB),
                color: colorDiff
            };
        };

        // `readable`
        // http://www.w3.org/TR/AERT#color-contrast
        // Ensure that foreground and background color combinations provide sufficient contrast.
        // *Example*
        //    tinycolor.readable("#000", "#111") => false
        tinycolor.readable = function(color1, color2) {
            var readability = tinycolor.readability(color1, color2);
            return readability.brightness > 125 && readability.color > 500;
        };

        // `mostReadable`
        // Given a base color and a list of possible foreground or background
        // colors for that base, returns the most readable color.
        // *Example*
        //    tinycolor.mostReadable("#123", ["#fff", "#000"]) => "#000"
        tinycolor.mostReadable = function(baseColor, colorList) {
            var bestColor = null;
            var bestScore = 0;
            var bestIsReadable = false;
            for (var i=0; i < colorList.length; i++) {

                // We normalize both around the "acceptable" breaking point,
                // but rank brightness constrast higher than hue.

                var readability = tinycolor.readability(baseColor, colorList[i]);
                var readable = readability.brightness > 125 && readability.color > 500;
                var score = 3 * (readability.brightness / 125) + (readability.color / 500);

                if ((readable && ! bestIsReadable) ||
                    (readable && bestIsReadable && score > bestScore) ||
                    ((! readable) && (! bestIsReadable) && score > bestScore)) {
                    bestIsReadable = readable;
                    bestScore = score;
                    bestColor = tinycolor(colorList[i]);
                }
            }
            return bestColor;
        };


        // Big List of Colors
        // ------------------
        // <http://www.w3.org/TR/css3-color/#svg-color>
        var names = tinycolor.names = {
            aliceblue: "f0f8ff",
            antiquewhite: "faebd7",
            aqua: "0ff",
            aquamarine: "7fffd4",
            azure: "f0ffff",
            beige: "f5f5dc",
            bisque: "ffe4c4",
            black: "000",
            blanchedalmond: "ffebcd",
            blue: "00f",
            blueviolet: "8a2be2",
            brown: "a52a2a",
            burlywood: "deb887",
            burntsienna: "ea7e5d",
            cadetblue: "5f9ea0",
            chartreuse: "7fff00",
            chocolate: "d2691e",
            coral: "ff7f50",
            cornflowerblue: "6495ed",
            cornsilk: "fff8dc",
            crimson: "dc143c",
            cyan: "0ff",
            darkblue: "00008b",
            darkcyan: "008b8b",
            darkgoldenrod: "b8860b",
            darkgray: "a9a9a9",
            darkgreen: "006400",
            darkgrey: "a9a9a9",
            darkkhaki: "bdb76b",
            darkmagenta: "8b008b",
            darkolivegreen: "556b2f",
            darkorange: "ff8c00",
            darkorchid: "9932cc",
            darkred: "8b0000",
            darksalmon: "e9967a",
            darkseagreen: "8fbc8f",
            darkslateblue: "483d8b",
            darkslategray: "2f4f4f",
            darkslategrey: "2f4f4f",
            darkturquoise: "00ced1",
            darkviolet: "9400d3",
            deeppink: "ff1493",
            deepskyblue: "00bfff",
            dimgray: "696969",
            dimgrey: "696969",
            dodgerblue: "1e90ff",
            firebrick: "b22222",
            floralwhite: "fffaf0",
            forestgreen: "228b22",
            fuchsia: "f0f",
            gainsboro: "dcdcdc",
            ghostwhite: "f8f8ff",
            gold: "ffd700",
            goldenrod: "daa520",
            gray: "808080",
            green: "008000",
            greenyellow: "adff2f",
            grey: "808080",
            honeydew: "f0fff0",
            hotpink: "ff69b4",
            indianred: "cd5c5c",
            indigo: "4b0082",
            ivory: "fffff0",
            khaki: "f0e68c",
            lavender: "e6e6fa",
            lavenderblush: "fff0f5",
            lawngreen: "7cfc00",
            lemonchiffon: "fffacd",
            lightblue: "add8e6",
            lightcoral: "f08080",
            lightcyan: "e0ffff",
            lightgoldenrodyellow: "fafad2",
            lightgray: "d3d3d3",
            lightgreen: "90ee90",
            lightgrey: "d3d3d3",
            lightpink: "ffb6c1",
            lightsalmon: "ffa07a",
            lightseagreen: "20b2aa",
            lightskyblue: "87cefa",
            lightslategray: "789",
            lightslategrey: "789",
            lightsteelblue: "b0c4de",
            lightyellow: "ffffe0",
            lime: "0f0",
            limegreen: "32cd32",
            linen: "faf0e6",
            magenta: "f0f",
            maroon: "800000",
            mediumaquamarine: "66cdaa",
            mediumblue: "0000cd",
            mediumorchid: "ba55d3",
            mediumpurple: "9370db",
            mediumseagreen: "3cb371",
            mediumslateblue: "7b68ee",
            mediumspringgreen: "00fa9a",
            mediumturquoise: "48d1cc",
            mediumvioletred: "c71585",
            midnightblue: "191970",
            mintcream: "f5fffa",
            mistyrose: "ffe4e1",
            moccasin: "ffe4b5",
            navajowhite: "ffdead",
            navy: "000080",
            oldlace: "fdf5e6",
            olive: "808000",
            olivedrab: "6b8e23",
            orange: "ffa500",
            orangered: "ff4500",
            orchid: "da70d6",
            palegoldenrod: "eee8aa",
            palegreen: "98fb98",
            paleturquoise: "afeeee",
            palevioletred: "db7093",
            papayawhip: "ffefd5",
            peachpuff: "ffdab9",
            peru: "cd853f",
            pink: "ffc0cb",
            plum: "dda0dd",
            powderblue: "b0e0e6",
            purple: "800080",
            red: "f00",
            rosybrown: "bc8f8f",
            royalblue: "4169e1",
            saddlebrown: "8b4513",
            salmon: "fa8072",
            sandybrown: "f4a460",
            seagreen: "2e8b57",
            seashell: "fff5ee",
            sienna: "a0522d",
            silver: "c0c0c0",
            skyblue: "87ceeb",
            slateblue: "6a5acd",
            slategray: "708090",
            slategrey: "708090",
            snow: "fffafa",
            springgreen: "00ff7f",
            steelblue: "4682b4",
            tan: "d2b48c",
            teal: "008080",
            thistle: "d8bfd8",
            tomato: "ff6347",
            turquoise: "40e0d0",
            violet: "ee82ee",
            wheat: "f5deb3",
            white: "fff",
            whitesmoke: "f5f5f5",
            yellow: "ff0",
            yellowgreen: "9acd32"
        };

        // Make it easy to access colors via `hexNames[hex]`
        var hexNames = tinycolor.hexNames = flip(names);


        // Utilities
        // ---------

        // `{ 'name1': 'val1' }` becomes `{ 'val1': 'name1' }`
        function flip(o) {
            var flipped = { };
            for (var i in o) {
                if (o.hasOwnProperty(i)) {
                    flipped[o[i]] = i;
                }
            }
            return flipped;
        }

        // Return a valid alpha value [0,1] with all invalid values being set to 1
        function boundAlpha(a) {
            a = parseFloat(a);

            if (isNaN(a) || a < 0 || a > 1) {
                a = 1;
            }

            return a;
        }

        // Take input from [0, n] and return it as [0, 1]
        function bound01(n, max) {
            if (isOnePointZero(n)) { n = "100%"; }

            var processPercent = isPercentage(n);
            n = mathMin(max, mathMax(0, parseFloat(n)));

            // Automatically convert percentage into number
            if (processPercent) {
                n = parseInt(n * max, 10) / 100;
            }

            // Handle floating point rounding errors
            if ((math.abs(n - max) < 0.000001)) {
                return 1;
            }

            // Convert into [0, 1] range if it isn't already
            return (n % max) / parseFloat(max);
        }

        // Force a number between 0 and 1
        function clamp01(val) {
            return mathMin(1, mathMax(0, val));
        }

        // Parse a base-16 hex value into a base-10 integer
        function parseIntFromHex(val) {
            return parseInt(val, 16);
        }

        // Need to handle 1.0 as 100%, since once it is a number, there is no difference between it and 1
        // <http://stackoverflow.com/questions/7422072/javascript-how-to-detect-number-as-a-decimal-including-1-0>
        function isOnePointZero(n) {
            return typeof n == "string" && n.indexOf('.') != -1 && parseFloat(n) === 1;
        }

        // Check to see if string passed in is a percentage
        function isPercentage(n) {
            return typeof n === "string" && n.indexOf('%') != -1;
        }

        // Force a hex value to have 2 characters
        function pad2(c) {
            return c.length == 1 ? '0' + c : '' + c;
        }

        // Replace a decimal with it's percentage value
        function convertToPercentage(n) {
            if (n <= 1) {
                n = (n * 100) + "%";
            }

            return n;
        }

        // Converts a decimal to a hex value
        function convertDecimalToHex(d) {
            return Math.round(parseFloat(d) * 255).toString(16);
        }
        // Converts a hex value to a decimal
        function convertHexToDecimal(h) {
            return (parseIntFromHex(h) / 255);
        }

        var matchers = (function() {

            // <http://www.w3.org/TR/css3-values/#integers>
            var CSS_INTEGER = "[-\\+]?\\d+%?";

            // <http://www.w3.org/TR/css3-values/#number-value>
            var CSS_NUMBER = "[-\\+]?\\d*\\.\\d+%?";

            // Allow positive/negative integer/number.  Don't capture the either/or, just the entire outcome.
            var CSS_UNIT = "(?:" + CSS_NUMBER + ")|(?:" + CSS_INTEGER + ")";

            // Actual matching.
            // Parentheses and commas are optional, but not required.
            // Whitespace can take the place of commas or opening paren
            var PERMISSIVE_MATCH3 = "[\\s|\\(]+(" + CSS_UNIT + ")[,|\\s]+(" + CSS_UNIT + ")[,|\\s]+(" + CSS_UNIT + ")\\s*\\)?";
            var PERMISSIVE_MATCH4 = "[\\s|\\(]+(" + CSS_UNIT + ")[,|\\s]+(" + CSS_UNIT + ")[,|\\s]+(" + CSS_UNIT + ")[,|\\s]+(" + CSS_UNIT + ")\\s*\\)?";

            return {
                rgb: new RegExp("rgb" + PERMISSIVE_MATCH3),
                rgba: new RegExp("rgba" + PERMISSIVE_MATCH4),
                hsl: new RegExp("hsl" + PERMISSIVE_MATCH3),
                hsla: new RegExp("hsla" + PERMISSIVE_MATCH4),
                hsv: new RegExp("hsv" + PERMISSIVE_MATCH3),
                hex3: /^([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,
                hex6: /^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,
                hex8: /^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/
            };
        })();

        // `stringInputToObject`
        // Permissive string parsing.  Take in a number of formats, and output an object
        // based on detected format.  Returns `{ r, g, b }` or `{ h, s, l }` or `{ h, s, v}`
        function stringInputToObject(color) {

            color = color.replace(trimLeft,'').replace(trimRight, '').toLowerCase();
            var named = false;
            if (names[color]) {
                color = names[color];
                named = true;
            }
            else if (color == 'transparent') {
                return { r: 0, g: 0, b: 0, a: 0, format: "name" };
            }

            // Try to match string input using regular expressions.
            // Keep most of the number bounding out of this function - don't worry about [0,1] or [0,100] or [0,360]
            // Just return an object and let the conversion functions handle that.
            // This way the result will be the same whether the tinycolor is initialized with string or object.
            var match;
            if ((match = matchers.rgb.exec(color))) {
                return { r: match[1], g: match[2], b: match[3] };
            }
            if ((match = matchers.rgba.exec(color))) {
                return { r: match[1], g: match[2], b: match[3], a: match[4] };
            }
            if ((match = matchers.hsl.exec(color))) {
                return { h: match[1], s: match[2], l: match[3] };
            }
            if ((match = matchers.hsla.exec(color))) {
                return { h: match[1], s: match[2], l: match[3], a: match[4] };
            }
            if ((match = matchers.hsv.exec(color))) {
                return { h: match[1], s: match[2], v: match[3] };
            }
            if ((match = matchers.hex8.exec(color))) {
                return {
                    a: convertHexToDecimal(match[1]),
                    r: parseIntFromHex(match[2]),
                    g: parseIntFromHex(match[3]),
                    b: parseIntFromHex(match[4]),
                    format: named ? "name" : "hex8"
                };
            }
            if ((match = matchers.hex6.exec(color))) {
                return {
                    r: parseIntFromHex(match[1]),
                    g: parseIntFromHex(match[2]),
                    b: parseIntFromHex(match[3]),
                    format: named ? "name" : "hex"
                };
            }
            if ((match = matchers.hex3.exec(color))) {
                return {
                    r: parseIntFromHex(match[1] + '' + match[1]),
                    g: parseIntFromHex(match[2] + '' + match[2]),
                    b: parseIntFromHex(match[3] + '' + match[3]),
                    format: named ? "name" : "hex"
                };
            }

            return false;
        }

        // Expose tinycolor to window, does not need to run in non-browser context.
        window.tinycolor = tinycolor;

    })();


    $(function () {
        if ($.fn.spectrum.load) {
            $.fn.spectrum.processNativeColorInputs();
        }
    });

})(window, jQuery);

define("spectrum", function(){});

(function ($) {

  $.cssHooks[ "backgroundColor" ] = {

    set: function( elem, value ) {
    	if( value.indexOf("ufc") === -1 ) {
    		elem.style.backgroundColor = value;
    		return;
    	}

    	elem.style.backgroundColor = Upfront.Util.colors.get_color(value);
    	$(elem).data("ufc", value);
    	$(elem).data("ufc_rule", "backgroundColor");
    }
  };

  $.cssHooks[ "color" ] = {

    set: function( elem, value ) {
    	if( value.indexOf("ufc") === -1 ) {
    		elem.style.color = value;
    		return;
    	}

    	elem.style.color = Upfront.Util.colors.get_color(value);
    	$(elem).data("ufc", value);
    	$(elem).data("ufc_rule", "color");
    }
  };

var l10n = Upfront.Settings && Upfront.Settings.l10n
	? Upfront.Settings.l10n.global.views
	: Upfront.mainData.l10n.global.views
;

define('editor_views',[
	"chosen",
	"scripts/upfront/global-event-handlers",
	"scripts/upfront/inline-panels/inline-panels",
	"scripts/upfront/element-settings/sidebar",
	"scripts/upfront/link-panel", // If adding more arguments adjust _.rest in line 72
	"text!upfront/templates/property.html",
	"text!upfront/templates/properties.html",
	"text!upfront/templates/property_edit.html",
	"text!upfront/templates/overlay_grid.html",
	"text!upfront/templates/edit_background_area.html",
	"text!upfront/templates/sidebar_settings_lock_area.html",
	"text!upfront/templates/sidebar_settings_background.html",
	"text!upfront/templates/popup.html",
	"text!upfront/templates/region_add_panel.html",
	"text!upfront/templates/region_edit_panel.html",
	"text!upfront/templates/sidebar_settings_theme_colors.html",
	"text!upfront/templates/color_picker.html",
    'spectrum'
], function (chosen, globalEventHandlers, InlinePanelsLoader, ElementSettingsSidebar, LinkPanel) {
	var _template_files = [
		"text!upfront/templates/property.html",
		"text!upfront/templates/properties.html",
		"text!upfront/templates/property_edit.html",
		"text!upfront/templates/overlay_grid.html",
		"text!upfront/templates/edit_background_area.html",
		"text!upfront/templates/sidebar_settings_lock_area.html",
		"text!upfront/templates/sidebar_settings_background.html",
		"text!upfront/templates/popup.html",
		"text!upfront/templates/region_add_panel.html",
		"text!upfront/templates/region_edit_panel.html",
		"text!upfront/templates/sidebar_settings_theme_colors.html",
		"text!upfront/templates/color_picker.html"
	];

	// Auto-assign the template contents to internal variable
	var _template_args = _.rest(arguments, 5),
		_Upfront_Templates = {}
	;
	_(_template_files).each(function (file, idx) {
		if (file.match(/text!/)) _Upfront_Templates[file.replace(/text!upfront\/templates\//, '').replace(/\.html/, '')] = _template_args[idx];
	});

	var InlinePanels = InlinePanelsLoader;


	Upfront.Events.on('data:ready', function(){
		Upfront.data.tpls = _Upfront_Templates;
	});

	var Upfront_Scroll_Mixin = {
		stop_scroll_propagation: function ($el) {
			$el.on('DOMMouseScroll mousewheel', function(ev) {
				var $this = $(this),
					scrollTop = this.scrollTop,
					scrollHeight = this.scrollHeight,
					height = $this.outerHeight(),
					delta = ev.originalEvent.wheelDelta,
					up = delta > 0,
					scroll = scrollHeight > height;

				if ( !scroll )
					return;

				ev.stopPropagation();

				var prevent = function() {
					ev.preventDefault();
					ev.returnValue = false;
					return false;
				};

				if (!up && -delta > scrollHeight - height - scrollTop) {
					// Scrolling down, but this will take us past the bottom.
					$this.scrollTop(scrollHeight);
					return prevent();
				} else if (up && delta > scrollTop) {
					// Scrolling up, but this will take us past the top.
					$this.scrollTop(0);
			 		return prevent();
				}
			});
		}
	};

	// Stubbing interface control

	var Property = Backbone.View.extend({
		events: {
			"click .upfront-property-change": "show_edit_property_partial",
			"click .upfront-property-save": "save_property",
			"click .upfront-property-remove": "remove_property"
		},
		render: function () {
			var template = _.template(_Upfront_Templates.property, this.model.toJSON());
			this.$el.html(template);
		},

		remove_property: function () {
			this.model.destroy();
		},
		save_property: function () {
			var name = this.$("#upfront-new_property-name").val(),
				value = this.$("#upfront-new_property-value").val()
			;
			this.model.set({
				"name": name,
				"value": value
			});
			this.render();
		},
		show_edit_property_partial: function () {
			var template = _.template(_Upfront_Templates.property_edit, this.model.toJSON());
			this.$el.html(template);
		}
	});

	var Properties = Backbone.View.extend({
		events: {
			"click #add-property": "show_new_property_partial",
			"click #done-adding-property": "add_new_property",
		},
		initialize: function () {
/*
			this.model.get("properties").bind("change", this.render, this);
			this.model.get("properties").bind("add", this.render, this);
			this.model.get("properties").bind("remove", this.render, this);
			*/

			this.listenTo(this.model.get("properties"), 'change', this.render);
			this.listenTo(this.model.get("properties"), 'add', this.render);
			this.listenTo(this.model.get("properties"), 'remove', this.render);
		},
		render: function () {
			var template = _.template(_Upfront_Templates.properties, this.model.toJSON()),
				properties = this
			;
			this.$el.html(template);
			this.model.get("properties").each(function (obj) {
				var local_view = new Property({"model": obj});
				local_view.render();
				properties.$el.find("dl").append(local_view.el)
			});
		},

		show_new_property_partial: function () {
			this.$("#add-property").hide();
			this.$("#upfront-new_property").slideDown();
		},
		add_new_property: function () {
			var name = this.$("#upfront-new_property-name").val(),
				value = this.$("#upfront-new_property-value").val()
			;
			this.model.get("properties").add(new Upfront.Models.Property({
				"name": name,
				"value": value
			}));
			this.$("#upfront-new_property")
				.slideUp()
				.find("input").val('').end()
			;
			this.$("#add-property").show();
		}
	});

	var Command = Backbone.View.extend({
		"tagName": "li",
		"events": {
			"click": "on_click"
		},
		on_click: function () { this.render(); },
		add_module: function (module) {
			var region = this.model.get("regions").active_region;
			if (!region) return Upfront.Util.log("select a region");
			Upfront.Events.trigger("entity:module:before_added", module, region);
			var wrappers = this.model.get('wrappers'),
				wrapper_id = Upfront.Util.get_unique_id("wrapper"),
				wrapper = new Upfront.Models.Wrapper({
					"name": "",
					"properties": [
						{"name": "wrapper_id", "value": wrapper_id},
						{"name": "class", "value": "c24 clr"}
					]
				});
			module.set_property('wrapper_id', wrapper_id);
			wrappers.add(wrapper);
			region.get("modules").add(module);
			Upfront.Events.trigger("entity:module:added", module, region);
		}
	});

	var Command_Logo = Command.extend({
		className: "command-logo",
		render: function () {
			var url = Upfront.Settings.site_url;
			if(url[url.length - 1] != '/')
				url += '/';

			if ( Upfront.Application.get_current() != Upfront.Settings.Application.MODE.CONTENT )
				this.$el.html('<a class="upfront-logo" href="' + url + '"></a>');
			else
				this.$el.html('<a class="upfront-logo upfront-logo-small" href="' + url + '"></a>');
		},
		on_click: function () {
			/*var root = Upfront.Settings.site_url;
			root = root[root.length - 1] == '/' ? root : root + '/';

			if(window.location.origin + window.location.pathname != root)
				Upfront.Application.navigate('/' + root.replace(window.location.origin, '') + window.location.search, {trigger: true});*/
		}
	});

	var Command_Exit = Command.extend({
		className: "command-exit upfront-icon upfront-icon-exit",
		render: function () {
		},
		on_click: function () {
			// Upfront.Events.trigger("command:exit");
			var url = window.location.pathname,
				loading = new Upfront.Views.Editor.Loading({
					loading: l10n.exiting_upfront,
					done: l10n.exit_done,
					fixed: true
				})
			;

			loading.render();
			$('body').append(loading.$el);

			if (url.indexOf('/create_new/') !== -1) {
				return (window.location.href = Upfront.Settings.site_url);
			}
			if (url.indexOf('/edit/') !== -1 && _upfront_post_data && _upfront_post_data.post_id) {
				return (window.location.href = Upfront.Settings.site_url + '/?p=' + _upfront_post_data.post_id);
			}
			if (window.location.search.match(/(\?|\&)editmode/)) {
				return window.location.search = window.location.search.replace(/(\?|\&)editmode(=[^?&]+)?/, '');
			}

			window.location.reload(true);
			var tmout = setTimeout(function () {
				loading.cancel();
			}, 1000);
		}
	});


	var Command_NewPost = Command.extend({
		className: "command-new-post",
		postView: false,
		postType: 'post',
		setMode: false,
		initialize: function () {
			this.setMode = Upfront.Application.MODE.CONTENT;
		},
		render: function () {
			Upfront.Events.trigger("command:newpost:start", true);
			// this.$el.addClass('upfront-icon upfront-icon-post');
			this.$el.html(l10n.new_post);
            this.$el.prop("title", l10n.new_post);
		},
		on_click: function (e) {
			e.preventDefault();

			if(Upfront.Settings.LayoutEditor.newpostType == this.postType)
				return Upfront.Views.Editor.notify(l10n.already_creating_post.replace(/%s/, this.postType), 'warning');

			//return Upfront.Application.navigate('/create_new/post' + location.search, {trigger: true}); // DROP THIS INSANITY
			Upfront.Util
				.post({
					action: "upfront-create-post_type",
					data: _.extend({post_type: this.postType}, {})
				}).done(function (resp) {
					//Upfront.Util.log(resp.data);
					Upfront.Application.navigate('/edit/post/' + resp.data.post_id, {trigger: true});
				})
			;
		},
		on_post_loaded: function(view) {
			if(!this.postView){
				this.postView = view;
				view.editPost(view.post);

				Upfront.data.currentEntity = view;

				Upfront.Events.off("elements:this_post:loaded", this.on_post_loaded, this);

				Upfront.Events.on("upfront:application:contenteditor:render", this.select_title, this);
			}
		},
		select_title: function(){
			var input = this.postView.$('.post_title input').focus();

			input.val(input.val()); //Deselect the text
			$('#upfront-loading').remove();

			Upfront.Events.off("upfront:application:contenteditor:render", this.select_title, this);
		}
	});
	var Command_NewPage = Command_NewPost.extend({
		"className": "command-new-page",
		postType: 'page',
		_default_label: l10n.new_page,
		initialize: function () {
			this.setMode = Upfront.Application.MODE.LAYOUT;
		},
		render: function () {
			Upfront.Events.trigger("command:newpage:start", true);
			// this.$el.addClass('upfront-icon upfront-icon-page');
			this.$el.html(this._default_label);
            this.$el.prop("title", this._default_label);
		},
		on_click: function(e){
			e.preventDefault();
			var me = this;

			this.spawn_modal();
			this.modal.render();
			$('body').append(this.modal.el);

			this.modal.open(function () {
				me.render_modal();
				me.trigger("new_page:modal:open");
			}).done(function () {
				me.trigger("new_page:modal:close");
				Upfront.Util.post({
					action: "upfront-create-post_type",
					data: _.extend({post_type: me.postType}, me.modal._data)
				}).done(function (resp) {
					//Upfront.Util.log(resp.data);
					Upfront.Application.navigate('/edit/page/' + resp.data.post_id, {trigger: true});

				});
				//Upfront.Application.navigate('/create_new/page', {trigger: true});
			})
		},
		render_modal: function () {
			var me = this,
				$content = this.modal.$el.find('.upfront-inline-modal-content')
			;
			$content
				.empty()
				.append('<h2>' + l10n.add_new_page + '</h2>')
			;
			_.each(me.modal._fields, function (field) {
				field.render();
				field.delegateEvents();
				$content.append(field.$el);
			});
		},
		spawn_modal: function () {
			if (this.modal) return this.initialize_modal_data();
			var me = this,
				update_modal_data = function () {
					_.each(me.modal._fields, function (field, key) {
						me.modal._data[key] = field.get_value();
					});
					if (!me.modal._fields.permalink.has_been_edited()) {
						var title = $.trim(me.modal._data.title || me._default_label),
							permalink = title
								.replace(/^[^a-z0-9]+/gi, '') // Trim non-alnum off of start
								.replace(/[^a-z0-9]+$/gi, '') // Trim non-alnum off of end
								.replace(/[^-_0-9a-z]/gi, '-')
								.toLowerCase()
						;
						me.modal._fields.permalink.set_value(permalink);
					}
				},
				_initial_templates = [{label: l10n.none, value: ""}],
				templates_request = Upfront.Util.post({
					action: "upfront-wp-model",
					model_action: "get_post_extra",
					postId: "fake", // Stupid walkaround for model handler insanity
					allTemplates: true
				})
			;
			this.modal = new Upfront.Views.Editor.Modal({to: $('body'), button: true, top: 120, width: 540, button_text: l10n.create_page});
			this.modal._fields = {
				title: new Upfront.Views.Editor.Field.Text({
					label: "",
					name: "title",
					default_value: this._default_label,
					change: update_modal_data
				}),
				permalink: new Field_ToggleableText({
					label: '<b>' + l10n.permalink + ':</b> ' + Upfront.Settings.site_url.replace(/\/$/, '') + '/',
					label_style: "inline",
					name: "permalink",
					change: update_modal_data
				}),
				template: new Upfront.Views.Editor.Field.Select({
					label: l10n.page_template,
					name: "template",
					values: _initial_templates
				})
			};
			this.initialize_modal_data();
			this.on("new_page:modal:open", update_modal_data, this);
			this.on("new_page:modal:close", update_modal_data, this);
			templates_request.done(function (response) {
				me.modal._fields.template.options.values = _initial_templates; // Zero out the templates selection
				if (!response.data || !response.data.allTemplates) return false;
				_.each(response.data.allTemplates, function (tpl, title) {
					me.modal._fields.template.options.values.push({label: title, value: tpl});
				});
				me.modal._fields.template.render();
			});
		},
		initialize_modal_data: function () {
			var me = this;
			this.modal._data = {};
			_.each(_.keys(this.modal._fields), function (key) {
				me.modal._data[key] = "";
				if (me.modal._fields[key].reset_state) me.modal._fields[key].reset_state();
			});

		}
	});

	var Command_SaveLayout = Command.extend({
		"className": "command-save",
		render: function () {
			// this.$el.addClass('upfront-icon upfront-icon-save');
			this.$el.html(l10n.save);
            this.$el.prop("title", l10n.save);
		},
		on_click: function () {
			if ( _upfront_post_data.layout.specificity && _upfront_post_data.layout.item && !_upfront_post_data.layout.item.match(/-page/) )
				Upfront.Events.trigger("command:layout:save_as");
			else {
				Upfront.Events.trigger("command:layout:save");
			}
		}

	});
	var Command_SaveLayoutAs = Command.extend({
		render: function () {
			this.$el.html(l10n.save_as);
            this.$el.prop("title", l10n.save_as);
		},
		on_click: function () {
			Upfront.Events.trigger("command:layout:save_as");
		}

	});

	var Command_SavePostLayout = Command_SaveLayout.extend({
		"className": "command-save",
		render: function () {
                this.$el.addClass('upfront-icon upfront-icon-save');
                this.$el.html(l10n.save_layout);
                this.$el.prop("title", l10n.save_layout);
		},
		on_click: function () {
			Upfront.Events.trigger("post:layout:save");
		}
	});

	var Command_CancelPostLayout = Command.extend({
        className: "command-cancel",
		render: function () {
			this.$el.html(l10n.cancel);
            this.$el.prop("title", l10n.cancel);
		},
		on_click: function () {
            Upfront.Events.trigger("post:layout:cancel");
            if ( Upfront.Application.is_builder() ) {
                Upfront.Events.trigger("post:layout:post:style:cancel");
            }
		}
	});
	var Command_PreviewLayout = Command.extend({
		className: "command-preview",
		can_preview: false,
		render: function () {
			this.$el.addClass('command-save command-preview upfront-icon upfront-icon-save');
			//this.$el.html("Preview");
			this.preview_built();
			Upfront.Events.on("preview:build:start", this.building_preview, this);
			Upfront.Events.on("preview:build:stop", this.preview_built, this);
		},
		on_click: function () {
			if (this.can_preview) Upfront.Events.trigger("command:layout:preview");
		},
		building_preview: function () {
			this.$el.html(l10n.building);
			this.can_preview = false;
		},
		preview_built: function () {
			this.$el.html(l10n.preview);
            this.$el.prop("title", l10n.preview);
			this.can_preview = true;
		}

	});

	var Command_LoadLayout = Command.extend({
		render: function () {
			this.$el.html(l10n.alternate_layout);
            this.$el.prop("title", l10n.alternate_layout);
		},
		on_click: function () {
			Upfront.Events.trigger("command:layout:load", 2)
		}

	});

	var Command_PublishLayout = Command.extend({
		className: "command-publish-layout",
		render: function () {
			this.$el.html(l10n.publish_layout);
		},
		on_click: function () {
			Upfront.Events.trigger("command:layout:publish");
		}
	});

	var Command_Undo = Command.extend({
		"className": "command-undo",
		initialize: function () {
			//Upfront.Events.on("entity:activated", this.activate, this);
			//Upfront.Events.on("entity:deactivated", this.deactivate, this);
			Upfront.Events.on("command:undo", this.render, this);
			Upfront.Events.on("command:redo", this.render, this);

			// Re-activate on stored state
			Upfront.Events.on("upfront:undo:state_stored", this.render, this);

			this.deactivate();
		},
		render: function () {
			this.$el.addClass('upfront-icon upfront-icon-undo');
			this.$el.html(l10n.undo);
            this.$el.prop("title", l10n.undo);
			if (this.model.has_undo_states()) this.activate();
			else this.deactivate();
		},
		activate: function () {
			this.$el.css("opacity", 1);
		},
		deactivate: function () {
			this.$el.css("opacity", 0.5);
		},
		on_click: function () {
			var me = this,
				dfr = false,
				loading = new Upfront.Views.Editor.Loading({
					loading: l10n.undoing,
					done: l10n.undoing_done,
					fixed: true
				})
			;
			loading.render();
			$('body').append(loading.$el);

			dfr = me.model.restore_undo_state();
			if (dfr && dfr.done) {
				dfr.done(function () {
					Upfront.Events.trigger("command:undo");
					me.render();
					loading.done();
				});
			} else {
				setTimeout(function () {
					loading.done();
				}, 100);
			}
		}
	});

	var Command_Redo = Command.extend({
		"className": "command-redo",
		initialize: function () {
			//Upfront.Events.on("entity:activated", this.activate, this);
			//Upfront.Events.on("entity:deactivated", this.deactivate, this);
			Upfront.Events.on("command:undo", this.render, this);
			this.deactivate();
		},
		render: function () {
			this.$el.addClass('upfront-icon upfront-icon-redo');
			this.$el.html(l10n.redo);
            this.$el.prop("title", l10n.redo);
			if (this.model.has_redo_states()) this.activate();
			else this.deactivate();
		},
		activate: function () {
			this.$el.css("opacity", 1);
		},
		deactivate: function () {
			this.$el.css("opacity", 0.5);
		},
		on_click: function () {
			var me = this,
				dfr = false,
				loading = new Upfront.Views.Editor.Loading({
					loading: l10n.redoing,
					done: l10n.redoing_done,
					fixed: true
				})
			;
			loading.render();
			$('body').append(loading.$el);

			dfr = me.model.restore_redo_state();
			if (dfr && dfr.done) {
				dfr.done(function () {
					Upfront.Events.trigger("command:redo");
					me.render();
					loading.done();
				});
			} else {
				setTimeout(function () {
					loading.done();
				}, 100);
			}
		}
	});

	var Command_ExportHistory = Command.extend({
		render: function () {
			this.$el.html(l10n.export_history);
		},
		on_click: function () {
			alert("Check console output");
			console.log({
				"undo": Upfront.Util.Transient.get_all("undo"),
				"redo": Upfront.Util.Transient.get_all("redo")
			});
		}
	});

	var Command_Merge = Command.extend({
		render: function () {
			if (!this.model.merge.length) return false;
			this.$el.html(l10n.merge_selected);
		},
		on_click: function () {
			var merge_models = this.model.merge,
				region = this.model.get("regions").active_region,
				collection = region.get("modules"),
				objects = []
			;
			_(merge_models).each(function (module) {
				module.get("objects").each(function (obj) {
					objects.push(obj);
				});
				collection.remove(module);
			});
			var module_id = Upfront.Util.get_unique_id("module"),
				module = new Upfront.Models.Module({
				"name": "Merged module",
				"properties": [
					{"name": "element_id", "value": module_id},
					{"name": "class", "value": "c24"}
				],
				"objects": objects
			});
			this.add_module(module);
			$("#" + module_id).trigger("click"); // Reset selectable and activate the module
			this.remove();
			this.trigger("upfront:command:remove", this);
			Upfront.Events.trigger("command:merge");
		}
	});

	var Command_Delete = Command.extend({
		initialize: function () {
			Upfront.Events.on("entity:activated", this.activate, this);
			Upfront.Events.on("entity:deactivated", this.deactivate, this);
			this.deactivate();
		},
		render: function () {
			this.$el.html(l10n.delete_string);
		},

		on_click: function () {
			var region = this.model.get("regions").active_region,
				modules = region.get("modules"),
				active_module = modules.active_entity
			;
			if (active_module) return this.delete_module(region, active_module);

			modules.each(function (module) {
				var objects = module.get("objects"),
					active_object = objects.active_entity
				;
				if (active_object) objects.remove(active_object);
			});
		},

		activate: function () {
			this.$el.css("text-decoration", "none");
		},
		deactivate: function () {
			this.$el.css("text-decoration", "line-through");
		},

		delete_module: function (region, module) {
			var modules = region.get("modules");
			modules.remove(module);
		}
	});

	var Command_Select = Command.extend({
		initialize: function () {
			Upfront.Events.on("command:merge", this.on_click, this);
		},
		render: function () {
			this.$el.html("Select mode " + (this._selecting ? 'on' : 'off'));
			this.$el.html((
				this._selecting
					? l10n.select_mode_on
					: l10n.select_mode_off
			));
		},
		on_click: function () {
			if (!this._selecting) Upfront.Events.trigger("command:select");
			else Upfront.Events.trigger("command:deselect");
			this._selecting = !this._selecting;
			this.render();
		}
	});

	var Command_ToggleGrid = Command.extend({
		className: "command-grid",
		render: function () {
			this.$el.addClass('upfront-icon upfront-icon-grid');
			//this.$el.html('Toggle grid');
            this.$el.prop("title", l10n.toggle_grid);
			this.listenTo(Upfront.Events, "entity:region:added", this.update_grid);
			this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.update_grid);
            this.listenTo(Upfront.Events, "grid:toggle", this.on_click);
		},
		on_click: function () {
			$('.upfront-overlay-grid').size() || this.create_grid();
			this.toggle_grid();
		},
		create_grid: function () {
			this.update_grid();
			//this.attach_event();
		},
		toggle_grid: function () {
			if(!Upfront.Application.get_gridstate())
				this.show_grid();
			else
				this.hide_grid();
		},
		show_grid: function () {
			this.$el.addClass('upfront-icon-grid-active');
			$('.upfront-overlay-grid').addClass('upfront-overlay-grid-show');
			Upfront.Application.set_gridstate(true);
		},
		hide_grid: function () {
			this.$el.removeClass('upfront-icon-grid-active');
			$('.upfront-overlay-grid').removeClass('upfront-overlay-grid-show');
			Upfront.Application.set_gridstate(false);
		},
		update_grid: function (size) {
			var $main = $(Upfront.Settings.LayoutEditor.Selectors.main),
				grid = Upfront.Settings.LayoutEditor.Grid;
			$('.upfront-overlay-grid').remove();
			$('.upfront-grid-layout, .upfront-region-side-fixed .upfront-modules_container, .upfront-region-side-lightbox .upfront-modules_container').each(function(){
				var columns = grid.size,
					template = _.template(_Upfront_Templates.overlay_grid, {columns: columns, size_class: grid.class, style: 'simple'});
				$(this).prepend(template);

				//Adjust grid rulers position
				Upfront.Application.adjust_grid_padding_settings(this);
			});

			!Upfront.Application.get_gridstate() || this.show_grid();
		}
	});

	var Command_ResetEverything = Command.extend({
		className: 'command-reset-everything',
		render: function () {
			this.$el.html("<span title='" + l10n.destroy_layout + "'>" + l10n.reset_everything + "</span>");
		},
		on_click: function () {
			Upfront.Util.reset()
				.success(function () {
					Upfront.Util.log("layout reset");
					window.location.reload();
				})
				.error(function () {
					Upfront.Util.log("error resetting layout");
				})
			;
		}
	});

	var Command_ToggleMode = Command.extend({
		className: 'command-toggle-mode',
		enabled: true,
		initialize: function () {
			Upfront.Events.on('upfront:element:edit:start', this.disable_toggle, this);
			Upfront.Events.on('upfront:element:edit:stop', this.enable_toggle, this);
		},
		render: function () {
			this.$el.html(_.template(
				"<span title='toggle editing mode'>" + l10n.current_mode + "</span>",
				{mode: Upfront.Application.get_current()}
			));
		},
		on_click: function () {
			if ( !this.enabled )
				return false;
			var mode = Upfront.Application.mode && Upfront.Application.mode.current && Upfront.Application.mode.current != Upfront.Application.MODE.CONTENT
				? Upfront.Application.MODE.CONTENT
				: Upfront.Application.mode.last
			;
			Upfront.Application.start(mode);
		},
		disable_toggle: function () {
			this.$el.css('opacity', 0.5);
			this.enabled = false;
		},
		enable_toggle: function () {
			this.$el.css('opacity', 1);
			this.enabled = true;
		}
	});

	var Command_ToggleMode_Small = Command_ToggleMode.extend({
		className: 'command-toggle-mode upfront-icon',
		current_mode: false,
		render: function () {
			if ( this.current_mode )
				this.$el.removeClass('command-toggle-mode-' + this.current_mode + ' upfront-icon-collapse upfront-icon-expand');
			this.current_mode = Upfront.Application.get_current();
			var icon = ( this.current_mode != Upfront.Application.MODE.CONTENT ) ? 'upfront-icon-collapse' : 'upfront-icon-expand';
			this.$el.addClass('command-toggle-mode-' + this.current_mode + ' ' + icon);
		}
	});


	var Command_EditBackgroundArea = Command.extend({
		"className": "command-edit-background-area",
		events: {
			"click .switch": "on_switch"
		},
		initialize: function() {
			Upfront.Events.on("command:newpage:start", this.switchOff, this);
			Upfront.Events.on("command:newpost:start", this.switchOff, this);
		},
		render: function () {
			var template = _.template(_Upfront_Templates.edit_background_area, {})
			this.$el.html(template);
		},
		on_switch: function () {
			var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
			if ( this.$el.find('.switch-on').hasClass('active') ){ // Switch off
				this.switchOff();
			}
			else { // Switch on
				this.$el.find('.switch-off').removeClass('active');
				this.$el.find('.switch-on').addClass('active');
				$main.addClass('upfront-region-editing');
				Upfront.Events.trigger("command:region:edit_toggle", true);
			}
		},
		switchOff: function() {
			var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
			this.$el.find('.switch-off').addClass('active');
			this.$el.find('.switch-on').removeClass('active');
			$main.removeClass('upfront-region-editing');
			$main.removeClass('upfront-region-lightbox-editing');
			Upfront.Events.trigger("command:region:edit_toggle", false);
		}
	});

	/**
	 * DEPRECATED
	 */
	var Command_ThemesDropdown = Command.extend({
		className: 'themes-dropdown',
		enabled: true,
		events: {
			'click .upfront-field-select-value': 'openOptions',
			'mouseup .upfront-field-select': 'onMouseUp',
			'change .upfront-field-select-option input': 'onChange',
			'click .upfront-field-select-option label': 'onOptionClick'
		},
		initialize: function() {
			var themes = _.union([{label: l10n.choose_theme, value: ''}], _.map(Upfront.themeExporter.themes, function(theme) {
				return {
					label: theme.name,
					value: theme.directory
				};
			}));
			this.fields = [
				new Field_Select({
					values: themes,
					default_value: Upfront.themeExporter.currentTheme === 'upfront' ?
						'' : Upfront.themeExporter.currentTheme,
					change: function () {
					  if (this.get_value() === ''
							|| this.get_value() === Upfront.themeExporter.currentTheme) return;

						Upfront.Events.trigger("builder:load_theme", this.get_value());
					}
				})
			];
		},
		render: function () {
			this.fields[0].render();
			this.$el.append(this.fields[0].el);
		},
		// noop for preventing parent class rendering on click behaviour
		openOptions: function(e) {
			this.fields[0].openOptions(e);
		},
		onMouseUp: function(e) {
			this.fields[0].onMouseUp(e);
		},
		onChange: function(e) {
			this.fields[0].onChange(e);
		},
		onOptionClick: function(e) {
			this.fields[0].onOptionClick(e);
		}

	});

	/**
	 * DEPRECATED
	 */
	var Command_NewLayout = Command.extend({
		className: "command-new-layout",
		render: function () {
			this.$el.addClass('upfront-icon upfront-icon-layout');
			this.$el.html(l10n.new_layout);
			this.$el.prop("title", l10n.new_layout);
		},
		on_click: function () {
			Upfront.Events.trigger("command:layout:create");
		}
	});

	/**
	 * DEPRECATED
	 */
	var Command_BrowseLayout = Command.extend({
		className: "command-browse-layout upfront-icon upfront-icon-browse-layouts",
		render: function () {
			this.$el.html(l10n.layouts);
            this.$el.prop("title", l10n.layouts);
		},
		on_click: function () {
			Upfront.Events.trigger("command:layout:browse");
		}
	});

	var Command_EditStructure = Command.extend({
		tagName: 'div',
		className: "command-link command-edit-structure",
		render: function (){
			this.$el.html(l10n.edit_grid);
			this.$el.prop("title", l10n.edit_grid);
		},
		on_click: function () {
			Upfront.Events.trigger("command:layout:edit_structure");
		}
	});

	var Command_EditLayoutBackground = Command.extend({
		tagName: 'div',
		className: "command-link command-edit-bg",
		render: function (){
			this.$el.text(l10n.edit_global_bg);
			this.$el.prop("title", l10n.edit_global_bg);
		},
		on_click: function () {
			Upfront.Events.trigger("command:layout:edit_background");
		}
	});

	var Command_EditGlobalRegions = Command.extend({
		tagName: 'div',
		className: "command-link command-edit-global-regions",
		render: function (){
			this.$el.text(l10n.edit_global_regions);
			this.$el.prop("title", l10n.edit_global_regions);
		},
		on_click: function () {
			Upfront.Events.trigger("command:layout:edit_global_regions");
		}
	});

	var Command_EditCustomCSS = Command.extend({
		tagName: 'div',
		className: "command-edit-css upfront-icon upfront-icon-edit-css",
		render: function (){
			this.$el.html('<span>' + l10n.add_custom_css_rules + '</span>');
            this.$el.prop("title", l10n.add_custom_css_rules);
		},
		on_click: function () {
			var editor = Upfront.Application.cssEditor,
				save_t;

			editor.init({
				model: this.model,
				type: "Layout",
				sidebar: false,
				element_id: 'layout',
				global: true
			});
		}
	});

	var Command_OpenFontManager = Command.extend({
		tagName: 'div',
		className: "command-open-font-manager upfront-icon upfront-icon-open-font-manager",
		render: function (){
			this.$el.html('<span title="'+ l10n.theme_font_manager +'">' + l10n.theme_font_manager + '</span>');
		},
		on_click: function () {
			Upfront.Events.trigger('command:themefontsmanager:open');
		}
	});

	var Command_GeneralEditCustomCSS = Command.extend({
		tagName: 'div',
		className: "command-edit-css upfront-icon upfront-icon-edit-css",
		initialize: function() {
			this.lazy_save_styles = _.debounce(function(styles) {
				this.model.set({ styles: styles });
			}, 1000);
		},
		render: function () {
			this.$el.html('<span title="'+ l10n.add_custom_css_rules +'">' + l10n.add_custom_css_rules + '</span>');
		},
		on_click: function () {
			var editor,
				me = this;

			editor = new GeneralCSSEditor({
				model: this.model,
				page_class: this.model.get('id') + '-breakpoint',
				type: "Layout",
				sidebar: false,
				global: true,
				change: function(content) {
					me.lazy_save_styles(content);
				}
			});

			Upfront.Events.on("upfront:layout_size:change_breakpoint", function() {
				editor.close();
			});
		}
	});

	var Command_GoToTypePreviewPage = Command.extend({
		tagName: 'div',
		className: "command-go-to-type-preview",
		render: function () {
			this.$el.text(l10n.go_to_preview_page);
		},
		on_click: function () {
			alert('This is just placeholder :)');
		}
	});

	var Command_ExportLayout = Command.extend({
		className: "command-export upfront-icon upfront-icon-export",
		render: function (){
			this.$el.text(l10n.export_str);
		},
		on_click: function () {
			$('div.redactor_editor').each(function() {
				var ed = $(this).data('ueditor');
				if(ed)
					ed.stop();
			});
			Upfront.Events.trigger("command:layout:export_theme");
		}
	});

	/* Responsive mode commands */
	var Command_CreateResponsiveLayouts = Command.extend({
		enabled: true,
		className: 'command-create-responsive-layouts upfront-icon upfront-icon-start-responsive',
		render: function () {
			this.$el.html("<span title='"+ l10n.create_responsive_layouts +"'>" + l10n.create_responsive_layouts + "</span>");
		},
		on_click: function () {
			Upfront.Application.start(Upfront.Application.MODE.RESPONSIVE);
		}
	});

	var Command_StartResponsiveMode = Command.extend({
		enabled: true,
		className: 'command-start-responsive upfront-icon upfront-icon-start-responsive',
		render: function () {
			this.$el.html("<span title='"+ l10n.responsive_mode +"'>" + l10n.responsive_mode + "</span>");
		},
		on_click: function () {
			Upfront.Application.start(Upfront.Application.MODE.RESPONSIVE);
		}
	});

	var Command_StopResponsiveMode = Command.extend({
		enabled: true,
		className: 'exit-responsive',
		render: function () {
			this.$el.html("<span title='"+ l10n.exit_responsive  +"'>" + l10n.exit_responsive + "</span>");
		},
		on_click: function () {
			$('li.desktop-breakpoint-activate').trigger('click');
			Upfront.Application.start(Upfront.Application.mode.last);
		}
	});

	var Command_BreakpointDropdown = Command.extend({
		className: 'activate-breakpoints-dropdown',
		enabled: true,
		initialize: function() {
			var breakpoints = breakpoints_storage.get_breakpoints();

			this.fields = [
				new Field_Compact_Label_Select({
					multiple: true,
					label_text: l10n.activate_breakpoints,
					collection: breakpoints
				})
			]
		},
		render: function () {
			this.fields[0].render();
			this.$el.append(this.fields[0].el);
			this.fields[0].delegateEvents();
		},
		on_click: function () {

		}
	});

	var Command_AddCustomBreakpoint = Backbone.View.extend({
		tagName: 'li',
		className: 'upfornt-icon upfront-icon-add',
		id: 'new-custom-breakpoint',
		events: {
			'click': 'add_breakpoint'
		},
		render: function () {
				this.$el.html(l10n.new_breakpoint);
		},
		initialize: function(options) {
			this.collection = breakpoints_storage.get_breakpoints();
		},
		add_breakpoint: function(event) {
			event.preventDefault();
			var popup;
			var new_breakpoint = new Breakpoint_Model({ 'id': this.collection.get_unique_id() });
			this.collection.add(new_breakpoint);
			new_breakpoint.set({ 'enabled': true });
			new_breakpoint.set({ 'active': true });

			popup = Upfront.Popup.open(function (data, $top, $bottom) {
				$top.empty();
				var $content = $(this);
				var editPanel = new BreakpointEditPanel({ model: new_breakpoint });

				$content
				.append(editPanel.render().el);
				$bottom.append('<div class="breakpoint-edit-ok-button">' + l10n.ok + '</div>');
				$('#upfront-popup-close').hide();
				$('.breakpoint-edit-ok-button').on('click', function() {
					Upfront.Popup.close();
					$('#upfront-popup-close').show();
				});
			}, {
				width: 400
			});
		}
	});

	var Command_ResponsiveUndo = Command_Undo.extend({
		on_click: function() {
			alert('This is just placeholder.');
		}
	});

	var Command_ResponsiveRedo = Command_Redo.extend({
		on_click: function() {
			alert('This is just placeholder.');
		}
	});

	/**
	 * DEPRECATED
	 */
	var ResponsiveCommand_BrowseLayout = Command.extend({
		className: "command-browse-layout command-browse-layout-responsive",
		render: function () {
			this.$el.html('<span title="'+ l10n.browse_layouts +'">' + l10n.browse_layouts + '</span>');
		},
		on_click: function () {
			Upfront.Events.trigger("command:layout:browse");
		}
	});


	/* End responsive mode commands */

	var Commands = Backbone.View.extend({
		"tagName": "ul",

		initialize: function () {
			this.commands = _([
				new Command_NewPage({"model": this.model}),
				new Command_NewPost({"model": this.model}),
				new Command_SaveLayout({"model": this.model}),
				new Command_SaveLayoutAs({"model": this.model}),
				//new Command_LoadLayout({"model": this.model}),
				new Command_Undo({"model": this.model}),
				new Command_Redo({"model": this.model}),
				new Command_Delete({"model": this.model}),
				new Command_Select({"model": this.model}),
				new Command_ToggleGrid({"model": this.model}),
				new Command_ResetEverything({"model": this.model}),
			]);
			if (Upfront.Settings.Debug.transients) this.commands.push(new Command_ExportHistory({model: this.model}));
		},
		render: function () {
			this.$el.find("li").remove();
			this.commands.each(this.add_command, this);
		},

		add_command: function (command) {
			if (!command) return;
			command.remove();
			command.render();
			this.$el.append(command.el);
			command.bind("upfront:command:remove", this.remove_command, this);
			command.delegateEvents();
		},

		remove_command: function (to_remove) {
			var coms = this.commands.reject(function (com) {
					com.remove();
					return com.cid == to_remove.cid;
				})
			;
			this.commands = _(coms);
			this.render();
		}
	});

	var SidebarPanel = Backbone.View.extend(_.extend({}, Upfront_Scroll_Mixin, {
		"tagName": "li",
		"className": "sidebar-panel",
		events: {
			"click .sidebar-panel-title": "on_click",
			"click .sidebar-panel-tab" : "show_tab"
		},
		get_title: function () {
			return '';
		},
		render: function () {
			if(this.active)
				this.$el.addClass('active');
			else
				this.$el.removeClass('active');
			this.$el.html('<h3 class="sidebar-panel-title">' + this.get_title() + '</h3>');
			this.$el.append('<div class="sidebar-panel-content" />');
			this.stop_scroll_propagation(this.$el.find('.sidebar-panel-content'));
			if ( this.on_render ) this.on_render();
			// Make first tab active
			this.$el.find(".sidebar-panel-tab").first().addClass("active");
			// show first tab content
			this.$el.find(".sidebar-tab-content").first().show();
		},
		on_click: function () {
			$('.sidebar-panel').not(this.$el).removeClass('expanded');
			this.$el.addClass('expanded');

			// take care of tabs if any
			$('.sidebar-panel').not(this.$el).find(".sidebar-panel-tabspane").hide();
			this.$el.find(".sidebar-panel-tabspane").show();
		},
		show_tab : function( e ){
			var tab = "#" + $(e.target).data("target");
			// Set current tab active
			this.$el.find(".sidebar-panel-tab").removeClass("active");
			$(e.target).addClass("active");
			//Show current tab's content
			this.$el.find(".sidebar-tab-content").hide();
			this.$el.find(tab).show();
		}
	}));

	var DraggableElement = Backbone.View.extend({
		"tagName": "span",
		"className": "draggable-element upfront-no-select",
		"shadow_id": '',
		"draggable": true,
		"priority": 10000,
		initialize: function(opts){
			this.options = opts;
			this.title = opts.title || l10n.no_title;
		},

		render: function(){
			this.$el.html(this.title);
		},

		add_module: function (module) {
			// Add module to shadow region so it's available to add by dragging
			var region = this.model.get("regions").get_by_name('shadow');
			if (!region || !region.get) return false; // Let's break out if we can't find the shadow region
			this.shadow_id = Upfront.Util.get_unique_id("shadow");
			module.set({"shadow": this.shadow_id}, {silent: true});
			region.get("modules").add(module);
		}
	});

	var SidebarPanel_DraggableElements = SidebarPanel.extend({
		"className": "sidebar-panel sidebar-panel-elements",
		initialize: function () {
			this.active = true;
			this.elements = _([]);
			Upfront.Events.on("command:layout:save", this.on_save, this);
			Upfront.Events.on("command:layout:save_as", this.on_save, this);
			Upfront.Events.on("command:layout:publish", this.on_save, this);
			//Upfront.Events.on("command:layout:preview", this.on_preview, this); // Do NOT drop shadow region from layout on preview build
			Upfront.Events.on("command:layout:save_success", this.on_save_after, this);
			Upfront.Events.on("command:layout:save_error", this.on_save_after, this);
			Upfront.Events.on("entity:drag_stop", this.reset_modules, this);
			Upfront.Events.on("layout:render", this.apply_state_binding, this);
		},
		get_title: function () {
			return l10n.draggable_elements;
		},
		on_save: function () {
			var regions = this.model.get('regions');
			this._shadow_region = regions.get_by_name('shadow');
			regions.remove(this._shadow_region, {silent: true});
		},
		on_preview: function () { return this.on_save(); },
		apply_state_binding: function () {
			Upfront.Events.on("command:undo", this.reset_modules, this);
			Upfront.Events.on("command:redo", this.reset_modules, this);
		},
		on_render: function () {
			this.elements.each(this.render_element, this);
			this.reset_modules();
			if ( Upfront.Application.get_current() != Upfront.Settings.Application.MODE.THEME )
				this.$el.find('.sidebar-panel-title').trigger('click');
		},
		on_save_after: function () {
			var regions = this.model.get('regions');
			if ( this._shadow_region )
				regions.add(this._shadow_region, {silent: true});
			else
				this.reset_modules();
		},
		reset_modules: function () {
			var regions = this.model.get("regions"),
				region = regions ? regions.get_by_name('shadow') : false
			;
			if (!regions) return false;
			if ( ! region ){
				region = new Upfront.Models.Region({
					"name": "shadow",
					"container": "shadow",
					"title": "Shadow Region"
				});
				this.model.get('regions').add( region );
			}
			if ( region.get("modules").length != this.elements.size() ) {
				var modules = region.get("modules");
				this.elements.each(function (element) {
					var found = false;
					modules.forEach(function(module){
						if ( module.get('shadow') == element.shadow_id )
							found = true;
					});
					if ( ! found ){
						element.add_element();
					}
				}, this);
			}
		},
		render_element: function (element) {
			if(! element.draggable)
				return;

			var $main = $(Upfront.Settings.LayoutEditor.Selectors.main),
				me = this;
			element.remove();
			element.render();
			this.$el.find('.sidebar-panel-content').append(element.el);
			element.$el.on('mousedown', function (e) {
				// Trigger shadow element drag
				var $main = $(Upfront.Settings.LayoutEditor.Selectors.main),
					$shadow = $('[data-shadow='+element.shadow_id+']'),
					main_off = $main.offset(),
					pos = $shadow.position(),
					off = $shadow.offset(),
					target_off = element.$el.offset(),
					h = $shadow.outerHeight(),
					w = $shadow.outerWidth(),
					$clone = element.$el.clone(),
					clone_h = element.$el.outerHeight(),
					clone_w = element.$el.outerWidth(),
					$element_drag_wrapper = $('<div id="element-drag-wrapper" class="upfront-ui" />'),
					$gutter = $('.upfront-grid-layout-gutter-left:first, .upfront-grid-layout-gutter-right:first');
				$shadow.css({
					position: "absolute",
					top: ( e.pageY-( off.top-pos.top )-(h/2) ) ,
					left: ( e.pageX-( off.left-pos.left )-(w/2) ),
					visibility: "hidden",
					zIndex: -1
				})
				.one('mousedown', function(e){
					// console.log('Shadow mousing down');
				})
				.trigger(e)
				.one('dragstart', function (e, ui) {
					element.$el.addClass('element-drag-active');
					$('body').append($element_drag_wrapper);
					$clone.appendTo($element_drag_wrapper);
					$clone.addClass('element-dragging');
					$clone.css({
						position: "absolute",
						top: e.pageY - ( clone_h/2 ),
						left: e.pageX - ( clone_w/2 ),
						zIndex: 999
					});
				})
				.on('drag', function (e, ui) {
					var in_gutter = false;
					$gutter.each(function(){
						if ( in_gutter )
							return;
						var off = $(this).offset(),
							w = $(this).width();
						if ( e.pageX >= main_off.left && e.pageX >= off.left+10 && e.pageX <= off.left+w-10 )
							in_gutter = true;
					});
					if ( in_gutter )
						$clone.addClass('element-dragging-no-drop');
					else
						$clone.removeClass('element-dragging-no-drop');
					$clone.css({
						top: e.pageY - ( clone_h/2 ),
						left: e.pageX - ( clone_w/2 )
					});
				})
				.one('dragstop', function (e, ui) {
					element.$el.removeClass('element-drag-active');
					$clone.remove();
					$element_drag_wrapper.remove();
				});
			});
		}
	});

	var SidebarPanel_Posts = SidebarPanel_DraggableElements.extend({
		className: "sidebar-panel upfront-panel-post_panel",
		parts: ['Title', 'Contents', 'Excerpt', 'Featured Image', 'Author', 'Author Gravatar', 'Date', 'Update', 'Comments Count', 'Tags', 'Categories'],
		partElements: [],
		initialize: function (opts) {
			//SidebarPanel_DraggableElements.prototype.constructor.call(this, opts);
			this.active = false;
			this.elements = _([]);
			Upfront.Events.on("entity:drag_stop", this.reset_modules, this);
			Upfront.Events.on("layout:render", this.apply_state_binding, this);
		},
		get_title: function () {
			return l10n.post_components;
		},

		loadElements: function(){
			this.elements =  _([]);

			var me = this,
				PostPartElement = Upfront.Content.PostElement,
				editorObjects = Upfront.Application.LayoutEditor.Objects
			;

			_.each(this.parts, function(part){
				var element = new PostPartElement({title: part, model: Upfront.Application.layout}),
					elementSlug = 'PostPart_' + element.slug
				;

				me.elements.push(element);
				if(!editorObjects[elementSlug]){
					editorObjects[elementSlug] = {
						Model: element.Model,
						View: element.View,
						Element: PostPartElement,
						Settings: element.Settings
					};

					Upfront.Models[elementSlug + 'Model'] = element.Model;
					Upfront.Views[elementSlug + 'View'] = element.View;
				}

				me.partElements.push(element);
			});

			Upfront.Events.trigger('sidebar:postparts:loaded');

			return this;
		},

		unloadElements: function(){
			var me = this,
				editorObjects = Upfront.Application.LayoutEditor.Objects
			;

			_.each(this.partElements, function(element){
				var elementSlug = 'PostPart_' + element.slug;
				element.remove();
				delete(editorObjects[elementSlug]);
				delete(Upfront.Models[elementSlug + 'Model']);
				delete(Upfront.Views[elementSlug + 'View']);
			});

			this.partElements = [];


			Upfront.Events.trigger('sidebar:postparts:unloaded');

			return this;
		}
	});

	var SidebarPanel_Settings_Item = Backbone.View.extend({
		"tagName": "div",
		"className": "panel-setting upfront-no-select",
		render: function () {
			if ( this.on_render ) this.on_render();
		}
	});

	var SidebarPanel_Settings_Section = Backbone.View.extend({
		"tagName": "div",
		"className": "panel-section",
		initialize: function () {
			this.settings = _([]);
		},
		get_title: function () {},
		render: function () {
			var me = this;
//			this.$el.html('<h4 class="panel-section-title">' + this.get_title() + '</h4>');
            this.$el.html("");
			this.$el.append('<div class="panel-section-content" />');
			this.settings.each(function (setting) {
				setting.render();
				setting.delegateEvents();
				me.$el.find('.panel-section-content').append(setting.el);
			});
			if ( this.on_render ) this.on_render();
		}
	});

	var SidebarPanel_Settings_Item_Typography_Editor = SidebarPanel_Settings_Item.extend({
		fields: {},
		current_element: 'h1',
		elements: ["h1", "h2", "h3", "h4", "h5", "h6", "p", "a", "a:hover", "ul", "ol", "blockquote", 'blockquote.upfront-quote-alternative'],
		inline_elements: ["a", "a:hover"],
		typefaces: {},
		styles: {},
		sizes: {},
		colors: {},
		line_heights: {},
		initialize: function () {
			var me = this;
			SidebarPanel_Settings_Item.prototype.initialize.call(this);
			var fonts = google_fonts_storage.get_fonts();
			if (fonts && fonts.state) { // Is this a promise object? If not, DON'T try to re-render when it's "done", because we already have fonts
				$.when(fonts).done(function() {
					me.render();
				});
			}
			this.listenTo(Upfront.Events, 'upfront:render_typography_sidebar', this.render);
			this.listenTo(Upfront.Events, 'entity:object:after_render', this.update_typography_elements);
			this.listenTo(Upfront.Events, "theme_colors:update", this.update_typography_elements, this);
		},
		on_render: function () {
			var me = this,
				styles_list = [], // this will change with every font family change
				$wrap_left = $('<div class="upfront-typography-fields-left" />'),
				$wrap_right = $('<div class="upfront-typography-fields-right" />'),
				typography = this.model.get_property_value_by_name('typography'),
				layout_typography = _.findWhere(
					Upfront.Application.current_subapplication.get_layout_data().properties,
					{ 'name': 'typography' }
				),
				default_typography = $.parseJSON('{}'); //$.parseJSON('{\"h1\":{\"weight\":\"100\",\"style\":\"normal\",\"size\":\"72\",\"line_height\":\"1\",\"font_face\":\"Arial\",\"font_family\":\"sans-serif\",\"color\":\"rgba(0,0,0,1)\"},\"h2\":{\"weight\":\"400\",\"style\":\"normal\",\"size\":\"50\",\"line_height\":\"1\",\"font_face\":\"Georgia\",\"font_family\":\"serif\"},\"h3\":{\"weight\":\"400\",\"style\":\"normal\",\"size\":\"36\",\"line_height\":\"1.3\",\"font_face\":\"Georgia\",\"font_family\":\"serif\"},\"h4\":{\"weight\":\"400\",\"style\":\"normal\",\"size\":\"30\",\"line_height\":\"1.2\",\"font_face\":\"Arial\",\"font_family\":\"sans-serif\"},\"h5\":{\"weight\":\"400\",\"style\":\"normal\",\"size\":\"25\",\"line_height\":\"1.2\",\"font_face\":\"Georgia\",\"font_family\":\"serif\"},\"h6\":{\"weight\":\"400\",\"style\":\"italic\",\"size\":\"22\",\"line_height\":\"1.3\",\"font_face\":\"Georgia\",\"font_family\":\"serif\"},\"p\":{\"weight\":\"400\",\"style\":\"normal\",\"size\":\"18\",\"line_height\":\"1.4\",\"font_face\":\"Georgia\",\"font_family\":\"serif\"},\"a\":{\"weight\":\"400\",\"style\":\"italic\",\"size\":false,\"line_height\":false,\"font_face\":\"Georgia\",\"font_family\":\"serif\",\"color\":\"rgba(0,206,141,1)\"},\"a:hover\":{\"weight\":\"400\",\"style\":\"italic\",\"size\":false,\"line_height\":false,\"font_face\":\"Georgia\",\"font_family\":\"serif\",\"color\":\"rgba(0,165,113,1)\"},\"ul\":{\"weight\":\"400\",\"style\":\"normal\",\"size\":\"16\",\"line_height\":\"1.5\",\"font_face\":\"Arial\",\"font_family\":\"sans-serif\",\"color\":\"rgba(0,0,0,1)\"},\"ol\":{\"weight\":\"400\",\"style\":\"normal\",\"size\":\"16\",\"line_height\":\"1.5\",\"font_face\":\"Arial\",\"font_family\":\"sans-serif\"},\"blockquote\":{\"weight\":\"400\",\"style\":\"italic\",\"size\":\"20\",\"line_height\":\"1.5\",\"font_face\":\"Georgia\",\"font_family\":\"serif\",\"color\":\"rgba(103,103,103,1)\"},\"blockquote.upfront-quote-alternative\":{\"weight\":\"400\",\"style\":\"italic\",\"size\":\"20\",\"line_height\":\"1.5\",\"font_face\":\"Georgia\",\"font_family\":\"serif\",\"color\":\"rgba(103,103,103,1)\"}}');

			layout_typography = layout_typography ? layout_typography.value : default_typography;
			var big_tablet_breakpoint,
				tablet_breakpoint,
				switcheroo;

			// Breakpoint's typography should initialize like this:
			// - if there is no typography for current breakpoint it should inherit settings from
			//   wider one, if wider one is not defined inherit from one above, last one is default
			//   typography
			// - in case of widest (usually tablet for now, big-tablet in some themes) it should
			//   inherit from default typography
			if (_.isEmpty(typography) || _.isUndefined(typography.h2)) {
				if (_.contains(['tablet', 'mobile'], this.model.get('id')) || this.model.get('name') === 'big-tablet') {
					switcheroo = this.model.get('name') === 'big-tablet' ? 'big-tablet' : this.model.get('id');

					switch (switcheroo) {
						case 'big-tablet':
							// We look into the default typography and get those
							typography = layout_typography;
							break;
						case 'tablet':
							// We look to big-tablet typography, if it's undefined we take default typography
							big_tablet_breakpoint = breakpoints_storage.get_breakpoints().findWhere({name:'big-tablet'});
							if (_.isUndefined(big_tablet_breakpoint) || _.isUndefined(big_tablet_breakpoint.get('typography')) || _.isUndefined(big_tablet_breakpoint.get('typography').h2)) {
								typography = layout_typography;
							} else {
								typography = big_tablet_breakpoint.get('typography');
							}
							break;
						case 'mobile':
							// We look to tablet typography, if it's undefined we take default typography
							tablet_breakpoint = breakpoints_storage.get_breakpoints().findWhere({id:'tablet'});
							if (_.isUndefined(tablet_breakpoint) || _.isUndefined(tablet_breakpoint.get('typography')) || _.isUndefined(tablet_breakpoint.get('typography').h2)) {
								typography = layout_typography;
							} else {
								typography = tablet_breakpoint.get('typography');
							}
					}
				} else {
					// ensures that when theme is created there will be reasonable values for typography
					typography = layout_typography || default_typography;
				}
			}

			this.typography = typography;

			//Pass global typography settings to typography module
			Upfront.mainData.global_typography = typography;

			// Check for theme fonts if no theme fonts just return string
			var currentMode = Upfront.Application.get_current();
			var builderMode = Upfront.Settings.Application.MODE.THEME;
			var doneIntro = Upfront.mainData.userDoneFontsIntro;
			var showChooseFontsButton = (currentMode === builderMode && !doneIntro) ||
				(currentMode !== builderMode && theme_fonts_collection.length === 0 && !doneIntro);

			var chooseButton;
			if (showChooseFontsButton) {
				chooseButton = new Field_Button({
					label: l10n.select_fonts_to_use,
					compact: true,
					classname: 'open-theme-fonts-manager',

					on_click: function(e){
						Upfront.Events.trigger('command:themefontsmanager:open');
					}
				});
			} else {
				chooseButton = new Command_OpenFontManager();
			}

			if (theme_fonts_collection.length === 0 && Upfront.mainData.userDoneFontsIntro === false) {
				this.$el.html('<p class="sidebar-info-notice upfront-icon">' + l10n.no_defined_fonts + '</p>');
				chooseButton.render();
				this.$el.append(chooseButton.el);
				return;
			}

			// Load saved styles for all elements
			_.each(typography, function (value, element) {
				me.typefaces[element] = value.font_face;
				me.colors[element] = value.color;

				me.styles[element] = Font_Model.get_variant(value.weight, value.style);

				if ( value.size )
					me.sizes[element] = value.size;
				if ( value.line_height )
					me.line_heights[element] = value.line_height;
			});

			if ( !this.fields.length ) {
				this.fields = {
					start_font_manager: chooseButton,
					element: new Upfront.Views.Editor.Field.Select({
						label: l10n.type_element,
						default_value: 'h1',
						values: [
							{ label: l10n.h1, value: "h1" },
							{ label: l10n.h2, value: "h2" },
							{ label: l10n.h3, value: "h3" },
							{ label: l10n.h4, value: "h4" },
							{ label: l10n.h5, value: "h5" },
							{ label: l10n.h6, value: "h6" },
							{ label: l10n.p, value: "p" },
							{ label: l10n.a, value: "a" },
							{ label: l10n.ahover, value: "a:hover" },
							{ label: l10n.ul, value: "ul" },
							{ label: l10n.ol, value: "ol" },
							{ label: l10n.bq, value: "blockquote" },
							{ label: l10n.bqalt, value: "blockquote.upfront-quote-alternative" },
						],
						change: function () {
							var value = this.get_value(),
								is_inline = _.contains(me.inline_elements, value);
							me.current_element = value;
							me.fields.typeface.set_value( me.typefaces[value] );
							me.update_styles_field();
							if ( is_inline ){
								$([me.fields.size.el, me.fields.line_height.el]).hide();
							} else {
								$([me.fields.size.el, me.fields.line_height.el]).show();
								me.fields.size.set_value( me.sizes[value] );
								me.fields.line_height.set_value( me.line_heights[value] || '1.1' );
							}
							me.fields.color.set_value( me.colors[value] );
							me.fields.color.update_input_border_color(me.colors[value]);
						}
					}),
					typeface: new Field_Typeface_Chosen_Select({
						label: l10n.typeface,
						values: theme_fonts_collection.get_fonts_for_select(),
						default_value: me.typefaces['h1'],
						select_width: '225px',
						change: function () {
							var value = this.get_value(),
							element = me.current_element;
							if ( me.typefaces[element] != value ){
								me.typefaces[element] = value;
								me.styles[element] = Font_Model.get_default_variant(value);
								me.update_typography();
								me.update_styles_field();
							}
						}
					}),
					style: this.get_styles_field(),
					color: new Upfront.Views.Editor.Field.Color({
							label: l10n.color,
							default_value: me.colors['h1'],
							autoHide: true,
							spectrum: {
								choose: function (color) {
									var rgb = color.toRgb(),
										rgba_string = 'rgba('+rgb.r+','+rgb.g+','+rgb.b+','+color.alpha+')',
										element = me.current_element;
										rgba_string = color.get_is_theme_color() !== false ? color.theme_color: rgba_string;
									if ( me.colors[element] != rgba_string ){
										me.colors[element] = rgba_string;
										me.update_typography(color);
									}
								}
							}
					}),
					size: new Upfront.Views.Editor.Field.Number({
						label: l10n.size,
						min: 0,
						max: 100,
						suffix: 'px',
						default_value: me.sizes['h1'],
						change: function () {
							var value = this.get_value(),
								element = me.current_element;
							if ( me.sizes[element] != value ){
								me.sizes[element] = value;
								me.update_typography();
							}
						}
					}),
					line_height: new Upfront.Views.Editor.Field.Number({
						label: l10n.line_height,
						min: 0,
						max: 10,
						step: .1,
						default_value: me.line_heights['h1'],
						change: function () {
							var value = this.get_value(),
								element = me.current_element;
							if ( me.line_heights[element] != value ){
								me.line_heights[element] = value;
								me.update_typography();
							}
						}
					})
				};
			}
			this.$el.html('');
			this.$el.addClass('typography-panel');
			_.each( this.fields, function(field){
				field.render();
				field.delegateEvents();
			});
			this.$el.append([this.fields.start_font_manager.el, this.fields.element.el, this.fields.typeface.el]);
			$('.upfront-chosen-select', this.$el).chosen({
				width: '230px'
			});
			$wrap_left.append([this.fields.style.el, this.fields.size.el]);
			this.$el.append($wrap_left);
			$wrap_right.append([this.fields.color.el, this.fields.line_height.el]);
			this.$el.append($wrap_right);
			this.update_typography(undefined, true);
		},
		/*
		 * Style field needs some special treatment since options are completely changed
		 * on every element dropdown or typeface dropdown value change.
		 */
		update_styles_field: function() {
			this.fields.style.remove();
			this.fields.style = this.get_styles_field(this.typefaces[this.current_element]);
			this.fields.style.render();
			this.fields.style.delegateEvents();
			$('.upfront-typography-fields-left').prepend(this.fields.style.el);
		},
		get_styles_field: function(typeface) {
			var me = this;
			return new Field_Typeface_Style_Chosen_Select({
					label: l10n.weight_style,
					values: this.get_styles(),
					default_value: me.get_styles_field_default_value(),
					font_family: typeface,
					select_width: '120px',
					change: function () {
						var value = this.get_value(),
							element = me.current_element;
						if ( me.styles[element] != value ){
							me.styles[element] = value;
							me.update_typography();
						}
					},
					show: function (value) {
						me.fields.style.set_option_font(value);
					}
			});
		},
		get_styles_field_default_value: function() {
			var availableStyles = this.get_styles(),
				elementTypeface = this.typefaces[this.current_element],
				elementStyle = this.styles[this.current_element],
				style;

			if (elementStyle) {
				style = elementStyle;
			} else if (elementTypeface) {
				style = Font_Model.get_default_variant(elementTypeface);
			} else {
				style = 'regular';
			}

			// Make sure style is in available styles, this is needed because:
			// - regular is also noted as "400 normal" in system fonts
			// - italic is also noted as "400 italic" in system fonts
			if (style === 'regular' && !_.findWhere(availableStyles, { value: 'regular'}) && _.findWhere(availableStyles, { value: '400 normal'})) {
				style = '400 normal';
			} else if (style === '400 normal' && !_.findWhere(availableStyles, { value: '400 normal'}) && _.findWhere(availableStyles, { value: 'regular'})) {
				style = 'regular';
			}
			if (style === 'italic' && !_.findWhere(availableStyles, { value: 'italic'}) && _.findWhere(availableStyles, { value: '400 italic'})) {
				style = '400 italic';
			} else if (style === '400 italic' && !_.findWhere(availableStyles, { value: '400 italic'}) && _.findWhere(availableStyles, { value: 'italic'})) {
				style = 'italic';
			}

			return style;
		},
		get_styles: function() {
			var typography = this.typography,
				element = this.current_element,
				styles = [],
				variants;

			if (typography == false) typography = {};

			if (_.isUndefined(typography[element]) || _.isUndefined(typography[element].font_face)) typography[element] = { font_face: 'Arial' };

			variants = theme_fonts_collection.get_variants(typography[element].font_face);
			styles = [];
			_.each(variants, function(variant) {
				styles.push({ label: variant, value: variant });
			});
			return styles;
		},
		update_typography: function (color, updateSilently) {
			var me = this,
				css = [],
				breakpointCss = [],
				options = {};

			_.each(this.elements, function(element) {
				var rules = [],
					url,
					is_inline = _.contains(me.inline_elements, element),
					typeface = me.typefaces[element],
					font_rule_value = false,
					style = false,
					weight = false,
					selector = false,
					$this_el = $('.upfront-object-content ' + element ),
					font_family,
					style_base,
					theme_color_class;

				style_base = Font_Model.parse_variant(me.styles[element] || 'regular');
				weight = style_base.weight;
				style = style_base.style;

				if (typeface === '') {
					font_family = system_fonts_storage.get_fonts().models[0];// default to first system font
				}
				// Try to get font family from system fonts.
				if (_.isUndefined(font_family)) {
					font_family = system_fonts_storage.get_fonts().findWhere({family: typeface});
				}
				// Try to get font family from additional fonts
				if (_.isUndefined(font_family)) {
					font_family = theme_fonts_collection.get_additional_font(typeface);
				}
				if (_.isUndefined(font_family)) {
					// This is a Google font
					var ggfonts = google_fonts_storage.get_fonts();
					if (ggfonts && ggfonts.findWhere) {
						font_family = ggfonts.findWhere({family: typeface});
					}
					if (!font_family) return true; // Missing typeface family, pretend we're normal
					// If so, let's do this - load up the font
					url = '//fonts.googleapis.com/css?family=' + font_family.get('family').replace(/ /g, '+');
					if (400 !== parseInt("" + weight, 10) && 'inherit' !== weight) url += ':' + weight; // If not default weight, DO include the info
					$("head").append('<link href="' + url + '" rel="stylesheet" type="text/css" />');
				}

				font_rule_value = '"' + font_family.get('family') + '",' + font_family.get('category');

				 // Don't include "inherit", as that's the default
				if ('inherit' !== font_rule_value) {
					rules.push('font-family: ' + font_rule_value);
				}
				if ('inherit' !== weight) {
					rules.push('font-weight: ' + weight);
				}
				if ('inherit' !== style) {
					rules.push('font-style: ' + style);
				}

				if ( !is_inline ){
					rules.push('font-size: ' + me.sizes[element] + 'px');
					rules.push('line-height: ' + me.line_heights[element] + 'em');
				}

				if( !_.isEmpty(me.colors[element]) && Upfront.Views.Theme_Colors.colors.is_theme_color( me.colors[element] ) ){
					 theme_color_class = Upfront.Views.Theme_Colors.colors.get_css_class( me.colors[element]);
				} else {
					rules.push('color: ' + me.colors[element]);
				}
				if ('blockquote' === element) {
					selector = '.upfront-object-content blockquote, .upfront-object-content blockquote p';
				} else if ('a' === element) {
					selector = '.upfront-object-content:not(.upfront-output-button):not(.upfront-output-ubutton):not(.upfront-output-unewnavigation) a, .upfront-object-content:not(.upfront-output-button):not(.upfront-output-ubutton):not(.upfront-output-unewnavigation) a:link, .upfront-object-content:not(.upfront-output-button):not(.upfront-output-ubutton):not(.upfront-output-unewnavigation) a:visited';
				} else {
					selector = '.upfront-object-content ' + element  + ', .upfront-ui ' + element + '.tag-list-tag';
				}
				css.push(selector + '{ ' + rules.join("; ") + '; }');

				if (_.contains(['tablet', 'mobile'], me.model.get('id'))) {
					breakpointCss.push('.' + me.model.get('id') + '-breakpoint ' + selector + '{ ' + rules.join("; ") + '; }');
				}

				options[element] = {
					weight: weight,
					style: style,
					size: !is_inline ? me.sizes[element] : false,
					line_height: !is_inline ? (me.line_heights[element] || '1.1') : false,
					font_face: font_family.get('family'),
					font_family: font_family.get('category'), //todo this font_family is inconsistent. It should be called font_category
					color: me.colors[element],
					theme_color_class : theme_color_class
				};
			});
			this.update_typography_elements();
			// Update silently when update_typography is called from on_render, otherwise
			// though tablet/mobile breakpoints do not have typography defined it will be
			// written to theme/db with defaults. This happens because for typography sidebar
			// to show something we have to load defaults (which is explained in initialize method),
			// so even if breakpoint does not have anything defined we have to load defaults from
			// next wider breakpoint to show what gets applied to current breakpoint.
			if (!updateSilently) {
				this.model.set_property('typography', options);
				this.typography = options;
			}
			if (_.contains(['tablet', 'mobile'], this.model.get('id'))) {
				var styleId = this.model.get('id') + '-breakpoint-typography';
				var cssText = breakpointCss.join("\n");

				if ( $('#' + styleId).length ) {
					$('#' + styleId).html(cssText);
				} else {
					$('body').find('style').first().before('<style id="' + styleId + '">' + cssText + '</style>');
				}
			} else {
				if ( $('head').find('#upfront-default-typography-inline').length ) {
					$('head').find('#upfront-default-typography-inline').html( css.join("\n") );
				} else {
					$('<style id="upfront-default-typography-inline">' +css.join("\n") + '</style>').insertAfter($('head').find('link[rel="stylesheet"]').first());
				}
			}
		},
		update_typography_elements: function (view) {
			var me = this;
			var css = [],
				$style = false
			;
			$style = $("style#typography-colors");
			if (!$style.length) {
				$("body").append('<style id="typography-colors" />');
				$style = $("style#typography-colors");
			}
			_.each(this.elements, function (element) {
				if (me.colors[element]) {
                    css.push('.upfront-object-content ' + element + '{ color:' + Upfront.Util.colors.to_color_value(me.colors[element]) + '; }');
                }
			});
			$style.empty().append(css.join("\n"));
		}
	});

	var SidebarPanel_Settings_Section_Typography = SidebarPanel_Settings_Section.extend({
		initialize: function () {
			this.settings = _([
			    new SidebarPanel_Settings_Item_Typography_Editor({"model": this.model})
			]);

			//if (!Upfront.mainData.userDoneFontsIntro) return;

			this.edit_css = new Command_EditCustomCSS({"model": this.model});
			this.edit_background = new Command_EditLayoutBackground({"model": this.model});
			this.edit_global_regions = new Command_EditGlobalRegions({"model": this.model});
			if ( Upfront.Application.get_current() == Upfront.Settings.Application.MODE.THEME ) {
				this.edit_structure = new Command_EditStructure({"model": this.model});
			}
		},
		get_title: function () {
			return l10n.typography;
		},
		on_render: function () {
			this.$el.find('.panel-section-content').addClass('typography-section-content');

			//if (!Upfront.mainData.userDoneFontsIntro) return;

			this.edit_css.render();
			this.edit_css.delegateEvents();
			this.$el.find('.panel-section-content').append(this.edit_css.el);
			if ( Upfront.Application.get_current() == Upfront.Settings.Application.MODE.THEME ) {
				this.edit_structure.render();
				this.edit_structure.delegateEvents();
				this.$el.find('.panel-section-content').append(this.edit_structure.el);
			}
			this.edit_background.render();
			this.edit_background.delegateEvents();
			this.$el.find('.panel-section-content').append(this.edit_background.el);
			this.edit_global_regions.render();
			this.edit_global_regions.delegateEvents();
			this.$el.find('.panel-section-content').append(this.edit_global_regions.el);
		}
	});

	var SidebarPanel_Responsive_Settings_Section_Typography = SidebarPanel_Settings_Section.extend({
		initialize: function () {
			this.settings = _([
					new SidebarPanel_Settings_Item_Typography_Editor({"model": this.model})
			]);
			this.edit_css = new Command_GeneralEditCustomCSS({"model": this.model});
		},
		get_title: function () {
			return l10n.typography_and_colors;
		},
		on_render: function () {
			this.edit_css.render();
			this.edit_css.delegateEvents();
			this.$el.find('.panel-section-content').append(this.edit_css.el);
		}
	});

    var Theme_Color = Backbone.Model.extend({
        defaults : {
            color : "",
            prev : "",
            highlight : "",
            shade : "",
            selected : "",
            luminance : "",
            alpha: 1
        },
        get_hover_color : function(){
            var self = this;
            if( this.get("selected") !== "" ){
                return  this.get( self.get("selected") );
            }
            return this.get("color") === '#000000' && this.get("alpha") == 0 ? 'inherit' : this.get("color");
        }
    });
    var Theme_Colors_Collection = Backbone.Collection.extend({
        model : Theme_Color,
        get_colors : function(){
            return this.pluck("color") ? this.pluck("color") : [];
        },
        is_theme_color : function(color){
            color = this.color_to_hex( color );
            return _.indexOf(this.get_colors(), color) !== -1 ? _.indexOf(this.get_colors(), color) + 1 /* <== indexOf can easily return 0 :( */ : false;
        },
        get_css_class : function(color, bg){
            color = this.color_to_hex( color );
            var prefix = _.isUndefined( bg ) || bg === false ? "upfront_theme_color_" : "upfront_theme_bg_color_";
            if( this.is_theme_color(color) ){
                var model = this.findWhere({
                    color : color
                });
                if( model ){
                    var index = this.indexOf( model );
                    return prefix + index;
                }
            }
            return false
        },
        get_all_classes : function( bg ){
        	var prefix = _.isUndefined( bg ) || bg === false ? "upfront_theme_color_" : "upfront_theme_bg_color_";
            var classes = [];
            _.each( this.get_colors(), function(item, index){
                classes.push(prefix + index);
            });
            return classes;
        },
        remove_theme_color_classes :  function( $el, bg ){
            _.each(this.get_all_classes( bg ), function(cls){
                $el.removeClass(cls);
            });
        },
        color_to_hex : function(color) {
        	if( typeof tinycolor === "function" ){
        		color = tinycolor(color);
                return color.toHexString() === '#000000' && color.alpha == 0 ? 'inherit' : color.toHexString();
        	}

            if (color.substr(0, 1) === '#') {
                return color;
            }
            color = color.replace(/\s+/g, '');
            var digits = /(.*?)rgb\((\d+),(\d+),(\d+)\)/.exec(color);
            digits = _.isEmpty(digits) ?  /(.*?)rgba\((\d+),(\d+),(\d+),([0-9.]+)\)/.exec(color) : digits;
            var red = parseInt(digits[2]);
            var green = parseInt(digits[3]);
            var blue = parseInt(digits[4]);

            var rgb = blue | (green << 8) | (red << 16);
            return digits[1] + '#' + rgb.toString(16);
        }
    });
    var Theme_Colors = {
        colors : new Theme_Colors_Collection(Upfront.mainData.themeColors.colors),
        range  : Upfront.mainData.themeColors.range || 0
    };
    var SidebarPanel_Settings_Item_Colors_Editor = SidebarPanel_Settings_Item.extend({
        initialize : function(){
            var self = this;
            this.template = _.template(_Upfront_Templates.sidebar_settings_theme_colors);
            //this.bottomTemplate = _.template( $(_Upfront_Templates.sidebar_settings_theme_colors).find(".panel-setting-theme-colors-bottom").html() );
            Upfront.Events.on("command:layout:save", this.on_save, this);
            Upfront.Events.on("command:layout:save_as", this.on_save, this);
            if (Upfront.Settings.Application.NO_SAVE) Upfront.Events.on("preview:build:start", this.on_save, this); // Also build colors on preview, only in anonymous mode
            this.update_styles();
            Theme_Colors.colors.bind('change reset add', this.update_styles, this);
        },
        events : {
          "change .panel-setting-theme-colors-shades-range": "change_range",
          "click .theme-colors-color-box" : "select_variation"
        },
        on_save : function(){
            var post_data = {
                action: 'upfront_update_theme_colors',
                theme_colors: Theme_Colors.colors.toJSON(),
                range : Theme_Colors.range
            };

            Upfront.Util.post(post_data)
                .error(function(){
                    return notifier.addMessage(l10n.theme_colors_save_fail);
            });
            var styles_post_data = {
                action: 'upfront_save_theme_colors_styles',
                styles: this.styles
            };
            Upfront.Util.post(styles_post_data)
                .error(function(){
                    return notifier.addMessage(l10n.theme_color_style_save_fail);
            });

        },
        update_styles : function(){
            // Update the styles
            this.styles = "";
            var self = this;
            Theme_Colors.colors.each(function( item, index ){
                var color = item.get("color") === '#000000' && item.get("alpha") == 0 ? 'inherit' : item.get("color");
                self.styles += " .upfront_theme_color_" + index +"{ color: " + color + ";}";
                self.styles += " a .upfront_theme_color_" + index +":hover{ color: " + item.get_hover_color() + ";}";
                self.styles += " button .upfront_theme_color_" + index +":hover{ color: " + item.get_hover_color() + ";}";
                self.styles += " .upfront_theme_bg_color_" + index +"{ background-color: " + color + ";}";
                self.styles += " a .upfront_theme_bg_color_" + index +":hover{ background-color: " + item.get_hover_color() + ";}";
                self.styles += " button .upfront_theme_bg_color_" + index +":hover{ background-color: " + item.get_hover_color() + ";}";
				Upfront.Util.colors.update_colors_in_dom(item.get("prev"), color, index);
            });
            $("#upfront_theme_colors_dom_styles").remove();
            $("<style id='upfront_theme_colors_dom_styles' type='text/css'>" + this.styles + "</style>").appendTo("body");


			Upfront.Events.trigger("theme_colors:update");


        },
        on_render : function(){
            var self = this,
                unset_color_index;
            this.theme_colors = Theme_Colors,
            this.theme_color_range = Theme_Colors.range;
            this.$el.html( this.template({
                colors :  this.theme_colors.colors.toJSON(),
                range  :  Theme_Colors.range
            } ) );

            if( this.theme_colors.colors.length < 10 ){
                this.add_empty_picker(this.theme_colors.colors.length);
            }
            unset_color_index = this.theme_colors.colors.length + 1;
            while( unset_color_index < 10 ){
                this.add_unset_color(unset_color_index);
                unset_color_index++;
            }
            this.add_previous_pickers();
            this.add_slider();
        },
        add_empty_picker : function(index){
            var self = this,
                empty_picker = new Field_Color({
                className : 'upfront-field-wrap upfront-field-wrap-color sp-cf theme_color_swatch theme_color_swatch_empty',
                hide_label : true,
                default_value: '#ffffff',
                blank_alpha: 0,
                spectrum: {
                    choose: function (color) {
                    	if (!_.isObject(color)) return false;
                    	var value = empty_picker.get_value();
                        if (value && "undefined" !== typeof tinycolor) {
                        	color = tinycolor(value);
                        }
                        self.add_new_color(color);
                    },
                    change: function (color) {
                    	if (!_.isObject(color)) return false;
						empty_picker.update_input_val(color.toHexString())
                    }
                }
            });
            empty_picker.render();
            this.$(".theme_colors_empty_picker").html(empty_picker.$el)
                .prepend('<span class="theme-colors-color-name">ufc' + index + '</span>');
        },
        add_unset_color : function(index){
            this.$('#theme-colors-swatches').append(
                '<span class="theme_colors_unset_color">' +
                    '<span class="theme-colors-color-name">ufc' + index + '</span>' +
                    '<span class="theme-colors-color-no-color"><span></span></span>' +
                '</span>'
            );
        },
        add_previous_pickers : function(){
            var self = this;
            this.$(".theme-colors-color-picker").each(function(index){
                var picker = this,
                    $this = $(this),
                    color = $this.data("color"),
                    model = self.theme_colors.colors.at(index),
                    picker = new Field_Color({
                        className : 'upfront-field-wrap upfront-field-wrap-color sp-cf theme_color_swatch',
                        hide_label : true,
                        default_value: color,
                        blank_alpha: 0,
                        spectrum: {
                        	change: function (color) {
                                self.update_colors(this, color, index);
                        	},
                            move: function (color) {
	                            picker.$(".sp-preview").css({
                                    backgroundColor : color.toRgbString(),
                                    backgroundImage : "none"
                                });
                        	},
                        	hide: function (color) {
	                            picker.$(".sp-preview").css({
                                    backgroundColor : color.toRgbString(),
                                    backgroundImage : "none"
                                });
                        	}
                        }
                    });
                picker.render();
                picker.$(".sp-preview").css({
                    backgroundColor : color,
                    backgroundImage : "none"
                });
                if( model.get( 'color' ) === '#000000' && model.get( 'alpha' ) == 0 ) {
                    picker.$(".sp-preview").addClass( 'uf-unset-color' );
                }
                else {
                    picker.$(".sp-preview").removeClass( 'uf-unset-color' );
                }
                $this.html( picker.$el );
                $this.prepend('<span class="theme-colors-color-name">ufc' + index + '</span>')
           });
        },
        add_new_color : function( color ){
            var percentage = parseInt( Theme_Colors.range, 10) / 100 || 0;

            var self = this,
                model = this.theme_colors.colors.add({
                    color : color.toHexString(),
                    prev : color.toHexString(),
                    highlight : self.color_luminance( color.toHex(), percentage ),
                    shade : self.color_luminance( color.toHex(), (percentage * -1) ),
                    alpha: color.alpha
                }),
                new_color_picker = new Field_Color({
                    className : 'upfront-field-wrap upfront-field-wrap-color sp-cf theme_color_swatch theme-colors-color-picker',
                    hide_label : true,
                    default_value: color.toRgbString(),
                    blank_alpha: 0,
                    change: function (color){
                        var percentage = parseInt( Theme_Colors.range, 10) / 100 || 0;
                        color = tinycolor( color );
                        model.set({
                            color : color.toHexString(),
                            highlight : self.color_luminance( color.toHex(), percentage ),
                            shade : self.color_luminance( color.toHex(), (percentage * -1) ),
                            alpha: color.alpha
                        });
                        $(this).parent().find(".sp-preview").css({
                            backgroundColor : color.toRgbString(),
                            backgroundImage : "none"
                        });
                        this.default_value = color.toRgbString();
                        self.render_bottom();
                    }
                }),
                colorIndex = Theme_Colors.colors.length - 1,
                $wrapper = $('<span class="theme-colors-color-picker color-' + colorIndex + '" data-index="' + colorIndex + '" data-color="' + color.toHexString() + '"><span class="theme-colors-color-name">ufc' + colorIndex + '</span></span>')
            ;

            new_color_picker.render();
            new_color_picker.$(".sp-preview").css({
                backgroundColor : color.toRgbString(),
                backgroundImage : "none"
            });
            if( color.toHexString() === '#000000' && color.alpha == 0 ) {
                new_color_picker.$(".sp-preview").addClass( 'uf-unset-color' );
            }
            else {
                new_color_picker.$(".sp-preview").removeClass( 'uf-unset-color' );
            }
            $wrapper.append(new_color_picker.$el);

            this.$(".theme_colors_empty_picker").before($wrapper);
            this.$(".theme_colors_empty_picker").next().remove();

            this.$(".theme_colors_empty_picker").find('.theme-colors-color-name').html( 'ufc' + ( colorIndex + 1 ) );

            this.$(".theme_colors_empty_picker").find('.sp-preview').css({
                backgroundColor: 'inherit'
            });

            if ( Theme_Colors.colors.length === 10 ) {
                this.$(".theme_colors_empty_picker").remove();
            }
            this.$("#theme-colors-no-color-notice").hide();
            this.render_bottom();
			this.on_save();
        },
        render_bottom : function(){
			return;
            this.$(".panel-setting-theme-colors-bottom").html(
                this.bottomTemplate( {
                    colors : Theme_Colors.colors.toJSON(),
                    range  : Theme_Colors.range
                } )
            );
            this.add_slider();
        },
        color_luminance : function (hex, lum) {
            // validate hex string
            hex = String(hex).replace(/[^0-9a-f]/gi, '');
            if (hex.length < 6) {
                hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
            }
            lum = lum || 0;
            // convert to decimal and change luminosity
            var rgb = "#", c, i;
            for (i = 0; i < 3; i++) {
                c = parseInt(hex.substr(i*2,2), 16);
                c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
                rgb += ("00"+c).substr(c.length);
            }
            return rgb;
        },
        change_range : function(range){
            var self = this;
            Theme_Colors.range = range;
            percentage = parseInt( range, 10 ) / 100 || 0;
            Theme_Colors.colors.each(function(model){
                var original_color = model.get("color");
                model.set("highlight", self.color_luminance( original_color, percentage ));
                model.set("shade", self.color_luminance( original_color, (percentage * -1) ));
            });
            this.render_bottom();
        },
        select_variation : function(e){
            var self = this,
                $this = $(e.target),
                type = $this.data("type"),
                index = $this.data("index"),
                color = $this.data("color"),
                model = Theme_Colors.colors.at(index);
            if( model.get("selected") ){
                model.set("selected", "");
                model.set("luminance", self.luminance( color ) );
            }else{
                model.set("selected", type);
                model.set("luminance", self.luminance( color ) );
            }
            this.render_bottom();
        },
        luminance : function(color){
            color = color.substring(1);
            var rgb = parseInt(color, 16);
            var r = (rgb >> 16) & 0xff;
            var g = (rgb >>  8) & 0xff;
            var b = (rgb >>  0) & 0xff;

            var luma = 0.2126 * r + 0.7152 * g + 0.0722 * b;
            return (luma < 80) ? "dark" : "light";
        },
        add_slider : function(){
            var self = this;
            this.$(".panel-setting-theme-colors-shades-range").slider({
                value :  Theme_Colors.range,
                min : 0,
                max : 50,
                change: function( event, ui ) {
                    self.change_range(ui.value);
                }
            });
        },
        update_colors : function(picker, color, index){
            var model = Theme_Colors.colors.at(index),
                percentage = parseInt( Theme_Colors.range, 10) / 100 || 0;
            if( model ){
                model.set({
                    color : color.toHexString(),
                    prev : model.get("color"),
                    highlight : this.color_luminance( color.toHex(), percentage ),
                    shade : this.color_luminance( color.toHex(), (percentage * -1) ),
                    alpha : color.alpha
                });
                $(picker).parent().find(".sp-preview").css({
                    backgroundColor : color.toRgbString(),
                    backgroundImage : "none"
                });
                if( color.toHexString() === '#000000' && color.alpha == 0 ) {
                    $(picker).parent().find(".sp-preview").addClass( 'uf-unset-color' );
                }
                else {
                    $(picker).parent().find(".sp-preview").removeClass( 'uf-unset-color' );
                }
                picker.default_value = color.toRgbString();
                this.render_bottom();
            }
        }
    });
    var SidebarPanel_Settings_Section_Colors = SidebarPanel_Settings_Section.extend({
        initialize: function () {
            this.settings = _([]);
            this.edit_colors = new SidebarPanel_Settings_Item_Colors_Editor({"model": this.model});
        },
        get_title: function () {
            return l10n.colors_section;
        },
        on_render: function () {
            this.edit_colors.render();
            this.edit_colors.delegateEvents();
            this.$el.find('.panel-section-content').append(this.edit_colors.el);
			this.$el.addClass('colors-panel-section');
        }
    });
	var SidebarPanel_Settings = SidebarPanel.extend({
		"className": "sidebar-panel sidebar-panel-settings",
		initialize: function () {
			this.active = true;
			this.sections = _([
				new SidebarPanel_Settings_Section_Typography({"model": this.model}),
				new SidebarPanel_Settings_Section_Colors({"model": this.model})
			]);
		},
		get_title: function () {
			return l10n.theme_settings;
		},
		on_render: function () {
			var me = this;
			if( this.sections){
					me.$el.find('.sidebar-panel-title').after("<ul class='sidebar-panel-tabspane'></ul>");
			}
			this.sections.each(function (section) {
					section.render();
					me.$el.find('.sidebar-panel-tabspane').append( "<li data-target='" + section.cid +  "' class='sidebar-panel-tab'>" +  section.get_title() +  "</li>");
					me.$el.find('.sidebar-panel-content').append("<div class='sidebar-tab-content' id='" + section.cid +"'></div>");
					me.$el.find(".sidebar-panel-content").find(".sidebar-tab-content").last().html(section.el);
			});
			if ( Upfront.Application.get_current() == Upfront.Settings.Application.MODE.THEME )
				this.$el.find('.sidebar-panel-title').trigger('click');
		}
	});

	var SidebarPanels = Backbone.View.extend({
		"tagName": "ul",
		"className": "sidebar-panels",
		initialize: function () {
			this.panels = {
				posts: new SidebarPanel_Posts({"model": this.model}),
				elements: new SidebarPanel_DraggableElements({"model": this.model}),
				settings: new SidebarPanel_Settings({"model": this.model})
			};
			// Dev feature only
			//if ( Upfront.Settings.Debug.dev )
			//	this.panels.settings = new SidebarPanel_Settings({"model": this.model});
		},
		render: function () {
			var me = this;
			_.each(this.panels, function(panel){
				panel.render();
				me.$el.append(panel.el);
				panel.delegateEvents();
			});
		}
	});

	var SidebarCommands_PrimaryPostType = Commands.extend({
		"className": "sidebar-commands sidebar-commands-primary clearfix",
		initialize: function () {
			this.commands = _([]);
			if (Upfront.Settings.Application.MODE.ALLOW.match(Upfront.Settings.Application.MODE.CONTENT)) {
				this.commands.push(new Command_NewPost({"model": this.model}));
				this.commands.push(new Command_NewPage({"model": this.model}));
			}
			this.commands.push(new Command_PopupList({"model": this.model}));
			this.commands.push(new Command_OpenMediaGallery());
		}
	});

	/**
	 * DEPRECATED
	 */
	var SidebarCommands_PrimaryLayout = Commands.extend({
		"className": "sidebar-commands sidebar-commands-primary clearfix",
		initialize: function () {
			this.commands = _([
				new Command_ThemesDropdown({"model": this.model}),
			]);
			if ( Upfront.themeExporter.currentTheme !== 'upfront') {
				this.commands.push(new Command_NewLayout({"model": this.model}));
				this.commands.push(new Command_BrowseLayout({"model": this.model}));
			}
		}
	});

	var SidebarCommands_AdditionalPostType = Commands.extend({
		"className": "sidebar-commands sidebar-commands-additional",
		initialize: function () {
			this.commands = _([]);
		},
		render: function () {

		}

	});

	var SidebarCommands_Control = Commands.extend({
		className: function() {
			 var className = "sidebar-commands sidebar-commands-control";
			 if (Upfront.Application.get_current() === Upfront.Settings.Application.MODE.THEME) {
				className += ' sidebar-commands-theme';
			 }
			 return className;
		},
		initialize: function () {
		  var MODE = Upfront.Settings.Application.MODE;
			var current_app = Upfront.Application.get_current();

			if ( current_app !== MODE.THEME ) {
				this.commands = _([
					new Command_Undo({"model": this.model}),
					new Command_Redo({"model": this.model}),
					new Command_ToggleGrid({"model": this.model}),
				]);
			} else {
				this.commands = _([
					new Command_ToggleGrid({"model": this.model}),
				]);
			}

			if (MODE.ALLOW.match(MODE.RESPONSIVE) && current_app === MODE.THEME) {
				this.commands.push(
					new Command_CreateResponsiveLayouts({model: this.model})
				);
			}
			if ( current_app == MODE.THEME ) {
				this.commands.push(new Command_ExportLayout({"model": this.model}));
			}
			if (!Upfront.Settings.Application.NO_SAVE && current_app !== MODE.THEME) {
				this.commands.push(new Command_SaveLayout({"model": this.model}));
			} else if (current_app !== MODE.THEME && Upfront.Settings.Application.PERMS.REVISIONS) {
				this.commands.push(new Command_PreviewLayout({"model": this.model}));
			}
			if (MODE.ALLOW.match(MODE.RESPONSIVE) && current_app !== MODE.THEME) {
				this.commands.push(
					new Command_StartResponsiveMode({model: this.model})
				);
			}
			// Dev feature only
			if ( Upfront.Settings.Debug.dev ) {
				if (!Upfront.Settings.Application.NO_SAVE && current_app !== MODE.THEME) {
					this.commands.push(new Command_ResetEverything({"model": this.model}));
				}
				//if (current_app !== MODE.THEME) this.commands.push(new Command_ToggleMode({"model": this.model}));
				if (!Upfront.Settings.Application.DEBUG && current_app !== MODE.THEME && !Upfront.Settings.Application.NO_SAVE) {
					this.commands.push(new Command_PublishLayout({"model": this.model}));
				}
			}
		}
	});

	var SidebarCommands_Header = Commands.extend({
		className: "sidebar-commands sidebar-commands-header",
		initialize: function () {
			this.commands = _([
				new Command_Logo({"model": this.model}),
			]);
			//if ( !Upfront.Settings.Application.NO_SAVE ) this.commands.push(new Command_Exit({"model": this.model}));
			this.commands.push(new Command_Exit({"model": this.model})); // *Always* show exit
		}
	});

	/* Responsive */
	var SidebarPanel_ResponsiveSettings = Backbone.View.extend({
		tagName: 'li',
		className: 'sidebar-panel sidebar-panel-settings expanded',
		template: '<div class="sidebar-panel-content"></div>',
		initialize: function() {
			this.collection = breakpoints_storage.get_breakpoints();
			this.listenTo(this.collection, 'change:active', this.render);
		},
		render: function() {
			var breakpoint_model = breakpoints_storage.get_breakpoints().get_active();

			if(breakpoint_model.get('default'))
				this.model.attributes.id = 'default';

			var typography_section = new SidebarPanel_Responsive_Settings_Section_Typography({
				"model": breakpoint_model.get('default') ? this.model : breakpoint_model // If default, use layout model instead
			});

			typography_section.render();

			this.$el.html(this.template);
			this.$el.find('.sidebar-panel-content').html(typography_section.el);
		}
	});

	var SidebarCommands_Responsive = Backbone.View.extend({
		tagName: 'ul',
		className: 'sidebar-commands sidebar-commands-responsive',
		initialize: function () {
			this.views = [
				new Command_BreakpointDropdown(),
				new Command_AddCustomBreakpoint()
			];
			/*
			if ("themeExporter" in Upfront) {
				this.views.push(new ResponsiveCommand_BrowseLayout());
			}
			*/
			this.views.push(new SidebarPanel_ResponsiveSettings({"model": this.model}));
		},
		render: function() {
			_.each(this.views, function(view) {
				view.render();
				this.$el.append(view.el);
			}, this);

			return this;
		},
		destroy: function() {
			this.remove();
			_.each(this.views, function(view) {
				view.remove();
			});
		}
	});

	var SidebarCommands_ResponsiveControl = Commands.extend({
		"className": "sidebar-commands sidebar-commands-responsive-control sidebar-commands-control",
		initialize: function () {
			this.commands = _([
				new Command_ResponsiveUndo({"model": this.model}),
				new Command_ResponsiveRedo({"model": this.model}),
				new Command_ToggleGrid({"model": this.model}),
				new Command_SaveLayout(),
				new Command_StopResponsiveMode()
			]);
		},
		render: function () {
			this.$el.find("li").remove();
			this.commands.each(this.add_command, this);
		}
	});
	/* End Responsive */

	var SidebarProfile = Backbone.View.extend({
		className: "sidebar-profile",
		render: function () {
			var user = Upfront.data.currentUser;
			if ( !user ) user = new Backbone.Model();
			var data = user.get('data') || {},
				roles = user.get('roles') || [],
				tpl
			;
			tpl = '<div class="sidebar-profile-avatar"><img src="//www.gravatar.com/avatar/{{ gravatar ? gravatar : "gravatar" }}?s=25" /></div>' +
				'<div class="sidebar-profile-detail"><span class="sidebar-profile-name">{{name}}</span><span class="sidebar-profile-role">{{role}}</span></div>' +
				(roles.length ? '<div class="sidebar-profile-edit"><a class="upfront-icon upfront-icon-edit" data-bypass="true" title="'+  l10n.edit_profile +'" href="{{edit_url}}">' + l10n.edit_profile + '</a></div>' : '');
			this.$el.html(_.template(tpl,
				{
					gravatar: data.gravatar,
					name: data.display_name || l10n.anonymous,
					role: roles[0] || l10n.none,
					edit_url: Upfront.Settings.admin_url + 'profile.php'
				}
			));
		}
	});

	/*var SidebarEditorMode = Backbone.View.extend({
		"className": "sidebar-editor-mode",
		events: {
			"click .switch-mode-simple": "switch_simple",
			"click .switch-mode-advanced": "switch_advanced"
		},
		render: function () {
			this.$el.html(
				'<div class="sidebar-editor-mode-label">Editor mode:</div>' +
				'<div class="switch-mode-ui">' +
					'<span class="switch-mode switch-mode-simple">simple <i class="upfront-icon upfront-icon-simple"></i></span>' +
					'<span class="switch-slider"><span class="knob"></span></span>' +
					'<span class="switch-mode switch-mode-advanced">advanced <i class="upfront-icon upfront-icon-advanced"></i></span>' +
				'</div>'
			);
			this.switch_simple();
		},
		switch_simple: function () {
			this.$el.find('.switch-mode-simple').addClass('active');
			this.$el.find('.switch-mode-advanced').removeClass('active');
			this.$el.find('.switch-slider').removeClass('switch-slider-full');
		},
		switch_advanced: function () {
			this.$el.find('.switch-mode-advanced').addClass('active');
			this.$el.find('.switch-mode-simple').removeClass('active');
			this.$el.find('.switch-slider').addClass('switch-slider-full');
		}
	});*/

	var Sidebar = Backbone.View.extend({
		"tagName": "div",
		visible: 1,
		events: {
			'click #sidebar-ui-toggler-handle': 'toggleSidebar'
		},
		initialize: function () {
			var is_theme = Upfront.Application.get_current() == Upfront.Settings.Application.MODE.THEME;
			//this.editor_mode = new SidebarEditorMode({"model": this.model});
			this.sidebar_profile = new SidebarProfile({"model": this.model});
			this.sidebar_commands = {
				header: new SidebarCommands_Header({"model": this.model}),
				primary: is_theme ? new SidebarCommands_PrimaryLayout({"model": this.model}) : new SidebarCommands_PrimaryPostType({"model": this.model}), // DEPRECATED
				additional: is_theme ? false : new SidebarCommands_AdditionalPostType({"model": this.model}), // DEPRECATED
				control: new SidebarCommands_Control({"model": this.model}),
				responsive: new SidebarCommands_Responsive({"model": this.model})
			};
			this.sidebar_panels = new SidebarPanels({"model": this.model});

			this.fetch_current_user();

			if ( Upfront.Application.get_current() != Upfront.Settings.Application.MODE.CONTENT ){
				Upfront.Events.on('upfront:element:edit:start', this.preventUsage, this);
				Upfront.Events.on('upfront:element:edit:stop', this.allowUsage, this);
			}
			Upfront.Events.on("application:mode:after_switch", this.render, this);
			Upfront.Events.on("application:user:fetch", this.render, this); // Re-build when we're ready
		},
		preventUsage: function(type) {
			var preventUsageText = l10n.not_available_in_text_edit;
			if (type === 'media-upload') {
				preventUsageText = l10n.not_available_in_media_upload;
			}
	 		if (type === 'write') {
				this.writingIsOn = true;
				preventUsageText = l10n.publish_first_nag;
			}
			if (!this.prevented_usage_type) this.prevented_usage_type = type; // don't stack up on prevented types, keep the original
			$('#preventUsageOverlay span').html(preventUsageText);
			$('#preventUsageOverlay').show();
		},
		allowUsage: function(type) {
			if (this.writingIsOn && type !== 'write') {
				this.preventUsage('write');
				return;
			}
			this.prevented_usage_type = false;
			this.writingIsOn = false;
			$('#preventUsageOverlay').hide();
		},
		render: function () {
			var current_app = Upfront.Application.get_current();
			var is_responsive_app = current_app === Upfront.Settings.Application.MODE.RESPONSIVE;
			var output = $('<div id="sidebar-ui-wrapper" class="upfront-ui"></div>');
			if ( current_app == Upfront.Settings.Application.MODE.THEME ) {
				output.addClass('create-theme-sidebar');
			}

			// Header
			this.sidebar_commands.header.render();
			output.append(this.sidebar_commands.header.el);

			// Editor Mode
			//this.editor_mode.render();
			//this.$el.append(this.editor_mode.el);

			if ( current_app !== Upfront.Settings.Application.MODE.THEME && !is_responsive_app) {
				// Profile
				this.sidebar_profile.render();
				output.append(this.sidebar_profile.el);
			}

			// Primary commands
			if ( !is_responsive_app ) {
				this.sidebar_commands.primary.render();
				output.append(this.sidebar_commands.primary.el);
			}

			if ( this.sidebar_commands.additional && !is_responsive_app ) {
				// Additional commands
				this.sidebar_commands.additional.render();
				output.append(this.sidebar_commands.additional.el);
			}

			// Responsive
			if ( is_responsive_app ) {
				this.sidebar_commands.responsive.render();
				output.append(this.sidebar_commands.responsive.el);
			}

			if ( current_app !== Upfront.Settings.Application.MODE.CONTENT && !is_responsive_app ) {
				// Sidebar panels
				this.sidebar_panels.render();
				output.append(this.sidebar_panels.el);
				// Control
				this.sidebar_commands.control.render();
				output.append(this.sidebar_commands.control.el);

				output.append('<div id="preventUsageOverlay"><span></span></div>');
			} else if (is_responsive_app) {
				// Responsvie Control
				var responsive_controls = new SidebarCommands_ResponsiveControl({"model": this.model});
				responsive_controls.render();
				output.append(responsive_controls.el);
			}

			this.$el.html(output);

			Upfront.Events.trigger('sidebar:rendered');
		},
		get_panel: function ( panel ) {
			if ( ! this.sidebar_panels.panels[panel] )
				return false;
			return this.sidebar_panels.panels[panel];
		},
		get_commands: function ( commands ) {
			if ( ! this.sidebar_commands[commands] )
				return false;
			return this.sidebar_commands[commands];
		},
		to_content_editor: function () {
			/*
			var panel = this.sidebar_panels.panels.posts,
				post_model = Upfront.data.currentPost
			;
			if(!panel.commands){
				panel.commands = _([
					new Command_PopupStatus({"model": post_model}),
					new Command_PopupVisibility({"model": post_model}),
					new Command_PopupSchedule({model: post_model}),

					new Command_PopupTax({"model": this.model}),
					new Command_PopupSlug({"model": this.model}),
					//new Command_PopupMeta({"model": this.model}),
					new Command_SaveDraft({"model": this.model}),
					new Command_SavePublish({"model": this.model}),
					new Command_Trash({"model": this.model})
				]);
				panel.render();
			}
			else
				panel.show();

			panel.$el.find(".sidebar-panel-title").trigger("click");
			*/
			//console.log("to_content_editor got called");
		},
		from_content_editor: function () {
			/*
			var panel = this.sidebar_panels.panels.posts;
			//panel.commands = _([]);
			panel.hide();//render();
			$(".sidebar-panel-title.upfront-icon.upfront-icon-panel-elements").trigger("click");
			*/
			//console.log("from_content_editor got called")
		},
		fetch_current_user: function() {
			var user = Upfront.data.currentUser;

			if(!user){
				user = new Upfront.Models.User();
				Upfront.data.loading.currentUser = user.fetch().done(function(){
					Upfront.data.currentUser = user;
					Upfront.Events.trigger("application:user:fetch");
				});
			}
		},
		addCollapsibleEvents: function(){
			var me = this;
			this.$el.append('<div id="sidebar-ui-toggler"><div id="sidebar-ui-toggler-handle" class="sidebar-ui-hide"></div></div>');
			$('body').on('mousemove', function(e){
				if(me.visible * 300 + 100 > e.pageX){
					if(!me.collapsibleHint){
						$('#sidebar-ui-toggler').fadeIn();
						me.collapsibleHint = true;
					}
				}
				else {
					if(me.collapsibleHint){
						$('#sidebar-ui-toggler').fadeOut();
						me.collapsibleHint = false;
					}
				}
			});

			this.resizeCollapseHandle();
			$(window).on('resize', function(){
				me.resizeCollapseHandle();
			});
		},

		resizeCollapseHandle: function(){
			var height = $(window).height();
			this.$('#sidebar-ui-toggler').height(height);
		},

		toggleSidebar: function(instant){
			var me = this;
			if(!this.visible){
				$('#sidebar-ui').removeClass('collapsed').stop().animate({width: '260px'}, 300);
				//Remove collapsed class always after region editor is closed
				$('#element-settings-sidebar').removeClass('collapsed');

				//Bring back element-settings only if it was opened before
				if($('#element-settings-sidebar').contents().length !== 0) {
					$('#element-settings-sidebar').removeClass('collapsed').stop().animate({width: '260px'}, 300);
				}

				$('#page').animate({'margin-left': '260px'}, 300, function(){ Upfront.Events.trigger('sidebar:toggle:done', me.visible); });
				this.$('#sidebar-ui-toggler-handle').removeClass().addClass('sidebar-ui-hide');
				this.visible = 1;
			}
			else {
				$('#sidebar-ui, #element-settings-sidebar').stop().animate({width: '0px'}, 300, function(){
					$('#sidebar-ui, #element-settings-sidebar').addClass('collapsed');
				});
				$('#page').animate({'margin-left': '0px'}, 300, function(){ Upfront.Events.trigger('sidebar:toggle:done', me.visible); });
				this.$('#sidebar-ui-toggler-handle').removeClass().addClass('sidebar-ui-show');
				this.visible = 0;
			}
			Upfront.Events.trigger('sidebar:toggle', this.visible);
		}

	});

	var ContentEditor_SidebarCommand = Command.extend({
		tagName: "div",
		className: "upfront-sidebar-content_editor-sidebar_command",
		post: false,
		initialize: function(){
			this.setPost();
			Upfront.Events.on("data:current_post:change", this.setPost, this);
		},
		setPost: function(){
			var currentPost = Upfront.data.currentPost;

			if(!currentPost)
				this.post = new Upfront.Models.Post({post_type: 'post', id: '0'});
			else if(!this.post || this.post.id !=  currentPost.id){
				this.post = Upfront.data.currentPost;
			    if(this.onPostChange)
			    	this.onPostChange();
			}

			return this;
		}
	});

	var Command_PopupList = ContentEditor_SidebarCommand.extend({
		tagName: 'li',
		className: 'command-popup-list',
		$popup: {},
		views: {},
		currentPanel: false,
		render: function () {
			this.$el.addClass("upfront-entity_list upfront-icon upfront-icon-browse");
			if ( Upfront.Application.get_current() == Upfront.Settings.Application.MODE.LAYOUT )
				this.$el.html('<a title="'+ l10n.posts_pages_comments +'">' + l10n.posts_pages_comments + '</a>');
			else
				this.$el.html('<a title="'+ l10n.posts_pages +'">' + l10n.posts_pages + '</a>');
		},
		on_click: function () {
			var me = this,
				popup = Upfront.Popup.open(function (data, $top, $bottom) {
					var $me = $(this);
					$me.empty()
						.append('<p class="upfront-popup-placeholder">' + l10n.popup_preloader + '</p>')
					;
					me.$popup = {
						"top": $top,
						"content": $me,
						"bottom": $bottom
					};
				})
			;
			var has_comments = false,
				current_post_id = Upfront.data.currentPost && Upfront.data.currentPost.id
					? Upfront.data.currentPost.id
					: _upfront_post_data.post_id
			;
			has_comments = !!current_post_id;
			if (current_post_id && Upfront.data.posts && Upfront.data.posts.length) {
				has_comments = Upfront.data.posts[current_post_id] && Upfront.data.posts[current_post_id].get
					? !!(parseInt(Upfront.data.posts[current_post_id].get("comment_count"), 10))
					: false
				;
			}
			me.$popup.top.html(
				'<ul class="upfront-tabs">' +
					'<li data-type="posts" class="active">' + l10n.posts + '</li>' +
					'<li data-type="pages">' + l10n.pages + '</li>' +
					(has_comments ? '<li data-type="comments">' + l10n.comments + '</li>' : '') +
				'</ul>' +
				me.$popup.top.html()
			).find('.upfront-tabs li').on("click", function () {
				me.dispatch_panel_creation(this);
			} );

			me.dispatch_panel_creation();

			popup.done(function () {
				Upfront.Events.off("upfront:posts:sort");
				Upfront.Events.off("upfront:posts:post:expand");
				Upfront.Events.off("upfront:pages:sort");
				Upfront.Events.off("upfront:comments:sort");
			});
		},
		dispatch_panel_creation: function (data) {
			var me = this,
				$el = data ? $(data) : me.$popup.top.find('.upfront-tabs li.active'),
				panel = $el.attr("data-type"),
				class_suffix = panel.charAt(0).toUpperCase() + panel.slice(1).toLowerCase(),
				send_data = data || {},
				collection = false,
				postId = this.post.id,
				fetchOptions = {}
			;

			me.$popup.top.find('.upfront-tabs li').removeClass('active');
			$el.addClass('active');

			this.currentPanel = panel;

			//Already loaded?
			if(me.views[panel]){
				if(panel != 'pages' && panel != 'posts') {
					if(panel != 'comments' || (Upfront.data.currentPost && Upfront.data.currentPost.id && me.views[panel].view.collection.postId == Upfront.data.currentPost.id))
						return this.render_panel(me.views[panel]);
				}
			}

			if(panel == 'posts'){
				collection = new Upfront.Collections.PostList([], {postType: 'post'});
				collection.orderby = 'post_date';
				fetchOptions = {filterContent: true, withAuthor: true, limit: 15}
			}
			else if(panel == 'pages'){
				collection = new Upfront.Collections.PostList([], {postType: 'page'});
				fetchOptions = {limit: 15}
			}
			else{
				var post_id = Upfront.data.currentPost && Upfront.data.currentPost.id
					? Upfront.data.currentPost.id
					: _upfront_post_data.post_id
				;
				collection = new Upfront.Collections.CommentList([], {postId: post_id});
				collection.orderby = 'comment_date';
			}

			collection.fetch(fetchOptions).done(function(response){
				switch(panel){
					case "posts":
						//Check if we have rendered the panel once
						var cachedElements = null;
						if(typeof me.views[panel] !== "undefined") {
							cachedElements = me.views[panel].view.collection.pagination.totalElements;
						}
						//Check collection total elements
						var collectionElements = collection.pagination.totalElements;

						//Compare total items, if same return cached panel
						if(cachedElements == collectionElements) {
							return me.render_panel(me.views[panel]);
						}

						collection.on('reset sort', me.render_panel, me);
						views = {
							view: new ContentEditorPosts({collection: collection, $popup: me.$popup}),
							search: new ContentEditorSearch({collection: collection}),
							pagination: new ContentEditorPagination({collection: collection})
						}
						me.views.posts = views;
						break;
					case "pages":
						//Check if we have rendered the panel once
						var cachedElements = null;
						if(typeof me.views[panel] !== "undefined") {
							cachedElements = me.views[panel].view.collection.pagination.totalElements;
						}
						//Check collection total elements
						var collectionElements = collection.pagination.totalElements;

						//Compare total items, if same return cached panel
						if(cachedElements == collectionElements) {
							return me.render_panel(me.views[panel]);
						}

						collection.on('reset sort', me.render_panel, me);
						views = {
							view: new ContentEditorPages({collection: collection, $popup: me.$popup}),
							search: new ContentEditorSearch({collection: collection}),
							pagination: new ContentEditorPagination({collection: collection})
						}
						me.views.pages = views;
						break;
					case "comments":
						collection.on('reset sort', me.render_panel, me);
						views = {
							view: new ContentEditorComments({collection: collection, $popup: me.$popup}),
							search: new ContentEditorSearch({collection: collection}),
							pagination: new ContentEditorPagination({collection: collection})
						}
						me.views.comments = views;
						break;
				}
				me.render_panel();
			});

			return false;
		},

		render_panel: function(){
			var me = this,
				views = this.views[this.currentPanel];

			views.view.render();
			me.$popup.content.html(views.view.$el);
			views.view.setElement(views.view.$el);

			me.$popup.bottom.empty();

			if (views.pagination) {
				views.pagination.render();
				me.$popup.bottom.html(views.pagination.$el);
				views.pagination.setElement(views.pagination.$el);
			}

			views.search.render();
			me.$popup.bottom.append(views.search.$el);
			views.search.setElement(views.search.$el);
		}
	});

	var Command_OpenMediaGallery = Command.extend({
		tagName: 'li',
		className: 'command-open-media-gallery upfront-icon upfront-icon-open-gallery',
		render: function () {
				this.$el.html('<a title="'+ l10n.media +'">' + l10n.media + '</a>');
		},
		on_click: function () {
			Upfront.Media.Manager.open({
				media_type: ["images", "videos", "audios", "other"]
			});
		}
	});

	var ContentEditorSearch = Backbone.View.extend({
		id: "upfront-entity_list-search",
		searchTpl: _.template($(_Upfront_Templates.popup).find('#upfront-search-tpl').html()),
		events: {
			"click #upfront-search_action": "dispatch_search_click",
			"keydown #upfront-list-search_input": "dispatch_search_enter"
		},
		render: function () {
			var query = this.collection.lastFetchOptions ? this.collection.lastFetchOptions.search : false;
			this.$el.html(this.searchTpl({query: query}));
		},
		dispatch_search_click: function (e) {
			if ($("#upfront-search_container").is(":visible"))
				return this.handle_search_request(e);
			else return this.handle_search_reveal(e);
		},
		dispatch_search_enter: function (e) {
			if(e.which == 13)
				return this.handle_search_request(e);
		},
		handle_search_request: function (e) {
			e.preventDefault();
			var text = $("#upfront-search_container input").val();
			this.collection.fetch({search: text});
		},
		handle_search_reveal: function () {
			$("#upfront-search_container").show();
		}
	});

	var ContentEditorPagination = Backbone.View.extend({
		paginationTpl: _.template($(_Upfront_Templates.popup).find('#upfront-pagination-tpl').html()),
		events: {
			"click .upfront-pagination_page-item": "handle_pagination_request",
			"click .upfront-pagination_item-next": "handle_next",
			"click .upfront-pagination_item-prev": "handle_prev",
			"click .upfront-pagination_page-item": "set_page",
			"keypress .upfront-pagination_page-current": "set_page_keypress",
		},
		initialize: function(opts){
			this.options = opts;
		},
		render: function () {

			this.$el.html(this.paginationTpl(this.collection.pagination));
		},
		handle_pagination_request: function (e, page) {
			var me = this,
				pagination = this.collection.pagination,
				page = page ? page : parseInt($(e.target).attr("data-page_idx"), 10) || 0
			;
			this.collection.fetchPage(page).
				done(function(response){
					me.collection.trigger('reset');
				});
		},
		handle_next: function(e) {
			var pagination = this.collection.pagination,
				nextPage = pagination.currentPage == pagination.pages - 1 ? false : pagination.currentPage + 1;

			if(nextPage)
				this.handle_pagination_request(e, nextPage);
		},
		handle_prev: function(e) {
			var pagination = this.collection.pagination,
				prevPage = pagination.currentPage == 0 ? false : pagination.currentPage - 1;

			if(prevPage !== false)
				this.handle_pagination_request(e, prevPage);
		},
		set_page: function (e) {
			e.preventDefault();
			e.stopPropagation();
			/*
			var me = this;
			this.collection.fetchPage($(e.target).data("idx")-1).
				done(function(response){
					me.collection.trigger('reset');
				});
			*/
			var page = this.collection.pagination.pages - 1;
			this.handle_pagination_request(e, page);
		},
		set_page_keypress: function (e) {
			//var me = this;
			e.stopPropagation();
			if (13 !== e.which) return true;

			var string = $.trim($(e.target).val()),
				num = parseInt(string, 10)
			;
			if (!num || num < 1) return false;
			if (num > this.collection.pagination.pages) num = this.collection.pagination.pages;
/*
			this.collection.fetchPage(num-1).
				done(function(response){
					me.collection.trigger('reset');
				});
*/
			this.handle_pagination_request(e, num-1);
		}
	});

	var ContentEditorPosts = Backbone.View.extend({
		className: "upfront-entity_list-posts bordered-bottom",
		postListTpl: _.template($(_Upfront_Templates.popup).find('#upfront-post-list-tpl').html()),
		postSingleTpl: _.template($(_Upfront_Templates.popup).find('#upfront-post-single-tpl').html()),
		paginationTpl: _.template($(_Upfront_Templates.popup).find('#upfront-pagination-tpl').html()),
		events: {
			"click #upfront-list-meta .upfront-list_item-component": "handle_sort_request",
			"click .editaction.edit": "handle_post_edit",
			"click .editaction.view": "handle_post_view",
			"click #upfront-list-page-path a.upfront-path-back": "handle_return_to_posts",
			"click .editaction.trash": "trash_post",
		},
		initialize: function(options){
			this.collection.on('change reset', this.render, this);
		},
		render: function () {
			this.$el.empty().append(
				this.postListTpl({
					posts: this.collection.getPage(this.collection.pagination.currentPage),
					orderby: this.collection.orderby,
					order: this.collection.order
				})
			);
			//this.mark_sort_order();
		},

		handle_sort_request: function (e) {
			var $option = $(e.target),
				sortby = $option.attr('data-sortby'),
				order = this.collection.order;
			if(sortby){
				if(sortby == this.collection.orderby)
					order = order == 'desc' ? 'asc' : 'desc';
				this.collection.reSort(sortby, order);
			}
		},
/*
		handle_post_reveal: function (e) {
			var me = this,
				postId = $(e.currentTarget).closest('.upfront-list_item-post').attr('data-post_id');

			e.preventDefault();

			me.$('#upfront-list').after(me.postSingleTpl({post: me.collection.get(postId)}));
			me.expand_post(me.collection.get(postId));
		},
*/
		handle_post_edit: function (e) {
			e.preventDefault();
			var postId = $(e.currentTarget).closest('.upfront-list_item-post').attr('data-post_id');
			Upfront.Application.navigate('/edit/post/' + postId, {trigger: true});
		},
		handle_post_view: function (e) {
			e.preventDefault();
			var postId = $(e.currentTarget).closest('.upfront-list_item-post').attr('data-post_id');
			window.location.href = this.collection.get(postId).get('permalink');
		},
		trash_post: function (e) {
			var me = this;
			var postelement = $(e.currentTarget).closest('.upfront-list_item-post.upfront-list_item');
			var postId = postelement.attr('data-post_id');
			if(confirm( Upfront.Settings.l10n.global.content.delete_confirm.replace(/%s/, this.collection.get(postId).get('post_type')))) {
				this.collection.get(postId).set('post_status', 'trash').save().done(function(){
					me.collection.remove(me.collection.get(postId));

				});
			}
		},
		expand_post: function(post){
			var me = this;
			if(!post.featuredImage){
				this.collection.post({action: 'get_post_extra', postId: post.id, thumbnail: true, thumbnailSize: 'medium'})
					.done(function(response){
						if(response.data.thumbnail && response.data.postId == post.id){
							me.$('#upfront-page_preview-featured_image img').attr('src', response.data.thumbnail[0]).show();
							me.$('.upfront-thumbnailinfo').hide();
							post.featuredImage = response.data.thumbnail[0];
						}
						else{
							me.$('.upfront-thumbnailinfo').text(l10n.no_image);
							me.$('.upfront-page_preview-edit_feature a').html('<i class="icon-plus"></i> ' + l10n.add);
						}

					})
				;
			}
			$("#upfront-list-page").show('slide', { direction: "right"}, 'fast');
			this.$el.find("#upfront-list").hide();
			$("#upfront-page_preview-edit button").one("click", function () {
				//window.location = Upfront.Settings.Content.edit.post + post.id;
				var path = '/edit/post/' + post.id;
				// Respect dev=true
				if (window.location.search.indexOf('dev=true') > -1) path += '?dev=true';
				Upfront.Popup.close();
				Upfront.Application.navigate(path, {trigger: true});
			});

			this.bottomContent = $('#upfront-popup-bottom').html();

			$('#upfront-popup-bottom').html(
				$('<a href="#" id="upfront-back_to_posts">' + l10n.back_to_posts + '</a>').on('click', function(e){
					me.handle_return_to_posts();
				})
			);
		},

		handle_return_to_posts: function () {
			var me = this;
			this.$el.find("#upfront-list").show('slide', { direction: "left"}, function(){
				me.collection.trigger('reset');
			});
			$("#upfront-list-page").hide();
		}
	});


	var ContentEditorPages = Backbone.View.extend({
		events: {
			"click .upfront-list-page_item": "handle_page_activate",
			"click .upfront-page-path-item": "handle_page_activate",
			"change #upfront-page_template-select": "template_change",
			"click .editaction.trash": "trash_page",
			"click .editaction.view": "handle_post_view",
		},
		currentPage: false,
		pageListTpl: _.template($(_Upfront_Templates.popup).find('#upfront-page-list-tpl').html()),
		pageListItemTpl: _.template($(_Upfront_Templates.popup).find('#upfront-page-list-item-tpl').html()),
		pagePreviewTpl: _.template($(_Upfront_Templates.popup).find('#upfront-page-preview-tpl').html()),
		allTemplates: [],
		render: function () {
			var pages = this.collection.getPage(this.collection.pagination.currentPage);//this.collection.where({'post_parent': 0});
			// Render
			this.$el.html(
				this.pageListTpl({
					pages: pages,
					pageItemTemplate: this.pageListItemTpl,
					orderby: this.collection.orderby,
					order: this.collection.order
				})
			);
		},

		renderPreview: function (page) {
			var $root = this.$el.find("#upfront-list-page-preview");

			$root.html(this.pagePreviewTpl({
				page: page,
				template: page.template ? page.template : 'Default',
				allTemplates: this.allTemplates ? this.allTemplates : []
			}));
			this.$el.find("#upfront-page_preview-edit button").one("click", function () {
				//window.location = Upfront.Settings.Content.edit.page + page.get('ID');
				var path = '/edit/page/' + page.get('ID');
				// Respect dev=true
				if (window.location.search.indexOf('dev=true') > -1) path += '?dev=true';
				Upfront.Popup.close();
				Upfront.Application.navigate(path, {trigger: true});
			});
		},
		handle_post_view: function (e) {
			e.preventDefault();
			var postId = $(e.currentTarget).closest('.upfront-list_item-post').attr('data-post_id');
			window.location.href = this.collection.get(postId).get('permalink');
		},
		handle_page_activate: function (e) {
			var page = this.collection.get($(e.target).attr("data-post_id"));
			e.preventDefault();
			e.stopPropagation();

			this.$(".upfront-list-page_item").removeClass("active");
			this.$("#upfront-list-page_item-" + page.id).addClass("active").toggleClass('closed');

			this.update_path(page);
			this.update_page_preview(page);

			this.currentPage = page;
		},
		trash_page: function (e) {
			var me = this;
			var postelement = $(e.currentTarget).closest('.upfront-list_item-post.upfront-list_item');
			var postId = postelement.attr('data-post_id');
			if(confirm( Upfront.Settings.l10n.global.content.delete_confirm.replace(/%s/, this.collection.get(postId).get('post_type')))) {
				this.collection.get(postId).set('post_status', 'trash').save().done(function(){

					me.collection.remove(me.collection.get(postId));
					postelement.remove();
				});
			}
		},
		update_path: function (page) {
			var current = page,
				fragments = [{id: page.get('ID'), title: page.get('post_title')}],
				$root = this.$el.find("#upfront-list-page-path"),
				output = ''
			;

			while(current.get('post_parent')){
				current = this.collection.get(current.get('post_parent'));
				fragments.unshift({id: current.get('ID'), title: current.get('post_title')});
			}

			_.each(fragments, function(p){
				if(output)
					output += '&nbsp;»&nbsp;'
				if(p.id == page.id)
					output += '<span class="upfront-page-path-current last">' + p.title + '</span>';
				else
					output += '<a href="#" class="upfront-page-path-item" data-post_id="' + p.id + '">' + p.title + '</a>';
			})
			$root.html(output);
		},

		update_page_preview: function (page) {
			var me = this,
				getExtra = !page.thumbnail || !me.allTemplates || !page.template,
				extra = getExtra ?
					{
						thumbnail: !page.thumbnail,
						thumbnailSize: 'medium',
						allTemplates: !me.allTemplates,
						template: !page.template,
						action: 'get_post_extra',
						postId: page.get('ID')
					} : {}
			;

			if(getExtra){
				this.collection.post(extra)
					.done(function(response){
						if(response.data.thumbnail && response.data.postId == page.get('ID')){
							me.$('#upfront-page_preview-featured_image img').attr('src', response.data.thumbnail[0]).show();
							me.$('.upfront-thumbnailinfo').hide();
							page.thumbnail = response.data.thumbnail[0];
						}
						else{
							me.$('.upfront-thumbnailinfo').text(l10n.no_image);
							me.$('.upfront-page_preview-edit_feature a').html('<i class="icon-plus"></i> ' + l10n.add);
						}

						if(response.data.allTemplates)
							me.allTemplates = response.data.allTemplates;
						if(response.data.template){
							page.template = response.data.template;
							me.renderPreview(page);
						}
					})
				;
			}

			this.renderPreview(page);
		},

		template_change: function(e){
			var me = this,
				$target = $(e.target),
				value = $target.val()
			;

			this.currentPage.post({
				action: 'update_page_template',
				postId: this.currentPage.get('ID'),
				template: value
			}).done(function(response){
				if(me.currentPage.get('ID') == response.data.postId)
					me.currentPage.template = response.data.template;
			});
		}
	});


	var ContentEditorComments = Backbone.View.extend({
		events: {
			"click #upfront-list-meta .upfront-list_item-component": "handle_sort_request",
			"mouseenter .upfront-list_item-comment": "start_reveal_counter",
			"mouseleave .upfront-list_item-comment": "stop_reveal_counter",
			"click .upfront-list_item-comment": "toggle_full_post",
			"click .upfront-comments-approve": "handle_approval_request",
			"click .upfront-comment_actions-wrapper a": "handle_action_bar_request",
			"click .comment-edit-ok": "edit_comment",
			"click .comment-reply-ok": "reply_to_comment",
			"click .comment-reply-cancel": "cancel_edit",
			"click .comment-reply-cancel": "cancel_edit",
			"click .comment-edit-box": "stop_propagation"
		},
		excerptLength: 60,
		commentsTpl: _.template($(_Upfront_Templates.popup).find('#upfront-comments-tpl').html()),
		commentTpl: _.template($(_Upfront_Templates.popup).find('#upfront-comment-single-tpl').html()),
		initialize: function(options){
			this.collection.on('change', this.renderComment, this);
			this.collection.on('add', this.addComment, this);
		},

		render: function () {
			//Parse comment meta data
			var comments = this.collection.postId == 0 ? [] : this.collection.getPage(this.collection.pagination.currentPage);
			this.$el.html(
				this.commentsTpl({
					comments: comments,
					excerptLength: 45,
					commentTpl: this.commentTpl,
					orderby: this.collection.orderby,
					order: this.collection.order
				})
			);
		},

		renderComment: function(comment) {
			this.$('#upfront-list_item-comment-' + comment.get('comment_ID')).html(
				this.commentTpl({comment: comment, excerptLength: 60})
			);
		},

		addComment: function(comment){
			var parentId = comment.get('comment_parent'),
				tempId = comment.get('comment_ID'),
				commentTpl = $('<div class="upfront-list_item-comment upfront-list_item clearfix expanded" id="upfront-list_item-comment-' + tempId + '" data-comment_id="' + tempId + '">' +
					this.commentTpl({comment: comment, excerptLength: this.excerptLength}) +
					'</div>').hide()
			;
			this.$('div.upfront-list_item-comment').removeClass('expanded');
			this._currently_working = false;

			if(parentId)
				this.$('#upfront-list_item-comment-' + parentId).after(commentTpl);
			else
				this.$('div.upfront-list-comment-items').append(commentTpl);
			commentTpl.slideDown();
		},

		handle_sort_request: function (e) {
			var $option = $(e.target),
				sortby = $option.attr('data-sortby'),
				order = this.collection.order;
			if(sortby){
				if(sortby == this.collection.orderby)
					order = order == 'desc' ? 'asc' : 'desc';
				this.collection.reSort(sortby, order);
			}
		},

		start_reveal_counter: function (e) {
			var me = this;
			if ($(e.target).is(".upfront-comment-approved") || $(e.target).parents(".upfront-comment-approved").length) return false; // Not expanding on quick reveal
			if (this._currently_working) return false;

			clearTimeout(me._reveal_counter);

			me._reveal_counter = setTimeout(function () {
				me.reveal_comment(e);
			}, 500);
		},

		reveal_comment: function (e) {
			this.$(".upfront-list-comments .upfront-list_item").removeClass("expanded");
			$(e.currentTarget).addClass("expanded");
			clearTimeout(this._reveal_counter);
		},

		revert_comment: function (e) {
			$(e.currentTarget).removeClass("expanded");
			clearTimeout(this._reveal_counter);
		},

		toggle_full_post: function (e) {
			$(e.currentTarget).toggleClass("expanded");
		},

		stop_reveal_counter: function (e) {
			if (this._currently_working) return false;
			this.revert_comment(e);
		},

		handle_approval_request: function (e, comment) {
			var comment = comment ? comment : this.collection.get($(e.target).attr("data-comment_id"));
			this.$('#upfront-list_item-comment-' + comment.id + ' i.upfront-comments-approve')
				.animate({'font-size': '1px', opacity:0}, 400, 'swing', function(){
					comment.approve(true).save();
				})
		},

		handle_action_bar_request: function (e) {
			var me = this,
				$el = $(e.currentTarget),
				comment = this.collection.get($el.parents(".upfront-list_item-comment").attr("data-comment_id"))
			;
			if ($el.is(".edit"))
				this._edit_comment(comment);
			else if ($el.is(".reply"))
				this._reply_to_comment(comment);
			else if ($el.is(".approve"))
				this.handle_approval_request(false, comment);
			else if ($el.is(".unapprove"))
				comment.approve(false).save();
			else if ($el.is(".thrash"))
				comment.trash(true).save();
			else if ($el.is(".unthrash"))
				comment.trash(false).save();
			else if ($el.is(".spam"))
				comment.spam(true).save();
			else if ($el.is(".unspam"))
				comment.spam(false).save();

			return false;
		},

		edit_comment: function(e){
			var $container = $(e.target).parent(),
				comment = this.collection.get($container.attr('data-comment_id'))
			;

			comment.set('comment_content', $container.find('textarea').attr('disabled', true).val()).save();
		},
		reply_to_comment: function(e){
			var me = this,
				$container = $(e.target).parent(),
				comment = this.collection.get($container.attr('data-comment_id')),
				$comment = this.$('#upfront-list_item-comment-' + comment.get('comment_ID')),
				text = $container.find('textarea').val(),
				currentUser = Upfront.data.currentUser
			;


			if(text){
				var reply = new Upfront.Models.Comment({
						comment_author: currentUser.get('data').display_name,
						comment_post_ID	: this.collection.postId,
						comment_parent: comment.get('comment_ID'),
						comment_content: text,
						comment_approved: '1',
						user_id: currentUser.get('ID')
					}),
					tempId = (new Date()).getTime()
				;

				$comment.find("textarea").attr('disabled', true);

				reply.save().done(function(response){
					me.renderComment(comment);
					reply.set('comment_ID', response.data.comment_ID);
					me.collection.add(reply);
					me.$('#upfront-list_item-comment-' + response.data.comment_ID).hide().slideDown();
				});
			}
		},

		cancel_edit: function(e) {
			var $container = $(e.target).parent(),
				comment = this.collection.get($container.attr('data-comment_id'))
			;
			this.renderComment(comment);
		},

		stop_propagation: function(e) {
			e.stopPropagation();
		},

		_edit_comment: function (comment) {
			var $comment = this.$('#upfront-list_item-comment-' + comment.get('comment_ID'));

			$comment.find('.upfront-comment_togglable').hide();
			$comment.find('.upfront-comment_edit').show();

			this._currently_working = true;
		},

		_reply_to_comment: function (comment) {
			var $comment = this.$('#upfront-list_item-comment-' + comment.get('comment_ID'));

			$comment.find('.upfront-comment_togglable').show();
			$comment.find('.upfront-comment_edit').hide();

			this._currently_working = true;
		},
	});


// ----- Done bringing things back

	var Upfront_Icon_Mixin = {
		get_icon_html: function (src, classname) {
			if ( ! src )
				return '';
			if ( src.match(/^https?:\/\//) ) {
				var attr = {
					'src': src,
					'alt': '',
					'class': 'upfront-field-icon-img'
				}
				return '<img ' + this.get_field_attr_html(attr) + ' />';
			}
			else {
				var classes = ['upfront-field-icon'];
				if ( ! classname ){
					classes.push('upfront-field-icon-' + src);
				}
				else{
					classes.push(classname);
					classes.push(classname + '-' + src);
				}
				return '<i class="' + classes.join(' ') + '"></i>';
			}
		}
	};


	var Field = Backbone.View.extend({
		className: 'upfront-field-wrap',
		initialize: function (opts) {
			this.options = opts;
			this.multiple = typeof this.options.multiple != 'undefined' ? this.options.multiple : (typeof this.multiple != 'undefined' ? this.multiple : false);
			this.label = typeof this.options.label != 'undefined' ? this.options.label : '';
			this.default_value = typeof this.options.default_value != 'undefined' ? this.options.default_value : (this.multiple ? [] : '');
			if ( this.options.property ) {
				this.property = this.model.get_property_by_name(this.options.property);
				if ( this.property === false ) {
					this.model.init_property(this.options.property, this.default_value);
					this.property = this.model.get_property_by_name(this.options.property);
				}
				this.property_name = this.options.property;
				if ( typeof this.options.use_breakpoint_property != 'undefined' )
					this.use_breakpoint_property = this.options.use_breakpoint_property;
			}
			else {
				this.property = false;
			}
			this.name = this.options.name ? this.options.name : this.cid;
			this.selected_state = this.selected_state ? this.selected_state : '';
			if ( this.init )
				this.init();
			if ( this.options.change )
				this.on('changed', this.options.change, this);
			if ( this.options.show )
				this.on('changed rendered', this.dispatch_show, this);
			if ( this.options.focus )
				this.on('focus', this.options.focus, this);
			if ( this.options.blur )
				this.on('blur', this.options.blur, this);
			if ( this.options.rendered )
				this.on('rendered', this.options.rendered, this);
			if (this.options.on_click)
				this['on_click'] = this.options.on_click;
			this.once('rendered', function(){
				var me = this;
				this.get_field().on('focus', function(){
					me.trigger('focus');
				}).on('blur', function(){
					me.trigger('blur');
				});
			}, this);
		},
		dispatch_show: function () {
			var me = this;
			setTimeout(function() {
				me.options.show(me.get_value(), me.$el);
			}, 100);
		},
		get_name: function () {
			return this.property ? this.property.get('name') : this.name;
		},
		get_saved_value: function () {
			if ( this.property ){
				if ( this.use_breakpoint_property )
					return this.model.get_breakpoint_property_value(this.property_name, true);
				else
					return this.property.get('value');
			}
			else if ( this.model ){
				var value = this.model.get(this.name);
				return value ? value : this.default_value;
			}
			return this.default_value;
		},
		get_value: function () {
			var $field = this.get_field();
			if ( ! this.multiple || ($field.size() == 1 && $field.is('select')) )
				return $field.val();
			else
				return _.map($field, function (el) { return $(el).val(); });
			return false;
		},
		set_value: function (value) {
		    this.get_field().val(value);
		},
		get_field_id: function () {
			return this.cid + '-' + this.get_name();
		},
		get_field_name: function () {
			return this.get_name();
		},
		get_field: function () {
			return this.$el.find( '[name=' + this.get_field_name() + ']' + (this.selected_state ? ':'+this.selected_state : '') );
		},
		get_label_html: function () {
			if (this.options.hide_label === true) return '';
			var attr = {
				'for': this.get_field_id(),
				'class': 'upfront-field-label ' + ( this.options.label_style == 'inline' ? 'upfront-field-label-inline' : 'upfront-field-label-block' )
			};
			return '<label ' + this.get_field_attr_html(attr) + '>' + this.label + '</label>';
		},
		get_field_attr_html: function (attr) {
			return _.map(attr, function(value, att){
				return att + '="' + value + '"';
			}).join(' ');
		}
	});

	var Field_Text = Field.extend({
		className: 'upfront-field-wrap upfront-field-wrap-text',
		render: function () {
			this.$el.html('');
			if ( !this.options.compact )
				this.$el.append(this.get_label_html());
			this.$el.append(this.get_field_html());
			var me = this;
			this.get_field().keyup(function(){
				if ( $(this).val() == '' ){
					$(this).addClass('upfront-field-empty');
				}
				else if ( $(this).hasClass('upfront-field-empty') ) {
					$(this).removeClass('upfront-field-empty');
				}
			}).trigger('keyup').change(function(){
				me.trigger('changed', me.get_value());
			});
			this.trigger('rendered');
		},
		get_field_html: function () {
			var attr = {
				'type': 'text',
				'class': 'upfront-field upfront-field-text',
				'id': this.get_field_id(),
				'name': this.get_field_name(),
				'value': this.get_saved_value()
			};
			if ( this.options.compact ) {
				attr.placeholder = this.label;
				this.$el.attr('title', this.label);
			}
			else if ( this.options.placeholder ) {
				attr.placeholder = this.options.placeholder;
			}
			return '<input ' + this.get_field_attr_html(attr) + ' />';
		}
	});

/**
 * Start in initially not editable state.
 * Used for things such as permalink fields in "New Page" dialog.
 * Not exposed globally.
 */
var Field_ToggleableText = Field_Text.extend({
	is_edited: false,
	className: 'upfront-field-wrap upfront-field-wrap-text upfront-field-wrap-toggleable',
	render: function () {
		Field_Text.prototype.render.call(this);
		if (this.is_edited) return false;
		this.$el.append(
			' ' +
			'<a href="#" class="upfront-toggleable-button">Edit</a>'
		);
		var me = this;
		this.$el.on('click', '.upfront-toggleable-button', function (e) {
			e.preventDefault();
			e.stopPropagation();
			var $me = $(this),
				$el = me.get_field()
			;
			$me.hide();
			$el.replaceWith(me.get_editable_html());
			me.is_edited = true;
		});
	},
	has_been_edited: function () {
		return this.is_edited;
	},
	reset_state: function () {
		this.is_edited = Field_ToggleableText.prototype.is_edited;
	},
	get_field_html: function () {
		return this.is_edited
			? this.get_editable_html()
			: this.get_toggleable_html()
		;
	},
	get_field: function () {
		return this.is_edited
			? Field_Text.prototype.get_field.call(this)
			: this.$el.find(".upfront-field-toggleable-value")
		;
	},
	get_value: function () {
		return this.is_edited
			? Field_Text.prototype.get_value.call(this)
			: $.trim(this.get_field().text())
		;
	},
	set_value: function (value) {
		return this.is_edited
			? this.get_field().val(value)
			: this.get_field().text(value)
		;
	},
	get_toggleable_html: function () {
		var value = this.get_value() || this.get_saved_value();
		return '<span class="upfront-field-toggleable-value">' + value + '</span>';
	},
	get_editable_html: function () {
		var attr = {
				'type': 'text',
				'class': 'upfront-field upfront-field-text upfront-field-toggleable',
				'id': this.get_field_id(),
				'name': this.get_field_name(),
				'value': this.get_value() || this.get_saved_value()
			};
			if ('inline' === this.options.label_style) attr.class += ' upfront-has_inline_label';
			if ( this.options.compact ) {
				attr.placeholder = this.label;
				this.$el.attr('title', this.label);
			}
			else if ( this.options.placeholder ) {
				attr.placeholder = this.options.placeholder;
			}
			return '<input ' + this.get_field_attr_html(attr) + ' />';
	}
});

	var Field_Button = Field.extend({
		className: 'upfront-field-wrap upfront-field-wrap-button',
		events: {
			'click': 'on_click'
		},
		render: function () {
			this.$el.html('');
			if ( !this.options.compact )
				this.$el.append(this.get_label_html());
			if ( this.options.info) {
				this.$el.append(this.get_info_html());
			}
			this.$el.append(this.get_field_html());
			var me = this;

			if (this.options.classname) this.$el.addClass(this.options.classname);

			this.trigger('rendered');
		},
		get_info_html: function() {
			return '<span class="button-info">' + this.options.info + '</span>';
		},
		get_field_html: function () {
			var attr = {
				'type': 'button',
				'class': 'upfront-field upfront-field-button',
				'id': this.get_field_id(),
				'name': this.get_field_name(),
				'value': this.label
			};
			if ( this.options.compact ) {
				attr.placeholder = this.label;
				this.$el.attr('title', this.label);
			}
			else if ( this.options.placeholder ) {
				attr.value = this.options.placeholder;
			}
			return '<input ' + this.get_field_attr_html(attr) + ' />';
		}
	});

	var Field_Email = Field_Text.extend({
		get_field_html: function () {
			var attr = {
				'type': 'email',
				'class': 'upfront-field upfront-field-text upfront-field-email',
				'id': this.get_field_id(),
				'name': this.get_field_name(),
				'value': this.get_saved_value()
			};
			if ( this.options.compact ) {
				attr.placeholder = this.label;
				this.$el.attr('title', this.label);
			}
			else if ( this.options.placeholder ) {
				attr.placeholder = this.options.placeholder;
			}
			return '<input ' + this.get_field_attr_html(attr) + ' />';
		}
	});

	var Field_Textarea = Field_Text.extend({
		className: 'upfront-field-wrap upfront-field-wrap-text upfront-field-wrap-textarea',
		get_field_html: function () {
			var attr = {
				'cols': '40',
				'rows': '5',
				'class': 'upfront-field upfront-field-text upfront-field-textarea',
				'id': this.get_field_id(),
				'name': this.get_field_name()
			};
			if ( this.options.compact ) {
				attr.placeholder = this.label;
				this.$el.attr('title', this.label);
			}
			else if ( this.options.placeholder ) {
				attr.placeholder = this.options.placeholder;
			}
			return '<textarea ' + this.get_field_attr_html(attr) + '>' + this.get_saved_value() + '</textarea>';
		}
	});

	var Field_Number = Field_Text.extend({
		className: 'upfront-field-wrap upfront-field-wrap-number',
		get_field_html: function () {
			var attr = {
				'type': 'number',
				'class': 'upfront-field upfront-field-number',
				'id': this.get_field_id(),
				'name': this.get_field_name(),
				'value': this.get_saved_value()
			};
			if ( typeof this.options.min != 'undefined' )
				attr.min = this.options.min;
			if ( typeof this.options.max != 'undefined' )
				attr.max = this.options.max;
			if ( typeof this.options.step != 'undefined' )
				attr.step = this.options.step;
			return ' <input ' + this.get_field_attr_html(attr) + ' /> ' + (this.options.suffix ? this.options.suffix : '');
		}
	});


	var Field_Slider = Field_Text.extend(_.extend({}, Upfront_Icon_Mixin, {
		className: 'upfront-field-wrap upfront-field-wrap-slider',
		initialize: function(opts) {
			this.options = opts;
			Field_Slider.__super__.initialize.apply(this, arguments);

			var me = this,
				options = {
					range: this.getOption('range', 'min'),
					min: this.getOption('min', 0),
					max: this.getOption('max', 0),
					step: this.getOption('step', 1),
					orientation: this.getOption('orientation', 'horizontal'),
					value: this.get_saved_value()
				}
			;

			this.value = this.get_saved_value();
			if(typeof this.value == 'undefined')
				this.value = options.min;

			if(this.options.callbacks)
				_.extend(options, this.options.callbacks);

			options.slide = function(e, ui){
				var valueText = ui.value;
				me.value = valueText;

				me.$('input').val(me.value).trigger('change');

				if(me.options.valueTextFilter)
					valueText = me.options.valueTextFilter(valueText);

				me.$('.upfront-field-slider-value').text(valueText);

				if(me.options.callbacks && me.options.callbacks.slide)
					me.options.callbacks.slide(e, ui);
			}

			this.on('rendered', function(){
				var $field = me.$('#' + me.get_field_id());
				if ( options.orientation == 'vertical' ){
					$field.addClass('upfront-field-slider-vertical');
				}
				$field.slider(options);
			});
		},
		get_field_html: function () {
			var output = '<input type="hidden" name="' + this.get_field_name() + '" value="' + this.value + '">',
				value = this.value
			;

			if(this.options.info)
				output += '<div class="upfront-field-info">' + this.options.info + '</div>'

			output += '<div class="upfront-field upfront-field-slider" id="' + this.get_field_id() + '"></div>';

			if(this.options.valueTextFilter)
				value = this.options.valueTextFilter(value);

			output += '<div class="upfront-field-slider-value"> ' + value + '</div>';
			return output;
		},

		getOption: function(option, def){
			return this.options[option] ? this.options[option] : def;
		}
	}));

	var Field_Hidden = Field_Text.extend({
		className: 'upfront-field-wrap upfront-field-wrap-hidden',
		get_field_html: function(){
			var attr = {
				type: 'hidden',
				id: this.get_field_id(),
				name: this.get_field_name(),
				'class': 'upfront-field upfront-field-hidden',
				'value': this.get_saved_value()
			};
			return ' <input ' + this.get_field_attr_html(attr) + ' /> ';
		}
	});

	var Field_Color = Field_Text.extend({
		className: 'upfront-field-wrap upfront-field-wrap-color sp-cf',
		defaults : {
			blank_alpha : 1,
			autoHide: true
		},
		spectrumDefaults: {
			clickoutFiresChange: false,
			chooseText: 'OK',
			showSelectionPalette: true,
			showAlpha: true,
			showPalette: true,
            localStorageKey: "spectrum.recent_colors",
			palette: Theme_Colors.colors.pluck("color").length ? Theme_Colors.colors.pluck("color") : [],
			maxSelectionSize: 10,
			preferredFormat: "hex",
			showInput: true,
			allowEmpty:true,
			appendTo : "parent"
		},
		events : {
			'change .upfront_color_picker_rgba input' : 'rgba_sidebar_changed',
			'change .sp-input' : 'sp_input_changed',
			'click .upfront_color_picker_reset' : 'set_to_blank'
		},
		initialize: function(opts){
			this.options = _.extend({}, this.defaults, opts);
			this.options.blank_alpha = _.isUndefined( this.options.blank_alpha ) ? 1 : this.options.blank_alpha;
			this.sidebar_template = _.template(_Upfront_Templates.color_picker);
			var me = this,
			spectrumOptions = typeof this.options.spectrum == 'object' ? _.extend({}, this.spectrumDefaults, this.options.spectrum) : this.spectrumDefaults
			;
			this.rgba = {
				r : 0,
				g : 0,
				b : 0,
				a : 0
			};
			this.spectrumOptions = spectrumOptions;

			spectrumOptions.move = function(color, e){
				if( !_.isEmpty( color ) ){
					me.color = color;
					var rgb = color.toHexString();
					$('.sp-dragger').css({
						'border-top-color': rgb,
						'border-right-color': rgb
					});
					me.update_input_border_color( color.toRgbString() );
					me.update_input_val( rgb );
					me.rgba = _.extend(me.rgba, color.toRgb());
					me.render_sidebar_rgba(me.rgba);
				}

				if(me.options.spectrum && me.options.spectrum.move)
					me.options.spectrum.move(color);

				me.toggle_alpha_selector(color, e);
			};

			spectrumOptions.show = function(color){
				var $input = $(".sp-input"),
					input_val = $input.val();

				if( !_.isEmpty( color ) ){
					this.color = color;
					var rgb = color.toHexString();
					me.rgba = _.extend(me.rgba, color.toRgb());
					me.update_input_border_color( color.toRgbString() );
					me.render_sidebar_rgba(me.rgba);
					me.update_input_val( rgb );
				}
				if( !_.isEmpty( input_val) && !me.is_hex( input_val )){
					var t_color = tinycolor( input_val );
					$input.val(t_color.toHexString());
				}
				me.spectrumOptions = spectrumOptions;

				if(me.options.spectrum && me.options.spectrum.show)
					me.options.spectrum.show(color);

				/**
				 * Dont allow more than one top be open
				 */
				$(".sp-container").not( me.$(".sp-container")).each(function(){
					var $this = $(this),
						options = $this.data("sp-options");
					if( !options || !options.flat  ){
						$this.addClass("sp-hidden");
					}

				});

				if( !_.isEmpty( input_val ) ){
					var input_val_color = tinycolor( input_val );
					me.toggle_alpha_selector( input_val_color );
				}

			};

			spectrumOptions.beforeShow = function(color){
				if( color instanceof Object ){
					$.extend(color, tinycolor.prototype);
				}
				me.color = color;
				me.update_palette(); // Make sure we're up to date
				me.$('input[name=' + me.get_field_name() + ']').spectrum("option", "palette", me.options.palette);
				if(me.options.spectrum && me.options.spectrum.beforeShow) me.options.spectrum.beforeShow(color);

				me.$(".sp-container").data("sp-options", me.options.spectrum );
			};

			/**
			 * Wrap the hide callback so we can re-use it.
			 */
			var hide = function (color) {
				if (me.options.spectrum && me.options.spectrum.hide) {
					me.options.spectrum.hide(color);
				}
			};
			// Add wrapped hide callback
			spectrumOptions.hide = hide;
			if( !spectrumOptions.autoHide  ){
				spectrumOptions.hide = function(color){
					me.color = color;
					// And if we override the hide callback, re-apply it in overridden method
					hide(color);
					me.$(".sp-replacer").addClass("sp-active");
					me.$(".sp-container").removeClass("sp-hidden");
				};
			}

			var l10n_update = _.debounce(function () {
				// Let's fix the strings
				$(".sp-container").each(function () {
					$(this)
						.find(".sp-input-container").attr("data-label", l10n.current_color).end()
						.find(".sp-palette-container").attr("data-label", l10n.theme_colors).end()
						.find(".sp-palette-row:last").attr("data-label", l10n.recent_colors)
					;
				})
			});


			Field_Color.__super__.initialize.apply(this, arguments);

			this.on('rendered', function(){
				me.$('input[name=' + me.get_field_name() + ']').spectrum(spectrumOptions);
				me.$spectrum = me.$('input[name=' + me.get_field_name() + ']');

				// Listen to spectrum events and fire off l10n labels update
				me.$spectrum.on("reflow.spectrum move.spectrum change", l10n_update);

				me.$(".sp-container").append("<div class='color_picker_rgb_container'></div>");
				me.update_input_border_color(me.get_saved_value());
				me.$(".sp-container").data("field_color", me);
				me.$(".sp-container").data("$spectrum", me.$spectrum );
				me.$(".sp-container").find(".sp-choose").on("click.spectrum", function(e){
					if(me.options.spectrum && me.options.spectrum.choose && me.color)
						me.options.spectrum.choose(me.color);

					if( me.autoHide !== true ){
						me.$(".sp-replacer").removeClass("sp-active");
						me.$(".sp-container").addClass("sp-hidden");
					}
				});

			});

		},

		render: function () {
			Field_Color.__super__.render.apply(this, arguments);
			// Re-bind debounced listeners for theme color updates
			this.stopListening(Upfront.Events, "theme_colors:update");
			var cback = _.debounce(this.update_palette, 200);
			this.listenTo(Upfront.Events, "theme_colors:update", cback, this);
		},

		update_palette: function () {
			if (this.$spectrum && this.$spectrum.spectrum) {
				this.$spectrum.spectrum("option", "palette", Theme_Colors.colors.pluck("color").length ? Theme_Colors.colors.pluck("color") : []);
			}
		},

		is_hex : function(color_code){
			return color_code.indexOf( "#" ) === -1 ? false : true;
		},
		get_field_html: function () {
			var attr = {
				'type': 'text',
				'class': 'upfront-field upfront-field-color',
				'id': this.get_field_id(),
				'name': this.get_field_name(),
				'value': this.get_saved_value()
			};
			return ' <input ' + this.get_field_attr_html(attr) + ' /> ' + (this.options.suffix ? this.options.suffix : '');
		},
		update_input_border_color : function(rgb){
            var spPreview = this.$el.find(".sp-preview");
			$(".sp-input").css({
				borderColor : rgb
			});

            spPreview.css({
                backgroundColor: rgb
            })

            if( rgb !== 'rgba(0, 0, 0, 0)' ) {
                spPreview.removeClass('uf-unset-color');
            }
            else if( spPreview.closest( '.theme_colors_empty_picker' ).length === 0 ) {
                spPreview.addClass('uf-unset-color');
            }
		},
		update_input_val : function(hex){
			this.$(".sp-input").val(hex);
		},
		render_sidebar_rgba : function(rgba){
			var self = this;
			this.$(".color_picker_rgb_container").html(this.sidebar_template(rgba));
			this.$(".upfront_color_picker_reset").on("click", function(e){
				e.preventDefault();
				self.set_to_blank();
			});
		},
		rgba_sidebar_changed : function(e){
			var $el = $(e.target),
				type = $el.data("type"),
				val = parseFloat($el.val()),
				color = this.$spectrum.spectrum("get"),
				selection = {};
				selection[type] = val;
				color = tinycolor(_.extend(color.toRgb(), selection));
				// Set the new color
				this.$spectrum.spectrum("set", color.toRgbString());
				this.update_input_border_color( color.toRgbString() );
				this.update_input_val( color.toHexString() );
				this.render_sidebar_rgba(  color.toRgb() );
				// Trigger move event
				if(this.options.spectrum && typeof this.options.spectrum.move === "function"){
					this.options.spectrum.move(color);
				}
				// Trigger change event
				if(this.options.spectrum && typeof this.options.spectrum.change === "function"){
					this.options.spectrum.change(color);
				}
				e.stopPropagation();
				e.preventDefault();
				this.$spectrum.trigger("dragstop.spectrum");
		},
		sp_input_changed : function(e){
			var color = tinycolor($(e.target).val());
			// Trigger move event
			if(this.options.spectrum && typeof this.options.spectrum.move === "function"){
				this.options.spectrum.move(color);
			}
			// Trigger change event
			if(this.options.spectrum && typeof this.options.spectrum.change === "function"){
				this.options.spectrum.change(color);
			}
			//Update preview color
			this.update_input_border_color(color.toRgbString);
		},
		set_to_blank : function(){
            var blank_color = 'rgba(0, 0, 0, ' + ( _.isUndefined( this.options.blank_alpha ) ? 1 : this.options.blank_alpha ) + ')',
				color = tinycolor(blank_color);
			color.reset = true;
			this.rgba = {r: 0, g: 0, b:0, a: 0};
			this.$spectrum.spectrum("set", color.toRgbString() );
			this.update_input_border_color( blank_color );
			this.update_input_val( "#000000" );
			this.render_sidebar_rgba(  this.rgba );

			// Trigger move event
			if(this.options.spectrum && typeof this.options.spectrum.move === "function"){
				this.options.spectrum.move(color);
			}

			// Trigger change event
			if(this.options.spectrum && typeof this.options.spectrum.change === "function"){
				this.options.spectrum.change(color);
			}

			// Trigger move event in Theme Color Swatches
			if(this.options && typeof this.options.move === "function"){
				this.options.move(color);
			}

			// Trigger change event in Theme Color Swatches
			if(this.options && typeof this.options.change === "function"){
				this.options.change(color);
			}
		},
		get_value : function() {
			return this.$el.find(".sp-preview-inner").css('background-color');
		},
		set_value : function(rgba) {
			if (Upfront.Util.colors.is_theme_color(rgba)) rgba = Upfront.Util.colors.get_color(rgba);
			var color = tinycolor(rgba);
			this.color = color;
			this.$spectrum.spectrum("set", color );
		},
		toggle_alpha_selector: function(color){
			if( _.isEmpty( color ) ) return;

			var $alpha = this.$(".sp-alpha");

			if( Upfront.Views.Theme_Colors.colors.is_theme_color( color ) ){

				$alpha.addClass("sp-alpha-disabled sp-alpha-lower-opacity");
				$overlay = $("<span class='sp-alpha-overlay' title='"+ l10n.theme_colors_opacity_disabled +"'></span>")
				.on("click", function(e){
					e.stopPropagation();
					e.preventDefault();
				});
				if( !this.$(".sp-alpha-overlay").length ){
					$alpha.before($overlay);
				}

			}else{
				$alpha.removeClass("sp-alpha-disabled sp-alpha-lower-opacity");
				this.$(".sp-alpha-overlay").remove();
			}
		}

	});


	var Field_Multiple = Field.extend(_.extend({}, Upfront_Icon_Mixin, {
		get_values_html: function () {
			return _.map(this.options.values, this.get_value_html, this).join('');
		},
		set_value: function (value) {
			this.$el.find('[value="'+value+'"]').trigger('click');
		}
	}));

	var Field_Select = Field_Multiple.extend(_.extend({}, Upfront_Scroll_Mixin, {
		events: {
			'click .upfront-field-select-value': 'openOptions',
			'mouseup .upfront-field-select': 'onMouseUp',
			'change .upfront-field-select-option input': 'onChange',
			'click .upfront-field-select-option label': 'onOptionClick'
		},

		onOptionClick: function(e) {
			if ( !this.multiple ) {
				e.stopPropagation();
				if ( $(this).closest('.upfront-field-select-option').hasClass('upfront-field-select-option-disabled') ) {
					return;
				}

				// Make sure that input is clicked (for some reason in redactor toolbar this does not work naturally)
				if ( $(e.currentTarget).siblings('input').not(':checked')) {
					$(e.currentTarget).siblings('input').click();
				}

				this.$el.find('.upfront-field-select').removeClass('upfront-field-select-expanded');
				this.trigger('blur');
			}
		},

		openOptions: function(e) {
			if(e)
				e.stopPropagation();
			if ( this.options.disabled )
				return;
			$('.upfront-field-select-expanded').removeClass('upfront-field-select-expanded');
			this.$el.find('.upfront-field-select').css('min-width', '').css('min-width', this.$el.find('.upfront-field-select').width());
			this.$el.find('.upfront-field-select').addClass('upfront-field-select-expanded');

			// Make sure all select options are visible in scroll panel i.e. scroll scroll panel as needed
			var me = this;
			_.delay(function() { // Delay because opening animation causes wrong outerHeight results
				var in_sidebar = me.$el.parents('#sidebar-ui').length,
					in_settings = me.$el.parents('#element-settings-sidebar').length,
					settingsTitleHeight = 46;

				// Apply if select field is in sidebar or settings sidebar
				if(in_sidebar == 1 || in_settings == 1) {
					var select_dropdown = me.$el.find('.upfront-field-select-options'),
						select = select_dropdown.parent(),
						dropDownTop = select.offset().top - $('#element-settings-sidebar').offset().top;
						dropDownTop = dropDownTop + settingsTitleHeight;

					select_dropdown.css("width", select.width() + 3);
					select_dropdown.css('top', dropDownTop + "px");
					select_dropdown.css('left', select.offset().left + "px");
					select_dropdown.css('display', 'block');
				}
			}, 10);

			$('.sidebar-panel-content, #sidebar-scroll-wrapper').on('scroll', this, this.on_scroll);

			this.trigger('focus');
		},
		on_scroll: function(e) {
			var me = e.data;
			me.$el.find('.upfront-field-select').removeClass('upfront-field-select-expanded');
			me.trigger('blur');
		},
		onMouseUp: function(e){
			e.stopPropagation();
		},

		onChange: function() {
			this.update_select_display_value();
			this.trigger('changed', this.get_value());
		},

		selected_state: 'checked',

		className: 'upfront-field-wrap upfront-field-wrap-select',

		render: function () {
			this.$el.html('');

			if ( this.label ) {
				this.$el.append(this.get_label_html());
			}
			this.$el.append(this.get_field_html());

			this.stop_scroll_propagation(this.$el.find('.upfront-field-select-options'));

			if ( ! this.multiple && ! this.get_saved_value() ) {
				this.$el.find('.upfront-field-select-option:eq(0) input').prop('checked', true);
			}

			this.update_select_display_value();

			if ( this.options.width ) {
				this.$el.find('.upfront-field-select').css('width', this.options.width);
			}

			if (this.options.additional_classes) {
				this.$el.addClass(this.options.additional_classes);
			}

			this.trigger('rendered');
		},

		update_select_display_value: function() {
			var select_label = ( this.options.select_label ) ? this.options.select_label : ( this.options.placeholder ? this.options.placeholder : '' );
			var $select_value = this.$el.find('.upfront-field-select-value');
			var $checked = this.$el.find('.upfront-field-select-option input:checked');
			if ( $checked.size() == 1 && !this.multiple ) {
				var $option = $checked.closest('.upfront-field-select-option'),
					select_text = $option.text(),
					$select_icon = $option.find('.upfront-field-icon').clone();
				$select_value.html('');
				if ( $select_icon )
					$select_value.append($select_icon);
				$select_value.append('<span>'+select_text+'</span>');
			} else {
				var select_texts = [];
				$checked.each(function(){
					select_texts.push( $(this).closest('.upfront-field-select-option').text() );
				});
				$select_value.text( $checked.size() == 0 ? select_label : select_texts.join(', ') );
			}
			this.$el.find('.upfront-field-select-option').each(function(){
				if ( $(this).find('input:checked').size() > 0 )
					$(this).addClass('upfront-field-select-option-selected');
				else
					$(this).removeClass('upfront-field-select-option-selected');
			});
		},
		get_field_html: function () {
			var attr = {
				'class': 'upfront-field-select upfront-no-select',
				'id': this.get_field_id()
			};
			attr.class += ' upfront-field-select-' + ( this.options.multiple ? 'multiple' : 'single' );
			if ( this.options.disabled )
				attr.class += ' upfront-field-select-disabled';
			if ( this.options.style == 'zebra' )
				attr.class += ' upfront-field-select-zebra';
			//return '<select ' + this.get_field_attr_html(attr) + '>' + this.get_values_html() + '</select>';
			return '<div ' + this.get_field_attr_html(attr) + '><div class="upfront-field-select-value"></div><ul class="upfront-field-select-options">' + this.get_values_html() + '</ul></div>';
		},
		get_value_html: function (value, index) {
			var id = this.get_field_id() + '-' + index;
			var attr = {
				'type': ( this.multiple ? 'checkbox' : 'radio' ),
				'id': id,
				'name': this.get_field_name(),
				'class': 'upfront-field-' + ( this.multiple ? 'checkbox' : 'radio' ),
				'value': value.value
			};
			var saved_value = this.get_saved_value();
			var classes = 'upfront-field-select-option';
			if ( value.disabled ) {
				attr.disabled = 'disabled';
				classes += ' upfront-field-select-option-disabled';
			}
			var icon_class = this.options.icon_class ? this.options.icon_class : null;
			if ( this.multiple && _.contains(saved_value, value.value) )
				attr.checked = 'checked';
			else if ( ! this.multiple && saved_value == value.value )
				attr.checked = 'checked';
			if ( attr.checked )
				classes += ' upfront-field-select-option-selected';
			classes += ' upfront-field-select-option-' + ( index%2 == 0 ? 'odd' : 'even' );
			//return '<option ' + this.get_field_attr_html(attr) + '>' + value.label + '</option>';
			var input = '<input ' + this.get_field_attr_html(attr) + ' />';
			return '<li class="' + classes + '">' + '<label for="' + id + '">' + this.get_icon_html(value.icon, icon_class) + '<span class="upfront-field-label-text">' + value.label + '</span></label>' + input + '</li>';
		}
	}));

	var Field_Chosen_Select = Field_Select.extend({
		events: {
			'change select': 'on_change',
			'click .chosen-container .chosen-single': 'openOptions'
		},
		multiple: false,

		initialize: function(options) {
			Field.prototype.initialize.call(this, options);
			//Close dropdown on parent scroll
			$('.sidebar-panel-content, #sidebar-scroll-wrapper').on('scroll', this, this.closeChosen);

			//Disable scroll when chosen is opened
			$('.sidebar-panel-content .sidebar-tab-content').bind('mousewheel', function() {
				 return false
			});
		},

		get_field_html: function() {
			var multiple = this.multiple ? 'multiple' : '';
			return ['<select class="upfront-chosen-select"' , multiple, ' data-placeholder="', this.options.placeholder,  '">', this.get_values_html(), '</select>'].join('');
		},
		get_value_html: function (value, index) {
			var selected = '';
			if (value.value === this.options.default_value) selected = ' selected="selected"';
			return ['<option value="', value.value, '"', selected, '>', value.label, '</option>'].join('');
		},
		on_change: function(e) {
			this.$el.find('.chosen-drop').css('display', 'none');
			this.trigger('changed');
		},
		get_value: function() {
			return this.$el.find('select').val();
		},
		set_value: function(value) {
			this.$el.find('select').val(value).trigger('chosen:updated');
		},
		openOptions: function(e) {
			var me = this;
			_.delay(function() { // Delay because opening animation causes wrong outerHeight results
				var in_sidebar = me.$el.parents('#sidebar-ui').length,
					in_settings = me.$el.parents('#element-settings-sidebar').length,
					settingsTitleHeight = 44;

				// Apply if select field is in sidebar or settings sidebar
				if(in_sidebar == 1 || in_settings == 1) {
					var select_dropdown = me.$el.find('.chosen-drop'),
						select = select_dropdown.parent(),
						dropDownTop = (select.offset().top - $('#element-settings-sidebar').offset().top) + select.height();
						dropDownTop = dropDownTop + settingsTitleHeight;

					select_dropdown.css("width", select.width());
					select_dropdown.css('top', dropDownTop + "px");
					select_dropdown.css('left', select.offset().left + "px");
					select_dropdown.css('display', 'block');
				}
			}, 20);

			me.$el.find('.chosen-drop').show();
		},
		closeChosen: function(e) {
			var me = e.data;
			var in_sidebar = me.$el.parents('#sidebar-ui').length,
				in_settings = me.$el.parents('#element-settings-sidebar').length;

			if(in_sidebar == 1 || in_settings == 1) {
				me.$el.find('.chosen-drop').css('display', 'none');
			}
			me.$el.find('select').trigger("chosen:close");

			//Enable scroll when chosen is closed
			$('.sidebar-panel-content .sidebar-tab-content').unbind('mousewheel');
		}
	});

	var Field_Typeface_Chosen_Select = Field_Chosen_Select.extend({
		events: {
			'change select': 'on_change',
			'click .chosen-container .chosen-single': 'openOptions'
		},
		multiple: false,
		get_field_html: function() {
			var multiple = this.multiple ? 'multiple' : '';
			return ['<div class="upfront-select-font"><select class="upfront-chosen-select-typeface"' , multiple, ' data-placeholder="', this.options.placeholder,  '">', this.get_values_html(), '</select></div>'].join('');
		},
		get_value_html: function (value, index) {
			var selected = '';
			var saved_value = this.get_saved_value();
			if (value.value === saved_value) {
				selected = ' selected="selected"';
			}
			return ['<option value="', value.value, '"', selected, ' style="font-family: ', value.value ,'">', value.label, '</option>'].join('');
		},
		render: function() {
			Field_Chosen_Select.prototype.render.call(this);

			var me = this;
			$('.upfront-chosen-select-typeface', this.$el).chosen({
				width: this.options.select_width
			});

			//Wait for Chosen to be initialized
			setTimeout(function(){
				me.set_option_font(me.get_saved_value());
			}, 50);

		},
		on_change: function(event) {
			this.trigger('changed', this.get_value());
			this.$el.find('.chosen-drop').css('display', 'none');
			this.set_option_font(this.get_value());
		},
		set_option_font: function(value) {
			this.$el.find('.chosen-single').css( "font-family", value );
		},
		openOptions: function(e) {
			Field_Chosen_Select.prototype.openOptions.call(this);
		}
	});

	var Field_Typeface_Style_Chosen_Select = Field_Chosen_Select.extend({
		events: {
			'change select': 'on_change',
			'click .chosen-container .chosen-single': 'openOptions'
		},
		multiple: false,
		get_field_html: function() {
			var multiple = this.multiple ? 'multiple' : '';
			return ['<div class="upfront-select-font"><select class="upfront-chosen-select-style"' , multiple, ' data-placeholder="', this.options.placeholder,  '">', this.get_values_html(), '</select></div>'].join('');
		},
		get_value_html: function (value, index) {
			var selected = '';
			var font_family = this.options.font_family;
			var parsed_variant = Upfront.Views.Font_Model.parse_variant(value.value);
			var saved_value = this.get_saved_value();
			if (value.value === saved_value) {
				selected = ' selected="selected"';
			}
			var label =  this.map_labels(parsed_variant.weight, parsed_variant.style);
			return ['<option value="', value.value, '"', selected, ' style="font-family: ', font_family ,'; font-weight: ', parsed_variant.weight ,'; font-style: ', parsed_variant.style ,' ">', label, '</option>'].join('');
		},
		render: function() {
			Field_Chosen_Select.prototype.render.call(this);

			var me = this;
			$('.upfront-chosen-select-style', this.$el).chosen({
				width: this.options.select_width,
				disable_search: true
			});

			//Wait for Chosen to be initialized
			setTimeout(function(){
				me.set_option_font(me.get_saved_value());
			}, 50);

		},
		map_labels: function(weight, style) {
			//Map font weight to labels
			var label, labels = {
				'100': l10n.label_thin,
				'200': l10n.label_extra_light,
				'300': l10n.label_light,
				'400': l10n.label_regular,
				'500': l10n.label_medium,
				'600': l10n.label_semi_bold,
				'700': l10n.label_bold,
				'800':  l10n.label_extra_bold,
				'900': l10n.label_ultra_bold
			}

			//Check if weight is number or string
			if (!_.isUndefined( weight ) && weight.match(/^(\d+)/)) {
				label = labels[weight];
			} else {
				label = weight;
			}

			//Display style only if style is Italic
			if(style == "italic") {
				label += ' ' + style;
			}

			return label;
		},
		on_change: function(event) {
			this.trigger('changed', this.get_value());
			this.$el.find('.chosen-drop').css('display', 'none');
			this.set_option_font(this.get_value());
		},
		set_option_font: function(value) {
			var font_family = this.$el.parent().parent().find('.upfront-chosen-select-typeface').val();
			var parsed_variant = Upfront.Views.Font_Model.parse_variant(value);
			this.$el.find('.chosen-single').css( {"font-family": font_family, "font-weight": parsed_variant.weight, "font-style": parsed_variant.style });
		},
		openOptions: function(e) {
			Field_Chosen_Select.prototype.openOptions.call(this);
		}
	});

	var Field_Multiple_Chosen_Select = Field_Chosen_Select.extend({
		events: {
			'change select': 'on_change',
			'click .chosen-container-multi': 'openOptions'
		},
		multiple: true,
		get_field_html: function() {
			var multiple = this.multiple ? 'multiple' : '';
			return ['<select class="upfront-chosen-select-multiple"' , multiple, ' data-placeholder="', this.options.placeholder,  '">', this.get_values_html(), '</select>'].join('');
		},
		get_value_html: function (value, index) {
			var selected = '';
			var saved_value = this.get_saved_value();
			if (_.contains(saved_value, value.value) ) {
				selected = ' selected="selected"';
			}
			return ['<option value="', value.value, '"', selected, '>', value.label, '</option>'].join('');
		},
		render: function() {
			Field_Chosen_Select.prototype.render.call(this);

			var me = this;
			$('.upfront-chosen-select-multiple', this.$el).chosen({
				width: this.options.select_width,
			});

		},
		on_change: function(event) {
			this.trigger('changed', this.get_value());
			this.$el.find('.chosen-drop').css('display', 'none');
		},
		openOptions: function(e) {
			Field_Chosen_Select.prototype.openOptions.call(this);
		}
	});

	var Field_Multiple_Input = Field_Multiple.extend({
		selected_state: 'checked',
		render: function () {
			var me = this;

			this.$el.html('');

			if ( this.label ) {
				this.$el.append(this.get_label_html());
			}

			this.$el.append(this.get_field_html());

			this.$el.on('change', '.upfront-field-multiple input', function(){
				me.$el.find('.upfront-field-multiple').each(function(){
					if ( $(this).find('input:checked').size() > 0 ) {
						$(this).addClass('upfront-field-multiple-selected');
					} else {
						$(this).removeClass('upfront-field-multiple-selected');
					}
				});

				me.trigger('changed', me.get_value());
			});

			this.trigger('rendered');
		},
		get_field_html: function () {
			return this.get_values_html();
		},
		get_value_html: function (value, index) {
			var id = this.get_field_id() + '-' + index;
			var classes = "upfront-field-multiple";
			var attr = {
				'type': this.type,
				'id': id,
				'name': this.get_field_name(),
				'value': value.value,
				'class': 'upfront-field-' + this.type
			};
			var saved_value = this.get_saved_value();
			var icon_class = this.options.icon_class ? this.options.icon_class : null;
			if ( this.options.layout ) classes += ' upfront-field-multiple-'+this.options.layout;
			if ( value.disabled ) {
				attr.disabled = 'disabled';
				classes += ' upfront-field-multiple-disabled';
			}
			if ( this.multiple && _.contains(saved_value, value.value) ) {
				attr.checked = 'checked';
			} else if ( ! this.multiple && saved_value == value.value ) {
				attr.checked = 'checked';
			}
			if (value.checked) attr.checked = 'checked';
			if ( attr.checked ) {
				classes += ' upfront-field-multiple-selected';
			}
			return '<span class="' + classes + '"><input ' + this.get_field_attr_html(attr) + ' />' + '<label for="' + id + '">' + this.get_icon_html(value.icon, icon_class) + '<span class="upfront-field-label-text">' + value.label + '</span></label></span>';
		}
	});

	var Field_Radios = Field_Multiple_Input.extend({
		className: 'upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios',
		type: 'radio'
	});

	var Field_Checkboxes = Field_Multiple_Input.extend({
		className: 'upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes',
		type: 'checkbox',
		multiple: true
	});

	var OptionalField = Field_Checkboxes.extend({
		className: 'upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes upfront-field-wrap-optional',
		events: {
			'change input': 'onChange'
		},

		initialize: function(opts){
			var me = this;
			OptionalField.__super__.initialize.apply(this, arguments);

			this.options = opts;

			this.on('panel:set', function(){
				this.panel.on('rendered', function(){
					me.onChange();
				});
			});

			if(opts.onChange) this.onChange = opts.onChange;
		},

		onChange: function(){
			var check = this.$('input'),
				related = this.panel.$('input[name=' + this.options.relatedField + ']').closest('.upfront-field-wrap')
			;
			if(check.is(':checked')) {
				related.show();
			} else {
				related.hide();
			}

			$('#settings').height(this.panel.$('.upfront-settings_panel').outerHeight());
			this.model.set_property(this.options.property, this.get_value());
		}
	});

	var Field_Multiple_Suggest = Field.extend(_.extend({}, Upfront_Scroll_Mixin, {
		events: {
			"click .upfront-suggest-add": "add_list",
			"focus .upfront-field-text-suggest": "reveal_suggest",
			"keyup .upfront-field-text-suggest": "update_suggest"
		},
		multiple: true,
		selected_state: 'checked',
		added_list: [],
		checked_list: [],
		suggest_list: [],
		render: function () {
			var me = this;
			this.$el.html('');
			if ( this.label ) this.$el.append(this.get_label_html());
			this.$el.append('<div class="upfront-suggest-wrap" />');
			var $wrap = this.$el.find('.upfront-suggest-wrap')
			$wrap.append(this.get_field_html());
			$wrap.append('<div class="upfront-suggest-list-wrap upfront-no-select" />');
			this.checked_list = this.get_saved_value();
			var $list_wrap = this.$el.find('.upfront-suggest-list-wrap');
			$list_wrap.append('<ul class="upfront-suggest-lists">' + this.get_suggest_list_html() + '</ul>');
			$list_wrap.append('<div class="upfront-suggest-add-wrap"><span class="upfront-suggest-add-value"></span><span class="upfront-suggest-add">' + l10n.add_new + '</span></div>');
			this.stop_scroll_propagation(this.$el.find('.upfront-suggest-lists'));
			this.$el.on('change', '.upfront-suggest-list input', function () {
				var value = $(this).val();
				if ( !$(this).is(':checked') && _.contains(me.checked_list, value) ) {
					me.checked_list = _.without(me.checked_list, value);
				} else {
					me.checked_list.push(value);
				}
				me.trigger('changed');
			});
			this.$el.on('click', function (e) {
				e.stopPropagation();
			});
			$('#settings').on('click', '.upfront-settings_panel', function(){
				me.$el.find('.upfront-suggest-list-wrap').removeClass('upfront-suggest-list-wrap-expanded');
			});

			this.trigger('rendered');
		},
		reveal_suggest: function () {
			this.$el.find('.upfront-suggest-list-wrap').addClass('upfront-suggest-list-wrap-expanded');
			this.update_suggest();
		},
		update_suggest: function () {
			var value = this.get_field_input_value();
			this.$el.find('.upfront-suggest-lists').html(this.get_suggest_list_html());
			if ( value ){
				this.$el.find('.upfront-suggest-add-wrap').show()
				this.$el.find('.upfront-suggest-add-value').text(value);
				this.$el.find('.upfront-suggest-add').toggle( !(_.contains(this.suggest_list, value)) );
			}
			else {
				this.$el.find('.upfront-suggest-add-wrap').hide();
			}
		},
		get_field_html: function () {
			var attr = {
				'type': 'text',
				'class': 'upfront-field upfront-field-text upfront-field-text-suggest',
				'id': this.get_field_id()
			};
			if ( this.options.placeholder ) attr['placeholder'] = this.options.placeholder;
			return '<input ' + this.get_field_attr_html(attr) + ' />';
		},
		get_suggest_list_html: function () {
			var value = this.get_field_input_value();
			var rgx = value ? new RegExp('('+value+')', 'ig') : false;
			var lists = this.get_suggest_list(rgx);
			var me = this;
			return _.map(lists, function(list, index){
				var id = me.get_field_id() + '-' + index;
				var attr = {
					'type': 'checkbox',
					'id': id,
					'name': me.get_field_name(),
					'value': list,
					'class': 'upfront-field-checkbox'
				};
				if ( _.contains(me.checked_list, list) ) attr.checked = 'checked';
				var label = rgx ? list.replace(rgx, '<span class="upfront-suggest-match">$1</span>') : list;
				return '<li class="upfront-suggest-list"><input ' + me.get_field_attr_html(attr) + ' /><label for="' + id + '">' + label +'</label></li>';
			}).join('');
		},
		get_suggest_list: function (rgx) {
			var suggest = [];
			_.each([this.options.source, this.added_list, this.get_saved_value()], function(list, index){
				_.each(list, function(value){
					if ( !( index == 2 && _.contains(suggest, value) ) && ( ( rgx && value.match(rgx) ) || !rgx ) ) {
						suggest.push(value);
					}
				});
			});
			this.suggest_list = suggest;
			return suggest;
		},
		get_field_input_value: function () {
			return this.$el.find('#'+this.get_field_id()).val();
		},
		empty_field_input_value: function () {
			return this.$el.find('#'+this.get_field_id()).val('');
		},
		add_list: function (e) {
			var value = this.get_field_input_value();
			this.added_list.push(value);
			this.checked_list.push(value);
			this.empty_field_input_value();
			this.update_suggest();
		}
	}));


	var SettingsItem = Backbone.View.extend({
		group: true,
		get_name: function () {
			if ( this.fields.length == 1 ) {
				return this.fields[0].get_name();
			} else if ( this.fields.length > 1 ) {
				return this.fields.map(function(field){ return field.get_name(); });
			}
		},
		get_value: function () {
			if ( this.fields.length == 1 ) {
				return this.fields[0].get_value();
			} else if ( this.fields.length > 1 ) {
				return this.fields.map(function(field){ return field.get_value(); });
			}
		},

		get_title: function () {
			return this.options.title ? this.options.title : '';
		},

		initialize: function (opts) {
			var me = this;
			me.options = opts;
			this.fields = opts.fields ? _(opts.fields) : _([]);
			this.group = typeof opts.group != 'undefined' ? opts.group : this.group;
			this.on('panel:set', function(){
				me.fields.each(function(field){
					field.panel = me.panel;
					field.trigger('panel:set');
				});
			});
		},

		render: function () {
			if (this.group) {
				this.$el.append(
					'<div class="upfront-settings-item">' +
						'<div class="upfront-settings-item-title"><span>' + this.get_title() + '</span></div>' +
						'<div class="upfront-settings-item-content"></div>' +
					'</div>'
				);
			} else {
				this.$el.append('<div class="upfront-settings-item-content"></div>');
			}

			var $content = this.$el.find('.upfront-settings-item-content');
			this.fields.each(function(field){
				field.render();
				field.delegateEvents();
				$content.append(field.el);
			});

			this.trigger('rendered');
		},

		save_fields: function () {
			var changed = _([]);
			this.fields.each(function(field, index, list){
				if (field.property) {
					var value = field.get_value() || [];
					var saved_value = field.get_saved_value();
					if ( ! field.multiple && value != saved_value ) {
						changed.push(field);
					} else if ( field.multiple && (value.length != saved_value.length || _.difference(value, saved_value).length != 0) ) {
						changed.push(field);
					}
				}
			});
			changed.each(function(field, index, list){
				if ( field.use_breakpoint_property ) {
					field.model.set_breakpoint_property(field.property_name, field.get_value(), true);
				} else {
					field.property.set({'value': field.get_value()}, {'silent': true});
				}
			});
			if ( changed.size() > 0 ) this.panel.is_changed = true;
		},

		//@TODO remove wrap method below when all elements have changed to use setting fields API
		wrap: function (wrapped) {
			if (!wrapped) return false;
			var title = wrapped.title || '',
				markup = wrapped.markup || wrapped
			;
			this.$el.append(
				'<div id="usetting-' + this.get_name() + '" class="upfront-settings-item">' +
					'<div class="upfront-settings-item-title"><span>' + title + '</span></div>' +
					'<div class="upfront-settings-item-content">' + markup + '</div>' +
				'</div>'
			);
		},

		remove: function(){
			if(this.fields) {
				this.fields.each(function(field){
					field.remove();
				});
			}
			Backbone.View.prototype.remove.call(this);
		}
	});

	var SettingsItemTabbed = Backbone.View.extend(_.extend({}, Upfront_Icon_Mixin, {
		className: 'upfront-settings-item-tab-wrap',
		radio: false,
		is_default: false,
		events: {
			"click .upfront-settings-item-tab": "reveal"
		},
		initialize: function (opts) {
			this.options = opts;
			this.settings = opts.settings ? _(opts.settings) : _([]);
			this.radio = ( typeof opts.radio != 'undefined' ) ? opts.radio : this.radio;
			this.is_default = ( typeof opts.is_default != 'undefined' ) ? opts.is_default : this.is_default;
		},
		get_title: function () {
			return this.options.title ? this.options.title : '';
		},
		get_icon: function () {
			return this.options.icon ? this.options.icon : '';
		},
		get_property: function () {
			return this.options.property ? this.options.property : '';
		},
		get_value: function () {
			return this.options.value ? this.options.value : '';
		},
		get_property_model: function () {
			var property = this.get_property();
			if ( !property ) return false;
			return this.model.get_property_by_name(property);
		},
		get_property_value: function () {
			var property_model = this.get_property_model();
			return property_model ? property_model.get('value') : '';
		},
		render: function () {
			var me = this;
			this.$el.html('');
			this.$el.append('<div class="upfront-settings-item-tab" />');
			this.$el.append('<div class="upfront-settings-item-tab-content" />');
			var $tab = this.$el.find('.upfront-settings-item-tab'),
				$tab_content = this.$el.find('.upfront-settings-item-tab-content');
			if ( this.radio ) {
				var property_model = this.get_property_model();
				if ( ! property_model ) {
					if ( this.is_default ) this.model.init_property(this.get_property(), this.get_value());
				}
				var id = this.cid + '-' + this.get_property();
				var $label = $('<label for="' + id + '" />')
				var checked = ( this.get_property_value() == this.get_value() );
				$label.append(this.get_icon_html(this.get_icon()));
				$label.append('<span class="upfront-settings-item-tab-radio-text">' + this.get_title() + '</span>');
				$tab.append($label);
				$tab.append('<input type="radio" id="' + id + '" class="upfront-field-radio" name="' + this.get_property() + '" value="' + this.get_value() + '" ' + ( checked ? 'checked="checked"' : '' ) +  ' />');
				this.$el.addClass('upfront-settings-item-tab-radio');
			} else {
				$tab.text(this.get_title());
			}
			this.settings.each(function(setting){
				setting.panel = me.panel;
				setting.render();
				$tab_content.append(setting.el);
			});
			//this.panel.on('rendered', this.panel_rendered, this);
			this.listenTo(this.panel, 'rendered', this.panel_rendered);

			this.trigger('rendered');
		},
		conceal: function () {
			this.$el.removeClass('upfront-settings-item-tab-active');
		},
		reveal: function () {
			this.panel.settings.invoke('conceal');
			this.$el.addClass('upfront-settings-item-tab-active');
			if ( this.radio ) {
				this.$el.find('.upfront-settings-item-tab input').prop('checked', true).trigger('change');
			}
		},
		panel_rendered: function () {
			if ( this.radio && (this.get_property_value() == this.get_value()) ) {
				this.reveal();
			}
		},
		save_fields: function () {
			this.settings.invoke('save_fields');
			if ( this.radio && this.$el.find('.upfront-settings-item-tab input:checked').size() > 0 ) {
				var property_model = this.get_property_model();
				if ( property_model ) {
					property_model.set({'value': this.get_value()}, {silent: true});
				} else {
					this.model.init_property(this.get_property(), this.get_value());
				}
				if ( this.get_property_value() != this.get_value() ) {
					this.panel.is_changed = true;
				}
			}
		},
		remove: function(){
			if(this.settings) {
				this.settings.each(function(setting){
					setting.remove();
				});
			}
			Backbone.View.prototype.remove.call(this);
		}
	}));

	var SettingsPanel = Backbone.View.extend(_.extend({}, Upfront_Scroll_Mixin, {
		className: 'upfront-settings_panel_wrap',
		// For Anchor & Styles settings
		hide_common_anchors: false,
		hide_common_fields: false,

		events: {
			"click .upfront-save_settings": "on_save",
			"click .upfront-cancel_settings": "on_cancel",
			"click .upfront-settings_label": "on_toggle",
    		"click .upfront-settings-common_panel .upfront-settings-item-title": "on_toggle_common",
    		"click .upfront-settings-padding_panel .upfront-settings-item-title": "on_toggle_padding"
		},

		get_title: function () {
			return this.options.title ? this.options.title : '';
		},

		get_label: function () {
			return this.options.label ? this.options.label : '';
		},

		initialize: function (options) {
			var me = this;
			this.hide_common_fields = _.isUndefined(options.hide_common_fields) ? false : options.hide_common_fields;
			this.hide_common_anchors = _.isUndefined(options.hide_common_anchors) ? false : options.hide_common_anchors;
			me.options = options;
			this.settings = options.settings ? _(options.settings) : _([]);
			this.settings.each(function(setting){
				setting.panel = me;
				setting.trigger('panel:set');
			});
			this.tabbed = ( typeof options.tabbed != 'undefined' ) ? options.tabbed : this.tabbed;
		},

		tabbed: false,
		is_changed: false,

		render: function () {
			this.$el.html('<div class="upfront-settings_label" /><div class="upfront-settings_panel" ><div class="upfront-settings_panel_scroll" />');

			var $label = this.$el.find(".upfront-settings_label"),
				$panel = this.$el.find(".upfront-settings_panel"),
				$panel_scroll = this.$el.find(".upfront-settings_panel_scroll"),
				$common_panel,
				me = this
			;

			$label.append(this.get_label());
			this.settings.each(function (setting) {
				if ( ! setting.panel ) {
					setting.panel = me;
				}
				setting.render();
				$panel_scroll.append(setting.el)
			});
			if ( this.options.min_height ) {
				$panel_scroll.css('min-height', this.options.min_height);
			}
			if ( this.tabbed ) {
				var first_tab = this.settings.first();
				if ( !first_tab.radio ) {
					first_tab.reveal();
				}
				$panel_scroll.append('<div class="upfront-settings-tab-height" />');
			}
			this.stop_scroll_propagation($panel_scroll);
			// Add common fields
			if (this.hide_common_fields === false) {
				this.$el.find('.upfront-settings_panel_scroll').after('<div class="upfront-settings-common_panel"></div>');
				$common_panel = this.$el.find(".upfront-settings-common_panel");
				// Let's disable CSS settings panel as this is not used anymore
				/*if (typeof this.cssEditor == 'undefined' || this.cssEditor) {
					// Adding CSS item
					var css_settings = new _Settings_CSS({
						model: this.model,
						title: (false === this.hide_common_anchors ? l10n.css_and_anchor : l10n.css_styles)
					});
					css_settings.panel = me;
					css_settings.render();
					$common_panel.append(css_settings.el);
				}*/
				// Adding anchor trigger
				//todo should add this check again// if (this.options.anchor && this.options.anchor.is_target) {

				if (this.hide_common_anchors === false) {
					var anchor_settings = new _Settings_AnchorSetting({
						model: this.model,
						title: l10n.anchor_settings
					});
					anchor_settings.panel = me;
					anchor_settings.render();
					$common_panel.append(anchor_settings.el);
				}

				// this.listenTo(anchor_settings, "anchor:item:updated", function () {
					// this.toggle_panel(first); //todo don't know what this was for should investigate
				// });
			}
			// Padding panel
			this.$el.find('.upfront-settings_panel_scroll').after('<div class="upfront-settings-padding_panel"></div>');
			$padding_panel = this.$el.find(".upfront-settings-padding_panel");
			if(typeof this.paddingEditor == 'undefined' || this.paddingEditor){
				// Adding Padding item
				this.paddingEditor = new _Settings_Padding({
					model: this.model,
					title: l10n.padding_settings
				});
				this.paddingEditor.panel = me;
				this.paddingEditor.render();
				$padding_panel.append(this.paddingEditor.el);
			}
			// Save button
			$panel.append(
				"<div class='upfront-settings-button_panel'>" +
					"<button type='button' class='upfront-save_settings'><i class='icon-ok'></i> " + l10n.ok + "</button>" +
				'</div>'
			);

			this.$el.fadeIn('fast', function() {
				// Scroll the window if settings box clips vertically
				var parent = me.$el.parent();
				var elementbottom = (parent.offset() ? parent.offset().top : 0) + parent.height();
				var winheight = jQuery(window).height();

				if( (elementbottom +60) > (winheight+jQuery('body').scrollTop())) {
					jQuery('body').animate({scrollTop:(elementbottom - winheight + 60)}, 'slow');
				}

			});
			this.trigger('rendered');
		},

		on_toggle_common: function () {
			var me = this;
			var panel = this.$el.find('.upfront-settings-common_panel');
			panel.toggleClass('open');
			/*if(panel.is('.open')) {
				this.$el.find('.upfront-settings-common_panel .upfront-settings-item-title span').first().html(l10n.element_css_styles);
			} else {
				this.$el.find('.upfront-settings-common_panel .upfront-settings-item-title span').first().html(
					(false === me.hide_common_anchors ? l10n.css_and_anchor : l10n.css_styles)
				);
			}*/
		},

		on_toggle_padding: function () {
			var me = this;
			var panel = this.$el.find('.upfront-settings-padding_panel');
			panel.toggleClass('open');
		},

		conceal: function () {
			this.$el.find(".upfront-settings_panel").hide();
			this.$el.find(".upfront-settings_label").removeClass("active");
			//this.$el.find(".upfront-settings_label").show();
			this.trigger('concealed');
		},

		reveal: function () {
			this.$el.find(".upfront-settings_label").addClass("active");
			//this.$el.find(".upfront-settings_label").hide();
			this.$el.find(".upfront-settings_panel").show();
			if ( this.tabbed ) {
				var tab_height = 0;
				this.$el.find('.upfront-settings-item-tab-content').each(function(){
					var h = $(this).outerHeight(true);
					tab_height = h > tab_height ? h : tab_height;
				});
				this.$el.find('.upfront-settings-tab-height').css('height', tab_height);
			}
			this.trigger('revealed');
		},

		show: function () {
			this.$el.show();
		},

		hide: function () {
			this.$el.hide();
		},

		is_active: function () {
			return this.$el.find(".upfront-settings_panel").is(":visible");
		},

		on_toggle: function () {
			this.trigger("upfront:settings:panel:toggle", this);
			this.show();
		},
		//@Furqan and this for Loading for pnaels
		start_loading: function (loading_message, loading_complete_message) {
			this.loading = new Upfront.Views.Editor.Loading({
				loading: loading_message,
				done: loading_complete_message
			});
			this.loading.render();
			this.$el.find(".upfront-settings_panel").append(this.loading.$el);
		},
		end_loading: function (callback) {
			if ( this.loading ) {
				this.loading.done(callback);
			} else {
				callback();
			}
		},
		//end
		on_save: function () {
			var any_panel_changed = false;
			this.parent_view.panels.each(function(panel){
				panel.save_settings();
				if ( panel.is_changed ) {
					any_panel_changed = true;
					panel.is_changed = false;
				}
			});
			if ( any_panel_changed ) {
				this.parent_view.model.get("properties").trigger('change');
			}
			this.trigger("upfront:settings:panel:saved", this);
			Upfront.Events.trigger("entity:settings:deactivate");
		},
		save_settings: function () {
			if (!this.settings) return false;

			var me = this;
			this.settings.each(function (setting) {
				if ( (setting.fields || setting.settings).size() > 0 ) {
					setting.save_fields();
				} else {
					var value = me.model.get_property_value_by_name(setting.get_name());
					if ( value != setting.get_value() ) {
						me.model.set_property(
							setting.get_name(),
							setting.get_value()
						);
					}
				}
			});
			Upfront.Events.trigger("entity:settings:saved");
		},

		on_cancel: function () {
			this.trigger("upfront:settings:panel:close", this);
		},
		remove: function(){
			if (this.settings) {
				this.settings.each(function(setting){
					setting.remove();
				});
			}
			this.$el.off();
			Backbone.View.prototype.remove.call(this);
		}

	}));

	var Settings = Backbone.View.extend({
   	has_tabs: true,

		initialize: function(opts) {
			this.options = opts;
			this.panels = _([]);
		},
		get_title: function () {
			return l10n.settings;
		},

		render: function () {
			var me = this,
				$view = me.for_view.$el.hasClass('upfront-editable_entity') ? me.for_view.$el : me.for_view.$el.find(".upfront-editable_entity:first"),
				view_pos = $view.offset(),
				view_outer_width = $view.outerWidth(),
				view_pos_right = view_pos.left + view_outer_width,
				$button = ($view.hasClass('upfront-object') ? $view.closest('.upfront-module') : $view).find("> .upfront-element-controls .upfront-icon-region-settings"),
				button_pos = $button.offset(),
				button_pos_right = button_pos.left + $button.outerWidth(),
				$main = $(Upfront.Settings.LayoutEditor.Selectors.main),
				main_pos = $main.offset(),
				main_pos_right = main_pos.left + $main.outerWidth()
			;
			me.$el
				.empty()
				.show()
				.html(
					'<div class="upfront-settings_title">' + this.get_title() + '</div>'
				)
			;

			/*
			 * This event is broadcast so that other plugins can register their
			 * own Upfront element for the CSS Editor before the settings panel
			 * is displayed.
			 *
			 * Example:
			 * Upfront.Events.on( 'settings:prepare', function() {
			 *   args = {label: 'My Element', id: 'my_element'};
			 *   Upfront.Application.cssEditor.elementTypes['ElementModel'] = args;
			 * });
			 */
			Upfront.Events.trigger("settings:prepare");

			me.panels.each(function (panel) {
				panel.render();

				me.listenTo(panel, "upfront:settings:panel:toggle", me.toggle_panel);
				me.listenTo(panel, "upfront:settings:panel:close", me.close_panel);
				me.listenTo(panel, "upfront:settings:panel:refresh", me.refresh_panel);

				panel.parent_view = me;
				me.$el.append(panel.el);
			});

			this.toggle_panel(this.panels.first());

			var label_width = this.panels.first().$el.find('.upfront-settings_label').outerWidth(),
				panel_width = this.panels.first().$el.find('.upfront-settings_panel').outerWidth();

			// This will remove tabs from left side if element settings have specified so.
			// Default is to show tabs.
			if (!this.has_tabs) {
				label_width = 0;
				this.$el.addClass('settings-no-tabs');
			}

			this.$el
				.css({
					"position": "absolute",
					"z-index": 10000000
				})
				.offset({
					"top": view_pos.top /*+ $view.height() + 16*/,
					"left": view_pos.left + view_outer_width - ((view_pos_right+label_width+panel_width > main_pos_right) ? label_width+panel_width+(view_pos_right-button_pos.left)+5 : 0)
				})
				.addClass('upfront-ui')
			;

			this.trigger('open');
		},

		set_title: function (title) {
			if (!title || !title.length) return false;
			this.$el.find(".upfront-settings_title").html(title);
		},
		toggle_panel: function (panel) {
			this.panels.invoke("conceal");
			panel.$el.find(".upfront-settings_panel").css('height', '');
			panel.show();
			panel.reveal();
			this.set_title(panel.get_title());
			var min_height = 0;
			this.panels.each(function(p){
				min_height += p.$el.find(".upfront-settings_label").outerHeight();
			});
			var panel_height = panel.$el.find(".upfront-settings_panel").outerHeight() - 1;
			if ( panel_height >= min_height ) {
				this.$el.css('height', panel_height);
			} else {
				panel.$el.find(".upfront-settings_panel").css('height', min_height);
				this.$el.css('height', min_height);
			}
		},

		refresh_panel: function (panel) {
			if (panel.is_active()) this.toggle_panel(panel);
		},

		close_panel: function (panel) {
			this.panels.invoke("conceal");
			this.panels.invoke("show");
			this.set_title(this.get_title());
		},
		remove: function(){
			if (this.panels) {
				this.panels.each(function(panel){
					panel.remove();
				});
			}
			Backbone.View.prototype.remove.call(this);
		}
	});


var _Settings_Padding = SettingsItem.extend({
	className: 'upfront-settings-padding',
	initialize: function(options) {
		var column_padding = Upfront.Settings.LayoutEditor.Grid.column_padding,
			is_group = this.model instanceof Upfront.Models.ModuleGroup,
			top_padding_use = new Field_Checkboxes({
				model: this.model,
				use_breakpoint_property: true,
				property: 'top_padding_use',
				label: '',
				multiple: false,
				values: [{ label: l10n.top_padding, value: 'yes' }],
				default_value: this.model.get_breakpoint_property_value('top_padding_use') || false,
				change: function () {
					var value = this.get_value();

					this.model.set_breakpoint_property('top_padding_use', value ? value : 0);
				},
				show: function (value, $el) {
					if(value === 'yes') {
						$(top_padding_slider.$el).css('display', 'inline-block');
						$(top_padding_num.$el).css('display', 'inline-block');
					}
					else {
						$(top_padding_slider.$el).hide();
						$(top_padding_num.$el).hide();
					}
				}
			}),
			top_padding_slider = new Field_Slider({
				model: this.model,
				use_breakpoint_property: true,
				property: 'top_padding_slider',
				label: '',
				default_value: this.model.get_breakpoint_property_value('top_padding_slider') || column_padding,
				min: 0,
				max: 200,
				step: 5,
				valueTextFilter: function () {return '';},
				change: function () {
					var value = this.get_value();

					this.model.set_breakpoint_property('top_padding_slider', value);
					top_padding_num.get_field().val(value);
					this.model.set_breakpoint_property('top_padding_num', value, true);
				}
			}),
			top_padding_num = new Field_Number({
				model: this.model,
				use_breakpoint_property: true,
				property: 'top_padding_num',
				label: '',
				default_value: this.model.get_breakpoint_property_value('top_padding_num') || column_padding,
				suffix: 'px',
				min: 0,
				step: 5,
				change: function () {
					var value = this.get_value();

					this.model.set_breakpoint_property('top_padding_num', value);
					this.model.set_breakpoint_property('top_padding_slider', value, true);
					top_padding_slider.$el.find('#'+top_padding_slider.get_field_id()).slider('value', value);
				}
			}),
			bottom_padding_use = new Field_Checkboxes({
				model: this.model,
				use_breakpoint_property: true,
				property: 'bottom_padding_use',
				label: '',
				multiple: false,
				values: [{ label: l10n.bottom_padding, value: 'yes' }],
				default_value: this.model.get_breakpoint_property_value('bottom_padding_use') || false,
				change: function () {
					var value = this.get_value();

					this.model.set_breakpoint_property('bottom_padding_use', value ? value : 0);
				},
				show: function (value, $el) {
					if(value === 'yes') {
						$(bottom_padding_slider.$el).css('display', 'inline-block');
						$(bottom_padding_num.$el).css('display', 'inline-block');
					}
					else {
						$(bottom_padding_slider.$el).hide();
						$(bottom_padding_num.$el).hide();
					}
				}
			}),
			bottom_padding_slider = new Field_Slider({
				model: this.model,
				use_breakpoint_property: true,
				property: 'bottom_padding_slider',
				label: '',
				default_value: this.model.get_breakpoint_property_value('bottom_padding_slider') || column_padding,
				min: 0,
				max: 200,
				step: 5,
				valueTextFilter: function () {return '';},
				change: function () {
					var value = this.get_value();

					this.model.set_breakpoint_property('bottom_padding_slider', value);
					bottom_padding_num.get_field().val(value);
					this.model.set_breakpoint_property('bottom_padding_num', value, true);
				}
			}),
			bottom_padding_num = new Field_Number({
				model: this.model,
				use_breakpoint_property: true,
				property: 'bottom_padding_num',
				label: '',
				default_value: this.model.get_breakpoint_property_value('bottom_padding_num') || column_padding,
				suffix: 'px',
				min: 0,
				step: 5,
				change: function () {
					var value = this.get_value();

					this.model.set_breakpoint_property('bottom_padding_num', value);
					this.model.set_breakpoint_property('bottom_padding_slider', value, true);
					bottom_padding_slider.$el.find('#'+bottom_padding_slider.get_field_id()).slider('value', value);
				}
			})
		;
		if ( !is_group ) {
			var	left_padding_use = new Field_Checkboxes({
					model: this.model,
					use_breakpoint_property: true,
					property: 'left_padding_use',
					label: '',
					multiple: false,
					values: [{ label: l10n.left_padding, value: 'yes' }],
					default_value: this.model.get_breakpoint_property_value('left_padding_use') || false,
					change: function () {
						var value = this.get_value();

						this.model.set_breakpoint_property('left_padding_use', value ? value : 0);
					},
					show: function (value, $el) {
						if(value === 'yes') {
							$(left_padding_slider.$el).css('display', 'inline-block');
							$(left_padding_num.$el).css('display', 'inline-block');
						}
						else {
							$(left_padding_slider.$el).hide();
							$(left_padding_num.$el).hide();
						}
					}
				}),
				left_padding_slider = new Field_Slider({
					model: this.model,
					use_breakpoint_property: true,
					property: 'left_padding_slider',
					label: '',
					default_value: this.model.get_breakpoint_property_value('left_padding_slider') || column_padding,
					min: 0,
					max: 200,
					step: 5,
					valueTextFilter: function () {return '';},
					change: function () {
						var value = this.get_value();

						this.model.set_breakpoint_property('left_padding_slider', value);
						left_padding_num.get_field().val(value);
						this.model.set_breakpoint_property('left_padding_num', value, true);
					}
				}),
				left_padding_num = new Field_Number({
					model: this.model,
					use_breakpoint_property: true,
					property: 'left_padding_num',
					label: '',
					default_value: this.model.get_breakpoint_property_value('left_padding_num') || column_padding,
					suffix: 'px',
					min: 0,
					step: 5,
					change: function () {
						var value = this.get_value();

						this.model.set_breakpoint_property('left_padding_num', value);
						this.model.set_breakpoint_property('left_padding_slider', value, true);
						left_padding_slider.$el.find('#'+left_padding_slider.get_field_id()).slider('value', value);
					}
				}),
				right_padding_use = new Field_Checkboxes({
					model: this.model,
					use_breakpoint_property: true,
					property: 'right_padding_use',
					label: '',
					multiple: false,
					values: [{ label: l10n.right_padding, value: 'yes' }],
					default_value: this.model.get_breakpoint_property_value('right_padding_use') || false,
					change: function () {
						var value = this.get_value();

						this.model.set_breakpoint_property('right_padding_use', value ? value : 0);
					},
					show: function (value, $el) {
						if(value === 'yes') {
							$(right_padding_slider.$el).css('display', 'inline-block');
							$(right_padding_num.$el).css('display', 'inline-block');
						}
						else {
							$(right_padding_slider.$el).hide();
							$(right_padding_num.$el).hide();
						}
					}
				}),
				right_padding_slider = new Field_Slider({
					model: this.model,
					use_breakpoint_property: true,
					property: 'right_padding_slider',
					label: '',
					default_value: this.model.get_breakpoint_property_value('right_padding_slider') || column_padding,
					min: 0,
					max: 200,
					step: 5,
					valueTextFilter: function () {return '';},
					change: function () {
						var value = this.get_value();

						this.model.set_breakpoint_property('right_padding_slider', value);
						right_padding_num.get_field().val(value);
						this.model.set_breakpoint_property('right_padding_num', value, true);
					}
				}),
				right_padding_num = new Field_Number({
					model: this.model,
					use_breakpoint_property: true,
					property: 'right_padding_num',
					label: '',
					default_value: this.model.get_breakpoint_property_value('right_padding_num') || column_padding,
					suffix: 'px',
					min: 0,
					step: 5,
					change: function () {
						var value = this.get_value();

						this.model.set_breakpoint_property('right_padding_num', value);
						this.model.set_breakpoint_property('right_padding_slider', value, true);
						right_padding_slider.$el.find('#'+right_padding_slider.get_field_id()).slider('value', value);
					}
				})
			;
		}

		SettingsItem.prototype.initialize.call(this, options);

		if ( !is_group ){
			this.fields = _([
				top_padding_use,
				top_padding_slider,
				top_padding_num,
				bottom_padding_use,
				bottom_padding_slider,
				bottom_padding_num,
				left_padding_use,
				left_padding_slider,
				left_padding_num,
				right_padding_use,
				right_padding_slider,
				right_padding_num
			]);
		}
		else {
			this.fields = _([
				top_padding_use,
				top_padding_slider,
				top_padding_num,
				bottom_padding_use,
				bottom_padding_slider,
				bottom_padding_num
			]);
		}
	}
});

var _Settings_CSS = SettingsItem.extend({
	className: 'upfront-settings-css',
	events: {
		'click .upfront-css-edit': 'openEditor',
	},
	initialize: function(options) {
		SettingsItem.prototype.initialize.call(this, options);
		if (!Upfront.Application.cssEditor) return false;

		var styleType = Upfront.Application.cssEditor.getElementType(this.model),
			values = [{label: l10n.default_str, value: '_default'}];

		if (Upfront.data.styles[styleType.id]) {
			_.each(Upfront.data.styles[styleType.id], function(styleName){
				if (styleName.indexOf('_default') > -1) return;
				values.push({label: styleName, value: styleName});
			});
		}

		this.fields = _([
			new Upfront.Views.Editor.Field.Button({
				model: this.model,
				className: 'edit-preset-css-label',
				compact: true,
				label: l10n.edit_css_label,
			}),

			new Upfront.Views.Editor.Field.Button({
				model: this.model,
				className: 'upfront-css-edit',
				compact: true,
				name: 'preset_css',
				label: l10n.edit_css,
			})
		]);
	},

	openEditor: function(e){
		e.preventDefault();

		Upfront.Events.trigger("entity:settings:beforedeactivate");

		Upfront.Application.cssEditor.init({
			model: this.model,
			stylename: '_default' // Let's make sure we have *something* to work with
		});

		Upfront.Events.trigger("entity:settings:deactivate");

		//$('#settings').find('.upfront-save_settings').click();
	},
});

var ButtonPresetModel = Backbone.Model.extend({
	initialize: function(attributes) {
		this.set({ presets: attributes });
	}
});
var ButtonPresetsCollection = Backbone.Collection.extend({
	model: ButtonPresetModel
});

var button_presets_collection = new ButtonPresetsCollection(Upfront.mainData.buttonPresets);

var Button_Presets_Storage = function(stored_presets) {
	var button_presets;

	var initialize = function() {
		// When more than one weights are added at once don't send bunch of server calls
		var save_button_presets_debounced = _.debounce(save_button_presets, 100);
		button_presets_collection.on('add remove edit', save_button_presets_debounced);
	};

	var save_button_presets = function() {
		var postData = {
			action: 'upfront_update_button_presets',
			button_presets: button_presets_collection.toJSON()
		};

		Upfront.Util.post(postData)
			.error(function(){
				return notifier.addMessage(l10n.button_presets_save_fail);
			});
	};

	initialize();
};
var button_presets_storage = new Button_Presets_Storage();

// THEME FONTS START HERE //
var Font_Model = Backbone.Model.extend({}, {
	/*
	 * Parsing variant to get style and weight for font.
	 * @return Object { style: style, weight: weight }
	 */
	parse_variant: function(variant) {
		var parsed_variant;
		// For system fonts there are variants in format "{number} {style}" where {number} is
		// 100-900 with step of 100, and {style} is "normal", "italic" or "oblique"
		//
		// Fog google fonts variants can be in format "regular", "italic", "100" to "900",
		// "100italic" to "900italic".
		//
		// From browser font-weight[s] we'll use: 100 to 900, normal.
		// From browser font-style we'll use: italic, normal, oblique.
		//
		// Regular variant means that both font-weight and font-style are normal or not set.
		// Always set both style and weight to make everything easier.
		// Always use numbers for weight to make everything easier.
		if (variant === 'inherit') {
			return {
				weight: 'inherit',
				style: 'inherit'
			};
		}

		// Cover both '100italic' and '100 italic'
		if (!_.isUndefined( variant ) && variant.match(/^(\d+) *(normal|italic|oblique)$/)) {
			parsed_variant =  variant.match(/^(\d+) *(normal|italic|oblique)/);
			return {
				weight: parsed_variant[1],
				style: parsed_variant[2]
			};
		}

		if (variant === 'italic') {
			return {
				weight: '400',
				style: 'italic'
			};
		}

		// Cover 100, 200, 500 etc styles
		if ( !_.isUndefined( variant ) && variant.match(/^\d+$/)) {
			return {
				weight: variant,
				style: 'normal'
			};
		}

		// Default return value, also covers "regular" variant
		return {
			weight: '400',
			style: 'normal'
		};
	},
	/*
	 * Constructs variant from weight and style.
	 *
	 * Variant should always be displayed as:
	 * "{weight} {style}"
	 * where weight is {number} from 100 to 900 step 100 and {style} is
	 * "normal", "italic" or "oblique".
	 * Unless:
	 * 1. weight is 400(normal) and style is "normal" than variant is "regular".
	 * 2. weight is 400(normal) and style is "italic" than variant is "italic",
	 *
	 * @return String variant
	 */
	get_variant: function(weight, style) {
		if (weight === 'inherit' || style === 'inherit') {
			return 'inherit';
		}

		weight = this.normalize_weight(weight);
		if (style === '') style = 'normal';

		if (weight === '400' && style === 'normal') return 'regular';
		if (weight === '400' && style === 'italic') return 'italic';

		return weight + ' ' + style;
	},
	/*
	 * @see get_variant()
	 */
	normalize_variant: function(variant) {
		var parsed_variant = this.parse_variant(variant);
		return this.get_variant(parsed_variant.weight, parsed_variant.style);
	},
	/*
	 * Convert weight to number for comparison.
	 */
	normalize_weight: function (weight) {
		if ( weight == 'normal' || weight == '' ) return 400;
		if ( weight == 'lighter' ) return 100; // either 100-300 depend to the available weight
		if ( weight == 'bold' ) return 700;
		if ( weight == 'bolder' ) return 900; // either 800-900 depend to the available weight
		return weight;
	},
	get_default_variant: function(family) {
		return 'inherit';
	}
});

var Fonts_Collection = Backbone.Collection.extend({
	model: Font_Model
});

/**
 * Takes care about Google fonts.
 */
var Google_Fonts_Storage = function() {
	var fonts = false;

	/*
	 * Returns deferred that resolves to fonts collection containing all Google fonts.
	 */
	this.get_fonts = function() {
		if (fonts) return fonts;

		var request = Upfront.Util.post({action: "upfront_list_google_fonts"});

		// We're gonna pipe response since we need to convert it to fonts collection first.
		request = request.pipe(
			function(response) {
				fonts = new Fonts_Collection(response.data);
				// Return collection instead original response
				return fonts;
			}
		);

		return request;
	};
};

var google_fonts_storage = new Google_Fonts_Storage();

var System_Fonts_Storage = function() {
	var font_families = [
		{ family: "Andale Mono", category:'monospace' },
		{ family: "Arial", category:'sans-serif' },
		{ family: "Arial Black", category:'sans-serif' },
		{ family: "Courier New", category:'monospace' },
		{ family: "Georgia", category:'serif' },
		{ family: "Impact", category:'sans-serif' },
		{ family: "Times New Roman", category:'serif' },
		{ family: "Trebuchet MS", category:'sans-serif' },
		{ family: "Verdana", category:'sans-serif' }
	];

	var system_fonts = new Fonts_Collection();

	var initialize = function() {
		var variants;

		// Default variants for system fonts
		variants = ['Inherit', '400', '400 italic', '700', '700 italic'];

		// Add variants
		_.each(font_families, function(font_family) {
				font_family.variants = variants;
				system_fonts.add(font_family);
		});
	};

	this.get_fonts = function() {
		return system_fonts;
	}

	initialize();
}

var system_fonts_storage = new System_Fonts_Storage();

var ButtonPresetModel = Backbone.Model.extend();
var ButtonPresetsCollection = Backbone.Collection.extend({
	model: ButtonPresetModel
});

var button_presets_collection = new ButtonPresetsCollection(Upfront.mainData.buttonPresets);

var Button_Presets_Storage = function(stored_presets) {
	var button_presets;

	var initialize = function() {
		// When more than one weights are added at once don't send bunch of server calls
		var save_button_presets_debounced = _.debounce(save_button_presets, 100);
		button_presets_collection.on('add remove edit', save_button_presets_debounced);
	};

	var save_button_presets = function() {
		var postData = {
			action: 'upfront_update_button_presets',
			button_presets: button_presets_collection.toJSON()
		};

		Upfront.Util.post(postData)
			.error(function(){
				return notifier.addMessage(l10n.button_presets_save_fail);
			});
	};

	initialize();
};
var button_presets_storage = new Button_Presets_Storage();

var ThemeFontModel = Backbone.Model.extend({
	initialize: function(attributes) {
		this.set({ displayVariant: Font_Model.normalize_variant(attributes.variant) }, { silent: true });
	}
});

var ThemeFontsCollection = Backbone.Collection.extend({
	model: ThemeFontModel,
	get_fonts_for_select: function() {
		var typefaces_list = [{ label: l10n.choose_font, value:'' }],
			google_fonts = [];


		_.each(theme_fonts_collection.models, function(theme_font) {
			google_fonts.push(theme_font.get('font').family);
		});
		_.each(_.uniq(google_fonts), function(google_font) {
			typefaces_list.push({label: google_font, value: google_font});
		});
		_.each(Upfront.mainData.additionalFonts, function(font) {
			typefaces_list.push({label: font.family, value: font.family});
		});
		_.each(system_fonts_storage.get_fonts().models, function(font)	{
			typefaces_list.push({ label: font.get('family'), value: font.get('family') });
		});

		return typefaces_list;
	},

	get_variants: function(font_family) {
		var variants;

		_.each(system_fonts_storage.get_fonts().models, function(font) {
			if (font_family === font.get('family')) {
				variants = font.get('variants');
			}
		});
		if (variants) {
			return variants;
		}

		_.each(Upfront.mainData.additionalFonts, function(font) {
			if (font_family === font.family) {
				variants = ['inherit'].concat(font.variants);
			}
		});

		if (variants) {
			return variants;
		}

		variants = [];
		_.each(theme_fonts_collection.models, function(theme_font) {
			if (font_family === theme_font.get('font').family) {
				variants.push(theme_font.get('displayVariant'));
			}
		});

		variants.unshift('inherit');
		return variants;
	},

	get_variants_for_select: function(font_family) {
		var variants;
		var typefaces_list = [];

		_.each(system_fonts_storage.get_fonts().models, function(font) {
			if (font_family === font.get('family')) {
				_.each(font.get('variants'), function(font_style) {
					typefaces_list.push({ label: font_style, value: font_style });
				});
			}
		});

		_.each(Upfront.mainData.additionalFonts, function(font) {
			if (font_family === font.family) {
				_.each(font.variants, function(font_style) {
					typefaces_list.push({ label: font_style, value: font_style });
				});
			}
		});

		_.each(theme_fonts_collection.models, function(theme_font) {
			if (font_family === theme_font.get('font').family) {
				var font_style = theme_font.get('displayVariant');
				typefaces_list.push({ label: font_style, value: font_style });
			}
		});

		return typefaces_list;
	},


	get_additional_font: function(font_family) {
		var font = _.findWhere(Upfront.mainData.additionalFonts, {family: font_family});
		if (font) return new Backbone.Model(font);
		return;
	}
});

var theme_fonts_collection = new ThemeFontsCollection(Upfront.mainData.themeFonts);

var IconFont = Backbone.Model.extend({
	getUploadStatus: function() {
		if (_.keys(this.get('files')).length === 4) {
			return true;
		}
		var text = 'Please upload:';
		_.each(['eot', 'woff', 'svg', 'ttf'], function(type) {
			if (_.isUndefined(this.get('files')[type])) {
				text += ' ' + type + ',';
			}
		}, this);
		return text.substring(0, text.length - 1) + ' file(s).';
	}
});
var IconFontCollection = Backbone.Collection.extend({
	model: IconFont
});
var icon_fonts_collection = new IconFontCollection(Upfront.mainData.iconFonts);

var Theme_Fonts_Storage = function(stored_fonts) {
	var theme_fonts;

	var initialize = function() {
		// When more than one weights are added at once don't send bunch of server calls
		var save_theme_fonts_debounced = _.debounce(save_theme_fonts, 100);
		theme_fonts_collection.on('add remove', save_theme_fonts_debounced);
	};

	var save_theme_fonts = function() {
		var postData = {
			action: 'upfront_update_theme_fonts',
			theme_fonts: theme_fonts_collection.toJSON()
		};

		Upfront.Util.post(postData)
			.error(function(){
				return notifier.addMessage(l10n.theme_fonts_save_fail);
			});
	};

	initialize();
};

var theme_fonts_storage = new Theme_Fonts_Storage();

var ThemeFontListItem = Backbone.View.extend({
	className: 'theme-font-list-item',
	events: {
		'click': 'on_click',
		'click .delete': 'on_delete'
	},
	template: $(_Upfront_Templates.popup).find('#theme-font-list-item').html(),
	render: function() {
		this.$el.html(_.template(this.template, {
			family: this.model.get('font').family,
			variant: this.model.get('displayVariant')
		}));

		return this;
	},
	on_click: function() {
		this.$el.siblings().removeClass('theme-font-list-item-selected');
		this.$el.addClass('theme-font-list-item-selected');

		this.trigger('selected', this.model.toJSON());
	},
	on_delete: function() {
		theme_fonts_collection.remove(this.model);
		this.remove();
	}
});

var ThemeFontsPanel = Backbone.View.extend({
	className: 'theme-fonts-panel panel',
	template: _.template($(_Upfront_Templates.popup).find('#theme-fonts-panel').html()),
	initialize: function(options) {
		this.options = options || {};
		this.listenTo(this.collection, 'add remove', this.update_stats);
		this.listenTo(this.collection, 'add remove', this.render);
	},
	render: function() {
		this.$el.html('');
		this.$el.html(this.template({show_no_styles_notice: this.collection.length === 0}));

		if (this.collection.length > 0) this.$el.find('.font-list').css('background', 'white');

		_.each(this.collection.models, function(model) {
			this.add_one(model);
		}, this);

		this.update_stats();

		return this;
	},
	update_stats: function() {
		var msg = l10n.font_styles_selected.replace(/%d/, this.collection.length);
		this.$el.find('.font-stats').html('<strong>' + msg + '</strong>');
	},
	add_one: function(model) {
		var themeFontView = new ThemeFontListItem({ model: model });
		this.options.parent_view.listenTo(themeFontView, 'selected', this.options.parent_view.replaceFont);
		this.$el.find('.font-list').append(themeFontView.render().el);
	}
});

var Variant_View = Backbone.View.extend({
	initialize: function(options){
		this.options = options || {};
	},
	className: function() {
		var className = 'font-variant-preview';
		if (this.model.get('already_added')) {
			className += ' font-variant-already-added';
		}
		return className;
	},
	template: _.template('<span class="font-family">{{family}} — {{name}}</span>{[ if(already_added) { ]} <span class="already-added">' + l10n.already_added + '</span>{[ } ]}' +
			'{[ if(heading_preview) { ]}<h1 style="font-family: {{family}}; font-weight: {{weight}}; font-style: {{style}};" class="heading-font-preview font-preview">' + l10n.header_preview_quote + '</h1>{[ } else { ]}' +
			'<p style="font-family: {{family}}; font-weight: {{weight}}; font-style: {{style}};" class="paragraph-font-preview font-preview">' + l10n.body_preview_quote + '</p>{[ } ]}'),
	events: {
		'click': 'on_click'
	},
	render: function() {
		this.$el.html(this.template(_.extend({heading_preview: this.options.heading_preview}, this.model.toJSON())));
		return this;
	},
	on_click: function() {
		if (this.model.get('already_added')) return;
		this.model.set({selected: !this.model.get('selected')});
		this.$el.toggleClass('font-variant-selected');
	}
});

var Font_Variants_Preview = Backbone.View.extend({
	id: 'font-variants-preview',
	initialize: function(options) {
		this.options = options || {};
	},
	addOne: function(model) {
		var variant_view = new Variant_View({model: model, heading_preview: this.options.heading_preview});
		this.$el.append(variant_view.render().el);
	},
	render: function() {
		_.each(this.collection.models, function(model) {
			this.addOne(model);
		}, this);

		return this;
	},
	get_selected: function() {
		var selected = [];
		_.each(this.collection.models, function(model) {
			if (model.get('selected')) selected.push(model.get('variant'));
		});
		return selected;
	}
});

var Icon_Fonts_Manager = Backbone.View.extend({
	id: 'icon-fonts-manager',
	className: 'clearfix',
	template: _.template($(_Upfront_Templates.popup).find('#icon-fonts-manager-tpl').html()),

	events: {
		'click .upload-icon-font': 'triggerFileChooser',
		'click .icon-font-upload-status': 'triggerFileChooser',
		'click .icon-fonts-list-item': 'makeFontActive'
	},

	triggerFileChooser: function() {
		this.$el.find('#upfront-icon-font-input').click();
	},

	render: function() {
		this.$el.html(this.template({
			url: Upfront.mainData.ajax,
			show_no_fonts_notice: false,
			fonts: this.collection.models
		}));

		if (_.isUndefined(this.collection.findWhere({active: true}))) {
			this.$el.find('[data-family="icomoon"]').addClass('icon-fonts-list-item-active');
		}

		if (!this.fileUploadInitialized) {
			this.fileUploadInitialized = true;
			this.initializeFileUpload();
		}

		return this;
	},

	initializeFileUpload: function() {
		if (!jQuery.fn.fileupload) return false; // No file upload, carry on

		var me = this;
		this.$el.find('#upfront-upload-icon-font').fileupload({
			dataType: 'json',
			done: function (e, data) {
				var font = data.result.data.font;
				var fontObject;

				if (_.keys(font.files).length === 1) {
					me.$el.find('.icon-fonts-list').append('<div data-family="' + font.family + '" class="icon-fonts-list-item">' + font.name + '</div>');
					me.collection.add(font);
				} else {
					fontObject = me.collection.findWhere({'family': font.family});
					fontObject.set({files: font.files});
					if (fontObject.get('active') === true) {
						me.updateActiveFontStyle(font.family);
					}
				}

				fontObject = me.collection.findWhere({'family': font.family});
				var listItem = me.$el.find('[data-family=' + font.family + ']');
				listItem.find('.icon-font-upload-status').remove();
				if (fontObject.getUploadStatus() !== true) {
					listItem.append('<span class="icon-font-upload-status" title="' + fontObject.getUploadStatus() + '">*</span>');
				}
			}
		});
	},

	makeFontActive: function(event) {
		var fontItem = $(event.currentTarget);
		fontItem.siblings().removeClass('icon-fonts-list-item-active');
		fontItem.addClass('icon-fonts-list-item-active');

		var postData = {
			action: 'upfront_update_active_icon_font',
			family: fontItem.data('family')
		};


		Upfront.Util.post(postData)
			.error(function(){
				return notifier.addMessage('Could not update active icon font');
			});

		$('#active-icon-font').remove();
		_.each(this.collection.models, function(model) {
			model.set({'active': false});
		});

		if (fontItem.data('family') === 'icomoon') {
			return; // this is default font, no need to add style for it
		}

		this.collection.findWhere({family: fontItem.data('family')}).set({active: true});
		this.updateActiveFontStyle(fontItem.data('family'));
	},

	updateActiveFontStyle: function(family) {
		var font = this.collection.findWhere({family: family});
		var longSrc = '';
		_.each(font.get('files'), function(file, type) {
			longSrc += "url('" + Upfront.mainData.currentThemeUrl + '/icon-fonts/' + file + "') format('";
			switch(type) {
				case 'eot':
					longSrc += 'embedded-opentype';
					break;
				case 'woff':
					longSrc += 'woff';
					break;
				case 'ttf':
					longSrc += 'truetype';
					break;
				case 'svg':
					longSrc += 'svg';
					break;
			}
			longSrc += "'),";
		});
		var icon_font_style = "@font-face {" +
			"	font-family: '" + font.get('family') + "';";
		if (font.get('files').eot) {
			icon_font_style += "src: url('" + Upfront.mainData.currentThemeUrl + '/icon-fonts/' + font.get('files').eot + "');";
		}
		icon_font_style += "	src:" + longSrc.substring(0, longSrc.length - 1) + ';';

		icon_font_style +=
			"	font-weight: normal;" +
			"	font-style: normal;" +
			"}" +
			".uf_font_icon, .uf_font_icon * {" +
			"	font-family: '" + font.get('family') + "'!important;" +
			"}";

		$('body').append('<style id="active-icon-font">' + icon_font_style + '</style>');
	}
});

var Text_Fonts_Manager = Backbone.View.extend({
	id: 'text-fonts-manager',
	className: 'clearfix',
	template: _.template($(_Upfront_Templates.popup).find('#text-fonts-manager-tpl').html()),
	events: {
		'click .add-font-button': 'add_font',
		'click .preview-size-p': 'on_p_click',
		'click .preview-size-h1': 'on_h1_click'
	},
	initialize: function() {
		this.theme_fonts_panel = new ThemeFontsPanel({
			collection: this.collection,
			parent_view: this
		});
		this.listenTo(this.collection, 'remove', this.update_variants_on_remove);
	},
	render: function() {
		var me = this;

		this.$el.html(this.template({show_no_styles_notice: this.collection.length === 0}));
		$.when(google_fonts_storage.get_fonts()).done(function(fonts_collection) {
			me.load_google_fonts(fonts_collection);
		});

		this.$el.find('.add-font-panel').after(this.theme_fonts_panel.render().el);
		if (!Upfront.mainData.userDoneFontsIntro) this.$el.addClass('no-styles');

		this.$el.find('.choose-font').after('<div class="preview-type"><span class="preview-type-title">Preview Size</span><span class="preview-size-p selected-preview-size">P</span><span class="preview-size-h1">H1</span></div>');

		return this;
	},
	on_p_click: function() {
		this.$el.find('.preview-size-h1').removeClass('selected-preview-size');
		this.$el.find('.preview-size-p').addClass('selected-preview-size');
		this.heading_preview = false;
		this.update_variants();
	},
	on_h1_click: function() {
		this.$el.find('.preview-size-h1').addClass('selected-preview-size');
		this.$el.find('.preview-size-p').removeClass('selected-preview-size');
		this.heading_preview = true;
		this.update_variants();
	},
	add_font: function() {
		var variants;
		var font = google_fonts_storage.get_fonts().findWhere({ 'family': this.font_family_select.get_value() });
		if (_.isEmpty(font)) {
			alert(l10n.choose_font_weight);
			return;
		}

		variants = this.choose_variants.get_selected();
		if (_.isEmpty(variants)) {
			alert(l10n.choose_one_font_weight);
			return;
		}
		_.each(variants, function(variant) {
			theme_fonts_collection.add({
				id: font.get('family') + variant,
				font: font.toJSON(),
				variant: variant
			});
		});
		this.update_variants();
	},
	load_google_fonts: function(fonts_collection) {
		var add_font_panel = this.$el.find('.add-font-panel');
		var typefaces_list = [{ label: l10n.click_to_pick_google_font, value: ''}];
		_.each(fonts_collection.pluck('family'), function(family) {
			typefaces_list.push({ label: family, value: family });
		});
		add_font_panel.find('.loading-fonts').remove();
		// Select font
		this.font_family_select = new Field_Chosen_Select({
			label: l10n.typeface,
			values: typefaces_list,
			placeholder: l10n.choose_font,
			additional_classes: 'choose-font'
		});
		this.font_family_select.render();
		add_font_panel.find('.font-weights-list').before(this.font_family_select.el);
		$('.upfront-chosen-select', this.$el).chosen({
			width: '289px'
		});
		this.listenTo(this.font_family_select, 'changed', this.update_variants);
	},
	update_variants_on_remove: function() {
		this.update_variants();
	},
	update_variants: function(model) {
		this.$el.find('.font-weights-list').css('background', 'white');
		if (!model) model = google_fonts_storage.get_fonts().findWhere({ 'family' : this.font_family_select.get_value() });
		if (!model) return;
		// Choose variants
		var variants = new Backbone.Collection();
		_.each(model.get('variants'), function(variant) {
			// Add font to page so we can make preview with real fonts
			if ($('#' + model.get('family').toLowerCase() + variant + '-css').length === 0) {
				$('head').append('<link rel="stylesheet" id="' + model.get('family').toLowerCase() + '-' + variant + '-css" href="//fonts.googleapis.com/css?family=' + model.get('family') + '%3A' + variant + '" type="text/css" media="all">');
			}
			var weight_style = Font_Model.parse_variant(variant);
			variants.add({
				family: model.get('family'),
				name: Font_Model.normalize_variant(variant),
				variant: variant,
				already_added: !!theme_fonts_collection.get(model.get('family') + variant),
				weight: weight_style.weight,
				style: weight_style.style
			});
		});
		if (this.choose_variants) this.choose_variants.remove();

		this.choose_variants = new Font_Variants_Preview({
			collection: variants,
			heading_preview: this.heading_preview
		});
		this.choose_variants.render();
		this.$el.find('.font-weights-list-wrapper').html(this.choose_variants.el);
	},
	set_ok_button: function(button) {
		button.on('click', this.on_ok_click);
	},
	on_ok_click: function(event) {
		Upfront.Events.trigger("upfront:render_typography_sidebar");

		if (Upfront.mainData.userDoneFontsIntro) return;

		Upfront.Util.post({action: "upfront_user_done_font_intro"});
		Upfront.mainData.userDoneFontsIntro = true;
	}
});

var Insert_Font_Widget = Backbone.View.extend({
	initialize: function() {
		var me = this;
		this.fields = [
			new Field_Typeface_Chosen_Select({
				label: '',
				compact: true,
				values: theme_fonts_collection.get_fonts_for_select(),
				additional_classes: 'choose-typeface',
				select_width: '230px'
			}),
			new Field_Typeface_Style_Chosen_Select({
				label: '',
				compact: true,
				values: [],
				additional_classes: 'choose-variant',
				select_width: '120px'
			}),
			new Field_Button({
				label: l10n.insert_font,
				compact: true,
				on_click: function(){
					me.finish();
				}
			})
		];
	},
	render: function() {
		$('#insert-font-widget').html('').addClass('open');
		this.$el.html('');
		_.each(this.fields, function(field) {
			field.render();
			this.$el.append(field.el);
		}, this);

		this.listenTo(this.fields[0], 'changed', function() {
			var variants = theme_fonts_collection.get_variants(this.fields[0].get_value());
			this.render_variants(variants);
		});
		this.listenTo(this.fields[1], 'changed', function() {
			this.preview_font();
		});

		$('.choose-typeface select', this.$el).chosen({
			width: '230px',
			disable_search: true
		});
		$('.choose-variant select', this.$el).chosen({
			width: '120px',
			disable_search: true
		});

		return this;
	},
	render_variants: function(variants) {
		var $variant_field = this.$el.find('.choose-variant select');
		$variant_field.find('option').remove();
		$variant_field.append('<option value="">' + l10n.choose_variant + '</option>');
		_.each(variants, function(variant) {
			$variant_field.append('<option value="' + variant + '">' + variant + '</option>');
		});
		$variant_field.trigger('chosen:updated');
	},
	preview_font: function() {
		this.replaceFont({
			font_family: this.fields[0].get_value(),
			variant: Font_Model.parse_variant(this.fields[1].get_value())
		});
	},
	replaceFont: function(font) {
		var lines;
		this.editor = Upfront.Application.cssEditor.editor;
		this.style_doc = this.editor.getSession().getDocument();

		this.last_selected_font = font;

		// Insert selected font family
		if (!this.font_family_range) {
			this.font_family_range = this.editor.getSelection().getRange();
		} else {
			this.font_family_range.end = this.end_point;
		}
		this.end_point = this.style_doc.replace(this.font_family_range, font.font_family);

		// Insert selected weight and style, first reset them
		this.reset_properties();
		lines = [];
		if (font.variant.weight) {
			lines.push('    font-weight: ' + font.variant.weight + ';');
		}
		if (font.variant.style) {
			lines.push('    font-style: ' + font.variant.style + ';');
		}
		if (lines.length > 0) {
			this.style_doc.insertLines(this.font_family_range.start.row + 1, lines);
		}
	},
	reset_properties: function() {
		var row, line, result;
		this.editor = Upfront.Application.cssEditor.editor;
		this.style_doc = this.editor.getSession().getDocument();
		// Search forward only from font family row since lower properties override upper
		result = {};
		row = this.font_family_range.start.row + 1;
		line = this.style_doc.getLine(row);
		while (line.indexOf('}') < 0) {
			if (line.indexOf('font-weight') !== -1) {
				result.weight = row;
				if (!this.starting_weight) this.starting_weight = line;
			}
			if (line.indexOf('font-style') !== -1) {
				result.style = row;
				if (!this.starting_style) this.starting_style = line;
			}

			row++;
			line = this.style_doc.getLine(row);
			if (!line) {
				// Fix missing closing paren
				//this.style_doc.insertLines(row, ['}']); // This adds a standalone new brace for some reason
				break;
			}
		}

		// Reset properties. This is complicated. If both font style and font weight properties are in current style rule
		// we need to remove them carefully because when we remove first, seconds' row number might change
		// so first remove one with higher row number.
		if (result.weight && result.style) {
			if (result.weight > result.style) {
				this.style_doc.removeLines(result.weight, result.weight);
				this.style_doc.removeLines(result.style, result.style);
			} else {
				this.style_doc.removeLines(result.style, result.style);
				this.style_doc.removeLines(result.weight, result.weight);
			}
			result.weight = false;
			result.style = false;
		}
		if (result.weight) {
			this.style_doc.removeLines(result.weight, result.weight);
		}
		if (result.style) {
			this.style_doc.removeLines(result.style, result.style);
		}
	},
	finish: function() {
		$('#insert-font-widget').html('<a class="upfront-css-font" href="#">' + l10n.insert_font + '</a>').removeClass('open');
	}
});

var CSSEditor = Backbone.View.extend({
	className: 'upfront-ui',
	id: 'upfront-csseditor',
	tpl: _.template($(_Upfront_Templates.popup).find('#csseditor-tpl').html()),
	prepareAce: false,
	ace: false,
	events: {
		'click .upfront-css-save-ok': 'save',
		'click .upfront-css-close': 'close',
		'click .upfront-css-theme_image': 'openThemeImagePicker',
		'click .upfront-css-media_image': 'openImagePicker',
		'click .upfront-css-font': 'startInsertFontWidget',
		'click .upfront-css-selector': 'addSelector',
		'click .upfront-css-type' : 'scrollToElement',
		'click .upfront-css-delete': 'deleteStyle',
		'change .upfront-css-save-name-field': 'updateStylename',
		'mouseenter .upfront-css-selector': 'hiliteElement',
		'mouseleave .upfront-css-selector': 'unhiliteElement',
		'keyup .upfront-css-save-name-field': 'checkDeleteToggle'
	},

	//elemenTypes' element id matches model's 'id_slug' attribute
	elementTypes: {
		UaccordionModel: {label: l10n.accordion, id: 'uaccordion'},
		UcommentModel: {label: l10n.comments, id: 'ucomment'},
		UcontactModel: {label: l10n.contact_form, id: 'ucontact'},
		UgalleryModel: {label: l10n.gallery, id: 'ugallery'},
		UimageModel: {label: l10n.image, id: 'image'},
		LoginModel: {label: l10n.login, id: 'upfront-login_element'},
		LikeBox: {label: l10n.like_box, id: 'Like-box-object'},
		MapModel: {label: l10n.map, id: 'upfront-map_element'},
		UnewnavigationModel: {label: l10n.navigation, id: 'unewnavigation'},
		ButtonModel: {label: l10n.button, id: 'ubutton'},
		//UpostsModel: {label: l10n.posts, id: 'uposts'},
		PostsModel: {label: l10n.posts, id: 'uposts'},
		UsearchModel: {label: l10n.search, id: 'usearch'},
		USliderModel: {label: l10n.slider, id: 'uslider'},
		SocialMediaModel: {label: l10n.social, id: 'SocialMedia'},
		UtabsModel: {label: l10n.tabs, id: 'utabs'},
		ThisPageModel: {label: l10n.page, id: 'this_page'},
		ThisPostModel: {label: l10n.post, id: 'this_post'},
		UwidgetModel: {label: l10n.widget, id: 'uwidget'},
		UyoutubeModel: {label: l10n.youtube, id: 'uyoutube'},
		PlainTxtModel: {label: l10n.text, id:'plain_text'},
		CodeModel: {label: l10n.code, id: 'upfront-code_element'},
		Layout: {label: l10n.body, id: 'layout'},
		GalleryLightbox: {label: l10n.body, id: 'gallery-lightbox'},
		RegionContainer: {label: l10n.region, id: 'region-container'},
		Region: {label: l10n.inner_region, id: 'region'},
		RegionLightbox: {label: l10n.ltbox_region, id: 'region'},
		ModuleGroup: {label: l10n.group, id: 'module-group'},
		PostPart_titleModel: {label: l10n.postpart_title, id: 'PostPart_title'},
		PostPart_contentsModel: {label: l10n.postpart_content, id: 'PostPart_contents'},
		PostPart_excerptModel: {label: l10n.postpart_excerpt, id: 'PostPart_excerpt'},
		PostPart_featured_imageModel: {label: l10n.postpart_featured, id: 'PostPart_featured_image'},
		PostPart_authorModel: {label: l10n.postpart_author, id: 'PostPart_author'},
		PostPart_author_gravatarModel: {label: l10n.postpart_author_gravatar, id: 'PostPart_author_gravatar'},
		PostPart_dateModel: {label: l10n.postpart_date, id: 'PostPart_date'},
		PostPart_updateModel: {label: l10n.postpart_update, id: 'PostPart_update'},
		PostPart_comments_countModel: {label: l10n.postpart_comments, id: 'PostPart_comments_count'},
		PostPart_tagsModel: {label: l10n.postpart_tags, id: 'PostPart_tags'},
		PostPart_categoriesModel: {label: l10n.postpart_categories, id: 'PostPart_categories'}
	},
	initialize: function() {
		if (!$('#' + this.id).length) $('body').append(this.el);
		Upfront.Events.on("command:region:edit_toggle", this.close, this);
	},
	init: function(options) {
		var me = this,
			deferred = $.Deferred(),
			modelType;

		if (this.$style) this.close();

		// Don't render the editor, only makes the API available
		this.no_render = ( options.no_render === true );
		this.no_stylename_fallback = ( options.no_stylename_fallback === true );

		this.model = options.model;
		this.sidebar = ( options.sidebar !== false );
		this.toolbar = ( options.toolbar !== false );
		this.readOnly = ( options.readOnly === true );
		this.global = ( options.global === true );

		this.modelType = options.type ? options.type : this.model.get_property_value_by_name('type');
		this.elementType = this.elementTypes[this.modelType] || {label: 'Unknown', id: 'unknown'};

		// CSS editor treats global stylesheet as a separate case. When options.type is "Layout"
		// and options.element_id is "layout" than global stylesheet is edited.
		this.is_global_stylesheet = options.type === 'Layout' && options.element_id === 'layout';

		if (this.is_global_stylesheet) this.sidebar = true;

		this.resolve_stylename(options);

		this.ensure_style_element();

		this.selectors = this.elementSelectors[this.modelType] || {};

		this.element_id = options.element_id ? options.element_id : this.model.get_property_value_by_name('element_id');

		if ( !this.no_render ) {
			this.prepareAce = deferred.promise();
			require([Upfront.Settings.ace_url], function() {
				deferred.resolve();
			});

			this.resizeHandler = this.resizeHandler || function(){
				me.$el.width($(window).width() - $('#sidebar-ui').width() -1);
			};

			$(window).on('resize', this.resizeHandler);

			if ( typeof options.change == 'function' ) this.on('change', options.change);

			this.render();

			Upfront.Events.on("command:undo", function () {
				setTimeout(function () {
					var styles = Upfront.Util.Transient.pop('css-' + me.element_id);
					if (styles) {
						me.get_style_element().html(styles.replace(/#page/g, 'div#page.upfront-layout-view .upfront-editable_entity.upfront-module'));
						me.render();
					}
				}, 200);
			});

			this.startResizable();

			Upfront.Events.trigger('csseditor:open', this.element_id);
		}
	},
	resolve_stylename: function(options) {
		// Style name will be used to identify style element inserted to page by id and
		// to add class to elements that are using this style.
		this.stylename = ''; // reset
		if (this.is_global_stylesheet) this.stylename = 'layout-style';
		else this.stylename = options.stylename;

		// Check for regions
		if (this.is_region_style()) {
			var layout_id = _upfront_post_data.layout.specificity || _upfront_post_data.layout.item || _upfront_post_data.layout.type,
				is_global = ( this.model.get('scope') == 'global' ),
				default_stylename = this.elementType.id + '-' + this.model.get('name') + '-style',
				layout_stylename = layout_id + '-' + this.model.get('name') + '-style';
			if (is_global){
				this.stylename = default_stylename;
			} else {
				this.stylename = layout_stylename;
				if (
					_.isArray(Upfront.data.styles[this.elementType.id])
					&& Upfront.data.styles[this.elementType.id].indexOf(default_stylename) !== -1
					&& Upfront.data.styles[this.elementType.id].indexOf(layout_stylename) === -1
					&& !this.no_stylename_fallback
				) {
					this.stylename = default_stylename;
				}
			}
		}


		// If stylename is still empty than editor is creating new style and user have not
		// yet assigned name to style. Create temporary style name.
		if (this.stylename === '') {
			// User is adding element style so assign name according to element type
			// and add class to element on which editor is started so changes to style
			// reflect as edited.
			this.stylename = this.get_temp_stylename();
			$('#' + this.model.get_property_value_by_name('element_id')).addClass(this.stylename);
		}

		// For default styles saving and loading process is a bit different hence this flag
		this.is_default_style = this.stylename === '_default';
	},
	is_region_style: function() {
		return this.elementType.id === 'region-container'
			|| this.elementType.id === 'region';
	},
	get_style_id: function() {
		// Prepend element type if this is default style
		return this.is_default_style ?
			this.elementType.id + '_default' : this.stylename;
	},
	get_css_selector: function() {
		if (this.is_global_stylesheet) return '';

		if (this.is_region_style()) return '.upfront-' + this.elementType.id + '-' + this.model.get('name');

		// Add some specificity so this style would go over other
		if (this.is_default_style === false) return '#page .' + this.stylename;

		return '.upfront-output-' + this.elementType.id;
	},
	ensure_style_element: function() {
		var $style_el = this.get_style_element();
		if($style_el.length !== 0) {
			this.$style = $style_el;
			return;
		}

		this.$style = $('<style id="' + this.get_style_id() + '"></style>');
		$('body').append(this.$style);
	},
	get_style_element: function() {
		return $('style#' + this.get_style_id());
	},
	close: function(e){
		if(e && _.isFunction(e.preventDefault)) e.preventDefault();

		$(window).off('resize', this.resizeHandler);
		this.off('change');

		this.$style = false;
		if (this.editor) this.editor.destroy();

		$('#page').css('padding-bottom', 0);
		this.$el.hide();

		Upfront.Events.trigger('csseditor:closed', this.element_id);
	},
	render: function(){
		var me = this;

		if (!$('#' + this.id).length) $('#page').append(this.$el);

		if (!this.sidebar) {
			this.$el.addClass('upfront-css-no-sidebar');
		} else {
			this.$el.removeClass('upfront-css-no-sidebar');
		}

		this.$el.html(this.tpl({
			name: this.stylename,
			elementType: this.elementType.label,
			selectors: this.selectors,
			show_style_name: this.is_region_style() === false && this.is_global_stylesheet === false && this.sidebar !== true,
			showToolbar: this.toolbar
		}));

		this.resizeHandler('.');

		var bodyHeight = this.$el.height() - this.$('.upfront-css-top').outerHeight();
		this.$('.upfront-css-body').height(bodyHeight);

		this.prepareAce.done(function(){
			me.startAce();
		});

		this.prepareSpectrum();

		this.checkDeleteToggle(this.stylename);

		this.$el.show();
	},
	startAce: function() {
		var me = this,
			editor = ace.edit(this.$('.upfront-css-ace')[0]),
			session = editor.getSession(),
			scrollerDisplayed = false,
			scope,
			styles
		;

		session.setUseWorker(false);
		editor.setShowPrintMargin(false);

		editor.setReadOnly(this.readOnly);

		session.setMode("ace/mode/css");
		editor.setTheme('ace/theme/monokai');

		editor.on('change', function(e){
			if (me.timer) clearTimeout(me.timer);
			me.timer = setTimeout(function(){
				me.updateStyles(editor.getValue());
			},800);
			me.trigger('change', editor);

			if(typeof me.editor !== "undefined") {
				var aceOuterWidth = $(me.editor.container).get(0).scrollWidth;
				var aceInnerWidth = $(me.editor.container).find('.ace_content').innerWidth();

				if(aceOuterWidth < aceInnerWidth + 40) {
					if(!scrollerDisplayed) {
						me.startResizable();
					}
					scrollerDisplayed = true;
				} else {
					scrollerDisplayed = false;
				}
			}
		});

		styles = Upfront.Util.colors.convert_string_color_to_ufc(this.get_style_element().html().replace(/div#page.upfront-layout-view .upfront-editable_entity.upfront-module/g, '#page'));
		if (this.is_global_stylesheet === false) {
			scope = new RegExp(this.get_css_selector() + '\\s*', 'g');
			styles = styles.replace(scope, '');
		}
		editor.setValue($.trim(styles), -1);

		// Set up the proper vscroller width to go along with new change.
		editor.renderer.scrollBar.width = 5;
		editor.renderer.scroller.style.right = "5px";

		editor.focus();
		this.editor = editor;

		if(me.timer) clearTimeout(me.timer);
		me.timer = setTimeout(function(){
			me.startResizable();
		},300);

	},
	prepareSpectrum: function(){
		var me = this,
			color_picker = new Field_Color({
				default_value: '#ffffff',
				showAlpha: true,
				showPalette: true,
				maxSelectionSize: 9,
				localStorageKey: "spectrum.recent_bgs",
				preferredFormat: "hex",
				chooseText: "Ok",
				showInput: true,
				allowEmpty:true,
				autohide: false,
				spectrum: {
					show: function(){
						//spectrum = $('.sp-container:visible');
					},
					choose: function(color) {
						var colorString = color.alpha < 1 ? color.toRgbString() : color.toHexString();
						me.editor.insert(colorString);
						me.editor.focus();
					}
				}
			})
		;
		color_picker.render();
		me.$('.upfront-css-color').html(color_picker.el);
	},
	startResizable: function(){
		// Save the fetching inside the resize
		var me = this,
			$cssbody = me.$('.upfront-css-body'),
			topHeight = 0,
			$selectors = me.$('.upfront-css-selectors'),
			$saveform = me.$('.upfront-css-save-form'),
			$rsz = this.$('.upfront-css-resizable'),
			onResize = function(e, ui){
				var height = ui ? ui.size.height : me.$('.upfront-css-resizable').height(),
					bodyHeight = height  - topHeight;
				$cssbody.height(bodyHeight);
				if(me.editor)
					me.editor.resize();
				$selectors.outerHeight(bodyHeight - $saveform.outerHeight());
				// Clean unneeded CSS
				$rsz.css({
					width: "",
					height: "",
					left: "",
					top: ""
				});
				$('#page').css('padding-bottom', height);
			}
		;
		// Add appropriate handle classes
		$rsz.find(".upfront-css-top")
			.removeClass("ui-resizable-handle").addClass("ui-resizable-handle")
			.removeClass("ui-resizable-n").addClass("ui-resizable-n")
		;
		topHeight = me.$('.upfront-css-top').outerHeight();
		onResize();
		$rsz.resizable({
			handles: {n: '.upfront-css-top'},
			resize: onResize,
			minHeight: 200,
			delay: 100
		});
	},
	scrollToElement: function(){
		var $element = $('#' + this.element_id);

		if(!$element.length) return;

		var offset = $element.offset().top - 50;
		$(document).scrollTop(offset > 0 ? offset : 0);

		this.blink($element, 4);
	},

	blink: function(element, times) {
		var me = this;
		element.css('outline', '3px solid #3ea');
		setTimeout(function(){
			element.css('outline', 'none');

			times--;
			if (times > 0) {
				setTimeout(function(){
					me.blink(element, times - 1);
				}, 100);
			}

		}, 100);
	},

	hiliteElement: function(e){
		var selector = $(e.target).data('selector');

		if (!selector.length) return;

		var element = this.is_region_style() === false ? $('#' + this.element_id).parent() : $('#' + this.element_id);
		element.find(selector).addClass('upfront-css-hilite');
	},

	unhiliteElement: function(e){
		var selector = $(e.target).data('selector');

		if(!selector.length) return;

		var element = this.is_region_style() === false ? $('#' + this.element_id).parent() : $('#' + this.element_id);
		element.find(selector).removeClass('upfront-css-hilite');
	},

	remove: function(){
		Backbone.View.prototype.remove.call(this);
		$(window).off('resize', this.resizeHandler);
	},

	updateStyles: function(contents){
		var $el = this.get_style_element();
		Upfront.Util.Transient.push('css-' + this.element_id, $el.html());
		contents = Upfront.Util.colors.convert_string_ufc_to_color( contents);
		$el.html(
			this.stylesAddSelector(
				contents, (this.is_default_style ? '' : this.get_css_selector())
			).replace(/#page/g, 'div#page.upfront-layout-view .upfront-editable_entity.upfront-module')
		);
		this.trigger('updateStyles', this.element_id);
	},

	stylesAddSelector: function(contents, selector) {
		if (this.is_global_stylesheet && empty(selector)) return contents;

		var me = this,
			rules = contents.split('}'),
			processed = ''
		;

		_.each(rules, function (rl) {
			var src = $.trim(rl).split('{');

			if (src.length != 2) return true; // wtf

			var individual_selectors = src[0].split(','),
				processed_selectors = []
			;
			_.each(individual_selectors, function (sel) {
				sel = $.trim(sel);
				var clean_selector = sel.replace(/:[^\s]+/, ''); // Clean up states states such as :hover, so as to not mess up the matching
				var	is_container = clean_selector[0] === '@' || me.recursiveExistence(selector, clean_selector),
					spacer = is_container
						? '' // This is not a descentent selector - used for containers
						: ' ' // This is a descentent selector
				;

				processed_selectors.push('' +
					selector + spacer + sel +
				'');
			});
			processed += processed_selectors.join(', ') + ' {' +
				src[1] + // Actual rule
			'\n}\n';
		});
		return processed;
	},

	recursiveExistence: function(selector, clean_selector) {
		var splitted = clean_selector.split(' ');
		var me = this;
		while(splitted.length > 0) {
			try{
				if(!!$(selector + splitted.join(' ')).closest('#' + me.element_id).length)
					return true;
			}
			catch (err) {

			}
			splitted.pop();
		}

		return false;
	},
	// When stylename changes upfront needs to update element model theme_style property
	// and also to save style under new stylename.
	updateStylename: function() {
		var new_name =  $.trim(this.$('.upfront-css-save-name-field').val()),
			old_name = this.stylename;

		// Strict filtering on stylename
		new_name = new_name.replace(/\s/g, '-').replace(/[^A-Za-z0-9_-]/gi, '').replace(/-+/g, '-').toLowerCase();

		if (old_name === '_default') {
			this.$('.upfront-css-save-name-field').val('_default');
			Upfront.Views.Editor.notify(l10n.default_style_name_nag, 'error');
			return;
		}

		// Update class on element on which editor was called
		$('#' + this.model.get_property_value_by_name('element_id')).removeClass(this.stylename);
		$('#' + this.model.get_property_value_by_name('element_id')).addClass(new_name);

		// Replace id on style element
		this.get_style_element().attr('id', new_name);
		this.stylename = new_name;

		// Replace selector in style element htnl
		this.get_style_element().html(
			this.get_style_element().html().replace(new RegExp(old_name, 'g'), new_name)
		);

		// Update element on which editor is called to have appropriate theme style
		this.model.set_breakpoint_property('theme_style', new_name);

		// If this is change of name from temp don't do anything
		if (old_name === this.get_temp_stylename) return;

		// TODO Delete old style from database/files
		// this.delete(undefined, true);
		// Need to save with new name and delete old name
		this.save();
	},

	get_temp_stylename: function() {
		return this.modelType.toLowerCase().replace('model', '') + '-new-style';
	},

	save: function(event) {
		if (event) event.preventDefault();
		var me = this,
			styles = $.trim(this.editor.getValue()),
			data;

		if (this.is_global_stylesheet === false && this.stylename === this.get_temp_stylename())
			return notifier.addMessage(l10n.style_name_nag, 'error');

		styles = this.stylesAddSelector(styles, (this.is_default_style ? '' : this.get_css_selector()));
		data = {
			styles: styles,
			elementType: this.elementType.id,
			global: this.global
		};
		// If in exporter mode, export instead of saving
		if (Upfront.Application.is_builder()) {
			data.stylename = this.get_style_id();
			if (this.is_global_stylesheet) {
				var props = Upfront.Application.current_subapplication.layout.get('properties'),
					layout_styles = props && props.findWhere ? props.findWhere({name: 'layout_style'}) : false
				;
				if (layout_styles && layout_styles.set) {
					layout_styles.set({'value': styles});
				} else {
					props.add({name: "layout_style", value: styles});
				}
			}
			Upfront.Behaviors.LayoutEditor.export_element_styles(data);
			return;
		}

		data.name = this.get_style_id();
		data.action = 'upfront_save_styles';

		Upfront.Util.post(data)
			.success(function(response) {
				var data = response.data,
					elementType = me.elementType.id;

				if (!Upfront.data.styles[elementType]) {
					Upfront.data.styles[elementType] = [];
				}

				if (Upfront.data.styles[elementType].indexOf(me.get_style_id()) === -1) {
					Upfront.data.styles[elementType].push(me.get_style_id());
				}

				Upfront.Events.trigger('upfront:themestyle:saved', me.get_style_id());

				me.checkDeleteToggle(data.name);

				return notifier.addMessage(l10n.style_saved_as.replace(/%s/,  me.get_style_id()));
			})
			.error(function(response){
				return notifier.addMessage(l10n.there_was_an_error);
			});
	},

	/* API to call save style without loading editor */
	saveCall: function (notify) {
		var me = this,
			styles = $.trim(this.get_style_element().html()),
			data;

		data = {
			styles: styles,
			elementType: this.elementType.id,
			global: this.global
		};
		// If in exporter mode, export instead of saving
		if (Upfront.Application.is_builder()) {
			data.stylename = this.get_style_id();
			Upfront.Behaviors.LayoutEditor.export_element_styles(data);
			return;
		}

		data.name = this.get_style_id();
		data.action = 'upfront_save_styles';

		Upfront.Util.post(data)
			.success(function(response) {
				var data = response.data,
					elementType = me.elementType.id;

				if (!Upfront.data.styles[elementType]) Upfront.data.styles[elementType] = [];

				if (Upfront.data.styles[elementType].indexOf(me.get_style_id()) === -1) {
					Upfront.data.styles[elementType].push(me.get_style_id());
				}

				Upfront.Events.trigger('upfront:themestyle:saved', me.get_style_id());

				return notify ? notifier.addMessage(l10n.style_saved_as.replace(/%s/,  me.get_style_id())) : true;
			})
			.error(function(response){
				return notify ? notifier.addMessage(l10n.there_was_an_error) : true;
			});

	},

	checkDeleteToggle: function(e){
		if (_.isUndefined(e)) return;

		if(!this.deleteToggle) {
			this.deleteToggle = $('<a href="#" class="upfront-css-delete">' + l10n.delete_style + '</a>');
		}

		var value = _.isString(e) ? e : e.target.value,
			elementType = this.elementType.id,
			styles = Upfront.data.styles[elementType],
			showdelete = styles && styles.indexOf(elementType + '-' + value) != -1,
			inDom = this.deleteToggle.parent().length
		;

		if(showdelete && !inDom) {
			this.$('.upfront-css-save-form').append(this.deleteToggle);
		} else if(!showdelete && inDom) {
			this.deleteToggle.detach();
		}
	},

	deleteStyle: function(e){
		e.preventDefault();
		var me = this,
			elementType = this.elementType.id,
			styleName = elementType + '-' + this.$('.upfront-css-save-name-field').val()
		;

		if(!confirm(l10n.delete_stylename_nag.replace(/%s/, styleName)))
			return;

		var deleteData = {
			elementType: elementType,
			styleName: styleName,
			action: 'upfront_delete_styles'
		};

		Upfront.Util.post(deleteData)
			.done(function(){
				var styleIndex = Upfront.data.styles[elementType].indexOf(styleName);
				notifier.addMessage(l10n.stylename_deleted.replace(/%s/, styleName));

				//Clean the editor up
				me.$('.upfront-css-save-name-field').val('');
				me.editor.setValue('');

				//Remove the styles from the available styles
				if(styleIndex != -1)
					Upfront.data.styles[elementType].splice(styleIndex, 1);

				//Remove the styles from the dom
				$('#upfront-style-' + styleName).remove();

				//Unset the styles of the element if they are the same as the deleted ones.
				if(me.model.get_property_value_by_name('theme_style') == styleName)
					me.model.set_property('theme_style', '');

				//Remove the delete link
				me.deleteToggle.detach();
			});
		;
	},

	/* Used by upfront application */
	fetchThemeStyles: function(separately){
		var fetchData = {
				action:'upfront_theme_styles',
				separately: separately
			},
			deferred = $.Deferred()
		;

		Upfront.Util.post(fetchData)
			.success(function(response){
				deferred.resolve(response.data.styles);
			});
		return deferred.promise();
	},

	createSelectors: function(objects){
		var me = this,
			selectors = {}
		;

		_.each(objects, function(object){
			selectors[object.cssSelectorsId] = object.cssSelectors || {};
		});
		me.elementSelectors = selectors;
	},

	createSelector: function(model_class, view_class, id) {
		var model = new model_class(),
			view = new view_class({model: model});
		this.elementSelectors[id] = view.cssSelectors || {};
		view.remove();
	},

	openThemeImagePicker: function () {
		this._open_media_popup({themeImages: true});
	},

	openImagePicker: function(){
		this._open_media_popup();
	},

	/**
	 * Handles media popups.
	 * In this context, used for both theme and media images list.
	 *
	 * @param object opts Boot-time options to be passed to Upfront.Media.Manager
	 */
	_open_media_popup: function (opts) {
		opts = _.isObject(opts) ? opts : {};
		var me = this,
			options = _.extend({}, opts)
		;

		Upfront.Media.Manager.open(options).done(function(popup, result){
			Upfront.Events.trigger('upfront:element:edit:stop');
			if (!result) return;

			var imageModel = result.models[0],
				img = imageModel.get('image') ? imageModel.get('image') : result.models[0],
				url = 'src' in img ? img.src : ('get' in img ? img.get('original_url') : false)
			;

			me.editor.insert('url("' + url + '")');
			me.editor.focus();
		});
	},

	startInsertFontWidget: function() {
		var insertFontWidget = new Insert_Font_Widget({ collection: theme_fonts_collection });
		$('#insert-font-widget').html(insertFontWidget.render().el);
	},

	getElementType: function(model){
		var type = model.get_property_value_by_name('type'),
			styleType = this.elementTypes[type]
		;
		return styleType || type;
	},

	addSelector: function(e){
		var selector = $(e.target).data('selector');
		if( !_.isUndefined( this.editor ) ){
			this.editor.insert(selector);
			this.editor.focus();
		}

	}
});

/**
 * Like css editor but does not do saving and managing of styles.
 * Takes initial css from models "styles" property and fires change
 * event with new css.
 */
var GeneralCSSEditor = Backbone.View.extend({
	className: 'upfront-ui',
	id: 'upfront-general-csseditor',
	tpl: _.template($(_Upfront_Templates.popup).find('#csseditor-tpl').html()),
	prepareAce: false,
	ace: false,
	events: {
		'click .upfront-css-save-ok': 'fire_save',
		'click .upfront-css-close': 'close',
		'click .upfront-css-image': 'openImagePicker',
		'click .upfront-css-selector': 'addSelector'
	},
	initialize: function(options) {
		var me = this,
			deferred = $.Deferred(),
			style_selector,
			$style;

		this.options = options || {};
		this.model = options.model;
		this.sidebar = options.sidebar !== false;
		this.global = options.global === true;
		this.toolbar = ( options.toolbar !== false );
		this.prepareAce = deferred.promise();
		require([Upfront.Settings.ace_url], function(){
			deferred.resolve();
		});

		this.resizeHandler = this.resizeHandler || function(){
			me.$el.width($(window).width() - $('#sidebar-ui').width() -1);
		};

		$(window).on('resize', this.resizeHandler);

		style_selector = this.model.get('id') + '-breakpoint-style';
		$style = $('#' + style_selector);
		if ($style.length === 0) {
			this.$style = $('<style id="' + style_selector + '"></style>');
			$('body').append(this.$style);
		} else {
			this.$style = $style
		}

		if (options.cssSelectors) {
			this.selectors = options.cssSelectors;
		}


		if ( typeof options.change == 'function' ) this.listenTo(this, 'change', options.change);
		if ( typeof options.onClose == 'function' ) this.listenTo(this, 'close', options.onClose);

		this.render();

		this.startResizable();
	},
	close: function(event) {
		if(event)
			event.preventDefault();

		$(window).off('resize', this.resizeHandler);

		if(this.editor)
			this.editor.destroy();

		$('#page').css('padding-bottom', 0);
		this.remove();
	},
	render: function() {
		var me = this;

		$('#page').append(this.$el);

		if (!this.sidebar)
			this.$el.addClass('upfront-css-no-sidebar');
		else
			this.$el.removeClass('upfront-css-no-sidebar');

		this.$el.html(this.tpl({
			selectors: this.selectors,
			elementType: false,
			show_style_name: false,
			showToolbar: this.toolbar
		}));

		this.resizeHandler('.');

		var bodyHeight = this.$el.height() - this.$('.upfront-css-top').outerHeight();
		this.$('.upfront-css-body').height(bodyHeight);

		this.prepareAce.done(function(){
			me.startAce();
		});

		this.prepareSpectrum();

		this.$el.show();
	},
	startAce: function() {
		var me = this,
			editor = ace.edit(this.$('.upfront-css-ace')[0]),
			session = editor.getSession()
		;

		session.setUseWorker(false);
		editor.setShowPrintMargin(false);

		session.setMode("ace/mode/css");
		editor.setTheme('ace/theme/monokai');

		editor.on('change', function(event){
			var styles_with_selector;
			var rules = editor.getValue().split('}'),
				separator = '\n\n.' + me.options.page_class + ' ';

			rules = _.map(rules, function(rule){return $.trim(rule);});
			rules.pop();

			styles_with_selector = separator + rules.join('\n}' + separator) + '\n}';

			me.$style.html(styles_with_selector);
			me.trigger('change', styles_with_selector);
		});

		var scope = new RegExp('\.' + this.options.page_class + '\s*', 'g'),
			styles = this.model.get('styles') ? this.model.get('styles').replace(scope, '') : ''
		;
		var scope = new RegExp('\.' + this.options.page_class + '\s*', 'g');
		var styles;
		if (this.options.type === 'GalleryLightbox') {
			styles = this.model.get('properties').get('styles').get('value').replace(scope, '');
		} else {
			styles = this.model.get('styles').replace(scope, '');
		}
		editor.setValue($.trim(styles), -1);

		// Set up the proper vscroller width to go along with new change.
		editor.renderer.scrollBar.width = 5;
		editor.renderer.scroller.style.right = "5px";

		editor.focus();
		this.editor = editor;
	},
	prepareSpectrum: function() {
		var me = this;

		me.$('.upfront-css-color').spectrum({
			showAlpha: true,
			showPalette: true,
			palette: Theme_Colors.colors.pluck("color").length ? Theme_Colors.colors.pluck("color") : ['fff', '000', '0f0'],
			maxSelectionSize: 9,
			localStorageKey: "spectrum.recent_bgs",
			preferredFormat: "hex",
			chooseText: l10n.ok,
			showInput: true,
			allowEmpty:true,
			show: function(){
				spectrum = $('.sp-container:visible');
			},
			change: function(color) {
				var colorString = color.alpha < 1 ? color.toRgbString() : color.toHexString();
				me.editor.insert(colorString);
				me.editor.focus();
			},
			move: function(color) {
				var rgba = color.toRgbString();
				spectrum.find('.sp-dragger').css('border-top-color', rgba);
				spectrum.parent().find('.sp-dragger').css('border-right-color', rgba);
			}
		});
	},
	startResizable: function() {
		// Save the fetching inside the resize
		var me = this,
			$cssbody = me.$('.upfront-css-body'),
			topHeight = me.$('.upfront-css-top').outerHeight(),
			$selectors = me.$('.upfront-css-selectors'),
			$saveform = me.$('.upfront-css-save-form'),
			onResize = function(e, ui){
				var height = ui ? ui.size.height : me.$('.upfront-css-resizable').height(),
					bodyHeight = height  - topHeight;
				$cssbody.height(bodyHeight);
				if(me.editor)
					me.editor.resize();
				$selectors.height(bodyHeight - $saveform.outerHeight());
				$('#page').css('padding-bottom', height);
			}
		;
		onResize();
		this.$('.upfront-css-resizable').resizable({
			handles: {n: '.upfront-css-top'},
			resize: onResize,
			minHeight: 200,
			delay: 100
		});
	},
	remove: function() {
		this.trigger('close');
		Backbone.View.prototype.remove.call(this);
		$(window).off('resize', this.resizeHandler);
	},
	openImagePicker: function() {
		var me = this;
		Upfront.Media.Manager.open({}).done(function(popup, result){
			Upfront.Events.trigger('upfront:element:edit:stop');
			if(!result)
				return;

			var url = result.models[0].get('image').src;//.replace(document.location.origin, '');
			me.editor.insert('url("' + url + '")');
			me.editor.focus();
		});
	},
	addSelector: function(e) {
		var selector = $(e.target).data('selector');
		this.editor.insert(selector);
		this.editor.focus();
	}
});

	var Field_Complex_Toggleable_Text_Field = Field.extend({
		className: "upfront-field-complex_field-boolean_toggleable_text upfront-field-multiple",
		tpl: '<input type="checkbox" class = "upfront-field-checkbox" /> <label><span class="upfront-field-label-text">{{element_label}}</span></label> <div class="upfront-embedded_toggleable" style="display:none">{{field}}<div class="upfront-embedded_toggleable-notice">' + l10n.anchor_nag + '</div></div>',
		initialize: function (opts) {
			Field.prototype.initialize.call(this, opts);
			this.options.field = new Field_Text(this.options);
		},
		render: function () {
			var me = this;
			this.$el.empty();
			this.$el.append(this.get_field_html());

			this.$el.on("click", ':checkbox', function (e) {
				e.stopPropagation();
				me.field_toggle.apply(me);
			});
			if (this.model.get_property_value_by_name(this.options.field.get_name())) {
				this.$el.find(':checkbox').attr("checked", true);
				this.check_value();
				this.field_toggle();
			}

			this.$el.on("keyup", '[name="' + this.options.field.get_name() + '"]', function (e) {
				e.stopPropagation();
				me.check_value.apply(me);
			});

			setTimeout(function () {
				me.trigger("anchor:updated");
			}, 50);
		},
		field_toggle: function () {
			if (this.$el.find(":checkbox").is(":checked")) {
				this.$el.find(".upfront-embedded_toggleable").show();
			} else {
				this.$el.find(".upfront-embedded_toggleable").hide();
			}
			this.property.set({value: this.get_value()});
			this.trigger("anchor:updated");
		},
		check_value: function () {
			var $field = this.$el.find('[name="' + this.options.field.get_name() + '"]'),
				$root = this.$el.find(".upfront-embedded_toggleable"),
				val = $field.length && $field.val ? $field.val() : ''
			;
			$root.removeClass("error").removeClass("ok");
			if (val.length && !val.match(/^[a-zA-Z]+$/)) {
				$root.addClass("error");
			} else if (val.length) {
				$root.addClass("ok");
			}
			this.property.set({value: this.get_value()});
		},
		get_field_html: function () {
			this.options.field.render();
			var $input = this.options.field.$el;
			return _.template(this.tpl, _.extend({}, this.options, {field: $input.html()}));
		},
		get_value: function () {
			var data = {},
				$field = this.$el.find(":checkbox"),
				$subfield = this.$el.find('[name="' + this.options.field.get_name() + '"]'),
				value = $subfield.val().replace(/[^a-zA-Z]/g, '')
			;
			return $field.is(":checked") && value ? value : ''; // was false
		}
	});

var _Settings_AnchorSetting = SettingsItem.extend({
	className: "upfront-settings-item-anchor",
	//group: false,
	initialize: function (opts) {
		this.options = opts;
		SettingsItem.prototype.initialize.call(this, this.options);
		var item = new Field_Complex_Toggleable_Text_Field({
			element_label: l10n.make_element_anchor,
			className: 'upfront-field-complex_field-boolean_toggleable_text upfront-field-multiple checkbox-title',
			model: this.model,
			property: 'anchor'
		});
		item.on("anchor:updated", function () {
			this.trigger("anchor:item:updated");
		}, this);
		this.fields = _([item]);
	},
	save_fields: function () {
		this.fields.invoke("check_value");
		SettingsItem.prototype.save_fields.call(this);
	}
});

var Settings_LightboxTrigger = SettingsItem.extend({
	//className: "upfront-settings-item upfront-settings-item-lightbox",
	initialize: function (opts) {
		this.options = opts;
		var lightboxes = this.get_lightboxes()
		;

		this.options.fields = _([
			new Field_Select({
				model: this.model, property: 'lightbox_target',
				values: lightboxes
			})
		]);

		SettingsItem.prototype.initialize.call(this, this.options);
	},
	get_lightboxes: function () {
		var regions = Upfront.Application.layout.get("regions"),
			lightboxes = ['']
		;

		_.each(regions.models, function(model) {
			if(model.attributes.sub == 'lightbox')
				lightboxes.push({label: model.attributes.title, value: model.attributes.name});
		});


		return lightboxes;
	},
	get_values: function () {
        return this.fields._wrapped[0].get_value();
    }
});

var Settings_LabeledLightboxTrigger = Settings_LightboxTrigger.extend({
	//className: "upfront-settings-item upfront-settings-item-anchor",
	initialize: function (opts) {
		this.options = opts;
		Settings_LightboxTrigger.prototype.initialize.call(this, this.options);
		this.options.fields.push(
			new Field_Text({
				model: this.model,
				property: 'lightbox_label',
				label: l10n.label
			})
		);
	},
	get_values: function () {
		return {
			anchor: this.fields._wrapped[0].get_value(),
			label: this.fields._wrapped[1].get_value()
		}
	}
});

var Settings_AnchorTrigger = SettingsItem.extend({
	//className: "upfront-settings-item upfront-settings-item-anchor",
	initialize: function (opts) {
		this.options = opts;
		var anchors = [],
			raw = this.get_anchors()
		;
		_(raw).each(function (idx) {
			anchors.push({label: idx, value: idx});
		});
		this.options.fields = _([
			new Field_Select({
				model: this.model, property: 'anchor_target',
				values: anchors
			})
		]);
		SettingsItem.prototype.initialize.call(this, this.options);
	},
	get_anchors: function () {
		var regions = Upfront.Application.layout.get("regions"),
			anchors = ['']
		;
		regions.each(function (r) {
			r.get("modules").each(function (module) {
				module.get("objects").each(function (object) {
					var anchor = object.get_property_value_by_name("anchor");
					if (anchor && anchor.length) anchors.push(anchor);
				});
			});
		});
		return anchors;
	},
	get_values: function () {
        return this.fields._wrapped[0].get_value();
    }
});

var Settings_LabeledAnchorTrigger = Settings_AnchorTrigger.extend({
	//className: "upfront-settings-item upfront-settings-item-anchor",
	initialize: function (opts) {
		this.options = opts;
		Settings_AnchorTrigger.prototype.initialize.call(this, this.options);
		this.options.fields.push(
			new Field_Text({
				model: this.model,
				property: 'anchor_label',
				label: l10n.label
			})
		);
	},
	get_values: function () {
		return {
			anchor: this.fields._wrapped[0].get_value(),
			label: this.fields._wrapped[1].get_value()
		}
	}
});

var Field_Anchor = Field_Select.extend({
	initialize: function (opts) {
		Field_Select.prototype.initialize.call(this, opts);
		this.options.values = this.get_anchors();
	},
	get_anchors: function () {
		var raw = Settings_AnchorTrigger.prototype.get_anchors.call(this),
			anchors = []
		;
		_(raw).each(function (idx) {
			anchors.push({label: idx, value: idx});
		});
		return anchors;
	}
});


/**
 * This is ordinary select that will render first option as label which
 * is disabled, has no hover effect and has no value.
 * Specify label text with options.label_text
 */
var Field_Compact_Label_Select_Option = Backbone.View.extend({
	tagName: 'li',
	events: {
		'change input': 'on_change'
	},
	className: function() {
		var className = 'upfront-field-select-option';
		if (this.model.get('default')) className += ' upfront-field-select-option-disabled';
		if (this.model.get('enabled')) className += ' upfront-field-select-option-selected';
		// select-option-odd
		return className;
	},
	template: '<label><span class="upfront-field-label-text">{{ name }} {[ if (width > 0) { ]}({{width}}px){[ } ]}</span></label>' +
		'<input type="checkbox" class="upfront-field-checkbox" value="{{ id }}" ' +
		'{[ if (is_default) { ]} disabled="disabled"{[ } ]}' +
		'{[ if (enabled) { ]} checked="checked"{[ } ]}>',
	initilize: function(options) {
		this.options = options || {};
		this.listenTo(this.model, 'change', this.render);
	},
	on_change: function(event) {
		this.model.set({'enabled': this.$el.find('input').is(':checked')});
	},
	render: function() {
		var properties = this.model.toJSON();
		// "default" is reserved word can't use it in template rendering. //todo fix this in model
		properties.is_default = properties.default;
		this.$el.append(_.template(this.template, properties));
		return this;
	}
});
var Field_Compact_Label_Select = Field_Select.extend({
	className: 'upfront-field-select upfront-no-select upfront-field-compact-label-select',
	template: '' +
		'<ul class="upfront-field-select-options">' +
			'<li class="upfront-field-select-option">' +
				'<label><span class="upfront-field-label-text">{{ label_text }}</span></label>' +
			'</li>' +
		'</ul></div>' +
	'',

	initialize: function(options) {
		this.options = options || {};
		this.listenTo(this.collection, 'add remove change:name change:width', this.render);
	},

	render: function () {
		var me = this;
		this.$el.html('');
		this.$el.append(_.template(this.template, this.options));
		this.$el.addClass(' upfront-field-select-' + ( this.options.multiple ? 'multiple' : 'single' ));

		if (this.options.disabled) {
			this.$el.addClass('upfront-field-select-disabled');
		}

		if (this.options.style == 'zebra') {
			this.$el.addClass('upfront-field-select-zebra');
		}

		// Add option views
		_.each(this.collection.models, function(breakpoint) {
			var option = new Field_Compact_Label_Select_Option({ model: breakpoint });
			option.render();
			this.$el.find('ul').append(option.el);
		}, this);
	},

	onOptionClick: function (e) {
		this.$el.toggleClass('compact-label-select-open');
		Field_Select.prototype.onOptionClick.call(this, e);
	}
});

/*
	var ContentEditorUploader = Backbone.View.extend({

		initialize: function () {
			window.send_to_editor = this.add_to_editor;
			Upfront.Events.on("upfront:editor:init", this.rebind_ckeditor_image, this);
		},
		open: function () {
			var height = $(window).height()*0.67;
			tb_show("Upload Image", Upfront.Settings.admin_url + "media-upload.php?type=image&TB_iframe=1&width=640&height="+height);
			return false;
		},
		close: function () {
			tb_remove();
			this.remove();
		},
		rebind_ckeditor_image: function () {
			var me = this;
			_(CKEDITOR.instances).each(function (editor) {
				var img = editor.getCommand('image');
				if (img && img.on) img.on("exec", me.open, me);
			});
		},
		add_to_editor: function (html) {
			var instance = CKEDITOR.currentInstance,
				el = CKEDITOR.dom.element.createFromHtml(html)
			;
			if (instance) instance.insertElement(el);
			tb_remove();
		}
	});
*/
	var NotifierView = Backbone.View.extend({
		notices: new Backbone.Collection([]),
		elId: 'upfront-notice',
		timer: false,
		timeoutTime: 5000,
		$notice: false,
		tpl: _.template($(_Upfront_Templates.popup).find('#upfront-notifier-tpl').html()),
		initialize: function(options){
			this.notices.on('add', this.messageAdded, this);
			this.notices.on('remove', this.messageRemoved, this);

			$('body').append(this.tpl({}));

			this.setElement($('#' + this.elId));
			/*
			// Hey admin bar!
			var $bar = $('#wpadminbar'); // We'll use it a couple of times, so cache
			if($bar.length && $bar.is(":visible")) // Check existence *and* visibility
				$('#upfront-notifier').css({top: 28});
			*/
		},
		addMessage: function(message, type, duration){
			var notice = {
				message: message ? message : l10n.no_message,
				type: type ? type : 'info',
				duration: duration
			};

			this.notices.add(notice);
		},
		show: function(notice) {
			var me = this;
			this.setMessage(notice);
			this.$el.addClass('notify open')
				.removeClass('out')
			;
			this.timer = setTimeout(function(){
				me.notices.remove(notice);
			}, notice.get('duration') || this.timeoutTime)
		},
		replace: function(notice) {
			var me = this;
			this.setMessage(notice);
			this.timer = setTimeout(function(){
				me.notices.remove(notice);
			}, this.timeoutTime);

			this.$el.removeClass('notify').
				addClass('shake');

			setTimeout(function(){
				me.$el.removeClass('shake');
			}, this.timeoutTime / 2);
		},
		setMessage: function(notice) {
			this.$el.removeClass('info warning error')
				.addClass(notice.get('type'))
				.html(notice.get('message'))
			;
		},
		close: function() {
			this.$el.addClass('out');
			this.$el.removeClass('notify shake open');
		},
		messageAdded: function(notice){
			if(! this.$el.hasClass('notify')){
				this.show(notice);
			}
		},
		messageRemoved: function(notice){
			if(this.notices.length)
				this.replace(this.notices.at(0));
			else
				this.close();
		}
	});

	var notifier = new NotifierView();

	var PostSelectorNavigation = ContentEditorPagination.extend({
		className: 'upfront-selector-navigation',
		handle_pagination_request: function (e, page) {
			var me = this,
				pagination = this.collection.pagination,
				page = page ? page : parseInt($(e.target).attr("data-page_idx"), 10) || 0
			;
			this.options.pageSelection(page);
		},
	});

	var PostSelector = Backbone.View.extend({
		postTypeTpl: _.template($(_Upfront_Templates.popup).find('#selector-post_type-tpl').html()),
		postListTpl: _.template($(_Upfront_Templates.popup).find('#selector-post-tpl').html()),
		postType: 'post',
		posts: [],
		pagination: false,
		selected: false,
		deferred: false,
		popup: false,
		defaultOptions: {
			// Title for the top
			title: l10n.select_content_to_link,
			postTypes: [
				{name: 'post', label: l10n.posts},
				{name: 'page', label: l10n.pages}
			]
		},
		events: {
			'click .upfront-field-select-value': 'openTypesSelector',
			'click .upfront-field-select-option': 'selectType',
			'click .upfront-selector-post': 'selectPost',
			'click .use': 'postOk',
			'click #upfront-search_action': 'search',
			'keyup .search_container>input': 'inputSearch'
		},
        initialize: function () {
            if (("post_types" in Upfront.mainData.content_settings ? Upfront.mainData.content_settings : {post_types: []}).post_types.length) {
                this.defaultOptions.postTypes = Upfront.mainData.content_settings.post_types;
            }
        },
		open: function(options){
			var me = this
				bindEvents = false
			;

			options = _.extend({}, this.defaultOptions, options);

			if(!$("#upfront-popup").length && this.$el.attr('id') != 'upfront-popup')
				bindEvents = true;

			this.popup = Upfront.Popup.open(function(){});

			this.deferred = $.Deferred();

			this.posts = new Upfront.Collections.PostList([], {postType: 'page'});

			this.posts.pagination.pageSize = 20;
			this.pagination = new PostSelectorNavigation({
				collection: this.posts,
				pageSelection: function(page){
					me.fetch({page: page});
				}
			});

			this.setElement($('#upfront-popup'));

			this.$('#upfront-popup-top').html('<h3 class="upfront-selector-title">' + options.title +'</h3>');
			this.$('#upfront-popup-content').html(this.postTypeTpl(options));

			this.fetch({});

			this.$('#upfront-popup-bottom')
				.html('<div class="use_selection_container inactive"><a href="#use" class="use">Ok</a></div><div class="search_container clearfix"><input type="text" placeholder="' + l10n.search + '" value=""><div class="search upfront-icon upfront-icon-popup-search" id="upfront-search_action"></div></div>')
				.append(this.pagination.$el)
			;
			$('#upfront-popup').addClass('upfront-postselector-popup');

			this.$('.upfront-field-select-value').text(l10n.pages);
			return this.deferred.promise();
		},

		openTypesSelector: function(){
			var selector = this.$('.upfront-field-select');
			if(!selector.hasClass('open')) {
				selector.addClass('open');
			}
			else {
					selector.removeClass('open');
			}
		},

		selectType: function(e){
			var type = $(e.target).attr('rel');
			if(type != this.posts.postType){
				this.$('.upfront-field-select-value').text($(e.target).text());
				this.$('.upfront-field-select').removeClass('open');
				this.fetch({postType: type});
			}
		},

		selectPost: function(e){
			var post = $(e.currentTarget);
			this.$('.upfront-selector-post.selected').removeClass('selected');

			this.selected = $(e.currentTarget).addClass('selected').attr('rel');
			this.$('.use_selection_container').removeClass('inactive');
		},

		postOk: function(e){
			e.preventDefault();
			if(!this.selected)
				return;

			Upfront.Popup.close();
			return this.deferred.resolve(this.posts.get(this.selected));
		},

		fetch: function(options){
			var me = this,
				loading = new Upfront.Views.Editor.Loading({
					loading: l10n.loading,
					done: l10n.thank_you_for_waiting,
					fixed: false
				})
			;

			this.$('.use_selection_container').addClass('inactive');
			this.selected = false;

			loading.render();
			this.$('#upfront-selector-posts').append(loading.$el);

			if(options.postType && options.postType != this.posts.postType){
				options.flush = true;
				this.posts.postType = options.postType;
			}

			var page = options.page;
			if(!page)
				page = 0;

			this.posts.fetchPage(page, options).done(function(pages){
				loading.done();
				me.$('#upfront-selector-posts').find('table').remove();
				me.$('#upfront-selector-posts').append(me.postListTpl({posts: me.posts.getPage(page)}));
				me.pagination.render();
			});
		},

		search: function(e){
			e.preventDefault();
			var s = this.$('.search_container input').val();
			if(s){
				this.fetch({search: s, flush: true});
			}
			else
				this.$('.search_container input').focus();
		},
		inputSearch: function(e){
			if(e.which == 13)
				this.search(e);
		}
	});



	var Loading = Backbone.View.extend({
		className: 'upfront-loading',
		is_done: false,
		done_callback: [],
		done_timeout: false,
		initialize: function (opts) {
			this.options = opts;
		},
		render: function () {
			var me = this;

			this.$el.html('<div class="upfront-loading-ani" />');

			if (this.options.fixed) this.$el.addClass('upfront-loading-fixed');
			if (this.options.loading_type) this.$el.addClass(this.options.loading_type);
			if (this.options.loading)this.$el.append('<p class="upfront-loading-text">' + this.options.loading + '</p>');

			this.$el.find('.upfront-loading-ani').on('animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd', function(){
				var state = me.$el.hasClass('upfront-loading-repeat') ? 'repeat' : (me.$el.hasClass('upfront-loading-done') ? 'done' : 'start');
				if ( state == 'start' ){
					if ( me.is_done ){
						var done = me.done_text || me.options.done;
						me.$el.addClass('upfront-loading-done');
						me.$el.find('.upfront-loading-text').text(done);
					}
					else
						me.$el.addClass('upfront-loading-repeat');
				}
				else if ( state == 'repeat' ) {
					me.$el.removeClass('upfront-loading-repeat');
				}
				else if ( state == 'done' ) {
					me.remove();
					clearTimeout(me.done_timeout);
					if ( me.done_callback ) _(me.done_callback).each(function(cbk) { if (cbk && cbk.call) cbk.call(me); });
				}
			});
		},
		update_loading_text: function (loading) {
			this.$el.find('.upfront-loading-text').text(loading);
		},
		on_finish: function (callback) {
			this.done_callback.push(callback);
		},
		done: function (callback, done) {
			var me = this;
			this.is_done = true;
			this.done_timeout = setTimeout(function(){
				if ( me ){
					me.remove();
					_(me.done_callback).each(function(cbk) {
						if (cbk && cbk.call) cbk.call(me);
					});
				}
			}, 6000);
			if (callback) callback.call(me);
			this.done_text = done;
		},
		cancel: function (callback, canceled) {
			this.remove();
			if ( callback ) callback();
		}
	});

	var Modal = Backbone.View.extend({
		attributes: function () {
			return {
				class: "upfront-inline-modal upfront-ui upfront-no-select",
				id: "upfront-inline-modal-"+this.cid
			};
		},
		initialize: function (opts) {
			this.options = opts;
			this.$to = opts.to;
			this.button_text = opts.button_text ? opts.button_text : "Ok";
			this.button = typeof opts.button != 'undefined' ? opts.button : true;
			this.width = typeof opts.width != 'undefined' ? opts.width : '50%';
			this.top = typeof opts.top != 'undefined' ? opts.top : -1;
			this.left = typeof opts.left != 'undefined' ? opts.left : -1;
			this.right = typeof opts.right != 'undefined' ? opts.right : -1;
			this.keep_position = typeof opts.keep_position != 'undefined' ? opts.keep_position : true;
		},
		events: {
			"click": "on_click",
			"click .upfront-inline-modal-content": "on_click_content",
			"click .upfront-inline-modal-save": "on_click_save"
		},
		render: function () {
			this.$el.html(
				'<div class="upfront-inline-modal-wrap">' +
					'<div class="upfront-inline-modal-content"></div>' +
				'</div>'
			);
			this.$el.hide();
		},
		open: function (render_callback, context, button) {
			var me = this,
				$wrap = this.$el.find('.upfront-inline-modal-wrap'),
				$content = this.$el.find('.upfront-inline-modal-content'),
				$button = $('<button type="button" class="upfront-inline-modal-save">' + this.button_text + '</button>'),
				css = {},
				height, parent_height,
				is_lightbox = context && context.for_view && context.for_view.$el.hasClass('upfront-region-side-lightbox');


			this._deferred = $.Deferred();
			this.$el.show();
			render_callback.apply(context, [$content, this.$el]);
			button = typeof button != 'undefined' ? button : this.button;
			if ( button )
				$button.appendTo($content);
			// this.listenTo(Upfront.Events, "entity:region:deactivated", function(){
				// me.close(false);
			// });

			css.width = this.width;
			// if it is a lightbox, it is going to be a fixed position, no need to take scroll into calcs
			if (!is_lightbox && this.top >= 0 ) {
				css.top = this.top;
				css.bottom = 'auto';
			}
			else {
				parent_height = this.$el.height() > $(window).height() ? $(window).height() : this.$el.height();
				height = $content.outerHeight();
				this.top = parent_height-height > 0 ? (parent_height-height)/2 : 0;

				// if it is a lightbox, just add manual margin from top, rest is static.
				if(is_lightbox)
					this.top = 22;

				css.top = this.top;
				css.bottom = 'auto';
			}

			if ( this.left >= 0 ) {
				css.left = this.left;
				css.right = 'auto';
			}
			else if ( this.right >= 0 ) {
				css.left = 'auto';
				if (css.width > 0 && this.right + css.width <= $(window).width()) { // We need this for smaller screens, such as laptops
					css.right = this.right;
				}
			}
			$wrap.css(css);
			if ( this.keep_position ) {
				this.update_pos();
				$(window).on('scroll', this, this.on_scroll);
			}
			this.trigger('modal:open');
			return this._deferred.promise();
		},
		close: function (save) {
			this.$el.hide();
			$(window).off('scroll', this.on_scroll);
			this.trigger('modal:close');
			if ( ! this._deferred )
				return;
			if ( save )
				this._deferred.resolve(this);
			else
				this._deferred.reject(this);
		},
		on_scroll: function (e) {
			var me = e.data;
			me.update_pos();
		},
		on_click: function () {
			this.close(false);
		},
		on_click_content: function (e) {
			e.stopPropagation();
		},
		on_click_save: function () {
			this.close(true);
		},
		update_pos: function () {
			var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
			if ( this.$el.css('display') == 'none' )
				return;
			var	$wrap = this.$el.find('.upfront-inline-modal-wrap'),
				offset = this.$to.offset(),
				top = offset.top,
				bottom = top + this.$to.outerHeight(),
				win_height = $(window).height(),
				scroll_top = $(document).scrollTop(),
				scroll_bottom = scroll_top + win_height,
				rel_top = $main.offset().top,
				rel_bottom = 50,
				modal_offset = this.$el.offset(),
				modal_right = modal_offset.left+this.$el.width(),
				modal_height = this.$el.find('.upfront-inline-modal-wrap').outerHeight(),
				modal_bottom = top + modal_height
			;
			if ( scroll_top >= top-rel_top ) {
				if ( this.$el.css('position') != 'fixed' ){
					this.$el.css({
						position: 'fixed',
						top: 0,
						bottom: 0,
						left: modal_offset.left,
						right: $(window).width()-modal_right
					});
					$wrap.css({
						top: rel_top + this.top
					});
				}
			}
			else if ( ( bottom > modal_bottom ? bottom : modal_bottom )+rel_bottom > scroll_bottom ) {
				if ( this.$el.css('position') != 'fixed' ){
					this.$el.css({
						position: 'fixed',
						top: 0,
						bottom: 0,
						left: modal_offset.left,
						right: $(window).width()-modal_right
					});
					$wrap.css({
						top: ( bottom > modal_bottom ? win_height-(bottom-top > win_height ? win_height : bottom-top)-rel_bottom : win_height-modal_height-rel_bottom ) + this.top
					});
				}
			}
			else {
				this.$el.css({
					position: '',
					top: '',
					bottom: '',
					left: '',
					right: ''
				});
				$wrap.css({
					top: this.top
				});
			}
		}
	});

	var ModalBgSetting = Modal.extend({
		open: function () {
			return this.constructor.__super__.open.call(this, this.render_modal, this, true);
		},
		render_modal: function ($content, $modal) {
			var me = this,
				grid = Upfront.Settings.LayoutEditor.Grid,
				breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
				is_responsive = ( breakpoint && !breakpoint.default ),
				is_layout = ( this.model instanceof Upfront.Models.Layout ),
				is_region = ( this.model instanceof Upfront.Models.Region ),
				sub = is_region && this.model.is_main() ? false : this.model.get('sub'),
				bg_image = this.model.get_breakpoint_property_value('background_image', true),
				$template = $(_Upfront_Templates.region_edit_panel),
				setting_cback = _.template($template.find('#upfront-region-bg-setting').html()),
				setting = setting_cback(),
				region_types = [
					{ label: l10n.solid_color, value: 'color', icon: 'color' },
					{ label: l10n.image, value: 'image', icon: 'image' },
					{ label: l10n.video, value: 'video', icon: 'video' }
				]
			;

			if ( !is_layout ) {
				region_types.push({ label: l10n.image_slider, value: 'slider', icon: 'slider' });
				region_types.push({ label: l10n.map, value: 'map', icon: 'map' });
			}
			if (
				_upfront_post_data.post_id
				||
				(Upfront.Application.get_current() === Upfront.Application.MODE.THEME && 'type' in _upfront_post_data.layout && 'single' === _upfront_post_data.layout.type)
			) {
				if (!('item' in _upfront_post_data.layout && _upfront_post_data.layout.item.match(/single-404/))) region_types.push({ label: l10n.featured_image, value: 'featured', icon: 'feat' });
			}

			var	bg_type = new Field_Select({
					model: this.model,
					property: 'background_type',
					use_breakpoint_property: true,
					default_value: !bg_image ? 'color' : 'image',
					icon_class: 'upfront-region-field-icon',
					values: region_types,
					change: function () {
						var value = this.get_value();
						$content.find('.upfront-region-bg-setting-tab').not('.upfront-region-bg-setting-tab-'+value).hide();
						$content.find('.upfront-region-bg-setting-tab-'+value).show();
						me.render_modal_tab(value, $content.find('.upfront-region-bg-setting-tab-'+value), $content);
						this.model.set_breakpoint_property(this.property_name, value);
					}
				}),
				bg_item = new Upfront.Views.Editor.BgSettings.BgItem({
					model: this.model
				}),
				$region_header, $region_name, $region_global, $region_type, $region_nav, $region_behavior, $region_restrict, $region_sticky, $theme_body;

			if ( !is_responsive && is_region ) {
				var region_name = new Field_Text({
						model: this.model,
						name: 'title',
						placeholder: l10n.region_name_placeholder,
						compact: true,
						change: function () {
						},
						blur: function () {
							var collection = this.model.collection,
								prev_title = this.model.get('title'),
								prev_name = this.model.get('name'),
								title = $.trim(this.get_value().replace(/[^A-Za-z0-9\s_-]/g, '')), // strict filtering to prevent unwanted character
								name = title.toLowerCase().replace(/\s/g, '-'),
								new_title, sub_regions, region_css;
							if ( prev_title != title ) {
								// Check if the region name exists
								if ( collection.get_by_name(name) ) {
									new_title = collection.get_new_title(title + " ", 2);
									title = new_title.title;
									name = new_title.name;
								}

								// Let's keep old CSS content
								region_css = me.get_region_css_styles(this.model);

								// Also update the container attribute on sub regions
								if ( this.model.is_main() ) {
									sub_regions = this.model.get_sub_regions();
									_.each(sub_regions, function(sub_model, sub){
										if ( _.isArray(sub_model) )
											_.each(sub_model, function(sub_model2){ sub_model2.set({container: name}, {silent:true}); });
										else if ( _.isObject(sub_model) )
											sub_model.set({container: name}, {silent:true});
									});
									this.model.set({title: title, name: name, container: name}, {silent: true});
								}
								else {
									this.model.set({title: title, name: name}, {silent: true});
								}
								$region_name.find('.upfront-region-name-edit-value').text(title);

								// Save to the new CSS
								me.set_region_css_styles(this.model, region_css.styles, region_css.selector);

								this.model.get('properties').trigger('change');
							}
						},
						rendered: function () {
							var me = this;
							this.get_field().on('keyup', function(e){
								if ( e.which === 13 )
									me.trigger('blur');
							});
						}
					}),
					make_global = new Field_Checkboxes({
						model: this.model,
						name: 'scope',
						multiple: false,
						values: [
							{ label: l10n.make_global, value: 'global' }
						],
						change: function(){
							var value = this.get_value();
							if ( value == 'global' ){
								me.apply_region_scope(this.model, 'global');
								$region_name.find('.upfront-region-bg-setting-is-global').show();
							}
							//else {
							//	me.apply_region_scope(this.model, 'local');
							//}
						}
					}),
					localize_region = new Field_Button({
						model: this.model,
						name: 'localize',
						label: l10n.localize_region,
						classname: 'upfront-region-bg-setting-localize',
						compact: true,
						on_click: function () {
							me.apply_region_scope(this.model, 'local');
							$region_name.find('.upfront-region-bg-setting-name-wrap').show();
							$region_auto.show();
							$region_name.find('.upfront-region-bg-setting-name-edit').hide();
							$region_name.find('.upfront-region-bg-setting-is-global').hide();
							make_global.$el.find('[value=global]').prop('checked', false);
							make_global.$el.show();
							this.$el.hide();
						},
						rendered: function () {
							this.$el.attr('title', l10n.localize_region_info);
						}
					}),
					name_save = new Field_Button({
						model: this.model,
						name: 'save',
						label: l10n.save,
						compact: true,
						classname: 'upfront-region-bg-setting-name-save',
						on_click: function () {
							//region_name.trigger('blur');
							$region_name.find('.upfront-region-bg-setting-name-wrap').show();
							$region_auto.show();
							$region_name.find('.upfront-region-bg-setting-name-edit').hide();
							if ( this.model.get('scope') == 'global' ) {
								make_global.$el.hide();
								if ( !localize_region._no_display )
									localize_region.$el.show();
							}
							else {
								make_global.$el.show();
							}
						}
					})
				;
			}
			if ( is_layout ){
				var contained_region = new Field_Number({
					model: this.model,
					property: 'contained_region_width',
					label: l10n.contained_region_width,
					label_style: "inline",
					default_value: grid.size*grid.column_width,
					min: grid.size*grid.column_width,
					max: 5120,
					step: 1,
					suffix: 'px',
					change: function () {
						var value = this.get_value();
						value = ( value < this.options.min ) ? this.options.min : value;
						this.property.set({value: value});
						Upfront.Events.trigger('upfront:layout:contained_region_width', value);
					}
				});
			}
			if ( is_region && this.model.is_main() ){
				var global_regions = _.findWhere(Upfront.Application.current_subapplication.get_layout_data().properties, {name: 'global_regions'});
				var global_header_defined = _.isUndefined(global_regions) ?
					false : _.findWhere(global_regions.value, {name: 'header'});
				var global_footer_defined = _.isUndefined(global_regions) ?
					false : _.findWhere(global_regions.value, {name: 'footer'});

				var collection = this.model.collection,
					index = collection.indexOf(this.model),
					index_container = collection.index_container(this.model, ['shadow', 'lightbox']),
					total_container = collection.total_container(['shadow', 'lightbox']), // don't include shadow and lightbox region
					is_top = index_container == 0,
					is_bottom = index_container == total_container-1,
					has_sticky = collection.findWhere({sticky: '1'}),
					types = [
						{ label: l10n.full_width, value: 'wide' },
						{ label: l10n.contained, value: 'clip' }
					],
					types = index_container > 0 ? types : _.union( [
						{ label: l10n.full_screen, value: 'full' }
					], types)
					region_global = new Field_Checkboxes({
						model: this.model,
						name: 'scope',
						multiple: false,
						values: [
							{ label: (is_top ? l10n.use_as_global_header : (is_bottom ? l10n.use_as_global_footer : '')), value: 'global' }
						],
						change: function(){
							var value = this.get_value(),
								sub_regions = this.model.get_sub_regions(),
								new_title = false,
								title = false,
								name = false,
								related_region = false;
							if ( value == 'global' ){
								title = ( is_top ? l10n.header : ( is_bottom ? l10n.footer : '' ) );
								name = ( is_top ? 'header' : ( is_bottom ? 'footer' : '' ) );
								if ( title && name ){
									related_region = this.model.collection.get_by_name(name);
									if ( related_region && related_region != this.model ){ // make sure to rename other region with the same name and change the scope to local
										new_title = this.model.collection.get_new_title("Region ", total_container);
										me.apply_region_scope(related_region, 'local', new_title.name, new_title.title);
									}
									me.apply_region_scope(this.model, 'global', name, title);
								}
							}
							else {
								me.apply_region_scope(this.model, 'local');
							}
						}
					}),
					add_global_region = new Field_Button({
						model: this.model,
						label: is_top ? l10n.add_global_header : l10n.add_global_footer,
						info: (is_top ? l10n.layout_no_global_header : l10n.layout_no_global_footer),
						compact: true,
						on_click: function(e){
							e.preventDefault();
							var new_region = new Upfront.Models.Region( is_top ? global_header_defined : global_footer_defined ),
								related_region = this.model.collection.get_by_name( is_top ? 'header' : 'footer' ),
								new_title = false;
							if ( related_region ) {// make sure to rename other region with the same name and change the scope to local
								new_title = this.model.collection.get_new_title("Region ", total_container);
								me.apply_region_scope(related_region, 'local', new_title.name, new_title.title);
							}
							Upfront.Events.once('entity:region:added', function(view){
								view.trigger("activate_region", view);
							}, this);
							new_region.add_to( this.model.collection, ( is_top ? 0 : index+1 ) );
							me.close();
						}
					}),
					region_type = new Field_Radios({
						model: this.model,
						name: 'type',
						default_value: 'wide',
						layout: 'horizontal-inline',
						values: types,
						change: function () {
							var value = this.get_value();
							this.model.set({type: value}, {silent: true});
							if ( value == 'full' ){
								$region_nav.show();
								$region_behavior.show();
							}
							else {
								$region_nav.hide();
								$region_behavior.hide();
							}
							this.model.get('properties').trigger('change');
							me.update_pos();
							// Re-toggle editing
							Upfront.Events.trigger('command:region:edit_toggle', false);
							Upfront.Events.trigger('command:region:edit_toggle', true);
						}
					}),
					// backward compatible with old nav_region property
					region_nav_value = this.model.get_property_value_by_name('nav_region'),
					region_nav = new Field_Checkboxes({
						model: this.model,
						property: 'sub_regions',
						default_value: !this.model.get_property_value_by_name('sub_regions') ? [region_nav_value] : [],
						layout: 'horizontal-inline',
						multiple: true,
						values: [
							{ label: l10n.top, value: 'top' },
							{ label: l10n.bottom, value: 'bottom' }
						],
						change: function () {
							var value = this.get_value(),
								sub_regions = me.model.get_sub_regions(),
								copy_data = false;
							index = collection.indexOf(me.model);

							if ( !_.contains(value, 'top') && sub_regions.top ) {
								copy_data = Upfront.Util.model_to_json(sub_regions.top);
								me._sub_region_top_copy = new Upfront.Models.Region(copy_data);
								collection.remove(sub_regions.top);
							}
							if ( !_.contains(value, 'bottom') && sub_regions.bottom ) {
								copy_data = Upfront.Util.model_to_json(sub_regions.bottom);
								me._sub_region_bottom_copy = new Upfront.Models.Region(copy_data);
								collection.remove(sub_regions.bottom);
							}

							_.each(value, function(sub){
								if ( sub_regions[sub] )
									return;
								var add_region = false,
									region_model = false;
								if ( sub == 'bottom' ) {
									if ( me._sub_region_bottom_copy )
										region_model = me._sub_region_bottom_copy;
									add_region = sub_regions.right ? index+2 : index+1;
								}
								else if ( sub == 'top' ) {
									if ( me._sub_region_top_copy )
										region_model = me._sub_region_top_copy;
									add_region = sub_regions.left ? index-1 : index;
								}
								if ( add_region !== false ) {
									var name = me.model.get('name') + '_' + sub,
										title = me.model.get('title') + ' ' + sub;
									if ( region_model === false ){
										region_model = new Upfront.Models.Region(_.extend(_.clone(Upfront.data.region_default_args), {
											"name": name,
											"title": title,
											"container": me.model.get('name'),
											"sub": sub,
											"scope": me.model.get('scope')
										}));
									}
									region_model.add_to(collection, add_region, {sub: sub});
									Upfront.Events.trigger('command:region:edit_toggle', true);
								}
							});
							this.property.set({value: value});
						}
					}),
					region_behavior = new Field_Radios({
						model: this.model,
						name: 'behavior',
						default_value: 'keep-position',
						layout: 'horizontal-inline',
						values: [
							{ label: l10n.keep_position, value: 'keep-position' },
							{ label: l10n.keep_ratio, value: 'keep-ratio' }
						],
						change: function () {
							var value = this.get_value();
							this.model.set({behavior: value}, {silent: true});
							this.model.get('properties').trigger('change');
						}
					});
			}
			else if ( is_region && sub == 'fixed' ) {
				var region_restrict = new Field_Checkboxes({
						model: this.model,
						name: 'restrict_to_container',
						default_value: '',
						layout: 'horizontal-inline',
						values: [
							{ label: l10n.restrict_to_parent, value: '1' }
						],
						change: function () {
							var value = this.get_value();
							this.model.set({restrict_to_container: value}, {silent: true});
							this.model.trigger('restrict_to_container', value);
							this.model.get('properties').trigger('change');
						},
						multiple: false
					});
			}

			// Padding Settings
			var bg_padding_type = new Field_Radios({
					model: this.model,
					use_breakpoint_property: true,
					property: 'bg_padding_type',
					label: '',
					values: [{ label: l10n.varied_padding, value: 'varied' }, { label: l10n.equal_padding, value: 'equal' }],
					default_value: this.model.get_breakpoint_property_value('bg_padding_type') || 'varied',
					change: function () {
						this.model.set_breakpoint_property('bg_padding_type', this.get_value());
					},
					show: function (value, $el) {
						if(value === 'varied') {
							$('.upfront-region-bg-setting-padding-top', $content).show();
							$('.upfront-region-bg-setting-padding-bottom', $content).show();
							$('.upfront-region-bg-setting-equal-padding', $content).hide();
						}
						else {
							$('.upfront-region-bg-setting-equal-padding', $content).show();
							$('.upfront-region-bg-setting-padding-top', $content).hide();
							$('.upfront-region-bg-setting-padding-bottom', $content).hide();
						}
					}
				}),
				top_bg_padding_slider = new Field_Slider({
					model: this.model,
					use_breakpoint_property: true,
					property: 'top_bg_padding_slider',
					label: '',
					default_value: this.model.get_breakpoint_property_value('top_bg_padding_slider') || 0,
					min: 0,
					max: 200,
					step: 5,
					valueTextFilter: function () {return '';},
					change: function () {
						var value = this.get_value();

						this.model.set_breakpoint_property('top_bg_padding_slider', value);
						top_bg_padding_num.get_field().val(value);
						this.model.set_breakpoint_property('top_bg_padding_num', value, true);
					}
				}),
				top_bg_padding_num = new Field_Number({
					model: this.model,
					use_breakpoint_property: true,
					property: 'top_bg_padding_num',
					label: '',
					default_value: this.model.get_breakpoint_property_value('top_bg_padding_num') || 0,
					prefix: l10n.bottom_padding,
					suffix: 'px',
					min: 0,
					step: 5,
					change: function () {
						var value = this.get_value();

						this.model.set_breakpoint_property('top_bg_padding_num', value);
						this.model.set_breakpoint_property('top_bg_padding_slider', value, true);
						top_bg_padding_slider.$el.find('#'+top_bg_padding_slider.get_field_id()).slider('value', value);
					}
				}),
				bottom_bg_padding_slider = new Field_Slider({
					model: this.model,
					use_breakpoint_property: true,
					property: 'bottom_bg_padding_slider',
					label: '',
					default_value: this.model.get_breakpoint_property_value('bottom_bg_padding_slider') || 0,
					min: 0,
					max: 200,
					step: 5,
					valueTextFilter: function () {return '';},
					change: function () {
						var value = this.get_value();

						this.model.set_breakpoint_property('bottom_bg_padding_slider', value);
						bottom_bg_padding_num.get_field().val(value);
						this.model.set_breakpoint_property('bottom_bg_padding_num', value, true);
					}
				}),
				bottom_bg_padding_num = new Field_Number({
					model: this.model,
					use_breakpoint_property: true,
					property: 'bottom_bg_padding_num',
					label: '',
					default_value: this.model.get_breakpoint_property_value('bottom_bg_padding_num') || 0,
					suffix: 'px',
					min: 0,
					step: 5,
					change: function () {
						var value = this.get_value();

						this.model.set_breakpoint_property('bottom_bg_padding_num', value);
						this.model.set_breakpoint_property('bottom_bg_padding_slider', value, true);
						bottom_bg_padding_slider.$el.find('#'+bottom_bg_padding_slider.get_field_id()).slider('value', value);
					}
				}),
				bg_padding_slider = new Field_Slider({
					model: this.model,
					use_breakpoint_property: true,
					property: 'bg_padding_slider',
					label: '',
					default_value: this.model.get_breakpoint_property_value('bg_padding_slider') || 0,
					min: 0,
					max: 200,
					step: 5,
					valueTextFilter: function () {return '';},
					change: function () {
						var value = this.get_value();

						this.model.set_breakpoint_property('bg_padding_slider', value);
						this.model.set_breakpoint_property('top_bg_padding_slider', value, true);
						this.model.set_breakpoint_property('bottom_bg_padding_slider', value, true);
						top_bg_padding_slider.$el.find('#'+top_bg_padding_slider.get_field_id()).slider('value', value);
						bottom_bg_padding_slider.$el.find('#'+bottom_bg_padding_slider.get_field_id()).slider('value', value);
						bg_padding_num.get_field().val(value);
						top_bg_padding_num.get_field().val(value);
						bottom_bg_padding_num.get_field().val(value);
						this.model.set_breakpoint_property('bg_padding_num', value, true);
						this.model.set_breakpoint_property('top_bg_padding_num', value, true);
						this.model.set_breakpoint_property('bottom_bg_padding_num', value, true);
					}
				}),
				bg_padding_num = new Field_Number({
					model: this.model,
					use_breakpoint_property: true,
					property: 'bg_padding_num',
					label: '',
					default_value: this.model.get_breakpoint_property_value('bg_padding_num') || 0,
					suffix: 'px',
					min: 0,
					step: 5,
					change: function () {
						var value = this.get_value();

						this.model.set_breakpoint_property('bg_padding_num', value);
						top_bg_padding_num.get_field().val(value);
						bottom_bg_padding_num.get_field().val(value);
						this.model.set_breakpoint_property('top_bg_padding_num', value, true);
						this.model.set_breakpoint_property('bottom_bg_padding_num', value, true);
						this.model.set_breakpoint_property('bg_padding_slider', value, true);
						this.model.set_breakpoint_property('top_bg_padding_slider', value, true);
						this.model.set_breakpoint_property('bottom_bg_padding_slider', value, true);
						bg_padding_slider.$el.find('#'+bg_padding_slider.get_field_id()).slider('value', value);
						top_bg_padding_slider.$el.find('#'+top_bg_padding_slider.get_field_id()).slider('value', value);
						bottom_bg_padding_slider.$el.find('#'+bottom_bg_padding_slider.get_field_id()).slider('value', value);
					}
				})
			;

			// Preserve background settings element event binding by detaching them before resetting html
			$content.find('.upfront-region-bg-setting-tab-primary, .upfront-region-bg-setting-tab-secondary').children().detach();

			$content.html(setting);
			$modal.addClass('upfront-region-modal-bg');
			$fixed = $content.find('.upfront-region-bg-setting-fixed-region');
			$fixed.hide();
			$lightbox = $content.find('.upfront-region-bg-setting-lightbox-region');

			$lightbox.hide();
			$region_header = $content.find('.upfront-region-bg-setting-header');
			$region_name = $content.find('.upfront-region-bg-setting-name');
			$region_global = $content.find('.upfront-region-bg-setting-region-global');
			$add_global_region = $content.find('.upfront-region-bg-setting-add-global-region');
			$region_type = $content.find('.upfront-region-bg-setting-region-type');
			$region_nav = $content.find('.upfront-region-bg-setting-region-nav');
			$region_behavior = $content.find('.upfront-region-bg-setting-region-behavior');
			$region_restrict = $content.find('.upfront-region-bg-setting-floating-restrict');
			$region_sticky = $content.find('.upfront-region-bg-setting-sticky');
			$region_auto = $content.find('.upfront-region-bg-setting-auto-resize');
			$region_padding_type = $content.find('.upfront-region-bg-setting-padding-type');
			$region_equal_padding = $content.find('.upfront-region-bg-setting-equal-padding');
			$region_top_padding = $content.find('.upfront-region-bg-setting-padding-top');
			$region_bottom_padding = $content.find('.upfront-region-bg-setting-padding-bottom');

			if ( !is_responsive && is_region ) {
				region_name.render();
				make_global.render();
				localize_region.render();
				name_save.render();
				$region_name.find('.upfront-region-bg-setting-name-edit').append([region_name.$el, make_global.$el, localize_region.$el, name_save.$el]).hide();
				$region_name.find('.upfront-region-name-edit-value').text(this.model.get('title'));
				if ( this.model.get('scope') == 'global' ) {
					$region_name.find('.upfront-region-bg-setting-is-global').show();
					make_global.$el.hide()
					if ( !this.model.is_main() && sub ) {
						var main_region = this.model.collection.get_by_name(this.model.get('container'));
						if ( main_region && main_region.get('scope') == 'global' ){
							localize_region.$el.hide();
							localize_region._no_display = true;
						}
					}
				}
				else {
					$region_name.find('.upfront-region-bg-setting-is-global').hide();
					localize_region.$el.hide();
				}
				// Let's not allow name change for header/footer, as the name is reserved for global region
				//if ( this.model.get('name') == 'header' || this.model.get('name') == 'footer' ){
				//	$region_name.find('.upfront-region-name-edit-trigger').hide();
				//}
				//else {
					$region_name.on('click', '.upfront-region-name-edit-trigger', function(e){
						e.preventDefault();
						$region_name.find('.upfront-region-bg-setting-name-wrap').hide();
						$region_auto.hide();
						$region_name.find('.upfront-region-bg-setting-name-edit').show();
						if ( me.model.get('scope') != 'global' )
							region_name.get_field().prop('disabled', false).trigger('focus').select();
						else
							region_name.get_field().prop('disabled', true);
					});
				//}
			}
			else {
				$region_header.hide();
			}

			if ( !is_responsive && is_region && this.model.is_main() ) {
				/*if ( is_top || is_bottom ){
					// This is global header or footer, or there is no global header/footer - show checkbox
					if (
						(is_top && ( this.model.get('name') == 'header' || !global_header_defined ))
						|| (!is_top && is_bottom && ( this.model.get('name') == 'footer' || !global_footer_defined ) )
					) {
						region_global.render();
						$region_global.append(region_global.$el);
					} else {
						// There are global header/footer but not used on this layout yet
						add_global_region.render();
						$add_global_region.append(add_global_region.$el);
					}
				}*/
				region_type.render();
				$region_type.append(region_type.$el);
				region_nav.render();
				$region_nav.append(region_nav.$el);
				region_behavior.render();
				$region_behavior.append(region_behavior.$el);
			}
			else {
				$region_global.hide();
				$region_type.hide();
				$region_nav.hide();
				$region_behavior.hide();
				$region_auto.hide();
			}
			$region_restrict.hide();
			$region_sticky.hide();

			if ( !is_responsive && is_region && ( this.model.is_main() || sub == 'top' || sub == 'bottom' ) ) {
				// Show the sticky option if there's no sticky region yet AND the region is <= 300px height
				if ( ( !has_sticky && this.for_view.$el.height() <= 300 ) || this.model.get('sticky') ) {
					var region_sticky = new Field_Checkboxes({
						model: this.model,
						name: 'sticky',
						default_value: '',
						layout: 'horizontal-inline',
						values: [
							{ label: l10n.sticky_region, value: '1' }
						],
						change: function () {
							var value = this.get_value();
							this.model.set({sticky: value}, {silent: true});
							this.model.get('properties').trigger('change');
						},
						multiple: false
					});
					region_sticky.render();
					$region_sticky.append(region_sticky.$el).show();
				}
			}

			$theme_body = $content.find('.upfront-region-bg-setting-theme-body');
			if ( is_layout ) {
				contained_region.render();
				$theme_body.append(contained_region.$el);
				$content.find('.upfront-region-bg-setting-edit-css').hide();
			}
			else {
				$theme_body.hide();
			}

			if(this.model.attributes.sub != 'lightbox') { /* dont need too many background options for the lightbox */
				bg_type.render();
				$content.find('.upfront-region-bg-setting-type').append(bg_type.$el);
				/*$content.find('.upfront-region-bg-setting-change-image').on('click', function (e) {
					e.preventDefault();
					e.stopPropagation();
					me.upload_image();
				});*/

			}
			else {
				$content.find('.upfront-region-bg-setting-type').remove();
				//$content.find('.upfront-region-bg-setting-change-image').remove();
			}

			$content.find('.upfront-region-bg-setting-edit-css').on('click', function(e){
				e.preventDefault();
				e.stopPropagation();
				me.trigger_edit_css();
			});

			if ( is_region && this.model.is_main() ){
				var $auto_resize = $content.find('.upfront-region-bg-setting-auto-resize');
				$auto_resize.on('click', function (e) {
					e.preventDefault();
					e.stopPropagation();
					me.trigger_expand_lock($(this));
				});
				this.render_expand_lock($auto_resize);
				this.listenTo(region_type, 'changed', function(){
					me.render_expand_lock($auto_resize);
				});
				if ( !is_responsive )
					region_type.trigger('changed');
			}
			else if ( is_region && sub == 'fixed' ) {
				this.render_fixed_settings($fixed);
				$fixed.show();
				region_restrict.render();
				$region_restrict.append(region_restrict.$el).show();
			}
			else if ( is_region && sub == 'lightbox' ) {
				this.render_lightbox_settings($lightbox);
				$lightbox.show();
			}
			else {
				$content.find('.upfront-region-bg-setting-auto-resize').hide();
			}

			// Padding Settings
			bg_padding_type.render();
			$region_padding_type.append(bg_padding_type.$el);
			top_bg_padding_slider.render();
			$region_top_padding.append(top_bg_padding_slider.$el);
			top_bg_padding_num.render();
			$region_top_padding.append(top_bg_padding_num.$el);
			bottom_bg_padding_slider.render();
			$region_bottom_padding.append(bottom_bg_padding_slider.$el);
			bottom_bg_padding_num.render();
			$region_bottom_padding.append(bottom_bg_padding_num.$el);
			bg_padding_slider.render();
			$region_equal_padding.append(bg_padding_slider.$el);
			bg_padding_num.render();
			$region_equal_padding.append(bg_padding_num.$el);

			bg_type.trigger('changed');
		},
		on_close_modal: function () {
			var me = this;
			me._active = false;
			me.render_icon();
		},
		notify: function () {
			Upfront.Views.Editor.notify(l10n.bg_updated);
		},
		apply_region_scope: function (model, scope, name, title) {
			var me = this,
				sub_regions = model.get_sub_regions(),
				prev_title = model.get('title'),
				prev_name = model.get('name'),
				set_sub = function (region) {
					var css = me.get_region_css_styles(region);
					region.set({scope: scope}, {silent: true});
					if ( name && prev_name != name ){
						var title_rx = new RegExp('^' + prev_title, 'i'),
							name_rx = new RegExp('^' + prev_name, 'i'),
							sub_title = region.get('title').replace( title_rx, title ),
							sub_name = region.get('name').replace( name_rx, name );
						region.set({
							container: name,
							title: sub_title,
							name: sub_name
						}, {silent: true});
					}
					me.set_region_css_styles(region, css.styles, css.selector);
					region.get('properties').trigger('change');
				},
				region_css;
			if ( model.is_main() ){
				_.each(sub_regions, function(sub){
					if ( _.isArray(sub) )
						_.each(sub, function(each){ set_sub(each); })
					else if ( sub )
						set_sub(sub);
				});
			}
			region_css = me.get_region_css_styles(model);
			model.set({ scope: scope }, {silent: true});
			if ( name && prev_name != name ){
				model.set({
					title: title,
					name: name,
					container: name
				}, {silent: true});
			}
			me.set_region_css_styles(model, region_css.styles, region_css.selector);
			model.get('properties').trigger('change');
		},
		get_region_css_styles: function (model) {
			Upfront.Application.cssEditor.init({
				model: model,
				type: model.is_main() ? "RegionContainer" : "Region",
				element_id: model.is_main() ? "region-container-" + model.get('name') : "region-" + model.get('name'),
				no_render: true
			});
			return {
				styles: $.trim(Upfront.Application.cssEditor.get_style_element().html()),
				selector: Upfront.Application.cssEditor.get_css_selector()
			};
		},
		set_region_css_styles: function (model, styles, prev_selector) {
			if ( styles ) {
				Upfront.Application.cssEditor.init({
					model: model,
					type: model.is_main() ? "RegionContainer" : "Region",
					element_id: model.is_main() ? "region-container-" + model.get('name') : "region-" + model.get('name'),
					no_stylename_fallback: true,
					no_render: true
				});
				selector = Upfront.Application.cssEditor.get_css_selector();
				if ( prev_selector != selector )
					styles = styles.replace(new RegExp(prev_selector.replace(/^\./, '\.'), 'g'), selector);
				Upfront.Application.cssEditor.get_style_element().html(styles);
				Upfront.Application.cssEditor.saveCall(false);
			}
		},
		render_fixed_settings: function ($content) {
			var me = this,
				grid = Upfront.Settings.LayoutEditor.Grid,
				top = this.model.get_property_value_by_name('top'),
				is_top = ( typeof top == 'number' ),
				left = this.model.get_property_value_by_name('left'),
				is_left = ( typeof left == 'number' ),
				bottom = this.model.get_property_value_by_name('bottom'),
				is_bottom = ( typeof bottom == 'number' ),
				right = this.model.get_property_value_by_name('right'),
				is_right = ( typeof right == 'number' ),
				set_value = function () {
					var value = this.get_value(),
						saved = this.get_saved_value();
					if ( value != saved ){
						switch ( this.options.property ){
							case 'top':
								this.model.remove_property('bottom', true); break;
							case 'bottom':
								this.model.remove_property('top', true); break;
							case 'left':
								this.model.remove_property('right', true); break;
							case 'right':
								this.model.remove_property('left', true); break;
						}
						this.property.set({'value': parseInt(value)});
					}
				},
				fields = {
					width: new Upfront.Views.Editor.Field.Number({
						model: this.model,
						property: 'width',
						label: l10n.width + ':',
						label_style: "inline",
						min: 3 * grid.column_width,
						max: Math.floor(grid.size/2) * grid.column_width,
						change: set_value
					}),
					height: new Upfront.Views.Editor.Field.Number({
						model: this.model,
						property: 'height',
						label: l10n.height + ':',
						label_style: "inline",
						min: 3 * grid.baseline,
						change: set_value
					})
				};
			if ( is_top || !is_bottom )
				fields.top = new Upfront.Views.Editor.Field.Number({
					model: this.model,
					property: 'top',
					label: l10n.top + ':',
					label_style: "inline",
					min: 0,
					change: set_value
				});
			else
				fields.bottom = new Upfront.Views.Editor.Field.Number({
					model: this.model,
					property: 'bottom',
					label: l10n.bottom + ':',
					label_style: "inline",
					min: 0,
					change: set_value
				});
			if ( is_left || !is_right )
				fields.left = new Upfront.Views.Editor.Field.Number({
					model: this.model,
					property: 'left',
					label: l10n.left + ':',
					label_style: "inline",
					min: 0,
					change: set_value
				});
			else
				fields.right = new Upfront.Views.Editor.Field.Number({
					model: this.model,
					property: 'right',
					label: l10n.right + ":",
					label_style: "inline",
					min: 0,
					change: set_value
				});
			_.each(fields, function(field){
				field.render();
				field.delegateEvents();
				$content.append(field.$el);
			});
		},
		render_lightbox_settings: function ($content) {
			var me = this,
				grid = Upfront.Settings.LayoutEditor.Grid,
				/*top = this.model.get_property_value_by_name('top'),
				is_top = ( typeof top == 'number' ),
				left = this.model.get_property_value_by_name('left'),
				is_left = ( typeof left == 'number' ),
				bottom = this.model.get_property_value_by_name('bottom'),
				is_bottom = ( typeof bottom == 'number' ),
				right = this.model.get_property_value_by_name('right'),
				is_right = ( typeof right == 'number' ),*/
				set_value = function (object) {

					me = object.$spectrum?object:this;

					var value = me.get_value(),
						saved = me.get_saved_value();
					if ( value != saved ){
						me.property.set({'value': value});
					}
				},
				fields = {
					width: new Upfront.Views.Editor.Field.Number({
						model: this.model,
						property: 'col',
						className: 'upfront-field-wrap upfront-field-wrap-number width_cols',
						label: l10n.col_width + ":",
						label_style: "inline",
						min: 3,// * grid.column_width,
						max: 24,//Math.floor(grid.size/2) * grid.column_width,
						change: set_value
					}),
					height: new Upfront.Views.Editor.Field.Number({
						model: this.model,
						property: 'height',
						label: l10n.px_height + ":",
						label_style: "inline",
						min: 3 * grid.baseline,
						max: 99999,
						change: set_value
					}),
					click_out_close: new Upfront.Views.Editor.Field.Checkboxes({
					    model: this.model,
					    property: 'click_out_close',
					    label: "",
				  	    values: [
						    { label: l10n.click_close_ltbox, value: 'yes', checked: this.model.get_property_value_by_name('click_out_close') == 'yes' ? 'checked' : false }
					    ],
						change: set_value
				    }),
					show_close: new Upfront.Views.Editor.Field.Checkboxes({
					    model: this.model,
					    property: 'show_close',
					    label: "",
				  	    values: [
						    { label: l10n.show_close_icon, value: 'yes', checked: this.model.get_property_value_by_name('show_close') == 'yes' ? 'checked' : false }
					    ],
						change: set_value
				    }),
					/*add_close_text: new Upfront.Views.Editor.Field.Checkboxes({
					    model: this.model,
					    property: 'add_close_text',
					    label: "",
				  	    values: [
						    { label: l10n.add_close_text, value: 'yes', checked: this.model.get_property_value_by_name('add_close_text') == 'yes' ? 'checked' : false }
					    ],
						change: set_value
				    }),
					close_text: new Upfront.Views.Editor.Field.Text({
						model: this.model,
						default_value: l10n.close,
						property: 'close_text',
						label_style: "inline",
						change: set_value
					})*/
				};

				fields.overlay_color = new Upfront.Views.Editor.Field.Color({
						model: this.model,
						property: 'overlay_color',
						className: 'upfront-field-wrap upfront-field-wrap-color sp-cf overlay_color',
						default_value: 'rgba(38,58,77,0.75)',
						label: l10n.overlay_bg + ":",
						change: set_value,
						spectrum: {
							move: function(color) {
								var rgb = color.toRgb(),
									rgba_string = 'rgba('+rgb.r+','+rgb.g+','+rgb.b+','+color.alpha+')';
								fields.overlay_color.get_field().val(rgba_string)
								set_value(fields.overlay_color);
							},
							change: function(color) {
								var rgb = color.toRgb(),
									rgba_string = 'rgba('+rgb.r+','+rgb.g+','+rgb.b+','+color.alpha+')';
								fields.overlay_color.get_field().val(rgba_string)
								set_value(fields.overlay_color);
							}
						}
					});

				fields.lightbox_color = new Upfront.Views.Editor.Field.Color({
						model: this.model,
						property: 'lightbox_color',
						default_value: 'rgba(248,254,255,0.9)',
						label: l10n.active_area_bg + ":",
						change: set_value,
						spectrum: {
							move: function(color) {
								var rgb = color.toRgb(),
									rgba_string = 'rgba('+rgb.r+','+rgb.g+','+rgb.b+','+color.alpha+')';
								fields.lightbox_color.get_field().val(rgba_string)
								set_value(fields.lightbox_color);
							},
							change: function(color) {
								var rgb = color.toRgb(),
									rgba_string = 'rgba('+rgb.r+','+rgb.g+','+rgb.b+','+color.alpha+')';
								fields.lightbox_color.get_field().val(rgba_string)
								set_value(fields.lightbox_color);
							},
						}
					});

			_.each(fields, function(field){
				field.render();
				field.delegateEvents();
				$content.append(field.$el);
			});

			this.model.set_property('delete', false);
			var me = this;

			$content.on('click', 'a.upfront-entity-delete_trigger', function() {
				me.model.set_property('delete', true);
				me.close();
			});

			$content.closest('.upfront-inline-modal-wrap').draggable();
		},
		update_lightbox_overlay: function(color) {
			var rgb = color.toRgb(),
				rgba_string = 'rgba('+rgb.r+','+rgb.g+','+rgb.b+','+color.alpha+')';
		},
		render_modal_tab: function (tab, $tab, $content) {
			var $change_image = $content.find('.upfront-region-bg-setting-change-image');
			$change_image.hide();
			switch (tab){
				case 'color':
					this.render_modal_tab_color($tab);
					break;
				case 'image':
					$change_image.show();
					this.render_modal_tab_image($tab, tab);
					break;
				case 'featured':
					this.render_modal_tab_image($tab, tab);
					break;
				case 'slider':
					this.render_modal_tab_slider($tab);
					break;
				case 'map':
					this.render_modal_tab_map($tab);
					break;
				case 'video':
					this.render_modal_tab_video($tab);
					break;
			}
		},
		_render_tab_template: function($target, primary, secondary, template){
			var $template = $(_Upfront_Templates.region_edit_panel),
				$tab = false, tpl = false
			;
			if (template) {
				tpl = _.template($template.find('#upfront-region-bg-setting-tab-'+template).html());
			} else {
				tpl = _.template($template.find('#upfront-region-bg-setting-tab').html());
			}
			if (tpl) $tab = $('<div>' + tpl() + '</div>');
				//$tab = $('<div>'+$template.find( template ? '#upfront-region-bg-setting-tab-'+template : '#upfront-region-bg-setting-tab').html()+'</div>');
			$tab.find('.upfront-region-bg-setting-tab-primary').append(primary);
			if ( secondary )
				$tab.find('.upfront-region-bg-setting-tab-secondary').append(secondary);
			$target.html('');
			$target.append($tab);
		},
		// Color tab
		render_modal_tab_color: function ($tab) {
			if ( ! this._color_item ){
				this._color_item = new Upfront.Views.Editor.BgSettings.ColorItem({
					model: this.model
				});
				this._color_item.render();
			}
			this._color_item.trigger('show');
			this._render_tab_template($tab, this._color_item.$el, '');
		},
		// Image tab
		render_modal_tab_image: function ($tab, value) {
			if ( ! this._image_item ){
				this._image_item = new Upfront.Views.Editor.BgSettings.ImageItem({
					model: this.model
				});
				this._image_item.render();
				this.$_image_primary = this._image_item.$el.find('.uf-bgsettings-image-style, .uf-bgsettings-image-pick');
			}
			this._image_item.trigger('show');
			this._render_tab_template($tab, this.$_image_primary, this._image_item.$el);
		},
		// Slider tab
		render_modal_tab_slider: function ($tab) {
			if ( ! this._slider_item ) {
				this.$_slides = $('<div class="upfront-region-bg-slider-slides"></div>'),
				this._slider_item = new Upfront.Views.Editor.BgSettings.SliderItem({
					model: this.model,
					slides_item_el: this.$_slides
				});
				this._slider_item.render();
				this.$_slider_primary = this._slider_item.$el.find('.uf-bgsettings-slider-transition');
			}
			this._slider_item.trigger('show');
			this._render_tab_template($tab, this.$_slider_primary, [this._slider_item.$el, this.$_slides]);
		},
		// Map tab
		render_modal_tab_map: function ($tab) {
			if ( ! this._map_item ){
				this._map_item = new Upfront.Views.Editor.BgSettings.MapItem({
					model: this.model
				});
				this._map_item.render();
			}
			this._map_item.trigger('show');
			this._render_tab_template($tab, '', this._map_item.$el);
		},
		// Video tab
		render_modal_tab_video: function ($tab) {
			if ( ! this._video_item ) {
				this._video_item = new Upfront.Views.Editor.BgSettings.VideoItem({
					model: this.model
				});
				this._video_item.render();
			}
			this._video_item.trigger('show');
			this._render_tab_template($tab, '', this._video_item.$el);
		},
		// Expand lock trigger
		render_expand_lock: function ($el) {
			var locked = this.model.get_breakpoint_property_value('expand_lock', true),
				type = this.model.get('type'),
				$status = $('<span />');
			if ( type == 'full' ) {
				$el.addClass('upfront-region-bg-setting-auto-resize-disabled');
				$el.attr('title', l10n.auto_resize_disabled_title);
			}
			else {
				$el.removeClass('upfront-region-bg-setting-auto-resize-disabled');
				$el.removeAttr('title');
			}
			if ( locked ){
				$status.addClass('auto-resize-off');
			}
			else {
				$status.addClass('auto-resize-on');
			}
			$el.html('');
			$el.append('<span>' + l10n.auto_resize + '</span>');
			$el.append($status);
		},
		trigger_expand_lock: function ($el) {
			if ( $el.hasClass('upfront-region-bg-setting-auto-resize-disabled') )
				return;
			var locked = this.model.get_breakpoint_property_value('expand_lock');
			this.model.set_breakpoint_property('expand_lock', !locked);
			this.render_expand_lock($el);
		},
		// Edit CSS trigger
		trigger_edit_css: function () {
			Upfront.Application.cssEditor.init({
				model: this.model,
				type: this.model.is_main() ? "RegionContainer" : (this.model.get('type') == 'lightbox')?"RegionLightbox":"Region",
				element_id: this.model.is_main() ? "region-container-" + this.model.get('name') : "region-" + this.model.get('name')
			});

			this.listenTo(Upfront.Application.cssEditor, 'updateStyles', this.adjust_grid_padding);
		},

		adjust_grid_padding: function() {
			var togglegrid = new Upfront.Views.Editor.Command_ToggleGrid();
			togglegrid.update_grid();
		}
	});

	var RegionPanelItem = InlinePanels.Item.extend({
		initialize: function () {
			this.on('modal:open', this.on_modal_open, this);
			this.on('modal:close', this.on_modal_close, this);
		},
		on_modal_open: function () {
			// Disable region changing
			Upfront.Events.trigger('command:region:edit_toggle', false);
		},
		on_modal_close: function () {
			// Re-enable region changing
			Upfront.Events.trigger('command:region:edit_toggle', true);
		}
	});

	var RegionPanelItem_BgSetting = RegionPanelItem.extend({
		events: {
			'click .upfront-icon': 'open_bg_setting'
		},
		className: 'upfront-inline-panel-item upfront-region-panel-item-bg',
		icon: function(){
			return this._active ? 'bg-setting-active' : 'bg-setting';
		},
		tooltip: l10n.change_background,
		_active: false,
		open_bg_setting: function () {
			var type = this.model.get_property_value_by_name('background_type');
			if ( !type ){
				if ( this.model.get_property_value_by_name('background_image') )
					this.model.set_property('background_type', 'image');
			}
			this._active = true;
			this.render_icon();
			this.open_modal(this.render_modal, true).always($.proxy(this.on_close_modal, this)).fail($.proxy(this.notify, this));
		},
	});

	var RegionPanelItem_ExpandLock = RegionPanelItem.extend({
		events: {
			'click .upfront-icon': 'toggle_lock'
		},
		className: 'upfront-inline-panel-item upfront-region-panel-item-expand-lock',
		icon: function () {
			var locked = this.model.get_property_value_by_name('expand_lock');
			return locked ? 'expand-lock' : 'expand-unlock';
		},
		tooltip: function () {
			var locked = this.model.get_property_value_by_name('expand_lock'),
				status = '<span class="' + (locked ? 'expand-lock-active' : 'expand-lock-inactive') + '">' + (locked ? l10n.off : l10n.on) + '</span>';
			return l10n.autoexpand.replace(/%s/, status);
		},
		toggle_lock: function () {
			var locked = this.model.get_property_value_by_name('expand_lock');
			this.model.set_property('expand_lock', !locked);
			this.render_icon();
			this.render_tooltip();
		}
	});

	var RegionPanelItem_AddRegion = RegionPanelItem.extend({
		width: 24,
		height: 24,
		events: {
			'click': 'add_region_modal'
		},
		className: 'upfront-inline-panel-item upfront-region-panel-item-add-region',
		icon: function () {
			var to = this.options.to;
			if ( to.match(/^(top|bottom)-(left|right)$/) )
				return;
			return 'add ' + 'add-' + to;
		},
		tooltip: function () {
			var to = this.options.to;
			switch ( to ){
				case 'bottom':
					var msg = l10n.new_region_below; break;
				case 'left':
					var msg = l10n.new_sidebar_region; break;
				case 'right':
					var msg = l10n.new_sidebar_region; break;
				case 'top':
					var msg = l10n.new_region_above; break;
				case 'top-left':
				case 'top-right':
				case 'bottom-left':
				case 'bottom-right':
					var msg = l10n.add_floating_region; break;
			}
			return msg;
		},
		tooltip_pos: function () {
			var to = this.options.to;
			switch ( to ){
				case 'bottom':
					var pos = 'top'; break;
				case 'left':
				case 'top-left':
				case 'bottom-left':
					var pos = 'right'; break;
				case 'right':
				case 'top-right':
				case 'bottom-right':
					var pos = 'left'; break;
				case 'top':
					var pos = 'bottom'; break;
			}
			return pos;
		},
		initialize: function (opts) {
			this.options = opts;
			if ( ! this.options.to )
				this.options.to = 'top';
			if ( this.options.width )
				this.width = this.options.width;
			if ( this.options.height )
				this.height = this.options.height;
		},
		add_region_modal: function (e) {
			var to = this.options.to,
				me = this,
				modal = new Modal({ to: this.panel_view.panels_view.$el, button: true, width: 422 }),
				disable_global = ( ( to == 'left' || to == 'right' ) && me.model.get('scope') == 'global' );
				var parentContainer = me.$el.parents('.upfront-region-center');
				parentContainer.addClass('upfront-region-editing-modal');
				parentContainer.next().find('.upfront-icon-control-region-resize').hide();
				fields = {
					from: new Field_Radios({
						name: 'from',
						default_value: 'new',
						layout: 'horizontal-inline',
						values: [
							{ label: l10n.new_region, value: 'new' },
							{ label: l10n.choose_global_region, value: 'global', disabled: disable_global }
						],
						change: function(){
							var value = this.get_value();
							me.from = value;
						}
					}),
					region_title: new Field_Text({
						name: 'name',
						placeholder: l10n.region_name_placeholder,
						focus: function () {
							fields.from.set_value('new');
							fields.from.trigger('changed');
						},
						change: function () {
							var value = this.get_value();
							me.region_title = value;
						}
					}),
					make_global: new Field_Checkboxes({
						name: 'make_global',
						multiple: false,
						values: [{ label: l10n.make_this_region_global, value: 1 }],
						focus: function () {
							fields.from.set_value('new');
							fields.from.trigger('changed');
						},
						change: function () {
							var value = this.get_value();
							me.make_global = value == 1 ? true : false;
						}
					}),
					from_region: new Field_Select({
						name: 'from_region',
						values: [{ label: Upfront.Settings.l10n.global.behaviors.loading, value: "" }],
						disabled: disable_global,
						focus: function () {
							fields.from.set_value('global');
							fields.from.trigger('changed');
						},
						change: function () {
							var value = this.get_value();
							me.from_region = value;
						}
					})
				},
				from_region_values = function () {
					var values = [],
						is_main = ( to == 'top' || to == 'bottom' ),
						is_side = ( to == 'left' || to == 'right' );
					values.push( { label: l10n.select_global_region, value: '', disabled: true } )
					_.each(Upfront.data.global_regions, function(region){
						if ( is_main && region.container && region.name != region.container ) // exclude sub-region if main
							return;
						if ( is_side && ( region.sub != 'left' && region.sub != 'right' ) ) // exclude non-side region if it's side region (left/right)
							return;
						var collection = me.model.collection,
							region_exists = collection.get_by_name(region.name);
						values.push( { label: region.title, value: region.name, disabled: ( region_exists !== false ) } );
					});
					return values;
				};
			modal.render();
			this.panel_view.panels_view.$el.append(modal.$el);

			// Set default
			this.from = 'new';
			this.region_title = '';
			this.make_global = false;
			this.from_region = '';

			if ( !Upfront.data.global_regions ){
				Upfront.Util.post({
					action: 'upfront_list_scoped_regions',
					scope: 'global',
					storage_key: _upfront_save_storage_key
				}).done(function(data) {
					Upfront.data.global_regions = data.data;
					fields.from_region.options.values = from_region_values();
					fields.from_region.render();
					fields.from_region.delegateEvents();
				});
			}
			else {
				fields.from_region.options.values = from_region_values();
			}

			modal.open(function($content, $modal){
				var template = _.template(_Upfront_Templates.region_add_panel, {});
				_.each(fields, function(field, id) {
					field.render();
					field.delegateEvents();
				});
				$modal.addClass('upfront-add-region-modal')
				$content.append(template);
				$content.find('.upfront-add-region-choice').append(fields.from.$el);
				$content.find('.upfront-add-region-new').append(fields.region_title.$el);
				if ( !disable_global )
					$content.find('.upfront-add-region-new').append(fields.make_global.$el);
				$content.find('.upfront-add-region-global').append(fields.from_region.$el);
			}, this)
			.done(function(modal_view){
				if ( me.from == 'new' || !me.from_region ) {
					me.add_region();
				}
				else {
					me.add_region_from_global(me.from_region);
				}
			})
			.always(function(modal_view){
				parentContainer.removeClass('upfront-region-editing-modal');
				parentContainer.next().find('.upfront-icon-control-region-resize').show();
				modal_view.remove();
			});

			e.stopPropagation();
		},
		add_region: function () {
			var to = this.options.to,
				collection = this.model.collection,
				total = collection.size()-1, // total minus shadow region
				index = collection.indexOf(this.model),
				position = this.model.get('position'),
				sub_model = this.model.get_sub_regions(),
				is_new_container = ( to == 'top' || to == 'bottom' ),
				is_before = ( to == 'top' || to == 'left' ),
				region_title = this.region_title ? this.region_title.replace(/[^A-Za-z0-9\s_-]/g, '') : ( is_new_container ? "Region " : this.model.get('title') + ' ' + to.charAt(0).toUpperCase() + to.slice(1) ),
				region_name = region_title.toLowerCase().replace(/\s/g, '-'),
				new_title = collection.get_by_name(region_name) || (!this.region_title && is_new_container) ? collection.get_new_title(region_title, 1) : false,
				title = new_title !== false ? new_title.title : region_title,
				name = new_title !== false ? new_title.name : region_name,
				new_region = new Upfront.Models.Region(_.extend(_.clone(Upfront.data.region_default_args), {
					"name": name,
					"container": is_new_container ? name : this.model.get('name'),
					"title": title
				})),
				options = {},
				sub_index_func = function(model){
					if ( !model || !model.cid )
						return -1;
					return collection.indexOf(model);
				};

			if ( ! is_new_container ) {
				new_region.set_property('col', 5);
				if ( to == 'left' || to == 'right' ){
					new_region.set('sub', is_before ? 'left' : 'right');
					new_region.set('position', is_before ? position-1 : position+1 );
					options.sub = is_before ? 'left' : 'right';
				}
				else if ( to == 'top-left' || to == 'top-right' || to == 'bottom-left' || to == 'bottom-right' ) {
					new_region.set('type', 'fixed');
					new_region.set('sub', 'fixed');
					new_region.set_property('width', 225);
					new_region.set_property('height', 225);
					if ( to.match(/^top/) )
						new_region.set_property('top', 30);
					if ( to.match(/^bottom/) )
						new_region.set_property('bottom', 30);
					if ( to.match(/left$/) )
						new_region.set_property('left', 30);
					if ( to.match(/right$/) )
						new_region.set_property('right', 30);
					new_region.set_property('background_type', 'color');
					new_region.set_property('background_color', '#aeb8c2');
					options.sub = 'fixed';
				}
				if ( this.make_global )
					new_region.set({scope: 'global'});
				else
					new_region.set({scope: this.model.get('scope')});
			}
			else {
				new_region.set_property('row', Upfront.Util.height_to_row(300)); // default to 300px worth of rows
				var sub_model_index = _.filter(_.map(sub_model, sub_index_func), function(i){ return i >= 0; }),
					sub_model_fixed_index = sub_model.fixed.length > 0 ? _.map(sub_model.fixed, sub_index_func) : [];
				sub_model_index = _.union(sub_model_index, sub_model_fixed_index, [index]);
				if ( sub_model_index.length > 0 ){
					if ( to == 'top' )
						index = _.min(sub_model_index);
					else if ( to == 'bottom' )
						index = _.max(sub_model_index);
				}
				if ( this.make_global )
					new_region.set({scope: 'global'});
			}
			if ( new_region.get('clip') || !is_new_container ){
				Upfront.Events.once('entity:region:before_render', this.before_animation, this);
				Upfront.Events.once('entity:region:added', this.run_animation, this);
			}
			else {
				Upfront.Events.once('entity:region_container:before_render', this.before_animation, this);
				Upfront.Events.once('entity:region:added', this.run_animation, this);
			}
			new_region.add_to(collection, (is_before ? index : index+1), options);

			var wide_regions = collection.where({ type : 'wide'});
			if(wide_regions.length > 0) {
				$('div.upfront-regions a#no_region_add_one').remove();

			}
		},
		add_region_from_global: function (from_region) {
			var me = this,
				to = this.options.to,
				collection = this.model.collection,
				total = collection.size()-1, // total minus shadow region
				index = collection.indexOf(this.model),
				position = this.model.get('position'),
				sub_model = this.model.get_sub_regions(),
				is_new_container = ( to == 'top' || to == 'bottom' ),
				is_before = ( to == 'top' || to == 'left' ),
				sub_index_func = function(model){
					if ( !model || !model.cid )
						return -1;
					return collection.indexOf(model);
				};
			if ( is_new_container ){
				var sub_model_index = _.filter(_.map(sub_model, sub_index_func), function(i){ return i >= 0; }),
					sub_model_fixed_index = sub_model.fixed.length > 0 ? _.map(sub_model.fixed, sub_index_func) : [];
				sub_model_index = _.union(sub_model_index, sub_model_fixed_index, [index]);
				if ( sub_model_index.length > 0 ){
					if ( to == 'top' )
						index = _.min(sub_model_index);
					else if ( to == 'bottom' )
						index = _.max(sub_model_index);
				}
			}
			if ( !is_new_container ){
				Upfront.Events.once('entity:region:before_render', this.before_animation, this);
				Upfront.Events.once('entity:region:added', this.run_animation, this);
			}
			else {
				Upfront.Events.once('entity:region_container:before_render', this.before_animation, this);
				Upfront.Events.once('entity:region:added', this.run_animation, this);
			}
			Upfront.Util.post({
				action: 'upfront_get_scoped_regions',
				scope: 'global',
				name: from_region,
				storage_key: _upfront_save_storage_key
			}).done(function(data) {
				var regions = data.data,
					main_add = false,
					to_add = [],
					to_add_run = function(){
						_.each(to_add, function(add){
							add.model.add_to(collection, add.index, add.options);
						})
					};
				_.each(regions, function(region, i){
					var region_model = new Upfront.Models.Region(region),
						options = {};
					if ( ! region_model.is_main() ){
						if ( to == 'left' || to == 'right' ) {
							region_model.set('container', me.model.get('name'));
							region_model.set('sub', is_before ? 'left' : 'right');
							options.sub = is_before ? 'left' : 'right';
						}
						else {
							options.sub = region_model.get('sub');
						}
						to_add.push({
							model: region_model,
							index: (is_before ? index : index+1) + i,
							options: options
						});
					}
					else {
						main_add = {
							model: region_model,
							index: (is_before ? index : index+1),
							options: options
						}
					}
				});
				if ( main_add !== false ){
					Upfront.Events.once('entity:region:added', function(){
						to_add_run();
					});
					main_add.model.add_to(collection, main_add.index, main_add.options);
				}
				else {
					to_add_run();
				}
			});
		},
		before_animation: function (view, model) {
			// prepare to run animation, disable edit
			Upfront.Events.trigger('command:region:edit_toggle', false);
			Upfront.Events.trigger('command:region:fixed_edit_toggle', false);
		},
		run_animation: function (view, model) {
			var to = this.options.to,
				ani_class = 'upfront-add-region-ani upfront-add-region-ani-' + to,
				end_t = setTimeout(end, 500),
				ani_event_start = 'animationstart.region_ani webkitAnimationStart.region_ani MSAnimationStart.region_ani oAnimationStart.region_ani',
				ani_event_end = 'animationend.region_ani webkitAnimationEnd.region_ani MSAnimationEnd.region_ani oAnimationEnd.region_ani'
			;
			view.$el.one(ani_event_start, function () {
				clearTimeout(end_t);
				view.$el.off(ani_event_start); // Make sure to remove any remaining unfired event
			});
			view.$el.one(ani_event_end, function () {
				end();
				view.$el.off(ani_event_end); // Make sure to remove any remaining unfired event
			});
			// add animation class to trigger css animation
			view.$el.addClass(ani_class);
			// scroll if needed
			if ( to == 'top' || to == 'bottom' ){
				var $container = view.$el.hasClass('upfront-region-container') ? view.$el : view.$el.closest('.upfront-region-container'),
					offset = $container.offset(),
					scroll_top = $(document).scrollTop(),
					scroll_to = false,
					height = $container.height(),
					w_height = $(window).height();
				if ( to == 'top' && offset.top < scroll_top )
					scroll_to = offset.top - 50;
				else if ( to == 'bottom' && offset.top+height > scroll_top+w_height )
					scroll_to = offset.top+height-w_height;
				if ( scroll_to !== false )
					$('html,body').animate( {scrollTop: scroll_to}, 600 );
			}
			function end () {
				var baseline = Upfront.Settings.LayoutEditor.Grid.baseline,
					height = view.$el.outerHeight();
				//model.set_property('row', Math.ceil(height/baseline), true);
				view.$el.removeClass(ani_class);
				// enable edit and activate the new region
				Upfront.Events.trigger('command:region:edit_toggle', true);
				Upfront.Events.trigger('command:region:fixed_edit_toggle', true);
				view.trigger("activate_region", view);
			}
		}
	});

	// var RegionPanelItem_DeleteRegion = RegionPanelItem.extend({
	// 	events: {
	// 		'click .upfront-icon': 'delete_region'
	// 	},
	// 	className: 'upfront-inline-panel-item upfront-region-panel-item-delete-region',
	// 	icon: 'delete',
	// 	tooltip: l10n.delete_section,
	// 	//label: "Delete this section",
	// 	delete_region: function () {
	// 		var collection = this.model.collection;
	// 		if ( confirm(l10n.delete_section_nag) ){
	// 			collection.remove(this.model);
	// 		}
	// 	}
	// });

	// var RegionPanel = InlinePanels.Panel.extend({
	// 	className: 'upfront-inline-panel upfront-region-panel upfront-no-select',
	// 	initialize: function () {
	// 		this.items = _([]);
	// 	},
	// 	render: function() {
	// 		var me = this,
	// 			items = typeof this.items == 'function' ? this.items() : this.items,
	// 			classes = [
	// 				'upfront-inline-panel-'+this.position_v,
	// 				'upfront-inline-panel-'+this.position_v+'-'+this.position_h
	// 			],
	// 			width = 0,
	// 			height = 0;
	// 		this.$el.html('');
	// 		items.each(function(item){
	// 			item.panel_view = me;
	// 			item.render();
	// 			item.delegateEvents();
	// 			me.$el.append(item.el);
	// 			if ( me.position_v == 'center' )
	// 				height += item.$el.height();
	// 			else
	// 				width += item.$el.width();
	// 		});
	// 		this.$el.attr('class', this.className + ' ' + classes.join(' '));
	// 	},
	// 	remove: function() {
	// 		var items = typeof this.items == 'function' ? this.items() : this.items;

	// 		if(items)
	// 			items.each(function(item){
	// 				item.remove();
	// 			})
	// 		Backbone.View.prototype.remove.call(this);
	// 	}
	// });

	// var RegionPanel_Edit = InlinePanels.Panel.extend({
	// 	initialize: function () {
	// 		//this.bg = new RegionPanelItem_BgSetting({model: this.model});
	// 		if ( this.model.is_main() ){
	// 			//this.expand_lock = new RegionPanelItem_ExpandLock({model: this.model});
	// 			this.add_region = new RegionPanelItem_AddRegion({model: this.model, to: 'top'});
	// 		}
	// 		//this.delete_region = new RegionPanelItem_DeleteRegion({model: this.model});
	// 	},
	// 	items: function () {
	// 		var items = _([]),
	// 			type = this.model.get_property_value_by_name('background_type'),
	// 			sub = this.model.get('sub');
	// 		//items.push(this.bg);
	// 		//if ( this.expand_lock )
	// 		//	items.push(this.expand_lock);
	// 		if ( this.add_region && type != 'full' )
	// 			items.push(this.add_region);
	// 		if ( this.model.is_main() ) {
	// 			// if ( ! this.model.has_side_region() && ! this.model.get('default') && this.model.get('scope') != 'global' )
	// 				// items.push( this.delete_region );
	// 		}
	// 		else {
	// 			// if ( sub != 'top' && sub != 'bottom' )
	// 				// items.push( this.delete_region );
	// 		}
	// 		return items;
	// 	}
	// });

	var RegionPanel_Add = InlinePanels.Panel.extend({
		initialize: function (opts) {
			this.options = opts;
			if ( ! this.options.to )
				this.options.to = 'bottom';
			var to = this.options.to
				args = {model: this.model, to: to};
			if ( this.options.width )
				args.width = this.options.width;
			if ( this.options.height )
				args.height = this.options.height;
			this.items = _( [ new RegionPanelItem_AddRegion(args) ] );
			if ( to == 'top' || to == 'bottom' ){
				this.position_v = to;
				this.position_h = 'center';
			}
			else if ( to == 'left' || to == 'right' ) {
				this.position_v = 'center';
				this.position_h = to;
			}
			else if ( to == 'top-left' || to == 'top-right' || to == 'bottom-left'  || to == 'bottom-right'){
				this.position_v = to.split('-')[0];
				this.position_h = to.split('-')[1];
			}
		},
		items: function () {
			return _([ this.add_region ]);
		}
	});

	// var RegionPanel_Delete = InlinePanels.Panel.extend({
	// 	position_h: 'right',
	// 	initialize: function () {
	// 		this.items = _( [ new RegionPanelItem_DeleteRegion({model: this.model}) ] );
	// 	}
	// });

	var RegionPanels = InlinePanels.Panels.extend({
		className: 'upfront-inline-panels upfront-region-panels upfront-ui',
		initialize: function () {
			var container = this.model.get('container'),
				name = this.model.get('name');
			this.listenTo(this.model.collection, 'add', this.render);
			this.listenTo(this.model.collection, 'remove', this.render);
			this.listenTo(this.model.get("properties"), 'change', this.render);
			this.listenTo(this.model.get("properties"), 'add', this.render);
			this.listenTo(this.model.get("properties"), 'remove', this.render);
			this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.update_padding);
			this.listenTo(Upfront.Events, "layout:after_render", this.update_padding);
			this.listenTo(Upfront.Events, "entity:region:activated", this.on_region_active);
			this.listenTo(Upfront.Events, "entity:region:deactivated", this.on_region_deactive);
			//this.listenTo(Upfront.Events, "command:region:edit_toggle", this.update_pos);
			//this.edit_panel = new RegionPanel_Edit({model: this.model});
			//this.delete_panel = new RegionPanel_Delete({model: this.model});
			this.add_panel_top = new RegionPanel_Add({model: this.model, to: 'top'});
			this.add_panel_bottom = new RegionPanel_Add({model: this.model, to: 'bottom'});
			if ( this.model.is_main() && this.model.get('allow_sidebar') ){
				this.add_panel_left = new RegionPanel_Add({model: this.model, to: 'left'});
				this.add_panel_right = new RegionPanel_Add({model: this.model, to: 'right'});
			}
			//this.listenTo(Upfront.Events, "theme_colors:update", this.update_colors);
			//this.listenTo(Upfront.Events, "entity:region:after_render", this.update_colors);
		},
		panels: function () {
			var panels = _([]),
				collection = this.model.collection
			;
			if (_.isUndefined(collection)) { // The collection can easily be undefined for some reason. This happens e.g. when switching back from post layouts editing mode in exporter
				this._panels = panels; // This is so we don't error out a bit later on
				return panels; // Same as this - "return false" doesn't play well here.
			}
			var // Well, all is goog with the collection, so carry on as intended...
				index_container = collection.index_container(this.model, ['shadow', 'lightbox']),
				total_container = collection.total_container(['shadow', 'lightbox']), // don't include shadow and lightbox region
				is_top = index_container == 0,
				is_bottom = index_container == total_container-1,
				is_full = this.model.get('type') == 'full';
			if ( this.model.is_main() ) {
				var sub_models = this.model.get_sub_regions();
				if ( !(is_full && is_top) )
					panels.push( this.add_panel_top );
				if ( this.model.get('allow_sidebar') ){
					if ( sub_models.left === false )
						panels.push( this.add_panel_left );
					if ( sub_models.right === false )
						panels.push( this.add_panel_right );
				}
				panels.push( this.add_panel_bottom );
			}
			this._panels = panels;
			return panels;
		},
		on_render: function () {
			this.update_pos();
		},
		on_scroll: function (e) {
			var me = e.data;
			me.update_pos();
		},
		on_region_active: function (region) {
			if ( region.model != this.model )
				return;
			var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
			if ( $main.hasClass('upfront-region-editing') ){
				this.on_active();
				this.listenToOnce(Upfront.Events, 'sidebar:toggle:done', this.update_pos);
				$(window).on('scroll', this, this.on_scroll);
			}
		},
		on_region_deactive: function () {
			$(window).off('scroll', this, this.on_scroll);
		},
		/*
		update_colors: function () {
			var $region = [],
				background = this.model.get_property_value_by_name("background_color")
			;
			if (!background || !background.match(/ufc/)) return false;

			$region = this.$el.closest('.upfront-region-container-bg');
			if (!$region.length) return false;

			$region.css("background-color", Upfront.Util.colors.get_color(background));
		},
		*/
		update_pos: function () {
			var $main = $(Upfront.Settings.LayoutEditor.Selectors.main),
				$container = this.$el.closest('.upfront-region-container'),
				$region = this.$el.closest('.upfront-region'),
				$sub_top = $container.find('.upfront-region-side-top'),
				$sub_bottom = $container.find('.upfront-region-side-bottom');

			if ( ( !$main.hasClass('upfront-region-editing') && !$main.hasClass('upfront-region-fixed-editing') && !$main.hasClass('upfront-region-lightbox-editing') ) || !$container.hasClass('upfront-region-container-active') )
				return;

			var me = this,
				offset = $region.offset(),
				top = offset.top,
				bottom = top + $region.outerHeight(),
				top_height = $sub_top.length ? $sub_top.outerHeight() : 0,
				bottom_height = $sub_bottom.length ? $sub_bottom.outerHeight() : 0,
				win_height = $(window).height(),
				scroll_top = $(document).scrollTop(),
				scroll_bottom = scroll_top + win_height - bottom_height,
				rel_top = $main.offset().top + top_height
			;

			this.add_responsive_items();

			/*this.$el.css({
				top: scroll_top > top ? scroll_top-top+25 : 0,
				bottom: bottom > scroll_bottom ? bottom-scroll_bottom : 0
			});*/
			this._panels.each(function (panel) {
				var panel_offset = panel.$el.offset();
				if ( panel.position_v == 'top' && scroll_top > top-rel_top && scroll_top < bottom-rel_top ){
					if ( panel.$el.css('position') != 'fixed' )
						panel.$el.css({
							position: 'fixed',
							top: rel_top,
							left: panel_offset.left,
							right: 'auto'
						});
				}
				else if ( panel.position_v == 'bottom' && bottom > scroll_bottom && top < scroll_bottom ){
					if ( panel.$el.css('position') != 'fixed' )
						panel.$el.css({
							position: 'fixed',
							bottom: bottom_height,
							left: panel_offset.left,
							right: 'auto'
						});
				}
				else if ( panel.position_v == 'center' && ( scroll_top > top-rel_top || bottom > scroll_bottom ) ){
					var panel_top = scroll_top > top-rel_top ? rel_top : top-scroll_top,
						panel_bottom = bottom > scroll_bottom ? 0 : scroll_bottom-bottom,
						panel_left = panel.position_h == 'left' ? panel_offset.left : 'auto',
						panel_right = panel.position_h == 'right' ? $(window).width()-panel_offset.left-panel.$el.width() : 'auto';
					if ( panel.$el.css('position') != 'fixed' )
						panel.$el.css({
							position: 'fixed',
							top: panel_top,
							bottom: panel_bottom,
							left: panel_left,
							right: panel_right
						});
					else
						panel.$el.css({
							top: panel_top,
							bottom: panel_bottom
						});
				}
				else {
					panel.$el.css({
						position: '',
						top: '',
						bottom: '',
						left: '',
						right: ''
					});
				}
			});

			setTimeout(
				function () { me.update_padding() }
				, 300
			);
		},
		update_padding: function () {
			var props = {},
				$region = this.$el.closest('.upfront-region')
			;

			// Padding settings
			this.model.get("properties").each(function (prop) {
				props[prop.get("name")] = prop.get("value");
			});

			var breakpoints = typeof Upfront.Settings.LayoutEditor.Theme.breakpoints !== 'undefined' ? Upfront.Settings.LayoutEditor.Theme.breakpoints : [],
				current_breakpoint = typeof Upfront.Settings.LayoutEditor.CurrentBreakpoint !== 'undefined' ? Upfront.Settings.LayoutEditor.CurrentBreakpoint : 'desktop',
				current_breakpoint_id = current_breakpoint === 'default' ? current_breakpoint : current_breakpoint.id,
				top_padding,
				bottom_padding
			;

			var breakpoint_obj = (
						typeof props.breakpoint !== 'undefined'
						&& typeof props.breakpoint[current_breakpoint_id] !== 'undefined'
					)
					? props.breakpoint[current_breakpoint_id]
					: false
			;

			top_padding = (typeof breakpoint_obj.top_bg_padding_num !== 'undefined')
				? breakpoint_obj.top_bg_padding_num
				: (typeof props.top_bg_padding_num !== 'undefined')
					? props.top_bg_padding_num
					: false
			;

			bottom_padding = (typeof breakpoint_obj.bottom_bg_padding_num !== 'undefined')
				? breakpoint_obj.bottom_bg_padding_num
				: (typeof props.bottom_bg_padding_num !== 'undefined')
					? props.bottom_bg_padding_num
					: false
			;

			$region.css({
				'padding-top': ( false === top_padding ? '' : top_padding + 'px' ),
				'padding-bottom': ( false === bottom_padding ? '' : bottom_padding + 'px' )
			});
		},
		add_responsive_items: function() {
			var me = this,
				$regionEl = me.$el.parents('.upfront-region'),
				sub_models = me.model.get_sub_regions(),
				openItemControls = $('<span class="open-responsive-item-controls"></span>'),
				itemControls = $('<div class="responsive-item-controls">' + l10n.add_region + '</div>'),
				responsiveAddRegionTop = $('<div class="responsive-item-control responsive-add-region-top">' + l10n.above + '</div>'),
				responsiveAddRegionBottom = $('<div class="responsive-item-control responsive-add-region-bottom">' + l10n.below + '</div>'),
				responsiveAddRegionLeft = $('<div class="responsive-item-control responsive-add-region-left">' + l10n.left_sidebar + '</div>'),
				responsiveAddRegionRight = $('<div class="responsive-item-control responsive-add-region-right">' + l10n.right_sidebar + '</div>')
			;

			if($regionEl.find('.open-responsive-item-controls').length === 0) {
				openItemControls.click(function() {
					$regionEl.toggleClass('controls-visible');
				});
				$regionEl.append(openItemControls);
			}

			responsiveAddRegionTop.click(function() {
				me.add_panel_top.$el.find('.upfront-icon').trigger('click');
				$regionEl.toggleClass('controls-visible');
			});
			itemControls.append(responsiveAddRegionTop);

			responsiveAddRegionBottom.click(function() {
				me.add_panel_bottom.$el.find('.upfront-icon').trigger('click');
				$regionEl.toggleClass('controls-visible');
			});
			itemControls.append(responsiveAddRegionBottom);

			if ( me.model.is_main() && this.model.get('allow_sidebar') ){
				if(sub_models.left === false) {
					responsiveAddRegionLeft.click(function() {
						me.add_panel_left.$el.find('.upfront-icon').trigger('click');
						$regionEl.toggleClass('controls-visible');
					});
					itemControls.append(responsiveAddRegionLeft);
				}
				if(sub_models.right === false) {
					responsiveAddRegionRight.click(function() {
						me.add_panel_right.$el.find('.upfront-icon').trigger('click');
						$regionEl.toggleClass('controls-visible');
					});
					itemControls.append(responsiveAddRegionRight);
				}
			}
			$regionEl.find('.responsive-item-controls').remove();
			$regionEl.append(itemControls);
		},
		remove: function() {
			//this.edit_panel.remove();
			//this.delete_panel.remove();
			this.add_panel_top.remove();
			this.add_panel_bottom.remove();
			this.edit_panel = false;
			this.delete_panel = false;
			this.add_panel_top = false;
			this.add_panel_bottom = false;
			if ( this.model.is_main() && this.model.get('allow_sidebar') ){
				this.add_panel_left.remove();
				this.add_panel_right.remove();
				this.add_panel_left = false;
				this.add_panel_right = false;
			}
			$(window).off('scroll', this, this.on_scroll);
			Backbone.View.prototype.remove.call(this);
		}
	});


	var RegionFixedPanels = RegionPanels.extend({
		className: 'upfront-inline-panels upfront-region-fixed-panels upfront-ui',
		initialize: function () {
			var container = this.model.get('container'),
				name = this.model.get('name');
			this.listenTo(this.model.collection, 'add', this.render);
			this.listenTo(this.model.collection, 'remove', this.render);
			this.listenTo(Upfront.Events, "entity:region:activated", this.on_region_active);
			this.listenTo(Upfront.Events, "entity:region:deactivated", this.on_region_deactive);
			this.add_panel_top_left = new RegionPanel_Add({model: this.model, to: 'top-left', width: 50, height: 50});
			this.add_panel_top_right = new RegionPanel_Add({model: this.model, to: 'top-right', width: 50, height: 50});
			this.add_panel_bottom_left = new RegionPanel_Add({model: this.model, to: 'bottom-left', width: 50, height: 50});
			this.add_panel_bottom_right = new RegionPanel_Add({model: this.model, to: 'bottom-right', width: 50, height: 50});
		},
		panels: function () {
			var panels = _([]);
			panels.push( this.add_panel_top_left );
			panels.push( this.add_panel_top_right );
			panels.push( this.add_panel_bottom_left );
			panels.push( this.add_panel_bottom_right );
			this._panels = panels;
			return panels;
		},
		on_region_active: function (region) {
			if ( region.model != this.model )
				return;
			var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
			if ( $main.hasClass('upfront-region-fixed-editing') ){
				this.on_active();
				this.listenToOnce(Upfront.Events, 'sidebar:toggle:done', this.update_pos);
				$(window).on('scroll', this, this.on_scroll);
			}
		},
		remove: function() {
			this.add_panel_top_left.remove();
			this.add_panel_top_right.remove();
			this.add_panel_bottom_left.remove();
			this.add_panel_bottom_right.remove();
			this.add_panel_top_left = false;
			this.add_panel_top_right = false;
			this.add_panel_bottom_left = false;
			this.add_panel_bottom_right = false;
			Backbone.View.prototype.remove.call(this);
		}
	});

	var RegionFixedEditPosition = Backbone.View.extend({
		className: 'upfront-region-fixed-edit-pos',
		initialize: function () {

		},
		render: function () {
			var me = this,
				grid = Upfront.Settings.LayoutEditor.Grid,
				top = this.model.get_property_value_by_name('top'),
				is_top = ( typeof top == 'number' ),
				left = this.model.get_property_value_by_name('left'),
				is_left = ( typeof left == 'number' ),
				bottom = this.model.get_property_value_by_name('bottom'),
				is_bottom = ( typeof bottom == 'number' ),
				right = this.model.get_property_value_by_name('right'),
				is_right = ( typeof right == 'number' ),
				change = function () {
					var value = this.get_value(),
						saved = this.get_saved_value();
					if ( value != saved )
						this.property.set({'value': value});
				};
			this.fields = {
				width: new Upfront.Views.Editor.Field.Number({
					model: this.model,
					property: 'width',
					label: l10n.width,
					label_style: "inline",
					min: 3 * grid.column_width,
					max: Math.floor(grid.size/2) * grid.column_width
				}),
				height: new Upfront.Views.Editor.Field.Number({
					model: this.model,
					property: 'height',
					label: l10n.height,
					label_style: "inline",
					min: 3 * grid.baseline
				})
			};
			if ( is_top || !is_bottom )
				this.fields.top = new Upfront.Views.Editor.Field.Number({
					model: this.model,
					property: 'top',
					label: l10n.top,
					label_style: "inline",
					min: 0
				});
			else
				this.fields.bottom = new Upfront.Views.Editor.Field.Number({
					model: this.model,
					property: 'bottom',
					label: l10n.bottom,
					label_style: "inline",
					min: 0
				});
			if ( is_left || !is_right )
				this.fields.left = new Upfront.Views.Editor.Field.Number({
					model: this.model,
					property: 'left',
					label: l10n.left,
					label_style: "inline",
					min: 0
				});
			else
				this.fields.right = new Upfront.Views.Editor.Field.Number({
					model: this.model,
					property: 'right',
					label: l10n.right,
					label_style: "inline",
					min: 0
				});
			_.each(this.fields, function(field){
				field.render();
				field.delegateEvents();
				me.$el.append(field.$el);
			});
		},
		update_fields: function () {
			_.each(this.fields, function(field){
				var new_value = field.get_saved_value();
				field.set_value(new_value);
			});
		}
	});

	/** Responsive stuff, breakpoints, UI, etc */

	/**
	 * For easier setup of breakpoints.
	 */
	var Breakpoint_Model = Backbone.Model.extend({
		defaults: {
			'default': false,
			'name': 'Breakpoint',
			'short_name': 'breakpoint',
			'fixed': false,
			'enabled': false,
			'active': false,
			'width': 240,
			'columns': 5,
			'typography': {},
			'styles': ''
		},
		initialize: function() {
			// Fix 0 columns
			if (this.attributes.columns === 0 && this.attributes.width > 0) {
				this.attributes.columns = Math.round(this.attributes.width / 45); //todo get column width from theme
			}

			this.on('change:width', this.update_columns, this);
			this.on('change:columns', this.update_width, this);
			this.on('change:name', this.update_short_name, this);
		},
		update_width: function(me, new_columns) {
			var columns = parseInt(new_columns, 10);

			if (columns > 24) {
				this.set({ 'columns': 24 });
				return;
			}
			if (columns < 5) {
				this.set({ 'columns': 5 });
				return;
			}

			this.attributes.width = columns * 45; //todo get column width from theme
		},
		update_columns: function(me, new_width) {
			var new_columns;
			var width = parseInt(new_width, 10);

			if (width > 1080) {
				this.set({ 'width': 1080 });
				return;
			}
			if (width < 240) {
				this.set({ 'width': 240 });
				return;
			}

			new_columns = Math.round(width / 45); //todo get column width from theme
			if (this.attributes.columns !== new_columns) {
				this.attributes.columns =  new_columns;
			}
		},
		update_short_name: function(me, new_name) {
			this.attributes.short_name = new_name;
		},
		/* For compatibility with typography editor */
		get_property_value_by_name: function(name) {
			return this.get(name);
		},
		/* For compatibility with typography editor */
		set_property: function(name, value) {
			var map = {};
			map[name] = value;
			this.set(map);
		}
	});

	/**
	 * For centralized access to breakpoints for updating and watching on changes.
	 */
	var Breakpoints_Collection = Backbone.Collection.extend({
		model: Breakpoint_Model,
		initialize: function() {
			this.on( 'change:active', this.on_change_active, this);
			this.on( 'change:enabled', this.on_change_enabled, this);
			this.on( 'change:width', this.on_change_width, this);
		},
		on_change_active: function(changed_model) {
			var prev_active_json = this.active ? this.active.toJSON() : false;
			this.prev_active = this.active;
			this.active = changed_model;

			_.each(this.models, function(model) {
				if (model.get('id') === changed_model.get('id')) return;

				model.set({ 'active': false }, { 'silent': true });
			});

			Upfront.Events.trigger("upfront:layout_size:change_breakpoint", changed_model.toJSON(), prev_active_json);

			//todo This should go somewhere else
			if (this.prev_active) {
				$('#page').removeClass(this.prev_active.get('id') + '-breakpoint');
			}
			$('#page').addClass(this.active.get('id') + '-breakpoint');

			if (this.active.get('default'))
				$('#page').removeClass('responsive-breakpoint').addClass('default-breakpoint');
			else
				$('#page').removeClass('default-breakpoint').addClass('responsive-breakpoint');
		},
		on_change_enabled: function(changed_model) {
			// If disabled point was active it will disapear and leave UI in broken state.
			if (changed_model.get('active') === false) return;

			// Activate default breakpoint and fire event.
			var default_breakpoint = this.get_default();

			default_breakpoint.set({ 'active': true });
		},
		on_change_width: function(changed_model, new_width) {
			Upfront.Events.trigger("upfront:layout_size:viewport_width_change", new_width);
		},
		sorted_by_width: function() {
			return _.sortBy(this.models, function(model) {
				return model.get('width')
			});
		},
		get_active: function() {
			var active_breakpoint = this.findWhere({ 'active': true });
			if (_.isUndefined(active_breakpoint) === false) return active_breakpoint;

			active_breakpoint = this.get_default();
			active_breakpoint.set({ 'active': true });
			return active_breakpoint;
		},
		get_enabled: function() {
			var enabled_breakpoints = this.where({ 'enabled': true });
			if (_.isUndefined(enabled_breakpoints) === false && enabled_breakpoints.length > 0) return enabled_breakpoints;

			return [this.get_active()];


		},
		get_default: function() {
			var default_breakpoint = this.findWhere({ 'default': true });
			if (_.isUndefined(default_breakpoint)) {
				default_breakpoint = this.findWhere({ 'id': 'desktop' });
				if (default_breakpoint) default_breakpoint.set({ 'default': true });
			}
			if (_.isUndefined(default_breakpoint)) throw 'Breakpoints are not loaded properly.';

			return default_breakpoint;
		},
		get_unique_id: function() {
			var id = 'custom-' + +(new Date());

			// Ensure id is unique
			while (!_.isUndefined(this.findWhere({ 'id': id }))) {
				id = 'custom-' + +(new Date());
			}

			return id;
		}
	});

	// Breakpoint events tests - uncomment if needed
	// Upfront.Events.on("upfront:layout_size:change_breakpoint", function(breakpoint, prev_breakpoint) {
		// if (prev_breakpoint) console.log(['Breakpoint deactivated', prev_breakpoint.name, prev_breakpoint.width].join(' '));
	// });
	// Upfront.Events.on("upfront:layout_size:viewport_width_change", function(new_width) {
		// console.log(['Viewport width changed:', new_width].join(' '));
	// });

	/**
	 * Wrapper for Breakpoints_Collection since we can't use Backbone.Collection
	 * native saving.
	 */
	var Breakpoints_Storage = function(stored_breakpoints) {
		var breakpoints;

		var initialize = function() {
			breakpoints = new Breakpoints_Collection(stored_breakpoints);
			var default_breakpoint = breakpoints.get_default();
			default_breakpoint.set({ 'active': true });

			breakpoints.on('change:enabled change:width change:name add remove change:typography change:styles', save_breakpoints);

			// This should go somewhere else, just a temp
			_.each(breakpoints.models, function(breakpoint) {
				var $style = $('#' + breakpoint.get('id') + '-breakpoint-style');

				if ($style.length > 0) return;

				$('body').append('<style id="' + breakpoint.get('id') + '-breakpoint-style">' +
					breakpoint.get('styles') +
					'</style>'
				);
			});
		};

		this.get_breakpoints = function() {
			return breakpoints;
		};

		var save_breakpoints = function() {
			var postData = {
				action: 'upfront_update_breakpoints',
				breakpoints: breakpoints.toJSON()
			};

			Upfront.Util.post(postData)
				.error(function(){
					return notifier.addMessage(l10n.breakpoint_save_fail);
				});
		};

		Upfront.Events.once("application:mode:before_switch", initialize);
	};

	var breakpoints_storage = new Breakpoints_Storage(Upfront.mainData.themeInfo.breakpoints);

	/**
	 * Activates breakpoint which will change layout size.
	 */
	var Breakpoint_Activate_Button = Backbone.View.extend({
		tagName: 'li',
		template: '{{ short_name }} ({{ width }}px)',
		className: function() {
			return this.model.get('id') + '-breakpoint-activate';
		},
		events: {
			'click': 'on_click'
		},
		initialize: function(options) {
			this.options = options || {};
		},
		render: function() {
			this.$el.html(_.template(this.template, this.model.toJSON()));
			if (this.model.get('active')) this.$el.addClass('active');
			return this;
		},
		on_click: function() {
			this.model.set({ 'active': true });
		}
	});

	var BreakpointsToggler = Backbone.View.extend({
		tagName: 'ul',
		className: 'breakpoints-toggler',
		initialize: function() {
			this.collection = breakpoints_storage.get_breakpoints();

			this.listenTo(this.collection, 'add remove change', this.render);
		},
		render: function() {
			this.$el.html('');
			_.each(this.collection.sorted_by_width(), function(breakpoint) {
				// Add only enabled breakpoints
				if (breakpoint.get('enabled') === false) return;

				var breakpoint_button = new Breakpoint_Activate_Button({ model: breakpoint});
				this.$el.append(breakpoint_button.render().el);
			}, this);
			return this;
		}
	});

	var BreakpointWidthInput = Backbone.View.extend({
		className: 'breakpoint-width-input',
		initialize: function(options) {
			this.options = options || {};
			this.collection = breakpoints_storage.get_breakpoints();
			this.listenTo(this.collection, 'change:active', this.render);

		},
		render: function() {
			this.$el.html('');
			this.active_breakpoint = this.collection.get_active();
			// Debounce input value change event since it causes some heavy operations to kick in.
			var lazy_propagate_change = _.debounce(this.propagate_change, 1000);

			if (this.active_breakpoint.get('fixed')) return this;

			this.input = new Upfront.Views.Editor.Field.Number({
				className: 'inline-number plaintext-settings',
				min: 1,
				label: l10n.viewport_width,
				suffix: "px",
				default_value: this.active_breakpoint.get('width')
			});

			this.input.render();
			this.$el.html(this.input.el);

			this.listenTo(this.input, 'changed', lazy_propagate_change);

			return this;
		},
		propagate_change: function() {
			this.active_breakpoint.set({ 'width': this.input.get_value() });
		}
	});

	var BreakpointEditPanel = Backbone.View.extend({
		className: 'breakpoint-edit-panel',
		template: '<div><span class="edit-breakpoint-popup-title">' + l10n.set_custom_breakpoint + ':</span></div>' +
			'<div>' +
			'<label for="breakpoint-name">' + l10n.name + ':</label><input type="text" value="{{ name }}" placeholder="' + l10n.custom_breakpoint_placeholder + '" id="breakpoint-name" />' +
			'</div><div>' +
			'<label for="breakpoint-width">' + l10n.width + ':</label><input type="number" min="240" max="1080" value="{{ width }}" id="breakpoint-width" /><label>px</label>' +
			'<label for="breakpoint-columns">' + l10n.number_of_columns + ':</label><input min="5" max="24" type="number" value="{{ columns }}" id="breakpoint-columns" />' +
			'</div>',
		events: {
			'change #breakpoint-name': 'on_name_change',
			'change #breakpoint-width': 'on_width_change',
			'change #breakpoint-columns': 'on_columns_change'
		},
		initialize: function(options) {
			this.options = options || {};
			if (_.isUndefined(this.model)) {
				this.model = breakpoints_storage.get_breakpoints().get_active();
			}

			this.listenTo(this.model, 'change', this.update_values);

			// When changing width to fast there is too much rendering
			this.lazy_change_width = _.debounce(function(width) {
				this.model.set({ 'width': width });
			}, 500);
		},
		render: function() {
			this.$el.html(_.template(this.template, this.model.toJSON()));

			return this;
		},
		update_values: function() {
			this.$el.find('#breakpoint-name').val(this.model.get('name'));
			this.$el.find('#breakpoint-width').val(this.model.get('width'));
			this.$el.find('#breakpoint-columns').val(this.model.get('columns'));
		},
		on_name_change: function(event) {
			this.model.set({ 'name': $(event.currentTarget).val() });
		},
		on_width_change: function(event) {
			this.lazy_change_width($(event.currentTarget).val());
		},
		on_columns_change: function(event) {
			this.model.set({ 'columns': $(event.currentTarget).val() });
		}
	});

	var BreakpointEditButton = Backbone.View.extend({
		className: 'breakpoint-edit',
		events: {
			'click #edit-breakpoint': 'edit_breakpoint'
		},
		initialize: function(options) {
			this.options = options || {};
			this.collection = breakpoints_storage.get_breakpoints();
			this.listenTo(this.collection, 'change:active', this.render);
		},
		render: function() {
			this.$el.html('');
			this.active_breakpoint = this.collection.get_active();

			if (this.active_breakpoint.get('fixed')) return this;

			this.$el.html('<a href="" id="edit-breakpoint">' + l10n.edit_breakpoint + '</a>');

			return this;
		},
		edit_breakpoint: function(event) {
			event.preventDefault();
			var popup;

			popup = Upfront.Popup.open(function (data, $top, $bottom) {
				$top.empty();
				var $content = $(this);
				var editPanel = new BreakpointEditPanel();

				$content
				.append(editPanel.render().el);
				$bottom.append('<div class="breakpoint-edit-ok-button">' + l10n.ok + '</div>');
				$('#upfront-popup-close').hide();
				$('.breakpoint-edit-ok-button').on('click', function() {
					Upfront.Popup.close();
					$('#upfront-popup-close').show();
				});
			}, {
				width: 400
			});
		}
	});

	/** End responsive stuff, breakpoints, UI, etc */

	var Topbar = Backbone.View.extend({
		id: 'upfront-ui-topbar',
		content_views: [],
		initialize: function () {
			this.listenTo(Upfront.Events, 'sidebar:toggle', this.on_sidebar_toggle);
		},
		render: function() {
			_.each(this.content_views, function(view) {
				view.render();
				this.$el.append(view.el);
			}, this);

			return this;
		},
		start: function() {
			this.content_views = [];
			if ( Upfront.Application.get_current() === Upfront.Settings.Application.MODE.RESPONSIVE ) {
				this.content_views.push(new BreakpointEditButton());
				this.content_views.push(new BreakpointsToggler());
			}
			$('body').prepend(this.render().el);
		},
		stop: function() {
			this.remove();
		},
		on_sidebar_toggle: function (visible) {
			if ( !visible )
				this.$el.css('left', 0);
			else
				this.$el.css('left', '');
		}
	});

	return {
		"Editor": {
			"Property": Property,
			"Properties": Properties,
			"Commands": Commands,
			"Command": Command,
			"Command_SaveLayout": Command_SaveLayout,
			"Command_SavePostLayout": Command_SavePostLayout,
			"Command_CancelPostLayout": Command_CancelPostLayout,
			"Command_Undo": Command_Undo,
			"Command_ToggleGrid": Command_ToggleGrid,
			"Command_Merge": Command_Merge,
			"Settings": {
				"Settings": Settings,
				"Panel": SettingsPanel,
				"Item": SettingsItem,
				"ItemTabbed": SettingsItemTabbed,
				"Lightbox": {
					"Trigger": Settings_LightboxTrigger,
					"LabeledTrigger": Settings_LabeledLightboxTrigger
				},
				"Anchor": {
					"Trigger": Settings_AnchorTrigger,
					"LabeledTrigger": Settings_LabeledAnchorTrigger
				},
				"Settings_CSS": _Settings_CSS,
				"AnchorSetting": _Settings_AnchorSetting
			},
			"Button": {
				"Presets": button_presets_collection,
			},
			"Fonts": {
				"System": system_fonts_storage,
				"Google": google_fonts_storage,
				Text_Fonts_Manager: Text_Fonts_Manager,
				Icon_Fonts_Manager: Icon_Fonts_Manager,
				theme_fonts_collection: theme_fonts_collection,
				icon_fonts_collection: icon_fonts_collection
			},
			"Field": {
				"Field": Field,
				"Text": Field_Text,
				"Button": Field_Button,
				"Email": Field_Email,
				"Textarea": Field_Textarea,
				"Color": Field_Color,
				"Multiple_Suggest": Field_Multiple_Suggest,
				"Chosen_Select": Field_Chosen_Select,
				"Typeface_Chosen_Select": Field_Typeface_Chosen_Select,
				"Typeface_Style_Chosen_Select": Field_Typeface_Style_Chosen_Select,
				"Multiple_Chosen_Select": Field_Multiple_Chosen_Select,
				"Number": Field_Number,
				"Slider": Field_Slider,
				"Select": Field_Select,
				"Radios": Field_Radios,
				"Checkboxes": Field_Checkboxes,
				"Hidden": Field_Hidden,
				"Anchor": Field_Anchor,
				"Optional": OptionalField
			},
			"Sidebar": {
				"Sidebar": Sidebar,
				"Panel": SidebarPanel,
				"Element": DraggableElement
			},
			"Topbar": {
				"Topbar": Topbar
			},
			notify : function(message, type, duration){
				notifier.addMessage(message, type, duration);
			},
			"Loading": Loading,
			"Modal": Modal,
			"ModalBgSetting": ModalBgSetting,
			"PostSelector": new PostSelector(),
			InlinePanels: InlinePanels,
			"RegionPanels": RegionPanels,
			"RegionPanelsAddRegion": RegionPanelItem_AddRegion,
			"RegionFixedPanels": RegionFixedPanels,
			"RegionFixedEditPosition" : RegionFixedEditPosition,
			"CSSEditor": CSSEditor,
			"Insert_Font_Widget": Insert_Font_Widget,
			"GeneralCSSEditor": GeneralCSSEditor,
			"LinkPanel": LinkPanel
		},
		Mixins: {
			"Upfront_Scroll_Mixin": Upfront_Scroll_Mixin
		},
		Theme_Colors : Theme_Colors,
		breakpoints_storage: breakpoints_storage,
		Font_Model: Font_Model
	};
});
})(jQuery);

//@ sourceURL=upfront-views-editor.js
;
(function ($) {

var LayoutEditor = {
	selection: [], // store selection
	selecting: false, // true when selecting start, false when stopped
	create_mergeable: function (view, model) {
		var app = this,
			ed = Upfront.Behaviors.LayoutEditor,
			regions = app.layout.get('regions')
		;
		view.$el.selectable({
			distance: 10, // Prevents global click hijack
			filter: ".upfront-module",
			cancel: ".upfront-module, .upfront-module-group, .upfront-region-side-fixed, .upfront-entity_meta, .upfront-region-edit-trigger, .upfront-region-edit-fixed-trigger, .upfront-region-finish-edit, .upfront-icon-control-region-resize, .upfront-inline-modal, .upfront-inline-panels",
			selecting: function (e, ui) {
				var $el = $(ui.selecting),
					$region, $selected, $affected, group, do_select;
				// make sure it's not inside module group
				if ( $el.closest('.upfront-module-group').length > 0 ) return;
				if ( ed.selection.length > 0 ){
					// if we already have at least one selection, check if the next selection is mergeable or not
					// make sure it's in the same region
					$region = $(ed.selection[0]).closest('.upfront-region');
					if ( $el.closest('.upfront-region').get(0) != $region.get(0) ) return;
					ed._add_selections( $region.find('.ui-selecting'), $region.find('.upfront-module').not('.upfront-ui-selected, .upfront-module-parent-group'), $region.find('.upfront-module-group') );
				}
				else {
					ed._add_selection(ui.selecting);
				}
				ed._update_selection_outline();
			},
			unselecting: function (e, ui) {
				var $el = $(ui.unselecting),
					$region, $selected
				;
				if ( ed.selection.length > 1 ){
					$region = $(ed.selection[0]).closest('.upfront-region');
					if ( $el.closest('.upfront-region').get(0) != $region.get(0) ) return;
					$('.upfront-ui-selected').each(function(){
						ed._remove_selection(this);
					});
					$selected = $region.find('.ui-selecting');
					if ( $selected.length > 0 ) {
						ed._add_selection($selected.get(0));
						ed._add_selections( $selected, $region.find('.upfront-module').not('.upfront-ui-selected, .upfront-module-parent-group'), $region.find('.upfront-module-group') );
					}

					ed._update_selection_outline();
					return;
				}
				ed._remove_selection(ui.unselecting);
				ed._update_selection_outline();
			},
			/*selected: function (e, ui) {
				var $el = $(ui.selected);
				$el.prepend('<div class="upfront-selected-border" />');
			},*/
			unselected: function (e, ui) {
				var $el = $(ui.unselected);
				$el.find('.upfront-selected-border').remove();
				$('.upfront-module-group-group').remove();
			},
			start: function (e, ui) {
				// reset selection on start
				ed.remove_selections();
				ed.selection = [];
				ed.selecting = true;
			},
			stop: function (e, ui) {
				ed.parse_selections();
			}
		});
	},

	refresh_mergeable: function () {
		this.remove_selections();
		$(".ui-selectable").each(function () {
			$(this).selectable("refresh");
		});
	},

	enable_mergeable: function () {
		this.remove_selections();
		$(".ui-selectable").each(function () {
			$(this).selectable("enable");
		});
	},

	disable_mergeable: function () {
		this.remove_selections();
		$(".ui-selectable").each(function () {
			$(this).selectable("disable");
		});
	},

	destroy_mergeable: function () {
		this.remove_selections();
		$(".ui-selectable").each(function () {
			$(this).selectable("destroy");
		});
	},

	parse_selections: function () {
		if ( !$(".upfront-ui-selected").length )
			return false;
		var ed = this,
			regions = Upfront.Application.layout.get('regions'),
			$region = $(".upfront-ui-selected:first").closest('.upfront-region'),
			region = regions.get_by_name($region.data('name')),
			region_modules = (region ? region.get("modules") : false),
			region_wrappers = (region ? region.get("wrappers") : false),
			unselect = function(){
				$(this).find('.upfront-selected-border').remove();
				$(this).removeClass('upfront-ui-selected ui-selected');
			},
			$selected = $('.upfront-ui-selected');
		if ($selected.length < 2){
			$selected.each(function(){
				ed._remove_selection(this);
			});
			$('#upfront-group-selection').remove();
			return false;
		};
		$('.upfront-module-group-group').remove();
		var $group = $('<div class="upfront-module-group-toggle upfront-module-group-group">' + Upfront.Settings.l10n.global.behaviors.group + '</div>'),
			sel_top = sel_left = sel_right = sel_bottom = false,
			wrap_top = wrap_left = wrap_right = wrap_bottom = false,
			group_top = group_left = 0;
		$('body').append($group);
		$selected.each(function(){
			var off = $(this).offset(),
				width = $(this).outerWidth(),
				height = $(this).outerHeight(),
				$wrap = $(this).closest('.upfront-wrapper'),
				wrap_off = $wrap.offset(),
				wrap_width = $wrap.outerWidth(),
				wrap_height = $wrap.outerHeight()
			;
			off.right = off.left + width;
			off.bottom = off.top + height;
			sel_top = ( sel_top === false || off.top < sel_top ) ? off.top : sel_top;
			sel_bottom = ( sel_bottom === false || off.bottom > sel_bottom ) ? off.bottom : sel_bottom;
			sel_left = ( sel_left === false || off.left < sel_left ) ? off.left : sel_left;
			sel_right = ( sel_right === false || off.right > sel_right ) ? off.right : sel_right;
			wrap_off.right = wrap_off.left + wrap_width;
			wrap_off.bottom = wrap_off.top + wrap_height;
			wrap_top = ( wrap_top === false || wrap_off.top < wrap_top ) ? wrap_off.top : wrap_top;
			wrap_bottom = ( wrap_bottom === false || wrap_off.bottom > wrap_bottom ) ? wrap_off.bottom : wrap_bottom;
			wrap_left = ( wrap_left === false || wrap_off.left < wrap_left ) ? wrap_off.left : wrap_left;
			wrap_right = ( wrap_right === false || wrap_off.right > wrap_right ) ? wrap_off.right : wrap_right;
		});
		group_top = sel_top + Math.round( (sel_bottom-sel_top)/2 ) - Math.round( $group.outerHeight()/2 );
		group_left = sel_left + Math.round( (sel_right-sel_left)/2 ) - Math.round( $group.outerWidth()/2 );
		$group.css({
			position: 'absolute',
			zIndex: 999999,
			top: group_top,
			left: group_left
		});
		setTimeout(function(){ ed.selecting = false; }, 1000);
		$group.on('click', function () {
			var breakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),
				grid_ed = Upfront.Behaviors.GridEditor,
				first_module_view = false,
				max_col = Math.round((wrap_right-wrap_left)/grid_ed.grid.column_width),
				lines = grid_ed.parse_modules_to_lines(region_modules, region_wrappers, breakpoint.id, breakpoint.columns),
				group_lines = [],
				prev_group_lines = [],
				next_group_lines = [],
				is_prev_group_combine = false,
				is_next_group_combine = false,
				group_col = 0,
				prev_group_col = 0,
				next_group_col = 0,
				do_split = false
				;
			// Parse the lines into groups
			_.each(lines, function (l) {
				var wrappers = [],
					prev_wrappers = [],
					next_wrappers = [],
					top_wrappers = [],
					bottom_wrappers = [],
					line_col = 0,
					prev_line_col = 0,
					next_line_col = 0
					;
				_.each(l.wrappers, function (w) {
					var modules = [],
						top_modules = [],
						bottom_modules = []
						;
					_.each(w.modules, function (m) {
						var found = false;
						$selected.each(function () {
							var element_id = $(this).attr('id'),
								index;
							if ( m.model.get_element_id() == element_id ) {
								if ( first_module_view === false ) {
									first_module_view = Upfront.data.module_views[m.model.cid];
								}
								modules.push(m);
								found = true;
							}
						});
						if ( !found ) {
							if ( modules.length == 0 ) {
								top_modules.push(m);
							}
							else {
								bottom_modules.push(m);
							}
						}
					});
					if ( modules.length > 0 ) {
						wrappers.push({
							modules: modules,
							top_modules: top_modules,
							bottom_modules: bottom_modules,
							model: w.model,
							col: w.col,
							clear: w.clear,
							spacer: w.spacer,
							order: w.order
						});
						line_col += w.col;
						if ( top_modules.length ) {
							top_wrappers.push({
								modules: top_modules,
								model: w.model,
								col: w.col,
								clear: w.clear,
								spacer: w.spacer,
								order: w.order
							});
						}
						if ( bottom_modules.length ) {
							bottom_wrappers.push({
								modules: bottom_modules,
								model: w.model,
								col: w.col,
								clear: w.clear,
								spacer: w.spacer,
								order: w.order
							});
						}
					}
					else {
						( wrappers.length == 0 ? prev_wrappers : next_wrappers ).push({
							modules: w.modules,
							model: w.model,
							col: w.col,
							clear: w.clear,
							spacer: w.spacer,
							order: w.order
						});
						if ( wrappers.length == 0 ) prev_line_col += w.col;
						else next_line_col += w.col;
					}
				});
				if ( wrappers.length > 0 ) {
					group_lines.push({
						wrappers: wrappers,
						top_wrappers: top_wrappers,
						bottom_wrappers: bottom_wrappers,
						col: line_col
					});
					group_col = line_col > group_col ? line_col : group_col;
					if ( prev_wrappers.length > 0 ) {
						prev_group_lines.push({
							wrappers: prev_wrappers,
							col: prev_line_col
						});
						prev_group_col = prev_line_col > prev_group_col ? prev_line_col : prev_group_col;
					}
					if ( next_wrappers.length > 0 ) {
						next_group_lines.push({
							wrappers: next_wrappers,
							col: next_line_col
						});
						next_group_col = next_line_col > next_group_col ? next_line_col : next_group_col;
					}
				}
			});
			grid_ed.start(first_module_view, first_module_view.model);

			// Grouping!
			// Try to see if previous elements qualify to be grouped/combined (that is if it has > 1 line)
			if ( prev_group_lines.length > 1 ) {
				if ( !ed._do_combine(prev_group_lines, region) ) {
					ed._do_group(prev_group_lines, region);
				}
			}
			// If we don't have affected previous/next elements, we'll split non-selected element outside group
			// Otherwise, it creates another group
			if ( prev_group_lines.length == 0 && next_group_lines.length == 0 ) {
				do_split = true;
			}
			ed._do_group(group_lines, region, false, do_split);
			// Try to see if next elements qualify to be grouped/combined (that is if it has > 1 line)
			if ( next_group_lines.length > 1 ) {
				if ( !ed._do_combine(next_group_lines, region) ) {
					ed._do_group(next_group_lines, region);
				}
			}

			// now normalize the wrappers
			grid_ed.update_position_data($region.find('.upfront-editable_entities_container:first'));
			grid_ed.update_wrappers(region);

			$(this).remove();
			$('#upfront-group-selection').remove();
			ed.selection = [];
		});
	},

	_do_group: function (lines, region, force_add_wrapper, do_split)  {
		var ed = this,
			grid_ed = Upfront.Behaviors.GridEditor,
			add_wrapper = (force_add_wrapper === true),
			do_split = ( do_split === true ),
			region_modules = region.get("modules"),
			region_wrappers = region.get("wrappers"),
			group_id = Upfront.Util.get_unique_id("module-group"),
			group = new Upfront.Models.ModuleGroup(),
			group_view = false,
			group_modules = group.get('modules'),
			group_wrappers = group.get('wrappers'),
			group_wrapper_clear = false,
			group_wrapper = false,
			group_wrapper_id = false,
			group_col = 0,
			add_index = false,
			top_add_index = false
		;
		_.each(lines, function (l, li) {
			group_col = l.col > group_col ? l.col : group_col;
			_.each(l.wrappers, function (w, wi) {
				var new_wrapper = new Upfront.Models.Wrapper({}),
					new_wrapper_id = Upfront.Util.get_unique_id("wrapper"),
					wrapper_view = Upfront.data.wrapper_views[w.model.cid],
					has_top_modules = ( 'top_modules' in w && w.top_modules.length > 0 ),
					has_bottom_modules = ( 'bottom_modules' in w && w.bottom_modules.length > 0 )
				;
				new_wrapper.set_property('wrapper_id', new_wrapper_id);
				new_wrapper.set_property('class', w.model.get_property_value_by_name('class'));
				new_wrapper.replace_class(grid_ed.grid.class + w.col);
				if ( wi == 0 ) {
					new_wrapper.add_class('clr');
					if ( li == 0 ) {
						group_wrapper_clear = w.clear;
					}
				}
				group_wrappers.add(new_wrapper);
				_.each(w.modules, function (m, mi) {
					var index = region_modules.indexOf(m.model),
						view = Upfront.data.module_views[m.model.cid]
					;
					if ( add_index === false ) {
						add_index = index;
					}
					m.model.set_property('wrapper_id', new_wrapper_id, true);
					region_modules.remove(m.model, {silent: true});
					view.$el.detach(); // Detach element from DOM, will render later with group render
					if ( !has_top_modules && !has_bottom_modules ) {
						wrapper_view.$el.detach(); // Detach wrapper view from DOM too
					}
					group_modules.add(m.model);
				});
				if ( li == 0 && wi == 0 ) {
					// First wrapper is now used for group wrapper
					group_wrapper_id = w.model.get_wrapper_id();
					group_wrapper = w.model;
				}
				else if ( !has_top_modules ) {
					// Unused wrapper, remove
					region_wrappers.remove(w.model);
				}
			});
			if ( 'bottom_wrappers' in l && l.bottom_wrappers.length > 1 ) {
				// Has bottom wrappers, let's group that too
				if ( do_split ) {
					ed._do_split(l.bottom_wrappers, region);
				}
				else {
					ed._do_group([{
						wrappers: l.bottom_wrappers,
						col: l.col
					}], region);
				}
			}
			if ( 'top_wrappers' in l && l.top_wrappers.length > 1 ) {
				// Has top wrappers, let's group that too, create new wrapper instead
				if ( do_split ) {
					// We don't actually split the top wrappers, the group will be render below that
					// But we need to fix the element position
					_.each(l.top_wrappers, function (w, wi) {
						_.each(w.modules, function (m, mi) {
							var index = region_modules.indexOf(m.model);
							if ( top_add_index === false ) {
								top_add_index = index;
								return;
							}
							region_modules.remove(m.model, {silent: true});
							top_add_index++;
							m.model.add_to(region_modules, top_add_index);
						});
					});
					if ( top_add_index !== false ) {
						add_index = top_add_index+1;
					}
					add_wrapper = true;
				}
				else {
					ed._do_group([{
						wrappers: l.top_wrappers,
						col: l.col
					}], region);
				}
			}
		});
		if ( add_wrapper ) {
			group_wrapper = new Upfront.Models.Wrapper({});
			group_wrapper_id = Upfront.Util.get_unique_id("wrapper");
			region_wrappers.add(group_wrapper);
		}
		group_wrapper.set_property('wrapper_id', group_wrapper_id);
		group_wrapper.replace_class(grid_ed.grid.class + group_col);
		if ( group_wrapper_clear ){
			group_wrapper.add_class('clr');
		}
		group.set_property('wrapper_id', group_wrapper_id);
		group.set_property('element_id', group_id);
		group.replace_class(grid_ed.grid.class + group_col);
		group.set_property('original_col', group_col);
		group.add_to(region_modules, add_index);
		Upfront.Events.trigger("entity:module_group:group", group, region);
	},

	_do_combine: function (lines, region) {
		var ed = this,
			grid_ed = Upfront.Behaviors.GridEditor,
			region_modules = region.get("modules"),
			region_wrappers = region.get("wrappers"),
			wrappers_col = [],
			wrappers_combine = [],
			can_combine = true
		;
		_.each(lines, function (l, li) {
			if ( !(li in wrappers_col) ) wrappers_col[li] = [];
			_.each(l.wrappers, function (w, wi) {
				if ( !(wi in wrappers_combine) ) wrappers_combine[wi] = [];
				wrappers_col[li][wi] = w.col;
				wrappers_combine[wi].push(w);
			});
		});
		// Check if it's possible to combine modules to the same wrapper
		if ( wrappers_col.length > 1 ) {
			for ( var i = 1; i < wrappers_col.length; i++ ) {
				if ( !_.isEqual(wrappers_col[i-1], wrappers_col[i]) ) {
					can_combine = false;
					break;
				}
			}
		}
		if ( !can_combine ) return false;
		_.each(wrappers_combine, function (combine) {
			var add_index = 0,
				spacers = _.filter(combine, function(w){ return w.spacer; }),
				all_spacers = ( combine.length == spacers.length ),
				wrapper_id
			;
			_.each(combine, function (w, wi) {
				if ( wi == 0 ) {
					// The first wrapper which we'll use for combine
					wrapper_id = w.model.get_wrapper_id();
					add_index = region_modules.indexOf(_.last(w.modules).model);
					if ( w.spacer && !all_spacers ) {
						// It's spacer but we have other element below, so just remove this spacer
						_.each(w.modules, function (m) {
							region_modules.remove(m.model);
						});
						add_index--;
					}
					return;
				}
				region_wrappers.remove(w.model);
				if ( w.spacer ) {
					_.each(w.modules, function (m) {
						region_modules.remove(m.model);
					});
				}
				else {
					_.each(w.modules, function (m, mi) {
						m.model.set_property('wrapper_id', wrapper_id, true);
						region_modules.remove(m.model, {silent: true});
						add_index++;
						m.model.add_to(region_modules, add_index);
					});
				}
			});
		});
		return true;
	},

	_do_split: function (wrappers, region) {
		var ed = this,
			grid_ed = Upfront.Behaviors.GridEditor,
			region_modules = region.get("modules"),
			region_wrappers = region.get("wrappers")
		;
		_.each(wrappers, function (w, wi) {
			var new_wrapper = new Upfront.Models.Wrapper({}),
				new_wrapper_id = Upfront.Util.get_unique_id("wrapper")
			;
			new_wrapper.set_property('wrapper_id', new_wrapper_id);
			new_wrapper.set_property('class', w.model.get_property_value_by_name('class'));
			region_wrappers.add(new_wrapper);
			_.each(w.modules, function (m, mi) {
				var index = region_modules.indexOf(m.model);
				m.model.set_property('wrapper_id', new_wrapper_id, true);
				region_modules.remove(m.model, {silent: true});
				m.model.add_to(region_modules, index);
			});
		});
		return true;
	},

	_get_group_position: function ($selected) {
		var sel_top = sel_left = sel_right = sel_bottom = false,
			wrap_top = wrap_left = wrap_right = wrap_bottom = false
		;
		$selected.each(function(){
			var off = $(this).offset(),
				width = Math.round(parseFloat($(this).css('width'))),
				height = Math.round(parseFloat($(this).css('height'))),
				$wrap = $(this).closest('.upfront-wrapper'),
				wrap_off = $wrap.offset(),
				wrap_width = Math.round(parseFloat($wrap.css('width'))),
				wrap_height = Math.round(parseFloat($wrap.css('height')))
			;
			off.left = Math.round(off.left);
			off.top = Math.round(off.top);
			off.right = off.left + width;
			off.bottom = off.top + height;
			sel_top = ( sel_top === false || off.top < sel_top ) ? off.top : sel_top;
			sel_bottom = ( sel_bottom === false || off.bottom > sel_bottom ) ? off.bottom : sel_bottom;
			sel_left = ( sel_left === false || off.left < sel_left ) ? off.left : sel_left;
			sel_right = ( sel_right === false || off.right > sel_right ) ? off.right : sel_right;
			wrap_off.left = Math.round(wrap_off.left);
			wrap_off.top = Math.round(wrap_off.top);
			wrap_off.right = wrap_off.left + wrap_width;
			wrap_off.bottom = wrap_off.top + wrap_height;
			wrap_top = ( wrap_top === false || wrap_off.top < wrap_top ) ? wrap_off.top : wrap_top;
			wrap_bottom = ( wrap_bottom === false || wrap_off.bottom > wrap_bottom ) ? wrap_off.bottom : wrap_bottom;
			wrap_left = ( wrap_left === false || wrap_off.left < wrap_left ) ? wrap_off.left : wrap_left;
			wrap_right = ( wrap_right === false || wrap_off.right > wrap_right ) ? wrap_off.right : wrap_right;
		});
		return {
			element: {
				top: sel_top,
				bottom: sel_bottom,
				left: sel_left,
				right: sel_right
			},
			wrapper: {
				top: wrap_top,
				bottom: wrap_bottom,
				left: wrap_left,
				right: wrap_right
			}
		};
	},

	_find_affected_el: function ($els, pos) {
		if ( this.selection.length == 0 ) return false;
		var $affected = false;
		$els.each(function(){
			var off = $(this).offset(),
				width = Math.round(parseFloat($(this).css('width'))),
				height = Math.round(parseFloat($(this).css('height'))),
				top = Math.round(off.top),
				left = Math.round(off.left),
				bottom = top + height,
				right = left + width
			;
			if ( pos.top < bottom && pos.bottom > top && pos.left < right && pos.right > left ) {
				$affected = $affected !== false ? $affected.add($(this)) : $(this);
			}
		})
		return $affected;
	},

	_update_selection_outline: function () {
		var $selection = $('#upfront-group-selection'),
			group = this._get_group_position($(this.selection));

		if ( !$selection.length ){
			$selection = $('<div id="upfront-group-selection" />');
			$selection.appendTo('body');
		}
		$selection.css({
			top: group.element.top,
			left: group.element.left,
			height: group.element.bottom - group.element.top,
			width: group.element.right - group.element.left
		});
	},

	_add_selection: function (el) {
		var find = _.find(this.selection, function(sel){ return (sel == el); });
		if ( find ) return;
		this.selection.push(el);
		$(el).addClass('upfront-ui-selected');
		//$(el).prepend('<div class="upfront-selected-border" />');
	},

	/**
	 * Automatically resolve conflict on adding multiple selections
	 */
	_add_selections: function ($selecting, $affected_els, $restrict_els) {
		var ed = this,
			selected = [],
			group,
			$affected,
			$restricted
		;
		// Add selection one-by-one
		$selecting.each(function () {
			var el = this,
				find = _.find(ed.selection, function(sel){ return (sel == el); }),
				$affected_els_tmp = $($affected_els)
			;
			if ( find ) return;
			selected = [];
			group = ed._get_group_position( $(ed.selection).add(this) );
			$affected = ed._find_affected_el( $affected_els_tmp, group.element);
			// Find all affected elements by this selection
			while ( $affected !== false ) {
				$affected.each(function(){ selected.push(this); });
				$affected_els_tmp = $affected_els_tmp.not($affected);
				group = ed._get_group_position( $(ed.selection).add(selected) );
				$affected = ed._find_affected_el( $affected_els_tmp, group.element );
			}
			// Make sure no restricted element is on the way
			$restricted = ed._find_affected_el( $restrict_els, group.element );
			if ( $restricted !== false ) return;
			// Safe, now properly add selection
			_.each(selected, function (sel) {
				ed._add_selection(sel);
			});
		});

		return;
	},

	_remove_selection: function (el) {
		this.selection = _.reject(this.selection, function(sel){ return (sel == el); });
		$(el).find('.upfront-selected-border').remove();
		$(el).removeClass('upfront-ui-selected ui-selected');
	},

	remove_selections: function () {
		var ed = Upfront.Behaviors.LayoutEditor;
		$('.upfront-ui-selected').each(function(){
			ed._remove_selection(this);
		});
		ed._update_selection_outline();
		$('.upfront-module-group-group').remove();
	},

	create_undo: function () {
		this.layout.store_undo_state();
	},
	apply_history_change: function () {
		var regions = Upfront.Application.layout.get("regions"),
			region = regions ? regions.get_by_name('shadow') : false
		;
		if (regions && region) { regions.remove(region); region = false; }
		//Upfront.Application.layout_view.local_view = false;
		Upfront.Application.layout_view.render();
	},

	save_dialog: function (on_complete, context) {
		$("body").append("<div id='upfront-save-dialog-background' />");
		$("body").append("<div id='upfront-save-dialog' />");
		var $dialog = $("#upfront-save-dialog"),
			$bg = $("#upfront-save-dialog-background"),
			current = Upfront.Application.layout.get("current_layout"),
			html = ''
		;
		$bg
			.width($(window).width())
			.height($(document).height())
		;
		html += '<p>' + Upfront.Settings.l10n.global.behaviors.this_post_only + '</p>';
		$.each(_upfront_post_data.layout, function (idx, el) {
			//var checked = el == current ? "checked='checked'" : '';
			//html += '<input type="radio" name="upfront_save_as" id="' + el + '" value="' + el + '" ' + checked + ' />';
			//html += '&nbsp;<label for="' + el + '">' + Upfront.Settings.LayoutEditor.Specificity[idx] + '</label><br />';
			if ( idx == 'type' )
				return;
			html += '<span class="upfront-save-button" data-save-as="' + el + '">' + Upfront.Settings.LayoutEditor.Specificity[idx] + '</span>';
		});
		//html += '<button type="button" id="upfront-save_as">Save</button>';
		//html += '<button type="button" id="upfront-cancel_save">Cancel</button>';
		$dialog
			.html(html)
		;
		$("#upfront-save-dialog").on("click", ".upfront-save-button", function () {
			/*var $check = $dialog.find(":radio:checked"),
				selected = $check.length ? $check.val() : false
			;*/
			var selected = $(this).attr('data-save-as');
			$bg.remove(); $dialog.remove();
			on_complete.apply(context, [selected]);
			return false;
		});
		$("#upfront-save-dialog-background").on("click", function () {
			$bg.remove(); $dialog.remove();
			return false;
		});
	},

	/**
	 * We are loading theme by reloading page since lots of stuff needs
	 * to be setup like stylesheet etc. Only way to get this right is to
	 * load page from scratch.
	 */
	load_theme: function(theme_slug) {
		var url = location.origin;
		// Add anything before create_new
		url += location.pathname.split('create_new')[0];
		// Add create_new and theme slug
		url += 'create_new/' + theme_slug;
		// Check for dev=true
		if (location.toString().indexOf('dev=true') > -1) url += '?dev=true';

		window.location = url;
	},

	open_theme_fonts_manager: function() {
		var me = {};
		var textFontsManager = new Upfront.Views.Editor.Fonts.Text_Fonts_Manager({ collection: Upfront.Views.Editor.Fonts.theme_fonts_collection });
		textFontsManager.render();
		var iconFontsManager = new Upfront.Views.Editor.Fonts.Icon_Fonts_Manager({ collection: Upfront.Views.Editor.Fonts.icon_fonts_collection });
		iconFontsManager.render();

		var popup = Upfront.Popup.open(
			function (data, $top, $bottom) {
				var $me = $(this);
				$me.empty()
					.append('<p class="upfront-popup-placeholder">' + Upfront.Settings.l10n.global.behaviors.loading_content + '</p>');

				me.$popup = {
					"top": $top,
					"content": $me,
					"bottom": $bottom
				};
			},
			{
				width: 750
			},
			'font-manager-popup'
		);

		me.$popup.top.html(
			'<ul class="upfront-tabs">' +
				'<li id="theme-text-fonts-tab" class="active">' + Upfront.Settings.l10n.global.behaviors.theme_text_fonts + '</li>' +
				'<li id="theme-icon-fonts-tab">' + Upfront.Settings.l10n.global.behaviors.theme_icon_fonts + '</li>' +
			'</ul>' +
			me.$popup.top.html()
		);

		me.$popup.top.on('click', '#theme-text-fonts-tab', function(event) {
			me.$popup.content.html(textFontsManager.el);
			$('#theme-icon-fonts-tab').removeClass('active');
			$('#theme-text-fonts-tab').addClass('active');
			$('.theme-fonts-ok-button').css('margin-top', '30px');
		});

		me.$popup.top.on('click', '#theme-icon-fonts-tab', function() {
			me.$popup.content.html(iconFontsManager.el);
			$('#theme-text-fonts-tab').removeClass('active');
			$('#theme-icon-fonts-tab').addClass('active');
			$('.theme-fonts-ok-button').css('margin-top', 0);
		});

		me.$popup.bottom.append('<a class="theme-fonts-ok-button">' + Upfront.Settings.l10n.global.behaviors.ok + '</a>');
		me.$popup.content.html(textFontsManager.el);
		textFontsManager.set_ok_button(me.$popup.bottom.find('.theme-fonts-ok-button'));
		me.$popup.bottom.find('.theme-fonts-ok-button').on('click', function() {
			Upfront.Popup.close();
		});
	},

	/**
	 * DEPRECATED
	 */
	create_layout_dialog: function() {
		var app = Upfront.Application,
			ed = Upfront.Behaviors.LayoutEditor,
			fields = {
				layout: new Upfront.Views.Editor.Field.Select({
					name: 'layout',
					values: [{label: Upfront.Settings.l10n.global.behaviors.loading, value: ""}],
					change: function() {
						var value = this.get_value();

						if ( value === 'single-page' )
							fields.$_page_name_wrap.show();
						else
							fields.$_page_name_wrap.hide();
					}
				}),
				page_name: new Upfront.Views.Editor.Field.Text({
					name: 'page_name',
					label: Upfront.Settings.l10n.global.behaviors.page_layout_name,
				}),
				inherit: new Upfront.Views.Editor.Field.Radios({
					name: 'inherit',
					layout: "horizontal-inline",
					values: [
						{label: Upfront.Settings.l10n.global.behaviors.start_fresh, value: ''},
						{label: Upfront.Settings.l10n.global.behaviors.start_from_existing, value: 'existing'}
					]
				}),
				existing: new Upfront.Views.Editor.Field.Select({
					name: 'existing',
					values: []
				})
			};
		if ( !ed.available_layouts ) {
			Upfront.Util.post({
				action: 'upfront_list_available_layout'
			}).done(function(data) {
				ed.available_layouts = data.data;
				fields.layout.options.values = _.map(ed.available_layouts, function(layout, layout_id){
					return { label: layout.label, value: layout_id, disabled: layout.saved };
				});
				fields.layout.render();
				fields.layout.delegateEvents();
			});
		} else {
			fields.layout.options.values = _.map(ed.available_layouts, function(layout, layout_id){
				return {label: layout.label, value: layout_id, disabled: layout.saved};
			});
		}
		if (!ed.all_templates) {
			Upfront.Util.post({
				action: "upfront-wp-model",
				model_action: "get_post_extra",
				postId: "fake", // Stupid walkaround for model handler insanity
				allTemplates: true
			}).done(function (response) {
				if (!response.data || !response.data.allTemplates) return false;
				if (0 === response.data.allTemplates.length) {
					fields.inherit.$el.hide();
					fields.existing.$el.hide();
					return false;
				}
				ed.all_templates = response.data.allTemplates;
				fields.existing.options.values = [];
				_.each(response.data.allTemplates, function (tpl, title) {
					fields.existing.options.values.push({label: title, value: tpl});
				});
				fields.existing.render();
			});
		} else {
			fields.existing.options.values = _.map(ed.all_templates, function(tpl, title){
				return {label: title, value: tpl};
			});
		}

		if ( !ed.layout_modal ){
			ed.layout_modal = new Upfront.Views.Editor.Modal({to: $('body'), button: false, top: 120, width: 540});
			ed.layout_modal.render();
			$('body').append(ed.layout_modal.el);
		}

		ed.layout_modal.open(function($content, $modal){
			var $button = $('<div style="clear:both"><span class="uf-button">' + Upfront.Settings.l10n.global.behaviors.create + '</span></div>'),
				$select_wrap = $('<div class="upfront-modal-select-wrap" />');
				$page_name_wrap = $('<div class="upfront-modal-select-wrap" />')
			;
			fields.$_page_name_wrap = $page_name_wrap;
			_.each(fields, function(field) {
				if (!field.render) return true;
				field.render();
				field.delegateEvents();
			});
			$content.html(
				'<h1 class="upfront-modal-title">' + Upfront.Settings.l10n.global.behaviors.create_new_layout + '</h1>'
			);
			$select_wrap.append(fields.layout.el);
			$content.append($select_wrap);

			$page_name_wrap.hide();
			$page_name_wrap.append(fields.page_name.el);
			$page_name_wrap.append(fields.inherit.el);
			$page_name_wrap.append(fields.existing.el);
			$content.append($page_name_wrap);

			$content.append($button);
			$button.on('click', function(){
				ed.layout_modal.close(true);
			});
		}, ed)
		.done(function(){
			var layout = fields.layout.get_value(),
				layout_slug = app.layout.get('layout_slug'),
				data = _.extend({}, ed.available_layouts[layout]),
				specific_layout = fields.page_name.get_value();

			// Check if user is creating single page with specific name
			if (layout === 'single-page' && specific_layout) {
				layout = 'single-page-' + specific_layout.replace(/\s/g, '-').toLowerCase();
				data = {
					layout: {
						'type': 'single',
						'item': 'single-page',
						'specificity': layout
					}
				};
			}

			data.use_existing = layout.match(/^single-page/) && specific_layout && "existing" === fields.inherit.get_value()
				? fields.existing.get_value()
				: false
			;
/*
// Why were we using this?
// It was causing issues when trying to create a pre-existing layout: https://app.asana.com/0/11140166463836/36929734950095
			if ( data.latest_post )
				_upfront_post_data.post_id = data.latest_post;
*/
			app.create_layout(data.layout, {layout_slug: layout_slug, use_existing: data.use_existing}).done(function() {
				app.layout.set('current_layout', layout);
				// Immediately export layout to write initial state to file.
				ed._export_layout();
			});
		});
	},

	/**
	 * DEPRECATED
	 */
	browse_layout_dialog: function () {
		var app = Upfront.Application,
			ed = Upfront.Behaviors.LayoutEditor,
			fields = {
				layout: new Upfront.Views.Editor.Field.Select({
					name: 'layout',
					values: [{label: Upfront.Settings.l10n.global.behaviors.loading, value: ""}],
					default_value: app.layout.get('current_layout')
				})
			};

		if ( !ed.browse_modal ){
			ed.browse_modal = new Upfront.Views.Editor.Modal({to: $('body'), button: false, top: 120, width: 540});
			ed.browse_modal.render();
			$('body').append(ed.browse_modal.el);
		}
		ed._get_saved_layout().done(function(data){
			if ( !data || data.length == 0 ){
				fields.layout.options.values = [{label: Upfront.Settings.l10n.global.behaviors.no_saved_layout, value: ""}];
			}
			else {
				fields.layout.options.values = _.map(ed.saved_layouts, function(layout, layout_id){
					return {label: layout.label, value: layout_id};
				});
			}
			fields.layout.render();
			fields.layout.delegateEvents();
		});

		ed.browse_modal.open(function($content, $modal){
			var $button = $('<span class="uf-button">' + Upfront.Settings.l10n.global.behaviors.edit + '</span>'),
				$select_wrap = $('<div class="upfront-modal-select-wrap" />');
			_.each(fields, function(field){
				field.render();
				field.delegateEvents();
			});
			$content.html(
				'<h1 class="upfront-modal-title">' + Upfront.Settings.l10n.global.behaviors.edit_saved_layout + '</h1>'
			);
			$select_wrap.append(fields.layout.el);
			$content.append($select_wrap);
			$content.append($button);
			$button.on('click', function(){
				ed.browse_modal.close(true);
			});
		}, ed)
		.done(function(){
			var layout = fields.layout.get_value(),
				layout_slug = app.layout.get('layout_slug'),
				data = ed.saved_layouts[layout];
			if ( data.latest_post )
				_upfront_post_data.post_id = data.latest_post;
			app.layout.set('current_layout', layout);
			app.load_layout(data.layout, {layout_slug: layout_slug});
		});

	},

	is_exporter_start_page: function() {
		return Upfront.themeExporter.currentTheme === 'upfront';
	},

	export_dialog: function () {
		var app = Upfront.Application,
			ed = Upfront.Behaviors.LayoutEditor,
			fields,
			loading;

		loading = new Upfront.Views.Editor.Loading({
			loading: Upfront.Settings.l10n.global.behaviors.checking_layouts,
			done: Upfront.Settings.l10n.global.behaviors.layout_exported,
			fixed: true
		});

		if (ed.is_exporter_start_page()) {
			// Prepare export dialog
			fields = {
				theme: new Upfront.Views.Editor.Field.Select({
					name: 'theme',
					default_value: Upfront.themeExporter.currentTheme === 'upfront' ?
						'' : Upfront.themeExporter.currentTheme,
					label: Upfront.Settings.l10n.global.behaviors.select_theme,
					values: [{label: Upfront.Settings.l10n.global.behaviors.new_theme, value: ""}],
					change: function(){
						var value = this.get_value(),
							$fields = $([fields.name.el, fields.directory.el, fields.author.el, fields.author_uri.el]);
						if ( value != '' )
							$fields.hide();
						else
							$fields.show();
					}
				}),
				name: new Upfront.Views.Editor.Field.Text({
					name: 'name',
					label: Upfront.Settings.l10n.global.behaviors.theme_name,
				}),
				directory: new Upfront.Views.Editor.Field.Text({
					name: 'directory',
					label: Upfront.Settings.l10n.global.behaviors.directory,
				}),
				author: new Upfront.Views.Editor.Field.Text({
					name: 'author',
					label: Upfront.Settings.l10n.global.behaviors.author,
				}),
				author_uri: new Upfront.Views.Editor.Field.Text({
					name: 'author_uri',
					label: Upfront.Settings.l10n.global.behaviors.author_uri,
				}),
				activate: new Upfront.Views.Editor.Field.Checkboxes({
					name: 'activate',
					default_value: true,
					multiple: false,
					values: [{ label: Upfront.Settings.l10n.global.behaviors.activate_upon_creation, value: 1 }],
				}),
				with_images: new Upfront.Views.Editor.Field.Checkboxes({
					name: 'with_images',
					default_value: true,
					multiple: false,
					values: [{ label: Upfront.Settings.l10n.global.behaviors.export_theme_images, value: 1 }],
				})
			};

			if ( !ed.export_modal ){
				ed.export_modal = new Upfront.Views.Editor.Modal({to: $('body'), button: false, top: 120, width: 540});
				ed.export_modal.render();
				$('body').append(ed.export_modal.el);
			}

			ed._get_themes().done(function(data){
				fields.theme.options.values = _.union( [{label: Upfront.Settings.l10n.global.behaviors.new_theme, value: ""}], _.map(data, function(theme, directory){
					return {label: theme.name, value: theme.directory};
				}) );
				fields.theme.render();
				fields.theme.delegateEvents();
				fields.theme.$el.find('input').trigger('change'); // to collapse other fields if theme is set
			});

			ed.export_modal.open(function($content, $modal) {
				var $button = $('<span class="uf-button">' + Upfront.Settings.l10n.global.behaviors.export_button + '</span>');
				_.each(fields, function(field){
					field.render();
					field.delegateEvents();
				});
				$content.html(
					'<h1 class="upfront-modal-title">' + Upfront.Settings.l10n.global.behaviors.export_theme + '</h1>'
				);
				$content.append(fields.theme.el);
				$content.append(fields.name.el);
				$content.append(fields.directory.el);
				$content.append(fields.author.el);
				$content.append(fields.author_uri.el);
				$content.append(fields.activate.el);
				$content.append(fields.with_images.el);
				$content.append($button);
				$button.on('click', function() {
					var theme_name, create_theme, export_layout, export_layouts, do_export;
					theme_name = fields.theme.get_value() ? fields.theme.get_value() : fields.directory.get_value();
					create_theme = function(){
						var data = {
							'thx-theme-name': fields.name.get_value(),
							'thx-theme-slug': fields.directory.get_value(),
							'thx-author': fields.author.get_value(),
							'thx-author-uri': fields.author_uri.get_value(),
							'thx-theme-template': 'upfront',
							'thx-activate_theme': fields.activate.get_value() || '',
							'thx-export_with_images': fields.with_images.get_value() || '',
							add_global_regions: Upfront.Application.current_subapplication.layout.get('layout_slug') !== 'blank'
						};
						loading.update_loading_text(Upfront.Settings.l10n.global.behaviors.creating_theme);
						return ed._create_theme(data);
					};
					loading.render();
					$('body').append(loading.el);
					create_theme().done(function() {
						ed.export_single_layout(loading, theme_name).done(function() {
							ed.load_theme(theme_name);
						});
					});
				});
			}, ed);
		} else {
			// Just export layout
			loading.render();
			$('body').append(loading.el);
			ed.export_single_layout(loading, Upfront.themeExporter.currentTheme);
		}
	},

	export_single_layout: function(loading, theme_name) {
		var self = this,
            app = Upfront.Application,
			ed = Upfront.Behaviors.LayoutEditor;

		var layout_id = _upfront_post_data.layout.specificity || _upfront_post_data.layout.item || _upfront_post_data.layout.type; // Also make sure to include specificity first
		loading.update_loading_text(Upfront.Settings.l10n.global.behaviors.exporting_layout + layout_id);

		return ed._export_layout({ theme: theme_name }).done(function() {
			loading.done(function() {
				if (ed.export_modal) ed.export_modal.close(true);
				ed.clean_region_css();
			});
		});

	},

	// This function can probably be deleted.
	first_save_dialog: function (success) {
		var app = Upfront.Application,
			ed = Upfront.Behaviors.LayoutEditor,
			current_layout = app.layout.get('current_layout');
		if ( success && (!current_layout || current_layout == 'archive-home') ){
			ed.message_dialog(Upfront.Settings.l10n.global.behaviors.excellent_start, Upfront.Settings.l10n.global.behaviors.homepage_created);
		}
	},

	message_dialog: function (title, msg) {
		var app = Upfront.Application,
			ed = Upfront.Behaviors.LayoutEditor;
		if ( !ed.message_modal ){
			ed.message_modal = new Upfront.Views.Editor.Modal({to: $('body'), button: true, top: 120, width: 540});
			ed.message_modal.render();
			$('body').append(ed.message_modal.el);
		}
		ed.message_modal.open(function($content, $modal){
			$modal.addClass('upfront-message-modal');
			$content.html(
				'<h1 class="upfront-modal-title">' + title + '</h1>'
			);
			$content.append(msg);
		}, ed);
	},

	/**
	 * DEPRECATED
	 */
	_get_saved_layout: function (){
		var me = this,
			deferred = new $.Deferred();
		Upfront.Util.post({
			action: 'upfront_list_theme_layouts'
		}).success(function(response){
			me.saved_layouts = response.data;
			deferred.resolve(response.data);
		}).error(function(){
			deferred.reject();
		});
		return deferred.promise();
	},

	_get_themes: function () {
		var me = this,
			deferred = new $.Deferred();
		Upfront.Util.post({
			action: 'upfront_thx-get-themes'
		}).success(function(response){
			me.themes = response;
			deferred.resolve(response);
		}).error(function(){
			deferred.reject();
		});
		return deferred.promise();
	},

	_create_theme: function (data) {
		var deferred = new $.Deferred();
		Upfront.Util.post({
			action: 'upfront_thx-create-theme',
			form: this._build_query(data)
		}).success(function(response){
			if ( response && response.error )
				deferred.reject(response.error);
			else
				deferred.resolve();
		}).error(function(){
			deferred.reject();
		});
		return deferred.promise();
	},

	export_element_styles: function(data) {
		Upfront.Util.post({
			action: 'upfront_thx-export-element-styles',
			data: data
		}).success(function(response){
			if ( response && response.error ) {
				Upfront.Views.Editor.notify(response.error);
				return;
			}
			if(!Upfront.data.styles[data.elementType])
				Upfront.data.styles[data.elementType] = [];
			if(Upfront.data.styles[data.elementType].indexOf(data.stylename) === -1)
				Upfront.data.styles[data.elementType].push(data.stylename);

			Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.behaviors.style_exported);
		}).error(function(){
			Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.behaviors.style_export_fail);
		});
	},

	_export_layout: function (custom_data) {
		var typography,
			properties,
			layout_style,
			deferred,
			data = {};

		typography = _.findWhere(
			Upfront.Application.current_subapplication.get_layout_data().properties,
			{ 'name': 'typography' }
		);

		layout_style = _.findWhere(
			Upfront.Application.current_subapplication.get_layout_data().properties,
			{ 'name': 'layout_style' }
		);


		properties = _.extend({}, Upfront.Util.model_to_json(Upfront.Application.current_subapplication.get_layout_data().properties));
		properties = _.reject(properties, function(property) {
			return _.contains(['typography', 'layout_style', 'global_regions'], property.name);
		});

		data = {
			typography: (typography ? JSON.stringify(typography.value) : ''),
			regions: JSON.stringify(Upfront.Application.current_subapplication.get_layout_data().regions),
			template: _upfront_post_data.layout.specificity || _upfront_post_data.layout.item || _upfront_post_data.layout.type, // Respect proper cascade ordering
			layout_properties: JSON.stringify(properties),
			theme: Upfront.themeExporter.currentTheme,
			layout_style: layout_style ? layout_style.value : '',
			theme_colors: {
				colors: Upfront.Views.Theme_Colors.colors.toJSON(),
				range: Upfront.Views.Theme_Colors.range
			},
			/*
			 * Commented, because presets are updated in settings.php on create/edit
			 * button_presets: Upfront.Views.Editor.Button.Presets.toJSON(),
			 */
			post_image_variants: Upfront.Content.ImageVariants.toJSON()
		};

		if (Upfront.themeExporter.layoutStyleDirty) {
			data.layout_style = $('#layout-style').html();
			Upfront.themeExporter.layoutStyleDirty = false;
		}

		if (custom_data) data = _.extend(data, custom_data);

		deferred = new $.Deferred();
		Upfront.Util.post({
			action: 'upfront_thx-export-layout',
			data: data
		}).success(function(response){
			if ( response && response.error )
				deferred.reject(response.error);
			else
				deferred.resolve();
		}).error(function(){
			deferred.reject();
		});
		return deferred.promise();
	},

	/* Cleanup region CSS, running on save/export */
	clean_region_css: function () {
		var me = this,
			cssEditor = Upfront.Application.cssEditor,
            ed = Upfront.Behaviors.LayoutEditor,
			elementTypes = [cssEditor.elementTypes.RegionContainer, cssEditor.elementTypes.Region],
			layout = _upfront_post_data.layout,
			layout_id = layout.specificity || layout.item || layout.type,
			regions = Upfront.Application.layout.get('regions'),
			styleExists = [],
			deleteDatas = [],
			deleteFunc = function (index) {
				if ( ! deleteDatas[index] ) {
					Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.behaviors.region_css_cleaned);
					deferred.resolve();
					return;
				}
				var elementType = deleteDatas[index].elementType,
					styleName = deleteDatas[index].styleName;
				if ( Upfront.Application.get_current() === Upfront.Settings.Application.MODE.THEME ) {
					data = {
						action: 'upfront_thx-delete-element-styles',
						data: {
							stylename: styleName,
							elementType: elementType
						}
					};
				}
				else {
					data = {
						action: 'upfront_delete_styles',
						styleName: styleName,
						elementType: elementType
					}
				}
				Upfront.Util.post(data)
					.done(function(){
						var styleIndex = Upfront.data.styles[elementType].indexOf(styleName);

						//Remove the styles from the available styles
						if(styleIndex != -1)
							Upfront.data.styles[elementType].splice(styleIndex, 1);

						//Remove the styles from the dom
						$('#upfront-style-' + styleName).remove();

						//Continue deleting
						deleteFunc(index+1);
					});
				;
			},
			deferred = new $.Deferred()
		;

		regions.each(function(region){
			var elementType = region.is_main() ? cssEditor.elementTypes.RegionContainer.id : cssEditor.elementTypes.Region.id,
				styleName = layout_id + '-' + region.get('name') + '-style',
				isGlobal = ( region.get('scope') == 'global' );
			if ( _.isArray(Upfront.data.styles[elementType]) && Upfront.data.styles[elementType].indexOf(styleName) != -1 )
				styleExists.push(styleName);
			// global stylename
			styleName = elementType + '-' + region.get('name') + '-style';
			if ( _.isArray(Upfront.data.styles[elementType]) && Upfront.data.styles[elementType].indexOf(styleName) != -1 )
				styleExists.push(styleName);
		});

        ed._get_saved_layout().done(function(saved){
			_.each(elementTypes, function(elementType){
				_.each(Upfront.data.styles[elementType.id], function(styleName){
					var onOtherLayout = false;
					_.each(saved, function(obj, id){
						if ( id == layout_id )
							return;
						var is_parent_layout = ( layout_id.match(new RegExp('^' + id + '-')) );
						if ( styleName.match(new RegExp('^' + id)) && ( !is_parent_layout || ( is_parent_layout && !styleName.match(new RegExp('^' + layout_id)) ) ) )
							onOtherLayout = true;
					});
					if ( ! _.contains(styleExists, styleName) && styleName.match(new RegExp('^' + layout_id)) && !onOtherLayout )
						deleteDatas.push({
							elementType: elementType.id,
							styleName: styleName
						});
				});
			});
			if ( deleteDatas.length > 0 ) {
				Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.behaviors.cleaning_region_css)
				deleteFunc(0); // Start deleting
			}
		});

		return deferred.promise();
	},

	_build_query: function (data) {
		return _.map(data, function(value, key){ return key + '=' + value; }).join('&');
	},
	
	clean_global_regions: function () {
		Upfront.data.global_regions = false;
	},
	
	open_global_region_manager: function () {
		var ed = Upfront.Behaviors.LayoutEditor;
		Upfront.Popup.open(
			function (data, $top, $bottom) {
				var $me = $(this);
				$me.html('<p class="upfront-popup-placeholder">' + Upfront.Settings.l10n.global.behaviors.loading_content + '</p>');
				
				if ( !Upfront.data.global_regions ){
					ed._refresh_global_regions().done(function(){
						ed._render_global_region_manager($me);
					})
				}
				else {
					ed._render_global_region_manager($me);
				}
			},
			{
				width: 600
			},
			'global-region-manager'
		);
	},
	
	_refresh_global_regions: function () {
		return Upfront.Util.post({
			action: 'upfront_list_scoped_regions',
			scope: 'global',
			storage_key: _upfront_save_storage_key
		}).done(function(data) {
			Upfront.data.global_regions = data.data;
		});
	},
	
	_render_global_region_manager: function ($el) {
		var ed = Upfront.Behaviors.LayoutEditor,
			collection = Upfront.Application.layout.get("regions"),
			region_managers = [
				{
					title: Upfront.Settings.l10n.global.behaviors.global_regions,
					classname: 'global',
					data: _.sortBy(Upfront.data.global_regions, function(region, i, regions){
						if ( !region.container || region.name == region.container )
							return i * 3;
						else
							return _.indexOf(regions, _.findWhere(regions, {name: region.container})) * 3 + 1;
					})
				},
				{
					title: Upfront.Settings.l10n.global.behaviors.lightboxes,
					classname: 'lightbox',
					data: Upfront.Util.model_to_json( collection.filter(function(model){
						return model.get('sub') == 'lightbox';
					}) )
				}
			];
		$el.html('');
		_.each(region_managers, function(manager){
			var $wrap = $('<div class="global-region-manager-wrap global-region-manager-' + manager.classname + '"></div>'),
				$title = $('<h3 class="global-region-manager-title">'+ manager.title +'</h3>'),
				$content = $('<div class="global-region-manager-content upfront-scroll-panel"></div>');
			$wrap.append([$title, $content]);
			ed._render_regions(manager.data, $content);
			$el.append($wrap);
			// don't propagate scroll
			Upfront.Views.Mixins.Upfront_Scroll_Mixin.stop_scroll_propagation($content);
		});
		$el.on('click', '.region-list-edit', function(e){
			e.preventDefault();
		});
		$el.on('click', '.region-list-trash', function(e){
			e.preventDefault();
			var name = $(this).attr('data-name');
			if ( $(this).closest('.global-region-manager-wrap').hasClass('global-region-manager-global') ){
				if ( confirm('Deleting the global regions will remove it from all layouts. Continue?') ) {
					Upfront.Util.post({
						action: 'upfront_delete_scoped_regions',
						scope: 'global',
						name: name,
						storage_key: _upfront_save_storage_key
					}).done(function(data) {
						// Also remove from current layout
						if ( data.data ) {
							_.each(data.data, function(region_name){
								var model = collection.get_by_name(region_name);
								collection.remove(model);
							})
							ed._refresh_global_regions().done(function(){
								ed._render_global_region_manager($el);
							})
						}
					});
				}
			}
			else {
				// lightbox
			}
		})
	},
	
	_render_regions: function (regions, $el) {
		var $lists = $('<ul class="global-region-manager-lists"></ul>');
		_.each(regions, function(region){
			var classes = ['global-region-manager-list'],
				has_main = false;
			if ( !region.container || region.name == region.container ){
				classes.push('region-list-main');
			}
			else {
				has_main = _.find(regions, function(reg){ return reg.name == region.container; });
				classes.push('region-list-sub');
				classes.push('region-list-sub-' + region.sub);
				if ( has_main )
					classes.push('region-list-sub-has-main');
			}
			$lists.append(
				'<li class="' + classes.join(' ') + '">' +
					'<span class="region-list-name">' + region.title + '</span>' +
					'<span class="region-list-control">' +
						//'<a href="#" class="region-list-edit" data-name="' + region.name + '">' + Upfront.Settings.l10n.global.behaviors.edit + '</a>' + 
						( Upfront.Application.get_current() != Upfront.Settings.Application.MODE.THEME ? '<a href="#" class="region-list-trash" data-name="' + region.name + '">' + Upfront.Settings.l10n.global.behaviors.trash + '</a>' : '' ) + 
					'</span>' +
				'</li>'
			);
		});
		$el.append($lists);
	}
};

define('scripts/upfront/behaviors/layout-editor',LayoutEditor);
	
})(jQuery);
//@ sourceURL=layout-editor.js
;
(function ($) {

define('scripts/upfront/behaviors/dragdrop',[],function(){
	
var DragDrop = function (view, model) {
	this.initialize(view, model);
}

DragDrop.prototype = {
	module_selector: '> .upfront-module-view > .upfront-module, > .upfront-module-group',
	
	view: false,
	model: false,
	$me: false,
	$wrap: false,
	$region: false,
	$main: false,
	$layout: false,
	me: false,
	wrap: false,
	region: false,
	current_region: false,
	$container: false,
	$current_container: false,
	
	region_model: false,
	current_region_model: false,
	current_wrappers: false,
	
	is_group: false,
	is_parent_group: false,
	is_disabled: false,
	
	$helper: false,
	event: false,
	ui: false,
	breakpoint: false,
	app: false,
	ed: false,

	drop_areas: false,
	drop_areas_created: false,
	drops: false,
	drop: false,
	drop_col: 0,
	drop_left: 0,
	drop_top: 0,
	area_col: 0,
	current_area_col: 0,
	current_row_wraps: false,
	wrapper_id: false,
	wrap_only: false,
	new_wrap_view: false,
	move_region: false,

	current_grid: false,
	current_grid_pos: false,
	compare_area: false,
	compare_area_position: false,
	compare_col: 0,
	compare_row: 0,
	_last_drag_position: false,
	_last_drag_time: 0,
	_last_coord: false,
	_t: false,
	_focus_t: false,
	
	focus: false,
	focus_coord: false,
	
	initialize: function (view, model) {
		this.view = view;
		this.model = model;
		this.app = Upfront.Application;
		this.ed = Upfront.Behaviors.GridEditor;

		// Default property setup
		this.drop_areas = [];
		this.drop_areas_created = [];
		this.drops = [];
		this.current_row_wraps = [];
		this.current_grid = {};
		this.current_grid_pos = {};
		this.compare_area = {};
		this.compare_area_position =  {};
		this._last_coord = {x: 0, y: 0};
		this.focus_coord = {x: 0, y: 0};

		this.setup();
	},
	
	setup: function () {
		this.is_group = this.view.$el.hasClass('upfront-module-group');
		this.is_parent_group = ( typeof this.view.group_view != 'undefined' );
		this.is_disabled = ( this.is_parent_group && !this.view.group_view.$el.hasClass('upfront-module-group-on-edit') );
		this.$me = this.is_group ? this.view.$el : this.view.$el.find('.upfront-editable_entity:first');
		this.$main = $(Upfront.Settings.LayoutEditor.Selectors.main);
		this.$layout = this.$main.find('.upfront-layout');

		if ( this.app.mode.current !== this.app.MODE.THEME && this.model.get_property_value_by_name('disable_drag') ) {
			return false;
		}
		if ( this.$me.data('ui-draggable') ){
			if ( this.is_group || !this.is_disabled ) {
				this.$me.draggable('option', 'disabled', false);
			}
			return false;
		}
		
		this.$me.draggable({
			revert: true,
			revertDuration: 0,
			zIndex: 100,
			helper: 'clone',
			disabled: this.is_disabled,
			cancel: '.upfront-entity_meta, .upfront-element-controls',
			distance: 10,
			appendTo: this.$main,
			iframeFix: true,
			start: $.proxy(this.on_start, this),
			drag: $.proxy(this.on_drag, this),
			stop: $.proxy(this.on_stop, this)
		});
	},
	
	on_start: function (e, ui) {
		this.ed.time_start('drag start');
		this.event = e;
		this.ui = ui;
		this.breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint;
		this.is_parent_group = ( typeof this.view.group_view != 'undefined' );
		
		this.prepare_drag();

		this.ed.time_end('drag start');
		this.ed.time_start('drag start - trigger');
		Upfront.Events.trigger("entity:drag_start", this.view, this.model);
		this.ed.time_end('drag start');
	},
	
	on_drag: function (e, ui) {
		var that = this;
		this.event = e;
		this.ui = ui;
		
		//this.ed.time_start('dragging');

		// change drop point on timeout
		clearTimeout(this._t);
		this._t = setTimeout(function(){ that.update_drop_timeout(); }, this.ed.timeout);

		this.update_drop_position();

		if ( this.ed.show_debug_element ){
			this.$helper.find(".upfront-debug-info").text(
				'grid: '+this.current_grid.x+','+this.current_grid.y+' | ' +
				'current: ('+this.current_grid_pos.left+','+this.current_grid_pos.top+'),('+this.current_grid_pos.right+','+this.current_grid_pos.bottom+') | ' + 
				'margin size: '+this.drop_top+'/'+this.drop_left
			);
		}
		//this.ed.time_end('dragging');
	},
	
	on_stop: function (e, ui) {
		var that = this;
		this.ed.time_start('drag stop');
		this.event = e;
		this.ui = ui;
		
		clearTimeout(this._t);
		clearTimeout(this._focus_t);
		
		if ( !this.drop.is_me ) {
			this.render_drop();
		}
		this.clean_elements();
		this.update_models();
		this.update_views();
		this.reset();
		
		// Add drop animation
		var $me = this.is_group ? this.view.$el : this.view.$el.find('.upfront-editable_entity:first');
		var ani_event_end = 'animationend.drop_ani webkitAnimationEnd.drop_ani MSAnimationEnd.drop_ani oAnimationEnd.drop_ani';
		$me.one(ani_event_end, function(){
			$(this).removeClass('upfront-dropped');
			Upfront.Events.trigger("entity:drag_animate_stop", that.view, that.model);
			$me.off(ani_event_end); // Make sure to remove any remaining unfired event
		}).addClass('upfront-dropped');
		
		
		Upfront.Events.trigger("entity:drag_stop", this.view, this.model);
		this.view.trigger("entity:drop", {
			col: this.drop_col, 
			left: this.drop_left, 
			top: this.drop_top
		}, this.view, this.model);
		this.view.trigger("entity:self:drag_stop");
		
		this.ed.time_end('drag stop');
	},
	
	update_vars: function () {
		var regions = this.app.layout.get("regions");
		this.$helper = $('.ui-draggable-dragging');
		this.$wrap = this.$me.closest('.upfront-wrapper');
		this.$region = this.$me.closest('.upfront-region');
		this.me = this.ed.get_el(this.$me);
		this.wrap = this.ed.get_wrap(this.$wrap);
		this.region = this.ed.get_region(this.$region);
		this.region_model = regions.get_by_name(this.region.region);
		this.$container = this.$region.find('.upfront-modules_container > .upfront-editable_entities_container:first');
	},
	
	/**
	 * Create droppable points
	 */
	create_drop_point: function () {
		var ed = this.ed;
		ed.time_start('fn create_drop_point');
		
		var breakpoint = this.breakpoint,
			that = this,
			me = this.me,
			me_wrap = this.wrap,
			margin = me.$el.data('margin'),
			col = me.col,
			min_col = me.$el.hasClass('upfront-image_module') ? 1 : (col > ed.min_col ? ed.min_col : col),
			row = me.row > ed.max_row ? ed.max_row : me.row,
			is_spacer = me.$el.hasClass('upfront-module-spacer')
		;

		var $sibling_els = Upfront.Util.find_sorted(me.$el.closest('.upfront-wrapper')),
			has_siblings = $sibling_els.length > 1,
			sibling_index = $sibling_els.index(me.$el);

		_.each(this.drop_areas, function(area, area_index){
			if ( _.contains(me.drop_areas_created, area) ) return; // Don't run this over created area
			var is_region = area.$el.hasClass('upfront-region'),
				is_in_region = is_region ? ( area.$el.get(0) == that.current_region.$el.get(0) ) : false
			;
			if ( is_region && !is_in_region ) return; // Just create drop point for current region
			var $area = area.$el.find(".upfront-editable_entities_container:first"),
				$region = is_region ? area.$el : area.$el.closest('.upfront-region'),
				region_name = $region.data('name'),
				region = is_region ? area : ed.get_region($region);
				$wraps = Upfront.Util.find_sorted($area, '> .upfront-wrapper:visible').filter(function(){
					return ( $(this).height() > 0 )
				}),
				expand_lock = $region.hasClass('upfront-region-expand-lock'),
				current_full_top = area.grid.top,
				can_drop = function (top, bottom) {
					return ( !expand_lock || ( expand_lock && bottom-top+1 >= me.row ) );
				},
				first_cb = function ($w, $ws) {
					var w = ed.get_wrap($w);
					return ( w.outer_grid.left == area.grid.left );
				}
			;

			$wraps.each(function(index){
				var $wrap = $(this),
					wrap = ed.get_wrap($wrap),
					is_wrap_spacer = ( $wrap.find('> .upfront-module-view > .upfront-module-spacer').length > 0 ),
					wrap_clr = ( wrap.grid.left == area.grid.left ),
					is_wrap_me = ( me_wrap && wrap._id == me_wrap._id ),
					wrap_only = ( $wrap.find(that.module_selector).size() == 1 ),
					wrap_me_only = ( is_wrap_me && wrap_only ),
					$prev_wrap = $wraps[index-1] ? $wraps.eq(index-1) : false,
					prev_wrap = $prev_wrap ? ed.get_wrap($prev_wrap) : false,
					prev_wrap_clr = ( prev_wrap && prev_wrap.grid.left == area.grid.left ),
					is_prev_me = ( prev_wrap && me_wrap && prev_wrap._id == me_wrap._id ),
					is_prev_wrap_spacer = $prev_wrap ? ( $prev_wrap.find('> .upfront-module-view > .upfront-module-spacer').length > 0 ) : false,
					prev_me_only = ( is_prev_me && $prev_wrap.find(that.module_selector).size() == 1 ),
					$next_wrap = $wraps[index+1] ? $wraps.eq(index+1) : false,
					next_wrap = $next_wrap ? ed.get_wrap($next_wrap) : false,
					next_wrap_clr = ( next_wrap && next_wrap.grid.left == area.grid.left ),
					is_next_me = ( next_wrap && me_wrap && next_wrap._id == me_wrap._id ),
					is_next_wrap_spacer = $next_wrap ? ( $next_wrap.find('> .upfront-module-view > .upfront-module-spacer').length > 0 ) : false,
					next_me_only = ( is_next_me && $next_wrap.find(that.module_selector).size() == 1 ),
					$next_clr = Upfront.Util.find_from_elements($wraps, $wrap, first_cb, false),
					next_clr = $next_clr.size() > 0 ? ed.get_wrap($next_clr) : false,
					wrap_el_left = ed.get_wrap_el_min(wrap),
					wrap_el_top = ed.get_wrap_el_min(wrap, false, true),
					prev_wrap_el_left = prev_wrap ? ed.get_wrap_el_min(prev_wrap) : false,
					next_wrap_el_top = next_wrap ? ed.get_wrap_el_min(next_wrap, false, true) : false,
					next_wrap_el_left = next_wrap ? ed.get_wrap_el_min(next_wrap) : false,
					next_clr_el_top = next_clr ? ed.get_wrap_el_min(next_clr, false, true) : false,
					$row_wrap_first = !wrap_clr ? Upfront.Util.find_from_elements($wraps, $wrap, first_cb, true) : $wrap,
					$row_wraps_next = Upfront.Util.find_from_elements($wraps, $row_wrap_first, '.upfront-wrapper', false, first_cb),
					row_wraps = _.union( [ ed.get_wrap($row_wrap_first) ], $row_wraps_next.map(function(){ return ed.get_wrap($(this)); }).get() ),
					max_row_wrap = _.max(row_wraps, function(row_wrap){ return ( me_wrap && me_wrap._id == row_wrap._id ) ? -1 : row_wrap.grid.bottom; }),
					min_row_wrap = _.min(row_wraps, function(row_wrap){ return ed.get_wrap_el_min(row_wrap, false, true).grid.top; }),
					min_row_el = ed.get_wrap_el_min(min_row_wrap, false, true),
					wrap_me_in_row = _.find(row_wraps, function(row_wrap){ return me_wrap && me_wrap._id == row_wrap._id })
				;
				if ( wrap_me_in_row && that.current_row_wraps === false ) {
					that.current_row_wraps = row_wraps;
				}
				
				if (
					!is_spacer
					&&
					!is_wrap_spacer
					&&
					(
						( 
							( !breakpoint || breakpoint.default ) && wrap.col >= min_col && 
							(
								( next_wrap && !next_wrap_clr && !wrap_me_only && ( $next_wrap.find(that.module_selector).size() > 1 || !is_next_me ) ) ||
								( prev_wrap && !wrap_clr && !wrap_me_only && ( $prev_wrap.find(that.module_selector).size() > 1 || !is_prev_me ) ) ||
								( next_wrap && prev_wrap && !next_wrap_clr && !wrap_clr ) ||
								( !prev_wrap && !next_wrap && is_wrap_me && $wrap.find(that.module_selector).size() > 1 )
							)
						)
						||
						( breakpoint && !breakpoint.default && is_wrap_me && $wrap.find(that.module_selector).size() > 1 )
					)
				){
					var current_el_top = wrap.grid.top,
						wrap_right = ( next_wrap && !next_wrap_clr && next_wrap_el_left ) ? next_wrap_el_left.grid.left-1 : area.grid.right;
					$els = Upfront.Util.find_sorted($wrap, that.module_selector);
					$els.each(function(i){
						if ( $(this).get(0) == me.$el.get(0) ) return;
						var $el = $(this),
							el = ed.get_el($el),
							top = ( el.outer_grid.top == wrap.grid.top ) ? wrap.grid.top : current_el_top,
							bottom = Math.ceil(el.grid_center.y),
							$prev = $els[i-1] ? $els.eq(i-1) : false,
							prev = $prev ? ed.get_el($prev) : false,
							prev_me = ( prev && prev._id == me._id );
						that.drops.push({
							_id: ed._new_id(),
							top: top,
							bottom: bottom,
							left: wrap.grid.left,
							right: wrap_right,
							priority: {
								top: ( prev_me ? prev.outer_grid.top : el.outer_grid.top-1 ),
								bottom: el.grid.top-1,
								left: wrap.grid.left,
								right: wrap_right,
								index: ( prev_me ? 3 : 5 )
							},
							priority_index: 5,
							type: 'inside',
							insert: ['before', $el],
							region: region,
							is_me: prev_me,
							is_clear: false,
							is_use: false,
							is_switch: false,
							switch_dir: false,
							row_wraps: false,
							me_in_row: false
						});
						current_el_top = bottom+1;
					});
					var $last = $els.last(),
						last = $last.size() > 0 ? ed.get_el($last) : false,
						last_me = ( last && last._id == me._id ),
						wrap_bottom = ( breakpoint && !breakpoint.default && next_clr_el_top ) ? Math.ceil(next_clr_el_top.grid_center.y) : max_row_wrap.grid.bottom;
					// Don't add dropping below the most bottom wrap in a row
					//if ( last_me || !max_row_wrap || max_row_wrap != wrap || ( breakpoint && !breakpoint.default ) ){
						that.drops.push({
							_id: ed._new_id(),
							top: current_el_top,
							bottom: wrap_bottom,
							left: wrap.grid.left,
							right: wrap_right,
							priority: {
								top: ( last_me ? last.outer_grid.top : wrap.grid.bottom ),
								bottom: ( breakpoint && !breakpoint.default && next_clr_el_top ) ? next_clr_el_top.grid.top : wrap_bottom,
								left: wrap.grid.left,
								right: wrap_right,
								index: ( last_me ? 3 : 5 )
							},
							priority_index: 5,
							type: 'inside',
							insert: ['append', wrap.$el],
							region: region,
							is_me: last_me,
							is_clear: false,
							is_use: false,
							is_switch: false,
							switch_dir: false,
							row_wraps: false,
							me_in_row: false
						});
					//}
				}
				// Don't add another droppable if this is not the first el from wrapper, only on responsive
				if ( breakpoint && !breakpoint.default && has_siblings && sibling_index > 0 )
					return;
				// Add droppable before each wrapper that start in new line
				if ( !is_spacer && wrap_clr && !( is_wrap_me && ( !next_wrap || next_wrap_clr ) ) ){
					var top = ( wrap.grid.top == area.grid.top ) ? area.grid.top - 5 : current_full_top,
						el_top = ed.get_wrap_el_min(wrap, false, true),
						bottom = Math.ceil(el_top.grid_center.y),
						is_drop_me = ( prev_wrap_clr && is_prev_me && !has_siblings ),
						me_top = ( is_drop_me ? prev_wrap.grid.top : wrap.grid.top );
					if ( can_drop(me_top, el_top.grid.top-1) ){
						that.drops.push({
							_id: ed._new_id(),
							top: top,
							bottom: bottom,
							left: area.grid.left,
							right: area.grid.right,
							priority: {
								top: me_top,
								bottom: min_row_el.grid.top-1,
								left: area.grid.left,
								right: area.grid.right,
								index: ( is_drop_me ? 2 : 3 )
							},
							priority_index: 8,
							type: 'full',
							insert: ['before', wrap.$el],
							region: region,
							is_me: is_drop_me,
							is_clear: true,
							is_use: false,
							is_switch: false,
							switch_dir: false,
							row_wraps: false,
							me_in_row: false
						});
						current_full_top = bottom+1;
					}
				}
				// Check to see if the right side on wrapper has enough column to add droppable
				if ( 
					( // Check if it's spacer, if it is, only allow drop if between 2 non-spacer elements
						!is_spacer
						||
						(
							( is_spacer && wrap_me_in_row )
							&&
							(
								wrap_me_only
								||
								( !is_wrap_spacer && ( !next_wrap || next_wrap_clr || !is_next_wrap_spacer ) )
							)
						)
					)
					&&
					( !next_wrap || next_wrap_clr )
					&&
					( !wrap_me_only || !wrap_clr )
					/*&&
					( 
						( !is_wrap_me && area.grid.right-wrap.grid.right >= min_col ) 
						|| 
						( wrap_me_only && !wrap_clr ) 
						|| 
						( prev_me_only && !wrap_clr && wrap_only ) 
					)*/
				){ // @TODO Experiment: always allow right side drop
					var is_switch = false,
						left = Math.ceil(wrap.grid_center.x)+1,
						right = ( !next_wrap || next_wrap_clr ) ? area.grid.right : wrap.grid.right,
						bottom = ( is_wrap_me && wrap.grid.bottom > max_row_wrap.grid.bottom ? wrap.grid.bottom : max_row_wrap.grid.bottom );
					if ( can_drop(wrap.grid.top, bottom) ){
						that.drops.push({
							_id: ed._new_id(),
							top:  wrap.grid.top,
							bottom: bottom,
							left: ( wrap_me_only ? wrap.grid.left : left ),
							right: right,
							priority: {
								top: wrap.grid.top,
								bottom: bottom,
								left: ( wrap_me_only ? wrap.grid.left : left+Math.ceil((right-left)/2) ),
								right: right,
								index: ( wrap_me_only ? 1 : 4 )
							},
							priority_index: 10,
							type: 'side-after',
							insert: ['after', wrap.$el],
							region: region,
							is_me: wrap_me_only,
							is_clear: false,
							is_use: false,
							is_switch: is_switch,
							switch_dir: is_switch ? 'left' : false,
							row_wraps: row_wraps,
							me_in_row: ( wrap_me_in_row ? true : false )
						});
					}
				}
				// Now check the left side, finding spaces between wrapper and inner modules
				if ( 
					( // Check if it's spacer, if it is, only allow drop if between 2 non-spacer elements
						!is_spacer
						||
						(
							( is_spacer && wrap_me_in_row )
							&&
							(
								wrap_me_only
								||
								( !is_wrap_spacer && ( wrap_clr || !is_prev_wrap_spacer ) )
							)
						)
					)
					&&
					( !wrap_me_only || ( next_wrap && !next_wrap_clr ) )
					&&
					( wrap_clr || !prev_me_only )
					/*&&
					(
						( 
							//wrap_el_left.grid.left-wrap.grid.left >= min_col 
							//&&
							(!is_prev_me || wrap_clr) 
							&& 
							!is_wrap_me 
						) 
						|| 
						( is_wrap_me && next_wrap && !next_wrap_clr ) 
						|| 
						( is_prev_me && !wrap_clr && next_wrap && !next_wrap_clr ) 
						|| 
						( is_next_me && !next_wrap_clr ) 
					)*/
				){ // @TODO Experiment: always allow left side drop
					var is_switch_left = false,
						is_switch_right = false,
						left = ( prev_wrap && !wrap_clr ? Math.ceil(prev_wrap.grid_center.x)+1 : wrap.grid.left ),
						right = Math.ceil(wrap.grid_center.x),
						bottom = ( is_wrap_me && wrap.grid.bottom > max_row_wrap.grid.bottom ? wrap.grid.bottom : max_row_wrap.grid.bottom );
					if ( can_drop(wrap.grid.top, bottom) ){
						that.drops.push({
							_id: ed._new_id(),
							top: wrap.grid.top,
							bottom: bottom,
							left: left,
							right: ( wrap_me_only && next_wrap_el_left ? next_wrap_el_left.grid.left-1 : right ), 
							priority: {
								top: wrap.grid.top,
								bottom: bottom,
								left: ( prev_wrap && !wrap_clr ? left+Math.ceil((prev_wrap.grid.right-left)/2) : left ),
								right: ( wrap_me_only && next_wrap_el_left ? next_wrap_el_left.grid.left-1 : wrap.grid.left+Math.ceil((right-wrap.grid.left)/2)-1 ),
								index: ( wrap_me_only ? 1 : 4 )
							},
							priority_index: 10,
							type: 'side-before',
							insert: [( is_switch_left ? 'after' : 'before' ), wrap.$el],
							region: region,
							is_me: wrap_me_only,
							is_clear: wrap_clr,
							is_use: false,
							is_switch: ( is_switch_left || is_switch_right ),
							switch_dir: ( is_switch_left ? 'left' : ( is_switch_right ? 'right' : false ) ),
							row_wraps: row_wraps,
							me_in_row: ( wrap_me_in_row ? true : false )
						});
					}
				}
			});

			// Don't add another droppable if this is not the first el from wrapper, only on responsive
			if ( breakpoint && !breakpoint.default && has_siblings && sibling_index > 0 ){
				return;
			}
			
			// If spacer, don't add further
			if ( is_spacer ) {
				return;
			}

			if ( $wraps.size() > 0 ) {
				var last_wrap = ed.get_wrap($wraps.last()),
					last_wrap_clr = ( last_wrap && last_wrap.grid.left == area.grid.left ),
					is_drop_me = ( me_wrap && last_wrap_clr && last_wrap._id == me_wrap._id && !has_siblings ),
					bottom = ( expand_lock ? area.grid.bottom : ( area.grid.bottom-current_full_top > row ? area.grid.bottom + 5 : current_full_top + row ) ),
					bottom_wrap = _.max(ed.wraps, function(each){
						if ( each.region != region_name )
							return 0;
						if ( me_wrap && me_wrap._id == each._id )
							return 0;
						if ( !_.contains($wraps.get(), each.$el.get(0)) )
							return 0;
						return each.grid.bottom;
					}),
					top = bottom_wrap.grid.bottom+1,
					bottom_not_me = ( !me_wrap || ( bottom_wrap && me_wrap && bottom_wrap._id != me_wrap._id ) ),
					priority_top = ( bottom_not_me && top > current_full_top ? top : current_full_top );
				if ( can_drop(priority_top, bottom) || is_drop_me ){
					that.drops.push({
						_id: ed._new_id(),
						top: current_full_top,
						bottom: bottom,
						left: area.grid.left,
						right: area.grid.right,
						priority: {
							top: priority_top,
							bottom: bottom,
							left: area.grid.left,
							right: area.grid.right,
							index: ( is_drop_me ? 2 : 3 )
						},
						priority_index: 8,
						type: 'full',
						insert: ['append', $area],
						region: region,
						is_me: is_drop_me,
						is_clear: true,
						is_use: false,
						is_switch: false,
						switch_dir: false,
						row_wraps: false,
						me_in_row: false
					});
				}
			}
			else {
				var bottom = ( expand_lock ? area.grid.bottom : ( area.grid.bottom-area.grid.top > row ? area.grid.bottom : area.grid.top + row ) );
				if ( can_drop(area.grid.top, bottom) ){
					that.drops.push({
						_id: ed._new_id(),
						top: area.grid.top,
						bottom: bottom,
						left: area.grid.left,
						right: area.grid.right,
						priority: null,
						priority_index: 8,
						type: 'full',
						insert: ['append', $area],
						region: region,
						is_me: ( region_name == 'shadow' && me.region == region_name ),
						is_clear: true,
						is_use: false,
						is_switch: false,
						switch_dir: false,
						row_wraps: false,
						me_in_row: false
					});
				}
			}
		});
		ed.time_end('fn create_drop_point');
	},
	
	select_drop_point: function (drop) {
		var ed = this.ed;
		if ( !drop || drop.is_use ){
			return;
		}
		ed.time_start('fn select_drop');
		var drop_move = typeof this.drop == 'object' && !drop.is_me ? true : false;
		_.each(this.drops, function(each){
			each.is_use = ( each._id == drop._id );
		});
		this.drop = drop;

		if ( ed.show_debug_element ){
			$('.upfront-drop-view-current').removeClass('upfront-drop-view-current');
			$('#drop-view-'+drop._id).addClass('upfront-drop-view-current');
		}
		$('.upfront-drop').remove();
		
		var that = this,
			me = this.me,
			$drop = $('<div class="upfront-drop upfront-drop-use"></div>'),
			drop_change = function () {
				Upfront.Events.trigger("entity:drag:drop_change", that.view, that.model);
			},
			$insert_rel = ( drop.type == 'inside' && !drop.insert[1].hasClass('upfront-module-group') ) ?  drop.insert[1].parent() : drop.insert[1],
			insert_order = drop.insert[1].data('breakpoint_order') || 0,
			ani_width = me.width,
			ani_height = me.height
		;
		switch ( drop.insert[0] ){
			case 'before':
				$drop.insertBefore($insert_rel);
				break;
			case 'after':
				$drop.insertAfter($insert_rel);
				break;
			case 'append':
				drop.insert[1].append($drop);
				insert_order = drop.insert[1].children().length;
				break;
		}
		$drop.css('order', insert_order);
		
		if ( drop.type == 'full' || drop.type == 'inside' ) {
			$drop.css('width', (drop.right-drop.left+1)*ed.col_size);
			// Add height too in case of full region drop
			if ( !drop.priority || drop.is_me ) {
				if ( drop.is_me ) {
					$drop.css('margin-top', me.height*-1);
					$drop.css('height', me.height);
				}
				else {
					$drop.css('height', (drop.bottom-drop.top+1)*ed.baseline);
				}
			}
		}
		else if ( drop.type == 'side-before' || drop.type == 'side-after' ) {
			var pos = $insert_rel.position();
			$drop.css('height', (drop.bottom-drop.top+1)*ed.baseline);
			// If drop is current element, add width too
			if ( drop.is_me ){
				$drop.css('width', me.width);
				if ( drop.type == 'side-before' ) $drop.css('margin-right', me.width*-1);
				else $drop.css('margin-left', me.width*-1);
			}
			$drop.css({
				position: 'absolute',
				top: pos.top,
				left: pos.left + ( drop.type == 'side-after' ? $insert_rel.width() : 0 )
			});
		}
		else if ( drop_move ) {
			drop_change();
		}
		ed.time_end('fn select_drop');
	},
	
	prepare_drag: function () {
		var ed = this.ed,
			breakpoint = this.breakpoint
		;
		this.$main.addClass('upfront-dragging');
		// remove position which might be set to the module view
		this.view.$el.css("position", "");
		
		ed.start(this.view, this.model);
		ed.normalize(ed.els, ed.wraps);
		ed.update_position_data(ed.containment.$el);
		this.update_vars();
		this.set_current_region(this.region);
		
		var $me = this.$me,
			me = this.me,
			$helper = this.$helper,
			me_offset = $me.offset(),
			max_height = ed.max_row*ed.baseline,
			draggable = $me.data('ui-draggable'),
			cursor_top = this.event.pageY - me_offset.top,
			area = ( this.is_parent_group ? ed.get_position(this.view.group_view.$el) : ed.get_region(this.$region) ),
			drop_areas = false
		;

		// hack the cursor position
		if ( cursor_top > max_height/2 ) {
			draggable._adjustOffsetFromHelper({
				top: Math.round(( me.height > max_height ? max_height : me.height )/2)
			});
		}

		//this.$region.css('min-height', $region.css('height'));
		//$me.hide();
		$me.css('visibility', 'hidden');
		$helper.css('max-width', me.width);
		$helper.css('height', me.height);
		$helper.css('max-height', max_height);
		$helper.css('margin-left', $me.css('margin-left')); // fix error with the percentage margin applied

		this.area_col = area.col;
		if ( this.is_parent_group ) {
			area.region = this.$region.data('name');
			area.group = this.view.group_view.$el.attr('id');
			this.drop_areas = [ area ];
			this.current_area_col = area.col;
		}
		else if ( breakpoint && !breakpoint.default ) {
			this.drop_areas = [ area ];
		}
		else {
			//check if there is a light box in active state
			var lightbox = false;
			var shadowregion;
			ed.lightbox_cols = false;
			_.each(ed.regions, function(region) {
				if(region.$el.hasClass('upfront-region-side-lightbox') && region.$el.css('display') == 'block') {
//				console.log('found active lightbox');
					lightbox = region;
					ed.lightbox_cols = region.col;
				}
				if(region.$el.hasClass('upfront-region-shadow')){
					shadowregion = region;
				}

			});
			if ( lightbox ) {
				this.drop_areas = [ lightbox, shadowregion ];
			}
			else {
				this.drop_areas = ed.regions;
			}
		}


		this.current_row_wraps = false;

		this.create_drop_point();

		this.$wrap.css('min-height', '1px');

		$('.upfront-drop-me').css('height', (me.outer_grid.bottom-me.outer_grid.top)*ed.baseline);

		this.show_debug_data();

		// Default drop to me
		this.select_drop_point( _.find(this.drops, function(each){ return each.is_me; }) );
		this.$region.addClass('upfront-region-drag-active');
	},
	
	update_drop_timeout: function () {
		var breakpoint = this.breakpoint;
		this.update_compare_area();
		this.update_focus_state();
		
		if ( !breakpoint || breakpoint.default ) {
			this.update_current_region();
		}
		else {
			this.set_current_region();
		}
		this.update_current_drop_point();
	},
	
	update_compare_area: function () {
		var ed = this.ed,
			$helper = this.$helper,
			
			height = Math.ceil($helper.outerHeight()/ed.baseline)*ed.baseline,
			width = $helper.outerWidth(),

			current_offset = $helper.offset(),
			current_left = current_offset.left,
			current_top = current_offset.top,
			current_bottom = current_top+height,
			current_right = current_left+width,
			current_x = current_left+(width/2),
			current_y = current_top+(height/2),

			current_grid = ed.get_grid(current_left, current_top),
			current_grid_left = current_grid.x,
			current_grid_top = current_grid.y,
			current_grid2 = ed.get_grid(current_right, current_bottom),
			current_grid_right = current_grid2.x-1,
			current_grid_bottom = current_grid2.y-1,

			grid = ed.get_grid(this.event.pageX, this.event.pageY),
			col = this.me.col,
			
			compare_col = this.focus ? ed.focus_compare_col : ed.compare_col,
			compare_row = this.focus ? ed.focus_compare_row : ed.compare_row,

			compare_area_top = grid.y-(compare_row/2),
			compare_area_top = compare_area_top < current_grid_top ? current_grid_top : compare_area_top,
			compare_area_left = grid.x-(compare_col/2),
			compare_area_left = compare_area_left < current_grid_left ? current_grid_left : compare_area_left,
			compare_area_right = compare_area_left+compare_col-1,
			compare_area_right = compare_area_right > current_grid_right ? current_grid_right : compare_area_right,
			compare_area_bottom = compare_area_top+compare_row-1,
			compare_area_bottom = compare_area_bottom > current_grid_bottom ? current_grid_bottom : compare_area_bottom,
			compare_area_bottom = compare_area_bottom > compare_area_top+ed.max_row ? compare_area_top+ed.max_row : compare_area_bottom,

			compare_area_position = [grid.x, grid.y, compare_area_top, compare_area_right, compare_area_bottom, compare_area_left] // to store as reference
		;
		this.current_grid = grid;
		this.current_grid_pos = {
			top: current_grid_top,
			left: current_grid_left,
			right: current_grid_right,
			bottom: current_grid_bottom
		};
		this.compare_area = {
			top: compare_area_top,
			left: compare_area_left,
			right: compare_area_right,
			bottom: compare_area_bottom
		}
		this.compare_area_position = compare_area_position;
	},
	
	update_focus_state: function () {
		var that = this,
			ed = this.ed,
			moved_distance =  this._last_coord
				? Math.sqrt(Math.pow(this.event.pageX-this._last_coord.x, 2) + Math.pow(this.event.pageY-this._last_coord.y, 2))
				: 0,
			time = Date.now()
			;
		if ( this._last_drag_position && moved_distance <= ed.update_distance ){
			// Not moving much? Let's try to focus
			if ( !this._focus_t ) {
				this._focus_t = setTimeout(function(){
					that.focus = true;
					that.focus_coord.x = that.event.pageX;
					that.focus_coord.y = that.event.pageY;
					that._last_drag_time = Date.now();
					that.update_drop_timeout();
				}, ed.focus_timeout);
			}
			/*if ( time - this._last_drag_time >= ed.focus_timeout ) {
				this.focus = true;
				this.focus_coord.x = this.event.pageX;
				this.focus_coord.y = this.event.pageY;
				this._last_drag_time = time;
			}*/
			return;
		}
		clearTimeout(this._focus_t);
		this._focus_t = false;
		this._last_drag_position = this.compare_area_position;
		this._last_coord.x = this.event.pageX;
		this._last_coord.y = this.event.pageY;
		this._last_drag_time = time;
		
		// If focused, try to see if we need to out focus it
		if ( this.focus ) {
			var focus_distance = Math.sqrt(Math.pow(this.event.pageX-this.focus_coord.x, 2) + Math.pow(this.event.pageY-this.focus_coord.y, 2));
			if ( focus_distance > ed.focus_out_distance ) {
				this.focus = false;
			}
		}
	},
	
	update_current_drop_point: function () {
		var that = this,
			drops_area = _.map(this.drops, function(each){
				if ( each.region._id != that.current_region._id ) return false;
				var area = that.get_area_compared(each);
				return {
					area: area,
					drop: each
				};
			}).filter(function(each){
				if ( each !== false ) return true;
				return false;
			}),
			max_drop = _.max(drops_area, function(each){ return each.area; })
		;

		if ( max_drop.area > 0 ){
			var max_drops = _.filter(drops_area, function(each){ return each.area == max_drop.area; }),
				max_drops_sort = _.sortBy(max_drops, function(each, index, list){
					var priority_area = each.drop.priority ? that.get_area_compared(each.drop.priority) : 0;
					if ( priority_area*1 >= each.area ) return each.drop.priority.index;
					return each.drop.priority_index;
				}),
				drop = _.first(max_drops_sort).drop
			;
		}
		else {
			var drop = _.find(this.drops, function(each){
				return each.is_me;
			});
		}
		this.select_drop_point(drop);
		this.update_drop_position();
	},
	
	update_drop_position: function () {
		if ( !this.drop ) return;
		var ed = this.ed,
			drop = this.drop,
			col = this.current_region ? this.current_region.col : this.me.col,
			is_spacer = this.$me.hasClass('upfront-module-spacer'),
			wrap_only = this.$wrap.find(this.module_selector).length == 1,
			drop_priority_top = drop.priority ? drop.priority.top-drop.top : 0,
			drop_priority_left = drop.priority ? drop.priority.left-drop.left : 0,
			expand_lock = drop.region.$el.hasClass('upfront-region-expand-lock'),
			drop_row = ( drop.priority ? drop.priority.bottom-drop.priority.top+1 : drop.bottom-drop.top+1 );
		this.drop_top = 0;
		this.drop_left = 0;
		// drop_col is calculated based of it's position
		if ( drop.is_me || ( drop.me_in_row && wrap_only ) || is_spacer ){
			this.drop_col = this.me.col;
		}
		else {
			if ( drop.type == 'side-before' || drop.type == 'side-after' ) {
				var distribute = this.find_column_distribution(drop.row_wraps, (drop.me_in_row && wrap_only), true, this.current_area_col, false);
				this.drop_col = distribute.apply_col;
			}
			else {
				this.drop_col = drop.priority ? drop.priority.right-drop.priority.left+1 : drop.right-drop.left+1;
			}
		}

		/*if ( this.is_group ) {
			var original_col = this.model.get_property_value_by_name('original_col');
			if ( _.isNumber(original_col) && original_col > col ) {
				col = original_col;
			}
		}
		this.drop_col = this.drop_col <= col ? this.drop_col : col;*/

		//adjust_bottom = false;
		adjust_bottom = true;

		if ( ed.show_debug_element ){
			$('#upfront-compare-area').css({
				top: (this.compare_area.top-1) * ed.baseline,
				left: (this.compare_area.left-1) * ed.col_size + (ed.grid_layout.left-ed.grid_layout.layout_left),
				width: (this.compare_area.right-this.compare_area.left+1) * ed.col_size,
				height: (this.compare_area.bottom-this.compare_area.top+1) * ed.baseline
			}).text(
				'('+this.compare_area.left+','+this.compare_area.right+') '+
				'('+this.compare_area.top+','+this.compare_area.bottom+')'
			);
		}
	},
	
	/**
	 * Finding the region we currently on
	 */
	update_current_region: function () {
		var that = this,
			ed = this.ed,
			$last_region_container = $('.upfront-region-container-wide, .upfront-region-container-clip').not('.upfront-region-container-shadow').last(),
			regions_area = _.map(ed.regions, function(each){
				var top, bottom, left, right, area,
					is_same_container = ( each.$el.closest('.upfront-region-container').get(0) == $last_region_container.get(0) ),
					region_bottom = ( is_same_container && ( !each.$el.hasClass('upfront-region-side') || each.$el.hasClass('upfront-region-side-left') || each.$el.hasClass('upfront-region-side-right') ) ) ? 999999 : each.grid.bottom, // Make this bottom-less if it's in the last region container
					is_active = each.$el.hasClass('upfront-region-drag-active'),
					is_sub_h = each.$el.hasClass('upfront-region-side-top') || each.$el.hasClass('upfront-region-side-bottom'),
					area = that.get_area_compared({
						top: each.grid.top - 5,
						bottom: region_bottom + 5,
						left: each.grid.left,
						right: each.grid.right
					}),
					type = each.$el.data('type'),
					priority = ed.region_type_priority[type]
				;
				area *= priority;
				if ( is_sub_h ) area *= 2;
				if ( is_active ) area *= 1.5;
				return {
					area: area,
					region: each
				};
			}),
			max_region = _.max(regions_area, function(each){ return each.area; })
		;

		if ( max_region.area > 0 && max_region.region.$el.get(0) != this.current_region.$el.get(0) ) {
			this.set_current_region(max_region.region);

			// Create drop points on the new region
			ed.update_position_data(this.$current_container, false);
			this.create_drop_point();
		}


		if ( ed.show_debug_element ){
			_.each(regions_area, function(r){
				r.region.$el.find('>.upfront-debug-info').text(r.area);
			});
		}
	},
	
	set_current_region: function (region) {
		var regions = this.app.layout.get("regions");
		this.current_region = region && region.$el ? region : this.ed.get_region(this.$region);
		if ( !this.current_region.$el.hasClass('upfront-region-drag-active') ){
			$('.upfront-region-drag-active').removeClass('upfront-region-drag-active');
			this.current_region.$el.addClass('upfront-region-drag-active');
		}
		this.current_region_model = regions.get_by_name(this.current_region.region);
		this.current_wrappers = this.is_parent_group 
			? this.view.group_view.model.get('wrappers') 
			: this.current_region_model.get('wrappers')
		;
		this.$current_container = this.is_parent_group 
			? this.view.group_view.$el.find('.upfront-editable_entities_container:first') 
			: this.current_region.$el.find('.upfront-modules_container > .upfront-editable_entities_container:first')
		;
		this.move_region = ( this.region._id != this.current_region._id );
		if ( !this.is_parent_group ) {
			this.current_area_col = this.current_region.col;
		}
	},
	
	get_area_compared: function (compare) {
		var compare_area = this.compare_area,
			top, bottom, left, right, area;
		if ( compare_area.left >= compare.left && compare_area.left <= compare.right )
			left = compare_area.left;
		else if ( compare_area.left < compare.left )
			left = compare.left;
		if ( compare_area.right >= compare.left && compare_area.right <= compare.right )
			right = compare_area.right;
		else if ( compare_area.right > compare.right )
			right = compare.right;
		if ( compare_area.top >= compare.top && compare_area.top <= compare.bottom )
			top = compare_area.top;
		else if ( compare_area.top < compare.top )
			top = compare.top;
		if ( compare_area.bottom >= compare.top && compare_area.bottom <= compare.bottom )
			bottom = compare_area.bottom;
		else if ( compare_area.bottom > compare.bottom )
			bottom = compare.bottom;
		if ( top && bottom && left && right )
			area = (right-left+1) * (bottom-top+1);
		else
			area = 0;
		return area ? area : 0;
	},
	
	render_drop: function () {
		var ed = this.ed,
			breakpoint = this.breakpoint,
			$drop = $('.upfront-drop-use')
		;
		this.wrap_only = ( breakpoint && !breakpoint.default ? true : false );
		if ( !breakpoint || breakpoint.default ) {
			if ( this.drop.type != 'inside' ){
				var wrapper_id = Upfront.Util.get_unique_id("wrapper");
					wrap_model = new Upfront.Models.Wrapper({
						"name": "",
						"properties": [
							{"name": "wrapper_id", "value": wrapper_id},
							{"name": "class", "value": ed.grid.class+this.drop_col}
						]
					}),
					wrap_view = new Upfront.Views.Wrapper({model: wrap_model})
				;
				if ( this.drop.type == 'full' || this.drop.is_clear ) {
					wrap_model.add_class('clr');
				}
				this.current_wrappers.add(wrap_model);
				wrap_view.parent_view = this.view.parent_view;
				this.view.wrapper_view = wrap_view;
				wrap_view.render();
				wrap_view.$el.append(this.view.$el);
				if ( this.drop.type == 'side-before' && this.drop.is_clear ) {
					$drop.nextAll('.upfront-wrapper').eq(0).removeClass('clr');
				}
				$drop.before(wrap_view.$el);
				this.new_wrap_view = wrap_view;
				Upfront.data.wrapper_views[wrap_model.cid] = wrap_view;
			}
			else {
				var $drop_wrap = $drop.closest('.upfront-wrapper'),
					wrapper_id = $drop_wrap.attr('id');
				$drop.before(this.view.$el);
			}
			this.wrapper_id = wrapper_id;
			this.model.set_property('wrapper_id', this.wrapper_id, true);

			if ( this.$wrap.find(this.module_selector).length == 0 ){
				if ( this.wrap && this.wrap.grid.left == this.current_region.grid.left ) {
					this.$wrap.nextAll('.upfront-wrapper').eq(0).addClass('clr');
				}
				this.$wrap.remove();
				this.wrap_only = true;
			}
		}
	},
	
	update_models: function () {
		var that = this,
			ed = this.ed,
			breakpoint = this.breakpoint,
			wrappers = this.current_wrappers,
			$me = this.$me,
			$wrap = this.$wrap
		;
		// normalize clear
		_.each(ed.wraps, function(each){
			var breakpoint_clear = ( !breakpoint || breakpoint.default ) ? each.$el.hasClass('clr') : each.$el.data('breakpoint_clear');
			each.$el.data('clear', breakpoint_clear ? 'clear' : 'none');
		});
		if ( !this.drop.is_me && this.drop.type == 'side-before' ) {
			var $next_wrap = this.drop.insert[1];
			if ( $next_wrap.size() > 0 ){
				var next_wrap = ed.get_wrap($next_wrap),
					next_wrap_clr = ( !breakpoint || breakpoint.default ) ? $next_wrap.hasClass('clr') : $next_wrap.data('breakpoint_clear');
				if ( ! next_wrap_clr || this.drop.is_clear ){
					$next_wrap.data('clear', 'none');
				}
			}
		}
		
		ed.update_model_margin_classes( $me, [ed.grid.class + this.drop_col] );
		
		// If the drop is to side, also update the elements on the same row
		if ( 
			!this.drop.is_me 
			&& 
			( !this.drop.me_in_row || !this.wrap_only ) 
			&& 
			( this.drop.type == 'side-before' || this.drop.type == 'side-after' ) 
		) {
			var distribute = this.find_column_distribution(this.drop.row_wraps, false, true, this.current_area_col, false),
				remaining_col = distribute.remaining_col - (this.drop_col-distribute.apply_col),
				apply_index = 0,
				first_is_spacer = false,
				me_clear = false
			;
			_.each(this.drop.row_wraps, function (row_wrap) {
				row_wrap.$el.find(that.module_selector).each(function () {
					if ( $(this).hasClass('upfront-module-spacer') ) {
						var wrap_model = wrappers.get_by_wrapper_id(row_wrap.$el.attr('id')),
							this_model = ed.get_el_model($(this));
						wrappers.remove(wrap_model);
						that.model.collection.remove(this_model);
						if ( apply_index == 0 ) {
							first_is_spacer = true;
							if ( ( that.drop.type == 'side-after' || that.drop.type == 'side-before' ) && that.drop.insert[1].get(0) == row_wrap.$el.get(0) ) {
								// First is removed spacer and we drop before/after that spacer, means we now drop to the first
								me_clear = true;
							}
						}
					}
					else {
						var apply_col = distribute.apply_col;
						// Distribute remaining_col
						if ( remaining_col > 0 ) {
							apply_col += 1;
							remaining_col -= 1;
						}
						ed.update_model_margin_classes( $(this), [ed.grid.class + apply_col] );
						if ( apply_index == 1 && first_is_spacer ) {
							if ( that.drop.type == 'side-before' && that.drop.insert[1].get(0) == row_wrap.$el.get(0) ) {
								// First is removed spacer and we drop before the first element, means we now drop to the first
								me_clear = true;
							}
							else if ( !me_clear ) {
								// First is removed spacer and now this wrapper is the first instead, if we don't drop to the first
								row_wrap.$el.data('clear', 'clear');
							}
						}
					}
					apply_index++;
				});
			});
			if ( me_clear ) {
				if ( that.new_wrap_view !== false ) {
					that.new_wrap_view.$el.data('clear', 'clear');
				}
				else {
					that.$wrap.data('clear', 'clear');
				}
			}
		}
		
		// Also try to distribute columns if the element was moved away and leave empty spaces in previous place
		if ( !this.drop.is_me && !this.drop.me_in_row && this.wrap_only ) {
			if ( this.current_row_wraps && !_.isEqual(this.drop.row_wraps, this.current_row_wraps) ) {
				var distribute = this.find_column_distribution(this.current_row_wraps, true, false, this.area_col),
					remaining_col = distribute.remaining_col
				;
				if ( distribute.total > 0 ) {
					_.each(this.current_row_wraps, function (row_wrap) {
						if ( that.wrap.$el.get(0) == row_wrap.$el.get(0) ) return;
						row_wrap.$el.find(that.module_selector).each(function () {
							if ( $(this).hasClass('upfront-module-spacer') ) return;
							var apply_col = distribute.apply_col;
							// Distribute remaining_col
							if ( remaining_col > 0 ) {
								apply_col += 1;
								remaining_col -= 1;
							}
							ed.update_model_margin_classes( $(this), [ed.grid.class + apply_col] );	
						});
					});
				}
				else if ( distribute.spacer_total > 0 ) {
					// Nothing to distribute, means all spacer, so we'll remove them
					_.each(this.current_row_wraps, function (row_wrap) {
						if ( that.wrap.$el.get(0) == row_wrap.$el.get(0) ) return;
						row_wrap.$el.find(that.module_selector).each(function () {
							if ( !$(this).hasClass('upfront-module-spacer') ) return;
							var wrap_model = wrappers.get_by_wrapper_id(row_wrap.$el.attr('id')),
								this_model = ed.get_el_model($(this));
							wrappers.remove(wrap_model);
							that.model.collection.remove(this_model, {update: false});
						});
					});
				}
			}
		}
		
		if ( this.is_parent_group ) {
			ed.update_wrappers(this.view.group_view.model, this.view.group_view.$el);
		}
		else {
			ed.update_wrappers(this.current_region_model, this.current_region.$el);
		}

		if ( this.move_region ) {
			ed.update_model_margin_classes( this.$container.find('.upfront-wrapper').find(this.module_selector) );
			ed.update_wrappers(this.region_model, this.region.$el);
		}

		if ( !breakpoint || breakpoint.default ){
			if ( !this.move_region ){
				this.view.resort_bound_collection();
			}
			else {
				var modules = this.current_region_model.get('modules'),
					models = []
				;
				this.model.collection.remove(this.model, {silent: true});
				if ( this.model.get('shadow') ){
					this.view.trigger('on_layout');
					this.model.unset('shadow', {silent: true});
				}
				$me.removeAttr('data-shadow');
				this.$current_container.find('.upfront-wrapper').find(this.module_selector).each(function(){
					var element_id = $(this).attr('id'),
						each_model = modules.get_by_element_id(element_id);
					if ( !each_model && element_id == $me.attr('id') ) {
						models.push(that.model);
					}
					else if ( each_model ) {
						models.push(each_model);
					}
				});
				modules.reset(models);
			}
		}
		else {
			var orders = [],
				index = 0,
				is_drop_wrapper = ( this.drop.type != 'inside' ),
				$els = is_drop_wrapper
					? Upfront.Util.find_sorted(this.$current_container, '> .upfront-wrapper')
					: Upfront.Util.find_sorted($me.closest('.upfront-wrapper'), this.module_selector)
				,
				inside_length = !is_drop_wrapper ? $me.closest('.upfront-wrapper').find(this.module_selector).length : 0,
				insert_index = false
			;
			if ( !this.drop.is_me && this.drop.insert[0] == 'append' && is_drop_wrapper ) {
				insert_index = $els.length-1;
			}
			$els.each(function(){
				var each_el = is_drop_wrapper ? ed.get_wrap($(this)) : ed.get_el($(this));
				if ( !each_el ) return; // Doesn't exists, means it's not relevant to current breakpoint
				if ( insert_index === index ) index++;
				if ( !that.drop.is_me && that.drop.insert[0] == 'append' ) {
					if ( !is_drop_wrapper && insert_index === false && $(this).closest('.upfront-wrapper').get(0) == that.drop.insert[1].get(0) ){
						insert_index = index + inside_length - 1;
					}
					if ( ( is_drop_wrapper && $wrap.get(0) == this ) || ( !is_drop_wrapper && $me.get(0) == this ) ){
						index--;
					}
				}
				if ( !that.drop.is_me && that.drop.insert[1].get(0) == this ){
					if ( that.drop.insert[0] == 'before' ){
						insert_index = index;
						orders.push({
							$el: $(this),
							order: index+1,
							clear: ( that.drop.type != 'side-before' )
						});
					}
					else if ( that.drop.type == 'side-after' && that.drop.insert[0] == 'after' ){
						insert_index = index+1;
						orders.push({
							$el: $(this),
							order: index,
							clear: ( each_el.outer_grid.left == that.current_region.grid.left ) // @TODO: does it work correctly with group?
						});
					}
					index++;
				}
				else {
					orders.push({
						$el: $(this),
						order: index,
						clear: ( each_el.outer_grid.left == that.current_region.grid.left ) // @TODO: does it work correctly with group?
					});
				}
				index++;
			});
			_.each(orders, function(each_el){
				var id = each_el.$el.attr('id'),
					each_model = is_drop_wrapper ? wrappers.get_by_wrapper_id(id) : ed.get_el_model(each_el.$el),
					model_breakpoint, model_breakpoint_data
				;
				if ( !each_model ) return;
				if ( 
					( is_drop_wrapper && each_el.$el.get(0) == $wrap.get(0) ) 
					|| 
					( !is_drop_wrapper && each_el.$el.get(0) == $me.get(0) ) 
				){
					each_el.order = insert_index !== false ? insert_index : each_el.order;
					each_el.clear = that.drop.is_clear;
				}
				model_breakpoint = Upfront.Util.clone(each_model.get_property_value_by_name('breakpoint') || {});
				if ( !_.isObject(model_breakpoint[breakpoint.id]) ){
					model_breakpoint[breakpoint.id] = {};
				}
				model_breakpoint_data = model_breakpoint[breakpoint.id];
				model_breakpoint_data.order = each_el.order;
				model_breakpoint_data.edited = true;
				if ( is_drop_wrapper ) {
					model_breakpoint_data.clear = each_el.clear;
				}
				each_model.set_property('breakpoint', model_breakpoint);
			});
		}

		// Let's normalize
		ed.update_position_data(this.$current_container);
		ed.normalize(ed.els, ed.wraps);
	},
	
	update_views: function () {
		var view = this.view,
			model = this.model
		;
		if ( this.move_region ){
			view.region = this.current_region_model;
			view.region_view = Upfront.data.region_views[view.region.cid];
			view.parent_view = view.region_view._modules_view;
			if ( !_.isUndefined(view._modules_view) ) { // this is grouped modules, also fix the child views
				view._modules_view.region_view = view.region_view;
				if ( !_.isUndefined(model.get('modules')) ){
					model.get('modules').each(function(child_module){
						var child_view = Upfront.data.module_views[child_module.cid];
						if ( !child_view ) return;
						child_view.region = view.region;
						child_view.region_view = view.region_view;
					});
				}
			}
			view.trigger('region:updated');
		}
	},
	
	clean_elements: function () {
		$('.upfront-drop').remove();
		$('.upfront-drop-view').remove();
		$('#upfront-compare-area').remove();

		this.$me.css({
			'position': '',
			'top': '',
			'left': '',
			'z-index': '',
			'visibility': 'visible'
		});
		
		this.$wrap.css('min-height', '');
		this.$current_container.find('.upfront-wrapper').find(this.module_selector).css('max-height', '');
		$('.upfront-region-drag-active').removeClass('upfront-region-drag-active');
		this.$main.removeClass('upfront-dragging');
	},
	
	reset: function () {
		this.drop_areas_created = [];
		this.drops = [];
		this.drop = false;
	},
	
	find_column_distribution: function (row_wraps, me_in_row, add, area_col, count_spacer) {
		var add = ( add !== false ),
			spacers = _.filter(row_wraps, function (row_wrap) {
				return ( row_wrap.$el.find('> .upfront-module-view > .upfront-module-spacer').length > 0 );
			}),
			spacers_col = _.reduce(spacers, function (sum, spacer) {
				return sum + spacer.col;
			}, 0),
			row_wraps_total = ( me_in_row ? row_wraps.length-1 : row_wraps.length ) - spacers.length,
			count_spacer = ( count_spacer !== false ),
			total_col = ( count_spacer ? area_col-spacers_col : area_col ),
			apply_col = 0,
			remaining_col = 0
		;
		if ( add ) row_wraps_total++;
		// If we have columns to distribute, else just return available col after spacer columns substracted (total_col)
		if ( row_wraps_total > 0 ) {
			apply_col = Math.floor(total_col/row_wraps_total);
			remaining_col = total_col - (apply_col*row_wraps_total);
		}
		else {
			apply_col = total_col;
			remaining_col = 0;
		}
		return {
			apply_col: apply_col,
			remaining_col: remaining_col,
			total_col: total_col,
			spacers_col: spacers_col,
			total: row_wraps_total,
			spacer_total: spacers.length
		}
	},
	
	
	show_debug_data: function () {
		if ( !this.ed.show_debug_element ) return;
		var ed = this.ed,
			$layout = this.$layout,
			$helper = this.$helper
		;
		_.each(ed.els, function(each){
			each.$el.find(".upfront-debug-info").size() || each.$el.find('.upfront-editable_entity:first').append('<div class="upfront-debug-info"></div>');
			each.$el.find(".upfront-debug-info").text(
				'grid: ('+each.grid.left+','+each.grid.right+'),'+'('+each.grid.top+','+each.grid.bottom+') | '+
				'outer: ('+each.outer_grid.left+','+each.outer_grid.right+'),('+each.outer_grid.top+','+each.outer_grid.bottom+') | '+
				'center: '+each.grid_center.x+','+each.grid_center.y
			);
		});
		_.each(this.drops, function(each){
			//each.$el.append('<div class="upfront-drop-debug">('+each.left+','+each.top+'),('+each.right+','+each.bottom+')</div>');
			var $view = $('<div class="upfront-drop-view"><div class="upfront-drop-priority-view"></div><span class="upfront-drop-view-pos"></span></div>');
			$view.addClass('upfront-drop-view-'+each.type);
			if ( each.is_me ) {
				$view.addClass('upfront-drop-view-me');
			}
			$view.attr('id', 'drop-view-'+each._id);
			$view.css({
				top: (each.top-1)*ed.baseline,
				left: (each.left-1)*ed.col_size + (ed.grid_layout.left-ed.grid_layout.layout_left),
				width: (each.right-each.left+1) * ed.col_size,
				height: (each.bottom-each.top+1) * ed.baseline
			});
			if ( each.priority ){
				$view.find('.upfront-drop-priority-view').css({
					top: (each.priority.top-each.top)*ed.baseline,
					left: (each.priority.left-each.left)*ed.col_size,
					width: (each.priority.right-each.priority.left+1) * ed.col_size,
					height: (each.priority.bottom-each.priority.top+1) * ed.baseline
				});
			}
			$view.find('.upfront-drop-view-pos').text(
				'('+each.left+','+each.right+')'+'('+each.top+','+each.bottom+')'+'('+each.type+')' +
				( each.priority ? '('+each.priority.left+','+each.priority.right+')'+'('+each.priority.top+','+each.priority.bottom+')' : '' )
			);
			$layout.append($view);
		});
		$layout.append('<div id="upfront-compare-area"></div>');
		$helper.find(".upfront-debug-info").size() || $helper.append('<div class="upfront-debug-info"></div>');
	}
}


return DragDrop;

});
	
})(jQuery);
//@ sourceURL=dragdrop.js;
(function ($) {

var Resize = function (view, model) {
	
}

Resize.prototype = {
	view: false,
	model: false
}

define('scripts/upfront/behaviors/resize',Resize);
	
})(jQuery);
//@ sourceURL=resize.js;
(function ($) {

define('scripts/upfront/behaviors/grid-editor',[
	'scripts/upfront/behaviors/dragdrop',
	'scripts/upfront/behaviors/resize'
], function (DragDrop, Resize) {
	
var GridEditor = {
	lightbox_cols: false,
	main: {$el: null, top: 0, left: 0, right: 0},
	grid_layout: {top: 0, left: 0, right: 0},
	containment: {$el: null, top: 0, left: 0, right: 0, col: 0, grid: {top: 0, left: 0, right: 0}},
	min_col: 1,
	max_row: 0,
	compare_col: 2,
	compare_row: 10,
	focus_compare_col: 1,
	focus_compare_row: 3,
	update_distance: 10, // distance from last recorded coordinate before issuing update, in px
	timeout: 0, // in ms
	focus_timeout: 500, // in ms
	focus: false,
	focus_out_distance: 50,
	focus_coord: {x: 0, y: 0},
	_t: null, // timeout resource
	_t_focus: null, // timeout resource for focus
	col_size: 0,
	baseline: 0,
	grid: null,

	// some more configurable setting
	region_type_priority: {
		wide: 1,
		clip: 1,
		full: 1,
		fixed: 2,
		lightbox: 2,
	},

	els: [],
	wraps: [],
	regions: [],
	drops: [],

	drop: null,

	el_selector: '.upfront-module, .upfront-module-group',
	_id: 0,
	
	drag_instances: {},
	resize_instances: {},
	wrapper_resize_instances: {},

	show_debug_element: false,

	resizing: false,

	/**
	 * Return a new incremented internal counter
	 */
	_new_id: function(){
		var ed = Upfront.Behaviors.GridEditor;
		ed._id++;
		return ed._id;
	},

	/**
	 * Get grid position of an x,y offset
	 *
	 * @param {Int} x
	 * @param {Int} y
	 */
	get_grid: function(x, y){
		var	ed = Upfront.Behaviors.GridEditor,
			grid_x = Math.round((x-ed.grid_layout.left)/ed.col_size)+1,
			grid_y = Math.ceil((y-ed.grid_layout.top)/ed.baseline)+1;
		return {x: grid_x, y: grid_y};
	},

	/**
	 * Get position of an element
	 *
	 * @param {DOM Object} el
	 */
	get_position: function(el){
		var ed = Upfront.Behaviors.GridEditor,
			$el = $(el),
			width = parseFloat($el.css('width')),
			height = parseFloat($el.css('height')),
			offset = $el.offset(),
			top = offset.top,
			left = offset.left,
			grid = ed.get_grid(left, top),
			col = Math.round(width/ed.col_size),
			row = Math.floor(height/ed.baseline),
			//$region = $el.closest('.upfront-region'),
			//region = $region.data('name'),
			//$group = $el.closest('.upfront-module-group'),
			//group = $group.length > 0 ? $group.attr('id') : false,
			position = {
				top: Math.round(top),
				left: Math.round(left),
				bottom: Math.round(top+height),
				right: Math.round(left+width)
			},
			pos_grid = {
				top: grid.y,
				left: grid.x,
				right: grid.x+col-1,
				bottom: grid.y+row-1
			}
		;
		return {
			$el: $el,
			_id: ed._new_id(),
			position: position,
			outer_position: position, // Backward compatibility, to be deprecated
			width: width,
			height: height,
			center: {
				y: Math.round(top+(height/2)),
				x: Math.round(left+(width/2))
			},
			col: col,
			row: row,
			grid: pos_grid,
			outer_grid: pos_grid, // Backward compatibility, to be deprecated
			grid_center: {
				y: grid.y+(row/2)-1,
				x: grid.x+(col/2)-1
			},
			//region: region,
			//group: group
		};
	},

	get_region_position: function (el) {
		var ed = Upfront.Behaviors.GridEditor,
			$el = $(el),
			$modules_container = $el.find('.upfront-modules_container'),
			position = ed.get_position($modules_container);
		position.$el = $el;
		return position;
	},

	/**
	 * Get margin from class name and store in data to use later
	 *
	 * @param {Object} el
	 */
	init_margin: function (el){
		var ed = Upfront.Behaviors.GridEditor,
			left = Math.round(parseFloat(el.$el.css('margin-left'))/ed.col_size),
			top = Math.round(parseFloat(el.$el.css('margin-top'))/ed.baseline)
		;
		el.$el.data('margin', {
			original: {
				left: left,
				top: top
			},
			current: {
				left: left,
				top: top
			}
		});
	},

	get_affected_els: function (el, els, ignore, direct) {
		var aff_els = { top: [], left: [], bottom: [], right: [] },
			compare = el.outer_grid;
		if ( Array.isArray(ignore) )
			ignore.push(el);
		else
			ignore = [el];
		direct = direct ? true : false;
		_.each(_.reject(els, function(each){
				var ignored = _.find(ignore, function(i){
					return i.$el.get(0) == each.$el.get(0);
				});
				return ignored ? true : false;
			}),
			function(each){
				if ( el.region != each.region )
					return;
				if ( el.group != each.group )
					return;
				if ( ( each.outer_grid.top >= compare.top && each.outer_grid.top < compare.bottom ) ||
					 ( each.outer_grid.bottom >= compare.top && each.outer_grid.bottom <= compare.bottom ) ||
					 ( compare.top >= each.outer_grid.top && compare.top < each.outer_grid.bottom ) ||
					 ( compare.bottom >= each.outer_grid.top && compare.bottom <= each.outer_grid.bottom ) ){
					if ( compare.left > each.outer_grid.right ){
						aff_els.left.push(each);
					}
					if ( compare.right < each.outer_grid.left ){
						aff_els.right.push(each);
					}
				}
				if ( compare.top > each.outer_grid.bottom ){
					aff_els.top.push(each);
				}
				if ( compare.bottom < each.outer_grid.top ){
					aff_els.bottom.push(each);
				}
			}
		);
		if ( direct ){
			var direct_left = _.max(aff_els.left, function(each){ return each.outer_grid.right; });
			aff_els.left = _.filter(aff_els.left, function(each){
				return ( each.outer_grid.right == direct_left.outer_grid.right );
			});
			var direct_right = _.min(aff_els.right, function(each){ return each.outer_grid.left; });
			aff_els.right = _.filter(aff_els.right, function(each){
				return ( each.outer_grid.left == direct_right.outer_grid.left );
			});
			var direct_top = _.max(aff_els.top, function(each){ return each.outer_grid.top; });
			aff_els.top = _.filter(aff_els.top, function(each){
				return ( each.outer_grid.top == direct_top.outer_grid.top );
			});
			var direct_bottom = _.min(aff_els.bottom, function(each){ return each.outer_grid.top; });
			aff_els.bottom = _.filter(aff_els.bottom, function(each){
				return ( each.outer_grid.top == direct_bottom.outer_grid.top );
			});
		}
		return aff_els;
	},

	get_affected_wrapper_els: function(el, els, ignore, direct){
		var ed = Upfront.Behaviors.GridEditor,
			aff = ed.get_affected_els(el, els, ignore, direct),
			aff_els = {
				top: _.flatten(_.map(aff.top, function(w){
					var els = _.reject(ed.get_wrap_els(w), function(el){
							return ignore ? _.find(ignore, function(i){ return i.$el.get(0) == el.$el.get(0); }) : false;
						}),
						max = ed.get_wrap_el_max(w, ignore, true);
					return _.filter(els, function(el){ return el.outer_grid.bottom == max.outer_grid.bottom; });
				})),
				bottom: _.flatten(_.map(aff.bottom, function(w){
					var els = _.reject(ed.get_wrap_els(w), function(el){
							return ignore ? _.find(ignore, function(i){ return i.$el.get(0) == el.$el.get(0); }) : false;
						}),
						min = ed.get_wrap_el_min(w, ignore, true);
					return _.filter(els, function(el){ return el.outer_grid.top == min.outer_grid.top; });
				})),
				left: _.flatten(_.map(aff.left, function(w){
					var els = _.reject(ed.get_wrap_els(w), function(el){
							return ignore ? _.find(ignore, function(i){ return i.$el.get(0) == el.$el.get(0); }) : false;
						}),
						max = ed.get_wrap_el_max(w, ignore, false);
					return _.filter(els, function(el){ return el.outer_grid.right == max.outer_grid.right; });
				})),
				right: _.flatten(_.map(aff.right, function(w){
					var els = _.reject(ed.get_wrap_els(w), function(el){
							return ignore ? _.find(ignore, function(i){ return i.$el.get(0) == el.$el.get(0); }) : false;
						}),
						min = ed.get_wrap_el_min(w, ignore, false);
					return _.filter(els, function(el){ return el.outer_grid.left == min.outer_grid.left; });
				}))
			};
		return aff_els;
	},

	get_move_limit: function (aff_els, containment) {
		var move_limit = [containment.grid.left, containment.grid.right];
		_.each(aff_els.left, function(each){
			if ( each.grid.right > move_limit[0] ) {
				move_limit[0] = each.grid.right+1;
			}
		});
		_.each(aff_els.right, function(each){
			if ( each.grid.left < move_limit[1] ) {
				move_limit[1] = each.grid.left-1;
			}
		});
		return move_limit;
	},
	
	get_resize_limit: function (aff_els, containment) {
		var resize_limit = [containment.grid.left, containment.grid.right];
		_.each(aff_els.left, function(each){
			if ( each.grid.left > resize_limit[0] ) {
				resize_limit[0] = each.grid.left;
			}
		});
		_.each(aff_els.right, function(each){
			if ( each.grid.right < resize_limit[1] ) {
				resize_limit[1] = each.grid.right;
			}
		});
		return resize_limit;
	},

	/**
	 * Get maximum size available to resize
	 *
	 * @param (object) el
	 * @param (array) els
	 * @param (object) region
	 * @param (string) axis nw|se|all
	 */
	get_max_size: function ( el, els, region, axis ) {
		var ed = Upfront.Behaviors.GridEditor,
			col = ed.get_class_num(el.$el, ed.grid.class),
			axis = /all|nw|se/.test(axis) ? axis : 'all',
			margin = el.$el.data('margin'),
			aff_els = ed.get_affected_els(el, els, [], true),
			move_limit = ed.get_move_limit(aff_els, ed.containment),
			max_col = ( axis == 'nw' ? col+el.grid.left-move_limit[0] : ( axis == 'se' ? col+move_limit[1]-el.grid.right : move_limit[1]-move_limit[0]+1 ) ),
			expand_lock = region.$el.hasClass('upfront-region-expand-lock'),
			top_aff_el = aff_els.bottom.length ? _.min(aff_els.bottom, function(each){ return each.grid.top; }) : false,
			max_row_se = top_aff_el ? top_aff_el.grid.top-el.grid.top : region.grid.bottom-el.grid.top,
			max_row =  axis == 'nw' ? margin.original.top+el.row : ( axis == 'se' ? max_row_se : max_row_se+margin.original.top );
		return {
			col: max_col,
			row: expand_lock || axis == 'nw' ? max_row : false
		};
	},


	get_wrap_els: function( use_wrap ){
		var ed = Upfront.Behaviors.GridEditor,
			$els = use_wrap.$el.find('> .upfront-module-view > .upfront-module, > .upfront-module-group');
		return _.map($els, function(el){
			var el = ed.get_el($(el));
			return _.find(ed.els, function(each){ return each._id == el._id; });
		});
	},

	get_wrap_el_min: function( use_wrap, ignore, top ){
		var ed = Upfront.Behaviors.GridEditor,
			wrap_els = ed.get_wrap_els(use_wrap),
			wrap_el_min = _.min(_.reject(wrap_els, function(el){
				return ignore ? _.find(ignore, function(i){ return i.$el.get(0) == el.$el.get(0); }) : false;
			}), function(each){
				return top ? each.grid.top : each.grid.left;
			});
		return _.isObject(wrap_el_min) ? wrap_el_min : false;
	},

	get_wrap_el_max: function( use_wrap, ignore, bottom ){
		var ed = Upfront.Behaviors.GridEditor,
			wrap_els = ed.get_wrap_els(use_wrap),
			wrap_el_max = _.max(_.reject(wrap_els, function(el){
				return ignore ? _.find(ignore, function(i){ return i.$el.get(0) == el.$el.get(0); }) : false;
			}), function(each){
				return bottom ? each.grid.bottom : each.grid.right;
			});
		return _.isObject(wrap_el_max) ? wrap_el_max : false;
	},

	/**
	 * Get element position data
	 *
	 * @param {jQuery Object} $el
	 */
	get_el: function ($el){
		var ed = Upfront.Behaviors.GridEditor;
		return _.find(ed.els, function(each){ return ( $el.get(0) == each.$el.get(0) ); });
	},

	/**
	 * Get wrapper position data
	 *
	 * @param {jQuery Object} $wrap
	 */
	get_wrap: function ($wrap){
		var ed = Upfront.Behaviors.GridEditor;
		return _.find(ed.wraps, function(each){ return ( $wrap.get(0) == each.$el.get(0) ); });
	},

	/**
	 * Get region position data
	 *
	 * @param {jQuery Object} $region
	 */
	get_region: function ($region){
		var ed = Upfront.Behaviors.GridEditor;
		return _.find(ed.regions, function(each){ return ( $region.get(0) == each.$el.get(0) ); });
	},

	/**
	 * Get drop data
	 *
	 * @param {jQuery Object} $region
	 */
	get_drop: function ($drop){
		var ed = Upfront.Behaviors.GridEditor;
		return _.find(ed.drops, function(each){ return ( $drop.get(0) == each.$el.get(0) ); });
	},

	/**
	 * Get integer value from class name
	 *
	 * @param {jQuery Object|String} from
	 * @param {String} class_name
	 */
	get_class_num: function (from, class_name){
		var text = _.isString(from) ? from : from.attr('class'),
			rx = new RegExp('\\b' + class_name + '(\\d+)'),
			val = text.match(rx);
		return ( val && val[1] ) ? parseInt(val[1]) : 0;
	},

	/**
	 * Get element model
	 *
	 * @param {jQuery Object} $el
	 */
	get_el_model: function ($el) {
		var app = Upfront.Application,
			ed = Upfront.Behaviors.GridEditor,
			regions = app.layout.get('regions'),
			find_model = function (modules) {
				if ( !modules )
					return false;
				var module_model = modules.get_by_element_id($el.attr('id')),
					found_model;
				if ( module_model )
					return module_model;
				modules.find(function(module){
					if ( module.get('modules') ) {
						found_model = find_model(module.get('modules'));
						return found_model ? true : false;
					}
					else if ( module.get('objects') ) {
						found_model = module.get('objects').get_by_element_id($el.attr('id'));
						return found_model ? true : false;
					}
				});
				return found_model;
			},
			model;
		regions.find(function(region){
			model = find_model(region.get('modules'));
			return model ? true : false;
		});
		return model ? model : false;
	},

	/**
	 * Update class name with new value
	 *
	 * @param {jQuery Object} $el
	 * @param {String} class_name
	 * @param {Int} class_size
	 */
	update_class: function ($el, class_name, class_size) {
		var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
			rx = new RegExp('\\b' + class_name + '\\d+'),
			$parent, parent_col;
		if ( !breakpoint || breakpoint.default ){ // apply class if default
			if ( ! $el.hasClass(class_name+class_size) ){
				if ( $el.attr('class').match(rx) )
					$el.attr('class', $el.attr('class').replace(rx, class_name+class_size));
				else
					$el.addClass(class_name+class_size);
			}
		}
		else { // otherwise, inline style
			$parent = $el.parent();
			parent_col = Math.round($parent.width()/this.col_size);
			if ( class_name == 'c' )
				$el.css('width', ((class_size/parent_col)*100) + '%');
			else if ( class_name == 'ml' )
				$el.css('margin-left', ((class_size/parent_col)*100) + '%');
			else if ( class_name == 'mt' )
				$el.css('margin-top', (class_size*this.baseline) + 'px');
		}
	},

	/**
	 * Update margin class name
	 *
	 * @param {jQuery Object} $el
	 */
	update_margin_classes: function ($el) {
		this.time_start('fn update_margin_classes');
		var el_margin = $el.data('margin'),
			ed = Upfront.Behaviors.GridEditor;
		if ( el_margin.current != el_margin.original ){
			ed.update_class($el, ed.grid.left_margin_class, el_margin.current.left);
			ed.update_class($el, ed.grid.top_margin_class, el_margin.current.top);
		}
		this.time_end('fn update_margin_classes');
	},

	update_model_classes: function ($el, classes) {
		this.time_start('fn update_model_classes');
		var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
			model = this.get_el_model($el);
		if ( model && ( !breakpoint || breakpoint.default ) ){
			model.replace_class(classes.join(' '));
		}
		this.time_end('fn update_model_classes');
	},

	update_model_breakpoint: function ($el, data) {
		var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
			model = this.get_el_model($el),
			model_breakpoint;
		if ( model && breakpoint && !breakpoint.default ){
			model_breakpoint = Upfront.Util.clone(model.get_property_value_by_name('breakpoint') || {});
			if ( !_.isObject(model_breakpoint[breakpoint.id]) )
				model_breakpoint[breakpoint.id] = {};
			model_breakpoint[breakpoint.id] = _.extend(model_breakpoint[breakpoint.id], data);
			model_breakpoint[breakpoint.id].edited = true;
			model.set_property('breakpoint', model_breakpoint);
		}
	},

	update_model_margin_classes: function ($els, more_classes) {
		var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
			ed = Upfront.Behaviors.GridEditor;
		$els.each(function(){
			var $el = $(this),
				margin = $el.data('margin'),
				classes, data, margin_top, margin_left;
			if (
				( margin && ( margin.original.left != margin.current.left || margin.original.top != margin.current.top ) ) ||
				more_classes
			){
				margin_top = margin ? margin.current.top : 0;
				margin_left = margin ? margin.current.left : 0;
				if ( !breakpoint || breakpoint.default ){
					classes = [
						ed.grid.left_margin_class+margin_left,
						ed.grid.top_margin_class+margin_top
					];
					if ( more_classes ) {
						classes = _.union(classes, more_classes);
					}
					ed.update_model_classes($el, classes);
				}
				else {
					data = {
						left: margin_left,
						top: margin_top
					};
					if ( more_classes )
						_.each(more_classes, function(classname){
							var parse = classname.match(/^([A-Za-z])(\d+)$/);
							if ( parse && parse[1] == ed.grid.class ) {
								data.col = parseInt(parse[2]);
							}
						});
					ed.update_model_breakpoint($el, data);
				}
			}
		});
	},

	adjust_els_right: function( adj_els, cmp_right, update_class ){
		this.time_start('fn adjust_els_right');
		var	ed = Upfront.Behaviors.GridEditor;
		_.each(adj_els, function(each){
			var each_margin = each.$el.data('margin'),
				each_margin_size = each.grid.left > cmp_right ? each.grid.left-cmp_right-1 : each_margin.current.left;
			if ( each_margin.current.left != each_margin_size ){
				each_margin.current.left = each_margin_size;
				if ( update_class )
					ed.update_margin_classes(each.$el);
				each.$el.data('margin', each_margin);
			}
		});
		this.time_end('fn adjust_els_right');
	},

	adjust_affected_right: function( adj_wrap, adj_wrap_aff_right, ignore, cmp_right, update_class ){
		this.time_start('fn adjust_affected_right');
		var	ed = Upfront.Behaviors.GridEditor,
			wrap_el_max = ed.get_wrap_el_max(adj_wrap, ignore),
			wrap_right = wrap_el_max ? ( cmp_right && cmp_right > wrap_el_max.grid.right ? cmp_right : wrap_el_max.grid.right ) : ( cmp_right ? cmp_right : adj_wrap.grid.left-1 );
		adj_wrap_aff_right = _.reject(adj_wrap_aff_right, function(el){
			return ignore ? _.find(ignore, function(i){ return i.$el.get(0) == el.$el.get(0); }) : false;
		});
		ed.adjust_els_right(adj_wrap_aff_right, wrap_right, update_class);
		if ( cmp_right+1 == ed.containment.grid.left && ed.get_wrap_els(adj_wrap).length == 0 ) {
			adj_wrap.$el.nextAll('.upfront-wrapper:eq(0)').data('clear', 'clear'); // @TODO check this
		}
		this.time_end('fn adjust_affected_right');
	},

	adjust_els_bottom: function ( adj_els, cmp_bottom, update_class ) {
		this.time_start('fn adjust_els_bottom');
		var	ed = Upfront.Behaviors.GridEditor;
		_.each(adj_els, function(each){
			var each_margin = each.$el.data('margin'),
				each_margin_size = each.grid.top > cmp_bottom ? each.grid.top-cmp_bottom-1 : 0;
			if ( each_margin.current.top != each_margin_size ){
				each_margin.current.top = each_margin_size;
				if ( update_class )
					ed.update_margin_classes(each.$el);
				each.$el.data('margin', each_margin);
			}
		});
		this.time_end('fn adjust_els_bottom');
	},

	adjust_affected_bottom: function ( adj_wrap, adj_wrap_aff_bottom, ignore, cmp_bottom, update_class ) {
		this.time_start('fn adjust_affected_bottom');
		var	ed = Upfront.Behaviors.GridEditor,
			wrap_el_max = ed.get_wrap_el_max(adj_wrap, ignore, true),
			wrap_bottom = wrap_el_max ? ( cmp_bottom && cmp_bottom > wrap_el_max.grid.bottom ? cmp_bottom : wrap_el_max.grid.bottom ) : ( cmp_bottom ? cmp_bottom : adj_wrap.grid.bottom-1 );
		adj_wrap_aff_bottom = _.reject(adj_wrap_aff_bottom, function(el){
			return ignore ? _.find(ignore, function(i){ return i.$el.get(0) == el.$el.get(0); }) : false;
		});
		ed.adjust_els_bottom(adj_wrap_aff_bottom, wrap_bottom, update_class);
		this.time_end('fn adjust_affected_bottom');
	},

	/**
	 * Normalize elements and wrappers
	 */
	normalize: function (els, wraps) {
		this.time_start('fn normalize');
		var app = Upfront.Application,
			ed = Upfront.Behaviors.GridEditor,
			breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
			regions = app.layout.get("regions"),
			regions_need_update = [],
			groups_need_update = [],
			models_need_move = [],
			is_responsive = ( breakpoint && !breakpoint.default );
		// Remove unneeded wraps from processing
		wraps = _.filter(wraps, function(wrap){
			return ( wrap.$el.is(':visible') || wrap.height > 0 );
		});
		// Iterate through elements and check if it must be contained in separate wrapper
		_.each(wraps, function(wrap){
			var $wrap_els= wrap.$el.find('> .upfront-module-view > .upfront-module, > .upfront-module-group'),
				region = ed.get_region(wrap.$el.closest('.upfront-region')),
				$parent_group = wrap.$el.closest('.upfront-module-group'),
				is_parent_group = ( $parent_group.length > 0 ),
				group = is_parent_group ? ed.get_el($parent_group) : false,
				wrap_index = !is_responsive ? wrap.$el.index('.upfront-wrapper') : wrap.$el.data('breakpoint_order'),
				wrap_cleared = false,
				wrap_top = false,
				wrap_left = false,
				insert_index = false;
				
			// Reset the column size if it's bigger than it allowed to
			$wrap_els.each(function(index){
				if ( this.offsetWidth <= 0 ) // Element is not visible
					return;
				var wrap_el = ed.get_el($(this)),
					col = ( !breakpoint || breakpoint.default ) ? ed.get_class_num(wrap_el.$el, ed.grid.class) : wrap_el.$el.data('breakpoint_col');
				if ( wrap_el.col < col && wrap_el.col > 0 ) {
					ed.update_model_margin_classes(wrap_el.$el, [ed.grid.class + wrap_el.col]);
				}
			});
			
			// Clear the wrapper when wrapper is rendered side-by-side, but the elements is not conflicting each other
			$wrap_els.each(function(index){
				var wrap_el = ed.get_el($(this)),
					aff_wraps = ed.get_affected_els(wrap_el, wraps, [], false),
					margin = wrap_el.$el.data('margin');
				if ( index == 0 && ( aff_wraps.left.length > 0 || aff_wraps.right.length > 0 ) ){
					var bottom_wrap = _.max(_.union(aff_wraps.left, aff_wraps.right), function(each){ return each.outer_grid.bottom; });
					if ( bottom_wrap.outer_grid.bottom < wrap_el.grid.top ){
						var model = ed.get_el_model(wrap_el.$el),
							collection = model.collection,
							model_index = collection.indexOf(model),
							last_wrap = _.max(_.union(aff_wraps.left, aff_wraps.right), function(each){ return each.outer_grid.left; }),
							last_wrap_index = !is_responsive ? last_wrap.$el.index('.upfront-wrapper') : last_wrap.$el.data('breakpoint_order'),
							last_wrap_el = _.last(ed.get_wrap_els(last_wrap)),
							last_model = ed.get_el_model(last_wrap_el.$el),
							last_index = collection.indexOf(last_model),
							margin_top = wrap_el.grid.top - bottom_wrap.outer_grid.bottom;

						wrap_top = wrap_el.grid.top - margin_top + 1;
						wrap_left = region.grid.left;
						wrap_cleared = true;
						wrap_el.outer_grid.top = wrap_top;
						// Check if we also need to move the position in model, or reorder in responsive
						if ( ( !is_responsive && last_index > model_index ) || ( is_responsive && last_wrap_index > wrap_index ) ) {
							if ( !is_responsive ){
								insert_index = last_index;
								wrap.$el.insertAfter(last_wrap.$el);
								models_need_move.push({collection: collection, model: model, index: insert_index});
							}
							else {
								var wrappers = is_parent_group ? ed.get_el_model($parent_group).get('wrappers') : regions.get_by_name(wrap_el.region).get('wrappers'),
									$wraps = wrap.$el.parent().find('> .upfront-wrapper').each(Upfront.Util.normalize_sort_elements_cb).sort(Upfront.Util.sort_elements_cb),
									shift = false;
								$wraps.each(function(i){
									var wrap_model = wrappers.get_by_wrapper_id($(this).attr('id'))
									if ( this == wrap.$el.get(0) ) {
										shift = true;
										wrap_model.set_breakpoint_property('order', last_wrap_index);
									}
									else {
										wrap_model.set_breakpoint_property('order', i-1);
										if ( this == last_wrap.$el.get(0) )
											shift = false;
									}
								});
							}
							/*if ( aff_wraps.right.length > 0 ) {
								var right_wrap = _.min(aff_wraps.right, function(each){ return each.outer_grid.left; }),
									right_wrap_els = ed.get_wrap_els(right_wrap);
								_.each(right_wrap_els, function(each){
									var each_margin = each.$el.data('margin');
									each_margin.current.left = each.grid.left-wrap_el.outer_grid.left;
									ed.update_model_margin_classes(each.$el);
								});
							}*/
						}
						if ( is_parent_group )
							groups_need_update.push($parent_group);
						else
							regions_need_update.push(wrap_el.region);
					}
				}
				else if ( wrap_cleared ){
					if ( !is_responsive && insert_index !== false ){
						var model = ed.get_el_model(wrap_el.$el),
							collection = model.collection;
						models_need_move.push({collection: collection, model: model, index: insert_index});
					}
				}
			});
			if ( wrap_cleared ) {
				wrap.outer_grid.top = wrap_top;
				wrap.grid.top = wrap_top;
				wrap.outer_grid.left = wrap_left;
				wrap.$el.data('clear', 'clear');
			}

			// Don't allow separating wrapper on responsive
			if ( is_responsive )
				return;

			// Separate wrapper if more than one element in the wrapper, provided that the wrapper is not conflicting anything
			if ( $wrap_els.size() > 1 ){
				$wrap_els.each(function(){
					var wrap_el = ed.get_el($(this)),
						aff_wraps = ed.get_affected_els(wrap, wraps, [], false);
					if ( aff_wraps.left.length == 0 && aff_wraps.right.length == 0 ){
						// Separate the wrapper
						var wrap_el_model = ed.get_el_model(wrap_el.$el),
							wrap_el_view = Upfront.data.module_views[wrap_el_model.cid],
							parent_view = is_parent_group && wrap_el_view.group_view ? wrap_el_view.group_view : wrap_el_view.region_view,
							parent_el = is_parent_group && group ? group : region,
							wrappers = parent_view.model.get('wrappers'),
							wrapper_id = Upfront.Util.get_unique_id("wrapper"),
							wrap_model = new Upfront.Models.Wrapper({
								"name": "",
								"properties": [
									{"name": "wrapper_id", "value": wrapper_id},
									{"name": "class", "value": ed.grid.class+(wrap_el.grid.left+wrap_el.col-parent_el.grid.left)}
								]
							}),
							wrap_view = new Upfront.Views.Wrapper({model: wrap_model});
						wrappers.add(wrap_model);
						wrap_model.add_class('clr');
						wrap_view.parent_view = wrap_el_view.parent_view;
						wrap_view.render();
						wrap_el.$el.closest('.upfront-wrapper').before(wrap_view.$el);
						wrap_view.$el.append(wrap_el_view.$el);
						wrap_el_model.set_property('wrapper_id', wrapper_id, true);
						Upfront.data.wrapper_views[wrap_model.cid] = wrap_view;
						ed.init_margin(wrap_el);
						if ( is_parent_group )
							groups_need_update.push($parent_group);
						else
							regions_need_update.push(wrap_el.region);
					}
				});
			}
		});
		_.each(wraps, function(wrap){
			var region = ed.get_region(wrap.$el.closest('.upfront-region'));
			if ( !region )
				return;
			if ( !is_responsive && wrap.outer_grid.left == region.grid.left && !wrap.$el.hasClass('clr') )
				wrap.$el.addClass('clr');
		});
		_.each(_.uniq(regions_need_update), function(region){
			var region_model = regions.get_by_name(region),
				region_view = Upfront.data.region_views[region_model.cid];
			ed.update_wrappers(region_model, region_view.$el);
		});
		_.each(_.uniq(groups_need_update), function($group){
			var group_model = ed.get_el_model($group),
				group_view = Upfront.data.module_views[group_model.cid];
			ed.update_wrappers(group_model, group_view.$el);
		});
		if ( !is_responsive ) {
			_.each(models_need_move, function(move){
				move.collection.remove(move.model, {silent: true});
				move.model.add_to(move.collection, move.index);
			});
		}
		// Clean clear data attribute
		_.each(wraps, function(wrap){
			wrap.$el.removeData('clear');
		});
		this.time_end('fn normalize');
	},

	/**
	 * Init the GridEditor object
	 */
	init: function(){
		var app = Upfront.Application,
			ed = Upfront.Behaviors.GridEditor,
			$main = $(Upfront.Settings.LayoutEditor.Selectors.main),
			main_pos = $main.offset(),
			$layout = $main.find('.upfront-layout');
		ed.baseline = Upfront.Settings.LayoutEditor.Grid.baseline;
		ed.grid = Upfront.Settings.LayoutEditor.Grid;
		ed.col_size = ed.grid.column_width;

		ed.max_row = Math.floor(($(window).height()*.5)/ed.baseline);
		ed.main = {
			$el: $main,
			top: main_pos.top,
			bottom: main_pos.top + $main.outerHeight(),
			left: main_pos.left,
			right: main_pos.left + $main.outerWidth()
		};

		// Prevents quick scroll when resizing
		var scrollStep = 15;
		$(document).on('scroll', function(e){
			if(ed.resizing === false || ed.resizing == window.scrollY)
				return;

			if(window.scrollY > ed.resizing)
				ed.resizing += scrollStep;
			else
				ed.resizing -= scrollStep;

			window.scrollTo(window.scrollX, ed.resizing);
		});
	},

	/**
	 * Start editor, to set all required variables
	 *
	 * @param {Object} view
	 */
	start: function(view, model, $cont){
		this.time_start('fn start');
		var app = Upfront.Application,
			ed = Upfront.Behaviors.GridEditor,
			main_pos = ed.main.$el.offset(),
			$layout = ed.main.$el.find('.upfront-layout'),
			layout_pos = $layout.offset(),
			is_object = view.$el.find(".upfront-editable_entity").eq(0).is(".upfront-object"),
			$containment = $cont || view.$el.closest(".upfront-editable_entities_container"),
			containment_pos = $containment.offset();
		// Set variables
		ed.col_size = ed.grid.column_width;
		ed.el_selector = is_object ? '.upfront-object' : '.upfront-module, .upfront-module-group';
		ed.main.top = main_pos.top;
		ed.main.bottom = main_pos.top + ed.main.$el.outerHeight();
		ed.main.left = main_pos.left;
		ed.main.right = main_pos.left + ed.main.$el.outerWidth();
		var grid_layout_left = layout_pos.left + ($layout.outerWidth() - (ed.grid.size*ed.col_size))/2;
		ed.grid_layout = {
			top: layout_pos.top,
			bottom: layout_pos.top + $layout.outerHeight(),
			left: grid_layout_left,
			right: grid_layout_left + (ed.grid.size*ed.col_size),
			layout_left: layout_pos.left,
			layout_right: layout_pos.left + $layout.outerWidth()
		};
		var containment_width = $containment.outerWidth(),
			containment_height = $containment.outerHeight(),
			containment_col = Math.round(containment_width/ed.col_size),
			containment_row = Math.round(containment_height/ed.baseline),
			containment_grid = ed.get_grid(containment_pos.left, containment_pos.top);
		ed.containment = {
			$el: $containment,
			top: containment_pos.top,
			bottom: containment_pos.top + containment_height,
			left: containment_pos.left,
			right: containment_pos.left + containment_width,
			col: containment_col,
			grid: {
				top: containment_grid.y,
				bottom: containment_grid.y+containment_row-1,
				left: containment_grid.x,
				right: containment_grid.x+containment_col-1
			}
		};
		ed.update_position_data($containment);
		this.time_end('fn start');
	},

	/**
	 * Update position data
	 */
	update_position_data: function ($containment, update_regions) {
		this.time_start('fn update_position_data');
		var app = Upfront.Application,
			ed = Upfront.Behaviors.GridEditor,
			$layout = ed.main.$el.find('.upfront-layout'),
			is_object = ( ed.el_selector == '.upfront-object' ),
			$els = false,
			$wraps = $containment.find('> .upfront-wrapper'),
			$regions = $layout.find('.upfront-region').not('.upfront-region-locked'),
			$region = $containment.closest('.upfront-region'),
			region_name = $region.data('name'),
			$group = $containment.closest('.upfront-module-group'),
			group_id = $group.length > 0 ? $group.attr('id') : false
		;
		// If region isn't shadow, we ignore not-visible elements
		if ( region_name !== 'shadow' ) {
			$wraps = $wraps.filter(':visible');
			$els = is_object
				? $wraps.find('.upfront-object')
				: $wraps.find('> .upfront-module-view > .upfront-module, > .upfront-module-group');
		}
		else {
			$els = $containment.find('> .upfront-module-view > .upfront-module');
		}
		ed.els = _.map($els, ed.get_position ); // Generate elements position data
		_.each(ed.els, function(el){
			el.region = region_name;
			el.group = group_id;
			ed.init_margin(el); // Generate margin data
		});
		ed.wraps = _.map($wraps, ed.get_position ); // Generate wrappers position data
		_.each(ed.wraps, function(wrap){
			wrap.region = region_name;
			wrap.group = group_id;
		});
		if ( false !== update_regions ) {
			ed.regions = _.map($regions, ed.get_region_position ); // Generate regions position data
			_.each(ed.regions, function(region){
				region.region = region.$el.closest('.upfront-region').data('name');
				region.group = false;
			});
		}
		this.time_end('fn update_position_data');
	},

	

	/**
	 * Update wrappers
	 */
	update_wrappers: function (parent_model, $parent) {
		this.time_start('fn update_wrappers');
		var app = Upfront.Application,
			ed = Upfront.Behaviors.GridEditor,
			breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
			$main = $(Upfront.Settings.LayoutEditor.Selectors.main),
			$layout = $main.find('.upfront-layout'),
			wraps = parent_model.get('wrappers'),
			modules = parent_model.get('modules');
		($parent ? $parent : $layout).find('.upfront-wrapper:visible').each(function(){
			var $wrap = $(this),
				wrap_id = $wrap.attr('id'),
				wrap_model = wraps.get_by_wrapper_id(wrap_id),
				clear = $wrap.data('clear'),
				children = _.map($wrap.find('> .upfront-module-view > .upfront-module, > .upfront-module-group'), function (each) {
					var $el = $(each);
					if ( !$el || !$el.length ) return false;
					return $el;
				}).filter(function (each) {
					return each !== false;
				});
			;
			if ( children.length == 0 ){
				if ( wrap_model ) wraps.remove(wrap_model);
				return;
			}
			if ( $wrap.hasClass('upfront-wrapper-preview') ) return;
			if ( $wrap.height() <= 0 ) return;
			if ( ! wrap_model ) return;
			var current_col = ( !breakpoint || breakpoint.default ) ? ed.get_class_num($wrap, ed.grid.class) : $wrap.data('breakpoint_col'),
				child_els = _.map(children, function($el){
					return {
						$el: $el,
						col: ( !breakpoint || breakpoint.default ) ? ed.get_class_num($el, ed.grid.class) : $el.data('breakpoint_col')
					};
				}),
				max = _.max(child_els, function(each){
					if ( !each ) return;
					return each.col;
				}),
				wrap_col = max.col,
				wrap_breakpoint, breakpoint_data;
			ed.update_class($wrap, ed.grid.class, wrap_col);
			if ( !breakpoint || breakpoint.default ){
				if ( current_col != wrap_col ) {
					wrap_model.replace_class(ed.grid.class+wrap_col);
				}
				if ( (clear && clear == 'clear') || (!clear && $wrap.hasClass('clr')) ) {
					wrap_model.add_class('clr');
				}
				else {
					wrap_model.remove_class('clr');
				}
			}
			else {
				wrap_breakpoint = Upfront.Util.clone(wrap_model.get_property_value_by_name('breakpoint') || {});
				if ( !_.isObject(wrap_breakpoint[breakpoint.id]) ) {
					wrap_breakpoint[breakpoint.id] = {};
				}
				wrap_breakpoint[breakpoint.id].col = wrap_col;
				if ( clear ) {
					wrap_breakpoint[breakpoint.id].clear = (clear == 'clear');
				}
				wrap_model.set_property('breakpoint', wrap_breakpoint);
			}
			/*$wrap.stop().css({
				position: '',
				left: '',
				right: ''
			});*/
		});
		wraps.each(function(wrap){
			if ( $('#'+wrap.get_wrapper_id()).size() == 0 ) {
				wraps.remove(wrap);
			}
		});
		Upfront.Events.trigger("entity:wrappers:update", parent_model);
		this.time_end('fn update_wrappers');
	},


	/**
	 * Create resizable
	 *
	 * @param {Object} view
	 * @param {Object} model
	 */
	create_resizable: function(view, model){
		var app = this,
			ed = Upfront.Behaviors.GridEditor,
			is_group = view.$el.hasClass('upfront-module-group'),
			$me = is_group ? view.$el : view.$el.find('>.upfront-editable_entity'),
			is_parent_group = ( typeof view.group_view != 'undefined' ),
			$main = $(Upfront.Settings.LayoutEditor.Selectors.main),
			$layout = $main.find('.upfront-layout'),
			$resize, $resize_placeholder,
			axis
		;
		if ( Upfront.Application.mode.current !== Upfront.Application.MODE.THEME && model.get_property_value_by_name('disable_resize') ) {
			return false;
		}
		if ( $me.hasClass('upfront-module-spacer') ) {
			return false;
		}
		if ( $me.data('ui-resizable') ){
			$me.resizable('option', 'disabled', false);
			return false;
		}
		//$me.append('<span class="upfront-icon-control upfront-icon-control-resize-nw upfront-resize-handle-nw ui-resizable-handle ui-resizable-nw"></span>');
		//$me.append('<span class="upfront-icon-control upfront-icon-control-resize-se upfront-resize-handle-se ui-resizable-handle ui-resizable-se"></span>');
		$me.append('<span class="upfront-icon-control upfront-icon-control-resize-s upfront-resize-handle-s ui-resizable-handle ui-resizable-s"></span>');
		$me.resizable({
			containment: "document",
			autoHide: false,
			delay: 50,
			handles: {
				//nw: '.upfront-resize-handle-nw',
				//se: '.upfront-resize-handle-se',
				s: '.upfront-resize-handle-s'
			},
			start: function(e, ui){
				ed.start(view, model);

				// Prevents quick scroll when resizing
				ed.resizing = window.scrollY;

				var me = ed.get_el($me),
					margin = $me.data('margin'),
					data = $(this).data('ui-resizable');
				axis = data.axis ? data.axis : 'se';
				$resize_placeholder = $('<div class="upfront-resize-placeholder"></div>');
				$resize_placeholder.css({
					marginLeft: ((margin.original.left/(me.col+margin.original.left))*100) + '%',
					marginTop: margin.original.top*ed.baseline,
					width: ((me.col/(me.col+margin.original.left))*100) + '%',
					height: ui.originalSize.height
				});
				$resize = $('<div class="upfront-resize" style="height:'+me.height+'px;"></div>');
				$resize.css({
					height: me.height,
					width: me.width,
					minWidth: me.width,
					maxWidth: me.width,
					position: 'absolute'
				})
				if ( axis == 'nw' ) {
					$resize.css({
						top: me.position.top,
//						bottom: $('body').height() - me.position.bottom + ed.baseline,
						right: $('body').width() - me.position.right
					});
				}
				else
					$resize.css({
						top: me.position.top,
						left: me.position.left
					});
				$('body').append($resize);
				// Refreshing the elements position
				_.each(ed.els, function(each, index){
					ed.els[index] = ed.get_position(each.$el);
				});
				// Refreshing the wrapper position
				_.each(ed.wraps, function(each, index){
					ed.wraps[index] = ed.get_position(each.$el);
				});
				ed.normalize(ed.els, ed.wraps);
				ed.update_position_data(ed.containment.$el);
				// Clear margin and assign an absolute position, hack into the resizable instance as well
				var me_pos = $me.position(),
					rsz_pos = {
						left: me_pos.left + ( margin.original.left * ed.col_size ),
						top: me_pos.top + ( margin.original.top * ed.baseline )
					};
				$me.css({
					marginLeft: 0,
					marginTop: 0,
					position: 'absolute',
					left: rsz_pos.left,
					top: rsz_pos.top,
					minHeight: ''
				});
				data.originalPosition.left = rsz_pos.left;
				data.originalPosition.top = rsz_pos.top;
				data._updateCache({
					left: rsz_pos.left,
					top: rsz_pos.top
				});
				$resize_placeholder.insertBefore($me);
				
				view.trigger('entity:resize_start', {row: me.row, col: me.col, height: me.height, width: me.width}, view, view.model);
				Upfront.Events.trigger("entity:resize_start", view, view.model);
			},
			resize: function(e, ui){
				var $wrap = $me.closest('.upfront-wrapper'),
					$region = $me.closest('.upfront-region'),
					me = ed.get_el($me),
					wrap = ed.get_wrap($wrap),
					region = ed.get_region($region),
					expand_lock = $region.hasClass('upfront-region-expand-lock'),
					col = me.col,
					aff_els = wrap ? ed.get_affected_wrapper_els(wrap, ed.wraps, [], true) : ed.get_affected_els(me, ed.els, [], true),
					move_limit = ed.get_move_limit(aff_els, ed.containment),
					max_col = col + ( axis == 'nw' ? me.grid.left-move_limit[0] : move_limit[1]-me.grid.right ),

					top_aff_el = aff_els.bottom.length ? _.min(aff_els.bottom, function(each){ return each.grid.top; }) : false,
					max_row = top_aff_el ? top_aff_el.grid.top-me.grid.top : region.grid.bottom-me.grid.top+1,

					current_col = Math.ceil(ui.size.width/ed.col_size),
					w = ( current_col > max_col ? Math.round(max_col*ed.col_size) : ui.size.width ),
					h = ( (ui.size.height > 15 ? ui.size.height : 0) || ui.originalSize.height ),
					current_row = Math.ceil(h/ed.baseline),
					rsz_col = ( current_col > max_col ? max_col : current_col ),
					rsz_row = ( expand_lock && current_row > max_row && max_row > 0 ? max_row : current_row )
				;
				if ( Math.abs($(window).height()-e.clientY) < 50 ){
					h += (ed.baseline*10);
					$(window).scrollTop( $(window).scrollTop()+(ed.baseline*10) );
				}
				$me.css({
					height: rsz_row*ed.baseline,
					width: w,
					minWidth: w,
					maxWidth: w
				});
				$me.data('resize-col', rsz_col);
				$me.data('resize-row', rsz_row);
				$resize.css({
					height: rsz_row*ed.baseline,
					width: rsz_col*ed.col_size,
					minWidth: rsz_col*ed.col_size,
					maxWidth: rsz_col*ed.col_size,
				});
				if(axis == 'nw') {
					$resize.css({
						top: me.$el.find('>.upfront-resize-handle-nw').offset().top,
						marginTop: me.$el.find('>.upfront-resize-handle-se').offset().top+me.$el.find('>.upfront-resize-handle-se').height()-me.$el.find('>.upfront-resize-handle-nw').offset().top-rsz_row*ed.baseline
					});
				}
				if ( !expand_lock && axis != 'nw' )
					$resize_placeholder.css('height', rsz_row*ed.baseline);
				view.update_size_hint(rsz_col*ed.col_size, rsz_row*ed.baseline);
				
				view.trigger('entity:resizing', {row: rsz_row, col: rsz_col, height: rsz_row*ed.baseline, width: rsz_col*ed.col_size}, view, view.model);
			},
			stop: function(e, ui){
				Upfront.Events.trigger("entity:pre_resize_stop", view, view.model, ui);
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					$wrap = $me.closest('.upfront-wrapper'),
					$region = $me.closest('.upfront-region'),
					me = ed.get_el($me),
					margin = $me.data('margin'),
					wrap = ed.get_wrap($wrap),
					expand_lock = $region.hasClass('upfront-region-expand-lock'),
					aff_els = wrap ? ed.get_affected_wrapper_els(wrap, ed.wraps, [], true) : ed.get_affected_els(me, ed.els, [], true),
					move_limit = ed.get_move_limit(aff_els, ed.containment),
					prev_col = Math.ceil(ui.originalSize.width/ed.col_size),
					prev_row = Math.ceil(ui.originalSize.height/ed.baseline),
					rsz_col = $me.data('resize-col'),
					rsz_row = $me.data('resize-row'),

					regions = app.layout.get('regions'),
					region = regions.get_by_name($region.data('name')),
					model_breakpoint, breakpoint_data
				;

				// Prevents quick scroll when resizing
				ed.resizing = false;

				$resize_placeholder.remove();
				$resize.remove();

				ed.update_class($me, ed.grid.class, rsz_col);
				if ( axis == 'nw' ){
					margin.current.left = margin.original.left - (rsz_col-prev_col);
					margin.current.top = margin.original.top - (rsz_row-prev_row);
					$me.data('margin', margin);
					ed.update_margin_classes($me);
				}
				else if ( axis == 'se' && wrap ){
					ed.adjust_affected_right(wrap, aff_els.right, [me], me.grid.left+rsz_col-1, true);
					if ( expand_lock )
						ed.adjust_affected_bottom(wrap, aff_els.bottom, [me], me.grid.top+rsz_row-1, true);
				}

				// Make sure CSS is reset, to fix bug when it keeps all resize CSS for some reason
				$me.css({
					width: '',
					minWidth: '',
					maxWidth: '',
					height: '',
					position: '',
					top: '',
					left: '',
					marginLeft: '',
					marginTop: ''
				});

				if ( !breakpoint || breakpoint.default ){
					model.set_property('row', rsz_row);
					// Also resize containing object if it's only one object
					var objects = model.get('objects');
					if ( objects && objects.length == 1 ){
						objects.each(function(object){
							object.set_property('row', rsz_row);
						});
					}

					// Update model value
					if ( axis == 'nw' ){
						model.replace_class([
							ed.grid.class+rsz_col,
							ed.grid.left_margin_class+margin.current.left,
							ed.grid.top_margin_class+margin.current.top,
						].join(' '));
					}
					else{
						model.replace_class(ed.grid.class+rsz_col);
						ed.update_model_margin_classes($region.find('.upfront-module, .upfront-module-group').not($me));
					}
				}
				else {
					model_breakpoint = Upfront.Util.clone(model.get_property_value_by_name('breakpoint') || {});
					if ( !_.isObject(model_breakpoint[breakpoint.id]) )
						model_breakpoint[breakpoint.id] = {};
					breakpoint_data = model_breakpoint[breakpoint.id];
					breakpoint_data.edited = true;
					breakpoint_data.row = rsz_row;
					breakpoint_data.col = rsz_col;
					if ( axis == 'nw' ){
						breakpoint_data.left = margin.current.left;
						breakpoint_data.top = margin.current.top;
					}
					else {
						ed.update_model_margin_classes($region.find('.upfront-module, .upfront-module-group').not($me));
					}
					model.set_property('breakpoint', model_breakpoint);
					// Also resize containing object if it's only one object
					var objects = model.get('objects');
					if ( objects && objects.length == 1 ){
						objects.each(function(object){
							var obj_breakpoint = Upfront.Util.clone(object.get_property_value_by_name('breakpoint') || {});
							if ( !_.isObject(obj_breakpoint[breakpoint.id]) )
								obj_breakpoint[breakpoint.id] = {};
							obj_breakpoint[breakpoint.id].row = rsz_row;
							object.set_property('breakpoint', obj_breakpoint);
						});
					}
				}

				if ( is_parent_group )
					ed.update_wrappers(view.group_view.model, view.group_view.$el);
				else
					ed.update_wrappers(region, $region);

				// Let's normalize
				ed.update_position_data(ed.containment.$el);
				ed.normalize(ed.els, ed.wraps);

				$me.removeData('resize-col');
				$me.removeData('resize-row');

				view.trigger('entity:resize_stop', {row: rsz_row, col: rsz_col, height: rsz_row*ed.baseline, width: rsz_col*ed.col_size}, view, view.model);
				Upfront.Events.trigger("entity:resize_stop", view, view.model, ui);
				Upfront.Events.trigger("entity:resized", view, view.model);
			}
		});
	},

	toggle_resizables: function (enable) {
		$('.upfront-editable_entity.ui-resizable').resizable('option', 'disabled', (!enable));
	},

	/**
	 * Resize element
	 *
	 * @param (object) view
	 * @param (object) model
	 * @param (integer) col
	 * @param (integer) row
	 * @param (string) axis nw|se|all
	 * @param (bool) force
	 */
	resize: function (view, model, col, row, axis, force) {
		var app = Upfront.Application,
			ed = Upfront.Behaviors.GridEditor,
			axis = /all|nw|se/.test(axis) ? axis : 'all',
			$main = $(Upfront.Settings.LayoutEditor.Selectors.main),
			$layout = $main.find('.upfront-layout');

		ed.start(view, model);

		var $me = view.$el.find('.upfront-editable_entity:first'),
			$object = $me.find('.upfront-editable_entity'),
			$wrap = $me.closest('.upfront-wrapper'),
			$region = $me.closest('.upfront-region'),
			margin = $me.data('margin'),
			me = ed.get_el($me),
			wrap = ed.get_wrap($wrap),
			region = ed.get_region($region),
			expand_lock = $region.hasClass('upfront-region-expand-lock'),
			aff_els = wrap ? ed.get_affected_wrapper_els(wrap, ed.wraps, [], true) : ed.get_affected_els(me, ed.els, [], true),
			max = ed.get_max_size(me, ed.els, region, axis),
			is_parent_group = ( typeof view.group_view != 'undefined' ),
			group_model = is_parent_group ? view.group_view.model : false,
			regions = app.layout.get('regions'),
			region_model = regions.get_by_name($region.data('name')),
			wrappers = ( is_parent_group ? group_model : region_model ).get('wrappers'),
			wrap_model = wrappers.get_by_wrapper_id($wrap.attr('id')),
			wrap_view = Upfront.data.wrapper_views[wrap_model.cid]
		;

		if ( col < 1 || row < 1 )
			return false;

		if ( !force ){
			$me.css('min-height', '');
			$object.css('min-height', '');
			var min_row = Math.ceil($me.outerHeight()/ed.baseline);
			row = row > min_row ? row : min_row;
			$me.css('min-height', row*ed.baseline);
			$object.css('min-height', (row-2)*ed.baseline);
		}


		col = col ? ( col > max.col ? max.col : col ) : me.col;
		row = row ? ( max.row && row > max.row ? max.row : row ) : me.row;

		ed.normalize(ed.els, ed.wraps);
		ed.update_position_data(ed.containment.$el);
		ed.update_class($me, ed.grid.class, col);
		model.set_property('row', row);
		// Also resize containing object if it's only one object
		var objects = model.get('objects');
		if ( objects && objects.length == 1 ){
			objects.each(function(object){
				object.set_property('row', row);
			});
		}
		// Update model value
		if ( axis != 'se' ){
			model.replace_class([
				ed.grid.class+col,
				//ed.grid.left_margin_class+margin.current.left,
				//ed.grid.top_margin_class+margin.current.top
			].join(' '));
		}
		else{
			model.replace_class(ed.grid.class+col);
			//ed.update_model_margin_classes($layout.find('.upfront-module, .upfront-module-group').not($me));
		}
		if ( typeof view.group_view != 'undefined' ) {
			ed.update_wrappers(view.group_view.model, view.group_view.$el);
		}
		else {
			ed.update_wrappers(region_model, region.$el);
		}

		view.trigger('entity:resize_stop', {row: row, col: col}, view, view.model);
		Upfront.Events.trigger("entity:resized", view, view.model);
		return true;
	},
	
	


	/**
	 * Create resizable
	 *
	 * @param {Object} view
	 * @param {Object} model
	 */
	create_wrapper_resizable: function(view, model){
		var app = this,
			ed = Upfront.Behaviors.GridEditor,
			$me = view.$el,
			$main = $(Upfront.Settings.LayoutEditor.Selectors.main),
			$layout = $main.find('.upfront-layout'),
			has_group,
			also_has_group,
			$resize,
			$resize_placeholder,
			$also_resize,
			also_model,
			also_view,
			$spacer_feed,
			is_spacer,
			also_is_spacer,
			axis,
			min_col,
			also_min_col,
			max_col,
			child_els,
			also_child_els
		;
		if ( Upfront.Application.mode.current !== Upfront.Application.MODE.THEME && model.get_property_value_by_name('disable_resize') )
			return false;
		if ( $me.data('ui-resizable') ){
			$me.resizable('option', 'disabled', false);
			return false;
		}
		//$me.append('<span class="upfront-resize-handle-wrapper upfront-resize-handle-w ui-resizable-handle ui-resizable-w">');
		//$me.append('<span class="upfront-resize-handle-wrapper upfront-resize-handle-e ui-resizable-handle ui-resizable-e">');
		$me.resizable({
			containment: "document",
			autoHide: false,
			delay: 50,
			handles: {
				w: '.upfront-resize-handle-wrapper-w',
				e: '.upfront-resize-handle-wrapper-e'
			},
			start: function(e, ui){
				ed.start(view, model);

				// Prevents quick scroll when resizing
				ed.resizing = window.scrollY;

				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					me = ed.get_wrap($me),
					//margin = $me.data('margin'),
					data = $(this).data('ui-resizable'),
					$wrappers = Upfront.Util.find_sorted($me.parent(), '> .upfront-wrapper'),
					aff_els = ed.get_affected_els(me, ed.wraps, [], true),
					also_resize
				;
					
				axis = data.axis ? data.axis : 'e';
				has_group = ( $me.find('> .upfront-module-group').length > 0 );
				max_col = me.col;
				min_col = ed.min_col;
				also_min_col = ed.min_col;
				is_spacer = ( $me.find('> .upfront-module-view > .upfront-module-spacer').length > 0 );

				child_els = [];
				$me.find('> .upfront-module-view > .upfront-module, > .upfront-module-group').each(function () {
					var child_model = ed.get_el_model($(this)),
						child_view = Upfront.data.module_views[child_model.cid]
					;
					if ( !child_view ) return;
					child_els.push({
						view: child_view,
						is_group: $(this).hasClass('upfront-module-group'),
						el: ed.get_el($(this))
					});
				});
				if ( has_group ) {
					_.each(child_els, function (child) {
						if ( !child.is_group ) return;
						var child_min_col = ed.get_group_min_col(child.view);
						min_col = child_min_col > min_col ? child_min_col : min_col;
					});
				}
				
				$resize = $('<div class="upfront-resize" style="height:'+me.height+'px;"></div>');
				$resize.css({
					height: me.height,
					width: me.width,
					minWidth: me.width,
					maxWidth: me.width,
					position: 'absolute'
				});
				if ( axis == 'w' ) {
					$resize.css({
						top: me.position.top,
						right: $('body').width() - me.position.right
					});
				}
				else {
					$resize.css({
						top: me.position.top,
						left: me.position.left
					});
				}
				$('body').append($resize);
				$also_resize = false;
				also_child_els = [];
				if ( axis == 'w' && me.outer_grid.left > ed.containment.grid.left ) {
					$also_resize = Upfront.Util.find_from_elements($wrappers, $me, '.upfront-wrapper:visible', true).first();
				}
				else if ( axis == 'e' && me.outer_grid.right < ed.containment.grid.right ) {
					$also_resize = Upfront.Util.find_from_elements($wrappers, $me, '.upfront-wrapper:visible', false).first();
				}
				if ( $also_resize && $also_resize.length ) {
					also_resize = ed.get_wrap($also_resize);
					also_is_spacer = ( $also_resize.find('> .upfront-module-view > .upfront-module-spacer').length > 0 );
					also_has_group = ( $also_resize.find('> .upfront-module-group').length > 0 ),
					also_model = model.collection.get_by_wrapper_id($also_resize.attr('id'));
					also_view = Upfront.data.wrapper_views[also_model.cid];

					$also_resize.find('> .upfront-module-view > .upfront-module, > .upfront-module-group').each(function () {
						var child_model = ed.get_el_model($(this)),
							child_view = Upfront.data.module_views[child_model.cid]
						;
						if ( !child_view ) return;
						also_child_els.push({
							view: child_view,
							is_group: $(this).hasClass('upfront-module-group'),
							el: ed.get_el($(this))
						});
					});
					if ( also_has_group ) {
						_.each(also_child_els, function (child) {
							if ( !child.is_group ) return;
							var child_min_col = ed.get_group_min_col(child.view);
							also_min_col = child_min_col > also_min_col ? child_min_col : also_min_col;
						});
					}

					max_col = me.col + also_resize.col;
					if ( !is_spacer && !also_is_spacer ) {
						max_col -= also_min_col;
					}
					else if ( is_spacer ) {
						max_col -= also_min_col;
						min_col = 0;
					}
					if ( also_is_spacer ) {
						also_min_col = 0;
					}
				}
				else {
					$also_resize = false;
					also_resize = false;
					also_model = false;
					also_view = false;
					also_is_spacer = false;
				}
				
				$resize_placeholder = $('<div class="upfront-resize-placeholder"></div>');
				$resize_placeholder.css({
					width: (((also_resize ? also_resize.col + me.col : me.col)/ed.containment.col)*100) + '%',
					height: ui.originalSize.height,
					position: 'relative'
				});
				if ( breakpoint && !breakpoint.default ) {
					$resize_placeholder.css('order', $me.css('order'));
				}
				if ( is_spacer || also_is_spacer ) {
					$spacer_feed = $('<div class="upfront-spacer-feed"></div>');
					$spacer_feed.css({
						width: ed.col_size,
						height: 'auto',
						top: 0,
						bottom: 0,
						position: 'absolute'
					});
					$resize_placeholder.append($spacer_feed);
				}
				// Refreshing the elements position
				_.each(ed.els, function(each, index){
					ed.els[index] = ed.get_position(each.$el);
				});
				// Refreshing the wrapper position
				_.each(ed.wraps, function(each, index){
					ed.wraps[index] = ed.get_position(each.$el);
				});
				ed.normalize(ed.els, ed.wraps);
				ed.update_position_data(ed.containment.$el);
				// Clear margin and assign an absolute position, hack into the resizable instance as well
				var me_pos = $me.position(),
					also_resize_pos = ( $also_resize ? $also_resize.position() : false );
				$me.css({
					marginLeft: 0,
					marginTop: 0,
					position: 'absolute',
					left: me_pos.left,
					top: me_pos.top,
					minHeight: ''
				});
				if ( $also_resize ) {
					$also_resize.css({
						marginLeft: 0,
						marginTop: 0,
						position: 'absolute',
						top: also_resize_pos.top,
						left: also_resize_pos.left
					});
				}
				data.originalPosition.left = me_pos.left;
				data.originalPosition.top = me_pos.top;
				data._updateCache({
					left: me_pos.left,
					top: me_pos.top
				});
				$resize_placeholder.insertBefore($me);
				
				// Trigger child events
				_.each(child_els, function (child) {
					child.view.trigger('entity:resize_start', {row: child.el.row, col: child.el.col, height: child.el.height, width: child.el.width}, child.view, child.view.model);
				});
				_.each(also_child_els, function (child) {
					child.view.trigger('entity:resize_start', {row: child.el.row, col: child.el.col, height: child.el.height, width: child.el.width}, child.view, child.view.model);
				});
				
				// Trigger main event
				view.trigger('entity:wrapper:resize_start', {row: me.row, col: me.col, height: me.height, width: me.width}, view, view.model);
				if ( also_view ) {
					also_view.trigger('entity:wrapper:resize_start', {row: also_resize.row, col: also_resize.col, height: also_resize.height, width: also_resize.width}, also_view, also_view.model);
				}
				Upfront.Events.trigger("entity:wrapper:resize_start", view, view.model, also_view, also_view.model);
			},
			resize: function(e, ui){
				var $region = $me.closest('.upfront-region'),
					me = ed.get_wrap($me),
					also_resize = ( $also_resize ? ed.get_wrap($also_resize) : false ),
					region = ed.get_region($region),
					min_w = min_col*ed.col_size,
					w = ( current_col > max_col ? Math.round(max_col*ed.col_size) : ( min_w > ui.size.width ? min_w : ui.size.width ) ),
					current_col = Math.round(w/ed.col_size),
					h = ( (ui.size.height > 15 ? ui.size.height : 0) || ui.originalSize.height ),
					l = ( axis == 'w' ? ui.originalPosition.left+ui.originalSize.width-w : ui.position.left ),
					rsz_col = ( current_col > max_col ? max_col : current_col ),
					also_col = max_col - rsz_col + also_min_col,
					also_w = ( ( max_col + also_min_col ) * ed.col_size ) - w
				;
				$me.css({
					left: l,
					height: h,
					width: w,
					minWidth: w,
					maxWidth: w
				});
				$me.data('resize-col', rsz_col);
				// Visual feedback for deleting spacer
				if ( is_spacer && w < ed.col_size ) {
					var opacity = 0.5 * Math.round((ed.col_size-w)/ed.col_size*100)/100;
					$spacer_feed.css({
						left: ( axis == 'e' ? 0 : 'auto' ),
						right: ( axis == 'e' ? 'auto' : 0 ),
						backgroundColor: 'rgba(200, 0, 0, ' + opacity + ')'
					});
				}
				if ( $also_resize ) {
					$also_resize.css({
						width: also_w,
						minWidth: also_w,
						maxWidth: also_w
					});
					if ( axis == 'e' ) {
						$also_resize.css('margin-left', also_resize.width - also_w);
					}
					$also_resize.data('resize-col', also_col);
					// Visual feedback for deleting spacer
					if ( also_is_spacer && also_w < ed.col_size ) {
						var opacity = 0.5 * Math.round((ed.col_size-also_w)/ed.col_size*100)/100;
						$spacer_feed.css({
							left: ( axis == 'w' ? 0 : 'auto' ),
							right: ( axis == 'w' ? 'auto' : 0 ),
							backgroundColor: 'rgba(200, 0, 0, ' + opacity + ')'
						});
					}
				}
				$resize.css({
					height: h,
					width: rsz_col*ed.col_size,
					minWidth: rsz_col*ed.col_size,
					maxWidth: rsz_col*ed.col_size,
				});
				
				// Trigger child events
				_.each(child_els, function (child) {
					child.view.trigger('entity:resizing', {row: child.el.row, col: rsz_col, height: child.el.height, width: rsz_col*ed.col_size}, child.view, child.view.model);
				});
				_.each(also_child_els, function (child) {
					child.view.trigger('entity:resizing', {row: child.el.row, col: also_col, height: child.el.height, width: also_col*ed.col_size}, child.view, child.view.model);
				});
				
				// Trigger main event
				view.trigger('entity:wrapper:resizing', {row: me.row, col: rsz_col, height: me.height, width: rsz_col*ed.col_size}, view, view.model);
				if ( also_view ) {
					also_view.trigger('entity:wrapper:resizing', {row: also_resize.row, col: also_col, height: also_resize.height, width: also_col*ed.col_size}, also_view, also_view.model);
				}
			},
			stop: function(e, ui){
				Upfront.Events.trigger("entity:wrapper:pre_resize_stop", view, view.model, ui);
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					$region = $me.closest('.upfront-region'),
					me = ed.get_wrap($me),
					also_resize = ( $also_resize ? ed.get_wrap($also_resize) : false ),
					aff_els = ed.get_affected_els(me, ed.wraps, [], true),
					resize_limit = ed.get_resize_limit(aff_els, ed.containment),
					prev_col = Math.ceil(ui.originalSize.width/ed.col_size),
					rsz_col = $me.data('resize-col'),
					also_col = ( $also_resize ? $also_resize.data('resize-col') : 0 ),
					regions = app.layout.get('regions'),
					region = regions.get_by_name($region.data('name')),
					first_in_row = ( axis == 'w' && me.outer_grid.left == ed.containment.grid.left ),
					last_in_row = ( axis == 'e' && me.outer_grid.right == ed.containment.grid.right )
				;

				// Prevents quick scroll when resizing
				ed.resizing = false;

				$resize_placeholder.remove();
				$resize.remove();

				// Make sure CSS is reset, to fix bug when it keeps all resize CSS for some reason
				$me.css({
					width: '',
					minWidth: '',
					maxWidth: '',
					height: '',
					position: '',
					top: '',
					left: '',
					marginLeft: '',
					marginTop: ''
				});
				if ( $also_resize ) {
					$also_resize.css({
						width: '',
						minWidth: '',
						maxWidth: '',
						height: '',
						position: '',
						top: '',
						left: '',
						marginLeft: '',
						marginTop: ''
					});
				}

				// If this is placed on the side, let's add spacer
				if ( !also_model && ( first_in_row || last_in_row ) && max_col-rsz_col > 0 ) {
					view.add_spacer( ( first_in_row ? 'left' : 'right' ), max_col-rsz_col, max_col );
				}
				else {
					// Else if rsz_col is 0, remove model, otherwise update model
					if ( rsz_col > 0 ) {
						if ( breakpoint && !breakpoint.default ) {
							model.set_breakpoint_property('edited', true, true);
							model.set_breakpoint_property('col', rsz_col);
							_.each(child_els, function (child) {
								child.view.model.set_breakpoint_property('edited', true, true);
								child.view.model.set_breakpoint_property('col', rsz_col);
							});
						}
						else {
							model.replace_class(ed.grid.class+rsz_col);
							_.each(child_els, function (child) {
								child.view.model.replace_class(ed.grid.class+rsz_col);
							});
						}
					}
					else if ( is_spacer ) {
						model.collection.remove(model);
						_.each(child_els, function (child) {
							child.view.model.collection.remove(child.view.model);
						});
					}
					if ( also_model ) {
						// Do the same if also_col is 0, remove model, otherwise update model
						if ( also_col > 0 ) {
							if ( breakpoint && !breakpoint.default ) {
								also_model.set_breakpoint_property('edited', true, true);
								also_model.set_breakpoint_property('col', also_col);
								_.each(also_child_els, function (child) {
									child.view.model.set_breakpoint_property('edited', true, true);
									child.view.model.set_breakpoint_property('col', also_col);
								});
							}
							else {
								also_model.replace_class(ed.grid.class+also_col);
								_.each(also_child_els, function (child) {
									child.view.model.replace_class(ed.grid.class+also_col);
								});
							}
						}
						else if ( also_is_spacer ) {
							also_model.collection.remove(also_model);
							_.each(also_child_els, function (child) {
								child.view.model.collection.remove(child.view.model);
							});
						}
					}
				}

				// Let's normalize
				ed.update_position_data(ed.containment.$el);
				ed.normalize(ed.els, ed.wraps);

				$me.removeData('resize-col');
				if ( $also_resize ) {
					$also_resize.removeData('resize-col');
				}

				// Trigger child events
				_.each(child_els, function (child) {
					child.view.trigger('entity:resize_stop', {row: child.el.row, col: rsz_col, height: child.el.height, width: rsz_col*ed.col_size}, child.view, child.view.model);
				});
				_.each(also_child_els, function (child) {
					child.view.trigger('entity:resize_stop', {row: child.el.row, col: also_col, height: child.el.height, width: also_col*ed.col_size}, child.view, child.view.model);
				});
				
				// Trigger main event
				view.trigger('entity:wrapper:resize_stop', {row: me.row, col: rsz_col, height: me.height, width: rsz_col*ed.col_size}, view, view.model);
				view.trigger('entity:wrapper:resize', {col: rsz_col}, view, view.model);
				if ( also_view ) {
					also_view.trigger('entity:wrapper:resize_stop', {row: also_resize.row, col: also_col, height: also_resize.height, width: rsz_col*ed.col_size}, also_view, also_view.model);
					also_view.trigger('entity:wrapper:resize', {col: also_col}, also_view, also_view.model);
				}
				Upfront.Events.trigger("entity:wrapper:resize_stop", view, view.model, also_view, also_view.model, ui);
				Upfront.Events.trigger("entity:wrapper:resized", view, view.model, also_view, also_view.model);
			}
		});
	},

	get_group_min_col: function (group_view) {
		var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
			ed = Upfront.Behaviors.GridEditor,
			modules = group_view.model.get('modules'),
			wrappers = group_view.model.get('wrappers'),
			col = ( !breakpoint || breakpoint.default ) ? ed.get_class_num(group_view.$el, ed.grid.class) : group_view.$el.data('breakpoint_col'),
			lines = ed.parse_modules_to_lines(modules, wrappers, ( breakpoint ? breakpoint.id : 'desktop' ), col),
			min_col = ed.min_col
		;
		_.each(lines, function (line) {
			var line_min_col = 0;
			_.each(line.wrappers, function (w) {
				if (w.spacer ) line_min_col += 1; // Spacer minimum column is 1
				else line_min_col += ed.min_col; // Element minimum column depend to ed.min_col
			});
			if ( line_min_col > min_col ) min_col = line_min_col;
		});
		return min_col;
	},

	/**
	 * Create draggable
	 *
	 * @param {Object} view
	 * @param {Object} model
	 */
	create_draggable: function (view, model) {
		var ed = Upfront.Behaviors.GridEditor;
		if ( ed.drag_instances[view.cid] ) {
			// Instance already there, run setup again
			ed.drag_instances[view.cid].setup();
		}
		else {
			// Create new instance
			ed.drag_instances[view.cid] = new DragDrop(view, model);
			model.on('remove', function(){
				delete ed.drag_instances[view.cid];
			});
		}
	},

	toggle_draggables: function (enable) {
		$('.upfront-editable_entity.ui-draggable').draggable('option', 'disabled', (!enable));
	},

	/**
	 * Parse modules collection into the correct order by breakpoint
	 */
	parse_modules_to_lines: function (modules, wrappers, breakpoint_id, col) {
		var ed = Upfront.Behaviors.GridEditor,
			all_wrappers = {},
			sorted_wrappers = [],
			lines = [],
			line_col = 0,
			line = 0
		;
		modules.each(function(module, i){
			var wrapper_id = module.get_wrapper_id(),
				wrapper = wrappers.get_by_wrapper_id(wrapper_id),
				wrapper_breakpoint = wrapper ? wrapper.get_property_value_by_name('breakpoint') : false,
				wrapper_breakpoint_data = ( wrapper_breakpoint && breakpoint_id in wrapper_breakpoint ) ? wrapper_breakpoint[breakpoint_id] : {},
				wrapper_class = wrapper ? wrapper.get_property_value_by_name('class') : '',
				wrapper_col = ed.get_class_num(wrapper_class, ed.grid.class),
				is_clear = !!wrapper_class.match(/clr/),
				breakpoint = module.get_property_value_by_name('breakpoint'),
				breakpoint_data = ( breakpoint && breakpoint_id in breakpoint ) ? breakpoint[breakpoint_id] : {},
				default_hide = module.get_property_value_by_name('default_hide'),
				hide = module.get_property_value_by_name('hide'),
				module_class = module.get_property_value_by_name('class'),
				module_col = ed.get_class_num(module_class, ed.grid.class),
				is_spacer = !!module_class.match(/upfront-module-spacer/),
				order = i,
				wrapper_order = i,
				module_obj = {}
			;
			if ( !wrapper ) return;
			if ( breakpoint_id != 'desktop' ) {
				hide = ( "hide" in breakpoint_data ) ? breakpoint_data.hide : default_hide;
				module_col = ( "col" in breakpoint_data ) ? breakpoint_data.col : module_col;
				order = ( "order" in breakpoint_data ) ? breakpoint_data.order * 10000 + order : order;
				wrapper_col = ( "col" in wrapper_breakpoint_data ) ? wrapper_breakpoint_data.col : wrapper_col;
				wrapper_order = ( "order" in wrapper_breakpoint_data ) ? wrapper_breakpoint_data.order * 10000 + wrapper_order : wrapper_order;
				is_clear = ( "clear" in wrapper_breakpoint_data ) ? wrapper_breakpoint_data.clear : is_clear;
			}
			if ( hide === false ) hide = default_hide;
			if ( hide ) return;
			module_obj = {
				model: module,
				col: module_col,
				order: order,
				spacer: is_spacer
			};
			if ( module_col > wrapper_col ) wrapper_col = module_col;
			if ( wrapper_col > col ) wrapper_col = col;
			if ( wrapper_id in all_wrappers ) {
				all_wrappers[wrapper_id].modules.push(module_obj);
				all_wrappers[wrapper_id].col = wrapper_col;
			}
			else {
				all_wrappers[wrapper_id] = {
					model: wrapper,
					modules: [module_obj],
					order: wrapper_order,
					col: wrapper_col,
					clear: is_clear,
					spacer: is_spacer
				};
			}
		});
		sorted_wrappers = _.sortBy(all_wrappers, function(wrapper, i){
			return wrapper.order;
		});
		_.each(sorted_wrappers, function(wrapper, i){
			if ( ( i > 0 && wrapper.clear ) || ( line_col > 0 && line_col + wrapper.col > col ) ) { // this is new line
				lines[line].col = line_col;
				line++;
				line_col = 0;
			}
			if ( _.isUndefined(lines[line]) ) {
				lines[line] = {
					wrappers: [],
					col: 0
				};
			}
			line_col += wrapper.col;
			lines[line].wrappers.push(wrapper);
			lines[line].col = line_col;
		});
		return lines;
	},

	/**
	 * Call this to normalize module placement on remove
	 */
	normalize_module_remove: function (view, module, modules, wrapper, wrappers) {
		var app = Upfront.Application,
			ed = Upfront.Behaviors.GridEditor,
			index = modules.indexOf(module),
			breakpoints = Upfront.Views.breakpoints_storage.get_breakpoints().get_enabled()
		;
		_.each(breakpoints, function(each){
			var breakpoint = each.toJSON(),
				lines = ed.parse_modules_to_lines(modules, wrappers, breakpoint.id, breakpoint.columns),
				split_prev = false,
				split_next = false,
				all_wrappers = [],
				spacer_wrappers = [],
				line, my_wrapper, prev_wrapper, next_wrapper,
				prev_wrapper_class, next_wrapper_class
			;
			_.each(lines, function (each) {
				if ( line ) return;
				prev_wrapper = false;
				next_wrapper = false;
				_.each(each.wrappers, function (w) {
					if ( my_wrapper && !next_wrapper ) next_wrapper = w;
					_.each(w.modules, function (m) {
						if ( module == m.model ) {
							my_wrapper = w;
							line = each;
						}
					});
					if ( !my_wrapper ) prev_wrapper = w;
				});
			});
			if ( !line ) return;
			if ( next_wrapper ) {
				next_wrapper_class = next_wrapper.model.get_property_value_by_name('class');
				if ( !next_wrapper_class.match(/clr/g) ){
					split_next = true;
				}
			}
			if ( prev_wrapper ) {
				prev_wrapper_class = prev_wrapper.model.get_property_value_by_name('class');
				if ( prev_wrapper_class.match(/clr/g) && !split_next ) {
					split_prev = true;
				}
			}
			_.each(line.wrappers, function (w) {
				if ( w == my_wrapper ) return;
				all_wrappers.push(w);
				if ( w.spacer ) spacer_wrappers.push(w);
			});
			if ( all_wrappers.length >= 2 ) {
				split_next = false;
			}

			if ( my_wrapper.modules.length == 1 ) {
				var total_col = my_wrapper.col,
					new_col = 0,
					remaining_col = 0
				;
				_.each(all_wrappers, function (each_wrapper) {
					if ( _.contains(spacer_wrappers, each_wrapper) ) return;
					total_col += each_wrapper.col;
				});
				if ( all_wrappers.length == spacer_wrappers.length ) {
					// All wrappers is spacers, just remove them as we don't need it anymore
					_.each(all_wrappers, function (each_wrapper, id) {
						_.each(each_wrapper.modules, function (each_module) {
							modules.remove(each_module.model);
						});
						wrappers.remove(each_wrapper.model);
					});
				}
				else {
					// Otherwise split columns evenly and ignore spacer columns
					new_col = Math.floor(total_col/(all_wrappers.length-spacer_wrappers.length));
					remaining_col = total_col - ((all_wrappers.length-spacer_wrappers.length) * new_col);
					// Apply the new col
					_.each(all_wrappers, function (each_wrapper, id) {
						if ( _.contains(spacer_wrappers, each_wrapper) ) return;
						var each_wrapper_class = each_wrapper.model.get_property_value_by_name('class'),
							each_wrapper_breakpoint = each_wrapper.model.get_property_value_by_name('breakpoint'),
							each_wrapper_breakpoint_data = ( each_wrapper_breakpoint && breakpoint.id in each_wrapper_breakpoint ) ? each_wrapper_breakpoint[breakpoint.id] : {},
							apply_col =  new_col
						;
						// Distribute remaining_col
						if ( remaining_col > 0 ) {
							apply_col += 1;
							remaining_col -= 1;
						}
						if ( breakpoint.default ) {
							each_wrapper.model.replace_class(
								ed.grid.class + apply_col +
								( id == 0 && !each_wrapper_class.match(/clr/g) ? ' clr' : '' )
							);
							_.each(each_wrapper.modules, function (each_module) {
								each_module.model.replace_class(ed.grid.class + apply_col);
							});
						}
						else {
							each_wrapper_breakpoint_data.col = apply_col;
							if ( id == 0 && !each_wrapper_breakpoint_data.clear ) {
								each_wrapper_breakpoint_data.clear = true;
							}
							each_wrapper.model.set_property('breakpoint', Upfront.Util.clone(each_wrapper_breakpoint));
							_.each(each_wrapper.modules, function (each_module) {
								var each_module_breakpoint = each_module.model.get_property_value_by_name('breakpoint'),
									each_module_breakpoint_data = ( each_module_breakpoint && breakpoint.id in each_module_breakpoint ) ? each_module_breakpoint[breakpoint.id] : {}
								;
								each_module_breakpoint_data.col = apply_col;
								each_module.model.set_property('breakpoint', Upfront.Util.clone(each_module_breakpoint));
							});
						}
					});
				}
			}
			if ( !breakpoint.default ) return;
			if ( split_prev || split_next ){
				var current_wrapper = false;
				_.each(( split_prev ? prev_wrapper.modules : next_wrapper.modules ), function (each_module, id) {
					var each_module_class = each_module.model.get_property_value_by_name('class'),
						each_module_col = ed.get_class_num(each_module_class, ed.grid.class),
						each_module_view = Upfront.data.module_views[each_module.model.cid],
						each_wrapper = split_prev ? prev_wrapper : next_wrapper,
						each_wrapper_view = Upfront.data.wrapper_views[each_wrapper.model.cid],
						current_wrapper_view = current_wrapper ? Upfront.data.wrapper_views[current_wrapper.cid] : each_wrapper_view
					;
					if ( id > 0 ){
						var wrapper_id = Upfront.Util.get_unique_id("wrapper");
							wrap_model = new Upfront.Models.Wrapper({
								"name": "",
								"properties": [
									{"name": "wrapper_id", "value": wrapper_id},
									{"name": "class", "value": ed.grid.class+(each_module_col) + ' clr'}
								]
							}),
							wrap_view = new Upfront.Views.Wrapper({model: wrap_model})
						;
						wrappers.add(wrap_model);
						wrap_view.parent_view = each_module_view.parent_view;
						wrap_view.render();
						wrap_view.$el.append(each_module_view.$el);
						current_wrapper_view.$el.after(wrap_view.$el);
						Upfront.data.wrapper_views[wrap_model.cid] = wrap_view;
						each_module.model.set_property('wrapper_id', wrapper_id, true);
						current_wrapper = wrap_model;
					}
				});
			}
		});
	},

	/**
	 * Call this to adapt module to the breakpoint
	 */
	adapt_to_breakpoint: function (modules, wrappers, breakpoint_id, parent_col, silent) {
		var app = Upfront.Application,
			ed = Upfront.Behaviors.GridEditor,
			line_col = 0,
			line = -1,
			lines = [],
			modules_data = [],
			set_wrappers_col = {}, // keep track of set wrappers col
			silent = ( silent === true ) ? true : false,
			wrapper_index = 0
		;
		modules.each(function(module){
			var data = module.get_property_value_by_name('breakpoint'),
				module_class = module.get_property_value_by_name('class'),
				module_default_hide = module.get_property_value_by_name('default_hide'),
				module_hide = ( data[breakpoint_id] && "hide" in data[breakpoint_id] ) ? data[breakpoint_id].hide : module_default_hide,
				module_col = ed.get_class_num(module_class, ed.grid.class),
				wrapper = wrappers.get_by_wrapper_id(module.get_wrapper_id()),
				wrapper_data = wrapper && wrapper.get_property_value_by_name('breakpoint'),
				wrapper_class = wrapper && wrapper.get_property_value_by_name('class'),
				is_clear = wrapper && ( !!wrapper_class.match(/clr/) || line_col === 0 );
			if ( !wrapper )	return;
			if ( module_hide ) return;
			line_col += module_col; // Elements in a line have to fit the whole region now
			if ( line_col > parent_col ){
				is_clear = true;
			}
			if ( is_clear ){
				line_col = module_col; // Elements in a line have to fit the whole region now
				line++;
				lines[line] = [];
			}
			module_col = module_col > parent_col ? parent_col : module_col;
			lines[line].push({
				clear: is_clear,
				spacer: !!module_class.match(/upfront-module-spacer/),
				module: module,
				col: module_col,
				left: 0, // Elements in a line have to fit the whole region now
				wrapper: wrapper,
				breakpoint: Upfront.Util.clone( data || {} ),
				wrapper_breakpoint: Upfront.Util.clone( wrapper_data || {} )
			});
		});
		_.each(lines, function(line_modules){
			var line_col = _.map(line_modules, function(data){ 
					return data.col; // Elements in a line have to fit the whole region now
				}).reduce(function(sum, col){ 
					return sum + col;
				}),
				spacer_col = _.map(line_modules, function(data){
					return data.spacer ? data.col : 0;
				}).reduce(function(sum, col){
					return sum + col;
				})
			;
			_.each(line_modules, function(data, index){
				var new_col = 0,
					wrapper_col = 0;
				if ( ! _.isObject(data.breakpoint[breakpoint_id]) ) {
					data.breakpoint[breakpoint_id] = { edited: false };
				}
				if ( !_.isObject(data.wrapper_breakpoint[breakpoint_id]) ) {
					data.wrapper_breakpoint[breakpoint_id] = { edited: false };
				}
				if ( !data.breakpoint[breakpoint_id].edited ){
					// Elements in a line have to fit evenly the whole region now
					new_col = (line_col === parent_col) ? data.col : parent_col / line_modules.length;
					data.breakpoint[breakpoint_id].left = 0; 
					data.breakpoint[breakpoint_id].col = new_col;
					data.breakpoint[breakpoint_id].order = index;
					data.module.set_property('breakpoint', data.breakpoint, silent);
				}
				else {
					new_col = typeof data.breakpoint[breakpoint_id].col == 'number' ? data.breakpoint[breakpoint_id].col : data.col;
				}
				if ( !_.isUndefined(set_wrappers_col[data.wrapper.get_wrapper_id()]) ) {
					wrapper_col = set_wrappers_col[data.wrapper.get_wrapper_id()];
				}
				else {
					wrapper_index++;
				}
				if ( wrapper_col < new_col ) {
					wrapper_col = new_col;
					data.wrapper_breakpoint[breakpoint_id].col = wrapper_col;
					set_wrappers_col[data.wrapper.get_wrapper_id()] = wrapper_col;
					if ( !data.wrapper_breakpoint[breakpoint_id].edited ) {
						data.wrapper_breakpoint[breakpoint_id].order = wrapper_index-1;
						data.wrapper_breakpoint[breakpoint_id].clear = ( index === 0 );
					}
					data.wrapper.set_property('breakpoint', data.wrapper_breakpoint, silent);
				}
			});
		});
	},

	/**
	 * Call this to adapt region to the breakpoint
	 */
	adapt_region_to_breakpoint: function (regions, breakpoint_id, col, silent) {
		var app = Upfront.Application,
			ed = Upfront.Behaviors.GridEditor,
			default_breakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_default().toJSON();
			line_col = 0,
			silent = ( silent === true ) ? true : false;
		regions.each(function(region){
			var data = Upfront.Util.clone( region.get_property_value_by_name('breakpoint') || {} ),
				sub = region.get('sub');
			if ( !_.isObject(data[breakpoint_id]) )
				data[breakpoint_id] = { edited: false };
			if ( !data[breakpoint_id].edited ){
				if ( region.is_main() || ( !sub || sub.match(/^(left|right)$/) )  ){ 
					// Sidebar/main region, let's make the column to full width on responsive
					data[breakpoint_id].col = default_breakpoint.columns;
				}
			}
			region.set_property('breakpoint', data, silent);
		});
	},


	/**
	 * Create region resizable
	 *
	 * @param {Object} view
	 * @param {Object} model
	 */
	create_region_resizable: function(view, model){
		var app = this,
			ed = Upfront.Behaviors.GridEditor,
			$me = view.$el,
			$main = $(Upfront.Settings.LayoutEditor.Selectors.main),
			$layout = $main.find('.upfront-layout'),
			collection = model.collection,
			index = collection.indexOf(model),
			total = collection.size()-1, // total minus shadow region
			sub = model.get('sub'),
			container = model.get('container'),
			directions, handles, axis,
			fixed_pos = {},
			get_fixed_pos = function () {
				var pos = {
						top: model.get_property_value_by_name('top'),
						left: model.get_property_value_by_name('left'),
						bottom: model.get_property_value_by_name('bottom'),
						right: model.get_property_value_by_name('right'),
						width: model.get_property_value_by_name('width'),
						height: model.get_property_value_by_name('height')
					};
				pos.is_top = ( typeof pos.top == 'number' );
				pos.is_left = ( typeof pos.left == 'number' );
				pos.is_bottom = ( typeof pos.bottom == 'number' );
				pos.is_right = ( typeof pos.right == 'number' );
				return pos;
			}
		;
		if ( $me.data('ui-resizable') )
			return false;
		if ( !model.is_main() && sub && !sub.match(/^(fixed|left|right)$/) )
			return;
		if ( model.is_main() ){
			directions = ['s'];
			handles = { s: '.upfront-region-resize-handle-s' };
		}
		else if ( sub == 'left' ){
			directions = ['e', 's'];
			handles = { e: '.upfront-region-resize-handle-e', s: '.upfront-region-resize-handle-s' };
		}
		else if ( sub == 'right' ) {
			directions = ['w', 's'];
			handles = { w: '.upfront-region-resize-handle-w', s: '.upfront-region-resize-handle-s' };
		}
		else if ( sub == 'fixed' ) {
			fixed_pos = get_fixed_pos();
			if ( ( fixed_pos.is_top && fixed_pos.is_left ) || ( fixed_pos.is_bottom && fixed_pos.is_right ) ){
				directions = ['nw', 'se'];
				handles = { nw: '.upfront-region-resize-handle-nw', se: '.upfront-region-resize-handle-se' };
			}
			else{
				directions = ['ne', 'sw'];
				handles = { ne: '.upfront-region-resize-handle-ne', sw: '.upfront-region-resize-handle-sw' };
			}
		}
		_.each(directions, function(direction){
			var icon = ( direction.match(/^(e|w|s|n)$/) ) ? 'upfront-icon-control-region upfront-icon-control-region-resize upfront-icon-control-region-resize-' + direction : 'upfront-icon-control upfront-icon-control-resize upfront-icon-control-resize-' + direction;
			$me.append('<div class="' + icon + ' upfront-region-resize-handle upfront-region-resize-handle-' + direction + ' ui-resizable-handle ui-resizable-' + direction + '"></div>');
		});
		$me.resizable({
			containment: "document",
			//handles: "n, e, s, w",
			handles: handles,
			helper: "region-resizable-helper",
			disabled: true,
			zIndex: 9999999,
			start: function(e, ui){
				var col = ed.get_class_num($me, ed.grid.class),
					data = $(this).data('ui-resizable'),
					$helper = ui.helper;
				axis = data.axis ? data.axis : 'se';

				// Prevents quick scroll when resizing
				ed.resizing = window.scrollY;

				$(this).resizable('option', 'minWidth', ed.col_size*3);
				if ( sub != 'fixed' ){
					$(this).resizable('option', 'maxWidth', ed.col_size*10);
				}
				else {
					$(this).resizable('option', 'minHeight', ed.baseline*3);
					$me.css('position', '');
					view.update_region_position();
					fixed_pos = get_fixed_pos();
					// Hack into resizable instance
					var me_pos = $me.position();
					data.originalPosition.left = me_pos.left;
					data.originalPosition.top = me_pos.top;
					data.originalSize.width = fixed_pos.width;
					data.originalSize.height = fixed_pos.height;
					data._updateCache({
						left: me_pos.left,
						top: me_pos.top
					});
					$helper.css({
						marginLeft: 0,
						marginTop: 0,
						left: me_pos.left,
						top: me_pos.top,
						position: 'fixed'
					});
				}
				Upfront.Events.trigger("entity:region:resize_start", view, view.model);
			},
			resize: function(e, ui){
				var $helper = ui.helper;
				if ( sub != 'fixed' ){
					if ( axis == 's' ) {
						var current_row = Math.abs(Math.ceil(ui.size.height/ed.baseline)),
							h = Math.round(current_row*ed.baseline);
						$helper.css({
							height: h,
							width: ui.originalSize.width,
							minWidth: ui.originalSize.width,
							maxWidth: ui.originalSize.width
						});
						view.update_size_hint(ui.originalSize.width, h);
						$me.data('resize-row', current_row);
					}
					else {
						var col = ed.get_class_num($me, ed.grid.class),
							$prev = $me.prevAll('.upfront-region:first'),
							$next = $me.nextAll('.upfront-region:first'),
							prev_col = $prev.size() > 0 ? ed.get_class_num($prev, ed.grid.class) : 0,
							next_col = $next.size() > 0 ? ed.get_class_num($next, ed.grid.class) : 0,
							max_col = col + ( next_col > prev_col ? next_col : prev_col ),
							current_col = Math.abs(Math.ceil(ui.size.width/ed.col_size)),
							rsz_col = ( current_col > max_col ? max_col : current_col ),
							w = Math.round(rsz_col*ed.col_size)
						;
						$helper.css({
							height: ui.originalSize.height,
							width: w,
							minWidth: w,
							maxWidth: w,
							marginLeft: axis == 'w' ? ui.size.width-w : 0
						});
						view.update_size_hint(w, ui.originalSize.height);
						$me.data('resize-col', rsz_col);
					}
				}
				else {
					var offset = $me.offset(),
						main_offset = $main.offset(),
						height = $me.height(),
						width = $me.width(),
						max_height = max_width = false,
						rsz_width, rsz_height;
					if ( fixed_pos.is_top )
						max_height = axis == 'nw' || axis == 'ne' ? fixed_pos.top + height : false;
					if ( !fixed_pos.is_top && fixed_pos.is_bottom )
						max_height = axis == 'se' || axis == 'sw' ? fixed_pos.bottom + height : false;
					if ( fixed_pos.is_left )
						max_width = axis == 'nw' || axis == 'sw' ? fixed_pos.left + width : false;
					if ( !fixed_pos.is_left && fixed_pos.is_right )
						max_width = axis == 'se' || axis == 'ne' ? fixed_pos.right + width : false;
					rsz_height = Math.round( max_height && ui.size.height > max_height ? max_height : ui.size.height );
					rsz_width = Math.round( max_width && ui.size.width > max_width ? max_width : ui.size.width );
					$helper.css({
						height: rsz_height,
						width: rsz_width
					});
					view.update_size_hint(rsz_width, rsz_height, $helper);
					$me.data('resize-height', rsz_height);
					$me.data('resize-width', rsz_width);
				}
			},
			stop: function(e, ui){
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					model_breakpoint, breakpoint_data;
				// Prevents quick scroll when resizing
				ed.resizing = false;

				// Make sure CSS is reset, to fix bug when it keeps all resize CSS for some reason
				$me.css({
					width: '',
					minWidth: '',
					maxWidth: '',
					height: '',
					position: '',
					top: '',
					left: '',
					right: '',
					bottom: ''
				});
				if ( sub != 'fixed' ){
					var rsz_col = $me.data('resize-col'),
						rsz_row = $me.data('resize-row');
					if ( !breakpoint || breakpoint.default ){
						if ( rsz_col )
							model.set_property('col', rsz_col);
						if ( rsz_row )
							model.set_property('row', rsz_row);
					}
					else {
						if ( rsz_col || rsz_row ){
							model_breakpoint = Upfront.Util.clone(model.get_property_value_by_name('breakpoint') || {});
							if ( !_.isObject(model_breakpoint[breakpoint.id]) )
								model_breakpoint[breakpoint.id] = {};
							breakpoint_data = model_breakpoint[breakpoint.id];
							breakpoint_data.edited = true;
							if ( rsz_col )
								breakpoint_data.col = rsz_col;
							if ( rsz_row )
								breakpoint_data.row = rsz_row;
							model.set_property('breakpoint', model_breakpoint);
						}
					}
					$me.removeData('resize-col');
					$me.removeData('resize-row');
				}
				else {
					var rsz_width = $me.data('resize-width'),
						rsz_height = $me.data('resize-height'),
						rsz_col = Math.floor(rsz_width/ed.col_size);
					if ( ( axis == 'nw' || axis == 'ne' ) && fixed_pos.is_top )
						model.set_property('top', fixed_pos.top + fixed_pos.height - rsz_height);
					if ( ( axis == 'se' || axis == 'sw' ) && !fixed_pos.is_top && fixed_pos.is_bottom )
						model.set_property('bottom', fixed_pos.bottom + fixed_pos.height - rsz_height);
					if ( ( axis == 'nw' || axis == 'sw') && fixed_pos.is_left )
						model.set_property('left', fixed_pos.left + fixed_pos.width - rsz_width);
					if ( ( axis == 'se' || axis == 'ne' ) && !fixed_pos.is_left && fixed_pos.is_right )
						model.set_property('right', fixed_pos.right + fixed_pos.width - rsz_width);
					model.set_property('width', rsz_width, true);
					model.set_property('height', rsz_height, true);
					model.set_property('col', rsz_col, true);
					model.get('properties').trigger('change');
					$me.removeData('resize-width');
					$me.removeData('resize-height');
				}
				Upfront.Events.trigger("entity:region:resize_stop", view, view.model);
			}
		});
	},

	create_region_draggable: function(view, model) {
		if ( !model.get("container") || model.get("container") == model.get("name") )
			return;
		var app = this,
			ed = Upfront.Behaviors.GridEditor,
			$me = view.$el,
			$main = $(Upfront.Settings.LayoutEditor.Selectors.main),
			$layout = $main.find('.upfront-layout'),
			container_view = view.parent_view.get_container_view(model),
			sub = model.get('sub'),
			fixed_pos = {},
			restrict = false,
			get_fixed_pos = function () {
				var pos = {
						top: model.get_property_value_by_name('top'),
						left: model.get_property_value_by_name('left'),
						bottom: model.get_property_value_by_name('bottom'),
						right: model.get_property_value_by_name('right'),
						width: model.get_property_value_by_name('width'),
						height: model.get_property_value_by_name('height')
					};
				pos.is_top = ( typeof pos.top == 'number' );
				pos.is_left = ( typeof pos.left == 'number' );
				pos.is_bottom = ( typeof pos.bottom == 'number' );
				pos.is_right = ( typeof pos.right == 'number' );
				return pos;
			},
			move = {},
			position = ''
		;
		if ( sub != 'fixed' )
			return false;
		if ( $me.data('ui-draggable') )
			return false;

		$me.draggable({
			disabled: true,
			revert: true,
			revertDuration: 0,
			zIndex: 100,
			helper: 'clone',
			delay: 15,
			scroll: false,
			iframeFix: true,
			start: function (e, ui) {
				var $helper = ui.helper,
					width = $me.width(),
					height = $me.height();
				$helper.css('width', width);
				$helper.css('height', height);
				$me.hide();
				fixed_pos = get_fixed_pos();
				restrict = model.get('restrict_to_container');
				position = $helper.css('position');
			},
			drag: function (e, ui) {
				var $helper = ui.helper,
					main_offset = $main.offset(),
					main_width = $main.width(),
					container_offset = container_view.$el.offset(),
					container_height = container_view.$el.height(),
					container_bottom = container_offset.top + container_height,
					scroll_top = $(window).scrollTop(),
					win_height = $(window).height(),
					scroll_bottom = scroll_top + win_height,
					main_x = ( main_width / 2 ) + main_offset.left,
					main_y = ( position == 'fixed' || container_height > win_height ) ? win_height / 2 : container_height / 2,
					left = ui.position.left,
					top = ui.position.top,
					width = $helper.width(),
					height = $helper.height(),
					x = (width/2) + left,
					y = (height/2) + top,
					limit_top, limit_left, helper_top, helper_left;
				// reset move variable
				move = {};
				if ( position == 'absolute' && container_height > win_height && container_bottom <= scroll_bottom )
					main_y = container_height - ( win_height / 2 );
				if ( y <= main_y ){
					if ( position == 'fixed' || container_height < win_height || container_bottom >= scroll_bottom )
						limit_top = 0;
					else
						limit_top = container_height - win_height;
					helper_top = top < limit_top ? limit_top : top;
					move.top = helper_top - limit_top;
				}
				else {
					if ( position == 'fixed' || ( container_height > win_height && container_offset.top >= scroll_top ) )
						limit_top = win_height - height;
					else
						limit_top = container_height - height;
					helper_top = top > limit_top ? limit_top : top;
					move.bottom = limit_top - helper_top;
				}
				if ( x <= main_x ){
					limit_left = main_offset.left;
					helper_left = left < limit_left ? limit_left : left;
					move.left = helper_left - limit_left;
				}
				else {
					limit_left = main_width - width + main_offset.left;
					helper_left = left > limit_left ? limit_left : left;
					move.right = limit_left - helper_left;
				}
				view.update_position_hint(move, $helper);
				ui.position.top = helper_top;
				ui.position.left = helper_left;
			},
			stop: function (e, ui) {
				$me.show();
				if ( typeof move.top == 'number' ){
					model.set_property('top', move.top, true);
					model.remove_property('bottom', true);
				}
				else if ( typeof move.bottom == 'number' ){
					model.set_property('bottom', move.bottom, true);
					model.remove_property('top', true);
				}
				if ( typeof move.left == 'number' ){
					model.set_property('left', move.left, true);
					model.remove_property('right', true);
				}
				else if ( typeof move.right == 'number' ){
					model.set_property('right', move.right, true);
					model.remove_property('left', true);
				}
				model.get('properties').trigger('change');
			}
		});
	},


	/**
	 * Create region resizable
	 *
	 * @param {Object} view
	 * @param {Object} model
	 */
	create_region_container_resizable: function(view, model){
		var app = this,
			ed = Upfront.Behaviors.GridEditor,
			$me = view.$el,
			$main = $(Upfront.Settings.LayoutEditor.Selectors.main),
			sub = model.get('sub'),
			direction = 's',
			handles = {},
			$layout = $main.find('.upfront-layout')
		;
		if ( $me.data('ui-resizable') )
			return false;
		if ( !model.is_main() && sub == 'bottom' )
			direction = 'n';
		$me.append('<div class="upfront-icon-control-region upfront-icon-control-region-resize upfront-icon-control-region-resize-' + direction + ' upfront-region-resize-handle upfront-region-resize-handle-' + direction + ' ui-resizable-handle ui-resizable-' + direction + '"></div>');
		handles[direction] = '.upfront-region-resize-handle-' + direction;
		$me.resizable({
			containment: "document",
			//handles: "n, e, s, w",
			handles: handles,
			helper: "region-resizable-helper",
			disabled: true,
			zIndex: 9999999,
			start: function(e, ui){
				Upfront.Events.trigger("entity:region_container:resize_start", view, view.model);
				// Disable region changing
				Upfront.Events.trigger('command:region:edit_toggle', false);
				// Prevents quick scroll when resizing
				//ed.resizing = window.scrollY;
				// Preparing for auto scrolling on resize event
				ed._prepare_resize_auto_scroll(ui, $layout.find('> .upfront-regions'));
			},
			resize: function(e, ui){
				var $helper = ui.helper,
					h = ( (ui.size.height > 15 ? ui.size.height : 0) || ui.originalSize.height ),
					rsz_row = Math.ceil(h/ed.baseline),
					data = $(this).data('ui-resizable')
				;
				$helper.css({
					width: $me.width(),
					height: rsz_row * ed.baseline
				});
				$me.data('resize-row', rsz_row);

				var region_view = Upfront.data.region_views[model.cid];
				if ( region_view )
					region_view.update_size_hint(region_view.$el.width(), rsz_row * ed.baseline);
				_.each(view.sub_model, function (sub_model) {
					var sub_view = Upfront.data.region_views[sub_model.cid];
					if ( sub_view && ( sub_view.$el.hasClass('upfront-region-side-left') || sub_view.$el.hasClass('upfront-region-side-right')) )
						sub_view.update_size_hint(sub_view.$el.width(), rsz_row * ed.baseline);
				});

				// Auto scrolling when it hits bottom
				ed._start_resize_auto_scroll(e, ui, h, data);
			},
			stop: function(e, ui){
				var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint,
					rsz_row = $me.data('resize-row'),
					model_breakpoint, breakpoint_data;

				// Make sure CSS is reset, to fix bug when it keeps all resize CSS for some reason
				$me.css({
					width: '',
					minHeight: '',
					height: '',
					maxHeight: '',
					position: '',
					top: '',
					left: ''
				});

				// Make sure auto scrolling is cleared
				ed._clear_resize_auto_scroll();

				if ( !breakpoint || breakpoint.default ){
					model.set_property('row', rsz_row);
				}
				else {
					model_breakpoint = Upfront.Util.clone(model.get_property_value_by_name('breakpoint') || {});
					if ( !_.isObject(model_breakpoint[breakpoint.id]) )
						model_breakpoint[breakpoint.id] = {};
					breakpoint_data = model_breakpoint[breakpoint.id];
					breakpoint_data.edited = true;
					breakpoint_data.row = rsz_row;
					model.set_property('breakpoint', model_breakpoint);
				}

				$me.removeData('resize-row');

				Upfront.Events.trigger("entity:region_container:resize_stop", view, view.model);
				// Re-enable region changing
				Upfront.Events.trigger('command:region:edit_toggle', true);


				// Prevents quick scroll when resizing
				ed.resizing = false;
			}
		});
	},

	/**
	 * Auto scrolling when hit bottom
	 */
	_auto_scroll_t: false,
	_auto_scroll_data: {},
	_auto_scroll_step: 3,
	_auto_scroll_timeout: 100,

	/**
	 * Preparing data for auto scroll
	 */
	_prepare_resize_auto_scroll: function(ui, $parent){
		var document_height = $(document).height(),
			$scroller = $('<div class="upfront-auto-scroller"></div>');
		$scroller.css({
			width: 1,
			height: 0,
			visibility: 'hidden'
		}).appendTo( $parent ? $parent : 'body' );
		this._auto_scroll_data = {
			document_height: document_height,
			position_top: ui.originalPosition.top,
			position_height: ui.originalSize.height,
			position_rest: document_height - ( ui.originalPosition.top + ui.originalSize.height ),
			$scroller: $scroller
		};
	},

	/**
	 * Calling the auto scrolling on resize event, need direct access to resizable object
	 */
	_start_resize_auto_scroll: function (e, ui, height, data) {
		var me = this,
			window_height = $(window).height(),
			mouse_offset = Math.abs( window_height - e.clientY ),
			added_height = height - this._auto_scroll_data.position_height,
			added_scroll = added_height - this._auto_scroll_data.position_rest,
			auto_height = 0,
			step = this._auto_scroll_step * this.baseline,
			$helper = ui.helper;
		clearTimeout(this._auto_scroll_t);
		//if ( added_scroll > 0 )
		//	this._auto_scroll_data.$scroller.height(added_scroll);
		if ( mouse_offset > 50 )
			return;
		this._auto_scroll_t = setTimeout(function(){
			auto_height += step;
			if ( added_scroll + auto_height > 0 )
				me._auto_scroll_data.$scroller.height(added_scroll + auto_height + mouse_offset);
			data.size.height = height + auto_height;
			data.parentData.height = $(document).height();
			$helper.css('height', data.size.height);
			$(window).scrollTop( $(window).scrollTop() + step );
			data._trigger('resize', e, ui);
		}, this._auto_scroll_timeout);
	},

	_clear_resize_auto_scroll: function () {
		this._auto_scroll_data.$scroller.remove();
		clearTimeout(this._auto_scroll_t);
	},

	/**
	 * Toggle region resizable
	 *
	 */
	toggle_region_resizable: function(enable){
		var $main = $(Upfront.Settings.LayoutEditor.Selectors.main),
			$regions;
		if ( enable ) {
			if ( $main.hasClass('upfront-region-fixed-editing') )
				$regions = $('.upfront-region-side-fixed');
			else
				$regions = $('.upfront-region-center, .upfront-region-side-left, .upfront-region-side-right, .upfront-region-container-wide, .upfront-region-container-clip, .upfront-region-sub-container');
			$regions.each(function(){
				if ( $(this).data('ui-resizable') )
					$(this).resizable('option', 'disabled', false);
			});
		}
		else {
			$('.upfront-region, .upfront-region-container').each(function(){
				if ( $(this).data('ui-resizable') )
					$(this).resizable('option', 'disabled', true);
			});
		}
	},

	/**
	 * Toggle region draggable
	 *
	 */
	toggle_region_draggable: function(enable){
		var $main = $(Upfront.Settings.LayoutEditor.Selectors.main),
			$regions;
		if ( enable ) {
			if ( $main.hasClass('upfront-region-fixed-editing') )
				$regions = $('.upfront-region-side-fixed');
			else
				$regions = $('.upfront-region-side-left, .upfront-region-side-right, .upfront-region-container-wide, .upfront-region-container-clip');
			$regions.each(function(){
				if ( $(this).data('ui-draggable') )
					$(this).draggable('option', 'disabled', false);
			});
		}
		else {
			$('.upfront-region, .upfront-region-container').each(function(){
				if ( $(this).data('ui-draggable') )
					$(this).draggable('option', 'disabled', true);
			});
		}
	},

	/**
	 * Edit structure/grid
	 */
	edit_structure: function () {
		var ed = Upfront.Behaviors.GridEditor,
			app = Upfront.Application,
			grid = Upfront.Settings.LayoutEditor.Grid,
			$grid_wrap = $('<div class="upfront-edit-grid-wrap clearfix" />'),
			$recommended = $('<div class="upfront-edit-grid upfront-edit-grid-recommended" />'),
			$custom = $('<div class="upfront-edit-grid upfront-edit-grid-custom" />'),
			$color_wrap = $('<div class="upfront-edit-page-color" />'),
			$grid_width = $('<div class="upfront-grid-width-preview">Grid width: <span class="upfront-grid-width" /></div>'),
			$grid_width2 = $('<div class="upfront-grid-width-preview">( Grid width: <span class="upfront-grid-width" /> )</div>'),
			is_grid_custom = ( grid.column_width != grid.column_widths[grid.size_name] || grid.type_padding != grid.type_paddings[grid.size_name] || grid.baseline != grid.baselines[grid.size_name] || !(/^(0|5|10|15)$/.test(grid.column_padding)) ),
			update_grid_data = function() {
				var custom = fields.grid.get_value() == 'custom',
					new_grid = {
						column_width: custom ? fields.custom_width.get_value() : grid.column_widths[grid.size_name],
						column_padding: custom ? fields.custom_padding.get_value() : fields.recommended_padding.get_value(),
						baseline: custom ? fields.custom_baseline.get_value() : grid.baselines[grid.size_name],
						type_padding: custom ? fields.custom_type_padding.get_value() : grid.type_paddings[grid.size_name]
					},
					width = new_grid.column_width * grid.size;
				$grid_width.find('.upfront-grid-width').text(width + 'px');
				$grid_width2.find('.upfront-grid-width').text(width + 'px');
				ed.update_grid(new_grid);
			},
			togglegrid = new Upfront.Views.Editor.Command_ToggleGrid(),
			fields = {
				structure: new Upfront.Views.Editor.Field.Radios({
					label: Upfront.Settings.l10n.global.behaviors.structure,
					layout: "vertical",
					default_value: app.layout.get('layout_slug') || "blank",
					icon_class: 'upfront-structure-field-icon',
					values: [
						{label: "", value: "blank", icon: "blank"},
						{label: "", value: "wide", icon: "wide-no-sidebar"},
						{label: "", value: "wide-right-sidebar", icon: "wide-right-sidebar"},
						{label: "", value: "wide-left-sidebar", icon: "wide-left-sidebar"},
						{label: "", value: "clip", icon: "clip-no-sidebar"},
						{label: "", value: "clip-right-sidebar", icon: "clip-right-sidebar"},
						{label: "", value: "clip-left-sidebar", icon: "clip-left-sidebar"},
						{label: "", value: "full", icon: "full"},
						{label: "", value: "full-extended", icon: "full-extended"},
					],
					change: function(){
						if ( Upfront.themeExporter.currentTheme === 'upfront' ) {
							var structure = fields.structure.get_value(),
								layout_slug = app.layout.get('layout_slug');
							if ( (layout_slug && layout_slug != structure) || ( !layout_slug && structure != 'blank' ) ){
								app.layout.set('layout_slug', structure);
								if ( Upfront.Application.get_gridstate() )
									togglegrid.on_click();
								app.create_layout(_upfront_post_data.layout, {layout_slug: structure});
								Upfront.Events.once("layout:render", function() {
									if ( !Upfront.Application.get_gridstate() )
										togglegrid.on_click();
								});
							}
						}
					}
				}),
				grid: new Upfront.Views.Editor.Field.Radios({
					label: Upfront.Settings.l10n.global.behaviors.grid_settings,
					layout: "horizontal-inline",
					default_value: is_grid_custom ? "custom" : "recommended",
					values: [
						{label: Upfront.Settings.l10n.global.behaviors.recommended_settings, value: "recommended"},
						{label: Upfront.Settings.l10n.global.behaviors.custom_settings, value: "custom"}
					],
					change: function () {
						var value = this.get_value();
						if ( value == 'custom' ){
							$custom.show();
							$recommended.hide();
						}
						else {
							$recommended.show();
							$custom.hide();
						}
						update_grid_data();
					}
				}),
				recommended_padding: new Upfront.Views.Editor.Field.Select({
					default_value: grid.column_padding,
					values: [
						{label: Upfront.Settings.l10n.global.behaviors.padding_large, value: "15"},
						{label: Upfront.Settings.l10n.global.behaviors.padding_medium, value: "10"},
						{label: Upfront.Settings.l10n.global.behaviors.padding_small, value: "5"},
						{label: Upfront.Settings.l10n.global.behaviors.no_padding, value: "0"}
					],
					change: update_grid_data
				}),
				bg_color: new Upfront.Views.Editor.Field.Color({
					model: app.layout,
					label: Upfront.Settings.l10n.global.behaviors.page_bg_color,
					label_style: "inline",
					property: 'background_color',
					spectrum: {
						move: function (color) {
							var rgb = color.toRgb(),
							rgba_string = 'rgba('+rgb.r+','+rgb.g+','+rgb.b+','+color.alpha+')';
							app.layout.set_property('background_color', rgba_string);
						}
					}
				}),
				custom_width: new Upfront.Views.Editor.Field.Number({
					label: Upfront.Settings.l10n.global.behaviors.column_width,
					label_style: "inline",
					min: 40,
					max: 100,
					default_value: grid.column_width,
					change: update_grid_data
				}),
				custom_padding: new Upfront.Views.Editor.Field.Number({
					label: Upfront.Settings.l10n.global.behaviors.column_padding,
					label_style: "inline",
					min: 0,
					max: 100,
					default_value: grid.column_padding,
					change: update_grid_data
				}),
				custom_baseline: new Upfront.Views.Editor.Field.Number({
					label: Upfront.Settings.l10n.global.behaviors.baseline_grid,
					label_style: "inline",
					min: 5,
					max: 100,
					default_value: grid.baseline,
					change: update_grid_data
				}),
				custom_type_padding: new Upfront.Views.Editor.Field.Number({
					label: Upfront.Settings.l10n.global.behaviors.additional_type_padding,
					label_style: "inline",
					min: 0,
					max: 100,
					default_value: grid.type_padding,
					change: update_grid_data
				}),
				floated: new Upfront.Views.Editor.Field.Checkboxes({
					multiple: false,
					default_value: true,
					values: [
						{label: Upfront.Settings.l10n.global.behaviors.allow_floats_outside_main_grid, value: true}
					]
				})
			};

		if ( !ed.structure_modal ){
			ed.structure_modal = new Upfront.Views.Editor.Modal({to: $('body'), button: true, top: 120, width: 540});
			ed.structure_modal.render();
			$('body').append(ed.structure_modal.el);
		}
		// Toggle grid on
		if ( !Upfront.Application.get_gridstate() )
			togglegrid.on_click();

		ed.structure_modal.open(function($content, $modal){
			$modal.addClass('upfront-structure-modal');
			_.each(fields, function(field){
				field.render();
				field.delegateEvents();
			});
			$content.html('');
			if (Upfront.themeExporter.currentTheme === 'upfront') {
				$content.append(fields.structure.el);
			}
			$content.append(fields.grid.el);
			$recommended.append(fields.recommended_padding.el);
			$recommended.append($grid_width);
			$grid_wrap.append($recommended);
			$custom.append(fields.custom_width.el);
			$custom.append($grid_width2);
			$custom.append(fields.custom_padding.el);
			$custom.append(fields.custom_baseline.el);
			$custom.append(fields.custom_type_padding.el);
			$color_wrap.append(fields.bg_color.el);
			$grid_wrap.append($custom);
			$grid_wrap.append($color_wrap);
			$content.append($grid_wrap);
			$content.append(fields.floated.el);
			fields.grid.trigger('changed');
		}, ed)
		.always(function(){
			if ( Upfront.Application.get_gridstate() )
				togglegrid.on_click();
		});
	},

	/**
	 * Update grid value and appearance
	 */
	update_grid: function (grid_data) {
		var app = Upfront.Application,
			styles = [],
			grid = Upfront.Settings.LayoutEditor.Grid,
			selector = '#page',
			options = app.layout.get_property_value_by_name('grid') || {
				column_widths: {},
				column_paddings: {},
				baselines: {},
				type_paddings: {}
			},
			// Dealing with responsive settings which, apparently, trump the grid entirely
			current_bp_id = Upfront.Settings.LayoutEditor.CurrentBreakpoint || Upfront.Settings.LayoutEditor.Grid.size_name,
			breakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().findWhere({id: current_bp_id}),
			flag_update_breakpoint = false
		;

		if (grid_data.column_width) {
			options.column_widths[grid.size_name] = grid_data.column_width;
			if (breakpoint.get_property_value_by_name('column_width') != grid_data.column_width) {
				breakpoint.set_property("column_width", grid_data.column_width);
				flag_update_breakpoint = true;
			}
		}
		if ("column_padding" in grid_data) { // Special case! Allow zero values in column paddings
			options.column_paddings[grid.size_name] = grid_data.column_padding;
			if (breakpoint.get_property_value_by_name('column_padding') != grid_data.column_padding) {
				breakpoint.set_property("column_padding", grid_data.column_padding);
				flag_update_breakpoint = true;
			}
		}
		if (grid_data.baseline) {
			if (grid_data.baseline != grid.baseline) {
				// to prevent css loading at every change, we timeout to 1000ms before decide to load it
				clearTimeout(this._load_editor_css);
				this._load_editor_css = setTimeout(function() {
					Upfront.Util.post({
						action: 'upfront_load_editor_grid',
						baseline: grid_data.baseline
					}, 'text').success(function(data) {
						if ( $('#upfront-editor-grid-inline').length )
							$('#upfront-editor-grid-inline').html( data );
						else
							$('head').append('<style id="upfront-editor-grid-inline">' + data + '</style>'); // add it to head to prevent it override other custom CSS below
					});
				}, 1000);
			}
			options.baselines[grid.size_name] = grid_data.baseline;
			if (breakpoint.get_property_value_by_name('baseline') != grid_data.baseline) {
				breakpoint.set_property("baseline", grid_data.baseline);
				flag_update_breakpoint = true;
			}
		}
		if (grid_data.type_padding) {
			options.type_paddings[grid.size_name] = grid_data.type_padding;
			if (breakpoint.get_property_value_by_name('type_padding') != grid_data.type_padding) {
				breakpoint.set_property("type_padding", grid_data.type_padding);
				flag_update_breakpoint = true;
			}
		}
		Upfront.Settings.LayoutEditor.Grid = _.extend(grid, grid_data);
		app.layout.set_property('grid', options);
		app.layout_view.update_grid_css();
		this.init(); // re-init to update grid values

		if (flag_update_breakpoint && Upfront.Application.get_current() == Upfront.Settings.Application.MODE.THEME) {
			// Only do this in exporter, because that's where we're actually allowing structural changes.
			breakpoint.trigger("change:enabled", breakpoint);
		}
	},


	/**
	 * Apply saved grid in layout
	 */
	apply_grid: function () {
		var ed = Upfront.Behaviors.GridEditor,
			app = Upfront.Application,
			grid = Upfront.Settings.LayoutEditor.Grid,
			options = app.layout.get_property_value_by_name('grid');
		if ( !options || !options.column_widths || !options.column_widths[grid.size_name] )
			return;
		return ed.update_grid({
			column_width: options.column_widths[grid.size_name],
			column_padding: options.column_paddings[grid.size_name],
			baseline: options.baselines[grid.size_name],
			type_padding: options.type_paddings[grid.size_name]
		});
	},

	/**
	 * Debug stuff
	 */
	time_start: function (id) {
		if ( this.show_debug_element )
			console.time(id);
	},
	time_end: function (id) {
		if ( this.show_debug_element )
			console.timeEnd(id);
	},
	set_timeout: function(timeout){
		this.timeout = timeout;
	},
	set_compare_size: function(col, row){
		this.compare_col = col;
		this.compare_row = row;
	},
	toggle_debug: function(){
		this.show_debug_element = !this.show_debug_element;
		if ( this.show_debug_element )
			this.render_debug();
		else
			this.delete_debug();
	},
	render_debug: function () {
		var me = this,
			$main = $(Upfront.Settings.LayoutEditor.Selectors.main);
			$modal = $('<div id="behavior-debug" class="upfront-inline-modal"></div>'),
			$wrap = $('<div class="upfront-inline-modal-wrap"></div>'),
			field_delay = new Upfront.Views.Editor.Field.Number({
				name: 'delay',
				label: Upfront.Settings.l10n.global.behaviors.delay_before_drag,
				label_style: 'inline',
				min: 0,
				max: 2000,
				step: 1,
				default_value: 300,
				change: function () {
					$('.upfront-module.ui-draggable, .upfront-module-group.ui-draggable').draggable('option', 'delay', this.get_value());
				}
			}),
			field_timeout = new Upfront.Views.Editor.Field.Number({
				name: 'timeout',
				label: Upfront.Settings.l10n.global.behaviors.delay_before_changing_position,
				label_style: 'inline',
				min: 0,
				max: 2000,
				step: 1,
				default_value: me.timeout,
				change: function () {
					me.timeout = parseInt(this.get_value());
				}
			}),
			field_debug = new Upfront.Views.Editor.Field.Checkboxes({
				name: 'debug',
				multiple: false,
				default_value: true,
				values: [
					{ label: Upfront.Settings.l10n.global.behaviors.show_debug_info, value: true }
				],
				change: function () {
					me.show_debug_element = this.get_value() ? true : false;
				}
			}),
			$close = $('<a href="#" class="upfront-close-debug">' + Upfront.Settings.l10n.global.behaviors.close + '</a>');
		$main.addClass('show-debug');
		field_delay.render();
		$wrap.append(field_delay.$el);
		field_timeout.render();
		$wrap.append(field_timeout.$el);
		field_debug.render();
		$wrap.append(field_debug.$el);
		$wrap.append($close);
		$modal.append($wrap);
		$('body').append($modal);
		$modal.css({
			top: 'auto',
			left: 'auto',
			bottom: 0,
			right: 0,
			position: 'fixed'
		});
		$wrap.css({
			width: 360,
			top: 0,
			padding: '10px',
			position: 'relative'
		});
		$close.on('click', function () {
			me.show_debug_element = false;
			me.delete_debug();
		});
	},
	delete_debug: function () {
		var $main = $(Upfront.Settings.LayoutEditor.Selectors.main);
		$main.removeClass('show-debug');
		$('#behavior-debug').remove();
	}

};

	return GridEditor;
});
	
})(jQuery);
//@ sourceURL=grid-editor.js
;
(function ($) {
define('behaviors',[
	'scripts/upfront/behaviors/layout-editor',
	'scripts/upfront/behaviors/grid-editor'
], function (LayoutEditor, GridEditor) {
	return {
		Behaviors: {
			LayoutEditor: LayoutEditor,
			GridEditor: GridEditor
		}
	};
});

})(jQuery);
//@ sourceURL=upfront-behavior.js
;
/*! jquery-dateFormat 10-05-2014 */
var DateFormat={};!function(a){var b=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],c=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],d=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],e=["January","February","March","April","May","June","July","August","September","October","November","December"],f={Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12"},g=/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.?\d{0,3}[Z\-+]?(\d{2}:?\d{2})?/;a.format=function(){function a(a){return b[parseInt(a,10)]||a}function h(a){return c[parseInt(a,10)]||a}function i(a){var b=parseInt(a,10)-1;return d[b]||a}function j(a){var b=parseInt(a,10)-1;return e[b]||a}function k(a){return f[a]||a}function l(a){var b,c,d,e,f,g=a,h="";return-1!==g.indexOf(".")&&(e=g.split("."),g=e[0],h=e[1]),f=g.split(":"),3===f.length?(b=f[0],c=f[1],d=f[2].replace(/\s.+/,"").replace(/[a-z]/gi,""),g=g.replace(/\s.+/,"").replace(/[a-z]/gi,""),{time:g,hour:b,minute:c,second:d,millis:h}):{time:"",hour:"",minute:"",second:"",millis:""}}function m(a,b){for(var c=b-String(a).length,d=0;c>d;d++)a="0"+a;return a}return{parseDate:function(a){var b={date:null,year:null,month:null,dayOfMonth:null,dayOfWeek:null,time:null};if("number"==typeof a)return this.parseDate(new Date(a));if("function"==typeof a.getFullYear)b.year=String(a.getFullYear()),b.month=String(a.getMonth()+1),b.dayOfMonth=String(a.getDate()),b.time=l(a.toTimeString());else if(-1!=a.search(g))values=a.split(/[T\+-]/),b.year=values[0],b.month=values[1],b.dayOfMonth=values[2],b.time=l(values[3].split(".")[0]);else switch(values=a.split(" "),6===values.length&&isNaN(values[5])&&(values[values.length]="()"),values.length){case 6:b.year=values[5],b.month=k(values[1]),b.dayOfMonth=values[2],b.time=l(values[3]);break;case 2:subValues=values[0].split("-"),b.year=subValues[0],b.month=subValues[1],b.dayOfMonth=subValues[2],b.time=l(values[1]);break;case 7:case 9:case 10:b.year=values[3],b.month=k(values[1]),b.dayOfMonth=values[2],b.time=l(values[4]);break;case 1:subValues=values[0].split(""),b.year=subValues[0]+subValues[1]+subValues[2]+subValues[3],b.month=subValues[5]+subValues[6],b.dayOfMonth=subValues[8]+subValues[9],b.time=l(subValues[13]+subValues[14]+subValues[15]+subValues[16]+subValues[17]+subValues[18]+subValues[19]+subValues[20]);break;default:return null}return b.date=new Date(b.year,b.month-1,b.dayOfMonth),b.dayOfWeek=String(b.date.getDay()),b},date:function(b,c){try{var d=this.parseDate(b);if(null===d)return b;for(var e=(d.date,d.year),f=d.month,g=d.dayOfMonth,k=d.dayOfWeek,l=d.time,n="",o="",p="",q=!1,r=0;r<c.length;r++){var s=c.charAt(r),t=c.charAt(r+1);if(q)"'"==s?(o+=""===n?"'":n,n="",q=!1):n+=s;else switch(n+=s,p="",n){case"ddd":o+=a(k),n="";break;case"dd":if("d"===t)break;o+=m(g,2),n="";break;case"d":if("d"===t)break;o+=parseInt(g,10),n="";break;case"D":g=1==g||21==g||31==g?parseInt(g,10)+"st":2==g||22==g?parseInt(g,10)+"nd":3==g||23==g?parseInt(g,10)+"rd":parseInt(g,10)+"th",o+=g,n="";break;case"MMMM":o+=j(f),n="";break;case"MMM":if("M"===t)break;o+=i(f),n="";break;case"MM":if("M"===t)break;o+=m(f,2),n="";break;case"M":if("M"===t)break;o+=parseInt(f,10),n="";break;case"y":case"yyy":if("y"===t)break;o+=n,n="";break;case"yy":if("y"===t)break;o+=String(e).slice(-2),n="";break;case"yyyy":o+=e,n="";break;case"HH":o+=m(l.hour,2),n="";break;case"H":if("H"===t)break;o+=parseInt(l.hour,10),n="";break;case"hh":hour=0===parseInt(l.hour,10)?12:l.hour<13?l.hour:l.hour-12,o+=m(hour,2),n="";break;case"h":if("h"===t)break;hour=0===parseInt(l.hour,10)?12:l.hour<13?l.hour:l.hour-12,o+=parseInt(hour,10),n="";break;case"mm":o+=m(l.minute,2),n="";break;case"m":if("m"===t)break;o+=l.minute,n="";break;case"ss":o+=m(l.second.substring(0,2),2),n="";break;case"s":if("s"===t)break;o+=l.second,n="";break;case"S":case"SS":if("S"===t)break;o+=n,n="";break;case"SSS":o+=l.millis.substring(0,3),n="";break;case"a":o+=l.hour>=12?"PM":"AM",n="";break;case"p":o+=l.hour>=12?"p.m.":"a.m.",n="";break;case"E":o+=h(k),n="";break;case"'":n="",q=!0;break;default:o+=s,n=""}}return o+=p}catch(u){return console&&console.log&&console.log(u),b}},prettyDate:function(a){var b,c,d;return("string"==typeof a||"number"==typeof a)&&(b=new Date(a)),"object"==typeof a&&(b=new Date(a.toString())),c=((new Date).getTime()-b.getTime())/1e3,d=Math.floor(c/86400),isNaN(d)||0>d?void 0:60>c?"just now":120>c?"1 minute ago":3600>c?Math.floor(c/60)+" minutes ago":7200>c?"1 hour ago":86400>c?Math.floor(c/3600)+" hours ago":1===d?"Yesterday":7>d?d+" days ago":31>d?Math.ceil(d/7)+" weeks ago":d>=31?"more than 5 weeks ago":void 0},toBrowserTimeZone:function(a,b){return this.date(new Date(a),b||"MM/dd/yyyy HH:mm:ss")}}}()}(DateFormat),function(a){a.format=DateFormat.format}(jQuery);
define("jquery-df", function(){});

 /*!
 * jQuery Simulate v@VERSION - simulate browser mouse and keyboard events
 * https://github.com/jquery/jquery-simulate
 *
 * Copyright 2012 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * Date: @DATE
 */

;(function( $, undefined ) {

var rkeyEvent = /^key/,
	rmouseEvent = /^(?:mouse|contextmenu)|click/;

$.fn.simulate = function( type, options ) {
	return this.each(function() {
		new $.simulate( this, type, options );
	});
};

$.simulate = function( elem, type, options ) {
	var method = $.camelCase( "simulate-" + type );

	this.target = elem;
	this.options = options;

	if ( this[ method ] ) {
		this[ method ]();
	} else {
		this.simulateEvent( elem, type, options );
	}
};

$.extend( $.simulate, {

	keyCode: {
		BACKSPACE: 8,
		COMMA: 188,
		DELETE: 46,
		DOWN: 40,
		END: 35,
		ENTER: 13,
		ESCAPE: 27,
		HOME: 36,
		LEFT: 37,
		NUMPAD_ADD: 107,
		NUMPAD_DECIMAL: 110,
		NUMPAD_DIVIDE: 111,
		NUMPAD_ENTER: 108,
		NUMPAD_MULTIPLY: 106,
		NUMPAD_SUBTRACT: 109,
		PAGE_DOWN: 34,
		PAGE_UP: 33,
		PERIOD: 190,
		RIGHT: 39,
		SPACE: 32,
		TAB: 9,
		UP: 38
	},

	buttonCode: {
		LEFT: 0,
		MIDDLE: 1,
		RIGHT: 2
	}
});

$.extend( $.simulate.prototype, {

	simulateEvent: function( elem, type, options ) {
		var event = this.createEvent( type, options );
		this.dispatchEvent( elem, type, event, options );
	},

	createEvent: function( type, options ) {
		if ( rkeyEvent.test( type ) ) {
			return this.keyEvent( type, options );
		}

		if ( rmouseEvent.test( type ) ) {
			return this.mouseEvent( type, options );
		}
	},

	mouseEvent: function( type, options ) {
		var event, eventDoc, doc, body;
		options = $.extend({
			bubbles: true,
			cancelable: (type !== "mousemove"),
			view: window,
			detail: 0,
			screenX: 0,
			screenY: 0,
			clientX: 1,
			clientY: 1,
			ctrlKey: false,
			altKey: false,
			shiftKey: false,
			metaKey: false,
			button: 0,
			relatedTarget: undefined
		}, options );

		if ( document.createEvent ) {
			event = document.createEvent( "MouseEvents" );
			event.initMouseEvent( type, options.bubbles, options.cancelable,
				options.view, options.detail,
				options.screenX, options.screenY, options.clientX, options.clientY,
				options.ctrlKey, options.altKey, options.shiftKey, options.metaKey,
				options.button, options.relatedTarget || document.body.parentNode );

			// IE 9+ creates events with pageX and pageY set to 0.
			// Trying to modify the properties throws an error,
			// so we define getters to return the correct values.
			if ( event.pageX === 0 && event.pageY === 0 && Object.defineProperty ) {
				eventDoc = event.relatedTarget.ownerDocument || document;
				doc = eventDoc.documentElement;
				body = eventDoc.body;

				Object.defineProperty( event, "pageX", {
					get: function() {
						return options.clientX +
							( doc && doc.scrollLeft || body && body.scrollLeft || 0 ) -
							( doc && doc.clientLeft || body && body.clientLeft || 0 );
					}
				});
				Object.defineProperty( event, "pageY", {
					get: function() {
						return options.clientY +
							( doc && doc.scrollTop || body && body.scrollTop || 0 ) -
							( doc && doc.clientTop || body && body.clientTop || 0 );
					}
				});
			}
		} else if ( document.createEventObject ) {
			event = document.createEventObject();
			$.extend( event, options );
			// standards event.button uses constants defined here: http://msdn.microsoft.com/en-us/library/ie/ff974877(v=vs.85).aspx
			// old IE event.button uses constants defined here: http://msdn.microsoft.com/en-us/library/ie/ms533544(v=vs.85).aspx
			// so we actually need to map the standard back to oldIE
			event.button = {
				0: 1,
				1: 4,
				2: 2
			}[ event.button ] || event.button;
		}

		return event;
	},

	keyEvent: function( type, options ) {
		var event;
		options = $.extend({
			bubbles: true,
			cancelable: true,
			view: window,
			ctrlKey: false,
			altKey: false,
			shiftKey: false,
			metaKey: false,
			keyCode: 0,
			charCode: undefined
		}, options );

		if ( document.createEvent ) {
			try {
				event = document.createEvent( "KeyEvents" );
				event.initKeyEvent( type, options.bubbles, options.cancelable, options.view,
					options.ctrlKey, options.altKey, options.shiftKey, options.metaKey,
					options.keyCode, options.charCode );
			// initKeyEvent throws an exception in WebKit
			// see: http://stackoverflow.com/questions/6406784/initkeyevent-keypress-only-works-in-firefox-need-a-cross-browser-solution
			// and also https://bugs.webkit.org/show_bug.cgi?id=13368
			// fall back to a generic event until we decide to implement initKeyboardEvent
			} catch( err ) {
				event = document.createEvent( "Events" );
				event.initEvent( type, options.bubbles, options.cancelable );
				$.extend( event, {
					view: options.view,
					ctrlKey: options.ctrlKey,
					altKey: options.altKey,
					shiftKey: options.shiftKey,
					metaKey: options.metaKey,
					keyCode: options.keyCode,
					charCode: options.charCode
				});
			}
		} else if ( document.createEventObject ) {
			event = document.createEventObject();
			$.extend( event, options );
		}

		if ( !!/msie [\w.]+/.exec( navigator.userAgent.toLowerCase() ) || (({}).toString.call( window.opera ) === "[object Opera]") ) {
			event.keyCode = (options.charCode > 0) ? options.charCode : options.keyCode;
			event.charCode = undefined;
		}

		return event;
	},

	dispatchEvent: function( elem, type, event ) {
		if ( elem[ type ] ) {
			elem[ type ]();
		} else if ( elem.dispatchEvent ) {
			elem.dispatchEvent( event );
		} else if ( elem.fireEvent ) {
			elem.fireEvent( "on" + type, event );
		}
	},

	simulateFocus: function() {
		var focusinEvent,
			triggered = false,
			element = $( this.target );

		function trigger() {
			triggered = true;
		}

		element.bind( "focus", trigger );
		element[ 0 ].focus();

		if ( !triggered ) {
			focusinEvent = $.Event( "focusin" );
			focusinEvent.preventDefault();
			element.trigger( focusinEvent );
			element.triggerHandler( "focus" );
		}
		element.unbind( "focus", trigger );
	},

	simulateBlur: function() {
		var focusoutEvent,
			triggered = false,
			element = $( this.target );

		function trigger() {
			triggered = true;
		}

		element.bind( "blur", trigger );
		element[ 0 ].blur();

		// blur events are async in IE
		setTimeout(function() {
			// IE won't let the blur occur if the window is inactive
			if ( element[ 0 ].ownerDocument.activeElement === element[ 0 ] ) {
				element[ 0 ].ownerDocument.body.focus();
			}

			// Firefox won't trigger events if the window is inactive
			// IE doesn't trigger events if we had to manually focus the body
			if ( !triggered ) {
				focusoutEvent = $.Event( "focusout" );
				focusoutEvent.preventDefault();
				element.trigger( focusoutEvent );
				element.triggerHandler( "blur" );
			}
			element.unbind( "blur", trigger );
		}, 1 );
	}
});



/** complex events **/

function findCenter( elem ) {
	var offset,
		document = $( elem.ownerDocument );
	elem = $( elem );
	offset = elem.offset();

	return {
		x: offset.left + elem.outerWidth() / 2 - document.scrollLeft(),
		y: offset.top + elem.outerHeight() / 2 - document.scrollTop()
	};
}

$.extend( $.simulate.prototype, {
	simulateDrag: function() {
		var i = 0,
			target = this.target,
			options = this.options,
			center = findCenter( target ),
			x = Math.floor( center.x ),
			y = Math.floor( center.y ),
			dx = options.dx || 0,
			dy = options.dy || 0,
			moves = options.moves || 3,
			coord = { clientX: x, clientY: y };

		this.simulateEvent( target, "mousedown", coord );

		for ( ; i < moves ; i++ ) {
			x += dx / moves;
			y += dy / moves;

			coord = {
				clientX: Math.round( x ),
				clientY: Math.round( y )
			};

			this.simulateEvent( document, "mousemove", coord );
		}

		this.simulateEvent( target, "mouseup", coord );
		this.simulateEvent( target, "click", coord );
	}
});

})( jQuery );

define("jquery-simulate", function(){});

// v0.3.0 https://github.com/jhudson8/backbone-query-parameters
(function (root, factory) {
   if (typeof exports === 'object' && root.require) {
     module.exports = factory(require("underscore"), require("backbone"));
   } else if (typeof define === "function" && define.amd) {
      // AMD. Register as an anonymous module.
      define('scripts/backbone-query-parameters/backbone-query-parameters',["underscore","backbone"], function(_, Backbone) {
        // Use global variables if the locals are undefined.
        return factory(_ || root._, Backbone || root.Backbone);
      });
   } else {
      // RequireJS isn't being used. Assume underscore and backbone are loaded in <script> tags
      factory(_, Backbone);
   }
}(this, function(_, Backbone) {

var queryStringParam = /^\?(.*)/,
    optionalParam = /\((.*?)\)/g,
    namedParam    = /(\(\?)?:\w+/g,
    splatParam    = /\*\w+/g,
    escapeRegExp  = /[\-{}\[\]+?.,\\\^$|#\s]/g,
    fragmentStrip = /^([^\?]*)/,
    namesPattern = /[\:\*]([^\:\?\/]+)/g,
    routeStripper = /^[#\/]|\s+$/g,
    trailingSlash = /\/$/;
Backbone.Router.arrayValueSplit = '|';

_.extend(Backbone.History.prototype, {
  getFragment: function(fragment, forcePushState) {
    /*jshint eqnull:true */
    if (fragment == null) {
      if (this._hasPushState || !this._wantsHashChange || forcePushState) {
        fragment = this.location.pathname;
        var root = this.root.replace(trailingSlash, '');
        var search = this.location.search;
        if (!fragment.indexOf(root)) {
          fragment = fragment.substr(root.length);
        }
        if (search && this._hasPushState) {
          fragment += search;
        }
      } else {
        fragment = this.getHash();
      }
    }
    return fragment.replace(routeStripper, '');
  },

  // this will not perform custom query param serialization specific to the router
  // but will return a map of key/value pairs (the value is a string or array)
  getQueryParameters: function(fragment, forcePushState) {
    fragment = this.getFragment(fragment, forcePushState);
    // if no query string exists, this will still be the original fragment
    var queryString = fragment.replace(fragmentStrip, '');
    var match = queryString.match(queryStringParam);
    if (match) {
      queryString = match[1];
      var rtn = {};
      iterateQueryString(queryString, function(name, value) {
        value = parseParams(value);

        if (!rtn[name]) {
          rtn[name] = value;
        } else if (_.isString(rtn[name])) {
          rtn[name] = [rtn[name], value];
        } else {
          rtn[name].push(value);
        }
      });
      return rtn;
    } else {
      // no values
      return {};
    }
  }
});

_.extend(Backbone.Router.prototype, {
  initialize: function(options) {
    this.encodedSplatParts = options && options.encodedSplatParts;
  },

  _routeToRegExp: function(route) {
    var splatMatch = (splatParam.exec(route) || {index: -1}),
        namedMatch = (namedParam.exec(route) || {index: -1}),
        paramNames = route.match(namesPattern) || [];

    route = route.replace(escapeRegExp, '\\$&')
                 .replace(optionalParam, '(?:$1)?')
                 .replace(namedParam, function(match, optional){
                   return optional ? match : '([^\\/\\?]+)';
                 })
                 // `[^??]` is hacking around a regular expression bug under iOS4.
                 // If only `[^?]` is used then paths like signin/photos will fail
                 // while paths with `?` anywhere, like `signin/photos?`, will succeed.
                 .replace(splatParam, '([^??]*?)');
    route += '(\\?.*)?';
    var rtn = new RegExp('^' + route + '$');

    // use the rtn value to hold some parameter data
    if (splatMatch.index >= 0) {
      // there is a splat
      if (namedMatch >= 0) {
        // negative value will indicate there is a splat match before any named matches
        rtn.splatMatch = splatMatch.index - namedMatch.index;
      } else {
        rtn.splatMatch = -1;
      }
    }
    rtn.paramNames = _.map(paramNames, function(name) { return name.substring(1); });
    rtn.namedParameters = this.namedParameters;

    return rtn;
  },

  /**
   * Given a route, and a URL fragment that it matches, return the array of
   * extracted parameters.
   */
  _extractParameters: function(route, fragment) {
    var params = route.exec(fragment).slice(1),
        namedParams = {};
    if (params.length > 0 && _.isUndefined(params[params.length - 1])) {
      // remove potential invalid data from query params match
      params.splice(params.length - 1, 1);
    }

    // do we have an additional query string?
    var match = params.length && params[params.length-1] && params[params.length-1].match(queryStringParam);
    if (match) {
      var queryString = match[1];
      var data = {};
      if (queryString) {
        var self = this;
        iterateQueryString(queryString, function(name, value) {
          self._setParamValue(name, value, data);
        });
      }
      params[params.length-1] = data;
      _.extend(namedParams, data);
    }

    // decode params
    var length = params.length;
    if (route.splatMatch && this.encodedSplatParts) {
      if (route.splatMatch < 0) {
        // splat param is first
        return params;
      } else {
        length = length - 1;
      }
    }

    for (var i=0; i<length; i++) {
      if (_.isString(params[i])) {
        params[i] = parseParams(params[i]);
        if (route.paramNames && route.paramNames.length >= i-1) {
          namedParams[route.paramNames[i]] = params[i];
        }
      }
    }

    return (Backbone.Router.namedParameters || route.namedParameters) ? [namedParams] : params;
  },

  /**
   * Set the parameter value on the data hash
   */
  _setParamValue: function(key, value, data) {
    // use '.' to define hash separators
    key = key.replace('[]', '');
    key = key.replace('%5B%5D', '');
    var parts = key.split('.');
    var _data = data;
    for (var i=0; i<parts.length; i++) {
      var part = parts[i];
      if (i === parts.length-1) {
        // set the value
        _data[part] = this._decodeParamValue(value, _data[part]);
      } else {
        _data = _data[part] = _data[part] || {};
      }
    }
  },

  /**
   * Decode an individual parameter value (or list of values)
   * @param value the complete value
   * @param currentValue the currently known value (or list of values)
   */
  _decodeParamValue: function(value, currentValue) {
    // '|' will indicate an array.  Array with 1 value is a=|b - multiple values can be a=b|c
    var splitChar = Backbone.Router.arrayValueSplit;
    if (splitChar && value.indexOf(splitChar) >= 0) {
      var values = value.split(splitChar);
      // clean it up
      for (var i=values.length-1; i>=0; i--) {
        if (!values[i]) {
          values.splice(i, 1);
        } else {
          values[i] = parseParams(values[i]);
        }
      }
      return values;
    }

    value = parseParams(value);
    if (!currentValue) {
      return value;
    } else if (_.isArray(currentValue)) {
      currentValue.push(value);
      return currentValue;
    } else {
      return [currentValue, value];
    }
  },

  /**
   * Return the route fragment with queryParameters serialized to query parameter string
   */
  toFragment: function(route, queryParameters) {
    if (queryParameters) {
      if (!_.isString(queryParameters)) {
        queryParameters = toQueryString(queryParameters);
      }
      if(queryParameters) {
        route += '?' + queryParameters;
      }
    }
    return route;
  }
});


/**
 * Serialize the val hash to query parameters and return it.  Use the namePrefix to prefix all param names (for recursion)
 */
function toQueryString(val, namePrefix) {
  /*jshint eqnull:true */
  var splitChar = Backbone.Router.arrayValueSplit;
  function encodeSplit(val) { return String(val).replace(splitChar, encodeURIComponent(splitChar)); }

  if (!val) {
    return '';
  }

  namePrefix = namePrefix || '';
  var rtn = [];
  _.each(val, function(_val, name) {
    name = namePrefix + name;

    if (_.isString(_val) || _.isNumber(_val) || _.isBoolean(_val) || _.isDate(_val)) {
      // primitive type
      if (_val != null) {
        rtn.push(name + '=' + encodeSplit(encodeURIComponent(_val)));
      }
    } else if (_.isArray(_val)) {
      // arrays use Backbone.Router.arrayValueSplit separator
      var str = '';
      for (var i = 0; i < _val.length; i++) {
        var param = _val[i];
        if (param != null) {
          str += splitChar + encodeSplit(param);
        }
      }
      if (str) {
        rtn.push(name + '=' + str);
      }
    } else {
      // dig into hash
      var result = toQueryString(_val, name + '.');
      if (result) {
        rtn.push(result);
      }
    }
  });

  return rtn.join('&');
}

function parseParams(value) {
  // decodeURIComponent doesn't touch '+'
  try {
    return decodeURIComponent(value.replace(/\+/g, ' '));
  } catch (err) {
    // Failover to whatever was passed if we get junk data
    return value;
  }
}

function iterateQueryString(queryString, callback) {
  var keyValues = queryString.split('&');
  _.each(keyValues, function(keyValue) {
    var arr = keyValue.split('=');
    callback(arr.shift(), arr.join('='));
  });
}

}));
(function($){
	$.fn.responsiveElement = function(){
		return this.each(function(){
			var r_id = 'responsive-'+(Math.floor(Math.random()*100000)),
				bind = $(this).attr('data-bind'),
				editor = ( $(this).attr('data-editor') == 1 ),
				on_editor = false,
				min_width = normalize_size($(this).attr('data-min-width')),
				max_width = normalize_size($(this).attr('data-max-width')),
				min_height = normalize_size($(this).attr('data-min-height')),
				max_height = normalize_size($(this).attr('data-max-height')),
				styles = $(this).html(),
				applied_styles = {},
				lazyApplyBinding;

			lazyApplyBinding = _.throttle(function(e){
				if ( e.target == this )
					apply_binding_all();
				else
					apply_binding($(e.target), true);
			}, 100);

			$(window).on('load', apply_binding_all);
			$(window).on('resize', lazyApplyBinding);
			$(document).on('upfront-load', function(){
				if ( typeof Upfront.Events != 'undefined' ){
					// Attach events after render complete to improve load time
					Upfront.Events.once("layout:render", function(){
						on_editor = true;
						// Run once on startup
						apply_binding_all();
						Upfront.Events.on("layout:after_render", function(){
							apply_binding_all();
						});
						Upfront.Events.on("entity:modules:render_module", apply_binding_view);
						Upfront.Events.on("entity:regions:render_region", apply_binding_view);
						Upfront.Events.on("entity:regions:render_container", apply_binding_view);
						//Upfront.Events.on("entity:resize_stop", apply_binding_view_region);
						//Upfront.Events.on("entity:drag_stop", apply_binding_view_region);
						Upfront.Events.on("upfront:wrappers:after_fix_height", apply_binding_view);
						Upfront.Events.on("entity:region_container:resize_stop", apply_binding_view);
						Upfront.Events.on("upfront:editor:image_on", function(sel){
							apply_binding_all();
						});
						Upfront.Events.on("upfront:editor:image_align", function(sel, align){
							apply_binding_all();
						});
					});
				}
			});
			function apply_binding_all (sel) {
				var $sel = _.isString(sel) && sel != '' ? $(sel) :  $('.upfront-layout');
				return apply_binding($sel);
			}
			function apply_binding_view (view) {
				return apply_binding(view.$el.parent());
			}
			function apply_binding_view_region (view) {
				if ( bind.match(/\.upfront-region-container/) ) {
					apply_binding_all();
				}
				else {
					var $region = view.$el.closest('.upfront-region');
					apply_binding( bind.match(/\.upfront-region/) ? $region.parent() : $region );
				}
			}
			function apply_binding ($sel, single) {
				var $style = $('#'+r_id),
					changed = false
				;
				if ( editor && !on_editor ) return;
				$sel.find(bind+':visible').each(function(){
					var $el = single ? $(this).closest('.upfront-module') : $(this)
						id = $(this).attr('id') || 'bind-'+(Math.floor(Math.random()*100000)),
						width = parseFloat($el.css('width')),
						height = parseFloat($el.css('height'))
					;
					if ( ! $(this).attr('id') ) {
						$(this).attr('id', id);
					}
					var matched = (
						( (min_width && width >= min_width) || !min_width ) &&
						( (max_width && width <= max_width) || !max_width ) &&
						( (min_height && height >= min_height) || !min_height ) &&
						( (max_height && height <= max_height) || !max_height )
					);
					if ( typeof applied_styles[id] == 'undefined' ) {
						applied_styles[id] = '';
					}
					if ( matched ) {
						if ( applied_styles[id] == '' ) {
							applied_styles[id] = styles.replace(/\( ?this ?\)/igm, '#'+id);
							changed = true;
						}
					}
					else {
						if ( applied_styles[id] != '' ) {
							applied_styles[id] = '';
							changed = true;
						}
					}
				});
				if ( !changed ) {
					return;
				}
				var styles_all = $.map(applied_styles, function(style, id){
					return style;
				});
				if ( !$style.length ){
					$style = $('<style id="' + r_id + '">' + styles_all.join("\n") + '</style>');
					$('body').append($style);
				}
				else {
					$style.html( styles_all.join("\n") );
				}
			}
			function normalize_size (size) {
				if ( typeof size == 'undefined' )
					return false;
				var px_regex = /^(\d+)px$/i,
					col_regex = /^(\d+)col$/i,
					row_regex = /^(\d+)row$/i;
				if ( size.match(px_regex) ) // px
					return size.match(px_regex)[1];
			}
		});
	};

	$('[type="text/responsive_css"]').responsiveElement();

})(jQuery);

define("responsive", function(){});

/**
 * findAndReplaceDOMText v 0.4.2
 * @author James Padolsey http://james.padolsey.com
 * @license http://unlicense.org/UNLICENSE
 *
 * Matches the text of a DOM node against a regular expression
 * and replaces each match (or node-separated portions of the match)
 * in the specified element.
 */
window.findAndReplaceDOMText = (function() {

	var PORTION_MODE_RETAIN = 'retain';
	var PORTION_MODE_FIRST = 'first';

	var doc = document;
	var toString = {}.toString;

	function isArray(a) {
		return toString.call(a) == '[object Array]';
	}

	function escapeRegExp(s) {
		return String(s).replace(/([.*+?^=!:${}()|[\]\/\\])/g, '\\$1');
	}

	function exposed() {
		// Try deprecated arg signature first:
		return deprecated.apply(null, arguments) || findAndReplaceDOMText.apply(null, arguments);
	}

	function deprecated(regex, node, replacement, captureGroup, elFilter) {
		if ((node && !node.nodeType) && arguments.length <= 2) {
			return false;
		}
		var isReplacementFunction = typeof replacement == 'function';

		if (isReplacementFunction) {
			replacement = (function(original) {
				return function(portion, match) {
					return original(portion.text, match.startIndex);
				};
			}(replacement));
		}

		// Awkward support for deprecated argument signature (<0.4.0)
		var instance = findAndReplaceDOMText(node, {

			find: regex,

			wrap: isReplacementFunction ? null : replacement,
			replace: isReplacementFunction ? replacement : '$' + (captureGroup || '&'),

			prepMatch: function(m, mi) {

				// Support captureGroup (a deprecated feature)

				if (!m[0]) throw 'findAndReplaceDOMText cannot handle zero-length matches';

				if (captureGroup > 0) {
					var cg = m[captureGroup];
					m.index += m[0].indexOf(cg);
					m[0] = cg;
				}
		 
				m.endIndex = m.index + m[0].length;
				m.startIndex = m.index;
				m.index = mi;

				return m;
			},
			filterElements: elFilter
		});

		exposed.revert = function() {
			return instance.revert();
		};

		return true;
	}

	/** 
	 * findAndReplaceDOMText
	 * 
	 * Locates matches and replaces with replacementNode
	 *
	 * @param {Node} node Element or Text node to search within
	 * @param {RegExp} options.find The regular expression to match
	 * @param {String|Element} [options.wrap] A NodeName, or a Node to clone
	 * @param {String|Function} [options.replace='$&'] What to replace each match with
	 * @param {Function} [options.filterElements] A Function to be called to check whether to
	 *	process an element. (returning true = process element,
	 *	returning false = avoid element)
	 */
	function findAndReplaceDOMText(node, options) {
		return new Finder(node, options);
	}

	exposed.Finder = Finder;

	/**
	 * Finder -- encapsulates logic to find and replace.
	 */
	function Finder(node, options) {

		options.portionMode = options.portionMode || PORTION_MODE_RETAIN;

		this.node = node;
		this.options = options;

		// ENable match-preparation method to be passed as option:
		this.prepMatch = options.prepMatch || this.prepMatch;

		this.reverts = [];

		this.matches = this.search();

		if (this.matches.length) {
			this.processMatches();
		}

	}

	Finder.prototype = {

		/**
		 * Searches for all matches that comply with the instance's 'match' option
		 */
		search: function() {

			var match;
			var matchIndex = 0;
			var regex = this.options.find;
			var text = this.getAggregateText();
			var matches = [];

			regex = typeof regex === 'string' ? RegExp(escapeRegExp(regex), 'g') : regex;

			if (regex.global) {
				while (match = regex.exec(text)) {
					matches.push(this.prepMatch(match, matchIndex++));
				}
			} else {
				if (match = text.match(regex)) {
					matches.push(this.prepMatch(match, 0));
				}
			}

			return matches;

		},

		/**
		 * Prepares a single match with useful meta info:
		 */
		prepMatch: function(match, matchIndex) {

			if (!match[0]) {
				throw new Error('findAndReplaceDOMText cannot handle zero-length matches');
			}
	 
			match.endIndex = match.index + match[0].length;
			match.startIndex = match.index;
			match.index = matchIndex;

			return match;
		},

		/**
		 * Gets aggregate text within subject node
		 */
		getAggregateText: function() {

			var elementFilter = this.options.filterElements;

			return getText(this.node);

			/**
			 * Gets aggregate text of a node without resorting
			 * to broken innerText/textContent
			 */
			function getText(node) {

				if (node.nodeType === 3) {
					return node.data;
				}

				if (elementFilter && !elementFilter(node)) {
					return '';
				}

				var txt = '';

				if (node = node.firstChild) do {
					txt += getText(node);
				} while (node = node.nextSibling);

				return txt;

			}

		},

		/** 
		 * Steps through the target node, looking for matches, and
		 * calling replaceFn when a match is found.
		 */
		processMatches: function() {

			var matches = this.matches;
			var node = this.node;
			var elementFilter = this.options.filterElements;

			var startPortion,
				endPortion,
				innerPortions = [],
				curNode = node,
				match = matches.shift(),
				atIndex = 0, // i.e. nodeAtIndex
				matchIndex = 0,
				portionIndex = 0,
				doAvoidNode,
				nodeStack = [node];

			out: while (true) {

				if (curNode.nodeType === 3) {

					if (!endPortion && curNode.length + atIndex >= match.endIndex) {

						// We've found the ending
						endPortion = {
							node: curNode,
							index: portionIndex++,
							text: curNode.data.substring(match.startIndex - atIndex, match.endIndex - atIndex),
							indexInMatch: atIndex - match.startIndex,
							indexInNode: match.startIndex - atIndex, // always zero for end-portions
							endIndexInNode: match.endIndex - atIndex,
							isEnd: true
						};

					} else if (startPortion) {
						// Intersecting node
						innerPortions.push({
							node: curNode,
							index: portionIndex++,
							text: curNode.data,
							indexInMatch: atIndex - match.startIndex,
							indexInNode: 0 // always zero for inner-portions
						});
					}

					if (!startPortion && curNode.length + atIndex > match.startIndex) {
						// We've found the match start
						startPortion = {
							node: curNode,
							index: portionIndex++,
							indexInMatch: 0,
							indexInNode: match.startIndex - atIndex,
							endIndexInNode: match.endIndex - atIndex,
							text: curNode.data.substring(match.startIndex - atIndex, match.endIndex - atIndex)
						};
					}

					atIndex += curNode.data.length;

				}

				doAvoidNode = curNode.nodeType === 1 && elementFilter && !elementFilter(curNode);

				if (startPortion && endPortion) {

					curNode = this.replaceMatch(match, startPortion, innerPortions, endPortion);

					// processMatches has to return the node that replaced the endNode
					// and then we step back so we can continue from the end of the 
					// match:

					atIndex -= (endPortion.node.data.length - endPortion.endIndexInNode);

					startPortion = null;
					endPortion = null;
					innerPortions = [];
					match = matches.shift();
					portionIndex = 0;
					matchIndex++;

					if (!match) {
						break; // no more matches
					}

				} else if (
					!doAvoidNode &&
					(curNode.firstChild || curNode.nextSibling)
				) {
					// Move down or forward:
					if (curNode.firstChild) {
						nodeStack.push(curNode);
						curNode = curNode.firstChild;
					} else {
						curNode = curNode.nextSibling;
					}
					continue;
				}

				// Move forward or up:
				while (true) {
					if (curNode.nextSibling) {
						curNode = curNode.nextSibling;
						break;
					}
					curNode = nodeStack.pop();
					if (curNode === node) {
						break out;
					}
				}

			}

		},

		/**
		 * Reverts ... TODO
		 */
		revert: function() {
			// Reversion occurs backwards so as to avoid nodes subsequently
			// replaced during the matching phase (a forward process):
			for (var l = this.reverts.length; l--;) {
				this.reverts[l]();
			}
			this.reverts = [];
		},

		prepareReplacementString: function(string, portion, match, matchIndex) {
			var portionMode = this.options.portionMode;
			if (
				portionMode === PORTION_MODE_FIRST &&
				portion.indexInMatch > 0
			) {
				return '';
			}
			string = string.replace(/\$(\d+|&|`|')/g, function($0, t) {
				var replacement;
				switch(t) {
					case '&':
						replacement = match[0];
						break;
					case '`':
						replacement = match.input.substring(0, match.startIndex);
						break;
					case '\'':
						replacement = match.input.substring(match.endIndex);
						break;
					default:
						replacement = match[+t];
				}
				return replacement;
			});

			if (portionMode === PORTION_MODE_FIRST) {
				return string;
			}

			if (portion.isEnd) {
				return string.substring(portion.indexInMatch);
			}

			return string.substring(portion.indexInMatch, portion.indexInMatch + portion.text.length);
		},

		getPortionReplacementNode: function(portion, match, matchIndex) {

			var replacement = this.options.replace || '$&';
			var wrapper = this.options.wrap;

			if (wrapper && wrapper.nodeType) {
				// Wrapper has been provided as a stencil-node for us to clone:
				var clone = doc.createElement('div');
				clone.innerHTML = wrapper.outerHTML || new XMLSerializer().serializeToString(wrapper);
				wrapper = clone.firstChild;
			}

			if (typeof replacement == 'function') {
				replacement = replacement(portion, match, matchIndex);
				if (replacement && replacement.nodeType) {
					return replacement;
				}
				return doc.createTextNode(String(replacement));
			}

			var el = typeof wrapper == 'string' ? doc.createElement(wrapper) : wrapper;

			replacement = doc.createTextNode(
				this.prepareReplacementString(
					replacement, portion, match, matchIndex
				)
			);

			if (!replacement.data) {
				return replacement;
			}

			if (!el) {
				return replacement;
			}

			el.appendChild(replacement);

			return el;
		},

		replaceMatch: function(match, startPortion, innerPortions, endPortion) {

			var matchStartNode = startPortion.node;
			var matchEndNode = endPortion.node;

			var preceedingTextNode;
			var followingTextNode;

			if (matchStartNode === matchEndNode) {

				var node = matchStartNode;

				if (startPortion.indexInNode > 0) {
					// Add `before` text node (before the match)
					preceedingTextNode = doc.createTextNode(node.data.substring(0, startPortion.indexInNode));
					node.parentNode.insertBefore(preceedingTextNode, node);
				}

				// Create the replacement node:
				var newNode = this.getPortionReplacementNode(
					endPortion,
					match
				);

				node.parentNode.insertBefore(newNode, node);

				if (endPortion.endIndexInNode < node.length) { // ?????
					// Add `after` text node (after the match)
					followingTextNode = doc.createTextNode(node.data.substring(endPortion.endIndexInNode));
					node.parentNode.insertBefore(followingTextNode, node);
				}

				node.parentNode.removeChild(node);

				this.reverts.push(function() {
					if (preceedingTextNode === newNode.previousSibling) {
						preceedingTextNode.parentNode.removeChild(preceedingTextNode);
					}
					if (followingTextNode === newNode.nextSibling) {
						followingTextNode.parentNode.removeChild(followingTextNode);
					}
					newNode.parentNode.replaceChild(node, newNode);
				});

				return newNode;

			} else {
				// Replace matchStartNode -> [innerMatchNodes...] -> matchEndNode (in that order)


				preceedingTextNode = doc.createTextNode(
					matchStartNode.data.substring(0, startPortion.indexInNode)
				);

				followingTextNode = doc.createTextNode(
					matchEndNode.data.substring(endPortion.endIndexInNode)
				);

				var firstNode = this.getPortionReplacementNode(
					startPortion,
					match
				);

				var innerNodes = [];

				for (var i = 0, l = innerPortions.length; i < l; ++i) {
					var portion = innerPortions[i];
					var innerNode = this.getPortionReplacementNode(
						portion,
						match
					);
					portion.node.parentNode.replaceChild(innerNode, portion.node);
					this.reverts.push((function(portion, innerNode) {
						return function() {
							innerNode.parentNode.replaceChild(portion.node, innerNode);
						};
					}(portion, innerNode)));
					innerNodes.push(innerNode);
				}

				var lastNode = this.getPortionReplacementNode(
					endPortion,
					match
				);

				matchStartNode.parentNode.insertBefore(preceedingTextNode, matchStartNode);
				matchStartNode.parentNode.insertBefore(firstNode, matchStartNode);
				matchStartNode.parentNode.removeChild(matchStartNode);

				matchEndNode.parentNode.insertBefore(lastNode, matchEndNode);
				matchEndNode.parentNode.insertBefore(followingTextNode, matchEndNode);
				matchEndNode.parentNode.removeChild(matchEndNode);

				this.reverts.push(function() {
					preceedingTextNode.parentNode.removeChild(preceedingTextNode);
					firstNode.parentNode.replaceChild(matchStartNode, firstNode);
					followingTextNode.parentNode.removeChild(followingTextNode);
					lastNode.parentNode.replaceChild(matchEndNode, lastNode);
				});

				return lastNode;
			}
		}

	};

	return exposed;

}());
define("findandreplace", function(){});

(function ($) {

define('upfront/objects/loading',[],function() {

var LoadingModel = Upfront.Models.ObjectModel.extend({
	init: function () {
		this.init_property("type", "LoadingModel");
		this.init_property("view_class", "LoadingView");
		this.init_property("element_id", Upfront.Util.get_unique_id("please_wait"));
		this.init_property("content", 'Please, wait...');
		this.init_property("class", 'c24');
	}
});

var LoadingView = Upfront.Views.ObjectView.extend({
	model: LoadingModel,
	get_content_markup: function () {
		return '<img src="' + Upfront.Settings.root_url + '/img/loading.gif" /> ' +
			'<i>' + this.model.get_content() + '</i>' +
		'';
	},
});

//Upfront.Application.LayoutEditor.add_object("Image", {"Model": LoadingModel, "Command": ImageCommand}); // No command, this is built-in stub
Upfront.Models.LoadingModel = LoadingModel;
Upfront.Views.LoadingView = LoadingView;

});
})(jQuery);

(function () {

// These will be filterable!
define('objects',[
	'upfront/objects/loading'
	//'upfront/objects/image',
	//'upfront/objects/plain_text',
	//'upfront/objects/setting_example',
	//'upfront/objects/test_resize'
], function () {
  if (!Upfront || !Upfront.Application.LayoutEditor || !Upfront.Application.LayoutEditor.add_object) {
    Upfront.Util.log("Unable to add object");
    return false;
  }
	//Upfront.Util.log('loaded');
});

})();

;(function($){
    define('scripts/upfront/upfront-media/insert-options-item-control',[],function(){
    var l10n = Upfront.Settings.l10n.media;
    var INSERT_OPTIONS = {
        uf_insert: 'image_insert',
        wp_insert: 'wp_default'
    };

    var Options_Control = Backbone.View.extend({
        initialize: function(opts){

        },
        render: function(){
            var radios = new Upfront.Views.Editor.Field.Radios({
                label: l10n.insert_options,
                model:  this.model,
                name:  "insert_option",
                layout: 'horizontal-inline',
                default_value: this.model.at(0).get("insert_option") || 'image_insert',
                values: [
                    { label: l10n.image_inserts, value: INSERT_OPTIONS.uf_insert },
                    { label: l10n.wp_default, value: INSERT_OPTIONS.wp_insert }
                ],
                change: function(val){
                    this.model.at(0).set("insert_option", val);
                }
            });
            radios.render();
            this.$el.html( radios.el );

            return  this;
        }
    });

    return {
        Options_Control: Options_Control,
        INSERT_OPTIONS: INSERT_OPTIONS
    };

//End Define
   });
})(jQuery);

(function ($, undefined) {

define('media',[
    'scripts/upfront/upfront-media/insert-options-item-control'
],function(InsertOptions) {

	var MEDIA_SIZES = {
		FULL: "full",
		to_size: function (size) {
			return size.width + 'x' + size.height;
		}
	};

	var l10n = Upfront.Settings.l10n.media;

    var INSERT_OPTIONS = InsertOptions.INSERT_OPTIONS;

// ----- Models -----

	var MediaCollection_Model = Backbone.Collection.extend({
		defaults:{
			thumbnail: '',
			title: ''
		}
	});
	var MediaCollection_Selection = Backbone.Collection.extend({
		model: MediaItem_Model,
		initialize: function () {
			Upfront.Events.on("media_manager:media:labels_loaded", this.global_labels_loaded, this);
		},
		get_shared_labels: function () {
			var known_labels = ActiveFilters.get("label"),
				selected_labels = [],
				shared_labels = [],
				tmp_shared = {}
			;
			this.each(function (item) {
				tmp_shared[item.get("ID")] = item.get("labels") || [];
			});
			selected_labels = _.intersection.apply(this, _(tmp_shared).values());
			known_labels.each(function (label) {
				if (
					selected_labels.indexOf(label.get("value")) >= 0
					||
					selected_labels.indexOf(parseInt(label.get("value"), 10)) >= 0
				) shared_labels.push(label);
			});
			return shared_labels;
		},
		get_additional_sizes: function () {
			if (!ActiveFilters.multiple_sizes) return false; // Do not use multiple sizes if we're told not to
			var all_item_sizes = this.invoke("get", "additional_sizes"),
				item_sizes = []
			;
			_(all_item_sizes).each(function (item, idx) {
				var tmp_sizes = [];
				if (!idx) item_sizes = _(item).map(function (size) { return MEDIA_SIZES.to_size(size);});
				_(item).each(function (size) {
					tmp_sizes.push(MEDIA_SIZES.to_size(size));
				});
				item_sizes = _.intersection(item_sizes, tmp_sizes);
			});
			item_sizes.push(MEDIA_SIZES.FULL);
			return item_sizes;
		},
		is_used_label: function (label) {
			return (_(this.get_shared_labels()).invoke("get", "value").indexOf(label.get("value")) >= 0);
		},
		update_label_state: function (label) {
			return this.is_used_label(label)
				? this.disassociate_label(label)
				: this.associate_label(label)
			;
		},
		associate_label: function (label) {
			this._update_label('', label);
		},
		disassociate_label: function (label) {
			this._update_label('dis', label);
		},
		_update_label: function (pfx, label) {
			pfx = pfx || '';
			var me = this,
				idx = label.get("value"),
				data = {
					action: "upfront-media-" + pfx + "associate_label",
					term: idx,
					post_ids: this.invoke("get", "ID")
				}
			;
			Upfront.Util.post(data)
				.success(function (response) {
					me.each(function (model) {
						var labels = response.data[model.get("ID")];
						if (labels) model.set({labels: labels}, {silent: true});
					});
					me.trigger("change");
				})
			;
		},
		add_new_label: function (label) {
			var me = this,
				data = {
					"action": "upfront-media-add_label",
					"term": label,
					"post_ids": this.invoke("get", "ID")
				}
			;
			Upfront.Util.post(data)
				.success(function (response) {
					me.each(function (model) {
						var labels = response.data[model.get("ID")];
						if (labels) model.set({labels: labels}, {silent: true});
					});
					Upfront.Events.trigger("media_manager:media:labels_updated");
					me.trigger("change");
				})
			;
		},
		delete_media_items: function () {
			var me = this,
				data = {
					"action": "upfront-media-remove_item",
					"post_ids": this.invoke("get", "ID")
				}
			;
			Upfront.Util.post(data)
				.success(function (response) {
					me.reset([]);
					Upfront.Events.trigger("media_manager:media:list", ActiveFilters);
				})
			;
		},
		global_labels_loaded: function () {
			this.trigger("change");
		}
	});
	var MediaItem_Model = Backbone.Model.extend({
		defaults: {
			thumbnail: "<span class='upfront-image-upload-placeholder'></span>",
            insert_option: "image_insert"
		}
	});

	var MediaFilter_Collection = Backbone.Collection.extend({
		model: Media_FilterItem
	});
	var MediaFilter_Item = Backbone.Model.extend({
	});

	var ActiveMediaFilter_Collection = Backbone.Model.extend({
		CONST: {
			CUTOFF_SIZE: 8,
			CUTOFF_BIT: 3,
		},
		labels_cache: false,
		default_media_types: ['images', 'videos', 'audios', 'other'],
		allowed_media_types: [],
		image_sizes: true,
		showing_titles: true,
		current_page: 1,
		max_pages: 1,
		max_items: 1,
		initialize: function () {
			this.to_defaults();
			Upfront.Events.on("media_manager:media:filters_updated", this.update_active_filters, this);
			Upfront.Events.on("media_manager:media:labels_updated", this.reload_labels, this);
			Upfront.Events.on("media_manager:media:toggle_titles", this.toggle_titles, this);
		},
		to_defaults: function () {
			var types = new MediaFilter_Collection([]),
				has_all = (this.allowed_media_types.indexOf('other') >= 0)
			;
			if (!this.allowed_media_types.length) this.allowed_media_types = this.default_media_types;

			if (this.allowed_media_types.indexOf('images') >= 0) types.add(new MediaFilter_Item({filter: l10n.filter.images, value: 'images', state: !has_all}), {silent: true});
			if (this.allowed_media_types.indexOf('videos') >= 0) types.add(new MediaFilter_Item({filter: l10n.filter.videos, value: 'videos', state: !has_all}), {silent: true});
			if (this.allowed_media_types.indexOf('audios') >= 0) types.add(new MediaFilter_Item({filter: l10n.filter.audios, value: 'audios', state: !has_all}), {silent: true});
			if (this.allowed_media_types.indexOf('other') >= 0) types.add(new MediaFilter_Item({filter: l10n.filter.all, value: 'other', state: has_all}), {silent: true});

			this.set("type", types, {silent: true});

			this.set("recent", new MediaFilter_Collection([
				new MediaFilter_Item({filter: "5", value: 5, state: false}),
				new MediaFilter_Item({filter: "10", value: 10, state: false}),
				new MediaFilter_Item({filter: "20", value: 20, state: false}),
				new MediaFilter_Item({filter: "40", value: 40, state: false}),
				new MediaFilter_Item({filter: "100", value: 100, state: false})
			]), {silent: true});

			this.set("order", new MediaFilter_Collection([
				new MediaFilter_Item({filter: l10n.filter.newest, value: 'date_desc', state: true}),
				new MediaFilter_Item({filter: l10n.filter.oldest, value: 'date_asc', state: false}),
				new MediaFilter_Item({filter: l10n.filter.a_z, value: 'title_asc', state: false}),
				new MediaFilter_Item({filter: l10n.filter.z_a, value: 'title_desc', state: false})
			]), {silent: true});

			this.set({"search": new MediaFilter_Collection([])}, {silent: true});

			this.themeImages =false;
			this.current_page = 1;

			this.set_labels_to_defaults();
		},
		set_max_pages: function (max) {
			this.max_pages = max || 1;
		},
		set_max_items: function (max) {
			this.max_items = max || 1;
		},
		prev_page: function () {
			if (this.current_page > 1) return this.set_page(this.current_page-1);
		},
		next_page: function () {
			if (this.current_page < this.max_pages) return this.set_page(this.current_page+1);
		},
		set_page: function (page) {
			if (!page) return false;
			if (page >= 1 && page < this.max_pages) {
				if (page == this.current_page) return false; // Already here.
				this.current_page = page;
				return true;
			} else return false;
		},
		toggle_titles: function () {
			this.showing_titles = !this.showing_titles;
		},
		set_labels_to_defaults: function () {
			if (this.labels_cache) {
				var arr = [];
				_(this.labels_cache).each(function (item) {
					arr.push(new MediaFilter_Item({filter: item.name, value: item.term_id, state: false}));
				});
				this.set("label", new MediaFilter_Collection(arr), {silent: true});
				Upfront.Events.trigger("media_manager:media:labels_loaded");
			} else this.reload_labels();
		},
		reload_labels: function () {
			var me = this;
			Upfront.Util.post({action: "upfront-media-get_labels"})
				.success(function (response) {
					var arr = [];
					if (response.data) {
						me.labels_cache = response.data;
						me.set_labels_to_defaults();
					}
				})
			;
		},
		update_active_filters: function (filter, data) {
			if (!filter || !this.get(filter)) {
				this.to_defaults();
				Upfront.Events.trigger("media_manager:media:filters_reset");
			} else {
				var collection = data && data.get ? data.get(filter).toArray() : data,
					me = this.get(filter)
				;
				_(collection).each(function (item) {
					if (item.get("state")) {
						var has = me.where({filter: item.get("filter")});
						if (has.length) {
							has[0].set({state: item.get("state")}, {silent: true});
						}
					}
				});
			}
			Upfront.Events.trigger("media_manager:media:list", this);
		},
		to_request_json: function () {
			var data = {},
				me = this
			;
			_(this.attributes).each(function (collection, idx) {
				var active = me.get(idx).where({state:true});
				data[idx] = _(active).invoke("get", "value");
			});
			data.page = this.current_page;
			return data;
		},
		to_list: function () {
			var data = {},
				me = this
			;
			_(this.attributes).each(function (collection, idx) {
				var active = me.get(idx).where({state:true}),
					active_non_defaults = []
				;
				active_non_defaults = _(active).filter(function (filter) {
					var value = filter.get("value");
					return "other" !== value && "date_desc" !== value;
				});
				data[idx] = _(active_non_defaults).invoke("get", "filter");
			});
			return data;
		},
		has_upload: function () {
			if (!this.themeImages) return true; // Allow when not looking into theme images
			return Upfront.Application.is_builder(); // Otherwise, allow if in builder
		}
	});

	var ActiveFilters = new ActiveMediaFilter_Collection();

// ----- Views -----


	var MediaManager_Controls_View = Backbone.View.extend({
		className: "upfront-media-controls",
		is_search_active: false,
		initialize: function (args) {
			Upfront.Events.on("media:item:selection_changed", this.switch_controls, this);
			Upfront.Events.on("media:search:requested", this.switch_to_search, this);
            this.options = args.options;
		},
		render: function () {
			this.render_filters();
		},
		render_filters: function () {
			this.control = this.is_search_active ? new MediaManager_SearchFiltersControl() : new MediaManager_FiltersControl();
			this.control.render();
			this.$el.empty().append(this.control.$el);
			if ( this.is_search_active ) this.$el.removeClass('upfront-media-controls-search-selected').addClass('upfront-media-controls-search');
			else this.$el.removeClass('upfront-media-controls-search');
		},
		render_media: function (selected) {
			var item_control = new MediaManager_ItemControl({model: new MediaCollection_Selection(selected), options: this.options});
			item_control.render();
			this.$el.empty();
			if (this.is_search_active) {
				this.control = new MediaManager_SearchFiltersControl();
				this.control.render();
				this.$el.append(this.control.$el);
				this.$el.removeClass('upfront-media-controls-search').addClass('upfront-media-controls-search-selected');
			}
			else
				this.$el.removeClass('upfront-media-controls-search-selected');
			this.$el.append(item_control.$el);
		},
		switch_controls: function (media_collection) {
			var positive = media_collection.where({selected: true});
			if (positive.length) this.render_media(positive);
			else this.render_filters();
		},
		switch_to_search: function (search) {
			this.is_search_active = search && search.get("state");
			this.render_filters();
		},
		remove: function() {
			if (this.control) this.control.remove();
			Upfront.Events.off("media:item:selection_changed", this.switch_controls);
			Upfront.Events.off("media:search:requested", this.switch_to_search);
		}
	});

	var MediaManager_AuxControls_View = Backbone.View.extend({
		className: "upfront-media-aux_controls",
		initialize: function () {
			Upfront.Events.on("media:item:selection_changed", this.switch_controls, this);
		},
		render: function () {
			this.render_selection();
		},
		render_selection: function () {
			var selection_control = new MediaManager_SelectionControl({model: this.model});
			selection_control.render();
			this.$el.empty().append(selection_control.$el);
			this.$el.removeClass('upfront-media-aux_controls-has-select');
		},
		render_delete: function (selected) {
			var delete_control = new MediaManager_DeleteControl({model: new MediaCollection_Selection(selected)});
			delete_control.render();
			this.render_selection();
			this.$el.append(delete_control.$el);
			this.$el.addClass('upfront-media-aux_controls-has-select');
		},
		switch_controls: function (media_collection) {
			var positive = media_collection && media_collection.where ? media_collection.where({selected: true}) : [];
			if (positive.length) this.render_delete(positive);
			else this.render_selection();
		},
		remove: function() {
			Upfront.Events.off("media:item:selection_changed", this.switch_controls);
		}
	});

		var MediaManager_SelectionControl = Backbone.View.extend({
			className: "select_control_container",
			events: {
				"click a.none": "select_none",
				"click a.all": "select_all"
			},
			render: function () {
				this.$el.empty().append(l10n.select + ' <a href="#all" class="all">' + l10n.all + '</a>&nbsp;|&nbsp;<a href="#none" class="none">' + l10n.none + '</a>');
			},
			select_none: function (e) {
				e.preventDefault();
				e.stopPropagation();
				this.model.each(function (item) {
					item.set({selected: false}, {silent: true});
				});
				this.model.trigger("change");
				Upfront.Events.trigger("media:item:selection_changed", this.model);
			},
			select_all: function (e) {
				e.preventDefault();
				e.stopPropagation();
				var all = [];
				this.model.each(function (item) {
					item.set({selected: true}, {silent: true});
					all.push(item);
				});
				this.model.trigger("change");
				Upfront.Events.trigger("media:item:selection_changed", this.model);
			}
		});
		var MediaManager_DeleteControl = Backbone.View.extend({
			className: "delete_control_container",
			events: {
				click: "delete_selection"
			},
			render: function () {
				this.$el.empty().append('<a href="#delete">' + l10n.del_command + '</a>');
			},
			delete_selection: function (e) {
				e.preventDefault();
				e.stopPropagation();
				var show_nag = false;
				this.model.each(function (item) {
					if (item.get("parent")) show_nag = true;
				});
				if (!show_nag || (show_nag && confirm(l10n.item_in_use_nag))) {
					this.model.delete_media_items();
				}
			}
		});

		var MediaManager_ItemControl = Backbone.View.extend({
			className: "upfront-item-control",
            options: {
                insert_options: false,
                hide_sizes: false
            },
			templates: {
				caption: _.template('<label class="upfront-field-label upfront-field-label-block">{{title}}</label>'),
				shared_label: _.template('<a href="#remove" class="upfront-icon upfront-icon-media-label-delete" data-idx="{{value}}">{{filter}}</a>'),
				additional_size: _.template('<option value="{{size}}">{{size}}</option>')
			},
			events: {
				//"change .change_title :text": "change_title",
				"click .existing_labels a": "drop_label",
				//"change .additional_sizes select": "select_size"
			},
			initialize: function ( opts ) {
				this.model.on("change", this.render, this);
                this.options = _.extend( this.options, opts.options );
			},
			render: function () {
                var self = this,
                    sections = _([
                        'change_title',
                        'add_labels',
                        'existing_labels',
                        'insert_options',
                        'additional_sizes'
                    ]),
                    renderers = _([
                        'render_title',
                        'render_labels_adding',
                        'render_shared_labels',
                        'render_additional_sizes',
                        'render_insert_options'
                    ]);

                // remove prev sections
                this.$el.empty();

                // if insert_options is false remove insert options section
                if( !this.options.insert_options ){
                    sections = _( sections.reject(function(section){
                        return section === "insert_options";
                    }) );

                    renderers =  _( renderers.reject(function(renderer){
                        return renderer === "render_insert_options";
                    }) );
                }



                // add sections
                sections.each(function(section){
                    self.$el.append( '<div class="' + section +  '" />' )
                });

                // render sections
                renderers.each(function(renderer){
                    self[renderer]();
                });

			},
			render_title: function () {
				var	me = this,
					$hub = this.$el.find(".change_title");
				$hub.empty();
				if (this.model.length > 1) {

					$hub.append('<span class="selected_length">' + l10n.files_selected.replace(/%d/, this.model.length) + '</span>');
				} else {
					this.title_field = new Upfront.Views.Editor.Field.Text({
						model: this.model.at(0),
						label: l10n.media_title,
						name: 'post_title',
						change: function(){
							me.change_title();
						}
					});
					this.title_field.render();
					$hub.append(this.title_field.$el);
				}
			},
			render_labels_adding: function () {
				var me = this,
					$hub = this.$el.find(".add_labels"),
					container = new MediaManager_ItemControl_LabelsContainer({model: this.model})
				;
				$hub.empty().append(this.templates.caption({title: l10n.add_labels}));
				container.render();
				$hub.append(container.$el);
				this.$el.on("click", function (e) {
					e.stopPropagation();
					container.trigger("filters:selection:click");
				});
			},
			render_shared_labels: function () {
				var me = this,
					$hub = this.$el.find(".existing_labels"),
					shared_labels = this.model.get_shared_labels(),
					title = (shared_labels.length > 1 ? l10n.current_labels : '')
				;
				$hub.empty()
					.append(this.templates.caption({title: title}))
				;
				_(shared_labels).each(function (label) {
					$hub.append(me.templates.shared_label(label.toJSON()));
				});
			},
			render_additional_sizes: function () {
                var me = this,
                    $hub = this.$el.find(".additional_sizes"),
                    additional_sizes = this.model.get_additional_sizes(),
                    title = l10n.additional_sizes,
                    sizes = []
                    ;
                $hub.empty();

                if( ( this.options.insert_options &&  this.model.at(0).get("insert_option") === INSERT_OPTIONS.wp_insert) || ( !this.options.hide_sizes  && !this.options.insert_options )    ) {
                    if (!additional_sizes.length) return false;
                    _(additional_sizes).each(function (size) {
                        sizes.push({ label: (size === MEDIA_SIZES.FULL ? l10n.size_full : size), value: size });
                    });
                    this.size_field = new Upfront.Views.Editor.Field.Select({
                        model: this.model.at(0),
                        label: title,
                        name: 'selected_size',
                        width: '100%',
                        values: sizes,
                        default_value: MEDIA_SIZES.FULL,
                        change: function(){
                            me.select_size();
                        }
                    });
                    this.size_field.render();
                    $hub.append(this.size_field.$el);
                    this.size_field.$el.on("click", function (e) {
                        e.stopPropagation();
                    });
                }


                if (this.model.length < 2) {
                    this.add_url_label($hub);
                }

			},
            add_url_label: function($hub){
                // Add URL label
                var url_field = new Upfront.Views.Editor.Field.Text({
                    model: this.model.at(0),
                    label: l10n.url,
                    name: "document_url"
                });
                url_field.render();
                $hub.append(url_field.$el);
            },
			select_size: function (e) {
				//e.stopPropagation();
				var size = this.size_field.get_value() || MEDIA_SIZES.FULL;
				this.model.each(function (model) {
					model.set({selected_size: size}, {silent: true});
				});
			},
			change_title: function (e) {
				//e.stopPropagation();
				var model = this.model.at(0);
				model.set({post_title: this.title_field.get_value()});
				var me = this,
					data = {
						action: "upfront-media-update_media_item",
						data: model.toJSON()
					}
				;
				Upfront.Util.post(data)
					.done(function () {
						model.trigger("change");
					})
				;
				model.trigger("appearance:update");
			},
			drop_label: function (e) {
				e.preventDefault();
				e.stopPropagation();
				var $label = $(e.target),
					idx = $label.attr("data-idx"),
					shared = this.model.get_shared_labels(),
					label_idx = _(shared).invoke("get", "value").indexOf(idx),
					label = label_idx >= 0 && shared[label_idx] ? shared[label_idx] : false
				;
				if (label) this.model.update_label_state(label);
			},
            render_insert_options: function(){
                var $this_section = this.$(".insert_options"),
                    view = new InsertOptions.Options_Control( {model: this.model} );
                view.render();

                $this_section.html(view.el);
            }
		});

			var MediaManager_ItemControl_LabelsContainer = Backbone.View.extend({
				className: "upfront-additive_multiselection",
				selection: '',
				events: {
					"click :text": "stop_prop",
					"click .title": "show_labels",
					"keyup .search_labels :text": "update_selection",
					"click .add_labels a": "add_new_labels"
				},
				stop_prop: function (e) { e.stopPropagation(); },
				show_labels: function (e) {
					e.stopPropagation();
					e.preventDefault();
					this.$el.addClass("active");
				},
				hide_labels: function (e) {
					this.$el.removeClass("active");
				},
				render: function () {
					this.$el.empty()
						.append('<div class="title">' + l10n.please_select_labels + '</div>')
						.append('<div class="search_labels" />')
						.append('<div class="labels_list"><ul></ul></div>')
						.append('<div class="add_labels" />')
					;
					this.render_search();
					this.render_labels();
					this.render_addition();
					this.on("filters:selection:click", function () {
						this.hide_labels();
					}, this);
				},
				render_search: function () {
					var $hub = this.$el.find(".search_labels");
					$hub.empty().append('<input type="text" class="upfront-field upfront-field-text" value="' + this.selection + '"/>');
				},
				render_labels: function () {
					var me = this,
						$hub = this.$el.find(".labels_list ul"),
						known_labels = ActiveFilters.get("label"),
						shared_labels = this.model.get_shared_labels(),
						has_selection = false
					;
					$hub.empty();
					known_labels.each(function (label) {
						var item = new MediaManager_ItemControl_LabelItem({model: label});
						item.shared = shared_labels;
						item.media_items = me.model;
						item.selection = me.selection;
						item.render();
						if ( item.$el.find('input').size() > 0 ){
							has_selection = true;
							$hub.append(item.$el);
						}
					});
					if ( has_selection ) $hub.removeClass('empty');
					else $hub.addClass('empty');
				},
				render_addition: function () {
					var $hub = this.$el.find(".add_labels");
					$hub.empty();
					if (this.selection) $hub.append('<b class="add_value">' + this.selection + '</b> <a class="add_link" href="#add">' + l10n.add + '</a>').removeClass('empty');
					else $hub.addClass('empty');
				},
				update_selection: function (e) {
					e.preventDefault();
					e.stopPropagation();
					var $text = this.$el.find(".search_labels :text"),
						selection = $text.val()
					;
					this.selection = selection;

					this.render_labels();
					this.render_addition();
				},
				add_new_labels: function (e) {
					e.preventDefault();
					e.stopPropagation();
					var $text = this.$el.find(".search_labels :text"),
						selection = $text.val()
					;
					this.model.add_new_label(selection);
				}
			});

				var MediaManager_ItemControl_LabelItem = Backbone.View.extend({
					tagName: 'li',
					events: {
						click: "toggle_label_assignment"
					},
					render: function () {
						var me = this,
							is_used = this.media_items.is_used_label(this.model),
							used = _.template('<input type="checkbox" id="{{id}}" class="upfront-field-checkbox" value="{{value}}" checked />'),
							free = _.template('<input type="checkbox" id="{{id}}" class="upfront-field-checkbox" value="{{value}}" />'),
							label = _.template('<label for="{{id}}">{{name}}</label>'),
							name = this.model.get("filter") || '',
							match_rx = this.selection ? new RegExp('^(' + this.selection + ')', 'i') : false,
							obj = this.model.toJSON()
						;
						this.$el.empty();
						if (!name.match(match_rx)) return false;
						obj.id = this.cid;
						obj.name = name.replace(match_rx, '<span class="selection">$1</span>');
						this.$el
							.append(label(obj))
							.append((is_used ? used : free)(obj))
						;
					},
					toggle_label_assignment: function (e) {
						e.preventDefault();
						e.stopPropagation();
						this.media_items.update_label_state(this.model);
					}
				});

		var MediaManager_SearchFiltersControl = Backbone.View.extend({
			className: "upfront-search_filter-control",
			events: {
				"click a": "clear_search"
			},
			render: function () {
				var search = ActiveFilters.get("search").first(),
					obj = search.toJSON();
				obj.total = ActiveFilters.get("search").length;
				this.$el.empty().append(
					_.template(l10n.showing_total_results + ' <b class="search-text">{{value}}</b> <a href="#clear" class="clear_search">' + l10n.clear_search + '</a>', obj)
				);
			},
			clear_search: function (e) {
				e.preventDefault();
				e.stopPropagation();
				var search = new MediaFilter_Item({filter: false, value: false, state: false});
				ActiveFilters.set({search: new MediaFilter_Collection([search])});
				Upfront.Events.trigger("media_manager:media:list", ActiveFilters);
				Upfront.Events.trigger("media:search:requested", search);
			}
		});

		var MediaManager_FiltersControl = Backbone.View.extend({
			className: "upfront-filter-control",
			events: {
				"click": "stop_prop"
			},
			stop_prop: function (e) {
				e.stopPropagation();
				if (this.filter_selection) this.filter_selection.trigger("filters:outside_click")
			},
			initialize: function () {
				this.filter_selection = new MediaManager_FiltersSelectionControl();
				this.filters_selected = new MediaManager_FiltersSelectedControl({model: ActiveFilters});
			},
			render: function () {
				this.filter_selection.render();
				this.filters_selected.render();
				this.$el.empty()
					.append(this.filter_selection.$el)
					.append(this.filters_selected.$el)
				;
			},
			toggle_titles: function (e) {
				e.stopPropagation();
				Upfront.Events.trigger("media_manager:media:toggle_titles");
			},
			remove: function() {
				this.filters_selected.remove();
			}
		});

		var MediaManager_FiltersSelectedControl = Backbone.View.extend({
			className: "upfront-filter_selected-control",
			events: {
				"click a.filter": "drop_filter",
				"click a.all_filters": "drop_all"
			},
			initialize: function () {
				Upfront.Events.on("media_manager:media:list", this.set_filters, this);
			},
			render: function () {
				this.$el.empty();
				var me = this,
					_list = _(this.model.to_list()),
					_to_render = _([]),
					tpl = _.template(' <a href="#" class="filter upfront-icon upfront-icon-media-label-delete" data-type="{{type}}" data-filter="{{filter}}">{{filter}}</a>')
				;

				_list.each(function (filters, type) {
					_(filters).each(function (filter) {
						_to_render.push({filter: filter, type: type});
					});
				});
				if (!_to_render.size()) return false; // Do not render the empty filter array (ie. only defaults)

				this.$el.append('<label class="upfront-field-label upfront-field-label-block">' + l10n.active_filters + '</label>');

				_to_render.each(function (item) {
					me.$el.append(tpl(item));
				});
				this.$el.append(" <a href='#' class='all_filters'>" + l10n.clear_all_filters + "</a>");
			},
			set_filters: function (filters) {
				this.model = filters;
				this.render();
			},
			drop_filter: function (e) {
				e.preventDefault();
				e.stopPropagation();
				var $el = $(e.target),
					all = this.model,
					type = $el.attr("data-type"),
					filter = $el.attr("data-filter")
				;
				if (type && all.get(type)) {
					var has = all.get(type).where({filter: filter});
					if (has && has.length) _(has).invoke("set", {state: false}, {silent: true});
				} else {
					_(this.model.attributes).each(function (collection, idx) {
						var has = all.get(idx).where({filter: filter});
						if (has.length) {
							type = idx;
							_(has).invoke("set", {state: false}, {silent: true});
						}
					});
				}
				Upfront.Events.trigger("media_manager:media:filters_updated", type, this.model);
			},
			drop_all: function (e) {
				e.preventDefault();
				e.stopPropagation();
				Upfront.Events.trigger("media_manager:media:filters_updated", false, false);
			},
			remove: function() {
				Upfront.Events.off("media_manager:media:list", this.set_filters);
			}
		});

		var MediaManager_FiltersSelectionControl = Backbone.View.extend({
			className: "upfront-filter_selection-control clearfix",
			initialize: function () {
				this.controls = _([
					new Control_MediaType(),
					//new Control_MediaDate(),
					new Control_MediaFileName(),
					//new Control_MediaRecent(),
					new Control_MediaLabels()
				]);
				this.on("filters:outside_click", function () {
					this.controls.each(function (ctrl) {
						ctrl.trigger("filters:selection:click");
					});
				}, this);
			},
			render: function () {
				var me = this,
					tpl = _.template("<li style='display:none'><a href='#' data-idx='{{idx}}'>{{name}}</a></li>"),
					values = [{label: '&nbsp;', value: false}]
				;
				this.controls.each(function (ctl, idx) {
					values.push({label: ctl.get_name(), value: idx});
				});

				this.$el.empty();

				this.$el.append('<div class="upfront-filter_control" />');
				this.$control = this.$el.find("div.upfront-filter_control");

				this.control_field = new Upfront.Views.Editor.Field.Select({
					label: l10n.filter_label,
					name: "filter-selection",
					width: '100%',
					values: values,
					multiple: false,
					default_value: 'false',
					change: function(){
						me.select_control(this.get_value());
					}
				});
				this.control_field.render();
				this.$el.prepend(this.control_field.$el);
			},
			select_control: function (idx) {
				this.$control.empty();
				if ('false' === idx) return false;


				var control = this.controls.toArray()[idx];
				control.render();
				this.$control.append(control.$el);
				return false;
			}
		});

		var Media_FilterSelection_Multiselection = Backbone.View.extend({
			tagName: "ul",
			get_name: function () {
				return this.filter_name;
			},
			initialize_model: function () {
				this.model = ActiveFilters.get(this.filter_type);
				this.model.on("change", this.apply_changes, this);
			},
			render: function () {
				var me = this;
				this.$el.empty();
				this.model.each(function (model) {
					if (me.allowed_values && me.allowed_values.indexOf(model.get("value")) < 0) return false;
					var item = new Media_FilterSelection_Multiselection_Item({model: model});
					item.render();
					me.$el.append(item.$el);
				});
			},
			apply_changes: function () {
				var data = {},
					values = []
				;
				data = this.model.where({state:true});
				Upfront.Events.trigger("media_manager:media:filters_updated", this.filter_type, data);
			},
			update_selection: function () {
				var active = ActiveFilters.get(this.filter_type);
				if (!active) {
					this.model.invoke("set", {state: false});
				} else {
					this.model.each(function (model) {
						var has = active.where({filter: model.get("filter"), state: true});
						model.set({state: !!has.length});
					});
				}
				this.render();
				return false;
			}
		});

		var Media_FilterSelection_AdditiveMultiselection = Media_FilterSelection_Multiselection.extend({
			tagName: "div",
			className: "upfront-additive_multiselection",
			events: {
				click: "stop_prop",
				"keyup :text.filter": "show_matching_labels"
			},
			stop_prop: function (e) {
				e.stopPropagation();
				this.$el.addClass("active");
			},
			update_state: function (e) {
				this.$el.removeClass("active");
			},
			render: function () {
				var me = this,
					sel = this.selection || ''
				;
				this.$el
					.empty()
					.append('<div class="title">' + l10n.please_select_labels + '</div>')
					.append('<input type="text" class="filter upfront-field upfront-field-text" value="' + sel + '" />')
					.append('<div class="labels_list"><ul></ul></div>')
				;
				this.render_items();
				this.on("filters:selection:click", function () {
					this.update_state();
				}, this);
			},
			render_items: function () {
				var me = this,
					$hub = this.$el.find("div.labels_list ul")
				;
				$hub.empty();
				if (!this.$el.is(".active")) return false; // Only actually render this if we can see it - it takes *a while* to do so

				this.model.each(function (model) {
					if (me.allowed_values && me.allowed_values.indexOf(model.get("value")) < 0) return false;
					var item = new Media_FilterSelection_AdditiveMultiselection_Item({model: model});
					item.selection = me.selection;
					item.render();
					model.on("change:state", me.update_state, me);
					$hub.append(item.$el);
				});
			},
			show_matching_labels: function (e) {
				var $text = this.$el.find(":text.filter"),
					selection = $text.val()
				;
				this.selection = selection;
				this.render_items();
			}
		});

		var Media_FilterSelection_Uniqueselection = Media_FilterSelection_Multiselection.extend({
			render: function () {
				var me = this;
				this.$el.empty();
				this.model.each(function (model) {
					if (me.allowed_values && me.allowed_values.indexOf(model.get("value")) < 0) return false;
					var item = new Media_FilterSelection_Uniqueselection_Item({model: model});
					item.render();
					me.$el.append(item.$el);
					item.on("model:unique_state:change", me.change_state, me);
				});
			},
			change_state: function (model) {
				this.model.each(function (item) {
					if (item.get("value") != model.get("value")) item.set({state: false}, {silent: true});
				});
				model.set({state: true}, {silent: true});
				this.apply_changes();
				this.render();
			}
		});

			var Media_FilterSelection_Multiselection_Item = Backbone.View.extend({
				tagName: "li",
				events: {
					"click": "on_click"
				},
				initialize: function () {
					this.model.on("change", this.render, this);
				},
				render: function () {
					var name = this.model.get("filter");
					if ("other" === this.model.get("value")) return false; // DO NOT RENDER "ALL", special case
					if (this.model.get("state")) name = '<b>' + name + '</b>';
					this.$el.empty().append(name);
				},
				on_click: function (e) {
					e.preventDefault();
					e.stopPropagation();
					this.model.set({state: !this.model.get("state")});
				}
			});

			var Media_FilterSelection_Uniqueselection_Item = Media_FilterSelection_Multiselection_Item.extend({
				on_click: function (e) {
					e.preventDefault();
					e.stopPropagation();
					this.model.set({state: !this.model.get("state")}, {silent: true});
					this.trigger("model:unique_state:change", this.model);
				}
			});

			var Media_FilterSelection_AdditiveMultiselection_Item = Media_FilterSelection_Multiselection_Item.extend({
				render: function () {
					var checked = _.template('<input type="checkbox" for="{{id}}" class="upfront-field-checkbox" name="{{filter}}" value="{{value}}" checked />'),
						unchecked = _.template('<input type="checkbox" for="{{id}}" class="upfront-field-checkbox" name="{{filter}}" value="{{value}}" />'),
						label = _.template('<label for="{{id}}">{{name}}</label>'),
						name = this.model.get("filter") || '',
						match_rx = this.selection ? new RegExp('^(' + this.selection + ')', 'i') : false,
						obj = this.model.toJSON()
					;
					this.$el.empty();
					if (match_rx && !name.match(match_rx)) return false;
					obj.id = this.cid;
					obj.name = name.replace(match_rx, '<span class="selection">$1</span>');
					this.$el
						.append(label(obj))
						.append((this.model.get("state") ? checked : unchecked)(obj))
					;
				}
			});

		var Media_FilterCollection = Backbone.View.extend({
			render: function () {
				var me = this;
				this.$el.empty();
				this.model.each(function (model) {
					var item = new Media_FilterItem({model: model});
					item.render();
					me.$el.append(item.$el);
				});
			}
		});

			var Media_FilterItem = Backbone.View.extend({
				render: function () {
					this.$el.empty().append(this.model.get("filter"));
				}
			});

		var Control_MediaType = Media_FilterSelection_Multiselection.extend({
			initialize: function () {
				this.filter_name = l10n.media_type;
				this.filter_type = "type";
				this.initialize_model();
				Upfront.Events.on("media_manager:media:filters_updated", this.update_selection, this);
				Upfront.Events.on("media_manager:media:filters_reset", this.initialize_model, this);
			},
			apply_changes: function (model) {
				var all = this.model.where({state: true}),
					other = this.model.where({value: 'other'}),
					edited = model.previousAttributes()
				;
				if (other.length) other = other[0]; // Do the model
				else return;

				if (edited && edited.value && "other" === edited.value) {
					var no_other = !!edited.state;
					this.model.each(function (mod) {
						mod.set({state: no_other}, {silent: true});
					});
					other.set({state: !no_other}, {silent: true});
				} else if (other.get("state")) other.set({state: false}, {silent: true});

				Media_FilterSelection_Multiselection.prototype.apply_changes.call(this);

			}
		});

		var Control_MediaFileName = Media_FilterSelection_Uniqueselection.extend({
			allowed_values: ['title_desc', 'title_asc'],
			initialize: function () {
				this.filter_name = l10n.file_name;
				this.filter_type = "order";
				this.initialize_model();
				Upfront.Events.on("media_manager:media:filters_updated", this.update_selection, this);
				Upfront.Events.on("media_manager:media:filters_reset", this.initialize_model, this);
			}
		});

		var Control_MediaLabels = Media_FilterSelection_AdditiveMultiselection.extend({
			initialize: function () {
				this.filter_name = l10n.labels;
				this.filter_type = "label";
				this.initialize_model();
				Upfront.Events.on("media_manager:media:filters_updated", this.update_selection, this);
				Upfront.Events.on("media_manager:media:filters_reset", this.initialize_model, this);
				Upfront.Events.on("media_manager:media:labels_loaded", this.reinitialize_model, this);
			},
			reinitialize_model: function () {
				this.initialize_model();
				this.render();
			}
		});


	/**
	 * Top-level tabs switching and control.
	 */
	var MediaManager_Switcher = Backbone.View.extend({
		events: {
			"click .library": "switch_to_library",
			//"click .embed": "switch_to_embed",
			"click .upload": "switch_to_upload",
			"click .shortcode": "switch_to_shortcode",
			"click .markup": "switch_to_markup",
		},
		switch_template: _.template(
			'<ul class="upfront-tabs upfront-media_manager-tabs"> <li class="library">' + l10n.library + '</li> <li class="embed">' + l10n.embed + '</li> </ul> '
		),
		upload_template: _.template(
			'<button type="button" class="upload">' + l10n.upload + '</button>'
		),
		initialize: function () {
			Upfront.Events.on("media_manager:media:show_library", this.switch_to_library, this);
		},
		render: function () {
			this.$el.empty().append(
				this.switch_template({}) +
				(ActiveFilters.has_upload() ? this.upload_template({}) : '')
			);
			this.$el.addClass('clearfix');
			this.switch_to_library();
		},
		remove: function () {
			this.undelegateEvents();
			this.$el.empty();
		},
		switch_to_library: function (e) {
			var data = {};
			this.$el
				.find("li").removeClass("active")
				.filter(".library").addClass("active")
			;
			if (e && e.preventDefault) {
				e.preventDefault();
				e.stopPropagation();
			} else if (e) {
				data = e;
			}
			this.trigger("media_manager:switcher:to_library", data);
		},
		switch_to_embed: function (e) {
			return false;
			e.preventDefault();
			e.stopPropagation();
			this.$el
				.find("li").removeClass("active")
				.filter(".embed").addClass("active")
			;
			this.trigger("media_manager:switcher:to_embed");
		},
		switch_to_upload: function (e) {
			e.preventDefault();
			e.stopPropagation();
            this.trigger("media_manager:switcher:to_upload");
		},
		switch_to_shortcode: function (e) {
			e.preventDefault();
			e.stopPropagation();
			this.$el
				.find("li").removeClass("active")
				.filter(".shortcode").addClass("active")
			;
			this.trigger("media_manager:switcher:to_shortcode");
		},
		switch_to_markup: function (e) {
			e.preventDefault();
			e.stopPropagation();
			this.$el
				.find("li").removeClass("active")
				.filter(".markup").addClass("active")
			;
			this.trigger("media_manager:switcher:to_markup");
		},
		/**
		 * Boolean helper for determining if we're in some sort of a free-form or text editing mode
		 */
		is_in_editing_mode: function () {
			var type = Upfront.Application.sidebar.prevented_usage_type;
			return !(type.match(/media/));
		}
	});

	/**
	 * Main media dispatcher, has main level views.
	 */
	var MediaManager_View = Backbone.View.extend({
		_request_in_progress: false,
		initialize: function (data) {
			data = _.extend({
				type: "PostImage",
				multiple_selection: false
			}, data);

			var type = data.type,
				multiple_selection = data.multiple_selection,
				button_text = data.button_text
			;

			this.popup_data = data.data;

			ActiveFilters.to_defaults();
			this.switcher_view = new MediaManager_Switcher({el: this.popup_data.$top});

            this.listenTo(this.switcher_view, "media_manager:switcher:to_library", this.render_library, this);
            this.listenTo(this.switcher_view, "media_manager:switcher:to_embed", this.render_embed, this);
            this.listenTo(this.switcher_view, "media_manager:switcher:to_upload", this.render_upload, this);
            this.listenTo(this.switcher_view, "media_manager:switcher:to_shortcode", this.render_shortcode, this);
            this.listenTo(this.switcher_view, "media_manager:switcher:to_markup", this.render_markup, this);

			this.command_view = new MediaManager_BottomCommand({el: this.popup_data.$bottom, button_text: button_text, ck_insert: data.ck_insert});
			this.library_view = new MediaManager_PostImage_View(data.collection, data);
			//this.embed_view = new MediaManager_EmbedMedia({});

			this.library_view.multiple_selection = multiple_selection;

			if(data.themeImages){
				ActiveFilters.themeImages = true;
				this.library_view.multiple_selection = false;
			}
		},
		remove: function() {
			this.library_view.remove();
			this.switcher_view.remove();
			//this.library_view = new MediaManager_PostImage_View(this.collection);
			Upfront.Events.off("media_manager:media:list", this.switch_media_type, this);
		},
		render: function () {
			this.switcher_view.render();
			this.command_view.render();
			this.render_library();
			Upfront.Events
				.off("media_manager:media:list", this.switch_media_type)
				.on("media_manager:media:list", this.switch_media_type, this)
			;
		},
		render_library: function () {
			this.load();
			//this.embed_view.model.clear({silent:true});
			this.library_view.render();

			this.$el.empty().append(this.library_view.$el);
			if (arguments.length) {
				var sel = arguments[0], me = this;
				if ("ID" in sel) {
					this.library_view.media_collection.once("reset", function () {
						var found = me.library_view.media_collection.where({ID: sel.ID});
						if (found.length) found[0].set({selected: true});
					});
				}
			}
		},
		render_embed: function () {
			return false;
			/*
			this.embed_view.model.clear({silent:true});
			this.embed_view.render();
			this.embed_view.$el.css({
				'max-height': this.popup_data.height,
				'overflow-y': 'scroll'
			});
			this.$el.empty().append(this.embed_view.$el);
			*/
		},
		render_upload: function (e) {
			if (!this.library_view.$el.is(":visible")) this.render_library();

			// Check if we're actually allowing uploads
			if (!(window._upfront_media_upload && _upfront_media_upload.image_ref)) {
				alert(l10n.disabled);
				return false;
			}

			var me = this,
				uploaded = 0, progressing = 0, done =0,
				new_media = [],
				media_library_view = me.library_view._subviews.media,
				uploadUrl = ActiveFilters.themeImages ? _upfront_media_upload.theme : _upfront_media_upload.normal
			;

            this.$("#fileupload").remove();
            this.$el.append('<input id="fileupload" type="file" style="display:none" name="media" data-url="' + uploadUrl + '" multiple >');
            this.$("#fileupload").off("click").on("click", function (e) { e.stopPropagation(); }).fileupload({
				dataType: 'json',
				add: function (e, data) {
					var media = data.files[0],
						count = uploaded,
						name = media.name || 'tmp'
					;
					uploaded +=1;
					new_media[count] = new MediaItem_Model({progress: 0});
					new_media[count].set({post_title: name});
					media_library_view.model.add(new_media[count], {at: 0});
					data.submit();
					new_media[count].on("upload:abort", function () {
						data.abort();
						if (new_media[count].get("ID")) {
							// Already uploaded this file, remove on the server side
							Upfront.Util.post({
								action: "upfront-media-remove_item",
								item_id: new_media[count].get("ID")
							}).always(function () {
								media_library_view.model.trigger("change");
							});
						}
						media_library_view.model.remove(new_media[count]);
						media_library_view.model.trigger("change");
					});
					new_media[count].trigger("upload:start", media);
				},
				progressall: function (e, data) {
					var count = progressing;
					progressing+=1;
					var progress = parseInt(data.loaded / data.total * 100, 10);
					if (new_media[count]) new_media[count].trigger("upload:progress", progress);
				},
				done: function (e, data) {
					var count = done;
					done +=1;
					if(ActiveFilters.themeImages){
						new_media[count].set(data.result.data, {silent: true});
						return new_media[count].trigger("upload:finish");
					}

					var result = data.result.data || [],
						uploaded_id = result[0]
					;

					new_media[count].set({ID: uploaded_id}, {silent:true});
					Upfront.Util.post({
						action: "upfront-media-get_item",
						item_id: uploaded_id
					}).done(function (response) {
						new_media[count].set(response.data, {silent:true});
						new_media[count].trigger("upload:finish");
					}).fail(function () {
						Upfront.Events.trigger("media_manager:media:list", ActiveFilters);
					});
				},
				fail: function (e, data) {
					if (data.jqXHR.responseJSON && data.jqXHR.responseJSON.error) Upfront.Views.Editor.notify(data.jqXHR.responseJSON.error, 'error');
					Upfront.Events.trigger("media_manager:media:list", ActiveFilters);
				}
			}).trigger("click");

		},
		render_shortcode: function () {
			//console.log("SHORTCODE YAY");
		},
		render_markup: function () {
			//console.log("MARKUP YAY");
		},
		load: function (data) {
			this._request_in_progress = true;
			data = data && data.type ? data : ActiveFilters.to_request_json();
			data.action = ActiveFilters.themeImages ? 'upfront-media-list_theme_images' : "upfront-media-list_media";
			var me = this;
			if (this.library_view.media_view && this.library_view.media_view.start_loading) this.library_view.media_view.start_loading();
			Upfront.Util.post(data)
				.done(function (response) {
					ActiveFilters.set_max_pages(response.data.meta.max_pages);
					ActiveFilters.set_max_items(response.data.meta.max_items);
					me.library_view.update(response.data.items);
					me.command_view.render();
				})
				.fail(function (response) {
					me.library_view.update([]);
					me.command_view.render();
				})
				.always(function () {
					me._request_in_progress = false;
				})
			;
		},
		switch_media_type: function (what) {
			if (this._request_in_progress) return false;
			this.load(what.to_request_json());
		}
	});

	/**
	 * Bottom commands view (search etc)
	 */
	var MediaManager_BottomCommand = Backbone.View.extend({
		initialize: function(opts){
			this.options = opts;
		},
		render: function () {
			var button_text = this.options.button_text,
				pagination = new MediaManager_Pagination(),
				search = new MediaManager_BottomCommand_Search(),
				use = this.options.ck_insert ? new MediaManager_BottomCommand_UseSelection_MultiDialog({button_text: button_text}) : new MediaManager_BottomCommand_UseSelection({button_text: button_text})
			;
			pagination.render();
			search.render();
			use.render();
			this.$el.empty()
				.append(pagination.$el)
				.append(use.$el)
				.append(search.$el)
			;
		},
		switch_to_upload: function (e) {
			this.trigger("media_manager:switcher:to_upload");
		}
	});

		var MediaManager_Pagination = Backbone.View.extend({
			events: {
				"click .upfront-pagination_item-prev": "prev_page",
				"click .upfront-pagination_item-next": "next_page",
				"click .upfront-pagination_page-item": "set_page",
				"click .upfront-pagination_page-current": "stop_prop",
				"keypress .upfront-pagination_page-current": "set_page_keypress",
			},
			stop_prop: function (e) { e.stopPropagation(); },
			render: function () {
				var markup = '';
				if (ActiveFilters.max_pages > 1) {
					markup += '<div id="upfront-entity_list-pagination">';
					markup += '<a class="upfront-pagination_item upfront-pagination_item-skip upfront-pagination_item-prev"></a>';

					// Input
					markup += '<div class="upfront-pagination_navigation">';
					markup += 	'<input type="text" class="upfront-pagination_page-current" value="' + ActiveFilters.current_page + '" />';
					markup += 	'&nbsp;' + l10n.n_of_x + '&nbsp;';
					markup += 	'<a class="upfront-pagination_page-item" data-idx="' + (ActiveFilters.max_pages - 1) + '">' + (ActiveFilters.max_pages - 1) + '</a>';
					markup += '</div>';

					markup += '<a class="upfront-pagination_item upfront-pagination_item-skip upfront-pagination_item-next"></a>';
					// Add max items
					markup += '<small>(' + _.template(l10n.entity_list_info, {items: ActiveFilters.max_items, pages: ActiveFilters.max_pages - 1}) + ')</small>';
					markup += '</div>';
				}

				this.$el.empty().append(markup);
			},
			prev_page: function (e) {
				e.preventDefault();
				e.stopPropagation();
				if (ActiveFilters.prev_page()) Upfront.Events.trigger("media_manager:media:list", ActiveFilters);
			},
			next_page: function (e) {
				e.preventDefault();
				e.stopPropagation();
				if (ActiveFilters.next_page()) Upfront.Events.trigger("media_manager:media:list", ActiveFilters);
			},
			set_page: function (e) {
				e.preventDefault();
				e.stopPropagation();
				if (ActiveFilters.set_page($(e.target).data("idx"))) Upfront.Events.trigger("media_manager:media:list", ActiveFilters);
			},
			set_page_keypress: function (e) {
				e.stopPropagation();
				//e.preventDefault();
				var string = String.fromCharCode(e.which),
					num = parseInt(string, 10)
				;
				if (13 !== e.which) return true;
				var string = $.trim($(e.target).val()),
					num = parseInt(string, 10)
				;
				if (!num) return false;
				if (num > ActiveFilters.max_pages) num = ActiveFilters.max_pages;
				if (ActiveFilters.set_page(num)) Upfront.Events.trigger("media_manager:media:list", ActiveFilters);
			}
		});

		var MediaManager_BottomCommand_Search = Backbone.View.extend({
			className: "search_container clearfix",
			events: {
				"click .search": "do_search",
				"click .clear": "clear_search",
				"keyup :text": "on_keyup"
			},
			render: function () {
				var active = ActiveFilters.get("search"),
					search = !!active.length ? active.first() : false,
					has_search = !!search && search.get("state")
				;
				this.$el.empty()
					.append('<input type="text" placeholder="' + l10n.search + '" value="' + (has_search && search ? search.get("value") : '') + '" />')
				;
				if (has_search) {
					this.$el.append('<a href="#clear" class="clear upfront-icon upfront-icon-popup-search-clear"></a>');
					this.$el.addClass("has_search");
				}
				else {
					this.$el.removeClass("has_search");
				}
				this.$el.append('<div class="search upfront-icon upfront-icon-popup-search" id="upfront-search_action"></div>');
			},
			do_search: function (e) {
				e.preventDefault();
				e.stopPropagation();
				var $text = this.$el.find(":text"),
					text = $text.val(),
					search = new MediaFilter_Item({filter: text, value: text, state: true})
				;
				if (!text) {
					search = new MediaFilter_Item({filter: false, value: false, state: false});
				}

				ActiveFilters.to_defaults();
				ActiveFilters.set("search", new MediaFilter_Collection([search]));
				Upfront.Events.trigger("media_manager:media:list", ActiveFilters);
				Upfront.Events.trigger("media:search:requested", search);
				this.render();
			},
			clear_search: function (e) {
				e.preventDefault();
				e.stopPropagation();
				var $text = this.$el.find(":text");
				$text.val('');
				this.do_search(e);
			},
			on_keyup: function (e) {
				if ( e.keyCode == 13 )
					this.$el.find('.search').trigger('click');
				else if ( e.keyCode == 27 )
					this.$el.find('.clear').trigger('click');
			}
		});

		var MediaManager_BottomCommand_UseSelection = Backbone.View.extend({
			className: "use_selection_container",
			events: {
				"click a": "use_selection"
			},
			initialize: function (opts) {
				this.options = opts;
				Upfront.Events.on("media:item:selection_changed", this.update_model, this);
			},
			render: function () {
				var button_text = this.options.button_text || "Ok";
				this.$el.empty().append('<a href="#use" class="use">' + button_text + '</a>');
			},
			update_model: function (selected) {
				var positive = selected.where({selected: true});
				this.model = new MediaCollection_Selection(positive);
			},
			use_selection: function (e) {
				e.preventDefault();
				e.stopPropagation();
				Upfront.Popup.close(this.model);
			}
		});

			var MediaManager_BottomCommand_UseSelection_MultiDialog = MediaManager_BottomCommand_UseSelection.extend({
				use_selection: function (e) {
					e.preventDefault();
					e.stopPropagation();
					if ( this.model && this.model.length > 1 )
						this.open_dialog();
					else
						Upfront.Popup.close(this.model);
				},
				open_dialog: function () {
					var $dialog = $('<div id="media-manager-multi-dialog" class="upfront-ui" />');
					$dialog.append('<h3 class="multi-dialog-title">' + l10n.insertion_question + '</h3>');
					$dialog.append(
						'<ul class="multi-dialog-choices">' +
							'<li class="multi-dialog-choice upfront-icon upfront-icon-media-insert-multi-plain" data-choice="plain">' + l10n.plain_images + '</li>' +
							'<li class="multi-dialog-choice upfront-icon upfront-icon-media-insert-multi-slider" data-choice="slider">' + l10n.image_slider + '</li>' +
							'<li class="multi-dialog-choice upfront-icon upfront-icon-media-insert-multi-gallery" data-choice="gallery">' + l10n.image_gallery + '</li>' +
						'</ul>'
					);
					Upfront.Popup.$popup.find("#upfront-popup-content").append($dialog);
					$dialog.on('click', '.multi-dialog-choice', this, this.select_dialog);
				},
				select_dialog: function (e) {
					e.preventDefault();
					e.stopPropagation();
					var $dialog = $('#media-manager-multi-dialog'),
						choice = $(this).attr('data-choice') || 'plain',
						obj = e.data;
					obj.model.type = choice;
					$dialog.remove();
					Upfront.Popup.close(obj.model);
				}
			});

	/**
	 * Embed media from URL
	 */
	var MediaManager_EmbedMedia = Backbone.View.extend({
		className: "upfront-embed_media clearifx",
		initialize: function () {
			this.model = new MediaItem_Model();
		},
		render: function () {
			this.embed_pane = new MediaManager_Embed_DetailsPane({model: this.model});
			this.embed_pane.on("embed:editable:updated", this.embed_updated, this);

			this.preview_pane = new MediaManager_Embed_PreviewPane({model: this.model});

			this.embed_pane.render();
			this.preview_pane.render();
			this.$el.empty()
				.append(this.embed_pane.$el)
				.append(this.preview_pane.$el)
			;
		},
		embed_updated: function () {
			this.preview_pane.render_progress();
			var me = this;
			Upfront.Util.post(_.extend({
				action: "upfront-media-embed",
				media: this.model.get("original_url")
			}, _upfront_media_upload.embed_ref)).done(function (response) {
				me.model.set(response.data, {silent:true});
				me.preview_pane.trigger("embed:media:imported");
				me.embed_pane.clear_updating_flag();
				me.embed_pane.render();
				me.preview_pane.render();
			});
		}
	});
		var MediaManager_Embed_DetailsPane = Backbone.View.extend({
			className: "upfront-pane",
			embed_is_being_updated: false,
			events: {
				"click button": "save"
			},
			initialize: function () {
				this.editables = _([
					new MediaItem_EmbedableUrl({model: this.model}),
					new MediaItem_EditableTitle({model: this.model}),
					new MediaItem_EditableLabels({model: this.model})
				]);
			},
			render: function () {
				this.$el.empty();
				var me = this;
				this.editables.each(function (editable) {
					editable.render();
					editable.on("embed:updated", me.editable_updated, me);
					me.$el.append(editable.$el);
				});
				this.$el.append('<button type="button">' + l10n.ok + '</button>');
			},
			editable_updated: function () {
				this.embed_is_being_updated = true;
				this.trigger("embed:editable:updated");
			},
			clear_updating_flag: function () {
				this.embed_is_being_updated = false;
			},
			save: function () {
				if (!this.model) return false;
				var me = this;
				if (!this.model.get("ID") && this.embed_is_being_updated) {
					// A case when an embed is still being fetched but OK is clicked
					setTimeout(function () {
						me.save();
					}, 500);
					return false;
				}
				//this.editables.invoke("update"); // Do NOT!! invoke the update
				var data = {
					action: "upfront-media-update_media_item",
					data: this.model.toJSON()
				};
				Upfront.Util.post(data)
					.done(function () {
						me.model.trigger("change");
						// Swap back to media
						Upfront.Events.trigger("media_manager:media:show_library", data.data);
					})
				;
			}
		});

		var MediaManager_Embed_PreviewPane = Backbone.View.extend({
			className: "upfront-pane",
			initialize: function () {
			},
			render: function () {
				this.preview_view = new MediaManager_Embed_Preview({model: this.model});
				this.labels_view = new MediaItem_Labels({model: this.model});
				this.on("embed:media:imported", this.update_media_preview, this);

				this.preview_view.render();
				//this.labels_view.render();
				this.$el.empty()
					.append(this.preview_view.$el)
					//.append(this.labels_view.$el)
				;
			},
			render_progress: function () {
				this.$el.empty().append('<div class="preview_loader" />');
				var $loader = this.$el.find(".preview_loader");
				$loader.css({
					position: "relative",
					minHeight: "250px", // Ugh...
					width: "100%"
				});
				this.loading = new Upfront.Views.Editor.Loading({
					loading: l10n.loading_embeddable_preview,
					done: 'Loaded'
				});
				this.loading.render();
				$loader.append(this.loading.$el);
			},
			update_media_preview: function () {
				this.preview_view.render();
				this.labels_view.render();
				this.labels_view.delegateEvents();
			}
		});

			var MediaManager_Embed_Preview = Backbone.View.extend({
				className: "upfront-media_manager-embed-preview",
				template: _.template('{{thumbnail}} <div class="progress"></div>'),
				render: function () {
					if (!this.model.get("original_url")) return this.$el.empty();
					var me = this,
						is_image = this.is_image(),
						thumbnail = is_image ? this.model.get("thumbnail") : this.get_media_thumbnail()
					;
					this.$el.empty().append(this.template({thumbnail: thumbnail}));
				},
				is_image: function () {
					return (this.model.get("original_url") || "").match(/\.(jpe?g|gif|png)$/i);
				},
				get_media_thumbnail: function () {
					return this.model.get("thumbnail");
				}
			});

	/**
	 * Post images library implementation.
	 */
	var MediaManager_PostImage_View = MediaManager_View.extend({
		className: "upfront-media_manager upfront-media_manager-post_image clearfix",
		_subviews: {
			media: false,
			aux: false,
			controls: false
		},
		initialize: function (collection, opts) {
			var data = data || {};
			if(collection.models)
				collection = new MediaCollection_Model(collection);
			else
				collection = new MediaCollection_Model();
			this.media_collection = collection;

            this.options = opts;
		},
		render: function () {
			if (!this._subviews.media) {
				this._subviews.media = new MediaCollection_View({model: this.media_collection});
			}
			var media = this._subviews.media;
			
			if (!this._subviews.aux) {
				this._subviews.aux = new MediaManager_AuxControls_View({model: this.media_collection});
			}
			var aux = this._subviews.aux;
			
			if (!this._subviews.controls) {
				this._subviews.controls = new MediaManager_Controls_View({model: this.media_collection, options: this.options });
			}
			var controls = this._subviews.controls;

			media.multiple_selection = this.multiple_selection;

			controls.render();
			aux.render();
			media.render();
			this.$el
				.empty()
				.append(controls.$el)
				.append(aux.$el)
				.append(media.$el)
			;
			this.media_view = media;
			this.media_view.start_loading();
		},
		update: function (collection) {
			var me = this;
			this.media_view.model.reset(collection);
			this.media_view.end_loading(function(){
				me.media_view.render();
			});
		},
		remove: function() {
			_.each(this._subviews, function(subview, idx) {
				if (!subview) return true;
				subview.remove();
				this._subviews[idx] = false;
			}, this);
		}
	});

	var MediaCollection_View = Backbone.View.extend({
		tagName: 'ul',
		className: 'upfront-media_collection',
		initialize: function () {
			this.model.on("add", this.render, this);
			this.model.on("remove", this.render, this);
			this.model.on("change", this.update, this);
			this.model.on("change:selected", this.propagate_selection, this);
		},
		render: function () {
			this.subviews = [];
			var me = this;
			this.$el.empty();
			if (!this.model.length) {
				this.$el.append('&nbsp;');
			} else {
				this.model.each(function (model) {
					var view = new MediaItem_View({model: model});
					me.subviews.push(view);
					view.parent_view = me;
					view.render();
					me.$el.append(view.$el);
				});
			}
		},
		update: function () {
			if (this.model.length) {
				this.model.each(function (model) {
					model.trigger("appearance:update");
				});
			}
		},
		start_loading: function () {
			this.loading = new Upfront.Views.Editor.Loading({
				loading: l10n.loading_media_files,
				done: 'Loaded'
			});
			this.loading.render();
			this.$el.append(this.loading.$el);
		},
		end_loading: function (callback) {
			if (this.loading && this.loading.done) this.loading.done(callback);
			else callback();
			Upfront.Events.trigger("media:item:selection_changed", this.model);
		},
		propagate_selection: function (model) {
			if (!this.multiple_selection) {
				var has = this.model.where({selected: true}),
					selected = true === model.get("selected")
				;
				if (has.length) _(has).each(function (item) {
					item.set({selected: false}, {silent: true});
					item.trigger("appearance:update");
				});
				if (selected) model.set({selected: true}, {silent: true});
				model.trigger("appearance:update");
			}
			Upfront.Events.trigger("media:item:selection_changed", this.model);
		},
		remove: function() {
			_.each(this.subviews, function(subview) {
				subview.remove();
			});
		}
	});
		var MediaItem_View = Backbone.View.extend({
			tagName: 'li',
			className: 'upfront-media_item',
			events: {
				click: "toggle_item_selection"
			},
			initialize: function () {

				this.template = _.template("<div class='thumbnail'>{{thumbnail}}</div> <div class='title'>{{post_title}}</div> <div class='upfront-media_item-editor-container' />");
				Upfront.Events.on("media_manager:media:toggle_titles", this.toggle_title, this);

				this.model.on("appearance:update", this.update, this);

				this.model.on("upload:start", this.upload_start, this);
				this.model.on("upload:progress", this.upload_progress, this);
				this.model.on("upload:finish", this.upload_finish, this);
			},
			render: function () {
				this.$el.empty().append(
					this.template(this.model.toJSON())
				);
				this.update();
				this.toggle_title();
			},
			update: function () {
				if (this.model.get("parent")) this.$el.addClass("has-parent");
				else this.$el.removeClass("has-parent");
				if (this.model.get("selected") && !this.$el.hasClass("selected")) {
					this.$el.addClass("selected");
				}
				else if (!this.model.get("selected")) {
					this.$el.removeClass("selected");
				}
				this.$el.find(".title").text(this.model.get('post_title'));
			},
			toggle_title: function () {
				var state = ActiveFilters.showing_titles,
					$el = this.$el.find(".title")
				;
				if (state && !$el.is(":visible")) $el.show();
				else $el.hide();
			},
			toggle_item_selection: function (e) {
				e.stopPropagation();
				e.preventDefault();
				this.model.set({selected: !this.model.get("selected")});
			},
			upload_start: function (media) {
				/*$(".upfront-media_item-editor").remove();
				var editor = new MediaItem_EditorView({
					model: this.model,
					media: media
				});
				editor.render();
				this.$el.find(".upfront-media_item-editor-container").append(editor.$el);*/
				this.parent_view.$el.scrollTop(0);
				this.$el.find('.thumbnail').append('<div class="upfront-media-progress-bar" />');
			},
			upload_progress: function (progress) {
				//Upfront.Util.log(_.template("{{post.post_title}} progress changed to {{progress}}", {post:this.model.toJSON(), progress:progress}));
				this.$el.find('.upfront-media-progress-bar').css('width', progress+'%');
			},
			upload_finish: function () {
				this.$el.find(".thumbnail .upfront-image-upload-placeholder").replaceWith(this.model.get("thumbnail"));
				this.$el.find('.upfront-media-progress-bar').remove();
				this.model.set({selected: true});
				Upfront.Events.trigger("media:item:selection_changed", this.model.collection);
			},
			remove: function() {
				Upfront.Events.off("media_manager:media:toggle_titles", this.toggle_title);
			}
		});

// ----- Editor -----

	var MediaItem_EditorView = Backbone.View.extend({
		className: "upfront-media_item-editor",
		events: {
			"click button": "save"
		},
		initialize: function (data) {
			this.editables = _([
				new MediaItem_EditableTitle({model: this.model})
			]);
			if (data && data.media) this.media = data.media;
		},
		render: function () {
			this.$el.empty();
			var me = this;
			this.editables.each(function (editable) {
				editable.render();
				me.$el.append(editable.$el);
			});

			var labels = new MediaItem_Labels({model: this.model});
			labels.render();
			this.$el.append(labels.$el);

			this.$el.append('<button type="button">' + l10n.ok + '</button>');
			if (!this.media) return true;

			var type = this.media.type || 'application/octet-stream',
				is_image = type.match(/^image/i)
			;
			if (is_image) return true;

			var nag = new MediaItem_UploadNag({model: this.model, media:this.media});
			nag.render();
			this.$el.append(nag.$el);
		},
		save: function () {
			this.editables.invoke("update");
			var me = this,
				data = {
					action: "upfront-media-update_media_item",
					data: this.model.toJSON()
				}
			;
			Upfront.Util.post(data)
				.done(function () {
					//Upfront.Util.log('successfully saved data');
					me.model.trigger("change");
				})
			;
		}
	});

	var MediaItem_Labels = Backbone.View.extend({
		className: "upfront-media_labels",
		events: {
			"click button": "create_label",
			"click a.own_label": "drop_label",
			"click a.all_label": "add_label"
		},
		initialize: function () {
			this.labels = ActiveFilters.get("label");
			Upfront.Events.on("media_manager:media:labels_loaded", this.reset_labels, this);
		},
		reset_labels: function () {
			this.labels = ActiveFilters.get("label");
			this.render();
		},
		render: function () {
			var own_labels_template = _.template('<a class="own_label" href="#" data-idx="{{value}}">{{filter}}</a> '),
				all_labels_template = _.template('<a class="all_label" href="#" data-idx="{{value}}">{{filter}}</a> '),
				me = this,
				model_labels = this.model.get("labels"),
				own_labels = [],
				all_labels = []
			;
			this.$el.empty();
			if (this.labels) this.labels.each(function (item) {
				if (model_labels && model_labels.length && model_labels.indexOf(item.get("value")) >= 0) own_labels.push(own_labels_template(item.toJSON()));
				else all_labels.push(all_labels_template(item.toJSON()));
			});
			me.$el.append(l10n.applied_labels + "&nbsp;");
			_(own_labels).each(function (item) {
				me.$el.append(item);
			});
			this.$el.append(
				'<input type="text" placeholder="label..." />' +
				'<button type="button">' + l10n.add + '</button>'
			);
			me.$el.append("All labels: ");
			_(all_labels).each(function (item) {
				me.$el.append(item);
			});
		},
		create_label: function (e) {
			e.preventDefault();
			e.stopPropagation();

			var label = this.$el.find(":text").val(),
				data = {
					"action": "upfront-media-add_label",
					"term": label,
					"post_id": this.model.get("ID")
				}
			;
			Upfront.Util.post(data)
				.success(function (response) {
					Upfront.Events.trigger("media_manager:media:labels_updated");
				})
			;
		},
		add_label: function (e) {
			e.preventDefault();
			e.stopPropagation();
			this._update_labels(e);
		},
		drop_label: function (e) {
			e.preventDefault();
			e.stopPropagation();
			this._update_labels(e, 'dis');
		},
		_update_labels: function (e, pfx) {
			pfx = pfx || '';
			e.preventDefault();
			e.stopPropagation();
			var me = this,
				$label = $(e.target),
				idx = $label.attr("data-idx"),
				data = {
					action: "upfront-media-" + pfx + "associate_label",
					term: idx,
					post_id: this.model.get("ID")
				}
			;
			Upfront.Util.post(data)
				.success(function (response) {
					var id = me.model.get("ID"),
						data = response.data || {},
						labels = data[id] || data
					;
					me.model.set("labels", labels, {silent: true});
					me.render();
				})
			;
		}
	});

	var MediaItem_UploadNag = Backbone.View.extend({
		className: "upload_type-nag",
		events: {
			"click .keep": "keep_file",
			"click .remove": "remove_file"
		},
		render: function () {
			this.$el.empty()
				.append(l10n.video_recommendation_nag)
				.append('<a href="#" class="button keep">' + l10n.keep_file + '</a>')
				.append('<a href="#" class="button remove">' + l10n.remove_file + '</a>')
			;
		},
		keep_file: function (e) {
			e.preventDefault();
			e.stopPropagation();
		},
		remove_file: function (e) {
			e.preventDefault();
			e.stopPropagation();
			this.model.trigger("upload:abort");
		}
	});

		var MediaItem_EditorEditable = Backbone.View.extend({
			className: "upfront-media_item-editable",
			events:{
				change: "update"
			},
			template: _.template(
				"<label>{{label}}<input type='text' name='{{name}}' value='{{value}}' placeholder='{{placeholder}}' /></label>"
			),
			get_name: function () {},
			get_label: function () {},
			get_placeholder: function () {},
			get_value: function () {
				return this.$el.find('[name="' + this.get_name() + '"]:first').val();
			},
			render: function () {
				var name = this.get_name() || '',
					label = this.get_label() || '',
					placeholder = this.get_placeholder() || '',
					value = this.model.get(this.get_name()) || '',
					data = {
						name:  name,
						label: label,
						placeholder: placeholder,
						value: value
					}
				;
				this.$el.empty().append(
					this.template(data)
				);
			},
			update: function () {
				var obj = {};
				obj[this.get_name()] = this.get_value();
				this.model.set(obj, {silent: true});
			}
		});

		var MediaItem_EditorEmbedableEditable = MediaItem_EditorEditable.extend({
			update: function () {
				var obj = {};
				obj[this.get_name()] = this.get_value();
				this.model.set(obj, {silent: true});
				this.trigger("embed:updated");
			}
		});

		var MediaItem_EmbedableUrl = MediaItem_EditorEmbedableEditable.extend({
			get_name: function () { return "original_url"; },
			get_label: function () { return l10n.media_url; },
			get_placeholder: function () { return "http://sample.com/path-to-image/image.jpg"; }
		});

		var MediaItem_EditableTitle = MediaItem_EditorEditable.extend({
			get_name: function () { return "post_title"; },
			get_label: function () { return l10n.image_title; },
			get_placeholder: function () { return l10n.your_image_title; }
		});

		var MediaItem_EditableLabels = MediaItem_EditorEditable.extend({
			get_label: function () { return l10n.labels; },
			render: function () {
				var collection = new MediaCollection_Selection([this.model]),
					view = new MediaManager_ItemControl_LabelsContainer({model: collection})
				;
				view.render();
				collection.on("change", view.render_labels, view);
				this.$el.empty()
					.append('<label>' + this.get_label() + '</label>')
					.append(view.$el)
				;
			}
		});

// ----- Interface -----

	var ContentEditorUploader = Backbone.View.extend({
		initialize: function (opts) {
			this.options = opts;
		},
		open: function (options) {
			options = _.extend({
				media_type: ["images"],
				multiple_sizes: true,
				multiple_selection: true,
				button_text: l10n.ok,
				ck_insert: false,
				hold_editor: false,
			}, options);

			var me = this,
				popup = false,
				media_type = options.media_type,
				multiple_selection = options.multiple_selection,
				button_text = options.button_text
			;
			ActiveFilters.allowed_media_types = media_type;
			ActiveFilters.multiple_sizes = options.multiple_sizes;

			popup = Upfront.Popup.open(function (data, $top, $bottom) {
				me.out = this;
				me.popup_data = data;
				me.popup_data.$top = $top;
				me.popup_data.$bottom = $bottom;
				me.load(options);
			}, {width: 800, hold_editor: options.hold_editor}, 'media-manager');

			popup.always(_.bind(this.cleanup_active_filters, this));
			popup.progress($.proxy(this.clean_up, this));

			Upfront.Events.trigger('upfront:element:edit:start', 'media-upload');

			return popup;
		},
		/**
		 * Ensure everything is off when popup is closed.
		 */
		clean_up: function(flag) {
			if (flag === 'before_close') {
				Upfront.Events.trigger('upfront:element:edit:stop', 'media-upload');
			}
		},
		cleanup_active_filters: function () {
			ActiveFilters.allowed_media_types = [];
			this.cleanup_manager_view();
		},
		cleanup_manager_view: function () {
			if (this.media_manager) {
				this.media_manager.undelegateEvents();
				this.media_manager.remove();
				this.media_manage_options = undefined;
			}
		},
		load: function (options) {

			this.cleanup_manager_view();

			if (_.isUndefined(this.media_manage_options)) {
				this.media_manage_options = _.extend({
					el: this.out,
					data: this.popup_data
				}, options);
				this.media_manager = new MediaManager_View(this.media_manage_options);
			} else if(!_.isEqual(this.media_manage_options,  _.extend({ el: this.out, data: this.popup_data }, options))) {
				this.media_manage_options = _.extend({
					el: this.out,
					data: this.popup_data
				}, options);
				this.media_manager = new MediaManager_View(this.media_manage_options);
			}

			this.media_manager.render();
			return false;
		},
		results_html: function (result) {
			var html = '';
			if (result && result.each) result.each(function (item) {
				var data = item.toJSON(),
					selected_size = item.get("selected_size") || MEDIA_SIZES.FULL,
					all_sizes = item.get("additional_sizes")
				;
				if (selected_size && MEDIA_SIZES.FULL != selected_size) {
					_(all_sizes).each(function (size) {
						if (MEDIA_SIZES.to_size(size) != selected_size) return true;
						data.image = size;
					});
				}
				if ( result.type == 'gallery' )
					data.link = {
						href: '#',
						class: 'popup'
					};
				data.type = result.type;
				html += _.template( (data.link ? Upfront.Media.Templates.image_link : Upfront.Media.Templates.image), data);
			});
			if (result && result.length && result.length > 1) {
				if ( result.type == 'plain' )
					html = _.template(
						Upfront.Media.Templates.multiple,
						{content: html}
					);
				else if ( result.type == 'gallery' )
					html = _.template(
						Upfront.Media.Templates.gallery,
						{content: html}
					);
				else if ( result.type == 'slider' )
					html = _.template(
						Upfront.Media.Templates.slider,
						{content: html}
					);
			}
			return html;
		}
	});

Upfront.Media = {
	Manager: new ContentEditorUploader(),
	Templates: {
		image: '<p class="upfront-inserted_image-wrapper upfront-inserted_image-{{type}}"><img src="{{image.src}}" title="{{post_title}}" alt="{{post_title}}" height="{{image.height}}" width="{{image.width}}" /></p>',
		image_link: '<p class="upfront-inserted_image-wrapper upfront-inserted_image-{{type}}"><a href="{{link.href}}" class="{{link.class}}"><img src="{{image.src}}" title="{{post_title}}" alt="{{post_title}}" height="{{image.height}}" width="{{image.width}}" /></a></p>',
		embeddable: '<div>{{post_content}}<br />{{post_title}}</div>',
		gallery: '[upfront-gallery]{{content}}[/upfront-gallery]',
		slider: '[upfront-slider]{{content}}[/upfront-slider]',
		multiple: '{{content}}'
	},
	Transformations: {
		_transformations: _([]),
		add: function (f) {
			this._transformations.push(f);
		},
		apply: function (content) {
			this._transformations.each(function (t) {
				content = t.apply(this, [content]);
			});
			return content;
		}
	},
	Ref: (window._upfront_media_upload || {image_ref: ''}).image_ref
};

});
})(jQuery);

;(function ($, undefined) {

var deps = [
	"text!upfront/templates/content.html",
	'upfront/post-editor/upfront-post-content',
	'upfront/post-editor/upfront-post-layout'
];

define("content", deps, function(postTpl, ContentTools) {
	var PostEditor = Backbone.View.extend({
		tpl: Upfront.Util.template(postTpl),
		events: {
			'dblclick': 'editContents',
			'click a': 'preventLinkNavigation'
		},
		initialize: function(options){
			var me = this;
			this.postId = options.post_id;
			this.setElement(options.node);
			this.autostart = options.autostart || false;
			this.content_mode = options.content_mode;
			this.changed = {};

			//If the post is in the cache, prepare it!
			if(Upfront.data.posts[this.postId]){
				this.post = Upfront.data.posts[this.postId];
				if(!this.post.meta.length)
					this.post.meta.fetch();

				this.loadingPost = new $.Deferred();
				this.loadingPost.resolve(this.post);
			}

			this.postView = options.view;
			this.getPost();

			this.getPostLayout();

		},

		setDefaults: function(){
			this.mode = 'content'; // Also 'layout' to edit post layout.
		},

		getPost: function(){
			var deferred = $.Deferred();
			if(this.post){
				deferred.resolve(this.post);
				this.loadingPost = deferred.promise();
			}
			if(this.loadingPost) {
				return this.loadingPost;
			}

			var post = Upfront.data.posts[this.postId];
			if(post){
				this.post = post;
				deferred.resolve(post);
				this.loadingPost = deferred.promise();
				return this.loadingPost;
			}

			return this.fetchPost();
		},


		getPostLayout: function(){
			if(this.loadingLayout)
				return this.loadingLayout;

			var me = this,
				deferred = $.Deferred(),
				layoutData
			;

			if(me.postView.postLayout && me.postView.parts[me.postId]){
				layoutData = {
					postLayout: me.postView.postLayout,
					partOptions: me.postView.partOptions || {}
				};

				me.layoutData = true;
				me.parts = me.postView.parts[me.postId];

				deferred.resolve(layoutData);
				this.loadingLayout = deferred.promise();
				return this.loadingLayout;
			}


			this.loadingLayout = this.fetchPostLayout();
			return this.loadingLayout;
		},

		fetchPostLayout: function(){
			var deferred = $.Deferred(),
				me = this,
				layoutType = me.postView.property('type') == 'ThisPostModel' ? 'single' : 'archive',
				id = layoutType == 'single' ? this.postId : me.postView.property('element_id').replace('uposts-object-',''),
				properties = {
					hide_featured_image: me.postView.property('hide_featured_image'),
					full_featured_image: me.postView.property('full_featured_image')
				}
			;

			this.getPost().done(function(){
				Upfront.Util.post({
					action: 'upfront_get_postlayout',
					type: layoutType,
					id: id,
					layout_cascade: Upfront.Application.current_subapplication.get_layout_data().layout,
					post_id: me.postId,
					post_type: me.post.get('post_type'),
					properties: properties
				}).done(function(response){
					var layoutData = response.data;
					if(!layoutData.partOptions)
						layoutData.partOptions = {};

					_.extend(me.postView, layoutData);

					if(!me.postView.parts)
						me.postView.parts = {};

					me.postView.parts[me.postId] = layoutData.partContents;
					me.parts = layoutData.partContents;

					me.layoutData = true;

					deferred.resolve(layoutData);
				}).fail(function(error){
					console.log('error!!');
				});
			});

			return deferred.promise();
		},

		render: function(){
			var me = this,
				markupper = ContentTools.getMarkupper()
			;

			if(!this.layoutData){
				this.$el.html(Upfront.Settings.l10n.global.content.loading);
				return this.loadingLayout.done(function(){
					me.render();
				});
			}

			var wrappers = this.postView.postLayout || {},
				options = this.postView.partOptions || {},
				layout = {
					wrappers: wrappers,
					wrappersLength: wrappers.length,
					extraClasses: {},
					attributes: {}
				}
			;

			_.each(wrappers, function(wrapper, w){
				wrapper.objectsLength = wrapper.objects.length;
				_.each(wrapper.objects, function(object, o){

					var attributes = options && options[object.slug] && options[object.slug].attributes ? options[object.slug].attributes : {},
						attrs = ''
					;
					_.each(attributes, function(value, key){
						attrs += key +'="' + value + '" ';
					});

					layout.attributes[object.slug] = attrs;
					layout.extraClasses[object.slug] = options && options[object.slug] && options[object.slug].extraClasses ? options[object.slug].extraClasses : '';

					if ( object.slug in me.parts.classes && me.parts.classes[object.slug] && me.parts.classes[object.slug].length ) {
						layout.extraClasses[object.slug] = me.parts.classes[object.slug].join(' ');
					}
					
					if ( object.classes.indexOf('part-module-' + object.slug) === -1 ) {
						object.classes += ' part-module-' + object.slug;
					}

					object.markup = markupper.markup(object.slug, me.parts.replacements, me.getTemplate(object.slug));
				});
			});


			this.$el.html(this.tpl(layout));
			this.setContentPadding();
			this.trigger('rendered');


		},

		getTemplate: function(part){
			var templates = this.postView.partTemplates;

			if(part == 'contents' && this.content_mode == 'post_excerpt')
				part = 'excerpt';
			if(templates && templates[part])
				return templates[part];

			return Upfront.data.thisPost.templates[part];
		},

		fetchPost: function(){
			var me = this,
				deferred = $.Deferred()
			;
			this.post = new Upfront.Models.Post({ID: this.postId});

			//this.bindPostEvents();
			me.loadingPost = deferred.promise();
			this.post.fetch({withMeta: true, filterContent: true}).done(function(response){
				if(!Upfront.data.posts)
					Upfront.data.posts = {};
				Upfront.data.posts[me.postId] = me.post;
				deferred.resolve(me.post);
			});


			return this.loadingPost;
		},

		editContents: function(e, focusElement){
			var me = this,
				ram = function () {
					arguments.callee.iter = arguments.callee.iter || 0;
					arguments.callee.iter++;
					if (arguments.callee.iter < 30) setTimeout(function () { // Total 3s wait time
						me.editContents(e, focusElement);
					}, 100);
				}
			;

			//If we are already editing, don't do anything
			if(this.contentEditor || Upfront.Application.is_builder())// || Upfront.Application.current_subapplication == Upfront.Application.PostContentEditor)
				return;

			//If we haven't fetched all the data, return too
			if(!this.layoutData || !this.post) {
				// Yeah, so wait a bit and ram this again. It'll give at some point.
				ram();
				return;
			}

			// Make sure that the content is ready for editing, if not, render again and...
			if(this.$el.find('.upfront-content-marker').length < 1) {
				this.render();
				// Yeah, so wait a bit and ram this again. It'll give at some point.
				ram();
				return;
			}

			var target = e ? $(e.currentTarget) : focusElement;


			this.contentEditor = new ContentTools.PostContentEditor({
				post: this.post,
				postView: this.postView,
				content_mode: this.content_mode,
				el: this.el,
				triggeredBy: target,
				authorTpl: this.getTemplate('author'),
				partOptions: this.postView.partOptions,
				rawContent: this.parts.replacements['%raw_content%'],
				rawExcerpt: this.parts.replacements['%raw_excerpt%']
			});

			this.$el.closest('.upfront-wrapper').addClass('upfront-postcontent-editor');
			Upfront.Events.trigger('post:content:edit:start', this.contentEditor);

			this.listenTo(this.contentEditor, 'cancel', this.cancelChanges);
			this.listenTo(this.contentEditor, 'publish', this.publish);
			this.listenTo(this.contentEditor, 'draft', this.saveDraft);
			this.listenTo(this.contentEditor, 'auto-draft', this.saveAutoDraft);
			this.listenTo(this.contentEditor, 'trash', this.trash);

			// So let's focus on title
			this.contentEditor.focus(this.contentEditor.parts.titles, true);
		},

		stopEditContents: function(){
			this.stopListening(this.contentEditor);
			this.contentEditor.stop();
			this.contentEditor = false;
			this.$el.closest('.upfront-wrapper').removeClass('upfront-postcontent-editor');
			Upfront.Events.trigger('post:content:edit:stop', this.contentEditor);
		},

		cancelChanges: function(){
			this.stopEditContents();
			this.render();
		},

		publish: function(results){
			this.save(results, 'publish', Upfront.Settings.l10n.global.content.publishing.replace(/%s/, this.post.get('post_type')), Upfront.Settings.l10n.global.content.published.replace(/%s/, this.capitalize(this.post.get('post_type'))));
		},
		saveDraft:function(results){
			this.save(results, 'draft', Upfront.Settings.l10n.global.content.saving.replace(/%s/, this.post.get('post_type')), Upfront.Settings.l10n.global.content.drafted.replace(/%s/, this.capitalize(this.post.get('post_type'))));
		},
        saveAutoDraft:function(results){
            this.save(results, 'auto-draft');
        },
		trash: function(){
			var me = this,
				postType = this.post.get('post_type'),
				loading = new Upfront.Views.Editor.Loading({
					loading: Upfront.Settings.l10n.global.content.deleting.replace(/%s/, postType),
					done: Upfront.Settings.l10n.global.content.here_we_are,
					fixed: false
				})
			;
			loading.render();
			this.$el.append(loading.$el);
			this.post.set('post_status', 'trash').save().done(function(){
				loading.$el.remove();
				Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.content.deleted.replace(/%s/, postType));
				me.stopEditContents();

				if(me.postView.property('type') == 'UpostsModel')
					me.postView.refreshMarkup();

                // navigate to home
                Upfront.Application.sidebar.toggleSidebar();
                Upfront.Application.navigate( "/" , true);
			});
		},

		save: function(results, status, loadingMsg, successMsg){
			var me = this,
				changed = this.changed,
				updateMeta = true,
				metaUpdated = !updateMeta,
                is_auto_draft = status === "auto-draft",
                post_name = this.post.get("post_name"),
                loading = new Upfront.Views.Editor.Loading({
					loading: loadingMsg,
					done: Upfront.Settings.l10n.global.content.here_we_are,
					fixed: false
				}),
				postUpdated = false
			;

            if (!is_auto_draft && status !== 'draft') {
                loading.render();
                this.$el.append(loading.$el);
                this.contentEditor.box.$el.hide();
            } else {
                status = "draft";
            }



			if(results.title)
				this.post.set('post_title', results.title);
			if(results.content) {
				if(this.postView.property('content_type') == 'excerpt')
					this.post.set('post_excerpt', results.content);
				else
					this.post.set('post_content', results.content);
			}
			if(results.author)
				this.post.set('post_author', results.author);

            if(results.excerpt)
                this.post.set('post_excerpt', results.excerpt);

			if(results.inserts){
				this.post.meta.setValue('_inserts_data', results.inserts);
			}

			if(results.date)
				this.post.set('post_date', results.date);

			if(results.visibility){
				this.post.setVisibility(results.visibility);
				if(results.pass)
					this.post.set('post_password', results.pass);
			}

			if(results.visibility == 'private')
				this.post.set('post_status', 'private');
			else
				this.post.set('post_status', status);

			this.post.save().done(function(result){
                if( me.post.is_new && post_name.length){
                    me.post.set("post_name", post_name).save();
                }
                me.post.set("post_name", result.data.post_name);
                me.post.permalink = result.data.permalink;
				if(metaUpdated){
                    if( !is_auto_draft ) {
                        loading.done();
                        Upfront.Views.Editor.notify(successMsg);
                    }
					me.fetchPostLayout().then(function(){
                        if (!is_auto_draft && 'draft' !== status) {
                            me.stopEditContents();
                            me.render();
                        }
					});
				}

				postUpdated = true;
			});

			if(updateMeta){
				me.post.meta.save().done(function(){
                    if(postUpdated){
                        if( !is_auto_draft ) {
                            loading.done();
                            Upfront.Views.Editor.notify(successMsg);
                        }
						me.fetchPostLayout().then(function(){
                            if( !is_auto_draft ) {
                                me.stopEditContents();
                                me.render();
                            }
						});
					}
					metaUpdated = true;
				});
			}
			else
				metaUpdated

            this.post.is_new = false;
		},

		capitalize: function(str){
			return str.charAt(0).toUpperCase() + str.slice(1);
		},

		preventLinkNavigation: function(e){
			e.preventDefault();
		},

		setContentPadding: function(){
			var colSize = Upfront.Behaviors.GridEditor.col_size,
				options = this.postView.partOptions,
				rightPadding = options.contents ? options.contents.padding_right * colSize : 0,
				leftPadding = options.contents ? options.contents.padding_left * colSize : 0,
				styles = this.postView.$('.upfront-post-padding'),
				rules = '#' + this.postView.property('element_id') + ' .upfront-content-marker-contents>* {'
			;

			if(!styles.length){
				styles = $('<style class="upfront-post-padding"></style>');
				this.postView.$el.append(styles);
			}

			rules += 'padding-left: ' + leftPadding + 'px; padding-right: ' + rightPadding + 'px;}';

			styles.html(rules);
		}
	});

	// Publish the post editor to the Upfront.Content object, make sure Upfront.Content object exists
	if(!Upfront.Content)
		Upfront.Content = {};
	Upfront.Content.PostEditor = PostEditor;
});

})(jQuery);

(function($) {
	
define('scripts/upfront/bg-settings/mixins',[],function(){
	return {
		bind_toggles: function () {
			this.on('show', function(){
				this.$el.show();
			});
			this.on('hide', function(){
				this.$el.hide();
			})
		},
		save_fields: function () {
			// changes are auto saved, no need to invoke this, so blank it out
		},
		preview_color: function (color) {
			var rgb = color.toRgb(),
				rgba_string = 'rgba('+rgb.r+','+rgb.g+','+rgb.b+','+color.alpha+')';

			rgba_string = color.get_is_theme_color() !== false ?  color.theme_color : rgba_string;
			this.model.set_breakpoint_property('background_color', rgba_string);
		},
		update_color: function (color) {
			this.preview_color(color);
			this._default_color = this.model.get_breakpoint_property_value('background_color', true);
		},
		reset_color: function () {
			this.model.set_breakpoint_property('background_color', this._default_color);
		},
		upload_image: function () {
			var me = this;
			Upfront.Views.Editor.ImageSelector.open().done(function(images){
				var sizes = {},
					image_id;
				_.each(images, function(image, id){
					sizes = image;
					image_id = id;
				});
				$('<img>').attr('src', sizes.full[0]).load(function(){
					Upfront.Views.Editor.ImageSelector.close();
					me.model.set_breakpoint_property('background_image', sizes.full[0]);
					me.model.set_breakpoint_property('background_image_ratio', Math.round(sizes.full[2]/sizes.full[1]*100)/100);
				});
			});
		}
	};
});

})(jQuery);

(function($) {
	
var l10n = Upfront.Settings && Upfront.Settings.l10n
	? Upfront.Settings.l10n.global.views
	: Upfront.mainData.l10n.global.views
;

define('scripts/upfront/bg-settings/color-item',[
	'scripts/upfront/bg-settings/mixins'
], function(Mixins) {
	
	var ColorItem = Upfront.Views.Editor.Settings.Item.extend(_.extend({}, Mixins, {
		group: false,
		initialize: function (options) {
			var me = this;
			
			options.fields = [
				new Upfront.Views.Editor.Field.Color({
					model: this.model,
					label: l10n.bg_color_short,
					property: 'background_color',
					use_breakpoint_property: true,
					default_value: '#ffffff',
					spectrum: {
						move: function (color) {
							me.preview_color(color);
						},
						change: function (color) {
							me.update_color(color);
						},
						hide: function (color) {
							me.reset_color();
						}
					},
					rendered: function (){
						this.$el.addClass('uf-bgsettings-color-pick');
					}
				})
				
			];
			this.$el.addClass('uf-bgsettings-item uf-bgsettings-coloritem');
			
			this.bind_toggles();
			this.constructor.__super__.initialize.call(this, options);
		}
	}));

	return ColorItem;
});
})(jQuery);

(function($) {
	
var l10n = Upfront.Settings && Upfront.Settings.l10n
	? Upfront.Settings.l10n.global.views
	: Upfront.mainData.l10n.global.views
;

define('scripts/upfront/bg-settings/image-item',[
	'scripts/upfront/bg-settings/mixins'
], function(Mixins) {
	
	var ImageItem = Upfront.Views.Editor.Settings.Item.extend(_.extend({}, Mixins, {
		group: false,
		initialize: function (options) {
			var me = this,
				pos_option = {
					default_value: 50,
					min: 0,
					max: 100,
					step: 1
				},
				tile_fields = ['bg_tile'],
				fixed_fields = ['bg_color', 'bg_position_x', 'bg_position_y', 'bg_position_x_num', 'bg_position_y_num'],
				fields = {
					pick_image: new Upfront.Views.Editor.Field.Button({
						label: l10n.pick_image,
						compact: true,
						classname: 'uf-button-alt uf-bgsettings-image-pick',
						on_click: function(){
							me.upload_image();
						}
					}),
					bg_style: new Upfront.Views.Editor.Field.Select({
						model: this.model,
						label: l10n.image_type,
						className: 'upfront-field-wrap upfront-field-wrap-select background-image-field',
						property: 'background_style',
						use_breakpoint_property: true,
						default_value: 'full',
						icon_class: 'upfront-region-field-icon',
						values: this.get_bg_style_values(),
						change: function () {
							var value = this.get_value();
							if ( value == 'tile' ){
								_.each(tile_fields, function(key){ fields[key].$el.show(); });
								_.each(fixed_fields, function(key){ fields[key].$el.hide(); });
							}
							else if ( value == 'fixed' ){
								_.each(tile_fields, function(key){ fields[key].$el.hide(); });
								_.each(fixed_fields, function(key){ fields[key].$el.show(); });
							}
							else {
								_.each(tile_fields, function(key){ fields[key].$el.hide(); });
								_.each(fixed_fields, function(key){ fields[key].$el.hide(); });
							}
							me._bg_style = value;
							me.update_image();
						},
						rendered: function (){
							this.$el.addClass('uf-bgsettings-image-style');
						}
					}),
					bg_tile: new Upfront.Views.Editor.Field.Checkboxes({
						model: this.model,
						layout: 'horizontal-inline',
						default_value: ['y', 'x'],
						values: [
							{ label: l10n.tile_vertically, value: 'y' },
							{ label: l10n.tile_horizontally, value: 'x' }
						],
						change: function () {
							var value = this.get_value();
							me._bg_tile = value;
							me.update_image();
						},
						rendered: function (){
							this.$el.addClass('uf-bgsettings-image-tile');
						}
					}),
					bg_color: new Upfront.Views.Editor.Field.Color({
						model: this.model,
						label: l10n.bg_color_short,
						property: 'background_color',
						use_breakpoint_property: true,
						default_value: '#ffffff',
						spectrum: {
							move: function (color) {
								me.preview_color(color);
							},
							change: function (color) {
								me.update_color(color);
							},
							hide: function (color) {
								me.reset_color();
							}
						},
						rendered: function (){
							this.$el.addClass('uf-bgsettings-image-color');
						}
					}),
					bg_position_y: new Upfront.Views.Editor.Field.Slider(_.extend({
						model: this.model,
						label: l10n.image_position,
						orientation: 'vertical',
						property: 'background_position_y',
						use_breakpoint_property: true,
						range: false,
						change: function () {
							var value = this.get_value();
							fields.bg_position_y_num.get_field().val(value);
							me._bg_position_y = value;
							this.model.set_breakpoint_property(this.property_name, value);
							me.update_image();
						},
						rendered: function (){
							this.$el.addClass('uf-bgsettings-image-pos-y');
						}
					}, pos_option)),
					bg_position_x: new Upfront.Views.Editor.Field.Slider(_.extend({
						model: this.model,
						property: 'background_position_x',
						use_breakpoint_property: true,
						range: false,
						change: function () {
							var value = this.get_value();
							fields.bg_position_x_num.get_field().val(value);
							me._bg_position_x = value;
							this.model.set_breakpoint_property(this.property_name, value);
							me.update_image();
						},
						rendered: function (){
							this.$el.addClass('uf-bgsettings-image-pos-x');
						}
					}, pos_option)),
					bg_position_y_num: new Upfront.Views.Editor.Field.Number(_.extend({
						model: this.model,
						label: "Y:",
						label_style: 'inline',
						suffix: '%',
						change: function () {
							var value = this.get_value(),
								s = fields.bg_position_y;
							s.$el.find('#'+s.get_field_id()).slider('value', value);
							s.get_field().val(value);
							s.trigger('changed');
						},
						rendered: function (){
							this.$el.addClass('uf-bgsettings-image-pos-y-num');
						}
					}, pos_option)),
					bg_position_x_num: new Upfront.Views.Editor.Field.Number(_.extend({
						model: this.model,
						label: "X:",
						label_style: 'inline',
						suffix: '%',
						change: function () {
							var value = this.get_value(),
								s = fields.bg_position_x;
							s.$el.find('#'+s.get_field_id()).slider('value', value);
							s.get_field().val(value);
							s.trigger('changed');
						},
						rendered: function (){
							this.$el.addClass('uf-bgsettings-image-pos-x-num');
						}
					}, pos_option))
				};
			this.$el.addClass('uf-bgsettings-item uf-bgsettings-imageitem');
			options.fields = _.map(fields, function(field){ return field; });
			
			this.on('show', function(){
				var bg_type = me.model.get_breakpoint_property_value('background_type', true),
					bg_image = me.model.get_breakpoint_property_value('background_image', true);
				if ( bg_type == 'featured' ) {
					fields.pick_image.$el.hide();
				}
				else {
					if ( !bg_image )
						me.upload_image();
				}
				me._bg_style = fields.bg_style.get_value();
				me._bg_tile = fields.bg_tile.get_value();
				me._bg_position_y = fields.bg_position_y.get_value();
				fields.bg_position_y.trigger('changed');
				me._bg_position_x = fields.bg_position_x.get_value();
				fields.bg_position_x.trigger('changed');
				//me._default_color = fields.bg_color.get_value();
				fields.bg_style.trigger('changed');
			});
			
			this.bind_toggles();
			this.constructor.__super__.initialize.call(this, options);
		},
		update_image: function () {
			var style = this._bg_style,
				tile = this._bg_tile,
				is_repeat_y = _.contains(tile, 'y'),
				is_repeat_x = _.contains(tile, 'x'),
				pos_y = this._bg_position_y,
				pos_x = this._bg_position_x;
			if ( style == 'full' ) {
				this.model.set_breakpoint_property('background_style', 'full');
			}
			else {
				if ( style == 'tile' ){
					this.model.set_breakpoint_property('background_style', 'tile');
					if ( is_repeat_x && is_repeat_y )
						this.model.set_breakpoint_property('background_repeat', 'repeat');
					else if ( is_repeat_y )
						this.model.set_breakpoint_property('background_repeat', 'repeat-y');
					else if ( is_repeat_x )
						this.model.set_breakpoint_property('background_repeat', 'repeat-x');
					else
						this.model.set_breakpoint_property('background_repeat', 'no-repeat');
				}
				else if ( style == 'fixed' ){
					this.model.set_breakpoint_property('background_style', 'fixed');
					this.model.set_breakpoint_property('background_repeat', 'no-repeat');
					this.model.set_breakpoint_property('background_position', pos_x + '% ' + pos_y + '%');
				}
				else {
					this.model.set_breakpoint_property('background_style', style);
				}
			}
		},
		get_bg_style_values: function () {
			var values = [
				{ label: l10n.full_width_bg, value: 'full', icon: 'bg-image-full' },
				{ label: l10n.tiled_pattern, value: 'tile', icon: 'bg-image-tile' },
				{ label: l10n.fixed_position, value: 'fixed', icon: 'bg-image-fixed' }
			];
			if ( this.model instanceof Upfront.Models.Region ) {
				values.push({ label: l10n.parallax, value: 'parallax', icon: 'bg-image-full' });
			}
			return values;
		}
	}));

	return ImageItem;
});
})(jQuery);


define('text!scripts/upfront/templates/map-editor.html',[],function () { return '\r\n<div class="upfront_map-editor-complex-wrapper">\r\n\t<div class="upfront-css-top">\r\n\t\t<div class="upfront_map-custom_map_code" data-for="script">{{ l10n.custom_map_code }}</div>\r\n\t\t<i class="upfront-icon-info">{{ l10n.paste_below }}</i>\r\n\t\t<div class="upfront_map-jsalert error javascript"><i class="upfront-icon-button" title="{{ l10n.code_error }}"></i></div>\r\n\t\t<a class="upfront-css-close" href="#">{{ l10n.close }}</a>\r\n\t</div>\r\n\t<div class="upfront-css-body">\r\n\t\t<div class="upfront_map-editor-section upfront_map-script active">\r\n\t\t\t<div class="upfront_map-ace" data-type="script" >{{script}}</div>\r\n\t\t</div>\r\n\t\t<button>{{ l10n.save }}</button>\r\n\t</div>\r\n</div>\r\n';});

(function ($) {
	
var l10n = Upfront.Settings && Upfront.Settings.l10n
	? Upfront.Settings.l10n.global.views
	: Upfront.mainData.l10n.global.views
;

define('scripts/upfront/inline-panels/map-editor',[
	'text!scripts/upfront/templates/map-editor.html'
], function (editorTpl) {

	var MapEditorView = Upfront.Views.ObjectView.extend({

		is_editing: false,
		script_error: false,

		SYNTAX_TYPES: {
			"script": "json"
		},

		MIN_HEIGHT: 200,

		editorTpl: _.template(editorTpl),

		content_editable_selector: ".editable",

		initialize: function() {
			var json = this.fallback('script');
			this.checkJSon(json);
		},

		on_render: function () {
			this.start_json_editor();
		},

		start_json_editor: function () {
			if (this.is_editing) return false;

			this.is_editing = true;
			var $editor = $('#upfront_map-editor'),
				me = this
			;

			if(!$editor.length){
				$editor = $('<section id="upfront_map-editor" class="upfront-ui upfront_map-editor upfront_map-editor-complex"></section>');
				$('body').append($editor);
			}

			require([Upfront.Settings.ace_url], function () {
				me.createEditor($editor);
			});

		},

		on_edit: function(){
			if (this.is_editing) return false;

			// Since we're doing double duty here, let's first check if content editing mode is to boot
			var $contenteditables = this.$el.find('.upfront_map-element ' + this.content_editable_selector);
			if ($contenteditables.length) {
				// Yes? go for it
				return this.bootContentEditors($contenteditables);
			}
			// Oh well, let's just go ahead and boot code editing mode.
			this.is_editing = true;
			var $editor = $('#upfront_map-editor');

			if(!$editor.length){
				$editor = $('<section id="upfront_map-editor" class="upfront-ui upfront_map-editor upfront_map-editor-complex"></section>');
				$('body').append($editor);
			}

			this.createEditor($editor);
		},

		bootContentEditors: function ($editables) {
			if (!$editables || !$editables.length) return false;
			var $markup = $(this.fallback("markup")),
				me = this
			;
			$editables.each(function (idx) {
				var $me = $(this),
					start = idx <= 0
				;
				if ($me.data('ueditor')) return true;
				$me
					.ueditor({
						autostart: start,
						placeholder: "",
						disableLineBreak: true
					})
					.on("start", function () {
						me.is_editing = true;
					})
					.on("stop", function () {
						me.is_editing = false;
					})
					.on('syncAfter', function(){
						var $existing = $($markup.find(me.content_editable_selector)[idx]);
						if (!$existing.length) return false;
						$existing.html($me.html());
						me.property(
							"markup",
							$("<div />").append($markup).html()
						);
					})
				;
			});
		},

		createEditor: function($editor){
			var me = this;
			$editor.html(this.editorTpl({
				markup: this.fallback('markup'),
				style: this.fallback('style'),
				script: this.fallback('script'),
				l10n: l10n.template
			}));

			$('#page').css('padding-bottom', '200px');
			$editor.show();

			this.resizeHandler = this.resizeHandler || function(){
				$editor.width($(window).width() - $('#sidebar-ui').width() -1);
			};
			$(window).on('resize', this.resizeHandler);
			this.resizeHandler();

			//Start the editors
			this.editors = {};
			this.timers = {};

			$editor.find('.upfront_map-ace').each(function(){
				var $this = $(this),
					html = $this.html(),
					editor = ace.edit(this),
					syntax = $this.data('type')
				;

				editor.getSession().setUseWorker(false);
				editor.setTheme("ace/theme/monokai");
				editor.getSession().setMode("ace/mode/" + me.SYNTAX_TYPES[syntax]);
				editor.setShowPrintMargin(false);

				if ("markup" === syntax && html)
						editor.getSession().setValue(html);

				// Live update
				editor.on('change', function(){
					if(me.timers[syntax])
						clearTimeout(me.timers[syntax]);
					me.timers[syntax] = setTimeout(function(){
						var value = editor.getValue();

						if(syntax == 'script')
							me.checkJSon(value);

						if(me.script_error)
							$editor.find('.upfront_map-jsalert').show().find('i').attr('title', l10n.create.js_error + ' ' + me.script_error);
						else
							$editor.find('.upfront_map-jsalert').hide();

						me.property(syntax, value, false);
					}, 1000);
				});

				// Set up the proper vscroller width to go along with new change.
				editor.renderer.scrollBar.width = 5;
				editor.renderer.scroller.style.right = "5px";

				me.editors[syntax] = editor;
			});
			this.currentEditor = this.editors['markup'];

			var editorTop = $editor.find('.upfront-css-top'),
				editorBody = $editor.find('.upfront-css-body')
			;

			//Start resizable
			editorBody.height(this.MIN_HEIGHT - editorTop.outerHeight());
			$editor.find(".upfront_map-editor-complex-wrapper").resizable({
				handles: {
					n: ".upfront-css-top"
				},
				resize: function(e, ui){
					editorBody.height(ui.size.height - editorTop.outerHeight());
					_.each(me.editors, function(editor){
						editor.resize();
					});
				},
				minHeight: me.MIN_HEIGHT,
				delay:  100
			});

			//save edition
			$editor.find('button').on('click', function(e){
				_.each(me.editors, function(editor, type){
					me.property(type, editor.getValue());
				});

				me.property('map_styles', me.fallback('script'), false);
				me.is_editing = false;
				me.destroyEditor();
			});

			//Highlight element
			$editor
				.on('click', '.upfront-css-type', function(e){
					me.hiliteElement(e);
				}) // Close editor
				.on('click', '.upfront-css-close', function(e){
					e.preventDefault();
					me.destroyEditor();
					$('#page').css('padding-bottom', 0);
				})
			;
		},

		destroyEditor: function(){
			var me = this;
			if(this.editors && this.editors.length){
				_.each(this.editors, function(ed){
					ed.destroy();
				});
				me.editors = false;
			}
			this.currentEditor = false;
			$('#upfront_map-editor').html('').hide();
			$(window).off('resize', this.resizeHandler);
			this.is_editing = false;
		},

		hiliteElement: function(e){
			e.preventDefault();
			var element = this.$el.find('.upfront-object-content');
			var offset = element.offset().top - 50;
			$(document).scrollTop(offset > 0 ? offset : 0);
			this.blink(element, 4);
		},

		blink: function(element, times) {
			var me = this;
			element.css('outline', '3px solid #3ea');
			setTimeout(function(){
				element.css('outline', 'none');

				times--;
				if(times > 0){
					setTimeout(function(){
						me.blink(element, times - 1);
					}, 100);
				}

			}, 100);
		},

		checkJSon: function(json){
			this.script_error = false;
			try {
				eval(json);
			} catch (e) {
				this.script_error = e.message;
			}
		},

		fallback: function(attribute){
			return this.model.get_property_value_by_name(attribute) || Upfront.data.upfront_code.defaults.fallbacks[attribute];
		},

		property: function(name, value, silent) {
			if(typeof value != "undefined"){
				if(typeof silent == "undefined")
					silent = true;
				return this.model.set_property(name, value, silent);
			}
			return this.model.get_property_value_by_name(name);
		}
	});

	return MapEditorView;

});

})(jQuery);

(function($) {
	
var l10n = Upfront.Settings && Upfront.Settings.l10n
	? Upfront.Settings.l10n.global.views
	: Upfront.mainData.l10n.global.views
;

define('scripts/upfront/bg-settings/map-item',[
	'scripts/upfront/bg-settings/mixins',
	'scripts/upfront/inline-panels/map-editor'
], function(Mixins, MapEditorView) {
	
	var MapItem = Upfront.Views.Editor.Settings.Item.extend(_.extend({}, Mixins, {
		events: {
			"click .open-map-code-panel-button": "init_code_panel"
		},
		group: false,
		initialize: function (options) {
			var me = this,
				map_center = this.model.get_property_value_by_name('background_map_center'),
				set_value = function () {
					var value = this.get_value();
					this.model.set_breakpoint_property(this.property_name, value);
				};
				
			if ( ! map_center ){
				this.model.init_property('background_map_center', [-37.8180, 144.9760]);
				this.model.init_property('background_map_zoom', 10);
				this.model.init_property('background_map_style', "ROADMAP");
				this.model.init_property('background_map_controls', "");
				this.model.init_property('background_show_markers', "");
				this.model.init_property('background_use_custom_map_code', "");
			}
			
			var fields = {
					location: new Upfront.Views.Editor.Field.Text({
						model: this.model,
						label: l10n.location + ":",
						property: 'background_map_location',
						use_breakpoint_property: true,
						placeholder: "e.g 123 Nice St",
						change: function () {
							var value = this.get_value();
							this.model.set_breakpoint_property(this.property_name, value, true);
							me._location = value;
							me._location_changed = true;
						},
						rendered: function (){
							this.$el.addClass('uf-bgsettings-map-location');
						}
					}),
					refresh: new Upfront.Views.Editor.Field.Button({
						label: "",
						compact: true,
						classname: 'upfront-field-icon upfront-field-icon-refresh-2 upfront-refresh-map',
						on_click: function(){
							var $loc = me.$el.find('input[name="background_map_location"]');
							if ($loc.length) me._location = $loc.val();
							me._location_changed = true;
							me.geocode_location();
						}
					}),
					zoom: new Upfront.Views.Editor.Field.Slider({
						model: this.model,
						label: l10n.zoom + ":",
						property: 'background_map_zoom',
						use_breakpoint_property: true,
						default_value: 8,
						min: 1,
						max: 19,
						step: 1,
						change: set_value,
						rendered: function (){
							this.$el.addClass('uf-bgsettings-map-zoom');
						}
					}),
					style: new Upfront.Views.Editor.Field.Select({
						model: this.model,
						label: l10n.map_style + ":",
						property: 'background_map_style',
						use_breakpoint_property: true,
						values: [
							{ label: l10n.roadmap, value: 'ROADMAP' },
							{ label: l10n.satellite, value: 'SATELLITE' },
							{ label: l10n.hybrid, value: 'HYBRID' },
							{ label: l10n.terrain, value: 'TERRAIN' }
						],
						change: set_value,
						rendered: function (){
							this.$el.addClass('uf-bgsettings-map-style');
						}
					}),
					controls: new Upfront.Views.Editor.Field.Select({
						model: this.model,
						label: l10n.controls + ":",
						placeholder: l10n.choose_ctrl,
						property: 'background_map_controls',
						use_breakpoint_property: true,
						multiple: true,
						default_value: ["pan"],
						values: [
							{ label: l10n.pan, value: "pan" },
							{ label: l10n.zoom, value: "zoom" },
							{ label: l10n.map_type, value: "map_type" },
							{ label: l10n.scale, value: "scale" },
							{ label: l10n.street_view, value: "street_view" },
							{ label: l10n.overview_map, value: "overview_map" }
						],
						change: set_value,
						rendered: function (){
							this.$el.addClass('uf-bgsettings-map-controls');
						}
					}),
					show_markers: new Upfront.Views.Editor.Field.Checkboxes({
						model: this.model,
						label: l10n.show_markers,
						property: "background_show_markers",
						use_breakpoint_property: true,
						hide_label: true,
						values: [{label: l10n.show_markers, value: 1}],
						multiple: false,
						change: set_value,
						rendered: function () {
							this.$el.addClass('uf-bgsettings-map-show-marker');
						}
					}),
					custom_map_code: new Upfront.Views.Editor.Field.Checkboxes({
						model: this.model,
						label: l10n.custom_map_code,
						property: "background_use_custom_map_code",
						hide_label: true,
						values: [{label: l10n.custom_map_code + '<span class="checkbox-info" title="' + l10n.custom_map_code_info + '"></span>', value: 1}],
						multiple: false,
						change: function () {
							var value = this.get_value();

							this.property.set({value: value});

							if(value == 1) {
								$('.open-map-code-panel-button', this.$el.parent()).show();
							}
							else {
								$('.open-map-code-panel-button', this.$el.parent()).hide();
							}
						},
						rendered: function () {
							this.$el.addClass('uf-bgsettings-map-custom-map-code');
						}
					}),
					open_map_code_panel: new Upfront.Views.Editor.Field.Button({
						model: me.model,
						label: l10n.open_map_code_panel,
						className: "open-map-code-panel-button",
						compact: true,
					}),
				};
			
			this.$el.addClass('uf-bgsettings-item uf-bgsettings-mapitem');
			
			options.fields = _.map(fields, function(field){ return field; });
			
			this._location = fields.location.get_value();
			
			this.$el.on('keypress', 'input[name="background_map_location"]', function (e) {
				if( e.keyCode === 13 ){
					me._location = $(this).val();
					me._location_changed = true;
					me.geocode_location();
				}
			});
			
			this.bind_toggles();
			this.constructor.__super__.initialize.call(this, options);
		},
		render: function () {
			Upfront.Views.Editor.Settings.Item.prototype.render.call(this);
			$('[name="background_use_custom_map_code"]', this.$el).trigger('change');
		},
		geocode_location: function () {
			if ( this._geocoding == true || !this._location_changed )
				return;
			var me = this,
				location = this._location,
				geocoder = new google.maps.Geocoder()
			;
			if (!location) return;
			this._geocoding = true;
			geocoder.geocode({address: location}, function (results, status) {
				if (status != google.maps.GeocoderStatus.OK) return false;
				var pos = results[0].geometry.location;

				me.model.set_breakpoint_property("background_map_center", [pos.lat(), pos.lng()]);
				me._geocoding = false;
				me._location_changed = false;
			});
		},
		init_code_panel: function () {
			var view = new MapEditorView({model: this.model});
			view.render();
		}
	}));

	return MapItem;
});
})(jQuery);

(function($) {
	
var l10n = Upfront.Settings && Upfront.Settings.l10n
	? Upfront.Settings.l10n.global.views
	: Upfront.mainData.l10n.global.views
;

define('scripts/upfront/bg-settings/slider-item',[
	'scripts/upfront/bg-settings/mixins'
], function(Mixins) {
	
	var SliderItem = Upfront.Views.Editor.Settings.Item.extend(_.extend({}, Mixins, {
		group: false,
		initialize: function (options) {
			var me = this,
				set_value = function () {
					var value = this.get_value();
					this.model.set_breakpoint_property(this.property_name, value);
				},
				fields = {
					transition: new Upfront.Views.Editor.Field.Select({
						model: this.model,
						label: l10n.slider_transition,
						property: 'background_slider_transition',
						use_breakpoint_property: true,
						default_value: 'crossfade',
						icon_class: 'upfront-region-field-icon',
						values: [
							{ label: l10n.slide_down, value: 'slide-down', icon: 'bg-slider-slide-down' },
							{ label: l10n.slide_up, value: 'slide-up', icon: 'bg-slider-slide-up' },
							{ label: l10n.slide_left, value: 'slide-left', icon: 'bg-slider-slide-left' },
							{ label: l10n.slide_right, value: 'slide-right', icon: 'bg-slider-slide-right' },
							{ label: l10n.crossfade, value: 'crossfade', icon: 'bg-slider-crossfade' }
						],
						change: set_value,
						rendered: function (){
							this.$el.addClass('uf-bgsettings-slider-transition');
						}
					}),
					rotate: new Upfront.Views.Editor.Field.Checkboxes({
						model: this.model,
						property: 'background_slider_rotate',
						use_breakpoint_property: true,
						default_value: true,
						layout: 'horizontal-inline',
						multiple: false,
						values: [ { label: l10n.autorotate_each + " ", value: true } ],
						change: function () {
							var value = this.get_value();
							this.property.set({value: value ? true : false});
						},
						rendered: function (){
							this.$el.addClass('uf-bgsettings-slider-rotate');
						}
					}),
					rotate_time: new Upfront.Views.Editor.Field.Number({
						model: this.model,
						property: 'background_slider_rotate_time',
						use_breakpoint_property: true,
						default_value: 5,
						min: 1,
						max: 60,
						step: 1,
						suffix: 'sec',
						change: set_value,
						rendered: function (){
							this.$el.addClass('uf-bgsettings-slider-time');
						}
					}),
					control: new Upfront.Views.Editor.Field.Radios({
						model: this.model,
						property: 'background_slider_control',
						use_breakpoint_property: true,
						default_value: 'always',
						layout: 'horizontal-inline',
						values: [
							{ label: l10n.always_show_ctrl, value: 'always' },
							{ label: l10n.show_ctrl_hover, value: 'hover' }
						],
						change: set_value,
						rendered: function (){
							this.$el.addClass('uf-bgsettings-slider-control');
						}
					})
				};
			
			this.$el.addClass('uf-bgsettings-item uf-bgsettings-slideritem');
			
			options.fields = _.map(fields, function(field){ return field; });
			
			// Also add the slides item to the panel settings
			this.slides_item = new SliderSlidesItem({
				model: this.model,
				title: l10n.slides_order + ":"
			});
			if ( !_.isUndefined(options.slides_item_el) ){
				this.slides_item.render();
				options.slides_item_el.append(this.slides_item.$el);
			}
			else {
				this.on('panel:set', function(){
					me.panel.settings.push(me.slides_item);
					me.slides_item.panel = me.panel;
					me.slides_item.trigger('panel:set');
				});
			}
			this.on('show', function(){
				var slide_images = this.model.get_breakpoint_property_value('background_slider_images', true);
				if ( !slide_images )
					me.upload_slider_images();
				me.slides_item.trigger('show');
			});
			this.on('hide', function(){
				me.slides_item.trigger('hide');
			});
			
			
			
			this.bind_toggles();
			this.constructor.__super__.initialize.call(this, options);
		},
		upload_slider_images: function () {
			var me = this;
			Upfront.Views.Editor.ImageSelector.open({multiple: true}).done(function(images){
				var image_ids = [];
				_.each(images, function(image, id){
					image_ids.push(id);
				});
				me.model.set_breakpoint_property('background_slider_images', image_ids);
				//me.update_slider_slides($slides_content);
				me.slides_item.update_slider_slides();
				Upfront.Views.Editor.ImageSelector.close();
			});
		}
	}));
	
	var SliderSlidesItem = Upfront.Views.Editor.Settings.Item.extend(_.extend({}, Mixins, {
		initialize: function (options) {
			var me = this;
			
			this.$el.on('click', '.upfront-region-bg-slider-add-image', function (e) {
				e.preventDefault();
				e.stopPropagation();
				Upfront.Views.Editor.ImageSelector.open({multiple: true}).done(function(images){
					var slide_images = _.clone(me.model.get_breakpoint_property_value('background_slider_images', true) || []);
					_.each(images, function(image, id){
						slide_images.push(id);
					});
					me.model.set_breakpoint_property('background_slider_images', slide_images);
					Upfront.Views.Editor.ImageSelector.close();
					me.update_slider_slides();
				});
			});
			this.$el.on('click', '.upfront-region-bg-slider-delete-image', function (e) {
				e.preventDefault();
				e.stopPropagation();
				var $image = $(this).closest('.upfront-region-bg-slider-image'),
					image_id = $image.data('image-id'),
					slide_images = me.model.get_breakpoint_property_value('background_slider_images', true);

				if (_.isString(image_id) && image_id.match(/^[0-9]+$/))
					image_id = parseInt(image_id, 10);

				slide_images = _.without(slide_images, image_id);
				me.model.set_breakpoint_property('background_slider_images', slide_images);
				$image.remove();
				
				me.update_slider_slides();
			});
			
			this.on('show', function(){
				me.update_slider_slides();
			});
			
			this.$el.addClass('uf-bgsettings-item uf-bgsettings-slider-slidesitem');
			
			this.bind_toggles();
			this.constructor.__super__.initialize.call(this, options);
		},
		update_slider_slides: function () {
			var me = this,
				slide_images = me.model.get_breakpoint_property_value('background_slider_images', true),
				$add = $('<div class="upfront-region-bg-slider-add-image upfront-icon upfront-icon-region-add-slide">' + l10n.add_slide + '</div>'),
				$wrap = this.$el.find('.upfront-settings-item-content');
			$wrap.html('');

			if ( slide_images.length > 0 ) {
				Upfront.Views.Editor.ImageEditor.getImageData(slide_images).done(function(response){
					var images = response.data.images;
					// Rewrite slide images because in builder mode they will be just paths of theme images
					// and slider needs image objects to work.
					//slide_images = images;
					_.each(slide_images, function (id) {
						var image = _.isNumber(id) || id.match(/^\d+$/) ? images[id] : _.find(images, function(img){
							return img.full[0].split(/[\\/]/).pop() == id.split(/[\\/]/).pop();
						}),
						$image = $('<div class="upfront-region-bg-slider-image" />');
						$image.data('image-id', id);
						if(typeof image.thumbnail !== "undefined") {
							$image.css({
								background: 'url("' + image.thumbnail[0] + '") no-repeat 50% 50%',
								backgroundSize: '100% auto'
							});
						}
						$image.append('<span href="#" class="upfront-region-bg-slider-delete-image">&times;</span>');
						$wrap.append($image);
					});
					if ( $wrap.hasClass('ui-sortable') )
						$wrap.sortable('refresh');
					else
						$wrap.sortable({
							items: '>  .upfront-region-bg-slider-image',
							update: function () {
								var slide_images = [];
								$wrap.find('.upfront-region-bg-slider-image').each(function(){
									var id = $(this).data('image-id');
									if ( id )
										slide_images.push(id);
								});
								me.model.set_breakpoint_property('background_slider_images', slide_images);
							}
						});
					$wrap.append($add);
				});
			}
			else {
				$wrap.append($add);
			}
		}
	}));

	return SliderItem;
});
})(jQuery);

(function($) {
	
var l10n = Upfront.Settings && Upfront.Settings.l10n
	? Upfront.Settings.l10n.global.views
	: Upfront.mainData.l10n.global.views
;

define('scripts/upfront/bg-settings/video-item',[
	'scripts/upfront/bg-settings/mixins'
], function(Mixins) {
	
	var VideoItem = Upfront.Views.Editor.Settings.Item.extend(_.extend({}, Mixins, {
		group: false,
		initialize: function (options) {
			var me = this,
				fields = {
					mute: new Upfront.Views.Editor.Field.Checkboxes({
						model: this.model,
						property: 'background_video_mute',
						use_breakpoint_property: true,
						default_value: 1,
						layout: 'horizontal-inline',
						multiple: false,
						values: [ { label: l10n.mute_on_play, value: 1 } ],
						change: function () {
							var value = this.get_value();
							this.model.set_breakpoint_property(this.property_name, value ? 1 : 0);
						},
						rendered: function (){
							this.$el.addClass('uf-bgsettings-video-mute');
						}
					}),
					autoplay: new Upfront.Views.Editor.Field.Checkboxes({
						model: this.model,
						property: 'background_video_autoplay',
						use_breakpoint_property: true,
						default_value: 1,
						layout: 'horizontal-inline',
						multiple: false,
						values: [ { label: l10n.autoplay, value: 1 } ],
						change: function () {
							var value = this.get_value();
							this.model.set_breakpoint_property(this.property_name, value ? 1 : 0);
						},
						rendered: function (){
							this.$el.addClass('uf-bgsettings-video-autoplay');
						}
					}),
					style: new Upfront.Views.Editor.Field.Radios({
						model: this.model,
						property: 'background_video_style',
						use_breakpoint_property: true,
						layout: 'horizontal-inline',
						default_value: ["crop"],
						values: [
							{ label: l10n.scale_and_crop, value: "crop" },
							{ label: l10n.no_crop_embed, value: "full" },
							{ label: l10n.no_crop_bg, value: "inside" }
						],
						change: function () {
							var value = this.get_value();
							if ( value == 'inside' )
								fields.color.$el.show();
							else
								fields.color.$el.hide();
							this.model.set_breakpoint_property(this.property_name, value);
						},
						rendered: function (){
							this.$el.addClass('uf-bgsettings-video-style');
						}
					}),
					color: new Upfront.Views.Editor.Field.Color({
						model: this.model,
						label: l10n.area_bg_color + ":",
						label_style: 'inline',
						property: 'background_color',
						use_breakpoint_property: true,
						default_value: '#ffffff',
						spectrum: {
							move: function (color) {
								me.preview_color(color);
							},
							change: function (color) {
								me.update_color(color);
							},
							hide: function (color) {
								me.reset_color();
							}
						},
						rendered: function (){
							this.$el.addClass('uf-bgsettings-video-color');
						}
					}),
					video: new Upfront.Views.Editor.Field.Text({
						model: this.model,
						label: l10n.video_url,
						property: 'background_video',
						use_breakpoint_property: true,
						default_value: '',
						placeholder: l10n.video_source,
						change: function () {
							var value = this.get_value();
							if ( value ){
								me.model.set_breakpoint_property('background_video_embed', "");
								me.get_video_embed(value).done(function(response){
									if ( !response.data || !response.data.width || !response.data.height )
										return;
									me.model.set_breakpoint_property('background_video_width', response.data.width);
									me.model.set_breakpoint_property('background_video_height', response.data.height);
									me.model.set_breakpoint_property('background_video_embed', response.data.html);
								});
							}
							this.model.set_breakpoint_property(this.property_name, value);
						},
						rendered: function (){
							this.$el.addClass('uf-bgsettings-video-url');
						}
					})
				};
				
			this.$el.addClass('uf-bgsettings-item uf-bgsettings-videoitem');
				
			options.fields = _.map(fields, function(field){ return field; });
			
			this.on('show', function(){
				fields.style.trigger('changed');
			})
			
			this.bind_toggles();
			this.constructor.__super__.initialize.call(this, options);
		},
		get_video_embed: function (url) {
			return Upfront.Util.post({
				action: "upfront-media-get_embed_raw",
				media: url
			});
		}
	}));

	return VideoItem;
});
})(jQuery);

(function($) {
	
var l10n = Upfront.Settings && Upfront.Settings.l10n
	? Upfront.Settings.l10n.global.views
	: Upfront.mainData.l10n.global.views
;

define('bg-settings',[
	'scripts/upfront/bg-settings/color-item',
	'scripts/upfront/bg-settings/image-item',
	'scripts/upfront/bg-settings/map-item',
	'scripts/upfront/bg-settings/slider-item',
	'scripts/upfront/bg-settings/video-item'
], function(ColorItem, ImageItem, MapItem, SliderItem, VideoItem) {
	
	var BgItem = Upfront.Views.Editor.Settings.Item.extend({
		initialize: function (options) {
			var me = this,
				bg_image = this.model.get_breakpoint_property_value('background_image', true),
				types = [
					{ label: l10n.solid_color, value: 'color', icon: 'color' },
					{ label: l10n.image, value: 'image', icon: 'image' },
					{ label: l10n.video, value: 'video', icon: 'video' },
					{ label: l10n.image_slider, value: 'slider', icon: 'slider' },
					{ label: l10n.map, value: 'map', icon: 'map' }
				];
				
			if (_upfront_post_data.post_id) {
				types.push({ label: l10n.featured_image, value: 'featured', icon: 'feat' });
			}
			if ( _.isArray(options.enable_types) )
				types = _.filter(types, function(type){
					return _.contains(options.enable_types, type.value);
				});
			
			options.fields = [
				new Upfront.Views.Editor.Field.Checkboxes({
					model: this.model,
					property: 'use_padding',
					use_breakpoint_property: true,
					default_value: 0,
					layout: 'horizontal-inline',
					multiple: false,
					values: [ { label: l10n.use_theme_padding, value: 1 } ],
					change: function () {
						var value = this.get_value();
						this.model.set_breakpoint_property(this.property_name, value ? 1 : 0);
					}
				}),
				new Upfront.Views.Editor.Field.Select({
					model: this.model,
					className: 'upfront-field-wrap upfront-field-wrap-select background-type-field',
					label: l10n.group_bg,
					property: 'background_type',
					use_breakpoint_property: true,
					default_value: !bg_image ? 'color' : 'image',
					icon_class: 'upfront-region-field-icon',
					values: types,
					change: function () {
						var value = this.get_value();
						me.panel.parent_view.toggle_setting(value);
						this.model.set_breakpoint_property(this.property_name, value);
					}
				})
			];
			this.$el.addClass('uf-bgsettings-item');
			this.constructor.__super__.initialize.call(this, options);
		}
	});
	
	var BgSettings = Upfront.Views.Editor.Settings.Settings.extend({
		initialize: function (options) {
			this.options = options;
			this.has_tabs = false;
			
			var me = this,
				types = {
					color: ColorItem, 
					image: ImageItem,
					featured: ImageItem,
					slider: SliderItem, 
					video: VideoItem, 
					map: MapItem
				};
			if ( !_.isUndefined(options.enable_types) )
				this.enable_types = options.enable_types;
			
			this.settings = {};
			
			_.each(types, function(view, type){
				if ( !_.contains(me.enable_types, type) )
					return;
				me.settings[type] = new view({
					model: me.model
				});
				me.settings[type].once('rendered', function(){
					this.trigger('hide');
				});
			});
			
			var bg_item_options = {
					model: this.model,
					enable_types: this.enable_types
				};
			if ( this.bg_title )
				bg_item_options.title = this.bg_title;
			else
				bg_item_options.group = false;
			var	bg_item = new BgItem(bg_item_options);
			
			this.panels = _([
	  	 		new Upfront.Views.Editor.Settings.Panel({
					model: this.model,
					settings: _.union(
						[ bg_item ],
						_.map(this.settings, function(setting){ return setting; })
					)
				})
	 		]);
	 		
	 		this.once('open', function(){
	 			var bg_type = me.model.get_breakpoint_property_value('background_type', true),
	 				bg_image = me.model.get_breakpoint_property_value('background_image', true);
	 			if ( bg_type )
	 				me.toggle_setting(bg_type);
	 			else
	 				me.toggle_setting( bg_image ? 'image' : 'color' );
	 		});
		},
		
		toggle_setting: function (active) {
			_.each(this.settings, function(setting, type){
				if ( type == active )
					setting.trigger('show');
				else
					setting.trigger('hide');
			});
		}
		
	});

	Upfront.Views.Editor.BgSettings = {
		Settings: BgSettings,
		BgItem: BgItem,
		ColorItem: ColorItem,
		ImageItem: ImageItem,
		MapItem: MapItem,
		SliderItem: SliderItem,
		VideoItem: VideoItem
	};
});
})(jQuery);

define('elements/upfront-accordion/js/model',[],function() {
	var UaccordionModel = Upfront.Models.ObjectModel.extend({
		init: function () {
			var properties = _.clone(Upfront.data.uaccordion.defaults);

			var defaults = Upfront.data.uaccordion.defaults;

			// Copy the default panel data by value, so that the source does not get updated if passed by reference
			properties.accordion = [];
			properties.accordion[0] = {};
			properties.accordion[0].content = _.clone(defaults.accordion[0].content);
			properties.accordion[0].title = _.clone(defaults.accordion[0].title);

			properties.accordion[1] = {};
			properties.accordion[1].content = _.clone(defaults.accordion[1].content);
			properties.accordion[1].title = _.clone(defaults.accordion[1].title);

			properties.element_id = Upfront.Util.get_unique_id('uaccordion-object');
			this.init_properties(properties);
		}
	});

	return UaccordionModel;
});

define('elements/upfront-accordion/js/element',[
	'elements/upfront-accordion/js/model'
], function(UaccordionModel) {
	var l10n = Upfront.Settings.l10n.accordion_element;

	var AccordionElement = Upfront.Views.Editor.Sidebar.Element.extend({
		priority: 140,
		render: function () {
			this.$el.addClass('upfront-icon-element upfront-icon-element-accordion');
			this.$el.html(l10n.element_name);
		},
		add_element: function () {
			var object = new UaccordionModel(),
			module = new Upfront.Models.Module({
				'name': '',
				'properties': [
					{'name': 'element_id', 'value': Upfront.Util.get_unique_id('module')},
					{'name': 'class', 'value': 'c9 upfront-accordion_module'},
					{'name': 'has_settings', 'value': 0},
					{'name': 'row', 'value': Upfront.Util.height_to_row(225)}
				],
				'objects': [
					object
				]
			})
			;
			this.add_module(module);
		}
	});

	return AccordionElement;
});

define('scripts/upfront/element-settings/settings-container',[], function () {
	var SettingsContainer = Backbone.View.extend({
		save_settings: function () {
			if (!this.settings) return;

			var me = this;
			this.settings.each(function (setting) {
				if ( !setting.handlesSaving && (setting.fields || setting.settings).size() > 0 ) {
					setting.save_fields();
				} else  if (!setting.handlesSaving) {
					var value = me.model.get_property_value_by_name(setting.get_name());
					if ( value != setting.get_value() ) {
						me.model.set_property(
							setting.get_name(),
							setting.get_value()
						);
					}
				}
			});
			// some backward compatibility
			if (this.on_save) this.on_save();
			if (this.onSaveSettings) this.onSaveSettings();
		},

		cleanUp: function() {
			if(this.settings) {
				this.settings.each(function(setting){
					setting.remove();
				});
			}

			this.$el.off();
			this.remove();
		}

	});

	return SettingsContainer;
});

(function ($) {
define('scripts/upfront/element-settings/root-panel-mixin',[
], function () {
	var RootPanelMixin = {
		className: 'uf-settings-panel upfront-settings_panel',

		events: {
			'click .uf-settings-panel__title': 'toggleBody'
		},

		getTitle: function () {
			var title = this.options.title ? this.options.title : this.title;
			title = title ? title : 'Default Panel Title';
			return title;
		},

		/**
		 * Child classes need to override this method to return div with markup.
		 */
		getBody: function() {
			var $body = $('<div />');
			$body.append('<p>Implement getBody() in child class</p>');
			return $body;
		},

		toggleBody: function () {
			this.$el.find('.uf-settings-panel__body').toggle();
			this.$el.toggleClass('uf-settings-panel--expanded');
		},

		/**
		 * Hides panel body
		 */
		hideBody: function () {
			this.$el.find('.uf-settings-panel__body').hide();
			this.$el.removeClass('uf-settings-panel--expanded');
		},

		/**
		 * Shows panel body
		 */
		showBody: function () {
			this.$el.find('.uf-settings-panel__body').show();
			this.$el.addClass('uf-settings-panel--expanded');
		},

		render: function () {
			var body;

			this.$el.html('<div class="uf-settings-panel__title">' + this.getTitle() + '</div>');

			body = this.getBody();
			body.addClass('uf-settings-panel__body');
			this.$el.append(body);
			this.$el.addClass('uf-settings-panel--expanded');
		}
	};

	return RootPanelMixin;
});
})(jQuery);


define('text!elements/upfront-slider/tpl/backend.html',[],function () { return '<div>\r\n<script type="text/template" id="slides-setting-tpl">\r\n<div class="uslider-slides-setting">\r\n{[ slides.each(function(slide){ ]}\r\n<div class="uslider_content_imgslide uslider_content_slide" rel="{{slide.id}}">\r\n\t\t<img src="{{slide.get(\'src\')}}" />\r\n\t\t<span class="remove-slide"></span>\r\n\t</div>\r\n{[ }) ]}\r\n<div class="uslider-add upfront-region-bg-slider-add-image upfront-icon upfront-icon-region-add-slide">{{l10n.add_slide}}</div>\r\n</div>\r\n</script>\r\n\r\n\r\n<script type="text/template" id="startingTpl">\r\n\t<div class="upfront-image-starting-select upfront-ui upfront-initial-overlay-wrapper" style="min-height:{{startingHeight}}px">\r\n\t\t<div class="uslider-starting-centered upfront-initial-overlay-wrapper" style="height: 100px">\r\n\t\t\t<div class="uslider-starting-title">{{l10n.choose_type}}</div>\r\n\t\t\t<div class="uslider-starting-info">{{l10n.can_change}}</div>\r\n\t\t\t<a href="#" class="button upfront-image-select">{{l10n.choose_img}}</a>\r\n\t\t</div>\r\n\t</div>\r\n</script>\r\n\r\n\r\n</div>\r\n';});

(function ($) {
define('scripts/upfront/settings/fields/slides',[
	'text!elements/upfront-slider/tpl/backend.html',
], function(editorTpl) {
	var l10n = Upfront.Settings.l10n.slider_element;

	var SlidesField = Upfront.Views.Editor.Field.Field.extend({
		template: _.template($(editorTpl).find('#slides-setting-tpl').html()),
		events: {
			'click .uslider-add' : 'addSlides',
			'click .remove-slide' : 'onRemoveSlide'
		},
		initialize: function(){
			this.listenTo(this.model.slideCollection, 'add remove sort reset', this.render);
		},

		onRemoveSlide: function(event) {
			this.model.view.removeSlide($(event.currentTarget).parent());
		},

		render: function() {
			var me = this;
			this.$el.html(this.template({slides: this.model.slideCollection, l10n: l10n}));

			//Make the thumbs sortable
			this.$('.uslider-slides-setting').sortable({
				items: '.uslider_content_imgslide',
				start: function(event, ui) {
					ui.item.addClass('uslider-is-dragged');
				},
				stop: function(event, ui) {
					// When the drag stops we record the list of IDs into our array for use later.
					var slideId = ui.item.attr('rel'),
						newPosition = me.getSlidePosition(slideId),
						slide = false;

					if(newPosition != -1) {
						slide = me.model.slideCollection.get(slideId);
						me.model.slideCollection.remove(slideId, {silent:true});
						me.model.slideCollection.add(slide, {at: newPosition});
					}
				}
			});

			setTimeout(function(){
				var settings = $('#settings');
				settings.height(settings.find('.upfront-settings_panel:visible').outerHeight());
			},100)

		},

		addSlides: function(){
			this.model.trigger('addRequest');
		},

		getSlidePosition: function(slideId){
			var i = 0,
				found = false;
			this.$('div.uslider_content_slide').each(function(item){
				if($(this).attr('rel') == slideId)
					found = i;
				i++;
			});
			if(found !== false)
				return found;
			return -1;
		},
		get_name: function() {
			return 'slides';
		},
		get_value: function() {
			return this.model.slideCollection.toJSON();
		}
	});

	return SlidesField;
});
})(jQuery);

define('scripts/upfront/settings/field-factory',[
	'scripts/upfront/settings/fields/slides'
], function(SlidesField) {
	var FieldFactory = function() {
		var fieldClasses = {
			'SlidesField': SlidesField
		};

		this.createField = function(type, options) {
			var fieldClass = Upfront.Views.Editor.Field[type];

			if (_.isUndefined(fieldClass)) {
				fieldClass = fieldClasses[type];
			}

			if (type === 'Settings_CSS') fieldClass = Upfront.Views.Editor.Settings.Settings_CSS;
			if (_.isUndefined(fieldClass)) throw 'There is no \'' + type + '\' field class defined.';

			if (_.isFunction(options.values)) {
				options.values = options.values();
			}

			return new fieldClass(options);
		};
	};

	fieldFactory = new FieldFactory();

	return fieldFactory;
});

(function($) {
define('scripts/upfront/settings/modules/base-module',[
], function() {
	var BaseModule = Backbone.View.extend({
		initialize: function (opts) {
			var me = this;
			me.options = opts;
			this.fields = opts.fields ? _(opts.fields) : _([]);
			this.on('panel:set', function(){
				me.fields.each(function(field){
					field.panel = me.panel;
					field.trigger('panel:set');
				});
			});
		},

		render: function () {
			this.$el.html('');
			if (this.options.title && this.options.toggle !== true) {
				this.$el.append('<div class="upfront-settings-item-title">' + this.options.title + '</div>');
			}
			this.$el.append('<div class="upfront-settings-item-content"></div>');

			var $content = this.$el.find('.upfront-settings-item-content');
			this.fields.each(function(field){
				field.render();
				field.delegateEvents();
				$content.append(field.el);
			});

			this.trigger('rendered');
		},

		save_fields: function () {
			var changed = _([]);
			this.fields.each(function(field, index, list){
				if(field.property){
					var value = field.get_value();
					var saved_value = field.get_saved_value();
					if ( ! field.multiple && value != saved_value ){
						changed.push(field);
					}
					else if ( field.multiple && (value.length != saved_value.length || _.difference(value, saved_value).length !== 0) ) {
						changed.push(field);
					}
				}
			});
			changed.each(function(field, index, list){
				if ( field.use_breakpoint_property )
					field.model.set_breakpoint_property(field.property_name, field.get_value(), true);
				else
					field.property.set({'value': field.get_value()}, {'silent': true});
			});
			if ( changed.size() > 0 )
				this.panel.is_changed = true;
		},

		remove: function(){
			if(this.fields)
				this.fields.each(function(field){
					field.remove();
				});
			Backbone.View.prototype.remove.call(this);
		}
	});

	return BaseModule
});
})(jQuery);

/*
* Field names properies
* `use` - Overwrite theme settings
* `element` - Font element
* `typeface` - Font family
* `weight` - Font weight / style
* `size` - Font size
* `line_height` - Font line height
* `color` - Font color
*/
define('scripts/upfront/settings/modules/typography',[
	'scripts/upfront/settings/modules/base-module'
], function(BaseModule) {
	var l10n = Upfront.Settings.l10n.preset_manager;
	var TypographySettingsItem = BaseModule.extend({
		className: 'settings_module typography_settings_item',
		group: true,

		get_title: function() {
			return this.options.title;
		},

		initialize: function(options) {
			this.options = options || {};
			this.fieldCounter = 0;
			this.currentElement = '';
			var me = this,
				state = this.options.state,
				toggleClass = 'no-toggle';

			//Increase field counter if inner elements
			if(typeof me.options.elements !== "undefined") {
				this.fieldCounter++;
			}

			//Set default element
			if(typeof this.options.default_element !== "undefined") {
				this.currentElement = this.options.default_element + '-';
			}

			//Set saved element to default element
			if(typeof this.model.get(state + '-element-type') !== "undefined" && typeof this.options.elements !== "undefined") {
				this.currentElement = this.model.get(state + '-element-type') + '-';
			}

			if(this.options.toggle === true) {
				this.fieldCounter++;
				toggleClass = 'element-toggled';
			}

			this.fields = _([
				new Upfront.Views.Editor.Field.Typeface_Chosen_Select({
					name: this.currentElement + this.options.fields.typeface,
					model: this.model,
					values: Upfront.Views.Editor.Fonts.theme_fonts_collection.get_fonts_for_select(),
					default_value: this.model.get(this.currentElement + this.options.fields.typeface),
					label: l10n.typeface,
					select_width: '225px',
					label_style: 'inline',
					className: state + '-font-face static typeFace ' + toggleClass,
					change: function(value) {
						me.model.set(me.currentElement + me.options.fields.typeface, value);
						me.fields._wrapped[1 + me.fieldCounter].stopListening();
						me.fields._wrapped[1 + me.fieldCounter] = new Upfront.Views.Editor.Field.Typeface_Style_Chosen_Select({
							model: this.model,
							name: me.currentElement + me.options.fields.fontstyle,
							values: Upfront.Views.Editor.Fonts.theme_fonts_collection.get_variants_for_select(me.model.get(me.currentElement + me.options.fields.typeface)),
							label: l10n.weight_style,
							font_family: me.model.get(me.options.fields.typeface),
							select_width: '225px',
							label_style: 'inline',
							className: state + '-font-style static weightStyle ' + toggleClass,
							change: function(value) {
								//Explode Font style and font weight and save them as separate values
								var parsed_variant = Upfront.Views.Font_Model.parse_variant(value);
								var data = {};
								data[me.currentElement + me.options.fields.fontstyle] = value;
								data[me.currentElement + me.options.fields.weight] = parsed_variant.weight;
								data[me.currentElement + me.options.fields.style] = parsed_variant.style;
								me.model.set(data);
							},
							show: function(value) {
								if(value !== null) {
									me.fields._wrapped[1 + me.fieldCounter].set_option_font(value);
								}
							}
						});
						me.$el.empty();
						me.render();
					}
				}),

				new Upfront.Views.Editor.Field.Typeface_Style_Chosen_Select({
					model: this.model,
					name: this.currentElement + this.options.fields.fontstyle,
					values: Upfront.Views.Editor.Fonts.theme_fonts_collection.get_variants_for_select(me.model.get(this.currentElement + me.options.fields.typeface)),
					default_value: this.model.get(this.currentElement + this.options.fields.fontstyle),
					label: l10n.weight_style,
					font_family: me.model.get(this.options.fields.typeface),
					select_width: '225px',
					label_style: 'inline',
					className: state + '-font-style static weightStyle ' + toggleClass,
					change: function(value) {
						//Explode Font style and font weight and save them as separate values
						var parsed_variant = Upfront.Views.Font_Model.parse_variant(value);
						me.model.set(me.currentElement + me.options.fields.fontstyle, value);
						me.model.set(me.currentElement + me.options.fields.weight, parsed_variant.weight);
						me.model.set(me.currentElement + me.options.fields.style, parsed_variant.style);
					},
					show: function(value) {
						if(value !== null) {
							me.fields._wrapped[1 + me.fieldCounter].set_option_font(value);

						}
					}
				}),

				new Upfront.Views.Editor.Field.Number({
					model: this.model,
					className: state + '-font-size fontSize ' + toggleClass,
					name: this.currentElement + this.options.fields.size,
					default_value: this.model.get(this.currentElement + this.options.fields.size),
					label: l10n.size,
					label_style: 'inline',
					suffix: l10n.px,
					change: function(value) {
						me.model.set(me.currentElement + me.options.fields.size, value);
					}
				}),

				new Upfront.Views.Editor.Field.Number({
					model: this.model,
					className: state + '-font-lineheight lineHeight ' + toggleClass,
					name: this.currentElement + this.options.fields.line_height,
					label: l10n.line_height,
					label_style: 'inline',
					default_value: this.model.get(this.currentElement + this.options.fields.line_height),
					min: 0,
					step: 0.1,
					change: function(value) {
						me.model.set(me.currentElement + me.options.fields.line_height, value);
					}
				}),

				new Upfront.Views.Editor.Field.Color({
					model: this.model,
					className: state + '-font-color upfront-field-wrap upfront-field-wrap-color sp-cf fontColor ' + toggleClass,
					name: this.currentElement + this.options.fields.color,
					default_value: this.model.get(this.currentElement + this.options.fields.color),
					blank_alpha : 0,
					label_style: 'inline',
					label: l10n.color,
					spectrum: {
						preferredFormat: 'rgb',
						change: function(value) {
							if (!value) return false;
							var c = value.get_is_theme_color() !== false ? value.theme_color : value.toRgbString();
							me.model.set(me.currentElement + me.options.fields.color, c);
						},
						move: function(value) {
							if (!value) return false;
							var c = value.get_is_theme_color() !== false ? value.theme_color : value.toRgbString();
							me.model.set(me.currentElement + me.options.fields.color, c);
						}
					}
				}),

			]);


			//Add fields select box
			if(typeof me.options.elements !== "undefined") {
				this.fields.unshift(
					new Upfront.Views.Editor.Field.Select({
						model: this.model,
						label: l10n.type_element,
						label_style: 'inline',
						name: state + '-element-type',
						className: state + '-select-element selectElement ' + toggleClass,
						values: me.options.elements,
						change: function (value) {
							//Update element type value to keep it on typography re-render
							me.model.set(state + '-element-type', value);
							me.$el.empty();
							me.render();
						},
						show: function(value) {
							me.currentElement = value + '-';
							var settings = me.get_field_values(value);
							me.update_fields(settings);
						}
					})
				);
			}

			//Add toggle typography checkbox
			if(this.options.toggle === true) {
				this.group = false;
				this.fields.unshift(
					new Upfront.Views.Editor.Field.Checkboxes({
						model: this.model,
						className: 'useTypography checkbox-title ' + toggleClass,
						name: me.options.fields.use,
						label: '',
						multiple: false,
						values: [
							{
								label: l10n.typography,
								value: 'yes',
								checked: this.model.get(me.options.fields.use)
							}
						],
						change: function(value) {
							console.log('triggered change on checkbox');
							me.model.set(me.options.fields.use, value);
							me.reset_fields(value);
						},
						show: function(value, $el) {
							var stateSettings = $el.closest('.state_modules');
							//Toggle typography fields
							if(value == "yes") {
								stateSettings.find('.'+ state +'-select-element').show();
								stateSettings.find('.'+ state +'-font-face').show();
								stateSettings.find('.'+ state +'-font-style').show();
								stateSettings.find('.'+ state +'-font-size').show();
								stateSettings.find('.'+ state +'-font-lineheight').show();
								stateSettings.find('.'+ state +'-font-color').show();
							} else {
								stateSettings.find('.'+ state +'-select-element').hide();
								stateSettings.find('.'+ state +'-font-face').hide();
								stateSettings.find('.'+ state +'-font-style').hide();
								stateSettings.find('.'+ state +'-font-size').hide();
								stateSettings.find('.'+ state +'-font-lineheight').hide();
								stateSettings.find('.'+ state +'-font-color').hide();
							}
						}
					})
				);
			}
		},

		reset_fields: function(value) {
			var settings,
				me = this;
			if(typeof value !== "undefined" && value === "yes") {
				if(typeof this.options.elements !== "undefined") {
					_.each(this.options.elements, function(element) {
						var currentElementValue = element.value + '-';
						settings = me.get_static_field_values(me.options.prepend, currentElementValue);
						me.update_fields(settings);
						me.save_static_values(settings, currentElementValue);
					});
				} else {
					settings = this.get_static_field_values(this.options.prepend, '');
					me.update_fields(settings);
					this.save_static_values(settings, '');
				}
				this.$el.empty();
				this.render();
			}
		},

		save_static_values: function(settings, element) {
			//Save preset values from static state
			var parsed_variant = Upfront.Views.Font_Model.parse_variant(settings.fontstyle);
			this.model.set(element + this.options.fields.typeface, settings.typeface);
			this.model.set(element + this.options.fields.fontstyle, settings.fontstyle);
			this.model.set(element + this.options.fields.weight, parsed_variant.weight);
			this.model.set(element + this.options.fields.style, parsed_variant.style);
			this.model.set(element + this.options.fields.size, settings.fontsize);
			this.model.set(element + this.options.fields.line_height, settings.line_height);
			this.model.set(element + this.options.fields.color, settings.color);
		},

		get_static_field_values: function(prepend, element) {
			var settings = {},
				prefix = '';

			if(typeof this.options.prefix !== "undefined") {
				prefix = this.options.prefix + '-';
			}

			settings.typeface = this.model.get(this.clear_prepend(element + prefix + this.options.fields.typeface, prepend)) || '';
			settings.fontstyle = this.model.get(this.clear_prepend(element + prefix + this.options.fields.fontstyle, prepend)) || '';
			settings.fontsize = this.model.get(this.clear_prepend(element + prefix + this.options.fields.size, prepend)) || '';
			settings.line_height = this.model.get(this.clear_prepend(element + prefix + this.options.fields.line_height, prepend)) || '';
			settings.color = this.model.get(this.clear_prepend(element + prefix + this.options.fields.color, prepend)) || '';

			return settings;
		},

		clear_prepend: function(field, prepend) {
			return field.replace(prepend, '');
		},

		get_field_values: function(value) {
			var settings = {};
			//Get stored values else load from Global Typography settings
			if(typeof this.options.global_typography !== "undefined" && this.options.global_typography === true) {
				var font_settings = Upfront.mainData.global_typography[this.normalize_elements_selector(value)];
				font_settings = font_settings || {};
				settings.typeface = this.model.get(this.currentElement + this.options.fields.typeface) || font_settings.font_face || '';
				settings.fontstyle = this.model.get(this.currentElement + this.options.fields.fontstyle) || font_settings.weight + ' ' + font_settings.style || '';
				settings.fontsize = this.model.get(this.currentElement + this.options.fields.size) || font_settings.size || '';
				settings.line_height = this.model.get(this.currentElement + this.options.fields.line_height) || font_settings.line_height || '';
				settings.color = this.model.get(this.currentElement + this.options.fields.color) || font_settings.color || '';
			} else {
				settings.typeface = this.model.get(this.currentElement + this.options.fields.typeface) || '';
				settings.fontstyle = this.model.get(this.currentElement + this.options.fields.fontstyle) || '';
				settings.fontsize = this.model.get(this.currentElement + this.options.fields.size) || '';
				settings.line_height = this.model.get(this.currentElement + this.options.fields.line_height) || '';
				settings.color = this.model.get(this.currentElement + this.options.fields.color) || '';
			}

			return settings;
		},

		update_fields: function(settings) {
			//Update selected element

			//Update typography fields for selected element
			this.fields._wrapped[this.fieldCounter].set_value(settings.typeface);
			this.fields._wrapped[this.fieldCounter].set_option_font(settings.typeface);
			this.fields._wrapped[this.fieldCounter + 1].options.values = Upfront.Views.Editor.Fonts.theme_fonts_collection.get_variants_for_select(settings.typeface);
			this.fields._wrapped[this.fieldCounter + 1].set_value(settings.fontstyle);
			this.fields._wrapped[this.fieldCounter + 1].set_option_font(settings.fontstyle);
			this.fields._wrapped[this.fieldCounter + 2].set_value(settings.fontsize);
			this.fields._wrapped[this.fieldCounter + 3].set_value(settings.line_height);
			this.fields._wrapped[this.fieldCounter + 4].set_value(settings.color);
			this.fields._wrapped[this.fieldCounter + 4].update_input_border_color(settings.color);
		},

		normalize_elements_selector: function(value) {
			if(value === 'a-hover') {
				return 'a:hover';
			}
			if(value === "blockquote-alternative") {
				return 'blockquote.upfront-quote-alternative';
			}
			return value;
		}
	});

	return TypographySettingsItem;
});

/*
* Field names properties
* `use` - Toggle border settings
* `width` - Border width
* `type` - Border type
* `color` - Border color
*/
define('scripts/upfront/settings/modules/border',[
	'scripts/upfront/settings/modules/base-module'
], function(BaseModule) {
	var l10n = Upfront.Settings.l10n.preset_manager;
	var BorderSettingsModule = BaseModule.extend({
		className: 'settings_module border_settings_item clearfix',
		group: false,

		initialize: function(options) {
			this.options = options || {};
			this.fieldCounter = 0;
			this.currentElement = '';
			var me = this,
				state = this.options.state,
				custom_class = '';

			//If fields added increase field counter
			if(typeof this.options.elements !== "undefined") {
				this.fieldCounter++;
			}

			//Set default element
			if(typeof this.options.default_element !== "undefined") {
				this.currentElement = this.options.default_element + '-';
				custom_class = 'border-with-fields';
			}

			this.fields = _([
				new Upfront.Views.Editor.Field.Checkboxes({
					model: this.model,
					className: 'useBorder checkbox-title',
					name: me.options.fields.use,
					label: '',
					default_value: 1,
					multiple: false,
					values: [
						{ label: me.options.label || l10n.border, value: 'yes' }
					],
					change: function(value) {
						me.model.set(me.options.fields.use, value);
						me.reset_fields(value);
					},
					show: function(value, $el) {
						var stateSettings = $el.closest('.state_modules');

						//Toggle border settings when depending on checkbox value
						if(value == "yes") {
							stateSettings.find('.' + state + '-border-width').show();
							stateSettings.find('.' + state + '-border-type').show();
							stateSettings.find('.' + state + '-border-color').show();
							stateSettings.find('.' + state + '-border-select-element').css("opacity", "1");
						} else {
							stateSettings.find('.' + state + '-border-width').hide();
							stateSettings.find('.' + state + '-border-type').hide();
							stateSettings.find('.' + state + '-border-color').hide();
							stateSettings.find('.' + state + '-border-select-element').css("opacity", "0.5");
						}
					}
				}),
				new Upfront.Views.Editor.Field.Number({
					model: this.model,
					className: state + '-border-width borderWidth ' + custom_class,
					name: this.currentElement + me.options.fields.width,
					label: '',
					default_value: 1,
					suffix: l10n.px,
					values: [
						{ label: "", value: '1' }
					],
					change: function(value) {
						me.model.set(me.currentElement + me.options.fields.width, value);
						if (typeof me.options.elements !== "undefined") {
							_.each(me.options.elements, function(element) {
								me.model.set(element.value + '-' + me.options.fields.width, value);
							});
						}
						this.trigger('change');
					}
				}),
				new Upfront.Views.Editor.Field.Select({
					model: this.model,
					className: state + '-border-type borderType ' + custom_class,
					name: this.currentElement + me.options.fields.type,
					default_value: "solid",
					values: [
						{ label: l10n.solid, value: 'solid' },
						{ label: l10n.dashed, value: 'dashed' },
						{ label: l10n.dotted, value: 'dotted' }
					],
					change: function(value) {
						me.model.set(me.currentElement + me.options.fields.type, value);
						if (typeof me.options.elements !== "undefined") {
							_.each(me.options.elements, function(element) {
								me.model.set(element.value + '-' + me.options.fields.type, value);
							});
						}
					}
				}),

				new Upfront.Views.Editor.Field.Color({
					model: this.model,
					className: state + '-border-color upfront-field-wrap upfront-field-wrap-color sp-cf borderColor ' + custom_class,
					name: this.currentElement + me.options.fields.color,
					blank_alpha : 0,
					label_style: 'inline',
					label: l10n.color,
					default_value: '#000',
					spectrum: {
						preferredFormat: 'rgb',
						change: function(value) {
							if (!value) return false;
							var c = value.get_is_theme_color() !== false ? value.theme_color : value.toRgbString();
							me.model.set(me.currentElement + me.options.fields.color, c);
							if (typeof me.options.elements !== "undefined") {
								_.each(me.options.elements, function(element) {
									me.model.set(element.value + '-' + me.options.fields.color, c);
								});
							}
						},
						move: function(value) {
							if (!value) return false;
							var c = value.get_is_theme_color() !== false ? value.theme_color : value.toRgbString();
							me.model.set(me.currentElement + me.options.fields.color, c);
							if (typeof me.options.elements !== "undefined") {
								_.each(me.options.elements, function(element) {
									me.model.set(element.value + '-' + me.options.fields.color, c);
								});
							}
						}
					}
				})
			]);

			//Add fields select box
			if (typeof me.options.elements !== "undefined") {
				this.fields.unshift(
					new Upfront.Views.Editor.Field.Select({
						className: state + '-border-select-element border_selectElement',
						name: 'tagsToApply',
						default_value: me.model.get('tagsToApply') || 'field-button',
						values: me.options.elements,
						change: function () {
							var value = this.get_value();
							me.model.set({'tagsToApply': value});
							me.currentElement = value + '-';
						}
					})
				);
			}
		},

		reset_fields: function(value) {
			var settings,
				me = this;
			if(typeof value !== "undefined" && value === "yes") {
				if(typeof this.options.elements !== "undefined") {
					_.each(this.options.elements, function(element) {
						var currentElementValue = element.value + '-';
						settings = me.get_static_field_values(me.options.prepend, currentElementValue);
						me.update_fields(settings);
						me.save_static_values(settings, currentElementValue);
					});
				} else {
					settings = this.get_static_field_values(this.options.prepend, '');
					this.update_fields(settings);
					this.save_static_values(settings, '');
				}
				this.$el.empty();
				this.render();
			}
		},

		save_static_values: function(settings, element) {
			//Save preset values from static state
			this.model.set(element + this.options.fields.width, settings.width);
			this.model.set(element + this.options.fields.type, settings.type);
			this.model.set(element + this.options.fields.color, settings.color);
		},

		get_static_field_values: function(prepend, element) {
			var settings = {},
				prefix = '';

			if(typeof this.options.prefix !== "undefined") {
				prefix = this.options.prefix + '-';
			}

			settings.width = this.model.get(this.clear_prepend(element + prefix + this.options.fields.width, prepend)) || '';
			settings.type = this.model.get(this.clear_prepend(element + prefix + this.options.fields.type, prepend)) || '';
			settings.color = this.model.get(this.clear_prepend(element + prefix + this.options.fields.color, prepend)) || '';

			return settings;
		},

		clear_prepend: function(field, prepend) {
			return field.replace(prepend, '');
		},

		update_fields: function(settings) {
			//Update selected element
			this.fields._wrapped[this.fieldCounter + 1].set_value(settings.width);
			this.fields._wrapped[this.fieldCounter + 2].set_value(settings.type);
			this.fields._wrapped[this.fieldCounter + 3].set_value(settings.color);
			this.fields._wrapped[this.fieldCounter + 3].update_input_border_color(settings.color);
		},
	});

	return BorderSettingsModule;
});

/*
* Field names properies
* `duration` - Animation duration
* `easing` - Animation effect
*/
define('scripts/upfront/settings/modules/hov-animation',[
	'scripts/upfront/settings/modules/base-module'
], function(BaseModule) {
	var l10n = Upfront.Settings.l10n.preset_manager;
	var HovAnimationSettingsModule = BaseModule.extend({
		className: 'settings_module hov_animation_settings_item clearfix',
		group: false,

		initialize: function(options) {
			this.options = options || {};
			var me = this,
				state = this.options.state,
				toggleClass = 'no-toggle';

			if(me.options.toggle === true) {
				toggleClass = 'element-toggled';
			}

			this.fields = _([
				new Upfront.Views.Editor.Field.Number({
					model: this.model,
					className: state + '-duration duration ' + toggleClass,
					name: me.options.fields.duration,
					min: 0,
					label: l10n.animate_hover_changes,
					step: 0.1,
					values: [
						{ label: '', value: '12' }
					],
					change: function(value) {
						me.model.set(me.options.fields.duration, value);
					}
				}),
				new Upfront.Views.Editor.Field.Select({
					model: this.model,
					name: me.options.fields.easing,
					label: l10n.sec,
					step: 0.1,
					label_style: 'inline',
					values: [
						{ label: 'ease', value: 'ease' },
						{ label: 'linear', value: 'linear' },
						{ label: 'ease-in', value: 'ease-in' },
						{ label: 'ease-out', value: 'ease-out' },
						{ label: 'ease-in-out', value: 'ease-in-out' }
					],
					className: state + '-transition transition ' + toggleClass,
					change: function(value) {
						me.model.set(me.options.fields.easing, value);
					}
				}),
			]);

			//Add toggle typography checkbox
			if(this.options.toggle === true) {
				this.group = false;
				this.fields.unshift(
					new Upfront.Views.Editor.Field.Checkboxes({
						model: this.model,
						className: 'useAnimation checkbox-title',
						name: me.options.fields.use,
						label: '',
						default_value: 1,
						multiple: false,
						values: [
							{ label: l10n.animate_hover_changes, value: 'yes' }
						],
						change: function(value) {
							me.model.set(me.options.fields.use, value);
						},
						show: function(value, $el) {
							var stateSettings = $el.closest('.state_modules');
							//Toggle color fields
							if(value == "yes") {
								stateSettings.find('.'+ state +'-transition').show();
								stateSettings.find('.'+ state +'-duration').show();
							} else {
								stateSettings.find('.'+ state +'-transition').hide();
								stateSettings.find('.'+ state +'-duration').hide();
							}
						}
					})
				);
			}
		},
	});

	return HovAnimationSettingsModule;
});

/*
* Field names properies
* `use` - Toggle radius settings
* `lock` - Lock radius
* `radius` - Radius slider
* `radius_number` - Radius number field
* `radius1` - Top left corner
* `radius2` - Top right corner
* `radius3` - Bottom left corner
* `radius4` - Bottom right corner
*/
define('scripts/upfront/settings/modules/radius',[
	'scripts/upfront/settings/modules/base-module'
], function(BaseModule) {
	var l10n = Upfront.Settings.l10n.preset_manager;
	var RadiusSettingsModule = BaseModule.extend({
		className: 'settings_module corner_radius_settings_item clearfix',
		group: false,

		get_title: function() {
			return this.options.title;
		},

		initialize: function(options) {
			this.options = options || {};
			var me = this,
				state = this.options.state;

			var sliderOnChange = function () {
				//Update border radius
				var value = this.get_value();
				var data = {};
				data[me.options.fields.radius1] = value;
				data[me.options.fields.radius2] = value;
				data[me.options.fields.radius3] = value;
				data[me.options.fields.radius4] = value;
				data[me.options.fields.radius] = value;
				me.model.set(data, {silent: true});
				me.model.set(me.options.fields.radius_number, value);
				me.$el.find("input[name="+ me.options.fields.radius1 +"]").val(value);
				me.$el.find("input[name="+ me.options.fields.radius2 +"]").val(value);
				me.$el.find("input[name="+ me.options.fields.radius3 +"]").val(value);
				me.$el.find("input[name="+ me.options.fields.radius4 +"]").val(value);
				me.$el.find("input[name="+ me.options.fields.radius_number +"]").val(value);

				//Set opacity to 1
				me.$el.closest('.state_modules').find('.'+ state +'-radius-slider').css('opacity', 1);
			};
			var throttledSliderOnChange = _.throttle(sliderOnChange, 16);

			var radiusOnChange = function(value) {
/*
// --- Don't do any of this - it's duplicated code and will fail to update properly as a result ---
				me.model.set(me.options.fields.radius_number, value);
				//Update border radius
				var data = {};
				data[me.options.fields.radius1] = value;
				data[me.options.fields.radius2] = value;
				data[me.options.fields.radius3] = value;
				data[me.options.fields.radius4] = value;
				data[me.options.fields.radius] = value;
				me.model.set(data, {silent: true});

				me.$el.find("input[name="+ me.options.fields.radius1 +"]").val(value);
				me.$el.find("input[name="+ me.options.fields.radius2 +"]").val(value);
				me.$el.find("input[name="+ me.options.fields.radius3 +"]").val(value);
				me.$el.find("input[name="+ me.options.fields.radius4 +"]").val(value);
				me.$el.find("input[name="+ me.options.fields.radius +"]").val(value);
*/
// --- Instead, just update slider value and deal with changes there ---
				//Update slider value
				s = me.fields._wrapped[2];
				s.$el.find('#'+s.get_field_id()).slider('value', value);
				s.get_field().val(value);
				
				// Now, once we updated the slider value, let that handler take care of it
				sliderOnChange.apply(s);
				
				//Lower opacity if value is bigger than the slider MAX_VALUE
				if(value > me.options.max_value) {
					me.$el.closest('.state_modules').find('.'+ state +'-radius-slider').css('opacity', 0.6);
				} else {
					me.$el.closest('.state_modules').find('.'+ state +'-radius-slider').css('opacity', 1);
				}
			};
			var throttledRadiusOnChange = _.throttle(radiusOnChange, 16);

			this.fields = _([
				new Upfront.Views.Editor.Field.Checkboxes({
					model: this.model,
					className: 'useRadius checkbox-title',
					name: me.options.fields.use,
					label: '',
					default_value: 1,
					multiple: false,
					values: [
						{ label: l10n.rounded_corners, value: 'yes' }
					],
					change: function(value) {
						me.model.set(me.options.fields.use, value);
						me.reset_fields(value);
					},
					show: function(value, $el) {
						var stateSettings = $el.closest('.state_modules');
						var lock = me.model.get(me.options.fields.lock);
						//Toggle border radius fields
						if(value == "yes") {
							if(lock == "yes") {
								stateSettings.find('.'+ state +'-radius-slider').show();
								stateSettings.find('.'+ state +'-radius-slider-number').show();
							} else {
								stateSettings.find('.'+ state +'-radius-slider').hide();
								stateSettings.find('.'+ state +'-radius-slider-number').hide();
								stateSettings.find('.'+ state +'-radius1').show();
								stateSettings.find('.'+ state +'-radius2').show();
								stateSettings.find('.'+ state +'-radius3').show();
								stateSettings.find('.'+ state +'-radius4').show();
							}
						} else {
							stateSettings.find('.'+ state +'-radius1').hide();
							stateSettings.find('.'+ state +'-radius2').hide();
							stateSettings.find('.'+ state +'-radius3').hide();
							stateSettings.find('.'+ state +'-radius4').hide();
							stateSettings.find('.'+ state +'-radius-slider').hide();
							stateSettings.find('.'+ state +'-radius-slider-number').hide();
						}
					}
				}),

				new Upfront.Views.Editor.Field.Checkboxes({
					model: this.model,
					className: state + '-radius-lock border_radius_lock',
					name: me.options.fields.lock,
					label: "",
					default_value: 0,
					multiple: false,
					values: [
						{ label: '', value: 'yes' }
					],
					show: function(value) {
						me.model.set(me.options.fields.lock, value);

						var stateSettings = me.$el.closest('.state_modules');
						var useRadius = me.model.get(me.options.fields.use);

						//Toggle border radius fields
						if(value == "yes" && useRadius == "yes") {
							stateSettings.find('.'+ state +'-radius-slider').show();
							stateSettings.find('.'+ state +'-radius-slider-number').show();
							stateSettings.find('.'+ state +'-radius1').hide();
							stateSettings.find('.'+ state +'-radius2').hide();
							stateSettings.find('.'+ state +'-radius3').hide();
							stateSettings.find('.'+ state +'-radius4').hide();
						} else {
							if(useRadius == "yes") {
								stateSettings.find('.'+ state +'-radius-slider').hide();
								stateSettings.find('.'+ state +'-radius-slider-number').hide();
								stateSettings.find('.'+ state +'-radius1').show();
								stateSettings.find('.'+ state +'-radius2').show();
								stateSettings.find('.'+ state +'-radius3').show();
								stateSettings.find('.'+ state +'-radius4').show();
							}
						}
					}
				}),


				new Upfront.Views.Editor.Field.Slider({
					className: state + '-radius-slider upfront-field-wrap upfront-field-wrap-slider radius-slider',
					model: this.model,
					name: me.options.fields.radius,
					suffix: l10n.px,
					min: 1,
					max: me.options.max_value,
					change: throttledSliderOnChange,
					show: function() {
						var value = me.model.get(me.options.fields.radius_number);
						if(value > me.options.max_value) {
							me.$el.closest('.state_modules').find('.'+ state +'-radius-slider').css('opacity', 0.6);
						} else {
							me.$el.closest('.state_modules').find('.'+ state +'-radius-slider').css('opacity', 1);
						}
					}
				}),

				new Upfront.Views.Editor.Field.Number({
					model: this.model,
					className: state + '-radius-slider-number border_radius_number',
					name: me.options.fields.radius_number,
					label: '',
					min: 0,
					max: me.options.max_value,
					default_value: 0,
					values: [
						{ label: "", value: '0' }
					],
					change: throttledRadiusOnChange
				}),

				new Upfront.Views.Editor.Field.Number({
					model: this.model,
					className: state + '-radius1 border_radius border_radius1',
					name: me.options.fields.radius1,
					label: '',
					min: 0,
					max: me.options.max_value,
					default_value: 0,
					values: [
						{ label: "", value: '0' }
					],
					change: function(value) {
						me.model.set(me.options.fields.radius1, value);
					}
				}),

				new Upfront.Views.Editor.Field.Number({
					model: this.model,
					className: state + '-radius2 border_radius border_radius2 border_radius2_static',
					name: me.options.fields.radius2,
					label: '',
					min: 0,
					max: me.options.max_value,
					default_value: 0,
					values: [
						{ label: "", value: '0' }
					],
					change: function(value) {
						me.model.set(me.options.fields.radius2, value);
					}
				}),

				new	Upfront.Views.Editor.Field.Number({
					model: this.model,
					className: state + '-radius4 border_radius border_radius4',
					name: me.options.fields.radius4,
					label: '',
					min: 0,
					max: me.options.max_value,
					default_value: 0,
					values: [
						{ label: "", value: '0' }
					],
					change: function(value) {
						me.model.set(me.options.fields.radius4, value);
					}
				}),

				new Upfront.Views.Editor.Field.Number({
					model: this.model,
					className: state + '-radius3 border_radius border_radius3',
					name: me.options.fields.radius3,
					label: '',
					min: 0,
					max: me.options.max_value,
					default_value: 0,
					values: [
						{ label: "", value: '0' }
					],
					change: function(value) {
						me.model.set(me.options.fields.radius3, value);
					}
				}),


			]);
		},
		reset_fields: function(value) {
			if(typeof value !== "undefined" && value === "yes") {
				var settings = this.get_static_field_values(value, this.options.prepend);
				this.update_fields(value, settings);
				this.save_static_values(value, settings);
				this.$el.empty();
				this.render();
			}
		},

		save_static_values: function(value, settings) {
			//Save preset values from static state
			this.model.set(this.options.fields.lock, settings.lock);
			this.model.set(this.options.fields.radius, settings.radius);
			this.model.set(this.options.fields.radius_number, settings.radius_number);
			this.model.set(this.options.fields.radius1, settings.radius1);
			this.model.set(this.options.fields.radius2, settings.radius2);
			this.model.set(this.options.fields.radius3, settings.radius3);
			this.model.set(this.options.fields.radius4, settings.radius4);
		},

		get_static_field_values: function(value, prepend) {
			var settings = {},
				prefix = '';

			if(typeof this.options.prefix !== "undefined") {
				prefix = this.options.prefix + '-';
			}

			settings.lock = this.model.get(this.clear_prepend(prefix + this.options.fields.lock, prepend)) || '';
			settings.radius = this.model.get(this.clear_prepend(prefix + this.options.fields.radius, prepend)) || '';
			settings.radius_number = this.model.get(this.clear_prepend(prefix + this.options.fields.radius_number, prepend)) || '';
			settings.radius1 = this.model.get(this.clear_prepend(prefix + this.options.fields.radius1, prepend)) || '';
			settings.radius2 = this.model.get(this.clear_prepend(prefix + this.options.fields.radius2, prepend)) || '';
			settings.radius3 = this.model.get(this.clear_prepend(prefix + this.options.fields.radius3, prepend)) || '';
			settings.radius4 = this.model.get(this.clear_prepend(prefix + this.options.fields.radius4, prepend)) || '';

			return settings;
		},

		clear_prepend: function(field, prepend) {
			return field.replace(prepend, '');
		},

		update_fields: function(value, settings) {
			//Update slider value
			s = this.fields._wrapped[2];
			s.$el.find('#'+s.get_field_id()).slider('value', settings.radius);
			s.get_field().val(settings.radius);
			s.trigger('changed');
		},
	});

	return RadiusSettingsModule;
});

/*
* Field names properies
* `name` - Select box name
*/
define('scripts/upfront/settings/modules/selectbox',[
	'scripts/upfront/settings/modules/base-module'
], function(BaseModule) {
	var SelectboxSettingsModule = BaseModule.extend({
		className: 'settings_module selectbox_settings_item clearfix',
		group: true,
		get_title: function() {
			return this.options.title;
		},
		initialize: function(options) {
			this.options = options || {};

			if(typeof this.options.title === "undefined") {
				this.group = false;
			}

			var me = this,
				custom_class = this.options.custom_class,
				state = this.options.state;

			this.fields = _([
				new Upfront.Views.Editor.Field.Select({
					model: this.model,
					className: state + '-select select-module ' + custom_class,
					name: me.options.fields.name,
					default_value: me.options.default_value,
					label: me.options.label,
					values: me.options.values,
					change: function(value) {
						me.model.set(me.options.fields.name, value);
					}
				})
			]);
		},
	});

	return SelectboxSettingsModule;
});

define('scripts/upfront/settings/modules/caption-location',[
	'scripts/upfront/settings/modules/base-module'
], function(BaseModule) {
	var l10n = Upfront.Settings.l10n.image_element;
	var CaptionLocationSettingsModule = BaseModule.extend({
		className: 'settings_module image-caption-location caption_location clearfix',
		group: false,

		initialize: function(options) {
			this.options = options || {};
			var me = this,
				state = this.options.state;

			this.fields = _([
				new Upfront.Views.Editor.Field.Checkboxes({
					model: this.model,
					className: 'useCaptions checkbox-title',
					name: 'use_captions',
					label: '',
					default_value: 1,
					multiple: false,
					values: [
						{ label: l10n.settings.show_caption, value: 'yes' }
					],
					change: function(value) {
						me.model.set('use_captions', value);
					},
					show: function(value, $el) {
						var stateSettings = $el.closest('.state_modules');
						//Toggle color fields
						if(value == "yes") {
							stateSettings.find('.'+ state +'-caption-select').show();
							stateSettings.find('.'+ state +'-caption-trigger').show();
						} else {
							stateSettings.find('.'+ state +'-caption-select').hide();
							stateSettings.find('.'+ state +'-caption-trigger').hide();
						}
					}
				}),

				new Upfront.Views.Editor.Field.Radios({
					className: state + '-caption-trigger field-caption_trigger upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios over_image_field',
					model: this.model,
					name: 'caption-trigger',
					label: '',
					layout: 'horizontal-inline',
					values: [
						{
							label: l10n.settings.always,
							value: 'always_show'
						},
						{
							label: l10n.settings.hover,
							value: 'hover_show'
						}
					],
					change: function(value) {
						me.model.set('caption-trigger', value);
					}
				}),

				new Upfront.Views.Editor.Field.Select({
					model: this.model,
					className: state + '-caption-select caption_select',
					name: 'caption-position-value',
					default_value: 'topOver',
					label: l10n.ctrl.caption_position,
					values: [
						{ label: l10n.ctrl.over_top, value: 'topOver', icon: 'topOver' },
						{ label: l10n.ctrl.over_bottom, value: 'bottomOver', icon: 'bottomOver' },
						{ label: l10n.ctrl.cover_top, value: 'topCover', icon: 'topCover' },
						{ label: l10n.ctrl.cover_middle, value: 'middleCover', icon: 'middleCover' },
						{ label: l10n.ctrl.cover_bottom, value: 'bottomCover', icon: 'bottomCover' },
						{ label: l10n.ctrl.below, value: 'below', icon: 'below' },
					],
					change: function(value) {
						me.model.set('caption-position-value', value);
						switch(value){
							case 'topOver':
								me.model.set('caption-position', 'over_image');
								me.model.set('caption-alignment', 'top');
								break;
							case 'bottomOver':
								me.model.set('caption-position', 'over_image');
								me.model.set('caption-alignment', 'bottom');
								break;
							case 'topCover':
								me.model.set('caption-position', 'over_image');
								me.model.set('caption-alignment', 'fill');
								break;
							case 'middleCover':
								me.model.set('caption-position', 'over_image');
								me.model.set('caption-alignment', 'fill_middle');
								break;
							case 'bottomCover':
								me.model.set('caption-position', 'over_image');
								me.model.set('caption-alignment', 'fill_bottom');
								break;
							case 'below':
								me.model.set('caption-position', 'below_image');
								me.model.set('caption-alignment', false);
						}
					}
				})
			]);
		},
	});

	return CaptionLocationSettingsModule;
});

define('scripts/upfront/settings/modules/gallery-caption-location',[
	'scripts/upfront/settings/modules/base-module'
], function(BaseModule) {
	var l10n = Upfront.Settings.l10n.gallery_element;
	var CaptionLocation = BaseModule.extend({
		className: 'settings_module caption_location gallery-caption-location clearfix',
		group: false,

		initialize: function(options) {
			this.options = options || {};
			var me = this,
				state = this.options.state;

			this.fields = _([
				new Upfront.Views.Editor.Field.Checkboxes({
					model: this.model,
					className: 'useCaptions checkbox-title',
					name: 'use_captions',
					label: '',
					default_value: 1,
					multiple: false,
					values: [
						{ label: l10n.panel.show_caption, value: 'yes' }
					],
					change: function(value) {
						me.model.set('use_captions', value);
					},
					show: function(value, $el) {
						var stateSettings = $el.closest('.state_modules');
						//Toggle color fields
						if(value == "yes") {
							stateSettings.find('.'+ state +'-caption-select').show();
							stateSettings.find('.'+ state +'-caption-trigger').show();
							stateSettings.find('.'+ state +'-caption-height').show();
							var height_type = me.model.get('caption-height', value);
							if(height_type === "fixed") {
								stateSettings.find('.'+ state +'-caption-height-number').show();
							}
						} else {
							stateSettings.find('.'+ state +'-caption-select').hide();
							stateSettings.find('.'+ state +'-caption-trigger').hide();
							stateSettings.find('.'+ state +'-caption-height').hide();
							stateSettings.find('.'+ state +'-caption-height-number').hide();
						}
					}
				}),
				new Upfront.Views.Editor.Field.Select({
					model: this.model,
					className: state + '-caption-select caption_select',
					name: 'captionType',
					default_value: 'below',
					label: l10n.panel.caption_location,
					values: [
						{value: 'over', label: l10n.panel.over, icon: 'over'},
						{value: 'below', label: l10n.panel.under, icon: 'below'}
					],
					change: function(value) {
						me.model.set('captionType', value);
						
						//If caption below image, we should set captionOnHover to false
						if(value == "below") {
							me.model.set('showCaptionOnHover', '0');
						}
					},
					show: function(value, $el) {
						var stateSettings = $el.closest('.state_modules');
						if(value == "below") {
							stateSettings.find('.gallery-caption-on-hover').hide();
						} else {
							stateSettings.find('.gallery-caption-on-hover').show();
						}
					}
				}),

				new Upfront.Views.Editor.Field.Radios({
					className: state + '-caption-trigger field-caption_trigger gallery-caption-on-hover upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios over_image_field',
					model: this.model,
					name: 'showCaptionOnHover',
					label: '',
					layout: 'horizontal-inline',
					values: [
						{
							label: l10n.panel.always,
							value: '0'
						},
						{
							label: l10n.panel.hover,
							value: '1'
						}
					],
					change: function(value) {
						me.model.set('showCaptionOnHover', value);
					},
				}),

				new Upfront.Views.Editor.Field.Radios({
					className: state + '-caption-height field-caption-height upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios',
					model: this.model,
					name: 'caption-height',
					label: l10n.panel.caption_height,
					layout: 'horizontal-inline',
					values: [
						{
							label: l10n.panel.auto,
							value: 'auto'
						},
						{
							label: l10n.panel.fixed,
							value: 'fixed'
						}
					],
					change: function(value) {
						me.model.set('caption-height', value);
					},
					show: function(value, $el) {
						var stateSettings = $el.closest('.state_modules');
						//Toggle color fields
						if(value == "fixed") {
							stateSettings.find('.'+ state +'-caption-height-number').show();
						} else {
							stateSettings.find('.'+ state +'-caption-height-number').hide();
						}
					}
				}),

				new Upfront.Views.Editor.Field.Number({
					model: this.model,
					className: state + '-caption-height-number caption-height-number',
					name: 'thumbCaptionsHeight',
					min: 1,
					label: '',
					default_value: 20,
					values: [
						{ label: 'px', value: '1' }
					],
					change: function(value) {
						me.model.set('thumbCaptionsHeight', value);
					}
				})
			]);
		},
	});

	return CaptionLocation;
});

define('scripts/upfront/settings/modules/colors',[
	'scripts/upfront/settings/modules/base-module'
], function(BaseModule) {
	var l10n = Upfront.Settings.l10n.preset_manager;
	var ColorsSettingsModule = BaseModule.extend({
		className: 'settings_module colors_settings_item clearfix',
		group: true,

		get_title: function() {
			return this.options.title;
		},

		initialize: function(options) {
			this.options = options || {};
			this.fieldCounter = 0;
			var me = this,
				state = this.options.state,
				per_row = 'single',
				toggleClass = 'no-toggle',
				fields = [];

			if(this.options.toggle === true) {
				this.fieldCounter++;
			}

			if(this.options.single !== true) {
				per_row = 'two';
			}
			_.each(this.options.abccolors, function(color) {
				if(me.options.toggle === true) {
					toggleClass = 'element-toggled';
				}
				var colorField = new Upfront.Views.Editor.Field.Color({
					className: state + '-color-field upfront-field-wrap-color color-module module-color-field ' + toggleClass + ' ' + per_row,
					blank_alpha : 0,
					model: me.model,
					name: color.name,
					default_value: me.model.get(color.name),
					label_style: 'inline',
					label: color.label,
					spectrum: {
						preferredFormat: 'hex',
						change: function(value) {
							if (!value) return false;
							var c = value.get_is_theme_color() !== false ? value.theme_color : value.toRgbString();
							me.model.set(color.name, c);
						},
						move: function(value) {
							if (!value) return false;
							var c = value.get_is_theme_color() !== false ? value.theme_color : value.toRgbString();
							me.model.set(color.name, c);
						}
					}
				});
				fields.push(colorField);
			});

			this.fields = _(fields);

			//Add toggle colors checkbox
			if(this.options.toggle === true) {
				this.group = false;
				this.fields.unshift(
					new Upfront.Views.Editor.Field.Checkboxes({
						model: this.model,
						className: 'useColors checkbox-title',
						name: me.options.fields.use,
						label: '',
						multiple: false,
						values: [
							{
								label: l10n.color,
								value: 'yes',
								checked: this.model.get(me.options.fields.use)
							}
						],
						change: function(value) {
							me.model.set(me.options.fields.use, value);
							me.reset_fields(value);
						},
						show: function(value, $el) {
							var stateSettings = $el.closest('.state_modules');
							//Toggle color fields
							if(value == "yes") {
								stateSettings.find('.'+ state +'-color-field').show();
							} else {
								stateSettings.find('.'+ state +'-color-field').hide();
							}
						}
					})
				);
			}
		},

		reset_fields: function(value) {
			var me = this;
			if(typeof value !== "undefined" && value === "yes") {
				_.each(this.options.abccolors, function(color) {
					var settings = me.get_static_field_value(color, me.options.prepend);
					me.update_field(color, settings);
					me.save_static_value(color, settings);
					this.fieldCounter++;
				});

				this.$el.empty();
				this.render();
			}
		},

		save_static_value: function(color, settings) {
			//Save preset values from static state
			this.model.set(color.name, settings.color);
		},

		get_static_field_value: function(color, prepend) {
			var settings = {},
				prefix = '';

			if(typeof this.options.prefix !== "undefined") {
				prefix = this.options.prefix + '-';
			}

			settings.color = this.model.get(this.clear_prepend(prefix + color.name, prepend)) || '';

			return settings;
		},

		clear_prepend: function(field, prepend) {
			return field.replace(prepend, '');
		},

		update_field: function(color, settings) {
			//Update selected element
			this.fields._wrapped[this.fieldCounter].set_value(settings.color);
			this.fields._wrapped[this.fieldCounter].update_input_border_color(settings.color);
		},
		render: function() {
			var me = this;
			this.constructor.__super__.render.call(this);
			this.fields.each( function (field) {
				if(typeof field.spectrumOptions !== "undefined") {
					var color = me.model.get(field.name);
					field.set_value(color);
					field.update_input_border_color(Upfront.Util.colors.to_color_value(color));
				}
      });
		}
	});

	return ColorsSettingsModule;
});

define('scripts/upfront/settings/modules/element-style',[
	'scripts/upfront/settings/modules/base-module'
], function(BaseModule) {
	var l10n = Upfront.Settings.l10n.preset_manager;

	var ElementStyleModule = BaseModule.extend({
		className: "upfront-settings-item-anchor",

		initialize: function (opts) {
			this.options = opts;
			var me = this;
			var displayStyle = new Upfront.Views.Editor.Field.Text({
				model: this.model,
				property: 'theme_style',
				label: 'Element style:'
			});

			var openEditor = new Upfront.Views.Editor.Field.Button({
				label: 'Show style',
				compact: true,
				on_click: function(){
					me.openCssEditor();
				},
				display: 'inline'
			});

			var removeStyle = new Upfront.Views.Editor.Field.Button({
				label: 'Remove style',
				compact: true,
				on_click: function(){
					me.removeStyle();
				},
				display: 'inline'
			});

			this.listenTo(displayStyle, 'rendered', function() {
				displayStyle.$el.find('input').attr('readonly', 'readonly');
			});

			this.fields = _([
				displayStyle,
				openEditor,
				removeStyle
			]);

			this.on('panel:set', function(){
				me.fields.each(function(field){
					field.panel = me.panel;
					field.trigger('panel:set');
				});
			});
		},

		openCssEditor: function() {
			var elementStyleName = this.model.get_property_value_by_name('theme_style');

			Upfront.Application.cssEditor.init({
				model: this.model,
				stylename: elementStyleName,
				sidebar: false,
				toolbar: false,
				readOnly: true
			});
		},

		removeStyle: function() {
			this.$el.find('input[type=text]').val('');
			this.$el.hide();
			this.model.set_property('theme_style', '');
		}
	});

	return ElementStyleModule;
});

define('scripts/upfront/settings/modules/padding',[
	'scripts/upfront/settings/modules/base-module'
], function(BaseModule) {
	var l10n = Upfront.Settings.l10n.preset_manager;
	var PaddingSettingsModule = BaseModule.extend({
		className: 'padding-settings sidebar-settings clearfix',

		initialize: function(options) {
			this.options = options || {};
			var me = this,
				column_padding = Upfront.Settings.LayoutEditor.Grid.column_padding;

			this.listenTo(Upfront.Events, "upfront:paddings:updated", this.refresh);

			this.fields = _([
				new Upfront.Views.Editor.Field.Checkboxes({
					model: this.model,
					className: 'use-padding checkbox-title',
					use_breakpoint_property: true,
					property: 'use_padding',
					label: '',
					default_value: this.model.get_breakpoint_property_value('top_padding_use') || this.model.get_breakpoint_property_value('bottom_padding_use') || this.model.get_breakpoint_property_value('left_padding_use') || this.model.get_breakpoint_property_value('right_padding_use'),
					multiple: false,
					values: [
						{ label: 'Customize Padding', value: 'yes' }
					],
					change: function(value) {
						me.model.set_breakpoint_property('use_padding', value);
						
						if(typeof value === "undefined") {
							//Disable custom padding, update to theme default padding
							me.model.set_breakpoint_property('left_padding_num', column_padding, true);
							me.model.set_breakpoint_property('top_padding_num', column_padding, true);
							me.model.set_breakpoint_property('right_padding_num', column_padding, true);
							me.model.set_breakpoint_property('bottom_padding_num', column_padding, true);
							padding_left.get_field().val(column_padding);
							padding_top.get_field().val(column_padding);
							padding_right.get_field().val(column_padding);
							padding_bottom.get_field().val(column_padding);
							
							//Disable paddings
							me.disable_paddings();
						}
					},
					show: function(value, $el) {
						var stateSettings = $el.closest('.upfront-settings-item-content');
						var lock = me.model.get_breakpoint_property_value('lock_padding');
						//Toggle padding fields
						if(value == "yes") {
							if(lock == "yes") {
								stateSettings.find('.padding-slider').show();
								stateSettings.find('.padding-number').show();
							} else {
								stateSettings.find('.padding-top').show();
								stateSettings.find('.padding-bottom').show();
								stateSettings.find('.padding-left').show();
								stateSettings.find('.padding-right').show();
							}
						} else {
							stateSettings.find('.padding-top').hide();
							stateSettings.find('.padding-bottom').hide();
							stateSettings.find('.padding-left').hide();
							stateSettings.find('.padding-right').hide();
							stateSettings.find('.padding-slider').hide();
							stateSettings.find('.padding-number').hide();
						}
					}
				}),

				lock_padding = new Upfront.Views.Editor.Field.Checkboxes({
					model: this.model,
					className: 'padding-lock',
					use_breakpoint_property: true,
					property: 'lock_padding',
					label: "",
					default_value: 0,
					multiple: false,
					values: [
						{ label: '', value: 'yes' }
					],
					show: function(value) {
						me.model.set_breakpoint_property('lock_padding', value);

						var stateSettings = me.$el;
						var usePadding = me.model.get_breakpoint_property_value('use_padding');
						var padding = me.model.get_breakpoint_property_value('padding_number');

						//Toggle border radius fields
						if(value == "yes" && usePadding == "yes") {
							stateSettings.find('.padding-slider').show();
							stateSettings.find('.padding-number').show();
							stateSettings.find('.padding-top').hide();
							stateSettings.find('.padding-bottom').hide();
							stateSettings.find('.padding-left').hide();
							stateSettings.find('.padding-right').hide();
							
							me.model.set_breakpoint_property('left_padding_num', padding);
							me.model.set_breakpoint_property('top_padding_num', padding);
							me.model.set_breakpoint_property('right_padding_num', padding);
							me.model.set_breakpoint_property('bottom_padding_num', padding);
							padding_left.get_field().val(padding);
							padding_top.get_field().val(padding);
							padding_right.get_field().val(padding);
							padding_bottom.get_field().val(padding);

							if(typeof(Upfront.data.currentEntity.paddingControl) !== 'undefined') {
								Upfront.data.currentEntity.paddingControl.refresh();
							}
						} else {
							if(usePadding == "yes") {
								stateSettings.find('.padding-slider').hide();
								stateSettings.find('.padding-number').hide();
								stateSettings.find('.padding-top').show();
								stateSettings.find('.padding-bottom').show();
								stateSettings.find('.padding-left').show();
								stateSettings.find('.padding-right').show();
							}
						}
					},
					change: function(value) {
						me.model.set_property('lock_padding', value);
					}
				}),


				locked_slider = new Upfront.Views.Editor.Field.Slider({
					className: 'padding-slider upfront-field-wrap',
					model: this.model,
					use_breakpoint_property: true,
					property: 'padding_slider',
					default_value: this.model.get_breakpoint_property_value('padding_slider') || column_padding,
					suffix: l10n.px,
					step: 5,
					min: 0,
					max: 250,
					change: function (value) {
						//Update all padding values
						me.model.set_breakpoint_property('padding_slider', value);
						me.model.set_breakpoint_property('padding_number', value, true);
						me.model.set_breakpoint_property('left_padding_num', value, true);
						me.model.set_breakpoint_property('top_padding_num', value, true);
						me.model.set_breakpoint_property('right_padding_num', value, true);
						me.model.set_breakpoint_property('bottom_padding_num', value, true);
						
						locked_num.get_field().val(value);
						padding_left.get_field().val(value);
						padding_top.get_field().val(value);
						padding_right.get_field().val(value);
						padding_bottom.get_field().val(value);
						
						//Enable padding fields
						me.enable_lock_padding();
						
						me.re_render_entity();
					},
					show: function() {
						var value = me.model.get_property_value_by_name('padding_number');
						if(value > 250) {
							me.$el.find('.padding-slider').css('opacity', 0.6);
						} else {
							me.$el.find('.padding-slider').css('opacity', 1);
						}
					}
				}),

				locked_num = new Upfront.Views.Editor.Field.Number({
					className: 'padding-number',
					model: this.model,
					use_breakpoint_property: true,
					property: 'padding_number',
					default_value: this.model.get_breakpoint_property_value('padding_number') || column_padding,
					label: '',
					step: 5,
					min: 0,
					change: function(value) {
						// me.model.set('padding_number', value);
						me.model.set_breakpoint_property('padding_slider', value);
						me.model.set_breakpoint_property('padding_number', value);
						locked_slider.$el.find('#'+locked_slider.get_field_id()).slider('value', value);
						
						//Update all padding values
						me.model.set_breakpoint_property('left_padding_num', value, true);
						me.model.set_breakpoint_property('top_padding_num', value, true);
						me.model.set_breakpoint_property('right_padding_num', value, true);
						me.model.set_breakpoint_property('bottom_padding_num', value, true);
						padding_left.get_field().val(value);
						padding_top.get_field().val(value);
						padding_right.get_field().val(value);
						padding_bottom.get_field().val(value);
						
						//Enable padding fields
						me.enable_lock_padding();
									
						me.re_render_entity();
						
						//Lower opacity if value is bigger than the slider MAX_VALUE
						if(value > 250) {
							me.$el.find('.padding-slider').css('opacity', 0.6);
						} else {
							me.$el.find('.padding-slider').css('opacity', 1);
						}
					}
				}),

				padding_top = new Upfront.Views.Editor.Field.Number({
					model: this.model,
					className: 'padding-top',
					use_breakpoint_property: true,
					property: 'top_padding_num',
					label: '',
					step: 5,
					min: 0,
					default_value: this.model.get_breakpoint_property_value('top_padding_num') || column_padding,
					change: function(value) {
						me.model.set_breakpoint_property('top_padding_num', value);
						me.enable_padding('top_padding_use');
					},
					focus: function() {
						me.$el.find('.padding-bottom label').css('border-top', '3px solid #7bebc6');
					},
					blur: function() {
						me.$el.find('.padding-bottom label').css('border', '1px dotted #7d99b3');
					}
				}),

				padding_left = new Upfront.Views.Editor.Field.Number({
					model: this.model,
					className: 'padding-left',
					use_breakpoint_property: true,
					property: 'left_padding_num',
					label: '',
					step: 5,
					min: 0,
					default_value: this.model.get_breakpoint_property_value('left_padding_num') || column_padding,
					change: function(value) {
						me.model.set_breakpoint_property('left_padding_num', value);
						me.enable_padding('left_padding_use');
					},
					focus: function() {
						me.$el.find('.padding-bottom label').css('border-left', '3px solid #7bebc6');
					},
					blur: function() {
						me.$el.find('.padding-bottom label').css('border', '1px dotted #7d99b3');
					}
				}),

				padding_right = new Upfront.Views.Editor.Field.Number({
					model: this.model,
					className: 'padding-right',
					use_breakpoint_property: true,
					property: 'right_padding_num',
					label: '',
					step: 5,
					min: 0,
					default_value: this.model.get_breakpoint_property_value('right_padding_num') || column_padding,
					change: function(value) {
						me.model.set_breakpoint_property('right_padding_num', value);
						me.enable_padding('right_padding_use');
					},
					focus: function() {
						me.$el.find('.padding-bottom label').css('border-right', '3px solid #7bebc6');
					},
					blur: function() {
						me.$el.find('.padding-bottom label').css('border', '1px dotted #7d99b3');
					}
				}),

				padding_bottom = new Upfront.Views.Editor.Field.Number({
					model: this.model,
					className: 'padding-bottom',
					use_breakpoint_property: true,
					property: 'bottom_padding_num',
					label: '',
					step: 5,
					min: 0,
					default_value: this.model.get_breakpoint_property_value('bottom_padding_num') || column_padding,
					change: function(value) {
						me.model.set_breakpoint_property('bottom_padding_num', value);
						me.enable_padding('bottom_padding_use');
					},
					focus: function() {
						me.$el.find('.padding-bottom label').css('border-bottom', '3px solid #7bebc6');
					},
					blur: function() {
						me.$el.find('.padding-bottom label').css('border', '1px dotted #7d99b3');
					}
				}),

			]);
		},
		
		refresh: function() {
			//Check use_padding when default settings are overwriten
			this.model.set_breakpoint_property('use_padding', 'yes');

			//Update fields when element padding is changed
			var lockPadding      = this.model.get_breakpoint_property_value('lock_padding'),
				lockPaddingField = this.fields._wrapped[1].get_field(),
				topPadding       = this.model.get_breakpoint_property_value('top_padding_num'),
				bottomPadding    = this.model.get_breakpoint_property_value('bottom_padding_num'),
				leftPadding      = this.model.get_breakpoint_property_value('left_padding_num'),
				rightPadding     = this.model.get_breakpoint_property_value('right_padding_num')
			;

			lockPadding ? lockPaddingField.attr('checked', 'checked') : lockPaddingField.removeAttr('checked');
			lockPaddingField.trigger('change');
			this.fields._wrapped[4].get_field().val(topPadding);
			this.fields._wrapped[5].get_field().val(leftPadding);
			this.fields._wrapped[6].get_field().val(rightPadding);
			this.fields._wrapped[7].get_field().val(bottomPadding);
		},
		
		enable_padding: function(field) {
			//Enable padding when settings is changed
			this.model.set_breakpoint_property(field, 'yes');
			
			Upfront.Events.trigger("upfront:paddings:updated");
		},
		
		disable_paddings: function() {
			//Enable padding when settings is changed
			this.model.set_breakpoint_property('top_padding_use', '');
			this.model.set_breakpoint_property('bottom_padding_use', '');
			this.model.set_breakpoint_property('left_padding_use', '');
			this.model.set_breakpoint_property('right_padding_use', '');
			Upfront.Events.trigger("upfront:paddings:updated");
		},
		
		enable_lock_padding: function() {
			var is_group = this.model instanceof Upfront.Models.ModuleGroup;
			
			this.enable_padding('top_padding_use');
			this.enable_padding('bottom_padding_use');
			if( ! is_group ) {
				this.enable_padding('left_padding_use');
				this.enable_padding('right_padding_use');
			}
		},

		re_render_entity: function() {							
			var currentEntity = Upfront.data.currentEntity;
			clearTimeout(this.refresh_timer);
			this.refresh_timer = setTimeout(function() {
				if(typeof(currentEntity.render) === 'function') currentEntity.render();
			}, 200);
		}
	});

	return PaddingSettingsModule;
});

define('scripts/upfront/settings/modules/anchor',[
	'scripts/upfront/settings/modules/base-module'
], function(BaseModule) {
	var l10n = Upfront.Settings.l10n.preset_manager;

	var Field_Complex_Toggleable_Text_Field = Upfront.Views.Editor.Field.Field.extend({
		className: "upfront-field-complex_field-boolean_toggleable_text upfront-field-multiple",
		tpl: '<input type="checkbox" class = "upfront-field-checkbox" /> <label><span class="upfront-field-label-text">{{element_label}}</span></label> <div class="upfront-embedded_toggleable" style="display:none">{{field}}<div class="upfront-embedded_toggleable-notice">' + Upfront.Settings.l10n.global.views.anchor_nag + '</div></div>',
		initialize: function (opts) {
			Upfront.Views.Editor.Field.Field.prototype.initialize.call(this, opts);
			this.options.field = new Upfront.Views.Editor.Field.Text(this.options);
		},
		render: function () {
			var me = this;
			this.$el.empty();
			this.$el.append(this.get_field_html());

			this.$el.on("click", ':checkbox', function (e) {
				e.stopPropagation();
				me.field_toggle.apply(me);
			});
			if (this.model.get_property_value_by_name(this.options.field.get_name())) {
				this.$el.find(':checkbox').attr("checked", true);
				this.check_value();
				this.field_toggle();
			}

			this.$el.on("keyup", '[name="' + this.options.field.get_name() + '"]', function (e) {
				e.stopPropagation();
				me.check_value.apply(me);
			});

			setTimeout(function () {
				me.trigger("anchor:updated");
			}, 50);
		},
		field_toggle: function () {
			if (this.$el.find(":checkbox").is(":checked")) {
				this.$el.find(".upfront-embedded_toggleable").show();
			} else {
				this.$el.find(".upfront-embedded_toggleable").hide();
			}
			this.property.set({value: this.get_value()});
			this.trigger("anchor:updated");
		},
		check_value: function () {
			var $field = this.$el.find('[name="' + this.options.field.get_name() + '"]'),
				$root = this.$el.find(".upfront-embedded_toggleable"),
				val = $field.length && $field.val ? $field.val() : ''
			;
			$root.removeClass("error").removeClass("ok");
			if (val.length && !val.match(/^[a-zA-Z]+$/)) {
				$root.addClass("error");
			} else if (val.length) {
				$root.addClass("ok");
			}
			this.property.set({value: this.get_value()});
		},
		get_field_html: function () {
			this.options.field.render();
			var $input = this.options.field.$el;
			return _.template(this.tpl, _.extend({}, this.options, {field: $input.html()}));
		},
		get_value: function () {
			var data = {},
				$field = this.$el.find(":checkbox"),
				$subfield = this.$el.find('[name="' + this.options.field.get_name() + '"]'),
				value = $subfield.val().replace(/[^a-zA-Z]/g, '')
			;
			return $field.is(":checked") && value ? value : ''; // was false
		}
	});

	var AnchorSettingsModule = BaseModule.extend({
		className: "upfront-settings-item-anchor",

		initialize: function (opts) {
			this.options = opts;

			var anchorField = new Field_Complex_Toggleable_Text_Field({
				element_label: Upfront.Settings.l10n.global.views.make_element_anchor,
				className: 'upfront-field-complex_field-boolean_toggleable_text upfront-field-multiple checkbox-title',
				model: this.model,
				property: 'anchor'
			});

			anchorField.on("anchor:updated", function () {
				this.trigger("anchor:item:updated");
			}, this);

			this.fields = _([anchorField]);
		},

		save_fields: function () {
			this.fields.invoke("check_value");
			BaseModule.prototype.save_fields.call(this);
		}
	});

	return AnchorSettingsModule;
});

define('elements/upfront-newnavigation/js/menu-util',[], function () {
	var l10n = Upfront.Settings.l10n.newnavigation_element;

	var MenuUtil = function() {
		var self = this;
		// Array of wp menus with all data
		var wpMenus = Upfront.mainData.menus;
		// Array of {label: "Menu Name", value: "42"} items
		var selectMenuOptions = _.map(wpMenus, function (menu, index) {
			return  {label: menu.name, value: menu.term_id};
		});

		this.getMenuById = function(id) {
			var id_str = id + '',
				id_int = parseInt(id_str, 10),
				menu = _.findWhere(wpMenus, {term_id: id_int})
			;
			if (_.isUndefined(menu)) 
				menu = _.findWhere(wpMenus, {term_id: id_str})
			return menu;
		};

		this.getMenuSlugById = function(id) {
			return (this.getMenuById(id) || {}).slug;
		};

		this.getSelectMenuOptions = function() {
			return selectMenuOptions;
		};

		this.addMenu = function(menuData) {
			menuData.term_id = menuData.term_id + '';
			wpMenus.push(menuData);
			selectMenuOptions.unshift({label: menuData.slug, value: menuData.term_id});
		};

		this.deleteMenu = function(menuId) {
			selectMenuOptions = _.reject(selectMenuOptions, function(option) {
				return option.value === menuId;
			});
			wpMenus = _.reject(wpMenus, function(menu) {
				return menu['term_id'] === menuId;
			});
		};

		Upfront.Events.on('menu_element:menu_created', function(menuData) {
			self.addMenu(menuData);
		});

		Upfront.Events.on('menu_element:delete', function(menuId) {
			self.deleteMenu(menuId);
		});
	};

	var menuUtil = new MenuUtil();

	return menuUtil;
});


define('text!scripts/upfront/settings/modules/menu-structure/menu-item-editor.tpl',[],function () { return '<form>\r\n\t<label>Menu Item Label:</label>\r\n\t<input type="text" class="menu-item-title" value="{{ title }}">\r\n\t<label class="item-links-to-label">{{Upfront.Settings.l10n.global.content.links_to}}</label>\r\n\t<div class="menu-item-type-editor">\r\n\t\t{[if(type == \'external\') { ]}\r\n\t\t\t<input type="text" class="menu-item-external-input" value="{{url}}" placeholder="Type link URL" >\r\n\t\t{[ } ]}\r\n\t\t{[if(type == \'entry\') { ]}\r\n\t\t\t<span class="menu-item-entry-display">{{url}}</span>\r\n\t\t\t<span class="menu-item-entry-input" >Edit Link</span>\r\n\t\t{[ } ]}\r\n\t\t{[if(type == \'anchor\') { ]}\r\n\t\t<div class="anchor-selector">\r\n\t\t</div>\r\n\t\t{[ } ]}\r\n\t\t{[if(type == \'email\') { ]}\r\n\t\t<div class="upfront-field-wrap ulinkpanel-external-wrap">\r\n\t\t\t<input type="text" value="{{url}}" placeholder="johnsmith@example.com" class="menu-item-email-input">\r\n\t\t</div>\r\n\t\t{[ } ]}\r\n\t\t{[if(type == \'lightbox\') { ]}\r\n\t\t\t{[ if(lightboxes.length) { ]}\r\n\t\t\t\t<div class="lightbox-selector">\r\n\t\t\t\t</div>\r\n\t\t\t{[ } else { ]}\r\n\r\n\t\t\t{[ } ]}\r\n\r\n\t\t\t\t<div class="new-lightbox">\r\n\t\t\t\t\t\t<label>Create lightbox</label>\r\n\t\t\t\t\t\t<input type="text" name="menu-item-lightbox-input" class="menu-item-lightbox-input upfront-field upfront-field-text upfront-field-empty" value="" placeholder="{{Upfront.Settings.l10n.global.content.lightbox_name}}" />\r\n\t\t\t\t</div>\r\n\t\t{[ } ]}\r\n\t\t{[if(type !== \'lightbox\' && type !== \'anchor\') { ]}\r\n\t\t\t<label class="menu-item-target-label">Link Opens In:</label>\r\n\t\t{[ } ]}\r\n\t</div>\r\n</form>\r\n';});

(function ($) {
define('scripts/upfront/settings/modules/menu-structure/menu-item-editor',[
	'text!scripts/upfront/settings/modules/menu-structure/menu-item-editor.tpl'
], function(tpl) {
	var getLightBoxes = function() {
		var lightboxes = [],
			regions = Upfront.Application.layout.get('regions');

		_.each(regions.models, function(model) {
			if(model.attributes.sub == 'lightbox') {
				lightboxes.push({id: '#' + model.get('name'), label: model.get('title')});
			}
		});

		return lightboxes;
	};

	var getAnchors = function() {
		var regions = Upfront.Application.layout.get("regions"),
			anchors = [],
			find;

		find = function (modules) {
			modules.each(function(module) {
				var group_anchor = module.get_property_value_by_name("anchor");
				if (group_anchor && group_anchor.length) {
					anchors.push({id: '#' + group_anchor, label: group_anchor});
				}
				if (module.get("objects")) {
					module.get("objects").each(function (object) {
						var anchor = object.get_property_value_by_name("anchor");
						if (anchor && anchor.length) {
							anchors.push({id: '#' + anchor, label: anchor});
						}
					});
				} else if ( module.get("modules") ) {
					find(module.get("modules"));
				}
			});
		};

		regions.each(function(r) {
			find(r.get("modules"));
		});

		return anchors;
	};

	var getPostTypes = function(){
		var types = [];

		_.each(Upfront.data.ugallery.postTypes, function(type){
			if(type.name != 'attachment') {
				types.push({name: type.name, label: type.label});
			}
		});

		return types;
	};

	var MenuItemEditor = Backbone.View.extend({
		className: 'menu-item-editor',

		events: {
			'click .menu-item-entry-input': 'showPagePostSelector',
			'keydown .menu-item-lightbox-input': 'onLightboxNameInputChange',
			'keydown .menu-item-external-input': 'onUrlNameKeydown',
			'change .menu-item-external-input': 'onUrlNameChange',
			'keydown .menu-item-email-input': 'onEmailNameKeydown',
			'change .menu-item-email-input': 'onEmailNameChange',
			'keydown .menu-item-title': 'onItemNameKeydown',
			'change .menu-item-title': 'onItemNameChange'
		},

		initialize: function(options) {
			this.options = options || {};
			this.type = Upfront.Util.guessLinkType(this.model.get('menu-item-url'));
		},

		render: function() {
			this.$el.html(_.template(tpl, {
				title: this.model.get('menu-item-title'),
				type:  this.type,
				lightboxes: getLightBoxes(),
				url: this.model.get('menu-item-url')
			}));

			this.renderTypeSelect();

			if (this.type === 'anchor') {
				this.renderAnchorSelect();
			}

			if (this.type === 'lightbox' && getLightBoxes()) {
				this.renderLightBoxesSelect();
			}

			if (this.type !== 'anchor' && this.type !== 'anchor') {
				this.renderLinkTargetSelect();
			}

			return this;
		},

		renderTypeSelect: function() {
			var me = this;

			var typeSelectValues = [];
			_.each(['unlink', 'external', 'entry', 'anchor', 'lightbox', 'email'], function(t) {
				typeSelectValues.push(this.getLinkTypeValue(t));
			}, this);

			this.typeSelect = new Upfront.Views.Editor.Field.Select({
				label: '',
				values: typeSelectValues,
				default_value: this.type || 'external',
				change: function (value) {
					me.onTypeChange(value);
				}
			});

			this.typeSelect.render();
			this.$el.find('.item-links-to-label').after(this.typeSelect.el);
		},

		renderLinkTargetSelect: function() {
			var me = this;

			var targetSelect = new Upfront.Views.Editor.Field.Select({
				label: '',
				values: [
					{ value: '', label: 'Same Browser Tab' },
					{ value: '_blank', label: 'New Browser Tab' }
				],
				default_value: this.model.get('menu-item-target'),
				change: function (value) {
					me.onTargetChange(value);
				}
			});

			targetSelect.render();
			this.$el.find('.menu-item-target-label').after(targetSelect.el);
		},

		/**
		 * Determine proper link type select value/label based on link type. Used
		 * to populate link type select field.
		 */
		getLinkTypeValue: function(type) {
			var contentL10n = Upfront.Settings.l10n.global.content;
			switch(type) {
				case 'unlink':
					return { value: 'unlink', label: contentL10n.no_link };
				case 'external':
					return { value: 'external', label: contentL10n.url };
				case 'email':
					return { value: 'email', label: contentL10n.email_address };
				case 'entry':
					return { value: 'entry', label: contentL10n.post_or_page };
				case 'anchor':
					return { value: 'anchor', label: contentL10n.anchor };
				case 'image':
					return { value: 'image', label: contentL10n.larger_image };
				case 'lightbox':
					return { value: 'lightbox', label: contentL10n.lightbox };
			}
		},

		showPagePostSelector: function(event) {
			if (event) {
				event.preventDefault();
			}

			var me = this,
				selectorOptions = {
					postTypes: getPostTypes()
				};

			Upfront.Views.Editor.PostSelector.open(selectorOptions).done(
				function(post) {
					me.model.set({'menu-item-url' : post.get('permalink')});
					me.saveItem();
					me.render();
				}
			);
		},

		saveItem: function() {
			var me = this;
			Upfront.Util.post({
				action: 'upfront_update_single_menu_item',
				menuId: this.options.menuId,
				menuItemData: this.model.toJSON()
			}).done( function() {
				me.trigger('change');
			});
		},

		onTypeChange: function(value) {
			// First reset url property
			// We don't want funny results when changing from one type to another.
			this.model.set({'menu-item-url': ''});
			this.type = value;
			this.render();

			if (this.type === 'entry') {
				this.showPagePostSelector();
			}
			this.$el.parent().find('.menu-item-type').first().text(this.getLinkTypeLabel(value));
		},

		onTargetChange: function(value) {
			this.model.set({'menu-item-target': value});
			this.saveItem();
		},

		renderAnchorSelect: function() {
			var me = this;

			var anchorValues = [{label: 'Choose Anchor...', value: ''}];
			_.each(getAnchors(), function(anchor) {
				anchorValues.push({label: anchor.label, value: anchor.id});
			});

			var anchorValue = this.model.get('menu-item-url');
			anchorValue = anchorValue ? anchorValue : '';
			anchorValue = anchorValue.match(/^#/) ? anchorValue : '';

			this.anchorSelect = new Upfront.Views.Editor.Field.Select({
				label: '',
				values: anchorValues,
				default_value: anchorValue,
				change: function () {
					me.model.set({'menu-item-url': this.get_value()});
					me.saveItem();
				}
			});
			this.anchorSelect.render();
			this.$el.find('.anchor-selector').append(this.anchorSelect.el);
		},

		renderLightBoxesSelect: function() {
			var me = this;

			var lightboxValues = [{label: 'Choose Lightbox...', value: ''}];
			_.each(getLightBoxes() || [], function(lightbox) {
				lightboxValues.push({label: lightbox.label, value: lightbox.id});
			});

			var lightboxValue = this.model.get('menu-item-url');
			lightboxValue = lightboxValue ? lightboxValue : '';
			lightboxValue = lightboxValue.match(/^#/) ? lightboxValue : '';

			this.lightboxSelect = new Upfront.Views.Editor.Field.Select({
				label: '',
				values: lightboxValues,
				default_value: lightboxValue,
				change: function () {
					me.model.set({'url': this.get_value()});
					me.saveItem();
				}
			});
			this.lightboxSelect.render();
			this.$el.find('.lightbox-selector').append(this.lightboxSelect.el);
		},

		onLightboxNameInputChange: function(event) {
			if (event.which == 13) {
				event.preventDefault();
				this.createLightBox();
			}
		},

		createLightBox: function() {
			var name = $.trim(this.$('.menu-item-lightbox-input').val());
			if (!name) {
				Upfront.Views.Editor.notify(l10n.ltbox_empty_name_nag, 'error');
				return false;
			}

			this.model.set({
				'menu-item-url': '#' + Upfront.Application.LayoutEditor.createLightboxRegion(name)
			});
			this.saveItem();
			this.render();
		},

		onUrlNameKeydown: function(event) {
			if (event.which == 13) {
				event.preventDefault();
				this.onUrlNameChange();
			}
		},

		onUrlNameChange: function() {
			this.model.set({
				'menu-item-url': $.trim(this.$el.find('.menu-item-external-input').val())
			});
			this.saveItem();
		},
		
		onEmailNameKeydown: function(event) {
			if (event.which == 13) {
				event.preventDefault();
				this.onEmailNameChange();
			}
		},

		onEmailNameChange: function() {
			this.model.set({
				'menu-item-url': 'mailto:' + $.trim(this.$el.find('.menu-item-email-input').val())
			});
			this.saveItem();
		},

		onItemNameKeydown: function(event) {
			if (event.which == 13) {
				event.preventDefault();
				this.onItemNameChange();
			}
		},

		onItemNameChange: function() {
			var newTitle = $.trim(this.$el.find('.menu-item-title').val());
			this.model.set({
				'menu-item-title': newTitle
			});
			this.$el.parent().find('.menu-item-title').first().text(newTitle);
			this.saveItem();
		},

		getLinkTypeLabel: function(type) {
			var contentL10n = Upfront.Settings.l10n.global.content;
			switch(type) {
				case 'unlink':
					return contentL10n.no_link ;
				case 'external':
					return contentL10n.url;
				case 'email':
					return contentL10n.email_address;
				case 'entry':
					return contentL10n.post_or_page;
				case 'anchor':
					return contentL10n.anchor;
				case 'image':
					return contentL10n.larger_image;
				case 'lightbox':
					return contentL10n.lightbox;
			}
		}
	});

	return MenuItemEditor;
});
})(jQuery);


define('text!scripts/upfront/settings/modules/menu-structure/menu-item.tpl',[],function () { return '<div class="menu-item-header">\r\n\t<span class="menu-item-title" title="{{ title }}">{{ title }}</span>\r\n\t<span class="menu-item-type" title="{{ type }}">{{ type }}</span>\r\n\t<i class="menu-item-delete">x</i>\r\n</div>\r\n';});

define('scripts/upfront/settings/modules/menu-structure/menu-item',[
	'scripts/upfront/settings/modules/menu-structure/menu-item-editor',
	'text!scripts/upfront/settings/modules/menu-structure/menu-item.tpl'
], function(MenuItemEditor, tpl) {
	var MenuItem = Backbone.View.extend({
		className: 'menu-structure-module-item',

		events: {
			'click .menu-item-header': 'toggleEditor',
			'click .menu-item-delete': 'deleteItem'
		},

		initialize: function(options) {
			this.options = options || {};
			this.subViews = [];
			this.depth = this.options.depth || 0;
			this.parent_view = options.parent_view;
			var sub = this.model.get('sub');

			if (sub) {
				_.each(sub, function(itemOptions) {
					this.subViews.unshift(
						new MenuItem({
							model: new Backbone.Model(itemOptions),
							depth: this.depth + 1,
							menuId: this.options.menuId
						})
					);
				}, this);
			}
		},

		render: function() {
			var me = this;
			this.$el.html(_.template(tpl, {
				title: this.model.get('menu-item-title'),
				type:  this.getLinkTypeLabel(Upfront.Util.guessLinkType(this.model.get('menu-item-url')))
			}));
			this.$el.data('menu-item-object-id', this.model.get('menu-item-object-id'));
			this.$el.data('menu-item-depth', this.depth);
			this.$el.addClass('menu-structure-item-depth-' + this.depth);

			var editor = new MenuItemEditor({
				model: this.model,
				menuId: this.options.menuId
			});
			this.$el.append(editor.render().el);
			this.listenTo(editor, 'change', function() {
				me.trigger('change', me.model.toJSON());
			});

			// Gotta let this.$el render to use $.after()
			setTimeout(function() {
				_.each(me.subViews, function(view) {
					me.$el.after(view.render().el);
				});
			}, 100);

			this.delegateEvents();

			return this;
		},

		toggleEditor: function() {
			this.$el.toggleClass('menu-item-expanded');
			this.$el.find('.menu-item-editor').toggle();
		},

		/**
		 * Determine proper link type select value/label based on link type. Used
		 * to populate link type select field.
		 */
		getLinkTypeLabel: function(type) {
			var contentL10n = Upfront.Settings.l10n.global.content;
			switch(type) {
				case 'unlink':
					return contentL10n.no_link ;
				case 'external':
					return contentL10n.url;
				case 'email':
					return contentL10n.email_address;
				case 'entry':
					return contentL10n.post_or_page;
				case 'anchor':
					return contentL10n.anchor;
				case 'image':
					return contentL10n.larger_image;
				case 'lightbox':
					return contentL10n.lightbox;
			}
		},
		
		deleteItem: function(e) {
			e.preventDefault();
			e.stopPropagation();

			if(typeof this.model.get('menu-item-db-id') != 'undefined') {
				Upfront.Util.post({"action": "upfront_new_delete_menu_item", "menu_item_id": this.model.get('menu-item-db-id')})
					.success(function (ret) {
						//Make sure deleted element is removed from the list
						Upfront.Events.trigger("menu_element:edit");
					})
					.error(function (ret) {
						Upfront.Util.log("Error Deleting Menu Item");
					})
				;
			}
		},
	});

	return MenuItem;
});


define('text!scripts/upfront/settings/modules/menu-structure/menu-structure.tpl',[],function () { return '<div class="menu-structure-header">\r\n\t<span class="upfront-settings-item-title">MENU STRUCTURE</span>\r\n\t<span class="add-menu-item">Add item</span>\r\n</div>\r\n<div class="menu-structure-body"></div>\r\n';});

(function ($) {
define('scripts/upfront/settings/modules/menu-structure',[
	'elements/upfront-newnavigation/js/menu-util',
	'scripts/upfront/settings/modules/menu-structure/menu-item',
	'text!scripts/upfront/settings/modules/menu-structure/menu-structure.tpl'
], function(MenuUtil, MenuStructureItem, tpl) {
	var l10n = Upfront.Settings.l10n.preset_manager;
	var scrollDown = false;
	var MenuStructureModule = Backbone.View.extend({
		className: 'settings_module menu_structure_module clearfix',
		handlesSaving: true,

		events: {
			'mouseenter .menu-item-header': 'enableSorting',
			'mouseleave .menu-item-header': 'disableSortingOnHeaderLeave',
			'click .add-menu-item': 'addItem',
		},

		initialize: function(options) {
			var me = this;
			this.options = options || {};

			this.listenTo(this.model.get('properties'), 'change', function() {
				me.reloadItems();
			});

			Upfront.Events.on('menu_element:edit', function(menuData) {
				me.reloadItems();
			});

			this.setup();
		},
		
		reloadItems: function() {
			this.setup();
			this.render();
		},

		setup: function() {
			this.menuId = this.model.get_property_value_by_name('menu_id');
			this.menuItems = [];
			this.menuItemViews = [];
			this.menu = MenuUtil.getMenuById(this.menuId);

			if (this.menuId === false) return;

			this._load_items();
		},

		/**
		 * Check if we have a promise queued in
		 *
		 * @param {Object} args_obj The raw key used for promise - will be stringified before checking
		 *
		 * @return {Boolean}
		 */
		_has_promise: function (args_obj) {
			var key = JSON.stringify(args_obj);
			return !!(this._promises || {})[key];
		},

		/**
		 * Queue up a promise
		 *
		 * @param {Object} args_obj The raw key used for promise - will be stringified before checking
		 * @param {$.Deferred} promise Promise to queue up
		 */
		_add_promise: function (args_obj, promise) {
			var key = JSON.stringify(args_obj);
			this._promises = this._promises || {};
			this._promises[key] = promise;
			return true;
		},

		/**
		 * Drops a promise from the queue
		 *
		 * @param {Object} args_obj The raw key used for promise - will be stringified before checking
		 */
		_drop_promise: function (args_obj) {
			var key = JSON.stringify(args_obj);
			this._promises = this._promises || {};
			this._promises[key] = false;
			return true;
		},

		/**
		 * Loads the menu items.
		 *
		 * Also hooks up to promise response and sets up `this.menuItemViews` collection.
		 */
		_load_items: function () {
			var me = this,
				args = {
					action: "upfront_new_load_menu_array",
					"data": this.menuId + ''
				},
				promise
			;
			if (this._has_promise(args)) return true; // We're already waiting for this

			promise = Upfront.Util.post(_.extend({}, args));
			this._add_promise(args, promise); // So, stack up this promise

			promise
				.success(function (response) {
					me.menuItems = response.data || [];
					_.each(me.menuItems, function(itemOptions, index) {
						var menuStructureItem = new MenuStructureItem({
							model: new Backbone.Model(itemOptions),
							menuId: me.menuId
						});
						me.menuItemViews.push(menuStructureItem);
						me.listenTo(menuStructureItem, 'change', function(data) {
							me.menuItems[index] = data;
							me.model.trigger('change');
						});
					});
					me.model.set_property('menu_items', response.data, true);
					me.model.trigger('change'); // do not trigger change on this.model.get('properties') it will cause endless recursion
																			// this is needed for menu element to re-render on item position change
					me.render();
					me._drop_promise(args); // And pop it off the stack once we're done
				})
				.error(function (response) {
					Upfront.Util.log("Error loading menu items");
				})
			;
			return true;
		},

		render: function() {
			var me = this,
				$body;

			this.$el.html(tpl);

			if (this.menuId === false) return;

			$body = this.$el.find('.menu-structure-body');

			_.each(this.menuItemViews, function(view) {
				$body.append(view.render().el);
			});
			
			/**
			 * This will scroll the panel down to the position of the newly added menu item i.e., 
			 * at the bottom of the list
			 */
			 
			if(scrollDown) {

				// Scroll down to where the new menu item has been added.
				var menu_items_panel = me.$el.closest('.uf-settings-panel--expanded');
				var scroll_wrap = menu_items_panel.closest('#sidebar-scroll-wrapper');
				scroll_wrap.scrollTop(menu_items_panel.height()-175);
				scrollDown = false;

			}
		},

		enableSorting: function(event) {
			if (this.sortingInProggres === true) return;
			// highlight all sortables
			var $items = this.$el.find('.menu-structure-module-item'),
				hoveredItem = $(event.target).parent(),
				addedChildren = false,
				me = this,
				hoveredItemDepth;

			// First add sortable class to all items
			$items.addClass('menu-structure-sortable-item');

			// Leave only items that are not children of current item sortable
			// Than make a group that is wrapped with sortable from hovered item
			// and its children.
			$items.each(function() {
				if (addedChildren) {
					return;
				}
				if (!_.isUndefined(hoveredItemDepth) && $(this).data('menuItemDepth') <= hoveredItemDepth) {
					addedChildren = true;
					return;
				}

				if (!_.isUndefined(hoveredItemDepth) && $(this).data('menuItemDepth') > hoveredItemDepth) {
					$(this).addClass('hovered-item-group-member');
					$(this).removeClass('menu-structure-sortable-item');
					return;
				}

				if (_.isUndefined(hoveredItemDepth) && $(this).is(hoveredItem)) {
					hoveredItemDepth = $(this).data('menuItemDepth');
					$(this).addClass('hovered-item-group-member');
					$(this).removeClass('menu-structure-sortable-item');
				}
			});
			this.$el.find('.hovered-item-group-member').wrapAll('<div class="menu-structure-sortable-item"></div>');

			this.$el.sortable({
				axis: "y",
				items: '.menu-structure-sortable-item',
				start: function(event, ui) {
					me.sortingInProggres = true;
					me.watchItemDepth(ui.item);
				},
				stop: function(event, ui) {
					me.stopWatchingItemDepth(ui.item);
					me.updateItemsPosition(ui.item);
					me.sortingInProggres = false;
				},
			});
		},

		// Disable on mouse header leave only if sorting is not in progress,
		// otherwise sortable with break.
		disableSortingOnHeaderLeave: function() {
			if (this.sortingInProggres === true) return;
			this.disableSorting();
		},

		disableSorting: function() {
			var $items = this.$el.find('.menu-structure-module-item'),
				$hoveredItems = this.$el.find('.hovered-item-group-member');

			$hoveredItems.unwrap();
			$hoveredItems.removeClass('hovered-item-group-member');
			$items.removeClass('menu-structure-sortable-item');
			this.$el.sortable('destroy');
		},

		watchItemDepth: function(movedItem) {
			var me = this,
				mouseX;

			this.$el.on('mousemove', function(event) {
				if (_.isUndefined(mouseX)) {
					mouseX = event.pageX;
					return;
				}

				// Increase tolerance for movement
				if (Math.abs(mouseX - event.pageX) < 15) return;

				me.updateSortableDepth(mouseX, event.pageX, movedItem);

				mouseX = event.pageX;
			});
		},

		updateSortableDepth: function(oldX, newX, item) {
			var itemDepth = item.hasClass('menu-structure-module-item') ?
					item.data('menuItemDepth') : item.children().first().data('menu-item-depth'),
				prevDepth = item.prev().data('menu-item-depth'),
				nextDepth = item.nextAll().not('.ui-sortable-placeholder').first().data('menu-item-depth');

			// Decrease item depth
			if (oldX > newX) {
				this.decreaseGroupDepth(itemDepth, prevDepth, nextDepth, item);
			}
			// Increase item depth
			if (oldX < newX) {
				this.increaseGroupDepth(itemDepth, prevDepth, nextDepth, item);
			}
		},

		decreaseGroupDepth: function(itemDepth, prevDepth, nextDepth, item) {
			var me = this;

			if (
				(prevDepth < itemDepth && nextDepth < itemDepth) ||
				(prevDepth === itemDepth && nextDepth < itemDepth) ||
				_.isUndefined(nextDepth) || // This is the last item in menu, allow any decrease
				nextDepth < itemDepth // This is the last submenu item, allow any decrease
			){
				if (item.hasClass('menu-structure-module-item')) {
					if (item.data('menuItemDepth') === 0) return; // Do not allow decrease below 0
					this.decreaseItemDepth(item);
					return;
				}

				if (item.children().first().data('menuItemDepth') === 0) return; // Do not allow decrease below 0
				item.children().each(function() {
					me.decreaseItemDepth($(this));
				});
			}
		},

		increaseGroupDepth: function(itemDepth, prevDepth, nextDepth, item) {
			var me = this;

			if (
				(prevDepth >= itemDepth) ||
				(prevDepth === itemDepth && nextDepth < itemDepth)
			){
				if (item.hasClass('menu-structure-module-item')) {
					this.increaseItemDepth(item);
					return;
				}
				item.children().each(function() {
					me.increaseItemDepth($(this));
				});
			}
		},

		decreaseItemDepth: function(item) {
			item.removeClass('menu-structure-item-depth-' + item.data('menuItemDepth'));
			item.data('menu-item-depth', item.data('menuItemDepth') - 1);
			item.addClass('menu-structure-item-depth-' + item.data('menuItemDepth'));
		},

		increaseItemDepth: function(item) {
			item.removeClass('menu-structure-item-depth-' + item.data('menuItemDepth'));
			item.data('menuItemDepth', item.data('menuItemDepth') + 1);
			item.addClass('menu-structure-item-depth-' + item.data('menuItemDepth'));
		},

		stopWatchingItemDepth: function() {
			this.$el.off('mousemove');
		},

		flattenItem: function(item) {
			var me = this,
				allItems = [item];

			if (item.sub) {
				_.each(item.sub, function(subItem) {
					allItems = _.union(allItems, me.flattenItem(subItem));
				});
			}

			return allItems;
		},

		updateItemsPosition: function() {
			var me = this;
			// Flatten items
			var oldItems = [];
			_.each(this.menuItems, function(item) {
				oldItems = _.union(oldItems, me.flattenItem(item));
			});

			// Get all items
			var $items = this.$el.find('.menu-structure-module-item');
			var changedItems = [];
			// Start from top and keep track of parent item.
			// It needs to be an array because multiple levels of depth
			var parentItem = [0];
			var prevItemId = 0;
			var position = 1;
			var currentDepth = 0;
			var depthChange;
			var i;
			$items.each(function() {
				var itemData = _.findWhere(
					oldItems, {'menu-item-object-id': $(this).data('menuItemObjectId')}
				);
				var itemDepth = $(this).data('menuItemDepth');

				// If depth increased change parent to previous item id
				if (itemDepth > currentDepth) {
					parentItem.push(prevItemId);
					currentDepth = currentDepth + 1;
				} else if (itemDepth === currentDepth) {
					// do nothing
				} else if (itemDepth < currentDepth) {
					// Drop levels if depth decreased
					depthChange = currentDepth - itemDepth;
					for (i = 0; i < depthChange; i++) {
						parentItem = _.initial(parentItem);
					}
					currentDepth = itemDepth;
				}

				changedItems.push(_.extend(itemData, {
					'menu-item-parent-id': _.last(parentItem) || 0,
					'menu-item-position': position
				}));

				// Must be done in the end
				position = position + 1;
				prevItemId = itemData['menu-item-object-id'];
			});

			Upfront.Util.post({
				action: 'upfront_update_menu_items',
				data: {
					items: changedItems,
					menuId: this.menuId
				}
				}
			).done(
				function() {
					me.setup();
				}
			).fail(
				function(response) {
					Upfront.Util.log('Failed saving menu items.');
				}
			);
		},

		addItem: function() {
			var me = this,
				newItem = {
					'menu-item-object': 'custom',
					'menu-item-parent-id': 0,
					//'menu-item-position': -1,
					'menu-item-target': '',
					'menu-item-title': 'New Item',
					'menu-item-type': 'custom',
					'menu-item-url': ''
				};

			Upfront.Util.post({
				action: 'upfront_update_single_menu_item',
				menuId: this.menuId,
				menuItemData: newItem
			}).done(

					function(response) {
						
						newItem['menu-item-db-id'] = response.data.itemId;
						newItem['menu-item-object-id'] = response.data.itemId + '';

						// Gotta do this to save item now with id to make it published
						Upfront.Util.post({
							action: 'upfront_update_single_menu_item',
							menuId: me.menuId,
							menuItemData: newItem
						}).done(function() {
							me.model.get_property_value_by_name('menu_items').unshift(newItem);
							me.model.get('properties').trigger('change');

							/**
							 * This will flag the settings panel to scroll down 
							 * to the position of the newly added menu item i.e., 
							 * at the bottom of the list
							 */
							scrollDown = true;
						});

					}
				).fail(
					function(response) {
						Upfront.Util.log('Failed saving menu items.');
					}
				);

		},

		save_fields: function() {
		}
	});

	return MenuStructureModule;
});
})(jQuery);

define('elements/upfront-newnavigation/js/settings/menu-style',[],function() {
	var l10n = Upfront.Settings.l10n.newnavigation_element;

	var MenuStyle = Upfront.Views.Editor.Settings.Item.extend({
		className: 'settings_module menustyle_settings_item clearfix',
		group: true,
		get_title: function() {
			return this.options.title;
		},
		initialize: function(options) {

			this.options = options || {};

			var me = this,
				state = this.options.state;

			this.fields = _([
				new Upfront.Views.Editor.Field.Select({
					model: this.model,
					className: state + '-select select-module menu_style',
					name: 'menu_style',
					default_value: this.model.get('menu_style'),
					label: l10n.mnu.style,
					values: [
						{ label: l10n.mnu.horiz, value: 'horizontal' },
						{ label: l10n.mnu.vert, value: 'vertical' },
						{ label: l10n.mnu.triggered, value: 'burger' }
					],
					change: function(value) {
						me.model.set('menu_style', value);
						if (value !== 'burger') {
							me.fields._wrapped[3].$el.hide();
							me.fields._wrapped[3].set_value('over');
						} else if (me.model.get('burger_alignment') === 'top') {
							me.fields._wrapped[3].$el.show();
						}
					},
					show: function(value, $el) {
						if(value === "burger") {
							$el.parent().find('.burger_alignment').show();
						} else {
							$el.parent().find('.burger_alignment').hide();
						}
					}
				}),
				new Upfront.Views.Editor.Field.Select({
					model: this.model,
					className: state + '-select select-module menu_alignment',
					name: 'menu_alignment',
					default_value: this.model.get('menu_alignment'),
					label: l10n.mnu.alignment,
					values: [
						{ label: l10n.mnu.left, value: 'left' },
						{ label: l10n.mnu.center, value: 'center' },
						{ label: l10n.mnu.right, value: 'right' },
					],
					change: function(value) {
						me.model.set('menu_alignment', value);
					}
				}),
				new Upfront.Views.Editor.Field.Select({
					model: this.model,
					className: state + '-select select-module burger_alignment',
					name: 'burger_alignment',
					default_value: this.model.get('burger_alignment'),
					label: l10n.mnu.show_on_click,
					values: [
						{ label: l10n.mnu.left, value: 'left', icon: 'burger-left'},
						{ label: l10n.mnu.right, value: 'right', icon: 'burger-right'},
						{ label: l10n.mnu.top, value: 'top', icon: 'burger-top'},
						{ label: l10n.mnu.whole, value: 'whole', icon: 'burger-whole'}
					],
					change: function(value) {
						me.model.set('burger_alignment', value);
						if(value === 'left' || value === 'right' || value === 'whole') {
							me.fields._wrapped[3].$el.hide();
							me.fields._wrapped[3].set_value('over');
						}
						else {
							me.fields._wrapped[3].$el.show();
						}
					}
				}),
				new Upfront.Views.Editor.Field.Radios({
					model: this.model,
					default_value: this.model.get('burger_over'),
					name: 'burger_over',
					label: "",
					layout: "vertical",
					values: [
						{ label: l10n.mnu.over, value: 'over' },
						{ label: l10n.mnu.push, value: 'pushes' }
					],
					change: function(value) {
						me.model.set('burger_over', value);
					}
				})
			]);
			this.listenTo(this, 'rendered', function() {
				var alignment = me.model.get('burger_alignment');
				if(alignment === 'left' || alignment === 'right' || alignment === 'whole') {
					me.fields._wrapped[3].$el.hide();
					me.fields._wrapped[3].set_value('over');
				}
				else {
					me.fields._wrapped[3].$el.show();
				}
				var style = me.model.get('menu_style');
				if (style !== 'burger') {
					me.fields._wrapped[3].$el.hide();
					me.fields._wrapped[3].set_value('over');
				}
			});
		},
	});

	return MenuStyle;
});

define('scripts/upfront/settings/module-factory',[
	'scripts/upfront/settings/modules/typography',
	'scripts/upfront/settings/modules/border',
	'scripts/upfront/settings/modules/hov-animation',
	'scripts/upfront/settings/modules/radius',
	'scripts/upfront/settings/modules/selectbox',
	'scripts/upfront/settings/modules/caption-location',
	'scripts/upfront/settings/modules/gallery-caption-location',
	'scripts/upfront/settings/modules/colors',
	'scripts/upfront/settings/modules/element-style',
	'scripts/upfront/settings/modules/padding',
	'scripts/upfront/settings/modules/anchor',
	'scripts/upfront/settings/modules/menu-structure',
	'elements/upfront-newnavigation/js/settings/menu-style',
], function(TypographySettingsModule, BorderSettingsModule, HovAnimationSettingsModule, RadiusSettingsModule,
			SelectboxSettingsModule, CaptionLocationSettingsModule, GalleryCaptionLocationSettingsModule,
			ColorsSettingsModule, ElementStyleModule, PaddingSettingsModule, AnchorSettingsModule, MenuStructureModule, MenuStyleModule) {
	var ModuleFactory = function() {
		var classes = {
			'Typography': TypographySettingsModule,
			'Border': BorderSettingsModule,
			'HovAnimation': HovAnimationSettingsModule,
			'Radius': RadiusSettingsModule,
			'Selectbox': SelectboxSettingsModule,
			'CaptionLocation': CaptionLocationSettingsModule,
			'GalleryCaptionLocation': GalleryCaptionLocationSettingsModule,
			'Colors': ColorsSettingsModule,
			'ElementStyle': ElementStyleModule,
			'Padding': PaddingSettingsModule,
			'Anchor': AnchorSettingsModule,
			'MenuStructure': MenuStructureModule,
			'MenuStyle': MenuStyleModule
		};

		this.createModule = function(module, options, model) {
			var initializationOptions = _.extend({}, options, { model: model });
			if (typeof module === 'string') {
				return new classes[module](initializationOptions);
			}

			return new module(initializationOptions);
		};
	};

	moduleFactory = new ModuleFactory();

	return moduleFactory;
});

(function ($) {
define('scripts/upfront/element-settings/root-settings-panel',[
	'scripts/upfront/element-settings/settings-container',
	'scripts/upfront/element-settings/root-panel-mixin',
	'scripts/upfront/settings/field-factory',
	'scripts/upfront/settings/module-factory'
], function (SettingsContainer, RootPanelMixin, FieldFactory, ModuleFactory) {
	var l10n = Upfront.Settings && Upfront.Settings.l10n
		? Upfront.Settings.l10n.global.views
		: Upfront.mainData.l10n.global.views
	;

	var RootSettingsPanel = SettingsContainer.extend(_.extend({}, RootPanelMixin, {
		initialize: function (options) {
			var me = this,
				settings = [];

			this.options = options;
			this.settings = _(this.settings);

			this.settings.each(function(settingOptions){
				var setting;
				if (settingOptions.type === 'SettingsItem') {
					setting = new Upfront.Views.Editor.Settings.Item({
						title: settingOptions.title,
						model: me.model,
						className: settingOptions.className,
						fields: []
					});
				} else {
					setting = ModuleFactory.createModule(
						settingOptions.type, settingOptions || {}, me.model
					);
				}

				if(settingOptions.identifier) {
					// Use for selecting settings instead crawling DOM
					setting.identifier = settingOptions.identifier;
				}

				_.each(settingOptions.fields, function(fieldOptions) {
					var field;

					// Proxy the 'change' callback, and revert when finished
					if ("change" in fieldOptions) {
						if (!fieldOptions.preservedChangeCallback) {
							// Store the callback
							fieldOptions.preservedChangeCallback = fieldOptions.change;
						}

						// Proxy the stored callback to provide context
						fieldOptions.change = function (value) {
							fieldOptions.preservedChangeCallback(value, me);
						};

						// Reset change callback to avoid zombies
						Upfront.Events.once('entity:settings:deactivate', function() {
							fieldOptions.change = fieldOptions.preservedChangeCallback;
						});
					}
					if ("show" in fieldOptions) {
						if (!fieldOptions.preservedShowCallback) {
							// Store the callback
							fieldOptions.preservedShowCallback = fieldOptions.show;
						}

						// Proxy the stored callback to provide context
						fieldOptions.show = function (value) {
							fieldOptions.preservedShowCallback(value, me);
						};

						// Reset show callback to avoid zombies
						Upfront.Events.once('entity:settings:deactivate', function() {
							fieldOptions.show = fieldOptions.preservedShowCallback;
						});
					}

					field = FieldFactory.createField(fieldOptions.type, _.extend({ model: me.model }, _.omit(fieldOptions, ['type'])));

					if (settingOptions.triggerChange) {
						me.listenTo(field, 'change changed', function() {
							me.save_settings();
							me.model.trigger('change');
						});
					}

					if(fieldOptions.identifier) {
						// Use for selecting field instead crawling DOM
						field.identifier = fieldOptions.identifier;
					}

					setting.fields.push(field);
				});
				setting.panel = me;
				setting.trigger('panel:set');

				settings.push(setting);
			});

			this.settings = _(settings);
		},

		getBody: function () {
			var $body = $('<div />'),
				me = this;

			this.settings.each(function (setting) {
				if ( ! setting.panel ) setting.panel = me;
				setting.render();
				$body.append(setting.el);
			});

			return $body;
		}
	}));

	return RootSettingsPanel;
});
})(jQuery);

define('scripts/upfront/settings/fields/select-preset',[],function() {
	var l10n = Upfront.Settings.l10n.preset_manager;

	var SelectPresetField = Upfront.Views.Editor.Field.Chosen_Select.extend({
		className: 'preset select-preset-field',
		render: function() {
			Upfront.Views.Editor.Field.Chosen_Select.prototype.render.call(this);
			var me = this;
			var selectWidth = '';
			var preset = this.$el.find('.upfront-chosen-select').val();

			if(preset == 'default' && Upfront.Application.get_current() === Upfront.Application.MODE.THEME) {
				selectWidth = '230px';
			} else {
				selectWidth = '175px';
			}

			this.$el.find('.upfront-chosen-select').chosen({
				search_contains: true,
				width: selectWidth
			});

			var html = ['<a href="#" title="'+ l10n.add_preset_label +'" class="upfront-preset-add">'+ l10n.add_label +'</a>'];
			this.$el.find('.chosen-search').append(html.join(''));

			this.$el.on('click', '.upfront-preset-add', function(event) {
				event.preventDefault();

				var preset_name = me.$el.find('.chosen-search input').val();

				if (preset_name.trim() === '') {
					alert(l10n.not_empty_label);
					return;
				}
				if (preset_name.match(/[^A-Za-z0-9 ]/)) {
					alert(l10n.special_character_label);
					return;
				}

				me.trigger('upfront:presets:new', preset_name.trim());
			});

			return this;
		},

		get_value_html: function (value, index) {
			var selected = '';
			var currentPreset = this.get_saved_value() ? this.get_saved_value() : 'default';
			if (value.value === this.clear_preset_name(currentPreset)) selected = ' selected="selected"';
			return ['<option value="', value.value, '"', selected, '>', value.label, '</option>'].join('');
		},

		clear_preset_name: function(preset) {
			preset = preset.replace(' ', '-');
			preset = preset.replace(/[^-a-zA-Z0-9]/, '');
			return preset;
		},
	});

	return SelectPresetField;
});

define('scripts/upfront/settings/modules/select-preset',[
	'scripts/upfront/settings/modules/base-module',
	'scripts/upfront/settings/fields/select-preset'
], function(BaseModule, SelectPresetField) {
	var l10n = Upfront.Settings.l10n.preset_manager;

	var SelectPresetModule = BaseModule.extend({
		className: 'select-presets',
		initialize: function (options) {
			this.options = options || {};
			this.group = false;
			var me = this;

			this.selectPresetField = new SelectPresetField({
					model: this.model,
					label: l10n.select_preset_label,
					property: 'preset',
					values: this.get_presets(),
					change: function(value) {
						me.model.set_property('preset', this.get_value());
					}
				});

			this.fields = _([
				this.selectPresetField
			]);

			this.listenTo(this.selectPresetField, 'upfront:presets:new', this.createPreset);
			this.listenTo(this.selectPresetField, 'changed', this.changePreset);
		},

		changePreset: function() {
			this.trigger('upfront:presets:change', this.selectPresetField.get_value());
		},

		createPreset: function(preset) {
			this.trigger('upfront:presets:new', preset);
		},

		get_title: function() {
			return l10n.select_preset;
		},

		get_presets: function () {
			return _.map(this.options.presets.models, function(model) {
				if('undefined' === typeof model.get('name')) {
				  return { label: model.get('id'), value: model.get('id') };
				} else {
				  return { label: model.get('name'), value: model.get('id') };
				}
			});
		}
	});

	return SelectPresetModule;
});

define('scripts/upfront/settings/fields/show-state',[],function() {
	var ShowStateSettingsButton = Upfront.Views.Editor.Field.Button.extend({
		className: 'state_settings_button',

		initialize: function(options) {
			this.options = options || {};
			this.label = this.options.state;
			this.options.compact = true;
			this.$el.addClass('state_settings_button_' + this.options.state.toLowerCase());
		},

		on_click: function() {
			this.trigger('upfront:presets:state_show', this.options.state.toLowerCase());
		}
	});

	return ShowStateSettingsButton;
});

define('scripts/upfront/settings/modules-container',[
	'scripts/upfront/settings/module-factory'
],function(ModuleFactory) {
	var ModulesContainer = Backbone.View.extend({
		initialize: function(options) {
			this.options = options || {};

			var modules = [],
				me = this,
				modulesConfig = this.options.modules;

			// Try to get from child class if there is none in options
			if (_.isUndefined(modulesConfig)) modulesConfig = this.modules;

			if (typeof this.getAdditionalModules === 'function') {
				modulesConfig = this.getAdditionalModules(_.clone(modulesConfig));
			}

			// Create modules
			_.each(modulesConfig, function (moduleConfig) {
				moduleConfig.options = moduleConfig.options || {};

				// Proxy the 'change' callback, and revert when finished
				if (("change" in moduleConfig.options)) {
					if (!moduleConfig.options.preservedChangeCallback) {
						// Store the callback
						moduleConfig.options.preservedChangeCallback = moduleConfig.options.change;
					}

					// Proxy the stored callback to provide context
					moduleConfig.options.change = function (value) {
						moduleConfig.options.preservedChangeCallback(value, me);
					};

					// Reset change callback to avoid zombies
					Upfront.Events.once('entity:settings:deactivate', function() {
						moduleConfig.options.change = moduleConfig.options.preservedChangeCallback;
					});
				}

				var module = ModuleFactory.createModule(
					moduleConfig.moduleType, moduleConfig.options || {}, this.options.model
				);

				module.panel = this;
				modules.push(module);
			}, this);

			this.modules = _(modules);

			if (this.onInitialize) this.onInitialize(options);
		},

		render: function () {
			this.$el.html('');
			this.$el.append('<div class="upfront-settings-item-content"></div>');

			var $content = this.$el.find('.upfront-settings-item-content');
			this.modules.each(function(module){
				module.render();
				module.delegateEvents();
				$content.append(module.el);
			});
		},

		save_settings: function () {
			if (!this.modules) return;

			var me = this;
			this.modules.each(function (module) {
				if ( module.fields.size() > 0 ) {
					module.save_fields();
				}
			});
		}
	});

	return ModulesContainer;
});

define('scripts/upfront/preset-settings/state-settings',[
	'scripts/upfront/settings/modules-container'
], function(ModulesContainer) {

	var StateSettings = ModulesContainer.extend({
		onInitialize: function(options) {
			if(this.options.state !== "Global") {
				this.$el.addClass('state_modules state_settings state_settings_' + this.options.state.toLowerCase());
			} else {
				this.$el.addClass('state_modules global_modules');
			}
		}
	});

	return StateSettings;
});

define('scripts/upfront/settings/modules/edit-preset',[
	'scripts/upfront/settings/modules/base-module',
	'scripts/upfront/settings/fields/show-state',
	'scripts/upfront/preset-settings/state-settings'
], function(BaseModule, ShowStateSettingsButton, StateSettings) {
	var l10n = Upfront.Settings.l10n.preset_manager;

	var EditPresetModule = BaseModule.extend({
		className: 'preset_specific',

		initialize: function(options) {
			this.options = options || {};

			this.listenTo(this.model, 'change', this.onPresetUpdate);

			var me = this,
				firstStateButton = false,
				firstStateSettings = false;

			if((Upfront.Application.get_current() === Upfront.Application.MODE.THEME || this.options.model.get('theme_preset') !== true)
					&& this.options.model.get('id') !== 'default') {
				var fields = [
					new Upfront.Views.Editor.Field.Button({
						model: this.model,
						label: l10n.delete_label,
						className: 'delete_preset',
						compact: true,
						on_click: function() {
							if (confirm('Are you sure to delete this preset?')) {
								me.deletePreset();
							}
						}
					})
				];
			} else if(Upfront.Application.get_current() !== Upfront.Application.MODE.THEME
						&& (this.options.model.get('id') === 'default' || this.options.model.get('theme_preset') === true)) {
				var fields = [
					new Upfront.Views.Editor.Field.Button({
						model: this.model,
						label: 'Reset',
						className: 'delete_preset',
						compact: true,
						on_click: function() {
							me.resetPreset();
						}
					})
				];
			} else {
				var fields = [];
			}

			// First add global settings
			_.each(this.options.stateModules, function(stateModules, state) {
				if(state === "Global") {
					var stateSettings = new StateSettings({
						model: this.model,
						modules: stateModules,
						state: state
					});
					fields.push(stateSettings);
				}
			}, this);

			// Than add settings state tabs
			_.each(this.options.stateModules, function(stateModules, state) {
				if(state !== "Global") {
					var showStateButton = new ShowStateSettingsButton({
						state: state
					});
					fields.push(showStateButton);
					this.listenTo(showStateButton, 'upfront:presets:state_show', this.showState);

					if (!firstStateButton) {
						firstStateButton = showStateButton;
					}
				}
			}, this);

			// Than add non-global settings state panels
			_.each(this.options.stateModules, function(stateModules, state) {
				if(state !== "Global") {
					var stateSettings = new StateSettings({
						model: this.model,
						modules: stateModules,
						state: state
					});
					fields.push(stateSettings);
					if (!firstStateSettings) {
						firstStateSettings = stateSettings;
					} else {
						stateSettings.$el.hide();
					}
				}
			}, this);

			//Wrap tab buttons
			setTimeout(function(){
				me.$el.find('.state_settings_button').wrapAll('<div class="state_settings_button_wrapper">');

				var wrapper = me.$el.find('.state_settings_button_wrapper');
				if(wrapper.prev().hasClass('delete_preset')) {
					wrapper.addClass('move-wrapper-top');
				}
			}, 50);

			if (firstStateButton) firstStateButton.$el.addClass('active');
			if (firstStateSettings) firstStateSettings.$el.show();

			this.fields =_(fields);
		},

		onPresetUpdate: function() {
			this.trigger('upfront:presets:update', this.model.toJSON());
		},

		deletePreset: function() {
			this.trigger('upfront:presets:delete', this.model);
		},

		resetPreset: function() {
			this.trigger('upfront:presets:reset', this.model);
		},

		showState: function(state) {
			this.$el.find('.state_settings_button').removeClass('active');
			this.$el.find('.state_settings_button_' + state).addClass('active');
			this.$el.find('.state_settings').hide();
			this.$el.find('.state_settings_' + state).show();
			this.trigger('upfront:presets:state_show', state);
		}
	});

	return EditPresetModule;
});

define('scripts/upfront/settings/modules/migrate-preset',[
	'scripts/upfront/settings/modules/base-module',
], function(BaseModule) {
	var l10n = Upfront.Settings.l10n.preset_manager;

	var MigratePresetModule = BaseModule.extend({
		className: 'migrate-preset-overlay',

		initialize: function(options) {
			this.options = options || {};
			
			var me = this;
			
			var SimpleTextField = Upfront.Views.Editor.Field.Text.extend({
				get_field_html: function () {
					return '';
				}
			});
			
			var SelectPresetField = Upfront.Views.Editor.Field.Chosen_Select.extend({
				className: 'preset select-preset-field-overlay',
				render: function() {
					Upfront.Views.Editor.Field.Chosen_Select.prototype.render.call(this);
					var me = this;
					var preset = this.$el.find('.upfront-chosen-select').val();

					this.$el.find('.upfront-chosen-select').chosen({
						search_contains: true,
						width: '171px'
					});

					return this;
				},

				get_value_html: function (value, index) {
					var selected = '';
					var currentPreset = this.get_saved_value() ? this.get_saved_value() : 'default';
					if (value.value === this.clear_preset_name(currentPreset)) selected = ' selected="selected"';
					return ['<option value="', value.value, '"', selected, '>', value.label, '</option>'].join('');
				},

				clear_preset_name: function(preset) {
					preset = preset.replace(' ', '-');
					preset = preset.replace(/[^-a-zA-Z0-9]/, '');
					return preset;
				},
				
				on_change: function(e) {
					this.trigger('change', this.get_value());
				}
			});
			
			this.selectPresetField = new SelectPresetField({
					model: this.model,
					label: '',
					property: 'preset',
					values: this.get_presets(),
					change: function(value) {
						//me.model.set_property('preset', this.get_value());
					}
				}),
			
			this.listenTo(this.selectPresetField, 'change', this.previewPreset);

			var fields = [
				new Upfront.Views.Editor.Settings.Item({
				model: this.model,
				className: 'new-preset-module',
				fields: [
					new SimpleTextField({
						model: this.model,
						label: l10n.convert_preset_info,
						className: 'migrate-preset-info migrate-info-icon',
					}),
					
					new Upfront.Views.Editor.Field.Button({
						model: this.model,
						label: l10n.convert_style_to_preset,
						className: 'migrate-preset-button',
						compact: true,
						on_click: function() {
							me.show_new_preset_fields();
						}
					}),
					
					//New preset fields
					
					new Upfront.Views.Editor.Field.Button({
						model: this.model,
						label: l10n.cancel_label,
						className: 'new-preset-button-cancel',
						compact: true,
						on_click: function() {
							me.hide_new_preset_fields();
						}
					}),
					
					new Upfront.Views.Editor.Field.Text({
						model: this.model,
						label: '',
						default_value: me.suggestPresetName(this.options.elementPreset),
						className: 'new-preset-button-input',
					}),
					
					new Upfront.Views.Editor.Field.Button({
						model: this.model,
						label: l10n.ok_label,
						className: 'new-preset-button-submit',
						compact: true,
						on_click: function() {
							var preset_name = me.$el.find('.new-preset-button-input input').val();

							if (preset_name.trim() === '') {
								alert(l10n.not_empty_label);
								return;
							}
							if (preset_name.match(/[^A-Za-z0-9 ]/)) {
								alert(l10n.special_character_label);
								return;
							}

							me.trigger('upfront:presets:new', preset_name.trim());
						}
					}),
				]
				//End new preset fields
			}),
			new Upfront.Views.Editor.Settings.Item({
				model: this.model,
				className: 'existing-preset-module migrate-separator',
				fields: [
					new SimpleTextField({
						model: this.model,
						label: l10n.select_preset_info,
						className: 'migrate-preset-info',
					}),

					this.selectPresetField,
					
					new Upfront.Views.Editor.Field.Button({
						model: this.model,
						label: l10n.apply_label,
						className: 'migrate-preset-apply',
						compact: true,
						on_click: function() {
							me.trigger('upfront:presets:change', me.selectPresetField.get_value());
						}
					}),
				]
			})
			]
			
			setTimeout(function(){
				me.hide_new_preset_fields();
			}, 20);

			this.fields =_(fields);
		},
		
		suggestPresetName: function(presetName) {
			var preset = this.capitalisePreset(presetName.replace(/-preset/, '')),
				name = preset + l10n.preset;
			
			return name
		},
		
		capitalisePreset: function(preset) {
			return preset.charAt(0).toUpperCase() + preset.slice(1).toLowerCase();
		},
		
		hide_new_preset_fields() {
			var me = this;
			me.$el.find('.new-preset-button-cancel').hide();
			me.$el.find('.new-preset-button-input').hide();
			me.$el.find('.new-preset-button-submit').hide();
			me.$el.find('.migrate-preset-button').show();
			
			me.$el.find('.existing-preset-overlay-layout').remove();
		},
		
		show_new_preset_fields() {
			var me = this;
			me.$el.find('.new-preset-button-cancel').show();
			me.$el.find('.new-preset-button-input').show();
			me.$el.find('.new-preset-button-submit').show();
			me.$el.find('.migrate-preset-button').hide();
			
			me.$el.find('.existing-preset-module').append('<div class="existing-preset-overlay-layout">&nbsp;</div>');
		},
		
		previewPreset: function(value) {
			this.trigger('upfront:presets:preview', value);
		},
		
		get_presets: function () {
			return _.map(this.options.presets.models, function(model) {
				if('undefined' === typeof model.get('name')) {
				  return { label: model.get('id'), value: model.get('id') };
				} else {
				  return { label: model.get('name'), value: model.get('id') };
				}
			});
		}
	});

	return MigratePresetModule;
});

(function ($) {
define('scripts/upfront/preset-settings/preset-css-editor',[
	'text!upfront/templates/popup.html'
], function(popupTemplate) {
	var l10n = Upfront.Settings && Upfront.Settings.l10n
		? Upfront.Settings.l10n.global.views
		: Upfront.mainData.l10n.global.views
	;

	var PresetCSSEditor = Backbone.View.extend({
		className: 'upfront-ui',
		id: 'upfront-csseditor',
		tpl: _.template($(popupTemplate).find('#csseditor-tpl').html()),
		prepareAce: false,
		ace: false,
		events: {
			'click .upfront-css-save-ok': 'save',
			'click .upfront-css-close': 'close',
			'click .upfront-css-theme_image': 'openThemeImagePicker',
			'click .upfront-css-media_image': 'openImagePicker',
			'click .upfront-css-font': 'startInsertFontWidget',
			'click .upfront-css-selector': 'addSelector',
			'click .upfront-css-type' : 'scrollToElement',
			'mouseenter .upfront-css-selector': 'hiliteElement',
			'mouseleave .upfront-css-selector': 'unhiliteElement',
		},
		//elemenTypes' element id matches model's 'id_slug' attribute
		elementTypes: {
			UaccordionModel: {label: l10n.accordion, id: 'accordion'},
			UcommentModel: {label: l10n.comments, id: 'comment'},
			UcontactModel: {label: l10n.contact_form, id: 'contact'},
			UgalleryModel: {label: l10n.gallery, id: 'gallery', preset_container: 'inline'},
			UimageModel: {label: l10n.image, id: 'image'},
			LoginModel: {label: l10n.login, id: 'upfront-login_element'},
			LikeBox: {label: l10n.like_box, id: 'Like-box-object'},
			MapModel: {label: l10n.map, id: 'upfront-map_element'},
			UnewnavigationModel: {label: l10n.navigation, id: 'nav', preset_container: 'inline'},
			ButtonModel: {label: l10n.button, id: 'button', preset_container: 'inline'},
			//UpostsModel: {label: l10n.posts, id: 'uposts'},WW
			PostsModel: {label: l10n.posts, id: 'posts', preset_container: 'inline'},
			UsearchModel: {label: l10n.search, id: 'search'},
			USliderModel: {label: l10n.slider, id: 'slider'},
			SocialMediaModel: {label: l10n.social, id: 'SocialMedia'},
			UtabsModel: {label: l10n.tabs, id: 'tab', preset_container: 'inline'},
			ThisPageModel: {label: l10n.page, id: 'this_page'},
			ThisPostModel: {label: l10n.post, id: 'this_post'},
			UwidgetModel: {label: l10n.widget, id: 'widget'},
			UyoutubeModel: {label: l10n.youtube, id: 'youtube'},
			PlainTxtModel: {label: l10n.text, id:'text', preset_container: 'inline'},
		},
		initialize: function(options) {
			var me = this,
				deferred = $.Deferred(),
				style_selector;

			this.options = options || {};
			this.model = options.model;
			this.sidebar = ( options.sidebar !== false );
			this.global = ( options.global === true );

			this.prepareAce = deferred.promise();
			require(['//cdnjs.cloudflare.com/ajax/libs/ace/1.1.01/ace.js'], function(){
				deferred.resolve();
			});

			this.resizeHandler = this.resizeHandler || function(){
				me.$el.width($(window).width() - $('#sidebar-ui').width() -1);
			};

			//Destroy editor when Cancel or Save button is clicked
			Upfront.Events.on('element:settings:saved', this.close, this);
			Upfront.Events.on('element:settings:canceled', this.close, this);

			$(window).on('resize', this.resizeHandler);

			this.modelType = this.options.model.get_property_value_by_name('type');
			this.elementType = this.elementTypes[this.modelType] || {label: 'Unknown', id: 'unknown'};

			style_selector = this.options.preset.get('id');
			// DO NOT DO THIS!!! DELEGATE STYLE RENDERING TO PRESET (look at preset-css module
			// $style = $('#' + style_selector);
			// if ($style.length === 0) {
				// this.$style = $('<style id="' + style_selector + '"></style>');
				// $('body').append(this.$style);
			// } else {
				// this.$style = $style;
			// }

			this.createSelectors(Upfront.Application.LayoutEditor.Objects);

			this.selectors = this.elementSelectors[this.modelType] || {};

			this.element_id = options.element_id ? options.element_id : this.model.get_property_value_by_name('element_id');

			if ( typeof options.change == 'function' ) this.listenTo(this, 'change', options.change);

			if (this.options.doNotRender === true) return;

			this.render();
			this.startResizable();
		},
		close: function(event) {
			if(event)
				event.preventDefault();

			$(window).off('resize', this.resizeHandler);

			if(this.editor)
				this.editor.destroy();

			$('#page').css('padding-bottom', 0);
			this.remove();
		},
		render: function() {
			var me = this;

			$('#page').append(this.$el);

			if (!this.sidebar)
				this.$el.addClass('upfront-css-no-sidebar');
			else
				this.$el.removeClass('upfront-css-no-sidebar');

			this.$el.html(this.tpl({
				name: this.stylename,
				elementType: this.elementType.label,
				selectors: this.selectors,
				show_style_name: false,
				showToolbar: true
			}));

			this.resizeHandler('.');

			var bodyHeight = this.$el.height() - this.$('.upfront-css-top').outerHeight();
			this.$('.upfront-css-body').height(bodyHeight);

			this.prepareAce.done(function(){
				me.startAce();
			});

			this.prepareSpectrum();

			this.$el.show();
		},
		renderCss: function(rawCss) {
			var styles_with_selector;
			var preset_class = this.get_css_selector();
			styles_with_selector = this.stylesAddSelector($.trim(rawCss), '#page ' + preset_class);
			// Solve case of button loosing its styles
			styles_with_selector = Upfront.Util.colors.convert_string_ufc_to_color(styles_with_selector.replace(new RegExp(this.get_css_selector() + ' .upfront-button', 'g'), this.get_css_selector() + '.upfront-button'));

			return styles_with_selector;
		},
		cleanUpStyles: function(styles) {
			var scope = new RegExp(this.get_css_selector() + '\\s*', 'g');
			styles = styles.replace(new RegExp('#page ' + this.get_css_selector() + '\\s*', 'g'), '');
			styles = styles.replace(scope, '');
			// Unescape quotes a few times
			styles = styles.replace(/\\'/g, "'");
			styles = styles.replace(/\\'/g, "'");
			styles = styles.replace(/\\'/g, "'");
			styles = styles.replace(/\\"/g, '"');
			styles = styles.replace(/\\"/g, '"');
			styles = styles.replace(/\\"/g, '"');

			styles = styles.replace(/\.tablet-breakpoint/g, '');
			styles = styles.replace(/\.mobile-breakpoint/g, '');
			styles = styles.replace(/#page/g, '');

			styles = Upfront.Util.colors.convert_string_color_to_ufc(styles.replace(/div#page.upfront-layout-view .upfront-editable_entity.upfront-module/g, '#page'));

			return styles;
		},
		startAce: function() {
			var me = this,
				editor = ace.edit(this.$('.upfront-css-ace')[0]),
				session = editor.getSession()
			;

			session.setUseWorker(false);
			editor.setShowPrintMargin(false);

			session.setMode("ace/mode/css");
			editor.setTheme('ace/theme/monokai');

			editor.on('change', function(event){
				var styles_with_selector = me.renderCss(editor.getValue());
				// DO NOT DO THIS!!! DELEGATE STYLE RENDERING TO PRESET (look at preset-css module
				// me.$style.html(styles_with_selector);
				me.trigger('change', styles_with_selector);
			});


			var styles = this.options.preset.get('preset_style') ? this.options.preset.get('preset_style') : '';
			styles = this.cleanUpStyles(styles);
			editor.setValue($.trim(styles), -1);

			// Set up the proper vscroller width to go along with new change.
			editor.renderer.scrollBar.width = 5;
			editor.renderer.scroller.style.right = "5px";

			editor.focus();
			this.editor = editor;
		},
		prepareSpectrum: function(){
			var me = this,
				color_picker = new Upfront.Views.Editor.Field.Color({
					default_value: '#ffffff',
					showAlpha: true,
					showPalette: true,
					maxSelectionSize: 9,
					localStorageKey: "spectrum.recent_bgs",
					preferredFormat: "hex",
					chooseText: "Ok",
					showInput: true,
					allowEmpty:true,
					autohide: false,
					spectrum: {
						show: function(){
							//spectrum = $('.sp-container:visible');
						},
						choose: function(color) {
							var colorString = color.alpha < 1 ? color.toRgbString() : color.toHexString();
							me.editor.insert(colorString);
							me.editor.focus();
						}
					}
				})
			;
			color_picker.render();
			me.$('.upfront-css-color').html(color_picker.el);
		},
		createSelectors: function(objects){
			var me = this,
				selectors = {}
			;

			_.each(objects, function(object){
				selectors[object.cssSelectorsId] = object.cssSelectors || {};
			});
			me.elementSelectors = selectors;
		},

		createSelector: function(model_class, view_class, id) {
			var model = new model_class(),
				view = new view_class({model: model});
			this.elementSelectors[id] = view.cssSelectors || {};
			view.remove();
		},
		startResizable: function() {
			// Save the fetching inside the resize
			var me = this,
				$cssbody = me.$('.upfront-css-body'),
				topHeight = 0,
				$selectors = me.$('.upfront-css-selectors'),
				$saveform = me.$('.upfront-css-save-form'),
				$rsz = this.$('.upfront-css-resizable'),
				onResize = function(e, ui){
					var height = ui ? ui.size.height : me.$('.upfront-css-resizable').height(),
						bodyHeight = height  - topHeight;
					$cssbody.height(bodyHeight);
					if(me.editor)
						me.editor.resize();
					$selectors.height(bodyHeight - $saveform.outerHeight());
					// Clean unneeded CSS
					$rsz.css({
						width: "",
						height: "",
						left: "",
						top: ""
					});
					$('#page').css('padding-bottom', height);
				}
			;
			// Add appropriate handle classes
			$rsz.find(".upfront-css-top")
				.removeClass("ui-resizable-handle").addClass("ui-resizable-handle")
				.removeClass("ui-resizable-n").addClass("ui-resizable-n")
			;
			topHeight = me.$('.upfront-css-top').outerHeight();
			onResize();
			$rsz.resizable({
				handles: {n: '.upfront-css-top'},
				resize: onResize,
				minHeight: 200,
				delay: 100
			});
		},
		remove: function() {
			Backbone.View.prototype.remove.call(this);
			$(window).off('resize', this.resizeHandler);
		},
		openThemeImagePicker: function () {
			this._open_media_popup({themeImages: true});
		},

		openImagePicker: function(){
			this._open_media_popup();
		},

		/**
		 * Handles media popups.
		 * In this context, used for both theme and media images list.
		 *
		 * @param object opts Boot-time options to be passed to Upfront.Media.Manager
		 */
		_open_media_popup: function (opts) {
			opts = _.isObject(opts) ? opts : {};
			var me = this,
				options = _.extend({}, opts)
			;

			Upfront.Media.Manager.open(options).done(function(popup, result){
				Upfront.Events.trigger('upfront:element:edit:stop');
				if (!result) return;

				var imageModel = result.models[0],
					img = imageModel.get('image') ? imageModel.get('image') : result.models[0],
					url = 'src' in img ? img.src : ('get' in img ? img.get('original_url') : false)
				;

				me.editor.insert('url("' + url + '")');
				me.editor.focus();
			});
		},
		startInsertFontWidget: function() {
			var insertFontWidget = new Preset_Insert_Font_Widget({
				editor: this.editor,
				collection: Upfront.Views.Editor.Fonts.theme_fonts_collection
			});

			$('#insert-font-widget').html(insertFontWidget.render().el);
		},
		scrollToElement: function(){
			var $element = $('#' + this.element_id);
			if(!$element.length)
				return;

			var offset = $element.offset().top - 50;
			$(document).scrollTop(offset > 0 ? offset : 0);

			this.blink($element, 4);
		},
		hiliteElement: function(e){
			var preset_selector = this.get_css_selector();
			
			//Do not add empty space for posts element
			if(this.elementType.id !== "posts") {
				preset_selector = preset_selector + ' ';
			}

			var selector = preset_selector + $(e.target).data('selector');

			if(!selector.length)
				return;
			var element = $('#' + this.element_id + selector);

			element.addClass('upfront-css-hilite');
		},

		unhiliteElement: function(e){
			var preset_selector = this.get_css_selector();

			//Do not add empty space for posts element
			if(this.elementType.id !== "posts") {
				preset_selector = preset_selector + ' ';
			}
			
			var selector = preset_selector + $(e.target).data('selector');

			if(!selector.length)
				return;
			var element = $('#' + this.element_id + selector);
			element.removeClass('upfront-css-hilite');
		},
		addSelector: function(e) {
			var selector = $(e.target).data('selector');
			this.editor.insert(selector);
			this.editor.focus();
		},
		get_css_selector: function() {
			if (this.is_global_stylesheet) return '';

			var preset_class = '.' + this.options.preset.get('id');

			if(typeof this.elementType.preset_container === "undefined") {
				preset_class = preset_class + ' ';
			}

			return preset_class;
		},
		updateStyles: function(contents){
			var $el = this.get_style_element();
			Upfront.Util.Transient.push('css-' + this.element_id, $el.html());
			contents = Upfront.Util.colors.convert_string_ufc_to_color( contents);
			$el.html(
				this.stylesAddSelector(
					contents, (this.is_default_style ? '' : '#page ' + this.get_css_selector())
					).replace(/#page/g, 'div#page.upfront-layout-view .upfront-editable_entity.upfront-module')
			);
			this.trigger('updateStyles', this.element_id);
		},

		stylesAddSelector: function(contents, selector) {
			if (this.is_global_stylesheet && empty(selector)) return contents;
			var me = this,
				rules = contents.split('}'),
				processed = ''
			;
			_.each(rules, function (rl) {
				var src = $.trim(rl).split('{');
				if (src.length != 2) return true; // wtf
				var individual_selectors = src[0].split(','),
					processed_selectors = []
				;
				_.each(individual_selectors, function (sel) {
					sel = $.trim(sel);
					var clean_selector = sel.replace(/:[^\s]+/, ''); // Clean up states states such as :hover, so as to not mess up the matching
					var	is_container = clean_selector[0] === '@' || me.recursiveExistence(selector, clean_selector),
						spacer = is_container
							? '' // This is not a descentent selector - used for containers
							: ' ' // This is a descentent selector
					;

					processed_selectors.push('' +
						selector + spacer + sel +
					'');
				});
				processed += processed_selectors.join(', ') + ' {' +
					src[1] + // Actual rule
				'\n}\n';
			});
			return processed;
		/*
			var rules = contents.split('}'),
				separator = '\n\n' + selector + ' ';


			rules = _.map(rules, function(rule){return $.trim(rule);});

			rules.pop();

			return separator + rules.join('\n}' + separator) + '\n}';
		*/
		},
		recursiveExistence: function(selector, clean_selector) {
			var splitted = clean_selector.split(' ');
			var me = this;
			while(splitted.length > 0) {
				try{
					if(!!$(selector + splitted.join(' ')).closest('#' + me.element_id).length)
						return true;
				}
				catch (err) {

				}
				splitted.pop();
			}

			return false;
		},
		save: function(event) {
			if (event) event.preventDefault();
			var me = this,
				styles = $.trim(this.editor.getValue()),
				data;

			if (this.is_global_stylesheet === false && this.stylename === this.get_temp_stylename())
				return Upfront.Views.Editor.notify(l10n.style_name_nag, 'error');

			return Upfront.Views.Editor.notify(l10n.preset_style_saved.replace(/%s/,  this.elementType.id));
		},
	});

	var Preset_Insert_Font_Widget = Backbone.View.extend({
		initialize: function(options) {
			var me = this;

			this.editor = options.editor;

			this.fields = [
				new Upfront.Views.Editor.Field.Typeface_Chosen_Select({
					label: '',
					compact: true,
					values: Upfront.Views.Editor.Fonts.theme_fonts_collection.get_fonts_for_select(),
					additional_classes: 'choose-typeface',
					select_width: '230px'
				}),
				new Upfront.Views.Editor.Field.Typeface_Style_Chosen_Select({
					label: '',
					compact: true,
					values: [],
					additional_classes: 'choose-variant',
					select_width: '120px'
				}),
				new Upfront.Views.Editor.Field.Button({
					label: l10n.insert_font,
					compact: true,
					on_click: function(){
						me.finish();
					}
				})
			];
		},
		render: function() {
			$('#insert-font-widget').html('').addClass('open');
			this.$el.html('');
			_.each(this.fields, function(field) {
				field.render();
				this.$el.append(field.el);
			}, this);

			this.listenTo(this.fields[0], 'changed', function() {
				var variants = Upfront.Views.Editor.Fonts.theme_fonts_collection.get_variants(this.fields[0].get_value());
				this.render_variants(variants);
			});
			this.listenTo(this.fields[1], 'changed', function() {
				this.preview_font();
			});

			return this;
		},
		render_variants: function(variants) {
			var $variant_field = this.$el.find('.choose-variant select');
			$variant_field.find('option').remove();
			$variant_field.append('<option value="">' + l10n.choose_variant + '</option>');
			_.each(variants, function(variant) {
				$variant_field.append('<option value="' + variant + '">' + variant + '</option>');
			});
			$variant_field.trigger('chosen:updated');
		},
		preview_font: function() {
			this.replaceFont({
				font_family: this.fields[0].get_value(),
				variant: Upfront.Views.Font_Model.parse_variant(this.fields[1].get_value())
			});
		},
		replaceFont: function(font) {
			var lines;

			this.style_doc = this.editor.getSession().getDocument();

			this.last_selected_font = font;

			// Insert selected font family
			if (!this.font_family_range) {
				this.font_family_range = this.editor.getSelection().getRange();
			} else {
				this.font_family_range.end = this.end_point;
			}
			this.end_point = this.style_doc.replace(this.font_family_range, font.font_family);

			// Insert selected weight and style, first reset them
			this.reset_properties();
			lines = [];
			if (font.variant.weight) {
				lines.push('    font-weight: ' + font.variant.weight + ';');
			}
			if (font.variant.style) {
				lines.push('    font-style: ' + font.variant.style + ';');
			}
			if (lines.length > 0) {
				this.style_doc.insertLines(this.font_family_range.start.row + 1, lines);
			}
		},
		reset_properties: function() {
			var row, line, result;
			this.style_doc = this.editor.getSession().getDocument();
			// Search forward only from font family row since lower properties override upper
			result = {};
			row = this.font_family_range.start.row + 1;
			line = this.style_doc.getLine(row);
			while (line.indexOf('}') < 0) {
				if (line.indexOf('font-weight') !== -1) {
					result.weight = row;
					if (!this.starting_weight) this.starting_weight = line;
				}
				if (line.indexOf('font-style') !== -1) {
					result.style = row;
					if (!this.starting_style) this.starting_style = line;
				}

				row++;
				line = this.style_doc.getLine(row);
				if (!line) {
					// Fix missing closing paren
					//this.style_doc.insertLines(row, ['}']); // This adds a standalone new brace for some reason
					break;
				}
			}

			// Reset properties. This is complicated. If both font style and font weight properties are in current style rule
			// we need to remove them carefully because when we remove first, seconds' row number might change
			// so first remove one with higher row number.
			if (result.weight && result.style) {
				if (result.weight > result.style) {
					this.style_doc.removeLines(result.weight, result.weight);
					this.style_doc.removeLines(result.style, result.style);
				} else {
					this.style_doc.removeLines(result.style, result.style);
					this.style_doc.removeLines(result.weight, result.weight);
				}
				result.weight = false;
				result.style = false;
			}
			if (result.weight) {
				this.style_doc.removeLines(result.weight, result.weight);
			}
			if (result.style) {
				this.style_doc.removeLines(result.style, result.style);
			}
		},
		finish: function() {
			$('#insert-font-widget').html('<a class="upfront-css-font" href="#">' + l10n.insert_font + '</a>').removeClass('open');
		}
	});

	return PresetCSSEditor;
});
})(jQuery);

define('scripts/upfront/settings/modules/preset-css',[
	'scripts/upfront/settings/modules/base-module',
	'scripts/upfront/preset-settings/preset-css-editor'
], function(BaseModule, PresetCSSEditor) {
	var l10n = Upfront.Settings.l10n.preset_manager;

	var PresetCssModule = BaseModule.extend({
		className: 'upfront-settings-css',
		events: {
			'click input[name=preset_css]': 'openEditor'
		},
		initialize: function(options) {
			var me = this;

			BaseModule.prototype.initialize.call(this, options);

			this.fields = _([
				new Upfront.Views.Editor.Field.Button({
					model: me.model,
					className: 'edit_preset_label',
					compact: true,
					label: l10n.edit_preset_label,
				}),

				new Upfront.Views.Editor.Field.Button({
					model: me.model,
					className: 'edit_preset_css',
					compact: true,
					name: 'preset_css',
					label: l10n.edit_preset_css,
				})
			]);
		},

		onPresetUpdate: function(preset) {
			this.trigger('upfront:presets:update', preset);
		},

		updateCss: function(preset, newCss, me) {
			newCss.replace(/'/g, '"'); // Force double quotes, menu el. uses singlequotes to surround value of an attribute, if single quote slips in it will break the elelent
			preset.set({'preset_style': newCss});
		},

		openEditor: function(e){
			var me = this;
			e.preventDefault();

			Upfront.Events.trigger("entity:settings:beforedeactivate");

			var styleType = Upfront.Application.cssEditor.getElementType(this.model);
			var styleName = styleType.label.toLowerCase() + '-preset-' + this.options.preset.get('id');

			this.presetCSSEditor = new PresetCSSEditor({
				model: this.model,
				preset: this.options.preset,
				stylename: styleName
			});

			var updateCssDebounced = _.debounce(this.updateCss, 1000);

			this.listenTo(this.presetCSSEditor, 'upfront:presets:update', this.onPresetUpdate);
			this.listenTo(this.presetCSSEditor, 'change', function(newCss) {
				updateCssDebounced(me.options.preset, newCss, me);
			});

			Upfront.Events.trigger("entity:settings:deactivate");
		}
	});


	return PresetCssModule;
});


(function($) {
define(
'scripts/upfront/preset-settings/util',[],function() {
	var expandBreakpoints = function(properties) {
		if (properties['breakpoint'] && properties['breakpoint']['tablet']) {
			properties['tablet'] = [];
			_.each(properties['breakpoint']['tablet'], function(property, name) {
				properties['tablet'][name] = property;
			});
		}
		if (properties['breakpoint'] && properties['breakpoint']['mobile']) {
			properties['mobile'] = [];
			_.each(properties['breakpoint']['mobile'], function(property, name) {
				properties['mobile'][name] = property;
			});
		}
		return properties;
	};
	/**
	 * Generates CSS rules for placing into page styles.
	 *
	 * @param properties - preset properties
	 * @return String - CSS for preset
	 */
	var generateCss = function(properties, styleTpl) {
		var tpl = Upfront.Util.template(styleTpl);
		
		//Increase preset_style css specificity
		if(typeof properties.preset_style !== "undefined") {
			properties.preset_style = properties.preset_style
			.replace(/#page/g, '#page.upfront-layout-view .upfront-editable_entity.upfront-module');
		}
		
		return tpl({properties: expandBreakpoints(properties)})
			.replace(/#page/g, 'div#page.upfront-layout-view')
			// Solve case of button loosing its styles
			.replace(new RegExp(properties.id + ' .upfront-button', 'g'), properties.id + '.upfront-button')
			.replace(/\\'/g, "'")
			.replace(/\\'/g, "'")
			.replace(/\\'/g, "'")
			.replace(/\\"/g, '"')
			.replace(/\\"/g, '"')
			.replace(/\\"/g, '"');
	};

	var Util = {
		generateCss: generateCss,
		/**
		 * Generates and appends element preset styles to page using element presets from
		 * Upfront.mainData and preset style template.
		 *
		 * @param element String - element name
		 * @param styleTpl String - style template
		 */
		generatePresetsToPage: function(element, styleTpl) {
			_.each(Upfront.mainData[element + 'Presets'], function(properties) {
				Util.updatePresetStyle(element, expandBreakpoints(properties), styleTpl);
			});
		},

		getPresetProperties: function (element, preset_id) {
			var presets = Upfront.mainData[element + 'Presets'] || [],
				props = {}
			;
			
			$.each(presets, function (idx, preset) {
				if (!(preset && preset.id && preset_id === preset.id)) return true;
				props = _.extend({}, preset);
			});
			return props;
		},

		updatePresetStyle: function (element, properties, styleTpl) {
			var styleId = element + '-preset-' + properties.id,
				props = _.extend({}, properties)
			;

			// Do we have come colors here? Yes? Expand them then
			_.each(props, function (prop, idx) {
				if (Upfront.Util.colors.is_theme_color(prop)) {
					props[idx] = Upfront.Util.colors.get_color(prop);
				}
			});

			if ($('style#' + styleId).length === 0) {
				$('body').append('<style id="' + styleId + '"></style>');
			}
			$('style#' + styleId).text(generateCss(props, styleTpl));
		}
	};

	return Util;
});
})(jQuery);

(function($) {
define('scripts/upfront/preset-settings/preset-manager',[
	'scripts/upfront/element-settings/root-settings-panel',
	'scripts/upfront/settings/modules/select-preset',
	'scripts/upfront/settings/modules/edit-preset',
	'scripts/upfront/settings/modules/migrate-preset',
	'scripts/upfront/settings/modules/preset-css',
	'scripts/upfront/preset-settings/util',
	'scripts/upfront/preset-settings/preset-css-editor'
], function(RootSettingsPanel, SelectPresetModule, EditPresetModule, MigratePresetModule, PresetCssModule, Util, PresetCSSEditor) {
	/**
	 * Handles presets: load, edit, delete and update for elements.
	 *
	 * API
	 * ---
	 * Options that are needed for this to work:
	 * mainDataCollection - name of property that holds preset collection
	 * styleElementPrefix - this will be used to identify style elements in page
	 * ajaxActionSlug - slug that will be used to call ajax actions for updating and deleting presets
	 * panelTitle - title of panel
	 * presetDefaults - these include all preset properties except name and id that will be usde to
	 *		create new presets
	 * stateModules - presets handle element states like hover, static and active; for each state all
	 *		properties can be set this is object containing all states and their properties see Tab Element
	 *		settings for example.
	 *		In state fields, fields that have change callback can use second parameter which will be parent
	 *		element, using parent element change function can set value on model.
	 *
	 * styleTpl - Upfront.Util.template parsed styles template
	 */
	var l10n = Upfront.Settings.l10n.preset_manager;

	var PresetManager = RootSettingsPanel.extend({
		className: 'uf-settings-panel upfront-settings_panel preset-manager-panel',

		initialize: function (options) {
			var me = this;

			this.options = options;
			_.each(this.options, function(option, index) {
				this[index] = option;
			}, this);

			var defaultPreset = false;

			_.each(Upfront.mainData[this.mainDataCollection], function(preset, presetIndex) {
				if (preset.id === 'default') {
					defaultPreset = true;
				}
			});

			if(!defaultPreset) {
				Upfront.mainData[this.mainDataCollection] = _.isArray(Upfront.mainData[this.mainDataCollection]) ?
						Upfront.mainData[this.mainDataCollection] : [];

				Upfront.mainData[this.mainDataCollection].unshift(this.getPresetDefaults('default'));
			}


			this.presets = new Backbone.Collection(Upfront.mainData[this.mainDataCollection] || []);

			var savePreset = function(properties) {
				Upfront.Util.post({
					action: 'upfront_save_' + this.ajaxActionSlug + '_preset',
					data: properties
				}).done( function() {
					me.model.trigger("preset:updated");
				});
			};

			// Let's not flood server on some nuber property firing changes like crazy
			this.debouncedSavePreset = _.debounce(savePreset, 1000);

			this.createBackup();

			this.defaultOverlay();

			this.listenToOnce(Upfront.Events, 'element:settings:canceled', function() {
				this.updateCanceledPreset(this.backupPreset);
			});

			// Listen to breakpoint change and close off the interface
			this.listenToOnce(Upfront.Events, 'upfront:layout_size:change_breakpoint', this.cancelPresetChanges);
		},

		createBackup: function() {
			var preset = this.property('preset') ? this.clear_preset_name(this.property('preset')) : 'default',
				backupModel = this.presets.findWhere({id: preset});

			if(typeof backupModel === "undefined") {
				backupModel = this.presets.findWhere({id: 'default'});
			}

			// Backup preset model properties for later use in reset (on settings cancel)
			if(typeof this.backupPreset === "undefined") {
				this.backupPreset = Upfront.Util.clone(backupModel.toJSON());
			}
		},

		defaultOverlay: function() {
			var me = this,
				preset = this.property('preset') ? this.clear_preset_name(this.property('preset')) : 'default';

			if(preset === "default") {
				setTimeout( function() {
					//Wrap settings and preset styles
					me.$el.find('.preset_specific').next().andSelf().wrapAll('<div class="default-overlay-wrapper" />');

					//Append overlay div
					me.$el.find('.default-overlay-wrapper').append('<div class="default-overlay">' +
					'<div class="overlay-title">' + l10n.default_overlay_title + '</div>' +
					'<div class="overlay-text">' + l10n.default_overlay_text + '</div>' +
					'<div class="overlay-button"><button type="button" class="overlay-button-input">'+ l10n.default_overlay_button +'</button></div>' +
					'</div>');

					//Disable preset reset button
					me.$el.find('.delete_preset input').prop('disabled', true);
					me.$el.find('.delete_preset input').css({ opacity: 0.6 });
				}, 100);
			}

			this.$el.on('click', '.overlay-button-input', function(event) {
				event.preventDefault();

				//Remove overlay div
				me.$el.find('.default-overlay').remove();

				//Update wrapper min-height
				me.$el.find('.default-overlay-wrapper').css('min-height', '30px');

				//Enable preset reset button
				me.$el.find('.delete_preset input').prop('disabled', false);
				me.$el.find('.delete_preset input').css({ opacity: 1 });
			});
		},

		updateMainDataCollectionPreset: function(properties) {
			var index;

			_.each(Upfront.mainData[this.mainDataCollection], function(preset, presetIndex) {
				if (preset.id === properties.id) {
					index = presetIndex;
				}
			});

			if (typeof index !== 'undefined') {
				Upfront.mainData[this.mainDataCollection][index] = properties;
			} else {
				Upfront.mainData[this.mainDataCollection].push(properties);
			}
		},

		/**
		 * Allow element appearance panels to migrate properties from old type of settings
		 * to new preset based settings.
		 */
		migratePresetProperties: function(newPreset) {
			return newPreset;
		},

		/**
		 Migrate theme_style classes
		 */

		migrateElementStyle: function(styles) {
			return styles;
		},

		setupItems: function() {
			this.trigger('upfront:presets:setup-items', this);
			var preset = this.clear_preset_name(this.model.decode_preset() || 'default'),
				presetModel = this.presets.findWhere({id: preset}),
				currentBreakpoint,
				breakpointsData,
				breakpointData;

			if(typeof presetModel === "undefined") {
				presetModel = this.presets.findWhere({id: 'default'});
			}

			// Add items
			if (this.selectPresetModule && this.selectPresetModule.stopListening) {
				this.selectPresetModule.stopListening();
				this.stopListening(this.selectPresetModule);
			}
			this.selectPresetModule = new SelectPresetModule({
				model: this.model,
				presets: this.presets
			});

			// Setup preset model so that it uses breakpoint values
			if (this.options.hasBreakpointSettings === true) {
				currentBreakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_active();
				breakpointsData = presetModel.get('breakpoint') || {};
				breakpointData = breakpointsData[currentBreakpoint.id] || {};
				_.each(this.options.breakpointSpecificPresetSettings, function(settingOptions) {
					if (!_.isUndefined(breakpointData[settingOptions.name])) {
						var data = {};
						data[settingOptions.name] = breakpointData[settingOptions.name];
						presetModel.set(data, {silent: true});
					}
				}, this);
			}

			if (this.editPresetModule && this.editPresetModule.stopListening) {
				this.editPresetModule.stopListening();
				this.stopListening(this.editPresetModule);
			}
			this.editPresetModule = new EditPresetModule({
				model: presetModel,
				stateModules: this.stateModules
			});

			if (this.presetCssModule && this.presetCssModule.stopListening) {
				this.presetCssModule.stopListening();
				this.stopListening(this.presetCssModule);
			}
			this.presetCssModule = new PresetCssModule({
				model: this.model,
				preset: presetModel
			});

			//When element is not migrated yet
			this.migratePresetModule = new MigratePresetModule({
				model: this.model,
				presets: this.presets,
				elementPreset: this.styleElementPrefix
			});

			this.listenTo(this.selectPresetModule, 'upfront:presets:new', this.createPreset);
			this.listenTo(this.selectPresetModule, 'upfront:presets:change', this.changePreset);
			this.listenTo(this.editPresetModule, 'upfront:presets:delete', this.deletePreset);
			this.listenTo(this.editPresetModule, 'upfront:presets:reset', this.resetPreset);
			this.listenTo(this.editPresetModule, 'upfront:presets:update', this.updatePreset);
			this.listenTo(this.editPresetModule, 'upfront:presets:state_show', this.stateShow);
			this.listenTo(this.presetCssModule, 'upfront:presets:update', this.updatePreset);
			this.listenTo(this.selectPresetModule, 'upfront:presets:migrate', this.migratePreset);

			//Migration listeners
			this.listenTo(this.migratePresetModule, 'upfront:presets:preview', this.previewPreset);
			this.listenTo(this.migratePresetModule, 'upfront:presets:change', this.applyExistingPreset);
			this.listenTo(this.migratePresetModule, 'upfront:presets:new', this.migratePreset);

			this.settings = _([
				this.selectPresetModule,
				this.editPresetModule,
				this.presetCssModule
			]);
		},

		getTitle: function() {
			return 'Appearance';
		},

		getPresetDefaults: function(presetName) {
			return _.extend(this.presetDefaults, {
				id: presetName.toLowerCase().replace(/ /g, '-'),
				name: presetName
			});
		},

		updateCanceledPreset: function(properties) {
			Util.updatePresetStyle(this.styleElementPrefix.replace(/-preset/, ''), properties, this.styleTpl);

			this.debouncedSavePreset(properties);

			this.updateMainDataCollectionPreset(properties);
		},

		updatePreset: function(properties) {
			var index,
				styleElementId,
			 	currentBreakpoint,
				breakpointsData
			;

			// Setup model so that it saves breakpoint values to breakpoint property
			if (this.options.hasBreakpointSettings === true) {
				currentBreakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_active();
				breakpointsData = properties.breakpoint || {};
				breakpointsData[currentBreakpoint.id] = breakpointsData[currentBreakpoint.id] || {};
				_.each(this.options.breakpointSpecificPresetSettings, function(settingOptions) {
					breakpointsData[currentBreakpoint.id][settingOptions.name] = properties[settingOptions.name];
					// Delete property from root properties so that model remians clean (these properties should only be saved in breakpoint data)
					delete properties[settingOptions.name];
				}, this);
				// Finally update breakpoints in model
				properties.breakpoint = breakpointsData;
			}
			Util.updatePresetStyle(this.styleElementPrefix.replace(/-preset/, ''), properties, this.styleTpl);

			this.debouncedSavePreset(properties);

			this.updateMainDataCollectionPreset(properties);
		},

		migratePreset: function(presetName) {

			//Check if preset already exist
			var existingPreset = this.presets.findWhere({id: presetName.toLowerCase().replace(/ /g, '-')});

			if(typeof existingPreset !== "undefined") {
				Upfront.Views.Editor.notify(l10n.preset_already_exist.replace(/%s/, presetName), 'error');
				return;
			}

			var elementStyleName = this.property('theme_style');

			// We need to set to _default first so that css editor can get style properly
			if (!elementStyleName) elementStyleName = '_default';

			// We need to initialize cssEditor to get element styles
			Upfront.Application.cssEditor.init({
				model: this.model,
				stylename: elementStyleName,
				no_render: true
			});

			var style = $.trim(Upfront.Application.cssEditor.get_style_element().html().replace(/div#page.upfront-layout-view .upfront-editable_entity.upfront-module/g, '#page'));

			//Apply style only for the current preset
			style = style.replace(new RegExp('.' + elementStyleName, 'g'), '');

			style = Upfront.Application.stylesAddSelectorMigration($.trim(style), '');

			//Migrate element styles
			style = this.migrateElementStyle(style);

			newPreset = new Backbone.Model(this.getPresetDefaults(presetName));

			//Migrate element styles to preset
			if(typeof style !== "undefined") {
				newPreset.set({
					preset_style: style
				});
			}

			//Migrate element properties to preset
			this.migratePresetProperties(newPreset);

			// And remove element style
			this.property('preset', newPreset.id);
			this.presets.add(newPreset);
			presetOptions = newPreset;
			properties = newPreset.toJSON();

			this.property('theme_style', '');

			//Render new preset
			Util.updatePresetStyle(this.styleElementPrefix.replace(/-preset/, ''), properties, this.styleTpl);

			//Save preset
			this.debouncedSavePreset(properties);
			this.updateMainDataCollectionPreset(properties);

			//Set element as migrated
			this.property('usingNewAppearance', true);

			// Trigger change so that whole element re-renders again.
			// (to replace element style class with preset class, look upfront-views.js
			this.model.get('properties').trigger('change');

			//Notify preset is created
			Upfront.Views.Editor.notify(l10n.preset_created.replace(/%s/, presetName));

			this.render();
		},

		createPreset: function(presetName) {
			//Check if preset already exist

			var existingPreset = this.presets.findWhere({id: presetName.toLowerCase().replace(/ /g, '-')});
			if(typeof existingPreset !== "undefined") {
				Upfront.Views.Editor.notify(l10n.preset_already_exist.replace(/%s/, presetName), 'error');
				return;
			}

			var preset = this.getPresetDefaults(presetName);

			this.presets.add(preset);
			this.model.set_property('preset', preset.id);
			this.updatePreset(preset);

			// Make sure we don't lose our current preset
			this.model.encode_preset(preset.id);

			//Notify preset is created
			Upfront.Views.Editor.notify(l10n.preset_created.replace(/%s/, presetName));

			this.render();
		},

		deletePreset: function(preset) {
			var index;

			Upfront.Util.post({
				data: preset.toJSON(),
				action: 'upfront_delete_' + this.ajaxActionSlug + '_preset'
			});

			_.each(Upfront.mainData[this.mainDataCollection], function(storedPreset, presetIndex) {
				if (storedPreset.id === preset.get('id')) {
					index = presetIndex;
				}
			});
			Upfront.mainData[this.mainDataCollection].splice(index, 1);

			this.model.set_property('preset', 'default');
			this.model.encode_preset('default');

			this.presets.remove(preset);

			this.render();

			this.defaultOverlay();
		},

		resetPreset: function(preset) {
			var index;
			var me = this;

			Upfront.Util.post({
				data: preset.toJSON(),
				action: 'upfront_reset_' + this.ajaxActionSlug + '_preset'
			}).success(function (ret) {
				var resetPreset = ret.data;
				if(_.isEmpty(ret.data) || ret.data === false) {
					resetPreset = me.getPresetDefaults('default');
				}

				//Update preset CSS with reset properties
				Util.updatePresetStyle(me.styleElementPrefix.replace(/-preset/, ''), resetPreset, me.styleTpl);

				me.updateMainDataCollectionPreset(resetPreset);

				me.presets = new Backbone.Collection(Upfront.mainData[me.mainDataCollection] || []);

				//Notify preset is reset
				Upfront.Views.Editor.notify(l10n.preset_reset.replace(/%s/, preset.get('id')));

				me.$el.empty();
				me.render();
			}).error(function (ret) {
				//Notify error
				Upfront.Views.Editor.notify(ret);
			});
		},

		applyExistingPreset: function(preset) {
			//Set element as already migrated
			this.property('usingNewAppearance', true);

			//Set existing preset
			this.changePreset(preset);

			this.defaultOverlay();
		},

		changePreset: function(preset) {
			// Add items
			this.stopListening();

			// Make sure we don't lose our current preset
			this.model.encode_preset(preset);

			//this.setupItems(); // called in render -> getBody
			this.render();

			this.defaultOverlay();

			//Display notification
			Upfront.Views.Editor.notify(l10n.preset_changed.replace(/%s/, preset));
		},

		previewPreset: function(preset) {
			var element_id = this.property('element_id'),
				elementType = this.styleElementPrefix.replace(/-preset/, '');

			//We need to manage Tabs, Accordions & Buttons are they are using another classes for presets
			if(elementType === "accordion") {
				var $selector = $('#' + element_id).find(".upfront-accordion-container");

				$selector.removeClass(this.getPresetClasses(elementType));
				$selector.addClass(elementType + '-preset-' + preset);

			} else if(elementType === "tab") {
				//Remove original preset classes
				var $selector = $('#' + element_id).find(".upfront-tabs-container");

				$selector.removeClass(this.getPresetClasses(elementType));
				$selector.addClass(elementType + '-preset-' + preset);

			} else if(elementType === "button") {
				var $selector = $('#' + element_id).find(".upfront_cta");

				$selector.removeClass(this.getPresetClasses(elementType));
				$selector.addClass(elementType + '-preset-' + preset);

			} else {
				//Remove original preset classes
				$('#' + element_id).removeClass(this.getPresetClasses());

				//Add preset class to element
				$('#' + element_id).addClass(preset);
			}

		},

		getPresetClasses: function(elementType) {
			var presetClasses = '';

			_.map(this.presets.models, function(model) {
				if(typeof elementType !== "undefined" && elementType) {
					presetClasses += elementType + '-preset-' + model.get('id') + ' ';
				} else {
					presetClasses += model.get('id') + ' ';
				}
			});

			return presetClasses;
		},

		stateShow: function(state) {
			this.trigger('upfront:presets:state_show', state);
		},
		
		/**
		 * Allow element appearance panels to migrate properties from old type of settings
		 * to new preset based settings.
		 */
		getModifiedProperties: function() {
			return true;
		},
		
		migrateToDefault: function() {
			var needMigration = this.getModifiedProperties();
			
			if(!needMigration) {
				//Set element as already migrated
				this.property('usingNewAppearance', true);

				//Set preset to default
				this.property('preset', 'default');

				this.defaultOverlay();
			}
			
			return false;
		},

		getBody: function () {
			this.setupItems();
			var $body = $('<div />'),
				me = this;
			
			/**
			 *	Automatically migrate Text & Accordion elements to Default if no options are not modified.
			 */
			this.migrateToDefault();

			if(this.property('usingNewAppearance') !== true) {
				this.settings = _([
					this.migratePresetModule
				]);
			}

			this.settings.each(function (setting) {
				if ( ! setting.panel ) setting.panel = me;
				setting.render();
				$body.append(setting.el)
			});


			return $body;
		},

		// utils
		clear_preset_name: function(preset) {
			preset = preset.replace(' ', '-');
			preset = preset.replace(/[^-a-zA-Z0-9]/, '');
			return preset;
		},

		property: function(name, value, silent) {
			if(typeof value != "undefined"){
				if(typeof silent == "undefined")
					silent = true;
				return this.model.set_property(name, value, silent);
			}
			return this.model.get_property_value_by_name(name);
		},

		save_settings: function() {
			// Deliberately disable save_settings, preset manager saves preset as it changes
		}
	});

	return PresetManager;
});
})(jQuery);

(function ($) {
define('scripts/upfront/settings/root-modules-panel',[
	'scripts/upfront/settings/modules-container',
	'scripts/upfront/element-settings/root-panel-mixin'
],function(ModulesContainer, RootPanelMixin) {

	var RootModulesPanel = ModulesContainer.extend(
		_.extend({}, RootPanelMixin, {
			getBody: function() {
				var $body = $('<div />');

				$body.append('<div class="upfront-settings-item-content"></div>');

				var $content = $body.find('.upfront-settings-item-content');
				this.modules.each(function(module){
					module.render();
					module.delegateEvents();
					$content.append(module.el);
				});

				return $body;
			}
		})
	);

	return RootModulesPanel;
});
})(jQuery);

define('scripts/upfront/element-settings/advanced-settings',[
	'scripts/upfront/settings/root-modules-panel'
], function(RootModulesPanel) {
	var AdvancedSettings = RootModulesPanel.extend({
		className: 'uf-settings-panel upfront-settings_panel advanced-settings',
		modules: [
			{
				moduleType: 'Padding'
			},
			{
			 moduleType: 'Anchor'
			}
		],

		getAdditionalModules: function(modulesConfig) {
			var hadPresets = _.contains(['UtabsView', 'UaccordionView', 'ButtonView'], this.model.get_property_value_by_name('view_class')),
				elementStyleName;

			// Show only for tab, accordion and button
			if (!hadPresets) return modulesConfig;

			// And only if element used element styles
			elementStyleName = this.model.get_property_value_by_name('theme_style');
			if (!elementStyleName || elementStyleName === '_default') return modulesConfig;

			modulesConfig.unshift({moduleType:'ElementStyle'});
			return modulesConfig;
		},

		title: 'Advanced Settings'
	});

	return AdvancedSettings;
});

(function ($) {
define('scripts/upfront/element-settings/settings',[
	'scripts/upfront/preset-settings/preset-manager',
	'scripts/upfront/element-settings/advanced-settings'
], function (PresetManager, AdvancedSettings) {
	var l10n = Upfront.Settings && Upfront.Settings.l10n
		? Upfront.Settings.l10n.global.views
		: Upfront.mainData.l10n.global.views
	;

	var ElementSettings = Backbone.View.extend({
		id: 'settings',
		events: {
			'click .upfront-save_settings' : 'saveSettings',
			'click .upfront-cancel_settings' : 'cancelSettings'
		},

		initialize: function(opts) {
			this.options = opts;
			var me = this,
				panels = {},
				currentBreakpoint,
				breakpointsData,
				breakpointData;

			// Setup model so that it uses breakpoint values
			if (this.hasBreakpointSettings === true) {
				currentBreakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_active();
				breakpointsData = this.model.get_property_value_by_name('breakpoint') || {};
				breakpointData = breakpointsData[currentBreakpoint.id] || {};
				// Breakpoint specific settings
				_.each(this.breakpointSpecificSettings, function(settingOptions) {
					if (!_.isUndefined(breakpointData[settingOptions.name])) {
						this.model.set_property(settingOptions.name, breakpointData[settingOptions.name], true);
					}
				}, this);
			}

			// Instantiate panels
			_.each(this.panels, function(panel, index) {
				if (index === 'Appearance') {
					this.appearancePanel = new PresetManager(
					_.extend(
							{
								hasBreakpointSettings: this.hasBreakpointSettings,
								breakpointSpecificPresetSettings: this.breakpointSpecificPresetSettings,
								model: this.model
							},
							panel
						)
					);

					this.listenTo(this.appearancePanel, 'upfront:presets:state_show', this.stateShow);

					panels.Appearance = this.appearancePanel;
					return;
				}
				if(_.isFunction(panel)) {
					panels[index] = new panel({ model: this.model });
				}
			}, this);

			// Hard wiring here instead having every element define advanced panel
			// because all elements have identical advanced settings panel
			panels.Advanced = new AdvancedSettings({model: this.model});

			// Have to do this because overwriting own property
			this.panels = panels;

			this.on('open', function(){
				me.model.trigger('settings:open', me);
			});
		},

		saveSettings: function() {
			var currentBreakpoint,
				breakpointsData;

			this.removePreviewClasses();

			// Setup model so that it saves breakpoint values to breakpoint property
			if (this.hasBreakpointSettings === true && this.breakpointSpecificSettings) {
				currentBreakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_active();
				breakpointsData = this.model.get_property_value_by_name('breakpoint') || {};
				breakpointsData[currentBreakpoint.id] = breakpointsData[currentBreakpoint.id] || {};
				_.each(this.breakpointSpecificSettings, function(settingOptions) {
					breakpointsData[currentBreakpoint.id][settingOptions.name] = this.model.get_property_value_by_name(settingOptions.name);
					// Always save width to breakpoint, comes handy in public scripts
					breakpointsData[currentBreakpoint.id].width = currentBreakpoint.get('width');
				}, this);
				// Finally update breakpoints in model
				this.model.set_property('breakpoint', breakpointsData, true);
			}
			_.each(this.panels, function(panel){
				panel.save_settings();
			});

			this.model.get("properties").trigger('change');
			Upfront.Events.trigger("element:settings:saved");
			Upfront.Events.trigger("element:settings:deactivate");
			if ( _upfront_post_data.layout.specificity && _upfront_post_data.layout.item && !_upfront_post_data.layout.item.match(/-page/) )
				Upfront.Events.trigger("command:layout:save_as");
			else
				Upfront.Events.trigger("command:layout:save");

			if (this.onSaveSettings) this.onSaveSettings();
		},

		cancelSettings: function() {
			this.removePreviewClasses();
			Upfront.Events.trigger("element:settings:canceled");
		},

		stateShow: function(state) {
			var elementContainer = this.for_view.$el.find('.upfront-object');
			if(state !== "static") {
				this.removePreviewClasses();
				elementContainer.addClass('live-preview-' + state);
			} else {
				this.removePreviewClasses();
			}
		},

		removePreviewClasses: function() {
			var elementContainer = this.for_view.$el.find('.upfront-object');
			elementContainer.removeClass('live-preview-hover live-preview-focus live-preview-active');
		},

		render: function () {
			var me = this;

			this.$el
				.html(
					'<div class="upfront-settings-title">' + this.title + '</div><div id="sidebar-scroll-wrapper" />'
				)
			;

			/*
			 * This event is broadcast so that other plugins can register their
			 * own Upfront element for the CSS Editor before the settings panel
			 * is displayed.
			 *
			 * Example:
			 * Upfront.Events.on( 'settings:prepare', function() {
			 *   args = {label: 'My Element', id: 'my_element'};
			 *   Upfront.Application.cssEditor.elementTypes['ElementModel'] = args;
			 * });
			 */
			Upfront.Events.trigger("settings:prepare");

			_.each(this.panels, function (panel) {
				panel.render();
				panel.parent_view = me;
				me.$el.find('#sidebar-scroll-wrapper').append(panel.el);
			});

			this.$el.addClass('upfront-ui');
			this.$el.append(
				"<div class='upfront-settings-button_panel'>" +
					"<button type='button' class='upfront-cancel_settings'>" + l10n.cancel + "</button>" +
					"<button type='button' class='upfront-save_settings'><i class='icon-ok'></i> " + l10n.save_element + "</button>" +
				'</div>'
			);
		},

		cleanUp: function(){
			if (this.panels) {
				_.each(this.panels, function(panel){
					if (panel.cleanUp) panel.cleanUp();
				});
			}
			this.remove();
		}
	});

	return ElementSettings;
});
})(jQuery);


define('text!elements/upfront-accordion/tpl/preset-style.html',[],function () { return '.upfront-accordion-container.accordion-preset-<?php echo $properties[\'id\'] ?> .accordion-panel-title,\r\n.upfront-accordion-container.accordion-preset-<?php echo $properties[\'id\'] ?> .accordion-panel-title p {\r\n\t<?php if(!empty($properties[\'static-header-bg-color\'])) { ?>background: <?php echo $properties[\'static-header-bg-color\'] ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'static-font-color\'])) { ?>color: <?php echo $properties[\'static-font-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'static-font-family\'])) { ?>font-family: <?php echo $properties[\'static-font-family\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'static-font-size\'])) { ?>font-size: <?php echo $properties[\'static-font-size\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'static-weight\'])) { ?>font-weight: <?php echo $properties[\'static-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'static-style\'])) { ?>font-style: <?php echo $properties[\'static-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'static-line-height\'])) { ?>line-height: <?php echo $properties[\'static-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'static-useborder\'])) { ?>\r\n        <?php if(!empty($properties[\'static-borderwidth\']) && !empty($properties[\'static-bordertype\']) && !empty($properties[\'static-bordercolor\'])) { ?>border: <?php echo $properties[\'static-borderwidth\'] ?>px <?php echo $properties[\'static-bordertype\'] ?> <?php echo $properties[\'static-bordercolor\'] ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        border: none;\r\n    <?php } ?>\r\n\t<?php if(!empty($properties[\'hover-use-animation\'])) { ?>\r\n\t\ttransition: all <?php echo $properties[\'hover-transition-duration\']  ?>s <?php echo $properties[\'hover-transition-easing\']  ?>;\r\n\t<?php } else { ?>\r\n\t\ttransition: none;\r\n\t<?php } ?>\r\n}\r\n\r\n.upfront-accordion-container.accordion-preset-<?php echo $properties[\'id\'] ?> .accordion-panel-title:hover,\r\n.upfront-accordion-container.accordion-preset-<?php echo $properties[\'id\'] ?> .accordion-panel-title:hover p,\r\n.upfront-accordion.<?php echo $properties[\'id\']  ?>.live-preview-hover .upfront-accordion-container .accordion-panel-title {\r\n\t<?php if(!empty($properties[\'hover-use-colors\'])) { ?>\r\n\t\t<?php if(!empty($properties[\'hover-header-bg-color\'])) { ?>background: <?php echo $properties[\'hover-header-bg-color\'] ?>; <?php } ?>\r\n\t<?php } else { ?>\r\n\t\t<?php if(!empty($properties[\'static-header-bg-color\'])) { ?>background: <?php echo $properties[\'static-header-bg-color\'] ?>; <?php } ?>\r\n\t<?php } ?>\r\n\t<?php if(!empty($properties[\'hover-use-typography\'])) { ?>\r\n\t\t<?php if(!empty($properties[\'hover-font-color\'])) { ?>color: <?php echo $properties[\'hover-font-color\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-font-family\'])) { ?>font-family: <?php echo $properties[\'hover-font-family\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-font-size\'])) { ?>font-size: <?php echo $properties[\'hover-font-size\']  ?>px; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-weight\'])) { ?>font-weight: <?php echo $properties[\'hover-weight\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-style\'])) { ?>font-style: <?php echo $properties[\'hover-style\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-line-height\'])) { ?>line-height: <?php echo $properties[\'hover-line-height\']  ?>;<?php } ?>\r\n\t<?php } else { ?>\r\n\t\t<?php if(!empty($properties[\'static-font-color\'])) { ?>color: <?php echo $properties[\'static-font-color\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-font-family\'])) { ?>font-family: <?php echo $properties[\'static-font-family\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-font-size\'])) { ?>font-size: <?php echo $properties[\'static-font-size\']  ?>px; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-weight\'])) { ?>font-weight: <?php echo $properties[\'static-weight\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-style\'])) { ?>font-style: <?php echo $properties[\'static-style\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-line-height\'])) { ?>line-height: <?php echo $properties[\'static-line-height\']  ?>;<?php } ?>\r\n\t<?php } ?>\r\n\t<?php if(!empty($properties[\'hover-useborder\'])) { ?>\r\n        <?php if(!empty($properties[\'hover-borderwidth\']) && !empty($properties[\'hover-bordertype\']) && !empty($properties[\'hover-bordercolor\'])) { ?>border: <?php echo $properties[\'hover-borderwidth\'] ?>px <?php echo $properties[\'hover-bordertype\'] ?> <?php echo $properties[\'hover-bordercolor\'] ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        border: none;\r\n    <?php } ?>\r\n}\r\n\r\n.upfront-accordion-container.accordion-preset-<?php echo $properties[\'id\'] ?> .accordion-panel-active .accordion-panel-title,\r\n.upfront-accordion-container.accordion-preset-<?php echo $properties[\'id\'] ?> .accordion-panel-active .accordion-panel-title p,\r\n.upfront-accordion.<?php echo $properties[\'id\']  ?>.live-preview-active .upfront-accordion-container .accordion-panel-title {\r\n\t<?php if(!empty($properties[\'active-use-color\'])) { ?>\r\n\t\t<?php if(!empty($properties[\'active-header-bg-color\'])) { ?>background: <?php echo $properties[\'active-header-bg-color\'] ?>; <?php } ?>\r\n\t<?php } else { ?>\r\n\t\t<?php if(!empty($properties[\'static-header-bg-color\'])) { ?>background: <?php echo $properties[\'static-header-bg-color\'] ?>; <?php } ?>\r\n\t<?php } ?>\r\n\t<?php if(!empty($properties[\'active-use-typography\'])) { ?>\r\n\t\t<?php if(!empty($properties[\'active-font-color\'])) { ?>color: <?php echo $properties[\'active-font-color\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'active-font-family\'])) { ?>font-family: <?php echo $properties[\'active-font-family\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'active-font-size\'])) { ?>font-size: <?php echo $properties[\'active-font-size\']  ?>px; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'active-weight\'])) { ?>font-weight: <?php echo $properties[\'active-weight\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'active-style\'])) { ?>font-style: <?php echo $properties[\'active-style\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'active-line-height\'])) { ?>line-height: <?php echo $properties[\'active-line-height\']  ?>;<?php } ?>\r\n\t<?php } else { ?>\r\n\t\t<?php if(!empty($properties[\'static-font-color\'])) { ?>color: <?php echo $properties[\'static-font-color\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-font-family\'])) { ?>font-family: <?php echo $properties[\'static-font-family\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-font-size\'])) { ?>font-size: <?php echo $properties[\'static-font-size\']  ?>px; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-weight\'])) { ?>font-weight: <?php echo $properties[\'static-weight\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-style\'])) { ?>font-style: <?php echo $properties[\'static-style\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-line-height\'])) { ?>line-height: <?php echo $properties[\'static-line-height\']  ?>;<?php } ?>\r\n\t<?php } ?>\r\n\t<?php if(!empty($properties[\'active-useborder\'])) { ?>\r\n        <?php if(!empty($properties[\'active-borderwidth\']) && !empty($properties[\'active-bordertype\']) && !empty($properties[\'active-bordercolor\'])) { ?>border: <?php echo $properties[\'active-borderwidth\'] ?>px <?php echo $properties[\'active-bordertype\'] ?> <?php echo $properties[\'active-bordercolor\'] ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        border: none;\r\n    <?php } ?>\r\n\ttransition: none;\r\n}\r\n#page .upfront-accordion-container.accordion-preset-<?php echo $properties[\'id\'] ?> .accordion-panel-content,\r\n#page .upfront-accordion-container.accordion-preset-<?php echo $properties[\'id\'] ?> .accordion-panel-content p {\r\n\t<?php if (!empty($properties[\'active-content-bg-color\'])) { ?>\r\n\t\tbackground: <?php echo $properties[\'active-content-bg-color\'] ?>;\r\n\t<?php } ?>\r\n\t<?php if(!empty($properties[\'global-useborder\'])) { ?>\r\n        <?php if(!empty($properties[\'global-borderwidth\']) && !empty($properties[\'global-bordertype\']) && !empty($properties[\'global-bordercolor\'])) { ?>border: <?php echo $properties[\'global-borderwidth\'] ?>px <?php echo $properties[\'global-bordertype\'] ?> <?php echo $properties[\'global-bordercolor\'] ?>;<?php } ?>\r\n\t<?php } ?>\r\n}\r\n#page .upfront-accordion-container.accordion-preset-<?php echo $properties[\'id\'] ?> .accordion-panel-title:after {\r\n\tborder-top-color: <?php echo $properties[\'static-triangle-icon-color\'] ?>;\r\n\tborder-left-color: transparent;\r\n}\r\n#page .upfront-accordion-container.accordion-preset-<?php echo $properties[\'id\'] ?> .accordion-panel-title:hover:after {\r\n\t<?php if(!empty($properties[\'hover-use-colors\'])) { ?>\r\n\tborder-top-color: <?php echo $properties[\'hover-triangle-icon-color\'] ?>;\r\n\t<?php } else { ?>\r\n\tborder-top-color: <?php echo $properties[\'static-triangle-icon-color\'] ?>;\r\n\t<?php } ?>\r\n\tborder-left-color: transparent;\r\n}\r\n#page .upfront-accordion-container.accordion-preset-<?php echo $properties[\'id\'] ?> .accordion-panel-active .accordion-panel-title:after {\r\n\tborder-top-color: transparent;\r\n\t<?php if(!empty($properties[\'active-use-color\'])) { ?>\r\n\t\tborder-left-color: <?php echo $properties[\'active-triangle-icon-color\'] ?>;\r\n\t<?php } else { ?>\r\n\t\tborder-left-color: <?php echo $properties[\'static-triangle-icon-color\'] ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n<?php if(!empty($properties[\'preset_style\'])) { ?><?php echo $properties[\'preset_style\'] ?><?php } ?>\r\n';});

define('elements/upfront-accordion/js/settings',[
	'scripts/upfront/element-settings/settings',
	'scripts/upfront/preset-settings/util',
	'text!elements/upfront-accordion/tpl/preset-style.html'
], function(ElementSettings, Util, styleTpl) {
	var l10n = Upfront.Settings.l10n.accordion_element;

	var AccordionSettings = ElementSettings.extend({
		panels: {
			Appearance: {
				mainDataCollection: 'accordionPresets',
				styleElementPrefix: 'accordion-preset',
				ajaxActionSlug: 'accordion',
				panelTitle: l10n.settings,
				styleTpl: styleTpl,
				presetDefaults: Upfront.mainData.presetDefaults.accordion,
				stateModules: {
					Global: [
						{
							moduleType: 'Colors',
							options: {
								title: l10n.content_area_colors_label,
								multiple: false,
								single: true,
								abccolors: [
									{
										name: 'active-content-bg-color',
										label: l10n.content_area_bg_label
									},
								]
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'static',
								title: '',
								fields: {
									use: 'global-useborder',
									width: 'global-borderwidth',
									type: 'global-bordertype',
									color: 'global-bordercolor',
								}
							}
						}
					],
					Static: [
						{
							moduleType: 'Colors',
							toggle: false,
							options: {
								title: l10n.colors_label,
								abccolors: [
									{
										name: 'static-header-bg-color',
										label: l10n.header_bg_label
									},
									{
										name: 'static-triangle-icon-color',
										label: l10n.triangle_icon_label
									}
								]
							}
						},
						{
							moduleType: 'Typography',
							toggle: false,
							options: {
								state: 'static',
								title: l10n.typography_tab_label,
								fields: {
									typeface: 'static-font-family',
									fontstyle: 'static-font-style',
									weight: 'static-weight',
									style: 'static-style',
									size: 'static-font-size',
									line_height: 'static-line-height',
									color: 'static-font-color',
								}
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'static',
								title: '',
								fields: {
									use: 'static-useborder',
									width: 'static-borderwidth',
									type: 'static-bordertype',
									color: 'static-bordercolor',
								}
							}
						}
					],
					Hover: [
						{
							moduleType: 'Colors',
							options: {
								title: l10n.colors_label,
								toggle: true,
								prepend: 'hover-',
								prefix: 'static',
								fields: {
									use: 'hover-use-colors'
								},
								abccolors: [
									{
										name: 'hover-header-bg-color',
										label: l10n.header_bg_label
									},
									{
										name: 'hover-triangle-icon-color',
										label: l10n.triangle_icon_label
									}
								]
							}
						},
						{
							moduleType: 'Typography',
							options: {
								state: 'hover',
								toggle: true,
								prepend: 'hover-',
								prefix: 'static',
								title: l10n.typography_tab_label,
								fields: {
									use: 'hover-use-typography',
									typeface: 'hover-font-family',
									fontstyle: 'hover-font-style',
									weight: 'hover-weight',
									style: 'hover-style',
									size: 'hover-font-size',
									line_height: 'hover-line-height',
									color: 'hover-font-color',
								}
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'hover',
								title: '',
								prepend: 'hover-',
								prefix: 'static',
								fields: {
									use: 'hover-useborder',
									width: 'hover-borderwidth',
									type: 'hover-bordertype',
									color: 'hover-bordercolor',
								}
							}
						},
						{
							moduleType: 'HovAnimation',
							options: {
								state: 'hover',
								title: '',
								toggle: true,
								fields: {
									use: 'hover-use-animation',
									duration: 'hover-transition-duration',
									easing: 'hover-transition-easing',
								}
							}
						}
					],
					Active: [
						{
							moduleType: 'Colors',
							options: {
								title: l10n.colors_label,
								toggle: true,
								prepend: 'active-',
								prefix: 'static',
								fields: {
									use: 'active-use-color'
								},
								abccolors: [
									{
										name: 'active-header-bg-color',
										label: l10n.header_bg_label
									},
									{
										name: 'active-triangle-icon-color',
										label: l10n.triangle_icon_label
									}
								]
							}
						},
						{
							moduleType: 'Typography',
							options: {
								state: 'active',
								toggle: true,
								prepend: 'active-',
								prefix: 'static',
								title: l10n.typography_tab_label,
								fields: {
									use: 'active-use-typography',
									typeface: 'active-font-family',
									fontstyle: 'active-font-style',
									weight: 'active-weight',
									style: 'active-style',
									size: 'active-font-size',
									line_height: 'active-line-height',
									color: 'active-font-color',
								}
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'active',
								title: '',
								prepend: 'active-',
								prefix: 'static',
								fields: {
									use: 'active-useborder',
									width: 'active-borderwidth',
									type: 'active-bordertype',
									color: 'active-bordercolor',
								}
							}
						}
					]
				},
				
				migratePresetProperties: function(newPreset) {
					
					var preset = this.property('preset') ? this.clear_preset_name(this.property('preset')) : 'default',
						props = this.presets.findWhere({id: preset}),
						obj = {};

					_.each(props.attributes, function(preset_value, index) {
						
						if(index === 'id' || index === 'name' || index === 'theme_preset') {
							return;
						}
						
						obj[index] = preset_value;
					});
					
					//Migrate properties from existing preset
					newPreset.set(obj);
				},
			}
		},
		title: 'Accordion Settings'
	});

	// Generate presets styles to page
	Util.generatePresetsToPage('accordion', styleTpl);

	return AccordionSettings;
});


define('text!elements/upfront-accordion/tpl/uaccordion.html',[],function () { return '<div class="upfront-accordion-container accordion-preset-<?php echo $preset ?>">\r\n\t<div class="upfront-accordion-wrap">\r\n        <!-- <b class="upfront-entity_meta upfront-ui">\r\n            <a href="#" class="upfront-icon-button upfront-icon-button-accordion-add-panel accordion-add-panel"></a>\r\n        </b> -->\r\n        <?php for ($i = 0; $i < $accordion_count; $i++) { ?>\r\n        <div class="accordion-panel <?php if($i === 0) { ?>accordion-panel-active<?php } ?>">\r\n            <div class="accordion-panel-title" id="title_<?php echo $element_id ?>-<?php echo $i ?>"><?php echo $accordion[$i][\'title\'] ?></div>\r\n            <div id="<?php echo $element_id ?>-<?php echo $i ?>" class="accordion-panel-content">\r\n                <?php echo $accordion[$i][\'content\'] ?>\r\n            </div>\r\n            <i>x</i>\r\n        </div>\r\n        <?php } ?>\r\n    </div>\r\n</div>\r\n';});

(function ($) {
define('uaccordion',[
	'elements/upfront-accordion/js/model',
	'elements/upfront-accordion/js/element',
	'elements/upfront-accordion/js/settings',
	'scripts/upfront/preset-settings/util',
	'text!elements/upfront-accordion/tpl/uaccordion.html',
	'text!elements/upfront-accordion/tpl/preset-style.html'
], function(UaccordionModel, AccordionElement, AccordionSettings, PresetUtil, accordionTpl, settingsStyleTpl) {

	var l10n = Upfront.Settings.l10n.accordion_element;

	var UaccordionView = Upfront.Views.ObjectView.extend({
		model: UaccordionModel,
		currentEditItem: '',
		accordionTpl: Upfront.Util.template(accordionTpl),
		elementSize: {width: 0, height: 0},

		initialize: function(){
			if(! (this.model instanceof UaccordionModel)){
				this.model = new UaccordionModel({properties: this.model.get('properties')});
			}
			this.events = _.extend({}, this.events, {
				// 'click .accordion-add-panel': 'addPanel',
				'click .accordion-panel-title': 'onPanelTitleClick',
				'dblclick .accordion-panel-active .accordion-panel-content': 'onContentDblclick',
				'click i': 'deletePanel'
			});
			this.delegateEvents();

			this.model.get('properties').bind('change', this.render, this);
			this.model.get('properties').bind('change', this.handle_visual_padding_hint, this);
			this.model.get('properties').bind('add', this.render, this);
			this.model.get('properties').bind('remove', this.render, this);


			//this.on('deactivated', this.onDeactivate, this);
			Upfront.Events.on('entity:deactivated', this.stopEdit, this);

			this.listenTo(Upfront.Events, "theme_colors:update", this.update_colors, this);
		},
		update_colors: function () {
			var me = this,
				preset = this.model.get_property_value_by_name("preset"),
				props = PresetUtil.getPresetProperties('accordion', preset) || {}
			;
			
			if (_.size(props) <= 0) return false; // No properties, carry on

			PresetUtil.updatePresetStyle('accordion', props, settingsStyleTpl);

		},
		stopEdit: function() {
			var $panelcontent = this.$el.find('.accordion-panel-active .accordion-panel-content');
			$panelcontent.each(function () {
				var $me = $(this),
					editor = $me.data('ueditor');

				if (editor && editor.stop) {
					editor.stop();
				}
			});

			var $paneltitle = this.$el.find('.accordion-panel-active .accordion-panel-title:not(.ueditor-placeholder)');
			$paneltitle.trigger('blur');

			Upfront.Events.trigger('upfront:element:edit:stop');

		},
		addPanel: function(event) {
			event.preventDefault();
			this.property('accordion').push({
				title: l10n.panel_label + ' ' + (1 + this.property('accordion_count')),
				content: l10n.content_label + ' ' + (1 + this.property('accordion_count'))
			});
			this.property('accordion_count', this.property('accordion').length, false);
		},

		deletePanel: function(event) {
			var element = $(event.currentTarget);
			var panel = element.parents('.accordion-panel');
			var id = panel.index();
			this.property('accordion').splice(id, 1);
			this.property('accordion_count', this.property('accordion_count') - 1, false);
		},



		onPanelTitleClick: function(event) {
			var $panelTitle = $(event.currentTarget);
			if($panelTitle.parent().hasClass('accordion-panel-active')) {
				var titleUeditor = $panelTitle.data('ueditor');
				if(titleUeditor) {
					if(!titleUeditor.active)
						titleUeditor.start();
				}
				
			} else {
				this.$el.find('.accordion-panel-content').each(function () {
					var ed = $(this).data('ueditor');
					if (ed) {
						ed.stop();
					}
				});

				$panelTitle.parent().addClass('accordion-panel-active').find('.accordion-panel-content').slideDown();
				$panelTitle.parent().siblings().removeClass('accordion-panel-active').find('.accordion-panel-content').slideUp();

			}
		},

		onContentDblclick: function(event) {
			if($(event.target).data('ueditor')) {
				$(event.target).data('ueditor').start();
			} else {
				event.stopPropagation();
			}
		},

		saveTitle: function(target) {
			//var id = target.closest('div.accordion-panel').index()-1;
			var id = target.closest('div.accordion-panel').index(); // Index is zero-based!!! https://api.jquery.com/index/
			this.property('accordion')[id].title = target.html();
		},

		savePanelContent: function() {
			var panel = this.$el.find('.accordion-panel-active'),
				$content = panel.find('.accordion-panel-content'),
				panelId = panel.index(),
				ed = $content.data('ueditor'),
				text = ''
			;
			try { text = ed.getValue(true); } catch (e) { text = ''; }

			this.property('accordion')[panelId].content = text || $content.html();
			if (text) {
				this.render();
			}
		},


		get_content_markup: function () {
			var props = this.extract_properties();

			props.preset = props.preset || 'default';
			props.show_add = true;
			props.show_remove = this.property('accordion_count') > 1 ? true : false;

			return this.accordionTpl(props);
		},

		extract_properties: function() {
			var props = {};
			this.model.get('properties').each(function(prop){
				props[prop.get('name')] = prop.get('value');
			});
			return props;
		},

		on_render: function() {
			// Accordion won't be rendered in time if you do not delay.
			//_.delay(function(self) {

			//	, 10, this);
			var count = 1;
			var self = this;
			this.$el.find('.accordion-panel-title').each(function() {
				if ($(this).data('ueditor')) {
					return true;
				}
				var $content = $(this);
				$(this).ueditor({
					linebreaks: true,
					disableLineBreak: true,
					airButtons: false,
					allowedTags: ['h5'],
					placeholder: 'Panel '+count
				})
					.on('start', function(){
						self.$el.parent().parent().parent().draggable('disable');
						Upfront.Events.trigger('upfront:element:edit:start', 'text');
					})
					.on('stop', function(){
						self.$el.parent().parent().parent().draggable('enable');
						Upfront.Events.trigger('upfront:element:edit:stop');
					})
					.on('syncAfter', function(){
						self.saveTitle($(this));
					})
					.on('keydown', function(e){
						if (e.which === 9) {
							e.preventDefault();
							self.editContent();
						}
					})
					.on('blur', function() {
						$content.data('ueditor').stop();
					})
					.addClass('uf-click-to-edit-text');

				$(this).data('ueditor').stop();
				count++;
			});
			self.$el.find('.accordion-panel-content').each(function() {
				var $me = $(this);
				if ($me.data('ueditor')) {
					return true;
				}
				$me.ueditor({
						linebreaks: false,
						inserts: {},
						autostart: false
				})
				.on('start', function(){
					//self.$el.parent().parent().parent().draggable('enable');
					Upfront.Events.trigger('upfront:element:edit:start', 'text');
				})
				.on('stop', function(){
					//self.$el.parent().parent().parent().draggable('enable');
					self.savePanelContent();
					Upfront.Events.trigger('upfront:element:edit:stop');
				})
				.on('syncAfter', function(){
					//console.log('edited');
					//self.model.set_content($(this).html(), {silent: true});
				})
				.on('blur', function() {
					//$(this).data('ueditor').stop();
				});
			});
			self.$el.find('.accordion-panel:not(.accordion-panel-active) .accordion-panel-content').hide();

			this.$el.find('.accordion-panel:not(.accordion-panel-active) .accordion-panel-content').hide();

		},

		editContent: function() {
			this.$el.find('.accordion-panel-active .accordion-panel-content').data('ueditor').start();
			setTimeout(function() {
				Upfront.Events.trigger('upfront:element:edit:start');
			}, 250);
		},

		addTooltips: function() {
			$('.accordion-panel').each(function() {
				var span = $(this).find('span')[0];
				if (span.offsetWidth < span.scrollWidth) {
					$(this).attr('title', $(span).text().trim());
				}
			});
		},

		property: function(name, value, silent) {
			if(typeof value !== 'undefined'){
				if(typeof silent === 'undefined') {
					silent = true;
				}
				return this.model.set_property(name, value, silent);
			}
			return this.model.get_property_value_by_name(name);
		},

		getControlItems: function(){
			return _([
				this.createControl('add', l10n.add_panel, 'addPanel'),
				this.createPaddingControl(),
				this.createControl('settings', l10n.settings, 'on_settings_click')
			]);
		}
	});

		Upfront.Application.LayoutEditor.add_object('Uaccordion', {
			'Model': UaccordionModel,
			'View': UaccordionView,
			'Element': AccordionElement,
			'Settings': AccordionSettings,
			'anchor': {
				is_target: false
			},
			cssSelectors: {
				'.accordion-panel': {label: l10n.css.containers_label, info: l10n.css.containers_info},
				'.accordion-panel-title': {label: l10n.css.header_label, info: l10n.css.header_info},
				'.accordion-panel-active .accordion-panel-title': {label: l10n.css.active_header_label, info: l10n.css.active_header_info},
				'.accordion-panel-content': {label: l10n.css.body_label, info: l10n.css.body_info},
				'.accordion-panel:first-of-type' : {label: l10n.css.first_label, info: l10n.css.first_info},
				'.accordion-panel:last-child' : {label: l10n.css.last_label, info: l10n.css.last_info},
				'.accordion-panel:nth-child(2n+3)' : {label: l10n.css.odd_label, info: l10n.css.odd_info},
				'.accordion-panel:nth-child(2n)' : {label: l10n.css.even_label, info: l10n.css.even_info},
				'.upfront-accordion-wrap': {label: l10n.css.wrap, info: l10n.css.wrap_info}
			},
			cssSelectorsId: Upfront.data.uaccordion.defaults.type
		});

		Upfront.Models.UaccordionModel = UaccordionModel;
		Upfront.Views.UaccordionView = UaccordionView;

}); //End require

})(jQuery);

/*
    Redactor v10.0.9
    Updated: March 16, 2015

    http://imperavi.com/redactor/

    Copyright (c) 2009-2015, Imperavi LLC.
    License: http://imperavi.com/redactor/license/

    Usage: $('#content').redactor();
*/

(function($)
{
    'use strict';

    if (!Function.prototype.bind)
    {
        Function.prototype.bind = function(scope)
        {
            var fn = this;
            return function()
            {
                return fn.apply(scope);
            };
        };
    }

    var uuid = 0;

    var reUrlYoutube = /https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube\.com\S*[^\w\-\s])([\w\-]{11})(?=[^\w\-]|$)(?![?=&+%\w.\-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/ig;
    var reUrlVimeo = /https?:\/\/(www\.)?vimeo.com\/(\d+)($|\/)/;

    // Plugin
    $.fn.redactor = function(options)
    {
        var val = [];
        var args = Array.prototype.slice.call(arguments, 1);

        if (typeof options === 'string')
        {
            this.each(function()
            {
                var instance = $.data(this, 'redactor');
                var func;

                if (options.search(/\./) != '-1')
                {
                    func = options.split('.');
                    if (typeof instance[func[0]] != 'undefined')
                    {
                        func = instance[func[0]][func[1]];
                    }
                }
                else
                {
                    func = instance[options];
                }

                if (typeof instance !== 'undefined' && $.isFunction(func))
                {
                    var methodVal = func.apply(instance, args);
                    if (methodVal !== undefined && methodVal !== instance)
                    {
                        val.push(methodVal);
                    }
                }
                else
                {
                    $.error('No such method "' + options + '" for Redactor');
                }
            });
        }
        else
        {
            this.each(function()
            {
                $.data(this, 'redactor', {});
                $.data(this, 'redactor', Redactor(this, options));
            });
        }

        if (val.length === 0) return this;
        else if (val.length === 1) return val[0];
        else return val;

    };

    // Initialization
    function Redactor(el, options)
    {
        return new Redactor.prototype.init(el, options);
    }

    // Functionality
    $.Redactor = Redactor;
    $.Redactor.VERSION = '10.0.9';
    $.Redactor.modules = ['alignment', 'autosave', 'block', 'buffer', 'build', 'button',
                          'caret', 'clean', 'code', 'core', 'dropdown', 'file', 'focus',
                          'image', 'indent', 'inline', 'insert', 'keydown', 'keyup',
                          'lang', 'line', 'link', 'list', 'modal', 'observe', 'paragraphize',
                          'paste', 'placeholder', 'progress', 'selection', 'shortcuts',
                          'tabifier', 'tidy',  'toolbar', 'upload', 'utils'];

    $.Redactor.opts = {

        // settings
        lang: 'en',
        direction: 'ltr', // ltr or rtl

        plugins: false, // array

        focus: false,
        focusEnd: false,

        placeholder: false,

        visual: true,
        tabindex: false,

        minHeight: false,
        maxHeight: false,

        linebreaks: false,
        replaceDivs: true,
        paragraphize: true,
        cleanStyleOnEnter: false,
        enterKey: true,

        cleanOnPaste: true,
        cleanSpaces: true,
        pastePlainText: false,

        autosave: false, // false or url
        autosaveName: false,
        autosaveInterval: 60, // seconds
        autosaveOnChange: false,
        autosaveFields: false,

        linkTooltip: true,
        linkProtocol: 'http',
        linkNofollow: false,
        linkSize: 50,

        imageEditable: true,
        imageLink: true,
        imagePosition: true,
        imageFloatMargin: '10px',
        imageResizable: true,

        imageUpload: null,
        imageUploadParam: 'file',

        uploadImageField: false,

        dragImageUpload: true,

        fileUpload: null,
        fileUploadParam: 'file',

        dragFileUpload: true,

        s3: false,

        convertLinks: true,
        convertUrlLinks: true,
        convertImageLinks: true,
        convertVideoLinks: true,

        preSpaces: 4, // or false
        tabAsSpaces: false, // true or number of spaces
        tabKey: true,

        scrollTarget: false,

        toolbar: true,
        toolbarFixed: true,
        toolbarFixedTarget: document,
        toolbarFixedTopOffset: 0, // pixels
        toolbarExternal: false, // ID selector
        toolbarOverflow: false,

        source: true,
        buttons: ['html', 'formatting', 'bold', 'italic', 'deleted', 'unorderedlist', 'orderedlist',
                  'outdent', 'indent', 'image', 'file', 'link', 'alignment', 'horizontalrule'], // + 'underline'

        buttonsHide: [],
        buttonsHideOnMobile: [],

        formatting: ['p', 'blockquote', 'pre', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'],
        formattingAdd: false,

        tabifier: true,

        deniedTags: ['script', 'style'],
        allowedTags: false, // or array

        removeComments: false,
        replaceTags: [
            ['strike', 'del']
        ],
        replaceStyles: [
            ['font-weight:\\s?bold', "strong"],
            ['font-style:\\s?italic', "em"],
            ['text-decoration:\\s?underline', "u"],
            ['text-decoration:\\s?line-through', 'del']
        ],
        removeDataAttr: false,

        removeAttr: false, // or multi array
        allowedAttr: false, // or multi array

        removeWithoutAttr: ['span'], // or false
        removeEmpty: ['p'], // or false;

        activeButtons: ['deleted', 'italic', 'bold', 'underline', 'unorderedlist', 'orderedlist',
                        'alignleft', 'aligncenter', 'alignright', 'justify'],
        activeButtonsStates: {
            b: 'bold',
            strong: 'bold',
            i: 'italic',
            em: 'italic',
            del: 'deleted',
            strike: 'deleted',
            ul: 'unorderedlist',
            ol: 'orderedlist',
            u: 'underline'
        },

        shortcuts: {
            'ctrl+shift+m, meta+shift+m': { func: 'inline.removeFormat' },
            'ctrl+b, meta+b': { func: 'inline.format', params: ['bold'] },
            'ctrl+i, meta+i': { func: 'inline.format', params: ['italic'] },
            'ctrl+h, meta+h': { func: 'inline.format', params: ['superscript'] },
            'ctrl+l, meta+l': { func: 'inline.format', params: ['subscript'] },
            'ctrl+k, meta+k': { func: 'link.show' },
            'ctrl+shift+7':   { func: 'list.toggle', params: ['orderedlist'] },
            'ctrl+shift+8':   { func: 'list.toggle', params: ['unorderedlist'] }
        },
        shortcutsAdd: false,

        // private
        buffer: [],
        rebuffer: [],
        emptyHtml: '<p>&#x200b;</p>',
        invisibleSpace: '&#x200b;',
        imageTypes: ['image/png', 'image/jpeg', 'image/gif'],
        indentValue: 20,
        verifiedTags:       ['a', 'img', 'b', 'strong', 'sub', 'sup', 'i', 'em', 'u', 'small', 'strike', 'del', 'cite', 'ul', 'ol', 'li'], // and for span tag special rule
        inlineTags:         ['strong', 'b', 'u', 'em', 'i', 'code', 'del', 'ins', 'samp', 'kbd', 'sup', 'sub', 'mark', 'var', 'cite', 'small'],
        alignmentTags:      ['P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6',  'DL', 'DT', 'DD', 'DIV', 'TD', 'BLOCKQUOTE', 'OUTPUT', 'FIGCAPTION', 'ADDRESS', 'SECTION', 'HEADER', 'FOOTER', 'ASIDE', 'ARTICLE'],
        blockLevelElements: ['PRE', 'UL', 'OL', 'LI'],


        // lang
        langs: {
            en: {
                html: 'HTML',
                video: 'Insert Video',
                image: 'Insert Image',
                table: 'Table',
                link: 'Link',
                link_insert: 'Insert link',
                link_edit: 'Edit link',
                unlink: 'Unlink',
                formatting: 'Formatting',
                paragraph: 'Normal text',
                quote: 'Quote',
                code: 'Code',
                header1: 'Header 1',
                header2: 'Header 2',
                header3: 'Header 3',
                header4: 'Header 4',
                header5: 'Header 5',
                bold: 'Bold',
                italic: 'Italic',
                fontcolor: 'Font Color',
                backcolor: 'Back Color',
                unorderedlist: 'Unordered List',
                orderedlist: 'Ordered List',
                outdent: 'Outdent',
                indent: 'Indent',
                cancel: 'Cancel',
                insert: 'Insert',
                save: 'Save',
                _delete: 'Delete',
                insert_table: 'Insert Table',
                insert_row_above: 'Add Row Above',
                insert_row_below: 'Add Row Below',
                insert_column_left: 'Add Column Left',
                insert_column_right: 'Add Column Right',
                delete_column: 'Delete Column',
                delete_row: 'Delete Row',
                delete_table: 'Delete Table',
                rows: 'Rows',
                columns: 'Columns',
                add_head: 'Add Head',
                delete_head: 'Delete Head',
                title: 'Title',
                image_position: 'Position',
                none: 'None',
                left: 'Left',
                right: 'Right',
                center: 'Center',
                image_web_link: 'Image Web Link',
                text: 'Text',
                mailto: 'Email',
                web: 'URL',
                video_html_code: 'Video Embed Code or Youtube/Vimeo Link',
                file: 'Insert File',
                upload: 'Upload',
                download: 'Download',
                choose: 'Choose',
                or_choose: 'Or choose',
                drop_file_here: 'Drop file here',
                align_left: 'Align text to the left',
                align_center: 'Center text',
                align_right: 'Align text to the right',
                align_justify: 'Justify text',
                horizontalrule: 'Insert Horizontal Rule',
                deleted: 'Deleted',
                anchor: 'Anchor',
                link_new_tab: 'Open link in new tab',
                underline: 'Underline',
                alignment: 'Alignment',
                filename: 'Name (optional)',
                edit: 'Edit',
                upload_label: 'Drop file here or '

            }
        }
    };

    // Functionality
    Redactor.fn = $.Redactor.prototype = {

        keyCode: {
            BACKSPACE: 8,
            DELETE: 46,
            DOWN: 40,
            ENTER: 13,
            SPACE: 32,
            ESC: 27,
            TAB: 9,
            CTRL: 17,
            META: 91,
            SHIFT: 16,
            ALT: 18,
            RIGHT: 39,
            LEFT: 37,
            LEFT_WIN: 91
        },

        // Initialization
        init: function(el, options)
        {
            this.$element = $(el);
            this.uuid = uuid++;

            // if paste event detected = true
            this.rtePaste = false;
            this.$pasteBox = false;

            this.loadOptions(options);
            this.loadModules();

            // formatting storage
            this.formatting = {};

            // block level tags
            $.merge(this.opts.blockLevelElements, this.opts.alignmentTags);
            this.reIsBlock = new RegExp('^(' + this.opts.blockLevelElements.join('|' ) + ')$', 'i');

            // setup allowed and denied tags
            this.tidy.setupAllowed();

            // setup denied tags
            if (this.opts.deniedTags !== false)
            {
                var tags = ['html', 'head', 'link', 'body', 'meta', 'applet'];
                for (var i = 0; i < tags.length; i++)
                {
                    this.opts.deniedTags.push(tags[i]);
                }
            }

            // load lang
            this.lang.load();

            // extend shortcuts
            $.extend(this.opts.shortcuts, this.opts.shortcutsAdd);

            // start callback
            this.core.setCallback('start');

            // build
            this.start = true;
            this.build.run();
        },

        loadOptions: function(options)
        {
            this.opts = $.extend(
                {},
                $.extend(true, {}, $.Redactor.opts),
                this.$element.data(),
                options
            );
        },
        getModuleMethods: function(object)
        {
            return Object.getOwnPropertyNames(object).filter(function(property)
            {
                return typeof object[property] == 'function';
            });
        },
        loadModules: function()
        {
            var len = $.Redactor.modules.length;
            for (var i = 0; i < len; i++)
            {
                this.bindModuleMethods($.Redactor.modules[i]);
            }
        },
        bindModuleMethods: function(module)
        {
            if (typeof this[module] == 'undefined') return;

            // init module
            this[module] = this[module]();

            var methods = this.getModuleMethods(this[module]);
            var len = methods.length;

            // bind methods
            for (var z = 0; z < len; z++)
            {
                this[module][methods[z]] = this[module][methods[z]].bind(this);
            }
        },

        alignment: function()
        {
            return {
                left: function()
                {
                    this.alignment.set('');
                },
                right: function()
                {
                    this.alignment.set('right');
                },
                center: function()
                {
                    this.alignment.set('center');
                },
                justify: function()
                {
                    this.alignment.set('justify');
                },
                set: function(type)
                {
                    // focus
                    if (!this.utils.browser('msie')) this.$editor.focus();

                    this.buffer.set();
                    this.selection.save();

                    // get blocks
                    this.alignment.blocks = this.selection.getBlocks();
                    this.alignment.type = type;

                    // set alignment
                    if (this.alignment.isLinebreaksOrNoBlocks())
                    {
                        this.alignment.setText();
                    }
                    else
                    {
                        this.alignment.setBlocks();
                    }

                    // sync
                    this.selection.restore();
                    this.code.sync();
                },
                setText: function()
                {
                    var wrapper = this.selection.wrap('div');
                    $(wrapper).attr('data-tagblock', 'redactor').css('text-align', this.alignment.type);
                },
                setBlocks: function()
                {
                    $.each(this.alignment.blocks, $.proxy(function(i, el)
                    {
                        var $el = this.utils.getAlignmentElement(el);
                        if (!$el) return;

                        if (this.alignment.isNeedReplaceElement($el))
                        {
                            this.alignment.replaceElement($el);
                        }
                        else
                        {
                            this.alignment.alignElement($el);
                        }

                    }, this));
                },
                isLinebreaksOrNoBlocks: function()
                {
                    return (this.opts.linebreaks && this.alignment.blocks[0] === false);
                },
                isNeedReplaceElement: function($el)
                {
                    return (this.alignment.type === '' && typeof($el.data('tagblock')) !== 'undefined');
                },
                replaceElement: function($el)
                {
                    $el.replaceWith($el.html());
                },
                alignElement: function($el)
                {
                    $el.css('text-align', this.alignment.type);
                    this.utils.removeEmptyAttr($el, 'style');
                }
            };
        },
        autosave: function()
        {
            return {
                enable: function()
                {
                    if (!this.opts.autosave) return;

                    this.autosave.html = false;
                    this.autosave.name = (this.opts.autosaveName) ? this.opts.autosaveName : this.$textarea.attr('name');

                    if (this.opts.autosaveOnChange) return;
                    this.autosaveInterval = setInterval(this.autosave.load, this.opts.autosaveInterval * 1000);
                },
                onChange: function()
                {
                    if (!this.opts.autosaveOnChange) return;
                    this.autosave.load();
                },
                load: function()
                {
                    this.autosave.source = this.code.get();

                    if (this.autosave.html === this.autosave.source) return;
                    if (this.utils.isEmpty(this.autosave.source)) return;

                    // data
                    var data = {};
                    data['name'] = this.autosave.name;
                    data[this.autosave.name] = this.autosave.source;
                    data = this.autosave.getHiddenFields(data);

                    // ajax
                    var jsxhr = $.ajax({
                        url: this.opts.autosave,
                        type: 'post',
                        data: data
                    });

                    jsxhr.done(this.autosave.success);
                },
                getHiddenFields: function(data)
                {
                    if (this.opts.autosaveFields === false || typeof this.opts.autosaveFields !== 'object')
                    {
                        return data;
                    }

                    $.each(this.opts.autosaveFields, $.proxy(function(k, v)
                    {
                        if (v !== null && v.toString().indexOf('#') === 0) v = $(v).val();
                        data[k] = v;

                    }, this));

                    return data;

                },
                success: function(data)
                {
                    var json;
                    try
                    {
                        json = $.parseJSON(data);
                    }
                    catch(e)
                    {
                        //data has already been parsed
                        json = data;
                    }

                    var callbackName = (typeof json.error == 'undefined') ? 'autosave' :  'autosaveError';

                    this.core.setCallback(callbackName, this.autosave.name, json);
                    this.autosave.html = this.autosave.source;
                },
                disable: function()
                {
                    clearInterval(this.autosaveInterval);
                }
            };
        },
        block: function()
        {
            return {
                formatting: function(name)
                {
                    this.block.clearStyle = false;
                    var type, value;

                    if (typeof this.formatting[name].data != 'undefined') type = 'data';
                    else if (typeof this.formatting[name].attr != 'undefined') type = 'attr';
                    else if (typeof this.formatting[name]['class'] != 'undefined') type = 'class';

                    if (typeof this.formatting[name].clear != 'undefined')
                    {
                        this.block.clearStyle = true;
                    }

                    if (type) value = this.formatting[name][type];

                    this.block.format(this.formatting[name].tag, type, value);

                },
                format: function(tag, type, value)
                {
                    if (tag == 'quote') tag = 'blockquote';

                    var formatTags = ['p', 'pre', 'blockquote', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'];
                    if ($.inArray(tag, formatTags) == -1) return;

                    this.block.isRemoveInline = (tag == 'pre' || tag.search(/h[1-6]/i) != -1);

                    // focus
                    if (!this.utils.browser('msie')) this.$editor.focus();

                    this.block.blocks = this.selection.getBlocks();

                    this.block.blocksSize = this.block.blocks.length;
                    this.block.type = type;
                    this.block.value = value;

                    this.buffer.set();
                    this.selection.save();

                    this.block.set(tag);

                    this.selection.restore();
                    this.code.sync();

                },
                set: function(tag)
                {
                    this.selection.get();
                    this.block.containerTag = this.range.commonAncestorContainer.tagName;

                    if (this.range.collapsed)
                    {
                        this.block.setCollapsed(tag);
                    }
                    else
                    {
                        this.block.setMultiple(tag);
                    }
                },
                setCollapsed: function(tag)
                {
                    var block = this.block.blocks[0];
                    if (block === false) return;

                    if (block.tagName == 'LI')
                    {
                        if (tag != 'blockquote') return;

                        this.block.formatListToBlockquote();
                        return;
                    }

                    var isContainerTable = (this.block.containerTag  == 'TD' || this.block.containerTag  == 'TH');
                    if (isContainerTable && !this.opts.linebreaks)
                    {

                        document.execCommand('formatblock', false, '<' + tag + '>');

                        block = this.selection.getBlock();
                        this.block.toggle($(block));

                    }
                    else if (block.tagName.toLowerCase() != tag)
                    {
                        if (this.opts.linebreaks && tag == 'p')
                        {
                            $(block).prepend('<br>').append('<br>');
                            this.utils.replaceWithContents(block);
                        }
                        else
                        {
                            var $formatted = this.utils.replaceToTag(block, tag);

                            this.block.toggle($formatted);

                            if (tag != 'p' && tag != 'blockquote') $formatted.find('img').remove();
                            if (this.block.isRemoveInline) this.utils.removeInlineTags($formatted);
                            if (tag == 'p' || this.block.headTag) $formatted.find('p').contents().unwrap();

                            this.block.formatTableWrapping($formatted);
                        }
                    }
                    else if (tag == 'blockquote' && block.tagName.toLowerCase() == tag)
                    {
                        // blockquote off
                        if (this.opts.linebreaks)
                        {
                            $(block).prepend('<br>').append('<br>');
                            this.utils.replaceWithContents(block);
                        }
                        else
                        {
                            var $el = this.utils.replaceToTag(block, 'p');
                            this.block.toggle($el);
                        }
                    }
                    else if (block.tagName.toLowerCase() == tag)
                    {
                        this.block.toggle($(block));
                    }

                    if (typeof this.block.type == 'undefined' && typeof this.block.value == 'undefined')
                    {
                        $(block).removeAttr('class').removeAttr('style');
                    }

                },
                setMultiple: function(tag)
                {
                    var block = this.block.blocks[0];
                    var isContainerTable = (this.block.containerTag  == 'TD' || this.block.containerTag  == 'TH');

                    if (block !== false && this.block.blocksSize === 1)
                    {
                        if (block.tagName.toLowerCase() == tag &&  tag == 'blockquote')
                        {
                            // blockquote off
                            if (this.opts.linebreaks)
                            {
                                $(block).prepend('<br>').append('<br>');
                                this.utils.replaceWithContents(block);
                            }
                            else
                            {
                                var $el = this.utils.replaceToTag(block, 'p');
                                this.block.toggle($el);
                            }
                        }
                        else if (block.tagName == 'LI')
                        {
                            if (tag != 'blockquote') return;

                            this.block.formatListToBlockquote();
                        }
                        else if (this.block.containerTag == 'BLOCKQUOTE')
                        {
                            this.block.formatBlockquote(tag);
                        }
                        else if (this.opts.linebreaks && ((isContainerTable) || (this.range.commonAncestorContainer != block)))
                        {
                            this.block.formatWrap(tag);
                        }
                        else
                        {
                            if (this.opts.linebreaks && tag == 'p')
                            {
                                $(block).prepend('<br>').append('<br>');
                                this.utils.replaceWithContents(block);
                            }
                            else if (block.tagName === 'TD')
                            {
                                this.block.formatWrap(tag);
                            }
                            else
                            {
                                var $formatted = this.utils.replaceToTag(block, tag);

                                this.block.toggle($formatted);

                                if (this.block.isRemoveInline) this.utils.removeInlineTags($formatted);
                                if (tag == 'p' || this.block.headTag) $formatted.find('p').contents().unwrap();
                            }
                        }
                    }
                    else
                    {

                        if (this.opts.linebreaks || tag != 'p')
                        {
                            if (tag == 'blockquote')
                            {
                                var count = 0;
                                for (var i = 0; i < this.block.blocksSize; i++)
                                {
                                    if (this.block.blocks[i].tagName == 'BLOCKQUOTE') count++;
                                }

                                // only blockquote selected
                                if (count == this.block.blocksSize)
                                {
                                    $.each(this.block.blocks, $.proxy(function(i,s)
                                    {
                                        var $formatted = false;
                                        if (this.opts.linebreaks)
                                        {
                                            $(s).prepend('<br>').append('<br>');
                                            $formatted = this.utils.replaceWithContents(s);
                                        }
                                        else
                                        {
                                            $formatted = this.utils.replaceToTag(s, 'p');
                                        }

                                        if ($formatted && typeof this.block.type == 'undefined' && typeof this.block.value == 'undefined')
                                        {
                                            $formatted.removeAttr('class').removeAttr('style');
                                        }

                                    }, this));

                                    return;
                                }

                            }


                            this.block.formatWrap(tag);
                        }
                        else
                        {
                            var classSize = 0;
                            var toggleType = false;
                            if (this.block.type == 'class')
                            {
                                toggleType = 'toggle';
                                classSize = $(this.block.blocks).filter('.' + this.block.value).length;

                                if (this.block.blocksSize == classSize) toggleType = 'toggle';
                                else if (this.block.blocksSize > classSize) toggleType = 'set';
                                else if (classSize === 0) toggleType = 'set';

                            }

                            var exceptTags = ['ul', 'ol', 'li', 'td', 'th', 'dl', 'dt', 'dd'];
                            $.each(this.block.blocks, $.proxy(function(i,s)
                            {
                                if ($.inArray(s.tagName.toLowerCase(), exceptTags) != -1) return;

                                var $formatted = this.utils.replaceToTag(s, tag);

                                if (toggleType)
                                {
                                    if (toggleType == 'toggle') this.block.toggle($formatted);
                                    else if (toggleType == 'remove') this.block.remove($formatted);
                                    else if (toggleType == 'set') this.block.setForce($formatted);
                                }
                                else this.block.toggle($formatted);

                                if (tag != 'p' && tag != 'blockquote') $formatted.find('img').remove();
                                if (this.block.isRemoveInline) this.utils.removeInlineTags($formatted);
                                if (tag == 'p' || this.block.headTag) $formatted.find('p').contents().unwrap();

                                if (typeof this.block.type == 'undefined' && typeof this.block.value == 'undefined')
                                {
                                    $formatted.removeAttr('class').removeAttr('style');
                                }


                            }, this));
                        }
                    }
                },
                setForce: function($el)
                {
                    // remove style and class if the specified setting
                    if (this.block.clearStyle)
                    {
                        $el.removeAttr('class').removeAttr('style');
                    }

                    if (this.block.type == 'class')
                    {
                        $el.addClass(this.block.value);
                        return;
                    }
                    else if (this.block.type == 'attr' || this.block.type == 'data')
                    {
                        $el.attr(this.block.value.name, this.block.value.value);
                        return;
                    }
                },
                toggle: function($el)
                {
                    // remove style and class if the specified setting
                    if (this.block.clearStyle)
                    {
                        $el.removeAttr('class').removeAttr('style');
                    }

                    if (this.block.type == 'class')
                    {
                        $el.toggleClass(this.block.value);
                        return;
                    }
                    else if (this.block.type == 'attr' || this.block.type == 'data')
                    {
                        if ($el.attr(this.block.value.name) == this.block.value.value)
                        {
                            $el.removeAttr(this.block.value.name);
                        }
                        else
                        {
                            $el.attr(this.block.value.name, this.block.value.value);
                        }

                        return;
                    }
                    else
                    {
                        $el.removeAttr('style class');
                        return;
                    }
                },
                remove: function($el)
                {
                    $el.removeClass(this.block.value);
                },
                formatListToBlockquote: function()
                {
                    var block = $(this.block.blocks[0]).closest('ul, ol');

                    $(block).find('ul, ol').contents().unwrap();
                    $(block).find('li').append($('<br>')).contents().unwrap();

                    var $el = this.utils.replaceToTag(block, 'blockquote');
                    this.block.toggle($el);
                },
                formatBlockquote: function(tag)
                {
                    document.execCommand('outdent');
                    document.execCommand('formatblock', false, tag);

                    this.clean.clearUnverified();
                    this.$editor.find('p:empty').remove();

                    var formatted = this.selection.getBlock();

                    if (tag != 'p')
                    {
                        $(formatted).find('img').remove();
                    }

                    if (!this.opts.linebreaks)
                    {
                        this.block.toggle($(formatted));
                    }

                    this.$editor.find('ul, ol, tr, blockquote, p').each($.proxy(this.utils.removeEmpty, this));

                    if (this.opts.linebreaks && tag == 'p')
                    {
                        this.utils.replaceWithContents(formatted);
                    }

                },
                formatWrap: function(tag)
                {
                    if (this.block.containerTag == 'UL' || this.block.containerTag == 'OL')
                    {
                        if (tag == 'blockquote')
                        {
                            this.block.formatListToBlockquote();
                        }
                        else
                        {
                            return;
                        }
                    }

                    var formatted = this.selection.wrap(tag);
                    if (formatted === false) return;

                    var $formatted = $(formatted);

                    this.block.formatTableWrapping($formatted);

                    var $elements = $formatted.find(this.opts.blockLevelElements.join(',') + ', td, table, thead, tbody, tfoot, th, tr');

                    if ((this.opts.linebreaks && tag == 'p') || tag == 'pre' || tag == 'blockquote')
                    {
                        $elements.append('<br />');
                    }

                    $elements.contents().unwrap();

                    if (tag != 'p' && tag != 'blockquote') $formatted.find('img').remove();

                    $.each(this.block.blocks, $.proxy(this.utils.removeEmpty, this));

                    $formatted.append(this.selection.getMarker(2));

                    if (!this.opts.linebreaks)
                    {
                        this.block.toggle($formatted);
                    }

                    this.$editor.find('ul, ol, tr, blockquote, p').each($.proxy(this.utils.removeEmpty, this));
                    $formatted.find('blockquote:empty').remove();

                    if (this.block.isRemoveInline)
                    {
                        this.utils.removeInlineTags($formatted);
                    }

                    if (this.opts.linebreaks && tag == 'p')
                    {
                        this.utils.replaceWithContents($formatted);
                    }

                },
                formatTableWrapping: function($formatted)
                {
                    if ($formatted.closest('table').length === 0) return;

                    if ($formatted.closest('tr').length === 0) $formatted.wrap('<tr>');
                    if ($formatted.closest('td').length === 0 && $formatted.closest('th').length === 0)
                    {
                        $formatted.wrap('<td>');
                    }
                },
                removeData: function(name, value)
                {
                    var blocks = this.selection.getBlocks();
                    $(blocks).removeAttr('data-' + name);

                    this.code.sync();
                },
                setData: function(name, value)
                {
                    var blocks = this.selection.getBlocks();
                    $(blocks).attr('data-' + name, value);

                    this.code.sync();
                },
                toggleData: function(name, value)
                {
                    var blocks = this.selection.getBlocks();
                    $.each(blocks, function()
                    {
                        if ($(this).attr('data-' + name))
                        {
                            $(this).removeAttr('data-' + name);
                        }
                        else
                        {
                            $(this).attr('data-' + name, value);
                        }
                    });
                },
                removeAttr: function(attr, value)
                {
                    var blocks = this.selection.getBlocks();
                    $(blocks).removeAttr(attr);

                    this.code.sync();
                },
                setAttr: function(attr, value)
                {
                    var blocks = this.selection.getBlocks();
                    $(blocks).attr(attr, value);

                    this.code.sync();
                },
                toggleAttr: function(attr, value)
                {
                    var blocks = this.selection.getBlocks();
                    $.each(blocks, function()
                    {
                        if ($(this).attr(name))
                        {
                            $(this).removeAttr(name);
                        }
                        else
                        {
                            $(this).attr(name, value);
                        }
                    });
                },
                removeClass: function(className)
                {
                    var blocks = this.selection.getBlocks();
                    $(blocks).removeClass(className);

                    this.utils.removeEmptyAttr(blocks, 'class');

                    this.code.sync();
                },
                setClass: function(className)
                {
                    var blocks = this.selection.getBlocks();
                    $(blocks).addClass(className);

                    this.code.sync();
                },
                toggleClass: function(className)
                {
                    var blocks = this.selection.getBlocks();
                    $(blocks).toggleClass(className);

                    this.code.sync();
                }
            };
        },
        buffer: function()
        {
            return {
                set: function(type)
                {
                    if (typeof type == 'undefined' || type == 'undo')
                    {
                        this.buffer.setUndo();
                    }
                    else
                    {
                        this.buffer.setRedo();
                    }
                },
                setUndo: function()
                {
                    this.selection.save();
                    this.opts.buffer.push(this.$editor.html());
                    this.selection.restore();
                },
                setRedo: function()
                {
                    this.selection.save();
                    this.opts.rebuffer.push(this.$editor.html());
                    this.selection.restore();
                },
                getUndo: function()
                {
                    this.$editor.html(this.opts.buffer.pop());
                },
                getRedo: function()
                {
                    this.$editor.html(this.opts.rebuffer.pop());
                },
                add: function()
                {
                    this.opts.buffer.push(this.$editor.html());
                },
                undo: function()
                {
                    if (this.opts.buffer.length === 0) return;

                    this.buffer.set('redo');
                    this.buffer.getUndo();

                    this.selection.restore();

                    setTimeout($.proxy(this.observe.load, this), 50);
                },
                redo: function()
                {
                    if (this.opts.rebuffer.length === 0) return;

                    this.buffer.set('undo');
                    this.buffer.getRedo();

                    this.selection.restore();

                    setTimeout($.proxy(this.observe.load, this), 50);
                }
            };
        },
        build: function()
        {
            return {
                run: function()
                {
                    this.build.createContainerBox();
                    this.build.loadContent();
                    this.build.loadEditor();
                    this.build.enableEditor();
                    this.build.setCodeAndCall();
                },
                isTextarea: function()
                {
                    return (this.$element[0].tagName === 'TEXTAREA');
                },
                createContainerBox: function()
                {
                    this.$box = $('<div class="redactor-box" />');
                },
                createTextarea: function()
                {
                    this.$textarea = $('<textarea />').attr('name', this.build.getTextareaName());
                },
                getTextareaName: function()
                {
                    return ((typeof(name) == 'undefined')) ? 'content-' + this.uuid : this.$element.attr('id');
                },
                loadContent: function()
                {
                    var func = (this.build.isTextarea()) ? 'val' : 'html';
                    this.content = $.trim(this.$element[func]());
                },
                enableEditor: function()
                {
                    this.$editor.attr({ 'contenteditable': true, 'dir': this.opts.direction });
                },
                loadEditor: function()
                {
                    var func = (this.build.isTextarea()) ? 'fromTextarea' : 'fromElement';
                    this.build[func]();
                },
                fromTextarea: function()
                {
                    this.$editor = $('<div />');
                    this.$textarea = this.$element;
                    this.$box.insertAfter(this.$element).append(this.$editor).append(this.$element);
                    this.$editor.addClass('redactor-editor');

                    this.$element.hide();
                },
                fromElement: function()
                {
                    this.$editor = this.$element;
                    this.build.createTextarea();
                    this.$box.insertAfter(this.$editor).append(this.$editor).append(this.$textarea);
                    this.$editor.addClass('redactor-editor');

                    this.$textarea.hide();
                },
                setCodeAndCall: function()
                {
                    // set code
                    this.code.set(this.content);

                    this.build.setOptions();
                    this.build.callEditor();

                    // code mode
                    if (this.opts.visual) return;
                    setTimeout($.proxy(this.code.showCode, this), 200);
                },
                callEditor: function()
                {
                    this.build.disableMozillaEditing();
                    this.build.setEvents();
                    this.build.setHelpers();

                    // load toolbar
                    if (this.opts.toolbar)
                    {
                        this.opts.toolbar = this.toolbar.init();
                        this.toolbar.build();
                    }

                    // modal templates init
                    this.modal.loadTemplates();

                    // plugins
                    this.build.plugins();

                    // observers
                    setTimeout($.proxy(this.observe.load, this), 4);

                    // init callback
                    this.core.setCallback('init');
                },
                setOptions: function()
                {
                    // textarea direction
                    $(this.$textarea).attr('dir', this.opts.direction);

                    if (this.opts.linebreaks) this.$editor.addClass('redactor-linebreaks');

                    if (this.opts.tabindex) this.$editor.attr('tabindex', this.opts.tabindex);

                    if (this.opts.minHeight) this.$editor.css('minHeight', this.opts.minHeight);
                    if (this.opts.maxHeight) this.$editor.css('maxHeight', this.opts.maxHeight);

                },
                setEventDropUpload: function(e)
                {
                    e.preventDefault();

                    if (!this.opts.dragImageUpload || !this.opts.dragFileUpload) return;

                    var files = e.dataTransfer.files;
                    this.upload.directUpload(files[0], e);
                },
                setEventDrop: function(e)
                {
                    this.code.sync();
                    setTimeout(this.clean.clearUnverified, 1);
                    this.core.setCallback('drop', e);
                },
                setEvents: function()
                {
                    // drop
                    this.$editor.on('drop.redactor', $.proxy(function(e)
                    {
                        e = e.originalEvent || e;

                        if (window.FormData === undefined || !e.dataTransfer) return true;

                        if (e.dataTransfer.files.length === 0)
                        {
                            return this.build.setEventDrop(e);
                        }
                        else
                        {
                            this.build.setEventDropUpload(e);
                        }

                        setTimeout(this.clean.clearUnverified, 1);
                        this.core.setCallback('drop', e);

                    }, this));


                    // click
                    this.$editor.on('click.redactor', $.proxy(function(e)
                    {
                        var event = this.core.getEvent();
                        var type = (event == 'click' || event == 'arrow') ? false : 'click';

                        this.core.addEvent(type);
                        this.utils.disableSelectAll();
                        this.core.setCallback('click', e);

                    }, this));

                    // paste
                    this.$editor.on('paste.redactor', $.proxy(this.paste.init, this));

                    // keydown
                    this.$editor.on('keydown.redactor', $.proxy(this.keydown.init, this));

                    // keyup
                    this.$editor.on('keyup.redactor', $.proxy(this.keyup.init, this));

                    // textarea keydown
                    if ($.isFunction(this.opts.codeKeydownCallback))
                    {
                        this.$textarea.on('keydown.redactor-textarea', $.proxy(this.opts.codeKeydownCallback, this));
                    }

                    // textarea keyup
                    if ($.isFunction(this.opts.codeKeyupCallback))
                    {
                        this.$textarea.on('keyup.redactor-textarea', $.proxy(this.opts.codeKeyupCallback, this));
                    }

                    // focus
                    if ($.isFunction(this.opts.focusCallback))
                    {
                        this.$editor.on('focus.redactor', $.proxy(this.opts.focusCallback, this));
                    }

                    var clickedElement;
                    $(document).on('mousedown', function(e) { clickedElement = e.target; });

                    // blur
                    this.$editor.on('blur.redactor', $.proxy(function(e)
                    {
                        if (this.rtePaste) return;
                        if (!this.build.isBlured(clickedElement)) return;

                        this.utils.disableSelectAll();
                        if ($.isFunction(this.opts.blurCallback)) this.core.setCallback('blur', e);

                    }, this));
                },
                isBlured: function(clickedElement)
                {
                    var $el = $(clickedElement);

                    return (!$el.hasClass('redactor-toolbar, redactor-dropdown') && !$el.is('#redactor-modal') && $el.parents('.redactor-toolbar, .redactor-dropdown, #redactor-modal').length === 0);
                },
                setHelpers: function()
                {
                    // autosave
                    this.autosave.enable();

                    // placeholder
                    this.placeholder.enable();

                    // focus
                    if (this.opts.focus) setTimeout(this.focus.setStart, 100);
                    if (this.opts.focusEnd) setTimeout(this.focus.setEnd, 100);

                },
                plugins: function()
                {
                    if (!this.opts.plugins) return;
                    if (!RedactorPlugins) return;

                    $.each(this.opts.plugins, $.proxy(function(i, s)
                    {
                        if (typeof RedactorPlugins[s] === 'undefined') return;

                        if ($.inArray(s, $.Redactor.modules) !== -1)
                        {
                            $.error('Plugin name "' + s + '" matches the name of the Redactor\'s module.');
                            return;
                        }

                        if (!$.isFunction(RedactorPlugins[s])) return;

                        this[s] = RedactorPlugins[s]();

                        // get methods
                        var methods = this.getModuleMethods(this[s]);
                        var len = methods.length;

                        // bind methods
                        for (var z = 0; z < len; z++)
                        {
                            this[s][methods[z]] = this[s][methods[z]].bind(this);
                        }

                        if ($.isFunction(this[s].init)) this[s].init();


                    }, this));

                },
                disableMozillaEditing: function()
                {
                    if (!this.utils.browser('mozilla')) return;

                    // FF fix
                    try {
                        document.execCommand('enableObjectResizing', false, false);
                        document.execCommand('enableInlineTableEditing', false, false);
                    } catch (e) {}
                }
            };
        },
        button: function()
        {
            return {
                build: function(btnName, btnObject)
                {
                    var $button = $('<a href="#" class="re-icon re-' + btnName + '" rel="' + btnName + '" />').attr('tabindex', '-1');

                    // click
                    if (btnObject.func || btnObject.command || btnObject.dropdown)
                    {
                        this.button.setEvent($button, btnName, btnObject);
                    }

                    // dropdown
                    if (btnObject.dropdown)
                    {
                        var $dropdown = $('<div class="redactor-dropdown redactor-dropdown-' +  + this.uuid + ' redactor-dropdown-box-' + btnName + '" style="display: none;">');
                        $button.data('dropdown', $dropdown);
                        this.dropdown.build(btnName, $dropdown, btnObject.dropdown);
                    }

                    // tooltip
                    if (this.utils.isDesktop())
                    {
                        this.button.createTooltip($button, btnName, btnObject.title);
                    }

                    return $button;
                },
                setEvent: function($button, btnName, btnObject)
                {
                    $button.on('touchstart click', $.proxy(function(e)
                    {
                        if ($button.hasClass('redactor-button-disabled')) return false;

                        var type = 'func';
                        var callback = btnObject.func;

                        if (btnObject.command)
                        {
                            type = 'command';
                            callback = btnObject.command;
                        }
                        else if (btnObject.dropdown)
                        {
                            type = 'dropdown';
                            callback = false;
                        }

                        this.button.onClick(e, btnName, type, callback);

                    }, this));
                },
                createTooltip: function($button, name, title)
                {
                    var $tooltip = $('<span>').addClass('redactor-toolbar-tooltip redactor-toolbar-tooltip-' + name).hide().html(title);
                    $tooltip.appendTo('body');

                    $button.on('mouseover', function()
                    {
                        if ($(this).hasClass('redactor-button-disabled')) return;

                        var pos = $button.offset();

                        $tooltip.show();
                        $tooltip.css({
                            top: (pos.top + $button.innerHeight()) + 'px',
                            left: (pos.left + $button.innerWidth()/2 - $tooltip.innerWidth()/2) + 'px'
                        });
                    });

                    $button.on('mouseout', function()
                    {
                        $tooltip.hide();
                    });

                },
                onClick: function(e, btnName, type, callback)
                {
                    this.button.caretOffset = this.caret.getOffset();

                    e.preventDefault();

                    if (this.utils.browser('msie')) e.returnValue = false;

                    if (type == 'command') this.inline.format(callback);
                    else if (type == 'dropdown') this.dropdown.show(e, btnName);
                    else this.button.onClickCallback(e, callback, btnName);
                },
                onClickCallback: function(e, callback, btnName)
                {
                    var func;

                    if ($.isFunction(callback)) callback.call(this, btnName);
                    else if (callback.search(/\./) != '-1')
                    {
                        func = callback.split('.');
                        if (typeof this[func[0]] == 'undefined') return;

                        this[func[0]][func[1]](btnName);
                    }
                    else this[callback](btnName);

                    this.observe.buttons(e, btnName);
                },
                get: function(key)
                {
                    return this.$toolbar.find('a.re-' + key);
                },
                setActive: function(key)
                {
                    this.button.get(key).addClass('redactor-act');
                },
                setInactive: function(key)
                {
                    this.button.get(key).removeClass('redactor-act');
                },
                setInactiveAll: function(key)
                {
                    if (typeof key === 'undefined')
                    {
                        this.$toolbar.find('a.re-icon').removeClass('redactor-act');
                    }
                    else
                    {
                        this.$toolbar.find('a.re-icon').not('.re-' + key).removeClass('redactor-act');
                    }
                },
                setActiveInVisual: function()
                {
                    this.$toolbar.find('a.re-icon').not('a.re-html').removeClass('redactor-button-disabled');
                },
                setInactiveInCode: function()
                {
                    this.$toolbar.find('a.re-icon').not('a.re-html').addClass('redactor-button-disabled');
                },
                changeIcon: function(key, classname)
                {
                    this.button.get(key).addClass('re-' + classname);
                },
                removeIcon: function(key, classname)
                {
                    this.button.get(key).removeClass('re-' + classname);
                },
                setAwesome: function(key, name)
                {
                    var $button = this.button.get(key);
                    $button.removeClass('redactor-btn-image').addClass('fa-redactor-btn');
                    $button.html('<i class="fa ' + name + '"></i>');
                },
                addCallback: function($btn, callback)
                {
                    var type = (callback == 'dropdown') ? 'dropdown' : 'func';
                    var key = $btn.attr('rel');
                    $btn.on('touchstart click', $.proxy(function(e)
                    {
                        if ($btn.hasClass('redactor-button-disabled')) return false;
                        this.button.onClick(e, key, type, callback);

                    }, this));
                },
                addDropdown: function($btn, dropdown)
                {
                    var key = $btn.attr('rel');
                    this.button.addCallback($btn, 'dropdown');

                    var $dropdown = $('<div class="redactor-dropdown redactor-dropdown-' +  + this.uuid + ' redactor-dropdown-box-' + key + '" style="display: none;">');
                    $btn.data('dropdown', $dropdown);

                    // build dropdown
                    if (dropdown) this.dropdown.build(key, $dropdown, dropdown);

                    return $dropdown;
                },
                add: function(key, title)
                {
                    if (!this.opts.toolbar) return;

                    var btn = this.button.build(key, { title: title });
                    btn.addClass('redactor-btn-image');

                    this.$toolbar.append($('<li>').append(btn));

                    return btn;
                },
                addFirst: function(key, title)
                {
                    if (!this.opts.toolbar) return;

                    var btn = this.button.build(key, { title: title });
                    btn.addClass('redactor-btn-image');
                    this.$toolbar.prepend($('<li>').append(btn));

                    return btn;
                },
                addAfter: function(afterkey, key, title)
                {
                    if (!this.opts.toolbar) return;

                    var btn = this.button.build(key, { title: title });
                    btn.addClass('redactor-btn-image');
                    var $btn = this.button.get(afterkey);

                    if ($btn.length !== 0) $btn.parent().after($('<li>').append(btn));
                    else this.$toolbar.append($('<li>').append(btn));

                    return btn;
                },
                addBefore: function(beforekey, key, title)
                {
                    if (!this.opts.toolbar) return;

                    var btn = this.button.build(key, { title: title });
                    btn.addClass('redactor-btn-image');
                    var $btn = this.button.get(beforekey);

                    if ($btn.length !== 0) $btn.parent().before($('<li>').append(btn));
                    else this.$toolbar.append($('<li>').append(btn));

                    return btn;
                },
                remove: function(key)
                {
                    this.button.get(key).remove();
                }
            };
        },
        caret: function()
        {
            return {
                setStart: function(node)
                {
                    // inline tag
                    if (!this.utils.isBlock(node))
                    {
                        var space = this.utils.createSpaceElement();

                        $(node).prepend(space);
                        this.caret.setEnd(space);
                    }
                    else
                    {
                        this.caret.set(node, 0, node, 0);
                    }
                },
                setEnd: function(node)
                {
                    this.caret.set(node, 1, node, 1);
                },
                set: function(orgn, orgo, focn, foco)
                {
                    // focus
                    // disabled in 10.0.7
                    // if (!this.utils.browser('msie')) this.$editor.focus();

                    orgn = orgn[0] || orgn;
                    focn = focn[0] || focn;

                    if (this.utils.isBlockTag(orgn.tagName) && orgn.innerHTML === '')
                    {
                        orgn.innerHTML = this.opts.invisibleSpace;
                    }

                    if (orgn.tagName == 'BR' && this.opts.linebreaks === false)
                    {
                        var parent = $(this.opts.emptyHtml)[0];
                        $(orgn).replaceWith(parent);
                        orgn = parent;
                        focn = orgn;
                    }

                    this.selection.get();

                    try
                    {
                        this.range.setStart(orgn, orgo);
                        this.range.setEnd(focn, foco);
                    }
                    catch (e) {}

                    this.selection.addRange();
                },
                setAfter: function(node)
                {
                    try
                    {
                        var tag = $(node)[0].tagName;

                        // inline tag
                        if (tag != 'BR' && !this.utils.isBlock(node))
                        {
                            var space = this.utils.createSpaceElement();

                            $(node).after(space);
                            this.caret.setEnd(space);
                        }
                        else
                        {
                            if (tag != 'BR' && this.utils.browser('msie'))
                            {
                                this.caret.setStart($(node).next());
                            }
                            else
                            {
                                this.caret.setAfterOrBefore(node, 'after');
                            }
                        }
                    }
                    catch (e)
                    {
                        var space = this.utils.createSpaceElement();
                        $(node).after(space);
                        this.caret.setEnd(space);
                    }
                },
                setBefore: function(node)
                {
                    // block tag
                    if (this.utils.isBlock(node))
                    {
                        this.caret.setEnd($(node).prev());
                    }
                    else
                    {
                        this.caret.setAfterOrBefore(node, 'before');
                    }
                },
                setAfterOrBefore: function(node, type)
                {
                    // focus
                    if (!this.utils.browser('msie')) this.$editor.focus();

                    node = node[0] || node;

                    this.selection.get();

                    if (type == 'after')
                    {
                        try {

                            this.range.setStartAfter(node);
                            this.range.setEndAfter(node);
                        }
                        catch (e) {}
                    }
                    else
                    {
                        try {
                            this.range.setStartBefore(node);
                            this.range.setEndBefore(node);
                        }
                        catch (e) {}
                    }


                    this.range.collapse(false);
                    this.selection.addRange();
                },
                getOffsetOfElement: function(node)
                {
                    node = node[0] || node;

                    this.selection.get();

                    var cloned = this.range.cloneRange();
                    cloned.selectNodeContents(node);
                    cloned.setEnd(this.range.endContainer, this.range.endOffset);

                    return $.trim(cloned.toString()).length;
                },
                getOffset: function()
                {
                    var offset = 0;
                    var sel = window.getSelection();

                    if (sel.rangeCount > 0)
                    {
                        var range = window.getSelection().getRangeAt(0);
                        var caretRange = range.cloneRange();
                        caretRange.selectNodeContents(this.$editor[0]);
                        caretRange.setEnd(range.endContainer, range.endOffset);
                        offset = caretRange.toString().length;
                    }

                    return offset;
                },
                setOffset: function(start, end)
                {
                    if (typeof end == 'undefined') end = start;
                    if (!this.focus.isFocused()) this.focus.setStart();

                    var sel = this.selection.get();
                    var node, offset = 0;
                    var walker = document.createTreeWalker(this.$editor[0], NodeFilter.SHOW_TEXT, null, null);

                    while (node = walker.nextNode())
                    {
                        offset += node.nodeValue.length;
                        if (offset > start)
                        {
                            this.range.setStart(node, node.nodeValue.length + start - offset);
                            start = Infinity;
                        }

                        if (offset >= end)
                        {
                            this.range.setEnd(node, node.nodeValue.length + end - offset);
                            break;
                        }
                    }

                    this.range.collapse(false);
                    this.selection.addRange();
                },
                // deprecated
                setToPoint: function(start, end)
                {
                    this.caret.setOffset(start, end);
                },
                getCoords: function()
                {
                    return this.caret.getOffset();
                }
            };
        },
        clean: function()
        {
            return {
                onSet: function(html)
                {
                    html = this.clean.savePreCode(html);

                    // convert script tag
                    html = html.replace(/<script(.*?[^>]?)>([\w\W]*?)<\/script>/gi, '<pre class="redactor-script-tag" style="display: none;" $1>$2</pre>');

                    // replace dollar sign to entity
                    html = html.replace(/\$/g, '&#36;');

                    // replace special characters in links
                    html = html.replace(/<a href="(.*?[^>]?)®(.*?[^>]?)">/gi, '<a href="$1&reg$2">');

                    if (this.opts.replaceDivs) html = this.clean.replaceDivs(html);
                    if (this.opts.linebreaks)  html = this.clean.replaceParagraphsToBr(html);

                    // save form tag
                    html = this.clean.saveFormTags(html);

                    // convert font tag to span
                    var $div = $('<div>');
                    $div.html(html);
                    var fonts = $div.find('font[style]');
                    if (fonts.length !== 0)
                    {
                        fonts.replaceWith(function()
                        {
                            var $el = $(this);
                            var $span = $('<span>').attr('style', $el.attr('style'));
                            return $span.append($el.contents());
                        });

                        html = $div.html();
                    }
                    $div.remove();

                    // remove font tag
                    html = html.replace(/<font(.*?[^<])>/gi, '');
                    html = html.replace(/<\/font>/gi, '');

                    // tidy html
                    html = this.tidy.load(html);

                    // paragraphize
                    if (this.opts.paragraphize) html = this.paragraphize.load(html);

                    // verified
                    html = this.clean.setVerified(html);

                    // convert inline tags
                    html = this.clean.convertInline(html);

                    return html;
                },
                onSync: function(html)
                {
                    // remove spaces
                    html = html.replace(/[\u200B-\u200D\uFEFF]/g, '');
                    html = html.replace(/&#x200b;/gi, '');

                    if (this.opts.cleanSpaces)
                    {
                        html = html.replace(/&nbsp;/gi, ' ');
                    }

                    if (html.search(/^<p>(||\s||<br\s?\/?>||&nbsp;)<\/p>$/i) != -1)
                    {
                        return '';
                    }

                    // reconvert script tag
                    html = html.replace(/<pre class="redactor-script-tag" style="display: none;"(.*?[^>]?)>([\w\W]*?)<\/pre>/gi, '<script$1>$2</script>');

                    // restore form tag
                    html = this.clean.restoreFormTags(html);

                    var chars = {
                        '\u2122': '&trade;',
                        '\u00a9': '&copy;',
                        '\u2026': '&hellip;',
                        '\u2014': '&mdash;',
                        '\u2010': '&dash;'
                    };
                    // replace special characters
                    $.each(chars, function(i,s)
                    {
                        html = html.replace(new RegExp(i, 'g'), s);
                    });

                    // remove br in the of li
                    html = html.replace(new RegExp('<br\\s?/?></li>', 'gi'), '</li>');
                    html = html.replace(new RegExp('</li><br\\s?/?>', 'gi'), '</li>');
                    // remove verified
                    html = html.replace(new RegExp('<div(.*?[^>]) data-tagblock="redactor"(.*?[^>])>', 'gi'), '<div$1$2>');
                    html = html.replace(new RegExp('<(.*?) data-verified="redactor"(.*?[^>])>', 'gi'), '<$1$2>');
                    html = html.replace(new RegExp('<span(.*?[^>])\srel="(.*?[^>])"(.*?[^>])>', 'gi'), '<span$1$3>');
                    html = html.replace(new RegExp('<img(.*?[^>])\srel="(.*?[^>])"(.*?[^>])>', 'gi'), '<img$1$3>');
                    html = html.replace(new RegExp('<img(.*?[^>])\sstyle="" (.*?[^>])>', 'gi'), '<img$1 $2>');
                    html = html.replace(new RegExp('<img(.*?[^>])\sstyle (.*?[^>])>', 'gi'), '<img$1 $2>');
                    html = html.replace(new RegExp('<span class="redactor-invisible-space">(.*?)</span>', 'gi'), '$1');
                    html = html.replace(/ data-save-url="(.*?[^>])"/gi, '');

                    // remove image resize
                    html = html.replace(/<span(.*?)id="redactor-image-box"(.*?[^>])>([\w\W]*?)<img(.*?)><\/span>/gi, '$3<img$4>');
                    html = html.replace(/<span(.*?)id="redactor-image-resizer"(.*?[^>])>(.*?)<\/span>/gi, '');
                    html = html.replace(/<span(.*?)id="redactor-image-editter"(.*?[^>])>(.*?)<\/span>/gi, '');

                    // remove font tag
                    html = html.replace(/<font(.*?[^<])>/gi, '');
                    html = html.replace(/<\/font>/gi, '');

                    // tidy html
                    html = this.tidy.load(html);

                    // link nofollow
                    if (this.opts.linkNofollow)
                    {
                        html = html.replace(/<a(.*?)rel="nofollow"(.*?[^>])>/gi, '<a$1$2>');
                        html = html.replace(/<a(.*?[^>])>/gi, '<a$1 rel="nofollow">');
                    }

                    // reconvert inline
                    html = html.replace(/\sdata-redactor-(tag|class|style)="(.*?[^>])"/gi, '');
                    html = html.replace(new RegExp('<(.*?) data-verified="redactor"(.*?[^>])>', 'gi'), '<$1$2>');
                    html = html.replace(new RegExp('<(.*?) data-verified="redactor">', 'gi'), '<$1>');

                    return html;
                },
                onPaste: function(html, setMode)
                {
                    html = $.trim(html);

                    html = html.replace(/\$/g, '&#36;');

                    // convert dirty spaces
                    html = html.replace(/<span class="s1">/gi, '<span>');
                    html = html.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi, ' ');
                    html = html.replace(/<span class="Apple-tab-span"[^>]*>\t<\/span>/gi, '\t');
                    html = html.replace(/<span[^>]*>(\s|&nbsp;)<\/span>/gi, ' ');

                    if (this.opts.pastePlainText)
                    {
                        return this.clean.getPlainText(html);
                    }

                    if (!this.utils.isSelectAll() && typeof setMode == 'undefined')
                    {
                        if (this.utils.isCurrentOrParent(['FIGCAPTION', 'A']))
                        {
                            return this.clean.getPlainText(html, false);
                        }

                        if (this.utils.isCurrentOrParent('PRE'))
                        {
                            html = html.replace(/”/g, '"');
                            html = html.replace(/“/g, '"');
                            html = html.replace(/‘/g, '\'');
                            html = html.replace(/’/g, '\'');

                            return this.clean.getPreCode(html);
                        }

                        if (this.utils.isCurrentOrParent(['BLOCKQUOTE', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6']))
                        {
                            html = this.clean.getOnlyImages(html);

                            if (!this.utils.browser('msie'))
                            {
                                var block = this.selection.getBlock();
                                if (block && block.tagName == 'P')
                                {
                                    html = html.replace(/<img(.*?)>/gi, '<p><img$1></p>');
                                }
                            }

                            return html;
                        }

                        if (this.utils.isCurrentOrParent(['TD']))
                        {
                            html = this.clean.onPasteTidy(html, 'td');

                            if (this.opts.linebreaks) html = this.clean.replaceParagraphsToBr(html);

                            html = this.clean.replaceDivsToBr(html);

                            return html;
                        }


                        if (this.utils.isCurrentOrParent(['LI']))
                        {
                            return this.clean.onPasteTidy(html, 'li');
                        }
                    }


                    html = this.clean.isSingleLine(html, setMode);

                    if (!this.clean.singleLine)
                    {
                        if (this.opts.linebreaks)  html = this.clean.replaceParagraphsToBr(html);
                        if (this.opts.replaceDivs) html = this.clean.replaceDivs(html);

                        html = this.clean.saveFormTags(html);
                    }


                    html = this.clean.onPasteWord(html);
                    html = this.clean.onPasteExtra(html);

                    html = this.clean.onPasteTidy(html, 'all');


                    // paragraphize
                    if (!this.clean.singleLine && this.opts.paragraphize)
                    {
                        html = this.paragraphize.load(html);
                    }

                    html = this.clean.removeDirtyStyles(html);
                    html = this.clean.onPasteRemoveSpans(html);
                    html = this.clean.onPasteRemoveEmpty(html);


                    html = this.clean.convertInline(html);

                    return html;
                },
                onPasteWord: function(html)
                {
                    // comments
                    html = html.replace(/<!--[\s\S]*?-->/gi, '');

                    // style
                    html = html.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '');

                    if (/(class=\"?Mso|style=\"[^\"]*\bmso\-|w:WordDocument)/.test(html))
                    {
                        html = this.clean.onPasteIeFixLinks(html);

                        // shapes
                        html = html.replace(/<img(.*?)v:shapes=(.*?)>/gi, '');
                        html = html.replace(/src="file\:\/\/(.*?)"/, 'src=""');

                        // list
                        html = html.replace(/<p(.*?)class="MsoListParagraphCxSpFirst"([\w\W]*?)<\/p>/gi, '<ul><li$2</li>');
                        html = html.replace(/<p(.*?)class="MsoListParagraphCxSpMiddle"([\w\W]*?)<\/p>/gi, '<li$2</li>');
                        html = html.replace(/<p(.*?)class="MsoListParagraphCxSpLast"([\w\W]*?)<\/p>/gi, '<li$2</li></ul>');
                        // one line
                        html = html.replace(/<p(.*?)class="MsoListParagraph"([\w\W]*?)<\/p>/gi, '<ul><li$2</li></ul>');
                        // remove ms word's bullet
                        html = html.replace(/·/g, '');
                        html = html.replace(/<p class="Mso(.*?)"/gi, '<p');

                        // classes
                        html = html.replace(/ class=\"(mso[^\"]*)\"/gi, "");
                        html = html.replace(/ class=(mso\w+)/gi, "");

                        // remove ms word tags
                        html = html.replace(/<o:p(.*?)>([\w\W]*?)<\/o:p>/gi, '$2');

                        // ms word break lines
                        html = html.replace(/\n/g, ' ');

                        // ms word lists break lines
                        html = html.replace(/<p>\n?<li>/gi, '<li>');
                    }

                    // remove nbsp
                    if (this.opts.cleanSpaces)
                    {
                        html = html.replace(/(\s|&nbsp;)+/g, ' ');
                    }

                    return html;
                },
                onPasteExtra: function(html)
                {
                    // remove google docs markers
                    html = html.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi, "$2");
                    html = html.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi, "$3");

                    // google docs styles
                    html = html.replace(/<span[^>]*(font-style: italic; font-weight: bold|font-weight: bold; font-style: italic)[^>]*>/gi, '<span style="font-weight: bold;"><span style="font-style: italic;">');
                    html = html.replace(/<span[^>]*font-style: italic[^>]*>/gi, '<span style="font-style: italic;">');
                    html = html.replace(/<span[^>]*font-weight: bold[^>]*>/gi, '<span style="font-weight: bold;">');
                    html = html.replace(/<span[^>]*text-decoration: underline[^>]*>/gi, '<span style="text-decoration: underline;">');

                    html = html.replace(/<img>/gi, '');
                    html = html.replace(/\n{3,}/gi, '\n');
                    html = html.replace(/<font(.*?)>([\w\W]*?)<\/font>/gi, '$2');

                    // remove dirty p
                    html = html.replace(/<p><p>/gi, '<p>');
                    html = html.replace(/<\/p><\/p>/gi, '</p>');
                    html = html.replace(/<li>(\s*|\t*|\n*)<p>/gi, '<li>');
                    html = html.replace(/<\/p>(\s*|\t*|\n*)<\/li>/gi, '</li>');

                    // remove space between paragraphs
                    html = html.replace(/<\/p>\s<p/gi, '<\/p><p');

                    // remove safari local images
                    html = html.replace(/<img src="webkit-fake-url\:\/\/(.*?)"(.*?)>/gi, '');

                    // bullets
                    html = html.replace(/<p>•([\w\W]*?)<\/p>/gi, '<li>$1</li>');

                    // FF fix
                    if (this.utils.browser('mozilla'))
                    {
                        html = html.replace(/<br\s?\/?>$/gi, '');
                    }

                    return html;
                },
                onPasteTidy: function(html, type)
                {
                    // remove all tags except these
                    var tags = ['span', 'a', 'pre', 'blockquote', 'small', 'em', 'strong', 'code', 'kbd', 'mark', 'address', 'cite', 'var', 'samp', 'dfn', 'sup', 'sub', 'b', 'i', 'u', 'del',
                                'ol', 'ul', 'li', 'dl', 'dt', 'dd', 'p', 'br', 'video', 'audio', 'iframe', 'embed', 'param', 'object', 'img', 'table',
                                'td', 'th', 'tr', 'tbody', 'tfoot', 'thead', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'];
                    var tagsEmpty = false;
                    var attrAllowed =  [
                            ['a', '*'],
                            ['img', ['src', 'alt']],
                            ['span', ['class', 'rel', 'data-verified']],
                            ['iframe', '*'],
                            ['video', '*'],
                            ['audio', '*'],
                            ['embed', '*'],
                            ['object', '*'],
                            ['param', '*'],
                            ['source', '*']
                        ];

                    if (type == 'all')
                    {
                        tagsEmpty = ['p', 'span', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'];
                        attrAllowed =  [
                            ['table', 'class'],
                            ['td', ['colspan', 'rowspan']],
                            ['a', '*'],
                            ['img', ['src', 'alt', 'data-redactor-inserted-image']],
                            ['span', ['class', 'rel', 'data-verified']],
                            ['iframe', '*'],
                            ['video', '*'],
                            ['audio', '*'],
                            ['embed', '*'],
                            ['object', '*'],
                            ['param', '*'],
                            ['source', '*']
                        ];
                    }
                    else if (type == 'td')
                    {
                        // remove all tags except these and remove all table tags: tr, td etc
                        tags = ['ul', 'ol', 'li', 'span', 'a', 'small', 'em', 'strong', 'code', 'kbd', 'mark', 'cite', 'var', 'samp', 'dfn', 'sup', 'sub', 'b', 'i', 'u', 'del',
                                'ol', 'ul', 'li', 'dl', 'dt', 'dd', 'br', 'iframe', 'video', 'audio', 'embed', 'param', 'object', 'img', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'];

                    }
                    else if (type == 'li')
                    {
                        // only inline tags and ul, ol, li
                        tags = ['ul', 'ol', 'li', 'span', 'a', 'small', 'em', 'strong', 'code', 'kbd', 'mark', 'cite', 'var', 'samp', 'dfn', 'sup', 'sub', 'b', 'i', 'u', 'del', 'br',
                                'iframe', 'video', 'audio', 'embed', 'param', 'object', 'img'];
                    }

                    var options = {
                        deniedTags: false,
                        allowedTags: tags,
                        removeComments: true,
                        removePhp: true,
                        removeAttr: false,
                        allowedAttr: attrAllowed,
                        removeEmpty: tagsEmpty
                    };

                    // denied tags
                    if (this.opts.deniedTags)
                    {
                        options.deniedTags = this.opts.deniedTags;
                    }

                    // allowed tags
                    if (this.opts.allowedTags)
                    {
                        options.allowedTags = this.opts.allowedTags;
                    }

                    return this.tidy.load(html, options);

                },
                onPasteRemoveEmpty: function(html)
                {
                    html = html.replace(/<(p|h[1-6])>(|\s|\n|\t|<br\s?\/?>)<\/(p|h[1-6])>/gi, '');

                    // remove br in the end
                    if (!this.opts.linebreaks) html = html.replace(/<br>$/i, '');

                    return html;
                },
                onPasteRemoveSpans: function(html)
                {
                    html = html.replace(/<span>(.*?)<\/span>/gi, '$1');
                    html = html.replace(/<span[^>]*>\s|&nbsp;<\/span>/gi, ' ');

                    return html;
                },
                onPasteIeFixLinks: function(html)
                {
                    if (!this.utils.browser('msie')) return html;

                    var tmp = $.trim(html);
                    if (tmp.search(/^<a(.*?)>(.*?)<\/a>$/i) === 0)
                    {
                        html = html.replace(/^<a(.*?)>(.*?)<\/a>$/i, "$2");
                    }

                    return html;
                },
                isSingleLine: function(html, setMode)
                {
                    this.clean.singleLine = false;

                    if (!this.utils.isSelectAll() && typeof setMode == 'undefined')
                    {
                        var blocks = this.opts.blockLevelElements.join('|').replace('P|', '').replace('DIV|', '');

                        var matchBlocks = html.match(new RegExp('</(' + blocks + ')>', 'gi'));
                        var matchContainers = html.match(/<\/(p|div)>/gi);

                        if (!matchBlocks && (matchContainers === null || (matchContainers && matchContainers.length <= 1)))
                        {
                            var matchBR = html.match(/<br\s?\/?>/gi);
                            var matchIMG = html.match(/<img(.*?[^>])>/gi);
                            if (!matchBR && !matchIMG)
                            {
                                this.clean.singleLine = true;
                                html = html.replace(/<\/?(p|div)(.*?)>/gi, '');
                            }
                        }
                    }

                    return html;
                },
                stripTags: function(input, allowed)
                {
                    allowed = (((allowed || '') + '').toLowerCase().match(/<[a-z][a-z0-9]*>/g) || []).join('');
                    var tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;

                    return input.replace(tags, function ($0, $1) {
                        return allowed.indexOf('<' + $1.toLowerCase() + '>') > -1 ? $0 : '';
                    });
                },
                savePreCode: function(html)
                {
                    html = this.clean.savePreFormatting(html);
                    html = this.clean.saveCodeFormatting(html);

                    return html;
                },
                savePreFormatting: function(html)
                {
                    var pre = html.match(/<pre(.*?)>([\w\W]*?)<\/pre>/gi);
                    if (pre !== null)
                    {
                        $.each(pre, $.proxy(function(i,s)
                        {
                            var arr = s.match(/<pre(.*?)>([\w\W]*?)<\/pre>/i);

                            arr[2] = arr[2].replace(/<br\s?\/?>/g, '\n');
                            arr[2] = arr[2].replace(/&nbsp;/g, ' ');

                            if (this.opts.preSpaces)
                            {
                                arr[2] = arr[2].replace(/\t/g, Array(this.opts.preSpaces + 1).join(' '));
                            }

                            arr[2] = this.clean.encodeEntities(arr[2]);

                            // $ fix
                            arr[2] = arr[2].replace(/\$/g, '&#36;');

                            html = html.replace(s, '<pre' + arr[1] + '>' + arr[2] + '</pre>');

                        }, this));
                    }

                    return html;
                },
                saveCodeFormatting: function(html)
                {
                    var code = html.match(/<code(.*?[^>])>(.*?)<\/code>/gi);
                    if (code !== null)
                    {
                        $.each(code, $.proxy(function(i,s)
                        {
                            var arr = s.match(/<code(.*?[^>])>(.*?)<\/code>/i);

                            arr[2] = arr[2].replace(/&nbsp;/g, ' ');
                            arr[2] = this.clean.encodeEntities(arr[2]);

                            // $ fix
                            arr[2] = arr[2].replace(/\$/g, '&#36;');

                            html = html.replace(s, '<code' + arr[1] + '>' + arr[2] + '</code>');

                        }, this));
                    }

                    return html;
                },
                getTextFromHtml: function(html)
                {
                    html = html.replace(/<br\s?\/?>|<\/H[1-6]>|<\/p>|<\/div>|<\/li>|<\/td>/gi, '\n');

                    var tmp = document.createElement('div');
                    tmp.innerHTML = html;
                    html = tmp.textContent || tmp.innerText;

                    return $.trim(html);
                },
                getPlainText: function(html, paragraphize)
                {
                    html = this.clean.getTextFromHtml(html);
                    html = html.replace(/\n/g, '<br />');

                    if (this.opts.paragraphize && typeof paragraphize == 'undefined' && !this.utils.browser('mozilla'))
                    {
                        html = this.paragraphize.load(html);
                    }

                    return html;
                },
                getPreCode: function(html)
                {
                    html = html.replace(/<img(.*?) style="(.*?)"(.*?[^>])>/gi, '<img$1$3>');
                    html = html.replace(/<img(.*?)>/gi, '&lt;img$1&gt;');
                    html = this.clean.getTextFromHtml(html);

                    if (this.opts.preSpaces)
                    {
                        html = html.replace(/\t/g, Array(this.opts.preSpaces + 1).join(' '));
                    }

                    html = this.clean.encodeEntities(html);

                    return html;
                },
                getOnlyImages: function(html)
                {
                    html = html.replace(/<img(.*?)>/gi, '[img$1]');

                    // remove all tags
                    html = html.replace(/<([Ss]*?)>/gi, '');

                    html = html.replace(/\[img(.*?)\]/gi, '<img$1>');

                    return html;
                },
                getOnlyLinksAndImages: function(html)
                {
                    html = html.replace(/<a(.*?)href="(.*?)"(.*?)>([\w\W]*?)<\/a>/gi, '[a href="$2"]$4[/a]');
                    html = html.replace(/<img(.*?)>/gi, '[img$1]');

                    // remove all tags
                    html = html.replace(/<(.*?)>/gi, '');

                    html = html.replace(/\[a href="(.*?)"\]([\w\W]*?)\[\/a\]/gi, '<a href="$1">$2</a>');
                    html = html.replace(/\[img(.*?)\]/gi, '<img$1>');

                    return html;
                },
                encodeEntities: function(str)
                {
                    str = String(str).replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');
                    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                },
                removeDirtyStyles: function(html)
                {
                    if (this.utils.browser('msie')) return html;

                    var div = document.createElement('div');
                    div.innerHTML = html;

                    this.clean.clearUnverifiedRemove($(div));

                    html = div.innerHTML;
                    $(div).remove();

                    return html;
                },
                clearUnverified: function()
                {
                    if (this.utils.browser('msie')) return;

                    this.clean.clearUnverifiedRemove(this.$editor);

                    var headers = this.$editor.find('h1, h2, h3, h4, h5, h6');
                    headers.find('span').removeAttr('style');
                    headers.find(this.opts.verifiedTags.join(', ')).removeAttr('style');

                    this.code.sync();
                },
                clearUnverifiedRemove: function($editor)
                {
                    $editor.find(this.opts.verifiedTags.join(', ')).removeAttr('style');
                    $editor.find('span').not('[data-verified="redactor"]').removeAttr('style');

                    $editor.find('span[data-verified="redactor"], img[data-verified="redactor"]').each(function(i, s)
                    {
                        var $s = $(s);
                        $s.attr('style', $s.attr('rel'));
                    });

                },
                setVerified: function(html)
                {
                    if (this.utils.browser('msie')) return html;

                    html = html.replace(new RegExp('<img(.*?[^>])>', 'gi'), '<img$1 data-verified="redactor">');
                    html = html.replace(new RegExp('<span(.*?[^>])>', 'gi'), '<span$1 data-verified="redactor">');

                    var matches = html.match(new RegExp('<(span|img)(.*?)style="(.*?)"(.*?[^>])>', 'gi'));

                    if (matches)
                    {
                        var len = matches.length;
                        for (var i = 0; i < len; i++)
                        {
                            try {

                                var newTag = matches[i].replace(/style="(.*?)"/i, 'style="$1" rel="$1"');
                                html = html.replace(matches[i], newTag);

                            }
                            catch (e) {}
                        }
                    }

                    return html;
                },
                convertInline: function(html)
                {
                    var $div = $('<div />').html(html);

                    var tags = this.opts.inlineTags;
                    tags.push('span');

                    $div.find(tags.join(',')).each(function()
                    {
                        var $el = $(this);
                        var tag = this.tagName.toLowerCase();
                        $el.attr('data-redactor-tag', tag);

                        if (tag == 'span')
                        {
                            if ($el.attr('style')) $el.attr('data-redactor-style', $el.attr('style'));
                            else if ($el.attr('class')) $el.attr('data-redactor-class', $el.attr('class'));
                        }

                    });

                    html = $div.html();
                    $div.remove();

                    return html;
                },
                normalizeLists: function()
                {
                    this.$editor.find('li').each(function(i,s)
                    {
                        var $next = $(s).next();
                        if ($next.length !== 0 && ($next[0].tagName == 'UL' || $next[0].tagName == 'OL'))
                        {
                            $(s).append($next);
                        }

                    });
                },
                removeSpaces: function(html)
                {
                    html = html.replace(/\n/g, '');
                    html = html.replace(/[\t]*/g, '');
                    html = html.replace(/\n\s*\n/g, "\n");
                    html = html.replace(/^[\s\n]*/g, ' ');
                    html = html.replace(/[\s\n]*$/g, ' ');
                    html = html.replace( />\s{2,}</g, '> <'); // between inline tags can be only one space
                    html = html.replace(/\n\n/g, "\n");
                    html = html.replace(/[\u200B-\u200D\uFEFF]/g, '');

                    return html;
                },
                replaceDivs: function(html)
                {
                    if (this.opts.linebreaks)
                    {
                        html = html.replace(/<div><br\s?\/?><\/div>/gi, '<br />');
                        html = html.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi, '$2<br />');
                    }
                    else
                    {
                        html = html.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi, '<p$1>$2</p>');
                    }

                    html = html.replace(/<div(.*?[^>])>/gi, '');
                    html = html.replace(/<\/div>/gi, '');

                    return html;
                },
                replaceDivsToBr: function(html)
                {
                    html = html.replace(/<div\s(.*?)>/gi, '<p>');
                    html = html.replace(/<div><br\s?\/?><\/div>/gi, '<br /><br />');
                    html = html.replace(/<div>([\w\W]*?)<\/div>/gi, '$1<br /><br />');

                    return html;
                },
                replaceParagraphsToBr: function(html)
                {
                    html = html.replace(/<p\s(.*?)>/gi, '<p>');
                    html = html.replace(/<p><br\s?\/?><\/p>/gi, '<br />');
                    html = html.replace(/<p>([\w\W]*?)<\/p>/gi, '$1<br /><br />');
                    html = html.replace(/(<br\s?\/?>){1,}\n?<\/blockquote>/gi, '</blockquote>');

                    return html;
                },
                saveFormTags: function(html)
                {
                    return html.replace(/<form(.*?)>([\w\W]*?)<\/form>/gi, '<section$1 rel="redactor-form-tag">$2</section>');
                },
                restoreFormTags: function(html)
                {
                    return html.replace(/<section(.*?) rel="redactor-form-tag"(.*?)>([\w\W]*?)<\/section>/gi, '<form$1$2>$3</form>');
                }
            };
        },
        code: function()
        {
            return {
                set: function(html)
                {
                    html = $.trim(html.toString());

                    // clean
                    html = this.clean.onSet(html);

                    this.$editor.html(html);
                    this.code.sync();

                    if (html !== '') this.placeholder.remove();

                    setTimeout($.proxy(this.buffer.add, this), 15);
                    if (this.start === false) this.observe.load();

                },
                get: function()
                {
                    var code = this.$textarea.val();

                    // indent code
                    code = this.tabifier.get(code);

                    return code;
                },
                sync: function()
                {
                    setTimeout($.proxy(this.code.startSync, this), 10);
                },
                startSync: function()
                {
                    var html = this.$editor.html();

                    // is there a need to synchronize
                    if (this.code.syncCode && this.code.syncCode == html)
                    {
                        // do not sync
                        return;
                    }

                    // save code
                    this.code.syncCode = html;

                    // before clean callback
                    html = this.core.setCallback('syncBefore', html);

                    // clean
                    html = this.clean.onSync(html);

                    // set code
                    this.$textarea.val(html);

                    // after sync callback
                    this.core.setCallback('sync', html);

                    if (this.start === false)
                    {
                        this.core.setCallback('change', html);
                    }

                    this.start = false;

                    // autosave on change
                    this.autosave.onChange();
                },
                toggle: function()
                {
                    if (this.opts.visual)
                    {
                        this.code.showCode();
                    }
                    else
                    {
                        this.code.showVisual();
                    }
                },
                showCode: function()
                {
                    this.code.offset = this.caret.getOffset();
                    var scroll = $(window).scrollTop();

                    var height = this.$editor.innerHeight();

                    this.$editor.hide();

                    var html = this.$textarea.val();
                    this.modified = this.clean.removeSpaces(html);

                    // indent code
                    html = this.tabifier.get(html);

                    this.$textarea.val(html).height(height).show().focus();
                    this.$textarea.on('keydown.redactor-textarea-indenting', this.code.textareaIndenting);

                    $(window).scrollTop(scroll);

                    if (this.$textarea[0].setSelectionRange)
                    {
                        this.$textarea[0].setSelectionRange(0, 0);
                    }

                    this.$textarea[0].scrollTop = 0;

                    this.opts.visual = false;

                    this.button.setInactiveInCode();
                    this.button.setActive('html');
                    this.core.setCallback('source', html);
                },
                showVisual: function()
                {
                    if (this.opts.visual) return;

                    var html = this.$textarea.hide().val();

                    if (this.modified !== this.clean.removeSpaces(html))
                    {
                        this.code.set(html);
                    }

                    this.$editor.show();

                    if (!this.utils.isEmpty(html))
                    {
                        this.placeholder.remove();
                    }

                    this.caret.setOffset(this.code.offset);

                    this.$textarea.off('keydown.redactor-textarea-indenting');

                    this.button.setActiveInVisual();
                    this.button.setInactive('html');

                    this.observe.load();
                    this.opts.visual = true;
                    this.core.setCallback('visual', html);
                },
                textareaIndenting: function(e)
                {
                    if (e.keyCode !== 9) return true;

                    var $el = this.$textarea;
                    var start = $el.get(0).selectionStart;
                    $el.val($el.val().substring(0, start) + "\t" + $el.val().substring($el.get(0).selectionEnd));
                    $el.get(0).selectionStart = $el.get(0).selectionEnd = start + 1;

                    return false;
                }
            };
        },
        core: function()
        {
            return {
                getObject: function()
                {
                    return $.extend({}, this);
                },
                getEditor: function()
                {
                    return this.$editor;
                },
                getBox: function()
                {
                    return this.$box;
                },
                getElement: function()
                {
                    return this.$element;
                },
                getTextarea: function()
                {
                    return this.$textarea;
                },
                getToolbar: function()
                {
                    return (this.$toolbar) ? this.$toolbar : false;
                },
                addEvent: function(name)
                {
                    this.core.event = name;
                },
                getEvent: function()
                {
                    return this.core.event;
                },
                setCallback: function(type, e, data)
                {
                    var callback = this.opts[type + 'Callback'];
                    if ($.isFunction(callback))
                    {
                        return (typeof data == 'undefined') ? callback.call(this, e) : callback.call(this, e, data);
                    }
                    else
                    {
                        return (typeof data == 'undefined') ? e : data;
                    }
                },
                destroy: function()
                {
                    this.core.setCallback('destroy');

                    // off events and remove data
                    this.$element.off('.redactor').removeData('redactor');
                    this.$editor.off('.redactor');

                    $(document).off('click.redactor-image-delete.' + this.uuid);
                    $(document).off('click.redactor-image-resize-hide.' + this.uuid);
                    $(document).off('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid);
                    $("body").off('scroll.redactor.' + this.uuid);
                    $(this.opts.toolbarFixedTarget).off('scroll.redactor.' + this.uuid);

                    // common
                    this.$editor.removeClass('redactor-editor redactor-linebreaks redactor-placeholder');
                    this.$editor.removeAttr('contenteditable');

                    var html = this.code.get();

                    // dropdowns off
                    this.$toolbar.find('a').each(function()
                    {
                        var $el = $(this);
                        if ($el.data('dropdown'))
                        {
                            $el.data('dropdown').remove();
                            $el.data('dropdown', {});
                        }
                    });


                    if (this.build.isTextarea())
                    {
                        this.$box.after(this.$element);
                        this.$box.remove();
                        this.$element.val(html).show();
                    }
                    else
                    {
                        this.$box.after(this.$editor);
                        this.$box.remove();
                        this.$element.html(html).show();
                    }

                    // paste box
                    if (this.$pasteBox) this.$pasteBox.remove();

                    // modal
                    if (this.$modalBox) this.$modalBox.remove();
                    if (this.$modalOverlay) this.$modalOverlay.remove();

                    // buttons tooltip
                    $('.redactor-toolbar-tooltip').remove();

                    // autosave
                    clearInterval(this.autosaveInterval);

                }
            };
        },
        dropdown: function()
        {
            return {
                build: function(name, $dropdown, dropdownObject)
                {
                    if (name == 'formatting' && this.opts.formattingAdd)
                    {
                        $.each(this.opts.formattingAdd, $.proxy(function(i,s)
                        {
                            var name = s.tag;
                            if (typeof s['class'] != 'undefined')
                            {
                                name = name + '-' + s['class'];
                            }

                            s.type = (this.utils.isBlockTag(s.tag)) ? 'block' : 'inline';
                            var func = (s.type == 'inline') ? 'inline.formatting' : 'block.formatting';

                            if (this.opts.linebreaks && s.type == 'block' && s.tag == 'p') return;

                            this.formatting[name] = {
                                tag: s.tag,
                                style: s.style,
                                'class': s['class'],
                                attr: s.attr,
                                data: s.data,
                                clear: s.clear
                            };

                            dropdownObject[name] = {
                                func: func,
                                title: s.title
                            };

                        }, this));

                    }

                    $.each(dropdownObject, $.proxy(function(btnName, btnObject)
                    {
                        var $item = $('<a href="#" class="redactor-dropdown-' + btnName + '">' + btnObject.title + '</a>');
                        if (name == 'formatting') $item.addClass('redactor-formatting-' + btnName);

                        $item.on('click', $.proxy(function(e)
                        {
                            e.preventDefault();

                            var type = 'func';
                            var callback = btnObject.func;
                            if (btnObject.command)
                            {
                                type = 'command';
                                callback = btnObject.command;
                            }
                            else if (btnObject.dropdown)
                            {
                                type = 'dropdown';
                                callback = btnObject.dropdown;
                            }

                            this.button.onClick(e, btnName, type, callback);
                            this.dropdown.hideAll();

                        }, this));

                        $dropdown.append($item);

                    }, this));
                },
                show: function(e, key)
                {
                    if (!this.opts.visual)
                    {
                        e.preventDefault();
                        return false;
                    }

                    var $button = this.button.get(key);

                    // Always re-append it to the end of <body> so it always has the highest sub-z-index.
                    var $dropdown = $button.data('dropdown').appendTo(document.body);

                    // ios keyboard hide
                    if (this.utils.isMobile() && !this.utils.browser('msie'))
                    {
                        document.activeElement.blur();
                    }

                    if ($button.hasClass('dropact'))
                    {
                        this.dropdown.hideAll();
                    }
                    else
                    {
                        this.dropdown.hideAll();
                        this.core.setCallback('dropdownShow', { dropdown: $dropdown, key: key, button: $button });

                        this.button.setActive(key);

                        $button.addClass('dropact');

                        var keyPosition = $button.offset();

                        // fix right placement
                        var dropdownWidth = $dropdown.width();
                        if ((keyPosition.left + dropdownWidth) > $(document).width())
                        {
                            keyPosition.left = Math.max(0, keyPosition.left - dropdownWidth);
                        }

                        var left = keyPosition.left + 'px';
                        if (this.$toolbar.hasClass('toolbar-fixed-box'))
                        {
                            var top = this.$toolbar.innerHeight() + this.opts.toolbarFixedTopOffset;
                            var position = 'fixed';
                            if (this.opts.toolbarFixedTarget !== document)
                            {
                                top = (this.$toolbar.innerHeight() + this.$toolbar.offset().top) + this.opts.toolbarFixedTopOffset;
                                position = 'absolute';
                            }

                            $dropdown.css({ position: position, left: left, top: top + 'px' }).show();
                        }
                        else
                        {
                            var top = ($button.innerHeight() + keyPosition.top) + 'px';

                            $dropdown.css({ position: 'absolute', left: left, top: top }).show();
                        }

                        this.core.setCallback('dropdownShown', { dropdown: $dropdown, key: key, button: $button });
                    }

                    $(document).one('click', $.proxy(this.dropdown.hide, this));
                    this.$editor.one('click', $.proxy(this.dropdown.hide, this));

                    // disable scroll whan dropdown scroll
                    var $body = $(document.body);
                    var width = $body.width();

                    $dropdown.on('mouseover', function() {

                        $body.addClass('body-redactor-hidden');
                        $body.css('margin-right', ($body.width() - width) + 'px');

                     });

                    $dropdown.on('mouseout', function() {

                        $body.removeClass('body-redactor-hidden').css('margin-right', 0);

                    });


                    e.stopPropagation();
                },
                hideAll: function()
                {
                    this.$toolbar.find('a.dropact').removeClass('redactor-act').removeClass('dropact');

                    $(document.body).removeClass('body-redactor-hidden').css('margin-right', 0);
                    $('.redactor-dropdown-' + this.uuid).hide();
                    this.core.setCallback('dropdownHide');
                },
                hide: function (e)
                {
                    var $dropdown = $(e.target);
                    if (!$dropdown.hasClass('dropact'))
                    {
                        $dropdown.removeClass('dropact');
                        this.dropdown.hideAll();
                    }
                }
            };
        },
        file: function()
        {
            return {
                show: function()
                {
                    this.modal.load('file', this.lang.get('file'), 700);
                    this.upload.init('#redactor-modal-file-upload', this.opts.fileUpload, this.file.insert);

                    this.selection.save();

                    this.selection.get();
                    var text = this.sel.toString();

                    $('#redactor-filename').val(text);

                    this.modal.show();
                },
                insert: function(json, direct, e)
                {
                    // error callback
                    if (typeof json.error != 'undefined')
                    {
                        this.modal.close();
                        this.selection.restore();
                        this.core.setCallback('fileUploadError', json);
                        return;
                    }

                    var link;
                    if (typeof json == 'string')
                    {
                        link = json;
                    }
                    else
                    {
                        var text = $('#redactor-filename').val();
                        if (typeof text == 'undefined' || text === '') text = json.filename;

                        link = '<a href="' + json.filelink + '" id="filelink-marker">' + text + '</a>';
                    }

                    if (direct)
                    {
                        this.selection.removeMarkers();
                        var marker = this.selection.getMarker();
                        this.insert.nodeToCaretPositionFromPoint(e, marker);
                    }
                    else
                    {
                        this.modal.close();
                    }

                    this.selection.restore();
                    this.buffer.set();

                    this.insert.htmlWithoutClean(link);

                    if (typeof json == 'string') return;

                    var linkmarker = $(this.$editor.find('a#filelink-marker'));
                    if (linkmarker.length !== 0)
                    {
                        linkmarker.removeAttr('id').removeAttr('style');
                    }
                    else linkmarker = false;

                    this.core.setCallback('fileUpload', linkmarker, json);

                }
            };
        },
        focus: function()
        {
            return {
                setStart: function()
                {
                    this.$editor.focus();

                    var first = this.$editor.children().first();

                    if (first.length === 0) return;
                    if (first[0].length === 0 || first[0].tagName == 'BR' || first[0].nodeType == 3)
                    {
                        return;
                    }

                    if (first[0].tagName == 'UL' || first[0].tagName == 'OL')
                    {
                        var child = first.find('li').first();
                        if (!this.utils.isBlock(child) && child.text() === '')
                        {
                            // empty inline tag in li
                            this.caret.setStart(child);
                            return;
                        }
                    }

                    if (this.opts.linebreaks && !this.utils.isBlockTag(first[0].tagName))
                    {
                        this.selection.get();
                        this.range.setStart(this.$editor[0], 0);
                        this.range.setEnd(this.$editor[0], 0);
                        this.selection.addRange();

                        return;
                    }

                    // if node is tag
                    this.caret.setStart(first);
                },
                setEnd: function()
                {
                    if (this.utils.browser('mozilla') || this.utils.browser('msie'))
                    {
                        var last = this.$editor.children().last();

                        this.$editor.focus();
                        this.caret.setEnd(last);
                    }
                    else
                    {
                        this.selection.get();

                        try {
                            this.range.selectNodeContents(this.$editor[0]);
                            this.range.collapse(false);

                            this.selection.addRange();
                        }
                        catch (e) {}
                    }

                },
                isFocused: function()
                {
                    var focusNode = document.getSelection().focusNode;
                    if (focusNode === null) return false;

                    if (this.opts.linebreaks && $(focusNode.parentNode).hasClass('redactor-linebreaks')) return true;
                    else if (!this.utils.isRedactorParent(focusNode.parentNode)) return false;

                    return this.$editor.is(':focus');
                }
            };
        },
        image: function()
        {
            return {
                show: function()
                {
                    this.modal.load('image', this.lang.get('image'), 700);
                    this.upload.init('#redactor-modal-image-droparea', this.opts.imageUpload, this.image.insert);

                    this.selection.save();
                    this.modal.show();

                },
                showEdit: function($image)
                {
                    var $link = $image.closest('a');

                    this.modal.load('imageEdit', this.lang.get('edit'), 705);

                    this.modal.createCancelButton();
                    this.image.buttonDelete = this.modal.createDeleteButton(this.lang.get('_delete'));
                    this.image.buttonSave = this.modal.createActionButton(this.lang.get('save'));

                    this.image.buttonDelete.on('click', $.proxy(function()
                    {
                        this.image.remove($image);

                    }, this));

                    this.image.buttonSave.on('click', $.proxy(function()
                    {
                        this.image.update($image);

                    }, this));

                    $('#redactor-image-title').val($image.attr('alt'));

                    if (!this.opts.imageLink) $('.redactor-image-link-option').hide();
                    else
                    {
                        var $redactorImageLink = $('#redactor-image-link');

                        $redactorImageLink.attr('href', $image.attr('src'));
                        if ($link.length !== 0)
                        {
                            $redactorImageLink.val($link.attr('href'));
                            if ($link.attr('target') == '_blank') $('#redactor-image-link-blank').prop('checked', true);
                        }
                    }

                    if (!this.opts.imagePosition) $('.redactor-image-position-option').hide();
                    else
                    {
                        var floatValue = ($image.css('display') == 'block' && $image.css('float') == 'none') ? 'center' : $image.css('float');
                        $('#redactor-image-align').val(floatValue);
                    }

                    this.modal.show();

                },
                setFloating: function($image)
                {
                    var floating = $('#redactor-image-align').val();

                    var imageFloat = '';
                    var imageDisplay = '';
                    var imageMargin = '';

                    switch (floating)
                    {
                        case 'left':
                            imageFloat = 'left';
                            imageMargin = '0 ' + this.opts.imageFloatMargin + ' ' + this.opts.imageFloatMargin + ' 0';
                        break;
                        case 'right':
                            imageFloat = 'right';
                            imageMargin = '0 0 ' + this.opts.imageFloatMargin + ' ' + this.opts.imageFloatMargin;
                        break;
                        case 'center':
                            imageDisplay = 'block';
                            imageMargin = 'auto';
                        break;
                    }

                    $image.css({ 'float': imageFloat, display: imageDisplay, margin: imageMargin });
                    $image.attr('rel', $image.attr('style'));
                },
                update: function($image)
                {
                    this.image.hideResize();
                    this.buffer.set();

                    var $link = $image.closest('a');

                    $image.attr('alt', $('#redactor-image-title').val());

                    this.image.setFloating($image);

                    // as link
                    var link = $.trim($('#redactor-image-link').val());
                    if (link !== '')
                    {
                        // test url (add protocol)
                        var pattern = '((xn--)?[a-z0-9]+(-[a-z0-9]+)*\\.)+[a-z]{2,}';
                        var re = new RegExp('^(http|ftp|https)://' + pattern, 'i');
                        var re2 = new RegExp('^' + pattern, 'i');

                        if (link.search(re) == -1 && link.search(re2) === 0 && this.opts.linkProtocol)
                        {
                            link = this.opts.linkProtocol + '://' + link;
                        }

                        var target = ($('#redactor-image-link-blank').prop('checked')) ? true : false;

                        if ($link.length === 0)
                        {
                            var a = $('<a href="' + link + '">' + this.utils.getOuterHtml($image) + '</a>');
                            if (target) a.attr('target', '_blank');

                            $image.replaceWith(a);
                        }
                        else
                        {
                            $link.attr('href', link);
                            if (target)
                            {
                                $link.attr('target', '_blank');
                            }
                            else
                            {
                                $link.removeAttr('target');
                            }
                        }
                    }
                    else if ($link.length !== 0)
                    {
                        $link.replaceWith(this.utils.getOuterHtml($image));

                    }

                    this.modal.close();
                    this.observe.images();
                    this.code.sync();


                },
                setEditable: function($image)
                {
                    if (this.opts.imageEditable)
                    {
                        $image.on('dragstart', $.proxy(this.image.onDrag, this));
                    }

                    $image.on('mousedown', $.proxy(this.image.hideResize, this));
                    $image.on('click.redactor touchstart', $.proxy(function(e)
                    {
                        this.observe.image = $image;

                        if (this.$editor.find('#redactor-image-box').length !== 0) return false;

                        this.image.resizer = this.image.loadEditableControls($image);

                        $(document).on('click.redactor-image-resize-hide.' + this.uuid, $.proxy(this.image.hideResize, this));
                        this.$editor.on('click.redactor-image-resize-hide.' + this.uuid, $.proxy(this.image.hideResize, this));

                        // resize
                        if (!this.opts.imageResizable) return;

                        this.image.resizer.on('mousedown.redactor touchstart.redactor', $.proxy(function(e)
                        {
                            this.image.setResizable(e, $image);
                        }, this));


                    }, this));
                },
                setResizable: function(e, $image)
                {
                    e.preventDefault();

                    this.image.resizeHandle = {
                        x : e.pageX,
                        y : e.pageY,
                        el : $image,
                        ratio: $image.width() / $image.height(),
                        h: $image.height()
                    };

                    e = e.originalEvent || e;

                    if (e.targetTouches)
                    {
                         this.image.resizeHandle.x = e.targetTouches[0].pageX;
                         this.image.resizeHandle.y = e.targetTouches[0].pageY;
                    }

                    this.image.startResize();


                },
                startResize: function()
                {
                    $(document).on('mousemove.redactor-image-resize touchmove.redactor-image-resize', $.proxy(this.image.moveResize, this));
                    $(document).on('mouseup.redactor-image-resize touchend.redactor-image-resize', $.proxy(this.image.stopResize, this));
                },
                moveResize: function(e)
                {
                    e.preventDefault();

                    e = e.originalEvent || e;

                    var height = this.image.resizeHandle.h;

                    if (e.targetTouches) height += (e.targetTouches[0].pageY -  this.image.resizeHandle.y);
                    else height += (e.pageY -  this.image.resizeHandle.y);

                    var width = Math.round(height * this.image.resizeHandle.ratio);

                    if (height < 50 || width < 100) return;

                    this.image.resizeHandle.el.width(width);
                    this.image.resizeHandle.el.height(this.image.resizeHandle.el.width()/this.image.resizeHandle.ratio);

                    this.code.sync();
                },
                stopResize: function()
                {
                    this.handle = false;
                    $(document).off('.redactor-image-resize');

                    this.image.hideResize();
                },
                onDrag: function(e)
                {
                    if (this.$editor.find('#redactor-image-box').length !== 0)
                    {
                        e.preventDefault();
                        return false;
                    }

                    this.$editor.on('drop.redactor-image-inside-drop', $.proxy(function()
                    {
                        setTimeout($.proxy(this.image.onDrop, this), 1);

                    }, this));
                },
                onDrop: function()
                {
                    this.image.fixImageSourceAfterDrop();
                    this.observe.images();
                    this.$editor.off('drop.redactor-image-inside-drop');
                    this.clean.clearUnverified();
                    this.code.sync();
                },
                fixImageSourceAfterDrop: function()
                {
                    this.$editor.find('img[data-save-url]').each(function()
                    {
                        var $el = $(this);
                        $el.attr('src', $el.attr('data-save-url'));
                        $el.removeAttr('data-save-url');
                    });
                },
                hideResize: function(e)
                {
                    if (e && $(e.target).closest('#redactor-image-box').length !== 0) return;
                    if (e && e.target.tagName == 'IMG')
                    {
                        var $image = $(e.target);
                        $image.attr('data-save-url', $image.attr('src'));
                    }

                    var imageBox = this.$editor.find('#redactor-image-box');
                    if (imageBox.length === 0) return;

                    if (this.opts.imageEditable)
                    {
                        this.image.editter.remove();
                    }

                    $(this.image.resizer).remove();

                    imageBox.find('img').css({
                        marginTop: imageBox[0].style.marginTop,
                        marginBottom: imageBox[0].style.marginBottom,
                        marginLeft: imageBox[0].style.marginLeft,
                        marginRight: imageBox[0].style.marginRight
                    });

                    imageBox.css('margin', '');
                    imageBox.find('img').css('opacity', '');
                    imageBox.replaceWith(function()
                    {
                        return $(this).contents();
                    });

                    $(document).off('click.redactor-image-resize-hide.' + this.uuid);
                    this.$editor.off('click.redactor-image-resize-hide.' + this.uuid);

                    if (typeof this.image.resizeHandle !== 'undefined')
                    {
                        this.image.resizeHandle.el.attr('rel', this.image.resizeHandle.el.attr('style'));
                    }

                    this.code.sync();

                },
                loadResizableControls: function($image, imageBox)
                {
                    if (this.opts.imageResizable && !this.utils.isMobile())
                    {
                        var imageResizer = $('<span id="redactor-image-resizer" data-redactor="verified"></span>');

                        if (!this.utils.isDesktop())
                        {
                            imageResizer.css({ width: '15px', height: '15px' });
                        }

                        imageResizer.attr('contenteditable', false);
                        imageBox.append(imageResizer);
                        imageBox.append($image);

                        return imageResizer;
                    }
                    else
                    {
                        imageBox.append($image);
                        return false;
                    }
                },
                loadEditableControls: function($image)
                {
                    var imageBox = $('<span id="redactor-image-box" data-redactor="verified">');
                    imageBox.css('float', $image.css('float')).attr('contenteditable', false);

                    if ($image[0].style.margin != 'auto')
                    {
                        imageBox.css({
                            marginTop: $image[0].style.marginTop,
                            marginBottom: $image[0].style.marginBottom,
                            marginLeft: $image[0].style.marginLeft,
                            marginRight: $image[0].style.marginRight
                        });

                        $image.css('margin', '');
                    }
                    else
                    {
                        imageBox.css({ 'display': 'block', 'margin': 'auto' });
                    }

                    $image.css('opacity', '.5').after(imageBox);


                    if (this.opts.imageEditable)
                    {
                        // editter
                        this.image.editter = $('<span id="redactor-image-editter" data-redactor="verified">' + this.lang.get('edit') + '</span>');
                        this.image.editter.attr('contenteditable', false);
                        this.image.editter.on('click', $.proxy(function()
                        {
                            this.image.showEdit($image);
                        }, this));

                        imageBox.append(this.image.editter);

                        // position correction
                        var editerWidth = this.image.editter.innerWidth();
                        this.image.editter.css('margin-left', '-' + editerWidth/2 + 'px');
                    }

                    return this.image.loadResizableControls($image, imageBox);

                },
                remove: function(image)
                {
                    var $image = $(image);
                    var $link = $image.closest('a');
                    var $figure = $image.closest('figure');
                    var $parent = $image.parent();
                    if ($('#redactor-image-box').length !== 0)
                    {
                        $parent = $('#redactor-image-box').parent();
                    }

                    var $next;
                    if ($figure.length !== 0)
                    {
                        $next = $figure.next();
                        $figure.remove();
                    }
                    else if ($link.length !== 0)
                    {
                        $parent = $link.parent();
                        $link.remove();
                    }
                    else
                    {
                        $image.remove();
                    }

                    $('#redactor-image-box').remove();

                    if ($figure.length !== 0)
                    {
                        this.caret.setStart($next);
                    }
                    else
                    {
                        this.caret.setStart($parent);
                    }

                    // delete callback
                    this.core.setCallback('imageDelete', $image[0].src, $image);

                    this.modal.close();
                    this.code.sync();
                },
                insert: function(json, direct, e)
                {
                    // error callback
                    if (typeof json.error != 'undefined')
                    {
                        this.modal.close();
                        this.selection.restore();
                        this.core.setCallback('imageUploadError', json);
                        return;
                    }

                    var $img;
                    if (typeof json == 'string')
                    {
                        $img = $(json).attr('data-redactor-inserted-image', 'true');
                    }
                    else
                    {
                        $img = $('<img>');
                        $img.attr('src', json.filelink).attr('data-redactor-inserted-image', 'true');
                    }


                    var node = $img;
                    var isP = this.utils.isCurrentOrParent('P');
                    if (isP)
                    {
                        // will replace
                        node = $('<blockquote />').append($img);
                    }

                    if (direct)
                    {
                        this.selection.removeMarkers();
                        var marker = this.selection.getMarker();
                        this.insert.nodeToCaretPositionFromPoint(e, marker);
                    }
                    else
                    {
                        this.modal.close();
                    }

                    this.selection.restore();
                    this.buffer.set();

                    this.insert.html(this.utils.getOuterHtml(node), false);

                    var $image = this.$editor.find('img[data-redactor-inserted-image=true]').removeAttr('data-redactor-inserted-image');

                    if (isP)
                    {
                        $image.parent().contents().unwrap().wrap('<p />');
                    }
                    else if (this.opts.linebreaks)
                    {
                        $image.before('<br>').after('<br>');
                    }

                    if (typeof json == 'string') return;

                    this.core.setCallback('imageUpload', $image, json);

                }
            };
        },
        indent: function()
        {
            return {
                increase: function()
                {
                    // focus
                    if (!this.utils.browser('msie')) this.$editor.focus();

                    this.buffer.set();
                    this.selection.save();

                    var block = this.selection.getBlock();

                    if (block && block.tagName == 'LI')
                    {
                        this.indent.increaseLists();
                    }
                    else if (block === false && this.opts.linebreaks)
                    {
                        this.indent.increaseText();
                    }
                    else
                    {
                        this.indent.increaseBlocks();
                    }

                    this.selection.restore();
                    this.code.sync();
                },
                increaseLists: function()
                {
                    document.execCommand('indent');

                    this.indent.fixEmptyIndent();
                    this.clean.normalizeLists();
                    this.clean.clearUnverified();
                },
                increaseBlocks: function()
                {
                    $.each(this.selection.getBlocks(), $.proxy(function(i, elem)
                    {
                        if (elem.tagName === 'TD' || elem.tagName === 'TH') return;

                        var $el = this.utils.getAlignmentElement(elem);

                        var left = this.utils.normalize($el.css('margin-left')) + this.opts.indentValue;
                        $el.css('margin-left', left + 'px');

                    }, this));
                },
                increaseText: function()
                {
                    var wrapper = this.selection.wrap('div');
                    $(wrapper).attr('data-tagblock', 'redactor');
                    $(wrapper).css('margin-left', this.opts.indentValue + 'px');
                },
                decrease: function()
                {
                    this.buffer.set();
                    this.selection.save();

                    var block = this.selection.getBlock();
                    if (block && block.tagName == 'LI')
                    {
                        this.indent.decreaseLists();
                    }
                    else
                    {
                        this.indent.decreaseBlocks();
                    }

                    this.selection.restore();
                    this.code.sync();
                },
                decreaseLists: function ()
                {
                    document.execCommand('outdent');

                    var current = this.selection.getCurrent();

                    var $item = $(current).closest('li');
                    var $parent = $item.parent();
                    if ($item.length !== 0 && $parent.length !== 0 && $parent[0].tagName == 'LI')
                    {
                        $parent.after($item);
                    }

                    this.indent.fixEmptyIndent();

                    if (!this.opts.linebreaks && $item.length === 0)
                    {
                        document.execCommand('formatblock', false, 'p');
                        this.$editor.find('ul, ol, blockquote, p').each($.proxy(this.utils.removeEmpty, this));
                    }

                    this.clean.clearUnverified();
                },
                decreaseBlocks: function()
                {
                    $.each(this.selection.getBlocks(), $.proxy(function(i, elem)
                    {
                        var $el = this.utils.getAlignmentElement(elem);
                        var left = this.utils.normalize($el.css('margin-left')) - this.opts.indentValue;

                        if (left <= 0)
                        {
                            if (this.opts.linebreaks && typeof($el.data('tagblock')) !== 'undefined')
                            {
                                $el.replaceWith($el.html() + '<br />');
                            }
                            else
                            {
                                $el.css('margin-left', '');
                                this.utils.removeEmptyAttr($el, 'style');
                            }
                        }
                        else
                        {
                            $el.css('margin-left', left + 'px');
                        }

                    }, this));
                },
                fixEmptyIndent: function()
                {
                    var block = this.selection.getBlock();

                    if (this.range.collapsed && block && block.tagName == 'LI' && this.utils.isEmpty($(block).text()))
                    {
                        var $block = $(block);
                        $block.find('span').not('.redactor-selection-marker').contents().unwrap();
                        $block.append('<br>');
                    }
                }
            };
        },
        inline: function()
        {
            return {
                formatting: function(name)
                {
                    var type, value;

                    if (typeof this.formatting[name].style != 'undefined') type = 'style';
                    else if (typeof this.formatting[name]['class'] != 'undefined') type = 'class';

                    if (type) value = this.formatting[name][type];

                    this.inline.format(this.formatting[name].tag, type, value);

                },
                format: function(tag, type, value)
                {
                    // Stop formatting pre and headers
                    if (this.utils.isCurrentOrParent('PRE') || this.utils.isCurrentOrParentHeader()) return;

                    var tags = ['b', 'bold', 'i', 'italic', 'underline', 'strikethrough', 'deleted', 'superscript', 'subscript'];
                    var replaced = ['strong', 'strong', 'em', 'em', 'u', 'del', 'del', 'sup', 'sub'];

                    for (var i = 0; i < tags.length; i++)
                    {
                        if (tag == tags[i]) tag = replaced[i];
                    }

                    this.inline.type = type || false;
                    this.inline.value = value || false;

                    this.buffer.set();

                    if (!this.utils.browser('msie'))
                    {
                        this.$editor.focus();
                    }

                    this.selection.get();

                    if (this.range.collapsed)
                    {
                        this.inline.formatCollapsed(tag);
                    }
                    else
                    {
                        this.inline.formatMultiple(tag);
                    }
                },
                formatCollapsed: function(tag)
                {
                    var current = this.selection.getCurrent();
                    var $parent = $(current).closest(tag + '[data-redactor-tag=' + tag + ']');

                    // inline there is
                    if ($parent.length !== 0 && (this.inline.type != 'style' && $parent[0].tagName != 'SPAN'))
                    {
                        // remove empty
                        if (this.utils.isEmpty($parent.text()))
                        {
                            this.caret.setAfter($parent[0]);

                            $parent.remove();
                            this.code.sync();
                        }
                        else if (this.utils.isEndOfElement($parent))
                        {
                            this.caret.setAfter($parent[0]);
                        }

                        return;
                    }

                    // create empty inline
                    var node = $('<' + tag + '>').attr('data-verified', 'redactor').attr('data-redactor-tag', tag);
                    node.html(this.opts.invisibleSpace);

                    node = this.inline.setFormat(node);

                    var node = this.insert.node(node);
                    this.caret.setEnd(node);

                    this.code.sync();
                },
                formatMultiple: function(tag)
                {
                    this.inline.formatConvert(tag);

                    this.selection.save();
                    document.execCommand('strikethrough');

                    this.$editor.find('strike').each($.proxy(function(i,s)
                    {
                        var $el = $(s);

                        this.inline.formatRemoveSameChildren($el, tag);

                        var $span;
                        if (this.inline.type)
                        {
                            $span = $('<span>').attr('data-redactor-tag', tag).attr('data-verified', 'redactor');
                            $span = this.inline.setFormat($span);
                        }
                        else
                        {
                            $span = $('<' + tag + '>').attr('data-redactor-tag', tag).attr('data-verified', 'redactor');
                        }

                        $el.replaceWith($span.html($el.contents()));

                        if (tag == 'span')
                        {
                            var $parent = $span.parent();
                            if ($parent && $parent[0].tagName == 'SPAN' && this.inline.type == 'style')
                            {
                                var arr = this.inline.value.split(';');

                                for (var z = 0; z < arr.length; z++)
                                {
                                    if (arr[z] === '') return;
                                    var style = arr[z].split(':');
                                    $parent.css(style[0], '');

                                    if (this.utils.removeEmptyAttr($parent, 'style'))
                                    {
                                        $parent.replaceWith($parent.contents());
                                    }

                                }

                            }
                        }

                    }, this));

                    // clear text decoration
                    if (tag != 'span')
                    {
                        this.$editor.find(this.opts.inlineTags.join(', ')).each($.proxy(function(i,s)
                        {
                            var $el = $(s);
                            var property = $el.css('text-decoration');
                            if (property == 'line-through')
                            {
                                $el.css('text-decoration', '');
                                this.utils.removeEmptyAttr($el, 'style');
                            }
                        }, this));
                    }

                    if (tag != 'del')
                    {
                        var _this = this;
                        this.$editor.find('inline').each(function(i,s)
                        {
                            _this.utils.replaceToTag(s, 'del');
                        });
                    }

                    this.selection.restore();
                    this.code.sync();

                },
                formatRemoveSameChildren: function($el, tag)
                {
                    var self = this;
                    $el.children(tag).each(function()
                    {
                        var $child = $(this);

                        if (!$child.hasClass('redactor-selection-marker'))
                        {
                            if (self.inline.type == 'style')
                            {
                                var arr = self.inline.value.split(';');

                                for (var z = 0; z < arr.length; z++)
                                {
                                    if (arr[z] === '') return;

                                    var style = arr[z].split(':');
                                    $child.css(style[0], '');

                                    if (self.utils.removeEmptyAttr($child , 'style'))
                                    {
                                        $child.replaceWith($child.contents());
                                    }

                                }
                            }
                            else
                            {
                                $child.contents().unwrap();
                            }
                        }

                    });
                },
                formatConvert: function(tag)
                {
                    this.selection.save();

                    var find = '';
                    if (this.inline.type == 'class') find = '[data-redactor-class=' + this.inline.value + ']';
                    else if (this.inline.type == 'style')
                    {
                        find = '[data-redactor-style="' + this.inline.value + '"]';
                    }

                    var self = this;
                    if (tag != 'del')
                    {
                        this.$editor.find('del').each(function(i,s)
                        {
                            self.utils.replaceToTag(s, 'inline');
                        });
                    }

                    if (tag != 'span')
                    {
                        this.$editor.find(tag).each(function()
                        {
                            var $el = $(this);
                            $el.replaceWith($('<strike />').html($el.contents()));

                        });
                    }

                    this.$editor.find('[data-redactor-tag="' + tag + '"]' + find).each(function()
                    {
                        if (find === '' && tag == 'span' && this.tagName.toLowerCase() == tag) return;

                        var $el = $(this);
                        $el.replaceWith($('<strike />').html($el.contents()));

                    });

                    this.selection.restore();
                },
                setFormat: function(node)
                {
                    switch (this.inline.type)
                    {
                        case 'class':

                            if (node.hasClass(this.inline.value))
                            {
                                node.removeClass(this.inline.value);
                                node.removeAttr('data-redactor-class');
                            }
                            else
                            {
                                node.addClass(this.inline.value);
                                node.attr('data-redactor-class', this.inline.value);
                            }


                        break;
                        case 'style':

                            node[0].style.cssText = this.inline.value;
                            node.attr('data-redactor-style', this.inline.value);

                        break;
                    }

                    return node;
                },
                removeStyle: function()
                {
                    this.buffer.set();
                    var current = this.selection.getCurrent();
                    var nodes = this.selection.getInlines();

                    this.selection.save();

                    if (current && current.tagName === 'SPAN')
                    {
                        var $s = $(current);

                        $s.removeAttr('style');
                        if ($s[0].attributes.length === 0)
                        {
                            $s.replaceWith($s.contents());
                        }
                    }

                    $.each(nodes, $.proxy(function(i,s)
                    {
                        var $s = $(s);
                        if ($.inArray(s.tagName.toLowerCase(), this.opts.inlineTags) != -1 && !$s.hasClass('redactor-selection-marker'))
                        {
                            $s.removeAttr('style');
                            if ($s[0].attributes.length === 0)
                            {
                                $s.replaceWith($s.contents());
                            }
                        }
                    }, this));

                    this.selection.restore();
                    this.code.sync();

                },
                removeStyleRule: function(name)
                {
                    this.buffer.set();
                    var parent = this.selection.getParent();
                    var nodes = this.selection.getInlines();

                    this.selection.save();

                    if (parent && parent.tagName === 'SPAN')
                    {
                        var $s = $(parent);

                        $s.css(name, '');
                        this.utils.removeEmptyAttr($s, 'style');
                        if ($s[0].attributes.length === 0)
                        {
                            $s.replaceWith($s.contents());
                        }
                    }

                    $.each(nodes, $.proxy(function(i,s)
                    {
                        var $s = $(s);
                        if ($.inArray(s.tagName.toLowerCase(), this.opts.inlineTags) != -1 && !$s.hasClass('redactor-selection-marker'))
                        {
                            $s.css(name, '');
                            this.utils.removeEmptyAttr($s, 'style');
                            if ($s[0].attributes.length === 0)
                            {
                                $s.replaceWith($s.contents());
                            }
                        }
                    }, this));

                    this.selection.restore();
                    this.code.sync();
                },
                removeFormat: function()
                {
                    this.buffer.set();
                    var current = this.selection.getCurrent();

                    this.selection.save();

                    document.execCommand('removeFormat');

                    if (current && current.tagName === 'SPAN')
                    {
                        $(current).replaceWith($(current).contents());
                    }


                    $.each(this.selection.getNodes(), $.proxy(function(i,s)
                    {
                        var $s = $(s);
                        if ($.inArray(s.tagName.toLowerCase(), this.opts.inlineTags) != -1 && !$s.hasClass('redactor-selection-marker'))
                        {
                            $s.replaceWith($s.contents());
                        }
                    }, this));

                    this.selection.restore();
                    this.code.sync();

                },
                toggleClass: function(className)
                {
                    this.inline.format('span', 'class', className);
                },
                toggleStyle: function(value)
                {
                    this.inline.format('span', 'style', value);
                }
            };
        },
        insert: function()
        {
            return {
                set: function(html, clean)
                {
                    this.placeholder.remove();

                    html = this.clean.setVerified(html);

                    if (typeof clean == 'undefined')
                    {
                        html = this.clean.onPaste(html, false);
                    }

                    this.$editor.html(html);
                    this.selection.remove();
                    this.focus.setEnd();
                    this.clean.normalizeLists();
                    this.code.sync();
                    this.observe.load();

                    if (typeof clean == 'undefined')
                    {
                        setTimeout($.proxy(this.clean.clearUnverified, this), 10);
                    }
                },
                text: function(text)
                {
                    this.placeholder.remove();

                    text = text.toString();
                    text = $.trim(text);
                    text = this.clean.getPlainText(text, false);

                    this.$editor.focus();

                    if (this.utils.browser('msie'))
                    {
                        this.insert.htmlIe(text);
                    }
                    else
                    {
                        this.selection.get();

                        this.range.deleteContents();
                        var el = document.createElement("div");
                        el.innerHTML = text;
                        var frag = document.createDocumentFragment(), node, lastNode;
                        while ((node = el.firstChild))
                        {
                            lastNode = frag.appendChild(node);
                        }

                        this.range.insertNode(frag);

                        if (lastNode)
                        {
                            var range = this.range.cloneRange();
                            range.setStartAfter(lastNode);
                            range.collapse(true);
                            this.sel.removeAllRanges();
                            this.sel.addRange(range);
                        }
                    }

                    this.code.sync();
                    this.clean.clearUnverified();
                },
                htmlWithoutClean: function(html)
                {
                    this.insert.html(html, false);
                },
                html: function(html, clean)
                {
                    this.placeholder.remove();

                    if (typeof clean == 'undefined') clean = true;

                    this.$editor.focus();

                    html = this.clean.setVerified(html);

                    if (clean)
                    {
                        html = this.clean.onPaste(html);
                    }

                    if (this.utils.browser('msie'))
                    {
                        this.insert.htmlIe(html);
                    }
                    else
                    {
                        if (this.clean.singleLine) this.insert.execHtml(html);
                        else document.execCommand('insertHTML', false, html);

                        this.insert.htmlFixMozilla();

                    }

                    this.clean.normalizeLists();

                    // remove empty paragraphs finaly
                    if (!this.opts.linebreaks)
                    {
                        this.$editor.find('p').each($.proxy(this.utils.removeEmpty, this));
                    }

                    this.code.sync();
                    this.observe.load();

                    if (clean)
                    {
                        this.clean.clearUnverified();
                    }

                },
                htmlFixMozilla: function()
                {
                    // FF inserts empty p when content was selected dblclick
                    if (!this.utils.browser('mozilla')) return;

                    var $next = $(this.selection.getBlock()).next();
                    if ($next.length > 0 && $next[0].tagName == 'P' && $next.html() === '')
                    {
                        $next.remove();
                    }

                },
                htmlIe: function(html)
                {
                    if (this.utils.isIe11())
                    {
                        var parent = this.utils.isCurrentOrParent('P');
                        var $html = $('<div>').append(html);
                        var blocksMatch = $html.contents().is('p, :header, dl, ul, ol, div, table, td, blockquote, pre, address, section, header, footer, aside, article');

                        if (parent && blocksMatch) this.insert.ie11FixInserting(parent, html);
                        else this.insert.ie11PasteFrag(html);

                        return;
                    }

                    document.selection.createRange().pasteHTML(html);

                },
                execHtml: function(html)
                {
                    html = this.clean.setVerified(html);

                    this.selection.get();

                    this.range.deleteContents();

                    var el = document.createElement('div');
                    el.innerHTML = html;

                    var frag = document.createDocumentFragment(), node, lastNode;
                    while ((node = el.firstChild))
                    {
                        lastNode = frag.appendChild(node);
                    }

                    this.range.insertNode(frag);

                    this.range.collapse(true);
                    this.caret.setAfter(lastNode);

                },
                node: function(node, deleteContents)
                {
                    node = node[0] || node;

                    var html = this.utils.getOuterHtml(node);
                    html = this.clean.setVerified(html);

                    if (html.match(/</g) !== null)
                    {
                        node = $(html)[0];
                    }

                    this.selection.get();

                    if (deleteContents !== false)
                    {
                        this.range.deleteContents();
                    }

                    this.range.insertNode(node);
                    this.range.collapse(false);
                    this.selection.addRange();

                    return node;
                },
                nodeToPoint: function(node, x, y)
                {
                    node = node[0] || node;

                    this.selection.get();

                    var range;
                    if (document.caretPositionFromPoint)
                    {
                        var pos = document.caretPositionFromPoint(x, y);

                        this.range.setStart(pos.offsetNode, pos.offset);
                        this.range.collapse(true);
                        this.range.insertNode(node);
                    }
                    else if (document.caretRangeFromPoint)
                    {
                        range = document.caretRangeFromPoint(x, y);
                        range.insertNode(node);
                    }
                    else if (typeof document.body.createTextRange != "undefined")
                    {
                        range = document.body.createTextRange();
                        range.moveToPoint(x, y);
                        var endRange = range.duplicate();
                        endRange.moveToPoint(x, y);
                        range.setEndPoint("EndToEnd", endRange);
                        range.select();
                    }
                },
                nodeToCaretPositionFromPoint: function(e, node)
                {
                    node = node[0] || node;

                    var range;
                    var x = e.clientX, y = e.clientY;
                    if (document.caretPositionFromPoint)
                    {
                        var pos = document.caretPositionFromPoint(x, y);
                        var sel = document.getSelection();
                        range = sel.getRangeAt(0);
                        range.setStart(pos.offsetNode, pos.offset);
                        range.collapse(true);
                        range.insertNode(node);
                    }
                    else if (document.caretRangeFromPoint)
                    {
                        range = document.caretRangeFromPoint(x, y);
                        range.insertNode(node);
                    }
                    else if (typeof document.body.createTextRange != "undefined")
                    {
                        range = document.body.createTextRange();
                        range.moveToPoint(x, y);
                        var endRange = range.duplicate();
                        endRange.moveToPoint(x, y);
                        range.setEndPoint("EndToEnd", endRange);
                        range.select();
                    }

                },
                ie11FixInserting: function(parent, html)
                {
                    var node = document.createElement('span');
                    node.className = 'redactor-ie-paste';
                    this.insert.node(node);

                    var parHtml = $(parent).html();

                    parHtml = '<p>' + parHtml.replace(/<span class="redactor-ie-paste"><\/span>/gi, '</p>' + html + '<p>') + '</p>';
                    $(parent).replaceWith(parHtml);
                },
                ie11PasteFrag: function(html)
                {
                    this.selection.get();
                    this.range.deleteContents();

                    var el = document.createElement("div");
                    el.innerHTML = html;

                    var frag = document.createDocumentFragment(), node, lastNode;
                    while ((node = el.firstChild))
                    {
                        lastNode = frag.appendChild(node);
                    }

                    this.range.insertNode(frag);
                    this.range.collapse(false);
                    this.selection.addRange();
                }
            };
        },
        keydown: function()
        {
            return {
                init: function(e)
                {
                    if (this.rtePaste) return;

                    var key = e.which;
                    var arrow = (key >= 37 && key <= 40);

                    this.keydown.ctrl = e.ctrlKey || e.metaKey;
                    this.keydown.current = this.selection.getCurrent();
                    this.keydown.parent = this.selection.getParent();
                    this.keydown.block = this.selection.getBlock();

                    // detect tags
                    this.keydown.pre = this.utils.isTag(this.keydown.current, 'pre');
                    this.keydown.blockquote = this.utils.isTag(this.keydown.current, 'blockquote');
                    this.keydown.figcaption = this.utils.isTag(this.keydown.current, 'figcaption');

                    // shortcuts setup
                    this.shortcuts.init(e, key);

                    this.keydown.checkEvents(arrow, key);
                    this.keydown.setupBuffer(e, key);
                    this.keydown.addArrowsEvent(arrow);
                    this.keydown.setupSelectAll(e, key);

                    // callback
                    var keydownStop = this.core.setCallback('keydown', e);
                    if (keydownStop === false)
                    {
                        e.preventDefault();
                        return false;
                    }

                    // ie and ff exit from table
                    if (this.opts.enterKey && (this.utils.browser('msie') || this.utils.browser('mozilla')) && (key === this.keyCode.DOWN || key === this.keyCode.RIGHT))
                    {
                        var isEndOfTable = false;
                        var $table = false;
                        if (this.keydown.block && this.keydown.block.tagName === 'TD')
                        {
                            $table = $(this.keydown.block).closest('table');
                        }

                        if ($table && $table.find('td').last()[0] === this.keydown.block)
                        {
                            isEndOfTable = true;
                        }

                        if (this.utils.isEndOfElement() && isEndOfTable)
                        {
                            var node = $(this.opts.emptyHtml);
                            $table.after(node);
                            this.caret.setStart(node);
                        }
                    }

                    // down
                    if (this.opts.enterKey && key === this.keyCode.DOWN)
                    {
                        this.keydown.onArrowDown();
                    }

                    // turn off enter key
                    if (!this.opts.enterKey && key === this.keyCode.ENTER)
                    {
                        e.preventDefault();
                        // remove selected
                        if (!this.range.collapsed) this.range.deleteContents();
                        return;
                    }

                    // on enter
                    if (key == this.keyCode.ENTER && !e.shiftKey && !e.ctrlKey && !e.metaKey)
                    {
                        var stop = this.core.setCallback('enter', e);
                        if (stop === false)
                        {
                            e.preventDefault();
                            return false;
                        }

                        if (this.keydown.blockquote && this.keydown.exitFromBlockquote(e) === true)
                        {
                            return false;
                        }

                        var current, $next;
                        if (this.keydown.pre)
                        {
                            return this.keydown.insertNewLine(e);
                        }
                        else if (this.keydown.blockquote || this.keydown.figcaption)
                        {
                            current = this.selection.getCurrent();
                            $next = $(current).next();

                            if ($next.length !== 0 && $next[0].tagName == 'BR')
                            {
                                return this.keydown.insertBreakLine(e);
                            }
                            else if (this.utils.isEndOfElement() && (current && current != 'SPAN'))
                            {
                                return this.keydown.insertDblBreakLine(e);
                            }
                            else
                            {
                                return this.keydown.insertBreakLine(e);
                            }
                        }
                        else if (this.opts.linebreaks && !this.keydown.block)
                        {
                            current = this.selection.getCurrent();
                            $next = $(this.keydown.current).next();



                            if ($next.length !== 0 && $next[0].tagName == 'BR')
                            {
                                return this.keydown.insertBreakLine(e);
                            }
                            else if (current !== false && $(current).hasClass('redactor-invisible-space'))
                            {
                                this.caret.setAfter(current);
                                $(current).contents().unwrap();

                                return this.keydown.insertDblBreakLine(e);
                            }
                            else
                            {
                                if (this.utils.isEndOfEditor())
                                {
                                    return this.keydown.insertDblBreakLine(e);
                                }
                                else if ($next.length === 0 && current === false && typeof $next.context != 'undefined')
                                {
                                    return this.keydown.insertBreakLine(e);
                                }

                                return this.keydown.insertBreakLine(e);
                            }
                        }
                        else if (this.opts.linebreaks && this.keydown.block)
                        {
                            setTimeout($.proxy(this.keydown.replaceDivToBreakLine, this), 1);
                        }
                        // paragraphs
                        else if (!this.opts.linebreaks && this.keydown.block)
                        {
                            if (this.keydown.block.tagName !== 'LI')
                            {
                                setTimeout($.proxy(this.keydown.replaceDivToParagraph, this), 1);
                            }
                            else
                            {
                                current = this.selection.getCurrent();
                                var $parent = $(current).closest('li');
                                var $list = $parent.closest('ul,ol');

                                if ($parent.length !== 0 && this.utils.isEmpty($parent.html()) && $list.next().length === 0)
                                {
                                    var node = $(this.opts.emptyHtml);
                                    $list.after(node);
                                    this.caret.setStart(node);

                                    return false;
                                }
                            }
                        }
                        else if (!this.opts.linebreaks && !this.keydown.block)
                        {
                            return this.keydown.insertParagraph(e);
                        }
                    }

                    // Shift+Enter or Ctrl+Enter
                    if (key === this.keyCode.ENTER && (e.ctrlKey || e.shiftKey))
                    {
                        return this.keydown.onShiftEnter(e);
                    }


                    // tab or cmd + [
                    if (key === this.keyCode.TAB || e.metaKey && key === 221 || e.metaKey && key === 219)
                    {
                        return this.keydown.onTab(e, key);
                    }

                    // image delete and backspace
                    if (key === this.keyCode.BACKSPACE || key === this.keyCode.DELETE)
                    {
                        if (this.utils.browser('mozilla') && this.keydown.current && this.keydown.current.tagName === 'TD')
                        {
                            e.preventDefault();
                            return false;
                        }

                        var nodes = this.selection.getNodes();
                        if (nodes)
                        {
                            var len = nodes.length;
                            var last;
                            for (var i = 0; i < len; i++)
                            {
                                var children = $(nodes[i]).children('img');
                                if (children.length !== 0)
                                {
                                    var self = this;
                                    $.each(children, function(z,s)
                                    {
                                        var $s = $(s);
                                        if ($s.css('float') != 'none') return;

                                        // image delete callback
                                        self.core.setCallback('imageDelete', s.src, $s);
                                        last = s;
                                    });
                                }
                                else if (nodes[i].tagName == 'IMG')
                                {
                                    if (last != nodes[i])
                                    {
                                        // image delete callback
                                        this.core.setCallback('imageDelete', nodes[i].src, $(nodes[i]));
                                        last = nodes[i];
                                    }
                                }
                            }
                        }
                    }

                    // backspace
                    if (key === this.keyCode.BACKSPACE)
                    {
                        this.keydown.removeInvisibleSpace();
                        this.keydown.removeEmptyListInTable(e);
                    }

                    this.code.sync();
                },
                checkEvents: function(arrow, key)
                {
                    if (!arrow && (this.core.getEvent() == 'click' || this.core.getEvent() == 'arrow'))
                    {
                        this.core.addEvent(false);

                        if (this.keydown.checkKeyEvents(key))
                        {
                            this.buffer.set();
                        }
                    }
                },
                checkKeyEvents: function(key)
                {
                    var k = this.keyCode;
                    var keys = [k.BACKSPACE, k.DELETE, k.ENTER, k.SPACE, k.ESC, k.TAB, k.CTRL, k.META, k.ALT, k.SHIFT];

                    return ($.inArray(key, keys) == -1) ? true : false;

                },
                addArrowsEvent: function(arrow)
                {
                    if (!arrow) return;

                    if ((this.core.getEvent() == 'click' || this.core.getEvent() == 'arrow'))
                    {
                        this.core.addEvent(false);
                        return;
                    }

                    this.core.addEvent('arrow');
                },
                setupBuffer: function(e, key)
                {
                    if (this.keydown.ctrl && key === 90 && !e.shiftKey && !e.altKey && this.opts.buffer.length) // z key
                    {
                        e.preventDefault();
                        this.buffer.undo();
                        return;
                    }
                    // undo
                    else if (this.keydown.ctrl && key === 90 && e.shiftKey && !e.altKey && this.opts.rebuffer.length !== 0)
                    {
                        e.preventDefault();
                        this.buffer.redo();
                        return;
                    }
                    else if (!this.keydown.ctrl)
                    {
                        if (key == this.keyCode.BACKSPACE || key == this.keyCode.DELETE || (key == this.keyCode.ENTER && !e.ctrlKey && !e.shiftKey) || key == this.keyCode.SPACE)
                        {
                            this.buffer.set();
                        }
                    }
                },
                setupSelectAll: function(e, key)
                {
                    if (this.keydown.ctrl && key === 65)
                    {
                        this.utils.enableSelectAll();
                    }
                    else if (key != this.keyCode.LEFT_WIN && !this.keydown.ctrl)
                    {
                        this.utils.disableSelectAll();
                    }
                },
                onArrowDown: function()
                {
                    var tags = [this.keydown.blockquote, this.keydown.pre, this.keydown.figcaption];

                    for (var i = 0; i < tags.length; i++)
                    {
                        if (tags[i])
                        {
                            this.keydown.insertAfterLastElement(tags[i]);
                            return false;
                        }
                    }
                },
                onShiftEnter: function(e)
                {
                    this.buffer.set();

                    if (this.utils.isEndOfElement())
                    {
                        return this.keydown.insertDblBreakLine(e);
                    }

                    return this.keydown.insertBreakLine(e);
                },
                onTab: function(e, key)
                {
                    if (!this.opts.tabKey) return true;
                    if (this.utils.isEmpty(this.code.get()) && this.opts.tabAsSpaces === false) return true;

                    e.preventDefault();

                    var node;
                    if (this.keydown.pre && !e.shiftKey)
                    {
                        node = (this.opts.preSpaces) ? document.createTextNode(Array(this.opts.preSpaces + 1).join('\u00a0')) : document.createTextNode('\t');
                        this.insert.node(node);
                        this.code.sync();
                    }
                    else if (this.opts.tabAsSpaces !== false)
                    {
                        node = document.createTextNode(Array(this.opts.tabAsSpaces + 1).join('\u00a0'));
                        this.insert.node(node);
                        this.code.sync();
                    }
                    else
                    {
                        if (e.metaKey && key === 219) this.indent.decrease();
                        else if (e.metaKey && key === 221) this.indent.increase();
                        else if (!e.shiftKey) this.indent.increase();
                        else this.indent.decrease();
                    }

                    return false;
                },
                replaceDivToBreakLine: function()
                {
                    var blockElem = this.selection.getBlock();
                    var blockHtml = blockElem.innerHTML.replace(/<br\s?\/?>/gi, '');
                    if ((blockElem.tagName === 'DIV' || blockElem.tagName === 'P') && blockHtml === '' && !$(blockElem).hasClass('redactor-editor'))
                    {
                        var br = document.createElement('br');

                        $(blockElem).replaceWith(br);
                        this.caret.setBefore(br);

                        this.code.sync();

                        return false;
                    }
                },
                replaceDivToParagraph: function()
                {
                    var blockElem = this.selection.getBlock();
                    var blockHtml = blockElem.innerHTML.replace(/<br\s?\/?>/gi, '');
                    if (blockElem.tagName === 'DIV' && blockHtml === '' && !$(blockElem).hasClass('redactor-editor'))
                    {
                        var p = document.createElement('p');
                        p.innerHTML = this.opts.invisibleSpace;

                        $(blockElem).replaceWith(p);
                        this.caret.setStart(p);

                        this.code.sync();

                        return false;
                    }
                    else if (this.opts.cleanStyleOnEnter && blockElem.tagName == 'P')
                    {
                        $(blockElem).removeAttr('class').removeAttr('style');
                    }
                },
                insertParagraph: function(e)
                {
                    e.preventDefault();

                    this.selection.get();

                    var p = document.createElement('p');
                    p.innerHTML = this.opts.invisibleSpace;

                    this.range.deleteContents();
                    this.range.insertNode(p);

                    this.caret.setStart(p);

                    this.code.sync();

                    return false;
                },
                exitFromBlockquote: function(e)
                {
                    if (!this.utils.isEndOfElement()) return;

                    var tmp = $.trim($(this.keydown.block).html());
                    if (tmp.search(/(<br\s?\/?>){2}$/i) != -1)
                    {
                        e.preventDefault();

                        if (this.opts.linebreaks)
                        {
                            var br = document.createElement('br');
                            $(this.keydown.blockquote).after(br);

                            this.caret.setBefore(br);
                            $(this.keydown.block).html(tmp.replace(/<br\s?\/?>$/i, ''));
                        }
                        else
                        {
                            var node = $(this.opts.emptyHtml);
                            $(this.keydown.blockquote).after(node);
                            this.caret.setStart(node);
                        }

                        return true;

                    }

                    return;

                },
                insertAfterLastElement: function(element)
                {
                    if (!this.utils.isEndOfElement()) return;

                    this.buffer.set();

                    if (this.opts.linebreaks)
                    {
                        var contents = $('<div>').append($.trim(this.$editor.html())).contents();
                        var last = contents.last()[0];
                        if (last.tagName == 'SPAN' && last.innerHTML === '')
                        {
                            last = contents.prev()[0];
                        }

                        if (this.utils.getOuterHtml(last) != this.utils.getOuterHtml(element)) return;

                        var br = document.createElement('br');
                        $(element).after(br);
                        this.caret.setAfter(br);

                    }
                    else
                    {
                        if (this.$editor.contents().last()[0] !== element) return;

                        var node = $(this.opts.emptyHtml);
                        $(element).after(node);
                        this.caret.setStart(node);
                    }
                },
                insertNewLine: function(e)
                {
                    e.preventDefault();

                    var node = document.createTextNode('\n');

                    this.selection.get();

                    this.range.deleteContents();
                    this.range.insertNode(node);

                    this.caret.setAfter(node);

                    this.code.sync();

                    return false;
                },
                insertBreakLine: function(e)
                {
                    return this.keydown.insertBreakLineProcessing(e);
                },
                insertDblBreakLine: function(e)
                {
                    return this.keydown.insertBreakLineProcessing(e, true);
                },
                insertBreakLineProcessing: function(e, dbl)
                {
                    e.stopPropagation();

                    this.selection.get();
                    var br1 = document.createElement('br');

                    if (this.utils.browser('msie'))
                    {
                        this.range.collapse(false);
                        this.range.setEnd(this.range.endContainer, this.range.endOffset);
                    }
                    else
                    {
                        this.range.deleteContents();
                    }

                    this.range.insertNode(br1);

                    if (dbl === true)
                    {

                        var $next = $(br1).next();
                        if ($next.length !== 0 && $next[0].tagName === 'BR' && this.utils.isEndOfEditor())
                        {
                            this.caret.setAfter(br1);
                            this.code.sync();
                            return false;
                        }

                        var br2 = document.createElement('br');
                        this.range.insertNode(br2);
                        this.caret.setAfter(br2);
                    }
                    else
                    {
                        this.keydown.insertBreakLineProcessingAfter(br1);
                    }

                    this.code.sync();
                    return false;
                },
                insertBreakLineProcessingAfter: function(node)
                {
                    var space = this.utils.createSpaceElement();
                    $(node).after(space);
                    this.selection.selectElement(space);

                    $(space).replaceWith(function()
                    {
                        return $(this).contents();
                    });
                },
                removeInvisibleSpace: function()
                {
                    var $current = $(this.keydown.current);
                    if ($current.text().search(/^\u200B$/g) === 0)
                    {
                        $current.remove();
                    }
                },
                removeEmptyListInTable: function(e)
                {
                    var $current = $(this.keydown.current);
                    var $parent = $(this.keydown.parent);
                    var td = $current.closest('td');

                    if (td.length !== 0 && $current.closest('li') && $parent.children('li').length === 1)
                    {
                        if (!this.utils.isEmpty($current.text())) return;

                        e.preventDefault();

                        $current.remove();
                        $parent.remove();

                        this.caret.setStart(td);
                    }
                }
            };
        },
        keyup: function()
        {
            return {
                init: function(e)
                {
                    if (this.rtePaste) return;

                    var key = e.which;

                    this.keyup.current = this.selection.getCurrent();
                    this.keyup.parent = this.selection.getParent();
                    var $parent = this.utils.isRedactorParent($(this.keyup.parent).parent());

                    // callback
                    var keyupStop = this.core.setCallback('keyup', e);
                    if (keyupStop === false)
                    {
                        e.preventDefault();
                        return false;
                    }

                    // replace to p before / after the table or body
                    if (!this.opts.linebreaks && this.keyup.current.nodeType == 3 && this.keyup.current.length <= 1 && (this.keyup.parent === false || this.keyup.parent.tagName == 'BODY'))
                    {
                        this.keyup.replaceToParagraph();
                    }

                    // replace div after lists
                    if (!this.opts.linebreaks && this.utils.isRedactorParent(this.keyup.current) && this.keyup.current.tagName === 'DIV')
                    {
                        this.keyup.replaceToParagraph(false);
                    }


                    if (!this.opts.linebreaks && $(this.keyup.parent).hasClass('redactor-invisible-space') && ($parent === false || $parent[0].tagName == 'BODY'))
                    {
                        $(this.keyup.parent).contents().unwrap();
                        this.keyup.replaceToParagraph();
                    }

                    // linkify
                    if (this.keyup.isLinkify(key))
                    {
                        this.formatLinkify(this.opts.linkProtocol, this.opts.convertLinks, this.opts.convertUrlLinks, this.opts.convertImageLinks, this.opts.convertVideoLinks, this.opts.linkSize);

                        this.observe.load();
                        this.code.sync();
                    }

                    if (key === this.keyCode.DELETE || key === this.keyCode.BACKSPACE)
                    {
                        // clear unverified
                        this.clean.clearUnverified();

                        if (this.observe.image)
                        {
                            e.preventDefault();

                            this.image.hideResize();

                            this.buffer.set();
                            this.image.remove(this.observe.image);
                            this.observe.image = false;

                            return false;
                        }

                        // remove empty paragraphs
                        this.$editor.find('p').each($.proxy(this.utils.removeEmpty, this));

                        // remove invisible space
                        if (this.opts.linebreaks && this.keyup.current && this.keyup.current.tagName == 'DIV' && this.utils.isEmpty(this.keyup.current.innerHTML))
                        {
                            $(this.keyup.current).after(this.selection.getMarkerAsHtml());
                            this.selection.restore();
                            $(this.keyup.current).remove();
                        }

                        // if empty
                        return this.keyup.formatEmpty(e);
                    }
                },
                isLinkify: function(key)
                {
                    return this.opts.convertLinks && (this.opts.convertUrlLinks || this.opts.convertImageLinks || this.opts.convertVideoLinks) && key === this.keyCode.ENTER && !this.utils.isCurrentOrParent('PRE');
                },
                replaceToParagraph: function(clone)
                {
                    var $current = $(this.keyup.current);

                    var node;
                    if (clone === false)
                    {
                        node = $('<p>').append($current.html());
                    }
                    else
                    {
                        node = $('<p>').append($current.clone());
                    }

                    $current.replaceWith(node);
                    var next = $(node).next();
                    if (typeof(next[0]) !== 'undefined' && next[0].tagName == 'BR')
                    {
                        next.remove();
                    }

                    this.caret.setEnd(node);
                },
                formatEmpty: function(e)
                {
                    var html = $.trim(this.$editor.html());

                    if (!this.utils.isEmpty(html)) return;

                    e.preventDefault();

                    if (this.opts.linebreaks)
                    {
                        this.$editor.html(this.selection.getMarkerAsHtml());
                        this.selection.restore();
                    }
                    else
                    {
                        html = '<p><br /></p>';

                        this.$editor.html(html);
                        this.focus.setStart();
                    }

                    this.code.sync();

                    return false;
                }
            };
        },
        lang: function()
        {
            return {
                load: function()
                {
                    this.opts.curLang = this.opts.langs[this.opts.lang];
                },
                get: function(name)
                {
                    return (typeof this.opts.curLang[name] != 'undefined') ? this.opts.curLang[name] : '';
                }
            };
        },
        line: function()
        {
            return {
                insert: function()
                {
                    this.buffer.set();

                    var blocks = this.selection.getBlocks();
                    if (blocks[0] !== false && this.line.isExceptLastOrFirst(blocks))
                    {
                        if (!this.utils.browser('msie')) this.$editor.focus();
                        return;
                    }

                    if (this.utils.browser('msie'))
                    {
                        this.line.insertInIe();
                    }
                    else
                    {
                        this.line.insertInOthersBrowsers();
                    }
                },
                isExceptLastOrFirst: function(blocks)
                {
                    var exceptTags = ['li', 'td', 'th', 'blockquote', 'figcaption', 'pre', 'dl', 'dt', 'dd'];

                    var first = blocks[0].tagName.toLowerCase();
                    var last = this.selection.getLastBlock();

                    last = (typeof last == 'undefined') ? first : last.tagName.toLowerCase();

                    var firstFound = $.inArray(first, exceptTags) != -1;
                    var lastFound = $.inArray(last, exceptTags) != -1;

                    if ((firstFound && lastFound) || firstFound)
                    {
                        return true;
                    }
                },
                insertInIe: function()
                {
                    this.utils.saveScroll();
                    this.buffer.set();

                    this.insert.node(document.createElement('hr'));

                    this.utils.restoreScroll();
                    this.code.sync();
                },
                insertInOthersBrowsers: function()
                {
                    this.buffer.set();

                    var extra = '<p id="redactor-insert-line"><br /></p>';
                    if (this.opts.linebreaks) extra = '<br id="redactor-insert-line">';

                    document.execCommand('insertHTML', false, '<hr>' + extra);

                    this.line.setFocus();
                    this.code.sync();
                },
                setFocus: function()
                {
                    var node = this.$editor.find('#redactor-insert-line');
                    var next = $(node).next()[0];

                    if (next)
                    {
                        this.caret.setAfter(node);
                        node.remove();
                    }
                    else
                    {
                        node.removeAttr('id');
                    }
                }
            };
        },
        link: function()
        {
            return {
                show: function(e)
                {
                    if (typeof e != 'undefined' && e.preventDefault) e.preventDefault();

                    this.modal.load('link', this.lang.get('link_insert'), 600);

                    this.modal.createCancelButton();
                    this.link.buttonInsert = this.modal.createActionButton(this.lang.get('insert'));

                    this.selection.get();

                    this.link.getData();
                    this.link.cleanUrl();

                    if (this.link.target == '_blank') $('#redactor-link-blank').prop('checked', true);

                    this.link.$inputUrl = $('#redactor-link-url');
                    this.link.$inputText = $('#redactor-link-url-text');

                    this.link.$inputText.val(this.link.text);
                    this.link.$inputUrl.val(this.link.url);

                    this.link.buttonInsert.on('click', $.proxy(this.link.insert, this));

                    // hide link's tooltip
                    $('.redactor-link-tooltip').remove();

                    // show modal
                    this.selection.save();
                    this.modal.show();
                    this.link.$inputUrl.focus();
                },
                cleanUrl: function()
                {
                    var thref = self.location.href.replace(/\/$/i, '');
                    this.link.url = this.link.url.replace(thref, '');
                    this.link.url = this.link.url.replace(/^\/#/, '#');
                    this.link.url = this.link.url.replace('mailto:', '');

                    // remove host from href
                    if (!this.opts.linkProtocol)
                    {
                        var re = new RegExp('^(http|ftp|https)://' + self.location.host, 'i');
                        this.link.url = this.link.url.replace(re, '');
                    }

                },
                getData: function()
                {
                    this.link.$node = false;

                    var $el = $(this.selection.getCurrent()).closest('a');
                    if ($el.length !== 0 && $el[0].tagName === 'A')
                    {
                        this.link.$node = $el;

                        this.link.url = $el.attr('href');
                        this.link.text = $el.text();
                        this.link.target = $el.attr('target');
                    }
                    else
                    {
                        this.link.text = this.sel.toString();
                        this.link.url = '';
                        this.link.target = '';
                    }

                },
                insert: function()
                {
                    var target = '';
                    var link = this.link.$inputUrl.val();
                    var text = this.link.$inputText.val();

                    if ($.trim(link) === '')
                    {
                        this.link.$inputUrl.addClass('redactor-input-error').on('keyup', function()
                        {
                            $(this).removeClass('redactor-input-error');
                            $(this).off('keyup');

                        });

                        return;
                    }

                    // mailto
                    if (link.search('@') != -1 && /(http|ftp|https):\/\//i.test(link) === false)
                    {
                        link = 'mailto:' + link;
                    }
                    // url, not anchor
                    else if (link.search('#') !== 0)
                    {
                        if ($('#redactor-link-blank').prop('checked'))
                        {
                            target = '_blank';
                        }

                        // test url (add protocol)
                        var pattern = '((xn--)?[a-z0-9]+(-[a-z0-9]+)*\\.)+[a-z]{2,}';
                        var re = new RegExp('^(http|ftp|https)://' + pattern, 'i');
                        var re2 = new RegExp('^' + pattern, 'i');
                        var re3 = new RegExp('\.(html|php)$', 'i');
                        if (link.search(re) == -1 && link.search(re3) == -1 && link.search(re2) === 0 && this.opts.linkProtocol)
                        {
                            link = this.opts.linkProtocol + '://' + link;
                        }
                    }

                    this.link.set(text, link, target);
                    this.modal.close();
                },
                set: function(text, link, target)
                {
                    text = $.trim(text.replace(/<|>/g, ''));

                    this.selection.restore();

                    if (text === '' && link === '') return;
                    if (text === '' && link !== '') text = link;

                    if (this.link.$node)
                    {
                        this.buffer.set();

                        this.link.$node.text(text).attr('href', link);
                        if (target !== '')
                        {
                            this.link.$node.attr('target', target);
                        }
                        else
                        {
                            this.link.$node.removeAttr('target');
                        }

                        this.code.sync();
                    }
                    else
                    {
                        if (this.utils.browser('mozilla') && this.link.text === '')
                        {
                            var $a = $('<a />').attr('href', link).text(text);
                            if (target !== '') $a.attr('target', target);

                            this.insert.node($a);
                            this.selection.selectElement($a);
                        }
                        else
                        {
                            var $a;
                            if (this.utils.browser('msie'))
                            {
                                $a = $('<a href="' + link + '">').text(text);
                                if (target !== '') $a.attr('target', target);

                                $a = $(this.insert.node($a));
                                this.selection.selectElement($a);
                            }
                            else
                            {
                                document.execCommand('createLink', false, link);

                                $a = $(this.selection.getCurrent()).closest('a');
                                if (this.utils.browser('mozilla'))
                                {
                                    $a = $('a[_moz_dirty=""]');
                                }

                                if (target !== '') $a.attr('target', target);
                                $a.removeAttr('style').removeAttr('_moz_dirty');

                                if (this.link.text !== '' || this.link.text != text)
                                {

                                    $a.text(text);
                                    this.selection.selectElement($a);
                                }
                            }
                        }

                        this.code.sync();
                        this.core.setCallback('insertedLink', $a);

                    }

                    // link tooltip
                    setTimeout($.proxy(function()
                    {
                        this.observe.links();

                    }, this), 5);
                },
                unlink: function(e)
                {
                    if (typeof e != 'undefined' && e.preventDefault)
                    {
                        e.preventDefault();
                    }

                    var nodes = this.selection.getNodes();
                    if (!nodes) return;

                    this.buffer.set();

                    var len = nodes.length;
                    for (var i = 0; i < len; i++)
                    {
                        var $node = $(nodes[i]).closest('a');
                        $node.replaceWith($node.contents());
                    }

                    // hide link's tooltip
                    $('.redactor-link-tooltip').remove();

                    this.code.sync();

                },
                toggleClass: function(className)
                {
                    this.link.setClass(className, 'toggleClass');
                },
                addClass: function(className)
                {
                    this.link.setClass(className, 'addClass');
                },
                removeClass: function(className)
                {
                    this.link.setClass(className, 'removeClass');
                },
                setClass: function(className, func)
                {
                    var links = this.selection.getInlinesTags(['a']);
                    if (links === false) return;

                    $.each(links, function()
                    {
                        $(this)[func](className);
                    });
                }
            };
        },
        list: function()
        {
            return {
                toggle: function(cmd)
                {
                    this.placeholder.remove();
                    if (!this.utils.browser('msie')) this.$editor.focus();

                    this.buffer.set();
                    this.selection.save();

                    var parent = this.selection.getParent();
                    var $list = $(parent).closest('ol, ul');

                    if (!this.utils.isRedactorParent($list) && $list.length !== 0)
                    {
                        $list = false;
                    }

                    var isUnorderedCmdOrdered, isOrderedCmdUnordered;
                    var remove = false;
                    if ($list && $list.length)
                    {
                        remove = true;
                        var listTag = $list[0].tagName;

                        isUnorderedCmdOrdered = (cmd === 'orderedlist' && listTag === 'UL');
                        isOrderedCmdUnordered = (cmd === 'unorderedlist' && listTag === 'OL');
                    }

                    if (isUnorderedCmdOrdered)
                    {
                        this.utils.replaceToTag($list, 'ol');
                    }
                    else if (isOrderedCmdUnordered)
                    {
                        this.utils.replaceToTag($list, 'ul');
                    }
                    else
                    {
                        if (remove)
                        {
                            this.list.remove(cmd);
                        }
                        else
                        {
                            this.list.insert(cmd);
                        }
                    }


                    this.selection.restore();
                    this.code.sync();
                },
                insert: function(cmd)
                {
                    var parent = this.selection.getParent();
                    var current = this.selection.getCurrent();
                    var $td = $(current).closest('td, th');

                    if (this.utils.browser('msie') && this.opts.linebreaks)
                    {
                        this.list.insertInIe(cmd);
                    }
                    else
                    {
                        document.execCommand('insert' + cmd);
                    }

                    var $list = $(this.selection.getParent()).closest('ol, ul');

                    if ($td.length !== 0)
                    {
                        var prev = $td.prev();
                        var html = $td.html();
                        $td.html('');
                        if (prev && prev.length === 1 && (prev[0].tagName === 'TD' || prev[0].tagName === 'TH'))
                        {
                            $(prev).after($td);
                        }
                        else
                        {
                            $(parent).prepend($td);
                        }

                        $td.html(html);
                    }

                    if (this.utils.isEmpty($list.find('li').text()))
                    {
                        var $children = $list.children('li');
                        $children.find('br').remove();
                        $children.append(this.selection.getMarkerAsHtml());
                    }

                    if ($list.length)
                    {
                        // remove block-element list wrapper
                        var $listParent = $list.parent();
                        if (this.utils.isRedactorParent($listParent) && $listParent[0].tagName != 'LI' && this.utils.isBlock($listParent[0]))
                        {
                            $listParent.replaceWith($listParent.contents());
                        }
                    }

                    if (!this.utils.browser('msie'))
                    {
                        this.$editor.focus();
                    }

                    this.clean.clearUnverified();
                },
                insertInIe: function(cmd)
                {
                    var wrapper = this.selection.wrap('div');
                    var wrapperHtml = $(wrapper).html();

                    var tmpList = (cmd == 'orderedlist') ? $('<ol>') : $('<ul>');
                    var tmpLi = $('<li>');

                    if ($.trim(wrapperHtml) === '')
                    {
                        tmpLi.append(this.selection.getMarkerAsHtml());
                        tmpList.append(tmpLi);
                        this.$editor.find('#selection-marker-1').replaceWith(tmpList);
                    }
                    else
                    {
                        var items = wrapperHtml.split(/<br\s?\/?>/gi);
                        if (items)
                        {
                            for (var i = 0; i < items.length; i++)
                            {
                                if ($.trim(items[i]) !== '')
                                {
                                    tmpList.append($('<li>').html(items[i]));
                                }
                            }
                        }
                        else
                        {
                            tmpLi.append(wrapperHtml);
                            tmpList.append(tmpLi);
                        }

                        $(wrapper).replaceWith(tmpList);
                    }
                },
                remove: function(cmd)
                {
                    document.execCommand('insert' + cmd);

                    var $current = $(this.selection.getCurrent());

                    this.indent.fixEmptyIndent();

                    if (!this.opts.linebreaks && $current.closest('li, th, td').length === 0)
                    {
                        document.execCommand('formatblock', false, 'p');
                        this.$editor.find('ul, ol, blockquote').each($.proxy(this.utils.removeEmpty, this));
                    }

                    var $table = $(this.selection.getCurrent()).closest('table');
                    var $prev = $table.prev();
                    if (!this.opts.linebreaks && $table.length !== 0 && $prev.length !== 0 && $prev[0].tagName == 'BR')
                    {
                        $prev.remove();
                    }

                    this.clean.clearUnverified();

                }
            };
        },
        modal: function()
        {
            return {
                callbacks: {},
                loadTemplates: function()
                {
                    this.opts.modal = {
                        imageEdit: String()
                        + '<section id="redactor-modal-image-edit">'
                            + '<label>' + this.lang.get('title') + '</label>'
                            + '<input type="text" id="redactor-image-title" />'
                            + '<label class="redactor-image-link-option">' + this.lang.get('link') + '</label>'
                            + '<input type="text" id="redactor-image-link" class="redactor-image-link-option" />'
                            + '<label class="redactor-image-link-option"><input type="checkbox" id="redactor-image-link-blank"> ' + this.lang.get('link_new_tab') + '</label>'
                            + '<label class="redactor-image-position-option">' + this.lang.get('image_position') + '</label>'
                            + '<select class="redactor-image-position-option" id="redactor-image-align">'
                                + '<option value="none">' + this.lang.get('none') + '</option>'
                                + '<option value="left">' + this.lang.get('left') + '</option>'
                                + '<option value="center">' + this.lang.get('center') + '</option>'
                                + '<option value="right">' + this.lang.get('right') + '</option>'
                            + '</select>'
                        + '</section>',

                        image: String()
                        + '<section id="redactor-modal-image-insert">'
                            + '<div id="redactor-modal-image-droparea"></div>'
                        + '</section>',

                        file: String()
                        + '<section id="redactor-modal-file-insert">'
                            + '<div id="redactor-modal-file-upload-box">'
                                + '<label>' + this.lang.get('filename') + '</label>'
                                + '<input type="text" id="redactor-filename" /><br><br>'
                                + '<div id="redactor-modal-file-upload"></div>'
                            + '</div>'
                        + '</section>',

                        link: String()
                        + '<section id="redactor-modal-link-insert">'
                            + '<label>URL</label>'
                            + '<input type="url" id="redactor-link-url" />'
                            + '<label>' + this.lang.get('text') + '</label>'
                            + '<input type="text" id="redactor-link-url-text" />'
                            + '<label><input type="checkbox" id="redactor-link-blank"> ' + this.lang.get('link_new_tab') + '</label>'
                        + '</section>'
                    };


                    $.extend(this.opts, this.opts.modal);

                },
                addCallback: function(name, callback)
                {
                    this.modal.callbacks[name] = callback;
                },
                createTabber: function($modal)
                {
                    this.modal.$tabber = $('<div>').attr('id', 'redactor-modal-tabber');

                    $modal.prepend(this.modal.$tabber);
                },
                addTab: function(id, name, active)
                {
                    var $tab = $('<a href="#" rel="tab' + id + '">').text(name);
                    if (active)
                    {
                        $tab.addClass('active');
                    }

                    var self = this;
                    $tab.on('click', function(e)
                    {
                        e.preventDefault();
                        $('.redactor-tab').hide();
                        $('.redactor-' + $(this).attr('rel')).show();

                        self.modal.$tabber.find('a').removeClass('active');
                        $(this).addClass('active');

                    });

                    this.modal.$tabber.append($tab);
                },
                addTemplate: function(name, template)
                {
                    this.opts.modal[name] = template;
                },
                getTemplate: function(name)
                {
                    return this.opts.modal[name];
                },
                getModal: function()
                {
                    return this.$modalBody.find('section');
                },
                load: function(templateName, title, width)
                {
                    this.modal.templateName = templateName;
                    this.modal.width = width;

                    this.modal.build();
                    this.modal.enableEvents();
                    this.modal.setTitle(title);
                    this.modal.setDraggable();
                    this.modal.setContent();

                    // callbacks
                    if (typeof this.modal.callbacks[templateName] != 'undefined')
                    {
                        this.modal.callbacks[templateName].call(this);
                    }

                },
                show: function()
                {
                    // ios keyboard hide
                    if (this.utils.isMobile() && !this.utils.browser('msie'))
                    {
                        document.activeElement.blur();
                    }

                    $(document.body).removeClass('body-redactor-hidden');
                    this.modal.bodyOveflow = $(document.body).css('overflow');
                    $(document.body).css('overflow', 'hidden');

                    if (this.utils.isMobile())
                    {
                        this.modal.showOnMobile();
                    }
                    else
                    {
                        this.modal.showOnDesktop();
                    }

                    this.$modalOverlay.show();
                    this.$modalBox.show();

                    this.modal.setButtonsWidth();

                    this.utils.saveScroll();

                    // resize
                    if (!this.utils.isMobile())
                    {
                        setTimeout($.proxy(this.modal.showOnDesktop, this), 0);
                        $(window).on('resize.redactor-modal', $.proxy(this.modal.resize, this));
                    }

                    // modal shown callback
                    this.core.setCallback('modalOpened', this.modal.templateName, this.$modal);

                    // fix bootstrap modal focus
                    $(document).off('focusin.modal');

                    // enter
                    this.$modal.find('input[type=text],input[type=url],input[type=email]').on('keydown.redactor-modal', $.proxy(this.modal.setEnter, this));
                },
                showOnDesktop: function()
                {
                    var height = this.$modal.outerHeight();
                    var windowHeight = $(window).height();
                    var windowWidth = $(window).width();

                    if (this.modal.width > windowWidth)
                    {
                        this.$modal.css({
                            width: '96%',
                            marginTop: (windowHeight/2 - height/2) + 'px'
                        });
                        return;
                    }

                    if (height > windowHeight)
                    {
                        this.$modal.css({
                            width: this.modal.width + 'px',
                            marginTop: '20px'
                        });
                    }
                    else
                    {
                        this.$modal.css({
                            width: this.modal.width + 'px',
                            marginTop: (windowHeight/2 - height/2) + 'px'
                        });
                    }
                },
                showOnMobile: function()
                {
                    this.$modal.css({
                        width: '96%',
                        marginTop: '2%'
                    });

                },
                resize: function()
                {
                    if (this.utils.isMobile())
                    {
                        this.modal.showOnMobile();
                    }
                    else
                    {
                        this.modal.showOnDesktop();
                    }
                },
                setTitle: function(title)
                {
                    this.$modalHeader.html(title);
                },
                setContent: function()
                {
                    this.$modalBody.html(this.modal.getTemplate(this.modal.templateName));
                },
                setDraggable: function()
                {
                    if (typeof $.fn.draggable === 'undefined') return;

                    this.$modal.draggable({ handle: this.$modalHeader });
                    this.$modalHeader.css('cursor', 'move');
                },
                setEnter: function(e)
                {
                    if (e.which != 13) return;

                    e.preventDefault();
                    this.$modal.find('button.redactor-modal-action-btn').click();
                },
                createCancelButton: function()
                {
                    var button = $('<button>').addClass('redactor-modal-btn redactor-modal-close-btn').html(this.lang.get('cancel'));
                    button.on('click', $.proxy(this.modal.close, this));

                    this.$modalFooter.append(button);
                },
                createDeleteButton: function(label)
                {
                    return this.modal.createButton(label, 'delete');
                },
                createActionButton: function(label)
                {
                    return this.modal.createButton(label, 'action');
                },
                createButton: function(label, className)
                {
                    var button = $('<button>').addClass('redactor-modal-btn').addClass('redactor-modal-' + className + '-btn').html(label);
                    this.$modalFooter.append(button);

                    return button;
                },
                setButtonsWidth: function()
                {
                    var buttons = this.$modalFooter.find('button');
                    var buttonsSize = buttons.length;
                    if (buttonsSize === 0) return;

                    buttons.css('width', (100/buttonsSize) + '%');
                },
                build: function()
                {
                    this.modal.buildOverlay();

                    this.$modalBox = $('<div id="redactor-modal-box" />').hide();
                    this.$modal = $('<div id="redactor-modal" />');
                    this.$modalHeader = $('<header />');
                    this.$modalClose = $('<span id="redactor-modal-close" />').html('&times;');
                    this.$modalBody = $('<div id="redactor-modal-body" />');
                    this.$modalFooter = $('<footer />');

                    this.$modal.append(this.$modalHeader);
                    this.$modal.append(this.$modalClose);
                    this.$modal.append(this.$modalBody);
                    this.$modal.append(this.$modalFooter);
                    this.$modalBox.append(this.$modal);
                    this.$modalBox.appendTo(document.body);
                },
                buildOverlay: function()
                {
                    this.$modalOverlay = $('<div id="redactor-modal-overlay">').hide();
                    $('body').prepend(this.$modalOverlay);
                },
                enableEvents: function()
                {
                    this.$modalClose.on('click.redactor-modal', $.proxy(this.modal.close, this));
                    $(document).on('keyup.redactor-modal', $.proxy(this.modal.closeHandler, this));
                    this.$editor.on('keyup.redactor-modal', $.proxy(this.modal.closeHandler, this));
                    this.$modalBox.on('click.redactor-modal', $.proxy(this.modal.close, this));
                },
                disableEvents: function()
                {
                    this.$modalClose.off('click.redactor-modal');
                    $(document).off('keyup.redactor-modal');
                    this.$editor.off('keyup.redactor-modal');
                    this.$modalBox.off('click.redactor-modal');
                    $(window).off('resize.redactor-modal');
                },
                closeHandler: function(e)
                {
                    if (e.which != this.keyCode.ESC) return;

                    this.modal.close(false);
                },
                close: function(e)
                {
                    if (e)
                    {
                        if (!$(e.target).hasClass('redactor-modal-close-btn') && e.target != this.$modalClose[0] && e.target != this.$modalBox[0])
                        {
                            return;
                        }

                        e.preventDefault();
                    }

                    if (!this.$modalBox) return;

                    this.modal.disableEvents();

                    this.$modalOverlay.remove();

                    this.$modalBox.fadeOut('fast', $.proxy(function()
                    {
                        this.$modalBox.remove();

                        setTimeout($.proxy(this.utils.restoreScroll, this), 0);

                        if (e !== undefined) this.selection.restore();

                        $(document.body).css('overflow', this.modal.bodyOveflow);
                        this.core.setCallback('modalClosed', this.modal.templateName);

                    }, this));

                }
            };
        },
        observe: function()
        {
            return {
                load: function()
                {
                    this.observe.images();
                    this.observe.links();
                },
                buttons: function(e, btnName)
                {
                    var current = this.selection.getCurrent();
                    var parent = this.selection.getParent();

                    if (e !== false)
                    {
                        this.button.setInactiveAll();
                    }
                    else
                    {
                        this.button.setInactiveAll(btnName);
                    }

                    if (e === false && btnName !== 'html')
                    {
                        if ($.inArray(btnName, this.opts.activeButtons) != -1) this.button.toggleActive(btnName);
                        return;
                    }

                    //var linkButtonName = (this.utils.isCurrentOrParent('A')) ? this.lang.get('link_edit') : this.lang.get('link_insert');
                    //$('body').find('a.redactor-dropdown-link').text(linkButtonName);

                    $.each(this.opts.activeButtonsStates, $.proxy(function(key, value)
                    {
                        var parentEl = $(parent).closest(key);
                        var currentEl = $(current).closest(key);

                        if (parentEl.length !== 0 && !this.utils.isRedactorParent(parentEl)) return;
                        if (!this.utils.isRedactorParent(currentEl)) return;
                        if (parentEl.length !== 0 || currentEl.closest(key).length !== 0)
                        {
                            this.button.setActive(value);
                        }

                    }, this));

                    var $parent = $(parent).closest(this.opts.alignmentTags.toString().toLowerCase());
                    if (this.utils.isRedactorParent(parent) && $parent.length)
                    {
                        var align = ($parent.css('text-align') === '') ? 'left' : $parent.css('text-align');
                        this.button.setActive('align' + align);
                    }
                },
                addButton: function(tag, btnName)
                {
                    this.opts.activeButtons.push(btnName);
                    this.opts.activeButtonsStates[tag] = btnName;
                },
                images: function()
                {
                    this.$editor.find('img').each($.proxy(function(i, img)
                    {
                        var $img = $(img);

                        // IE fix (when we clicked on an image and then press backspace IE does goes to image's url)
                        $img.closest('a').on('click', function(e) { e.preventDefault(); });

                        if (this.utils.browser('msie')) $img.attr('unselectable', 'on');

                        this.image.setEditable($img);

                    }, this));

                    $(document).on('click.redactor-image-delete.' + this.uuid, $.proxy(function(e)
                    {
                        this.observe.image = false;
                        if (e.target.tagName == 'IMG' && this.utils.isRedactorParent(e.target))
                        {
                            this.observe.image = (this.observe.image && this.observe.image == e.target) ? false : e.target;
                        }

                    }, this));

                },
                links: function()
                {
                    if (!this.opts.linkTooltip) return;

                    this.$editor.find('a').on('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid, $.proxy(this.observe.showTooltip, this));
                    this.$editor.on('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid, $.proxy(this.observe.closeTooltip, this));
                    $(document).on('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid, $.proxy(this.observe.closeTooltip, this));
                },
                getTooltipPosition: function($link)
                {
                    return $link.offset();
                },
                showTooltip: function(e)
                {
                    var $link = $(e.target);
                    var $parent = $link.closest('a');
                    var tag = ($link.length !== 0) ? $link[0].tagName : false;

                    if ($parent[0].tagName === 'A')
                    {
                        if (tag === 'IMG') return;
                        else if (tag !== 'A') $link = $parent;
                    }

                    if (tag !== 'A')
                    {
                        return;
                    }

                    var pos = this.observe.getTooltipPosition($link);
                    var tooltip = $('<span class="redactor-link-tooltip"></span>');

                    var href = $link.attr('href');
                    if (href === undefined)
                    {
                        href = '';
                    }

                    if (href.length > 24) href = href.substring(0, 24) + '...';

                    var aLink = $('<a href="' + $link.attr('href') + '" target="_blank" />').html(href).addClass('redactor-link-tooltip-action');
                    var aEdit = $('<a href="#" />').html(this.lang.get('edit')).on('click', $.proxy(this.link.show, this)).addClass('redactor-link-tooltip-action');
                    var aUnlink = $('<a href="#" />').html(this.lang.get('unlink')).on('click', $.proxy(this.link.unlink, this)).addClass('redactor-link-tooltip-action');

                    tooltip.append(aLink).append(' | ').append(aEdit).append(' | ').append(aUnlink);
                    tooltip.css({
                        top: (pos.top + parseInt($link.css('line-height'), 10)) + 'px',
                        left: pos.left + 'px'
                    });

                    $('.redactor-link-tooltip').remove();
                    $('body').append(tooltip);
                },
                closeTooltip: function(e)
                {
                    e = e.originalEvent || e;

                    var target = e.target;
                    var $parent = $(target).closest('a');
                    if ($parent.length !== 0 && $parent[0].tagName === 'A' && target.tagName !== 'A')
                    {
                        return;
                    }
                    else if ((target.tagName === 'A' && this.utils.isRedactorParent(target)) || $(target).hasClass('redactor-link-tooltip-action'))
                    {
                        return;
                    }

                    $('.redactor-link-tooltip').remove();
                }

            };
        },
        paragraphize: function()
        {
            return {
                load: function(html)
                {
                    if (this.opts.linebreaks) return html;
                    if (html === '' || html === '<p></p>') return this.opts.emptyHtml;

                    this.paragraphize.blocks = ['table', 'div', 'pre', 'form', 'ul', 'ol', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'dl', 'blockquote', 'figcaption',
                    'address', 'section', 'header', 'footer', 'aside', 'article', 'object', 'style', 'script', 'iframe', 'select', 'input', 'textarea',
                    'button', 'option', 'map', 'area', 'math', 'hr', 'fieldset', 'legend', 'hgroup', 'nav', 'figure', 'details', 'menu', 'summary', 'p'];

                    html = html + "\n";

                    this.paragraphize.safes = [];
                    this.paragraphize.z = 0;

                    html = html.replace(/(<br\s?\/?>){1,}\n?<\/blockquote>/gi, '</blockquote>');

                    html = this.paragraphize.getSafes(html);
                    html = this.paragraphize.getSafesComments(html);
                    html = this.paragraphize.replaceBreaksToNewLines(html);
                    html = this.paragraphize.replaceBreaksToParagraphs(html);
                    html = this.paragraphize.clear(html);
                    html = this.paragraphize.restoreSafes(html);

                    html = html.replace(new RegExp('<br\\s?/?>\n?<(' + this.paragraphize.blocks.join('|') + ')(.*?[^>])>', 'gi'), '<p><br /></p>\n<$1$2>');

                    return $.trim(html);
                },
                getSafes: function(html)
                {
                    var $div = $('<div />').append(html);

                    // remove paragraphs in blockquotes
                    $div.find('blockquote p').replaceWith(function()
                    {
                        return $(this).append('<br />').contents();
                    });

                    html = $div.html();

                    $div.find(this.paragraphize.blocks.join(', ')).each($.proxy(function(i,s)
                    {
                        this.paragraphize.z++;
                        this.paragraphize.safes[this.paragraphize.z] = s.outerHTML;
                        html = html.replace(s.outerHTML, '\n{replace' + this.paragraphize.z + '}');

                    }, this));

                    return html;
                },
                getSafesComments: function(html)
                {
                    var commentsMatches = html.match(/<!--([\w\W]*?)-->/gi);

                    if (!commentsMatches) return html;

                    $.each(commentsMatches, $.proxy(function(i,s)
                    {
                        this.paragraphize.z++;
                        this.paragraphize.safes[this.paragraphize.z] = s;
                        html = html.replace(s, '\n{replace' + this.paragraphize.z + '}');
                    }, this));

                    return html;
                },
                restoreSafes: function(html)
                {
                    $.each(this.paragraphize.safes, function(i,s)
                    {
                        s = (typeof s !== 'undefined') ? s.replace(/\$/g, '&#36;') : s;
                        html = html.replace('{replace' + i + '}', s);

                    });

                    return html;
                },
                replaceBreaksToParagraphs: function(html)
                {
                    var htmls = html.split(new RegExp('\n', 'g'), -1);

                    html = '';
                    if (htmls)
                    {
                        var len = htmls.length;
                        for (var i = 0; i < len; i++)
                        {
                            if (!htmls.hasOwnProperty(i)) return;

                            if (htmls[i].search('{replace') == -1)
                            {
                                htmls[i] = htmls[i].replace(/<p>\n\t?<\/p>/gi, '');
                                htmls[i] = htmls[i].replace(/<p><\/p>/gi, '');

                                if (htmls[i] !== '')
                                {
                                    html += '<p>' +  htmls[i].replace(/^\n+|\n+$/g, "") + "</p>";
                                }
                            }
                            else html += htmls[i];
                        }
                    }

                    return html;
                },
                replaceBreaksToNewLines: function(html)
                {
                    html = html.replace(/<br \/>\s*<br \/>/gi, "\n\n");
                    html = html.replace(/<br\s?\/?>\n?<br\s?\/?>/gi, "\n<br /><br />");

                    html = html.replace(new RegExp("\r\n", 'g'), "\n");
                    html = html.replace(new RegExp("\r", 'g'), "\n");
                    html = html.replace(new RegExp("/\n\n+/"), 'g', "\n\n");

                    return html;
                },
                clear: function(html)
                {
                    html = html.replace(new RegExp('</blockquote></p>', 'gi'), '</blockquote>');
                    html = html.replace(new RegExp('<p></blockquote>', 'gi'), '</blockquote>');
                    html = html.replace(new RegExp('<p><blockquote>', 'gi'), '<blockquote>');
                    html = html.replace(new RegExp('<blockquote></p>', 'gi'), '<blockquote>');

                    html = html.replace(new RegExp('<p><p ', 'gi'), '<p ');
                    html = html.replace(new RegExp('<p><p>', 'gi'), '<p>');
                    html = html.replace(new RegExp('</p></p>', 'gi'), '</p>');
                    html = html.replace(new RegExp('<p>\\s?</p>', 'gi'), '');
                    html = html.replace(new RegExp("\n</p>", 'gi'), '</p>');
                    html = html.replace(new RegExp('<p>\t?\t?\n?<p>', 'gi'), '<p>');
                    html = html.replace(new RegExp('<p>\t*</p>', 'gi'), '');

                    return html;
                }
            };
        },
        paste: function()
        {
            return {
                init: function(e)
                {
                    if (!this.opts.cleanOnPaste)
                    {
                        setTimeout($.proxy(this.code.sync, this), 1);
                        return;
                    }

                    this.rtePaste = true;

                    this.buffer.set();
                    this.selection.save();
                    this.utils.saveScroll();

                    this.paste.createPasteBox();

                    $(window).on('scroll.redactor-freeze', $.proxy(function()
                    {
                        $(window).scrollTop(this.saveBodyScroll);

                    }, this));

                    setTimeout($.proxy(function()
                    {
                        var html = this.$pasteBox.html();

                        this.$pasteBox.remove();

                        this.selection.restore();
                        this.utils.restoreScroll();

                        this.paste.insert(html);

                        $(window).off('scroll.redactor-freeze');

                    }, this), 1);

                },
                createPasteBox: function()
                {
                    this.$pasteBox = $('<div>').html('').attr('contenteditable', 'true').css({ position: 'fixed', width: 0, top: 0, left: '-9999px' });

                    if (this.utils.browser('msie'))
                    {
                        this.$box.append(this.$pasteBox);
                    }
                    else
                    {
                        $('body').append(this.$pasteBox);
                    }

                    this.$pasteBox.focus();
                },
                insert: function(html)
                {
                    html = this.core.setCallback('pasteBefore', html);

                    // clean
                    html = (this.utils.isSelectAll()) ? this.clean.onPaste(html, false) : this.clean.onPaste(html);

                    html = this.core.setCallback('paste', html);

                    if (this.utils.isSelectAll())
                    {
                        this.insert.set(html, false);
                    }
                    else
                    {
                        this.insert.html(html, false);
                    }

                    this.utils.disableSelectAll();
                    this.rtePaste = false;

                    setTimeout($.proxy(this.clean.clearUnverified, this), 10);

                    // clean empty spans
                    setTimeout($.proxy(function()
                    {
                        var spans = this.$editor.find('span');
                        $.each(spans, function(i,s)
                        {
                            var html = s.innerHTML.replace(/[\u200B-\u200D\uFEFF]/, '');
                            if (html === '' && s.attributes.length === 0) $(s).remove();

                        });

                    }, this), 10);
                }
            };
        },
        placeholder: function()
        {
            return {
                enable: function()
                {
                    if (!this.placeholder.is()) return;

                    this.$editor.attr('placeholder', this.$element.attr('placeholder'));

                    this.placeholder.toggle();
                    this.$editor.on('keyup.redactor-placeholder', $.proxy(this.placeholder.toggle, this));

                },
                toggle: function()
                {
                    var func = 'removeClass';
                    if (this.utils.isEmpty(this.$editor.html(), false)) func = 'addClass';
                    this.$editor[func]('redactor-placeholder');
                },
                remove: function()
                {
                    this.$editor.removeClass('redactor-placeholder');
                },
                is: function()
                {
                    if (this.opts.placeholder)
                    {
                        return this.$element.attr('placeholder', this.opts.placeholder);
                    }
                    else
                    {
                        return !(typeof this.$element.attr('placeholder') == 'undefined' || this.$element.attr('placeholder') === '');
                    }
                }
            };
        },
        progress: function()
        {
            return {
                show: function()
                {
                    $(document.body).append($('<div id="redactor-progress"><span></span></div>'));
                    $('#redactor-progress').fadeIn();
                },
                hide: function()
                {
                    $('#redactor-progress').fadeOut(1500, function()
                    {
                        $(this).remove();
                    });
                }

            };
        },
        selection: function()
        {
            return {
                get: function()
                {
                    this.sel = document.getSelection();

                    if (document.getSelection && this.sel.getRangeAt && this.sel.rangeCount)
                    {
                        this.range = this.sel.getRangeAt(0);
                    }
                    else
                    {
                        this.range = document.createRange();
                    }
                },
                addRange: function()
                {
                    try {
                        this.sel.removeAllRanges();
                    } catch (e) {}

                    this.sel.addRange(this.range);
                },
                getCurrent: function()
                {
                    var el = false;
                    this.selection.get();

                    if (this.sel && this.sel.rangeCount > 0)
                    {
                        el = this.sel.getRangeAt(0).startContainer;
                    }

                    return this.utils.isRedactorParent(el);
                },
                getParent: function(elem)
                {
                    elem = elem || this.selection.getCurrent();
                    if (elem)
                    {
                        return this.utils.isRedactorParent($(elem).parent()[0]);
                    }

                    return false;
                },
                getBlock: function(node)
                {
                    node = node || this.selection.getCurrent();

                    while (node)
                    {
                        if (this.utils.isBlockTag(node.tagName))
                        {
                            return ($(node).hasClass('redactor-editor')) ? false : node;
                        }

                        node = node.parentNode;
                    }

                    return false;
                },
                getInlines: function(nodes, tags)
                {
                    this.selection.get();

                    if (this.range && this.range.collapsed)
                    {
                        return false;
                    }

                    var inlines = [];
                    nodes = (typeof nodes == 'undefined' || nodes === false) ? this.selection.getNodes() : nodes;
                    var inlineTags = this.opts.inlineTags;
                    inlineTags.push('span');

                    if (typeof tags !== 'undefined')
                    {
                        for (var i = 0; i < tags.length; i++)
                        {
                            inlineTags.push(tags[i]);
                        }
                    }

                    $.each(nodes, $.proxy(function(i,node)
                    {
                        if ($.inArray(node.tagName.toLowerCase(), inlineTags) != -1)
                        {
                            inlines.push(node);
                        }

                    }, this));

                    return (inlines.length === 0) ? false : inlines;
                },
                getInlinesTags: function(tags)
                {
                    this.selection.get();

                    if (this.range && this.range.collapsed)
                    {
                        return false;
                    }

                    var inlines = [];
                    var nodes =  this.selection.getNodes();
                    $.each(nodes, $.proxy(function(i,node)
                    {
                        if ($.inArray(node.tagName.toLowerCase(), tags) != -1)
                        {
                            inlines.push(node);
                        }

                    }, this));

                    return (inlines.length === 0) ? false : inlines;
                },
                getBlocks: function(nodes)
                {
                    this.selection.get();

                    if (this.range && this.range.collapsed)
                    {
                        return [this.selection.getBlock()];
                    }

                    var blocks = [];
                    nodes = (typeof nodes == 'undefined') ? this.selection.getNodes() : nodes;
                    $.each(nodes, $.proxy(function(i,node)
                    {
                        if (this.utils.isBlock(node))
                        {
                            this.selection.lastBlock = node;
                            blocks.push(node);
                        }

                    }, this));

                    return (blocks.length === 0) ? [this.selection.getBlock()] : blocks;
                },
                getLastBlock: function()
                {
                    return this.selection.lastBlock;
                },
                getNodes: function()
                {
                    this.selection.get();

                    var startNode = this.selection.getNodesMarker(1);
                    var endNode = this.selection.getNodesMarker(2);
                    var range = this.range.cloneRange();

                    if (this.range.collapsed === false)
                    {
                        var startContainer = range.startContainer;
                        var startOffset = range.startOffset;

                        // end marker
                        this.selection.setNodesMarker(range, endNode, false);

                        // start marker
                        range.setStart(startContainer, startOffset);
                        this.selection.setNodesMarker(range, startNode, true);
                    }
                    else
                    {
                        this.selection.setNodesMarker(range, startNode, true);
                        endNode = startNode;
                    }

                    var nodes = [];
                    var counter = 0;

                    var self = this;
                    this.$editor.find('*').each(function()
                    {
                        if (this == startNode)
                        {
                            var parent = $(this).parent();
                            if (parent.length !== 0 && parent[0].tagName != 'BODY' && self.utils.isRedactorParent(parent[0]))
                            {
                                nodes.push(parent[0]);
                            }

                            nodes.push(this);
                            counter = 1;
                        }
                        else
                        {
                            if (counter > 0)
                            {
                                nodes.push(this);
                                counter = counter + 1;
                            }
                        }

                        if (this == endNode)
                        {
                            return false;
                        }

                    });

                    var finalNodes = [];
                    var len = nodes.length;
                    for (var i = 0; i < len; i++)
                    {
                        if (nodes[i].id != 'nodes-marker-1' && nodes[i].id != 'nodes-marker-2')
                        {
                            finalNodes.push(nodes[i]);
                        }
                    }

                    this.selection.removeNodesMarkers();

                    return finalNodes;

                },
                getNodesMarker: function(num)
                {
                    return $('<span id="nodes-marker-' + num + '" class="redactor-nodes-marker" data-verified="redactor">' + this.opts.invisibleSpace + '</span>')[0];
                },
                setNodesMarker: function(range, node, type)
                {
                    try {
                        range.collapse(type);
                        range.insertNode(node);
                    }
                    catch (e) {}
                },
                removeNodesMarkers: function()
                {
                    $(document).find('span.redactor-nodes-marker').remove();
                    this.$editor.find('span.redactor-nodes-marker').remove();
                },
                fromPoint: function(start, end)
                {
                    this.caret.setOffset(start, end);
                },
                wrap: function(tag)
                {
                    this.selection.get();

                    if (this.range.collapsed) return false;

                    var wrapper = document.createElement(tag);
                    wrapper.appendChild(this.range.extractContents());
                    this.range.insertNode(wrapper);

                    return wrapper;
                },
                selectElement: function(node)
                {
                    this.caret.set(node, 0, node, 1);
                },
                selectAll: function()
                {
                    this.selection.get();
                    this.range.selectNodeContents(this.$editor[0]);
                    this.selection.addRange();
                },
                remove: function()
                {
                    this.selection.get();
                    this.sel.removeAllRanges();
                },
                save: function()
                {
                    this.selection.createMarkers();
                },
                createMarkers: function()
                {
                    this.selection.get();

                    var node1 = this.selection.getMarker(1);

                    this.selection.setMarker(this.range, node1, true);

                    if (this.range.collapsed === false)
                    {
                        var node2 = this.selection.getMarker(2);
                        this.selection.setMarker(this.range, node2, false);
                    }

                    this.savedSel = this.$editor.html();
                },
                getMarker: function(num)
                {
                    if (typeof num == 'undefined') num = 1;

                    return $('<span id="selection-marker-' + num + '" class="redactor-selection-marker"  data-verified="redactor">' + this.opts.invisibleSpace + '</span>')[0];
                },
                getMarkerAsHtml: function(num)
                {
                    return this.utils.getOuterHtml(this.selection.getMarker(num));
                },
                setMarker: function(range, node, type)
                {
                    range = range.cloneRange();

                    try {
                        range.collapse(type);
                        range.insertNode(node);
                    }
                    catch (e)
                    {
                        this.focus.setStart();
                    }
                },
                restore: function()
                {
                    var node1 = this.$editor.find('span#selection-marker-1');
                    var node2 = this.$editor.find('span#selection-marker-2');

                    if (node1.length !== 0 && node2.length !== 0)
                    {
                        this.caret.set(node1, 0, node2, 0);
                    }
                    else if (node1.length !== 0)
                    {
                        this.caret.set(node1, 0, node1, 0);
                    }
                    else
                    {
                        this.$editor.focus();
                    }

                    this.selection.removeMarkers();
                    this.savedSel = false;

                },
                removeMarkers: function()
                {
                    this.$editor.find('span.redactor-selection-marker').each(function(i,s)
                    {
                        var text = $(s).text().replace(/[\u200B-\u200D\uFEFF]/g, '');
                        if (text === '') $(s).remove();
                        else $(s).replaceWith(function() { return $(this).contents(); });
                    });
                },
                getText: function()
                {
                    this.selection.get();

                    return this.sel.toString();
                },
                getHtml: function()
                {
                    var html = '';

                    this.selection.get();
                    if (this.sel.rangeCount)
                    {
                        var container = document.createElement('div');
                        var len = this.sel.rangeCount;
                        for (var i = 0; i < len; ++i)
                        {
                            container.appendChild(this.sel.getRangeAt(i).cloneContents());
                        }

                        html = container.innerHTML;
                    }

                    return this.clean.onSync(html);
                },
                replaceWithHtml: function(html)
                {
                    html = this.selection.getMarkerAsHtml(1) + html + this.selection.getMarkerAsHtml(2);

                    this.selection.get();

                    if (window.getSelection && window.getSelection().getRangeAt)
                    {
                        this.range.deleteContents();
                        var div = document.createElement("div");
                        div.innerHTML = html;

                        var frag = document.createDocumentFragment(), child;
                        while ((child = div.firstChild))
                        {
                            frag.appendChild(child);
                        }

                        this.range.insertNode(frag);
                    }
                    else if (document.selection && document.selection.createRange)
                    {
                        this.range.pasteHTML(html);
                    }

                    this.selection.restore();
                    this.code.sync();
                }
            };
        },
        shortcuts: function()
        {
            return {
                init: function(e, key)
                {
                    // disable browser's hot keys for bold and italic
                    if (!this.opts.shortcuts)
                    {
                        if ((e.ctrlKey || e.metaKey) && (key === 66 || key === 73)) e.preventDefault();
                        return false;
                    }

                    $.each(this.opts.shortcuts, $.proxy(function(str, command)
                    {
                        var keys = str.split(',');
                        var len = keys.length;
                        for (var i = 0; i < len; i++)
                        {
                            if (typeof keys[i] === 'string')
                            {
                                this.shortcuts.handler(e, $.trim(keys[i]), $.proxy(function()
                                {
                                    var func;
                                    if (command.func.search(/\./) != '-1')
                                    {
                                        func = command.func.split('.');
                                        if (typeof this[func[0]] != 'undefined')
                                        {
                                            this[func[0]][func[1]].apply(this, command.params);
                                        }
                                    }
                                    else
                                    {
                                        this[command.func].apply(this, command.params);
                                    }

                                }, this));
                            }

                        }

                    }, this));
                },
                handler: function(e, keys, origHandler)
                {
                    // based on https://github.com/jeresig/jquery.hotkeys
                    var hotkeysSpecialKeys =
                    {
                        8: "backspace", 9: "tab", 10: "return", 13: "return", 16: "shift", 17: "ctrl", 18: "alt", 19: "pause",
                        20: "capslock", 27: "esc", 32: "space", 33: "pageup", 34: "pagedown", 35: "end", 36: "home",
                        37: "left", 38: "up", 39: "right", 40: "down", 45: "insert", 46: "del", 59: ";", 61: "=",
                        96: "0", 97: "1", 98: "2", 99: "3", 100: "4", 101: "5", 102: "6", 103: "7",
                        104: "8", 105: "9", 106: "*", 107: "+", 109: "-", 110: ".", 111 : "/",
                        112: "f1", 113: "f2", 114: "f3", 115: "f4", 116: "f5", 117: "f6", 118: "f7", 119: "f8",
                        120: "f9", 121: "f10", 122: "f11", 123: "f12", 144: "numlock", 145: "scroll", 173: "-", 186: ";", 187: "=",
                        188: ",", 189: "-", 190: ".", 191: "/", 192: "`", 219: "[", 220: "\\", 221: "]", 222: "'"
                    };


                    var hotkeysShiftNums =
                    {
                        "`": "~", "1": "!", "2": "@", "3": "#", "4": "$", "5": "%", "6": "^", "7": "&",
                        "8": "*", "9": "(", "0": ")", "-": "_", "=": "+", ";": ": ", "'": "\"", ",": "<",
                        ".": ">",  "/": "?",  "\\": "|"
                    };

                    keys = keys.toLowerCase().split(" ");
                    var special = hotkeysSpecialKeys[e.keyCode],
                        character = String.fromCharCode( e.which ).toLowerCase(),
                        modif = "", possible = {};

                    $.each([ "alt", "ctrl", "meta", "shift"], function(index, specialKey)
                    {
                        if (e[specialKey + 'Key'] && special !== specialKey)
                        {
                            modif += specialKey + '+';
                        }
                    });


                    if (special) possible[modif + special] = true;
                    if (character)
                    {
                        possible[modif + character] = true;
                        possible[modif + hotkeysShiftNums[character]] = true;

                        // "$" can be triggered as "Shift+4" or "Shift+$" or just "$"
                        if (modif === "shift+")
                        {
                            possible[hotkeysShiftNums[character]] = true;
                        }
                    }

                    for (var i = 0, len = keys.length; i < len; i++)
                    {
                        if (possible[keys[i]])
                        {
                            e.preventDefault();
                            return origHandler.apply(this, arguments);
                        }
                    }
                }
            };
        },
        tabifier: function()
        {
            return {
                get: function(code)
                {
                    if (!this.opts.tabifier) return code;

                    // clean setup
                    var ownLine = ['area', 'body', 'head', 'hr', 'i?frame', 'link', 'meta', 'noscript', 'style', 'script', 'table', 'tbody', 'thead', 'tfoot'];
                    var contOwnLine = ['li', 'dt', 'dt', 'h[1-6]', 'option', 'script'];
                    var newLevel = ['p', 'blockquote', 'div', 'dl', 'fieldset', 'form', 'frameset', 'map', 'ol', 'pre', 'select', 'td', 'th', 'tr', 'ul'];

                    this.tabifier.lineBefore = new RegExp('^<(/?' + ownLine.join('|/?' ) + '|' + contOwnLine.join('|') + ')[ >]');
                    this.tabifier.lineAfter = new RegExp('^<(br|/?' + ownLine.join('|/?' ) + '|/' + contOwnLine.join('|/') + ')[ >]');
                    this.tabifier.newLevel = new RegExp('^</?(' + newLevel.join('|' ) + ')[ >]');

                    var i = 0,
                    codeLength = code.length,
                    point = 0,
                    start = null,
                    end = null,
                    tag = '',
                    out = '',
                    cont = '';

                    this.tabifier.cleanlevel = 0;

                    for (; i < codeLength; i++)
                    {
                        point = i;

                        // if no more tags, copy and exit
                        if (-1 == code.substr(i).indexOf( '<' ))
                        {
                            out += code.substr(i);

                            return this.tabifier.finish(out);
                        }

                        // copy verbatim until a tag
                        while (point < codeLength && code.charAt(point) != '<')
                        {
                            point++;
                        }

                        if (i != point)
                        {
                            cont = code.substr(i, point - i);
                            if (!cont.match(/^\s{2,}$/g))
                            {
                                if ('\n' == out.charAt(out.length - 1)) out += this.tabifier.getTabs();
                                else if ('\n' == cont.charAt(0))
                                {
                                    out += '\n' + this.tabifier.getTabs();
                                    cont = cont.replace(/^\s+/, '');
                                }

                                out += cont;
                            }

                            if (cont.match(/\n/)) out += '\n' + this.tabifier.getTabs();
                        }

                        start = point;

                        // find the end of the tag
                        while (point < codeLength && '>' != code.charAt(point))
                        {
                            point++;
                        }

                        tag = code.substr(start, point - start);
                        i = point;

                        var t;

                        if ('!--' == tag.substr(1, 3))
                        {
                            if (!tag.match(/--$/))
                            {
                                while ('-->' != code.substr(point, 3))
                                {
                                    point++;
                                }
                                point += 2;
                                tag = code.substr(start, point - start);
                                i = point;
                            }

                            if ('\n' != out.charAt(out.length - 1)) out += '\n';

                            out += this.tabifier.getTabs();
                            out += tag + '>\n';
                        }
                        else if ('!' == tag[1])
                        {
                            out = this.tabifier.placeTag(tag + '>', out);
                        }
                        else if ('?' == tag[1])
                        {
                            out += tag + '>\n';
                        }
                        else if (t = tag.match(/^<(script|style|pre)/i))
                        {
                            t[1] = t[1].toLowerCase();
                            tag = this.tabifier.cleanTag(tag);
                            out = this.tabifier.placeTag(tag, out);
                            end = String(code.substr(i + 1)).toLowerCase().indexOf('</' + t[1]);

                            if (end)
                            {
                                cont = code.substr(i + 1, end);
                                i += end;
                                out += cont;
                            }
                        }
                        else
                        {
                            tag = this.tabifier.cleanTag(tag);
                            out = this.tabifier.placeTag(tag, out);
                        }
                    }

                    return this.tabifier.finish(out);
                },
                getTabs: function()
                {
                    var s = '';
                    for ( var j = 0; j < this.tabifier.cleanlevel; j++ )
                    {
                        s += '\t';
                    }

                    return s;
                },
                finish: function(code)
                {
                    code = code.replace(/\n\s*\n/g, '\n');
                    code = code.replace(/^[\s\n]*/, '');
                    code = code.replace(/[\s\n]*$/, '');
                    code = code.replace(/<script(.*?)>\n<\/script>/gi, '<script$1></script>');

                    this.tabifier.cleanlevel = 0;

                    return code;
                },
                cleanTag: function (tag)
                {
                    var tagout = '';
                    tag = tag.replace(/\n/g, ' ');
                    tag = tag.replace(/\s{2,}/g, ' ');
                    tag = tag.replace(/^\s+|\s+$/g, ' ');

                    var suffix = '';
                    if (tag.match(/\/$/))
                    {
                        suffix = '/';
                        tag = tag.replace(/\/+$/, '');
                    }

                    var m;
                    while (m = /\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(tag))
                    {
                        if (m[2]) tagout += m[1].toLowerCase() + '=' + m[2];
                        else if (m[1]) tagout += m[1].toLowerCase();

                        tagout += ' ';
                        tag = tag.substr(m[0].length);
                    }

                    return tagout.replace(/\s*$/, '') + suffix + '>';
                },
                placeTag: function (tag, out)
                {
                    var nl = tag.match(this.tabifier.newLevel);

                    if (tag.match(this.tabifier.lineBefore) || nl)
                    {
                        out = out.replace(/\s*$/, '');
                        out += '\n';
                    }

                    if (nl && '/' == tag.charAt(1)) this.tabifier.cleanlevel--;
                    if ('\n' == out.charAt(out.length - 1)) out += this.tabifier.getTabs();
                    if (nl && '/' != tag.charAt(1)) this.tabifier.cleanlevel++;

                    out += tag;

                    if (tag.match(this.tabifier.lineAfter) || tag.match(this.tabifier.newLevel))
                    {
                        out = out.replace(/ *$/, '');
                        //out += '\n';
                    }

                    return out;
                }
            };
        },
        tidy: function()
        {
            return {
                setupAllowed: function()
                {
                    if (this.opts.allowedTags) this.opts.deniedTags = false;
                    if (this.opts.allowedAttr) this.opts.removeAttr = false;

                    if (this.opts.linebreaks) return;

                    var tags = ['p', 'section'];
                    if (this.opts.allowedTags) this.tidy.addToAllowed(tags);
                    if (this.opts.deniedTags) this.tidy.removeFromDenied(tags);

                },
                addToAllowed: function(tags)
                {
                    var len = tags.length;
                    for (var i = 0; i < len; i++)
                    {
                        if ($.inArray(tags[i], this.opts.allowedTags) == -1)
                        {
                            this.opts.allowedTags.push(tags[i]);
                        }
                    }
                },
                removeFromDenied: function(tags)
                {
                    var len = tags.length;
                    for (var i = 0; i < len; i++)
                    {
                        var pos = $.inArray(tags[i], this.opts.deniedTags);
                        if (pos != -1)
                        {
                            this.opts.deniedTags.splice(pos, 1);
                        }
                    }
                },
                load: function(html, options)
                {
                    this.tidy.settings = {
                        deniedTags: this.opts.deniedTags,
                        allowedTags: this.opts.allowedTags,
                        removeComments: this.opts.removeComments,
                        replaceTags: this.opts.replaceTags,
                        replaceStyles: this.opts.replaceStyles,
                        removeDataAttr: this.opts.removeDataAttr,
                        removeAttr: this.opts.removeAttr,
                        allowedAttr: this.opts.allowedAttr,
                        removeWithoutAttr: this.opts.removeWithoutAttr,
                        removeEmpty: this.opts.removeEmpty
                    };

                    $.extend(this.tidy.settings, options);

                    html = this.tidy.removeComments(html);

                    // create container
                    this.tidy.$div = $('<div />').append(html);

                    // clean
                    this.tidy.replaceTags();
                    this.tidy.replaceStyles();
                    this.tidy.removeTags();

                    this.tidy.removeAttr();
                    this.tidy.removeEmpty();
                    this.tidy.removeParagraphsInLists();
                    this.tidy.removeDataAttr();
                    this.tidy.removeWithoutAttr();

                    html = this.tidy.$div.html();
                    this.tidy.$div.remove();

                    return html;
                },
                removeComments: function(html)
                {
                    if (!this.tidy.settings.removeComments) return html;

                    return html.replace(/<!--[\s\S]*?-->/gi, '');
                },
                replaceTags: function(html)
                {
                    if (!this.tidy.settings.replaceTags) return html;

                    var len = this.tidy.settings.replaceTags.length;
                    var replacement = [], rTags = [];
                    for (var i = 0; i < len; i++)
                    {
                        rTags.push(this.tidy.settings.replaceTags[i][1]);
                        replacement.push(this.tidy.settings.replaceTags[i][0]);
                    }

                    this.tidy.$div.find(replacement.join(',')).each($.proxy(function(n,s)
                    {
                        var tag = rTags[n];
                        $(s).replaceWith(function()
                        {
                            var replaced = $('<' + tag + ' />').append($(this).contents());

                            for (var i = 0; i < this.attributes.length; i++)
                            {
                                replaced.attr(this.attributes[i].name, this.attributes[i].value);
                            }

                            return replaced;
                        });

                    }, this));

                    return html;
                },
                replaceStyles: function()
                {
                    if (!this.tidy.settings.replaceStyles) return;

                    var len = this.tidy.settings.replaceStyles.length;
                    this.tidy.$div.find('span').each($.proxy(function(n,s)
                    {
                        var $el = $(s);
                        var style = $el.attr('style');
                        for (var i = 0; i < len; i++)
                        {
                            if (style && style.match(new RegExp('^' + this.tidy.settings.replaceStyles[i][0], 'i')))
                            {
                                var tagName = this.tidy.settings.replaceStyles[i][1];
                                $el.replaceWith(function()
                                {
                                    var tag = document.createElement(tagName);
                                    return $(tag).append($(this).contents());
                                });
                            }
                        }

                    }, this));

                },
                removeTags: function()
                {
                    if (!this.tidy.settings.deniedTags && this.tidy.settings.allowedTags)
                    {
                        this.tidy.$div.find('*').not(this.tidy.settings.allowedTags.join(',')).each(function(i, s)
                        {
                            if (s.innerHTML === '') $(s).remove();
                            else $(s).contents().unwrap();
                        });
                    }

                    if (this.tidy.settings.deniedTags)
                    {
                        this.tidy.$div.find(this.tidy.settings.deniedTags.join(',')).each(function(i, s)
                        {
                            if (s.innerHTML === '') $(s).remove();
                            else $(s).contents().unwrap();
                        });
                    }
                },
                removeAttr: function()
                {
                    var len;
                    if (!this.tidy.settings.removeAttr && this.tidy.settings.allowedAttr)
                    {

                        var allowedAttrTags = [], allowedAttrData = [];
                        len = this.tidy.settings.allowedAttr.length;
                        for (var i = 0; i < len; i++)
                        {
                            allowedAttrTags.push(this.tidy.settings.allowedAttr[i][0]);
                            allowedAttrData.push(this.tidy.settings.allowedAttr[i][1]);
                        }


                        this.tidy.$div.find('*').each($.proxy(function(n,s)
                        {
                            var $el = $(s);
                            var pos = $.inArray($el[0].tagName.toLowerCase(), allowedAttrTags);
                            var attributesRemove = this.tidy.removeAttrGetRemoves(pos, allowedAttrData, $el);

                            if (attributesRemove)
                            {
                                $.each(attributesRemove, function(z,f) {
                                    $el.removeAttr(f);
                                });
                            }
                        }, this));
                    }

                    if (this.tidy.settings.removeAttr)
                    {
                        len = this.tidy.settings.removeAttr.length;
                        for (var i = 0; i < len; i++)
                        {
                            var attrs = this.tidy.settings.removeAttr[i][1];
                            if ($.isArray(attrs)) attrs = attrs.join(' ');

                            this.tidy.$div.find(this.tidy.settings.removeAttr[i][0]).removeAttr(attrs);
                        }
                    }

                },
                removeAttrGetRemoves: function(pos, allowed, $el)
                {
                    var attributesRemove = [];

                    // remove all attrs
                    if (pos == -1)
                    {
                        $.each($el[0].attributes, function(i, item)
                        {
                            attributesRemove.push(item.name);
                        });

                    }
                    // allow all attrs
                    else if (allowed[pos] == '*')
                    {
                        attributesRemove = [];
                    }
                    // allow specific attrs
                    else
                    {
                        $.each($el[0].attributes, function(i, item)
                        {
                            if ($.isArray(allowed[pos]))
                            {
                                if ($.inArray(item.name, allowed[pos]) == -1)
                                {
                                    attributesRemove.push(item.name);
                                }
                            }
                            else if (allowed[pos] != item.name)
                            {
                                attributesRemove.push(item.name);
                            }

                        });
                    }

                    return attributesRemove;
                },
                removeAttrs: function (el, regex)
                {
                    regex = new RegExp(regex, "g");
                    return el.each(function()
                    {
                        var self = $(this);
                        var len = this.attributes.length - 1;
                        for (var i = len; i >= 0; i--)
                        {
                            var item = this.attributes[i];
                            if (item && item.specified && item.name.search(regex)>=0)
                            {
                                self.removeAttr(item.name);
                            }
                        }
                    });
                },
                removeEmpty: function()
                {
                    if (!this.tidy.settings.removeEmpty) return;

                    this.tidy.$div.find(this.tidy.settings.removeEmpty.join(',')).each(function()
                    {
                        var $el = $(this);
                        var text = $el.text();
                        text = text.replace(/[\u200B-\u200D\uFEFF]/g, '');
                        text = text.replace(/&nbsp;/gi, '');
                        text = text.replace(/\s/g, '');

                        if (text === '' && $el.children().length === 0)
                        {
                            $el.remove();
                        }
                    });
                },
                removeParagraphsInLists: function()
                {
                    this.tidy.$div.find('li p').contents().unwrap();
                },
                removeDataAttr: function()
                {
                    if (!this.tidy.settings.removeDataAttr) return;

                    var tags = this.tidy.settings.removeDataAttr;
                    if ($.isArray(this.tidy.settings.removeDataAttr)) tags = this.tidy.settings.removeDataAttr.join(',');

                    this.tidy.removeAttrs(this.tidy.$div.find(tags), '^(data-)');

                },
                removeWithoutAttr: function()
                {
                    if (!this.tidy.settings.removeWithoutAttr) return;

                    this.tidy.$div.find(this.tidy.settings.removeWithoutAttr.join(',')).each(function()
                    {
                        if (this.attributes.length === 0)
                        {
                            $(this).contents().unwrap();
                        }
                    });
                }
            };
        },
        toolbar: function()
        {
            return {
                init: function()
                {
                    return {
                        html:
                        {
                            title: this.lang.get('html'),
                            func: 'code.toggle'
                        },
                        formatting:
                        {
                            title: this.lang.get('formatting'),
                            dropdown:
                            {
                                p:
                                {
                                    title: this.lang.get('paragraph'),
                                    func: 'block.format'
                                },
                                blockquote:
                                {
                                    title: this.lang.get('quote'),
                                    func: 'block.format'
                                },
                                pre:
                                {
                                    title: this.lang.get('code'),
                                    func: 'block.format'
                                },
                                h1:
                                {
                                    title: this.lang.get('header1'),
                                    func: 'block.format'
                                },
                                h2:
                                {
                                    title: this.lang.get('header2'),
                                    func: 'block.format'
                                },
                                h3:
                                {
                                    title: this.lang.get('header3'),
                                    func: 'block.format'
                                },
                                h4:
                                {
                                    title: this.lang.get('header4'),
                                    func: 'block.format'
                                },
                                h5:
                                {
                                    title: this.lang.get('header5'),
                                    func: 'block.format'
                                }
                            }
                        },
                        bold:
                        {
                            title: this.lang.get('bold'),
                            func: 'inline.format'
                        },
                        italic:
                        {
                            title: this.lang.get('italic'),
                            func: 'inline.format'
                        },
                        deleted:
                        {
                            title: this.lang.get('deleted'),
                            func: 'inline.format'
                        },
                        underline:
                        {
                            title: this.lang.get('underline'),
                            func: 'inline.format'
                        },
                        unorderedlist:
                        {
                            title: '&bull; ' + this.lang.get('unorderedlist'),
                            func: 'list.toggle'
                        },
                        orderedlist:
                        {
                            title: '1. ' + this.lang.get('orderedlist'),
                            func: 'list.toggle'
                        },
                        outdent:
                        {
                            title: '< ' + this.lang.get('outdent'),
                            func: 'indent.decrease'
                        },
                        indent:
                        {
                            title: '> ' + this.lang.get('indent'),
                            func: 'indent.increase'
                        },
                        image:
                        {
                            title: this.lang.get('image'),
                            func: 'image.show'
                        },
                        file:
                        {
                            title: this.lang.get('file'),
                            func: 'file.show'
                        },
                        link:
                        {
                            title: this.lang.get('link'),
                            dropdown:
                            {
                                link:
                                {
                                    title: this.lang.get('link_insert'),
                                    func: 'link.show'
                                },
                                unlink:
                                {
                                    title: this.lang.get('unlink'),
                                    func: 'link.unlink'
                                }
                            }
                        },
                        alignment:
                        {
                            title: this.lang.get('alignment'),
                            dropdown:
                            {
                                left:
                                {
                                    title: this.lang.get('align_left'),
                                    func: 'alignment.left'
                                },
                                center:
                                {
                                    title: this.lang.get('align_center'),
                                    func: 'alignment.center'
                                },
                                right:
                                {
                                    title: this.lang.get('align_right'),
                                    func: 'alignment.right'
                                },
                                justify:
                                {
                                    title: this.lang.get('align_justify'),
                                    func: 'alignment.justify'
                                }
                            }
                        },
                        horizontalrule:
                        {
                            title: this.lang.get('horizontalrule'),
                            func: 'line.insert'
                        }
                    };
                },
                build: function()
                {
                    this.toolbar.hideButtons();
                    this.toolbar.hideButtonsOnMobile();
                    this.toolbar.isButtonSourceNeeded();

                    if (this.opts.buttons.length === 0) return;

                    this.$toolbar = this.toolbar.createContainer();

                    this.toolbar.setOverflow();
                    this.toolbar.append();
                    this.toolbar.setFormattingTags();
                    this.toolbar.loadButtons();
                    this.toolbar.setFixed();

                    // buttons response
                    if (this.opts.activeButtons)
                    {
                        this.$editor.on('mouseup.redactor keyup.redactor focus.redactor', $.proxy(this.observe.buttons, this));
                    }

                },
                createContainer: function()
                {
                    return $('<ul>').addClass('redactor-toolbar').attr('id', 'redactor-toolbar-' + this.uuid);
                },
                setFormattingTags: function()
                {
                    $.each(this.opts.toolbar.formatting.dropdown, $.proxy(function (i, s)
                    {
                        if ($.inArray(i, this.opts.formatting) == -1) delete this.opts.toolbar.formatting.dropdown[i];
                    }, this));

                },
                loadButtons: function()
                {
                    $.each(this.opts.buttons, $.proxy(function(i, btnName)
                    {
                        if (!this.opts.toolbar[btnName]) return;

                        if (btnName === 'file')
                        {
                             if (this.opts.fileUpload === false) return;
                             else if (!this.opts.fileUpload && this.opts.s3 === false) return;
                        }

                        if (btnName === 'image')
                        {
                             if (this.opts.imageUpload === false) return;
                             else if (!this.opts.imageUpload && this.opts.s3 === false) return;
                        }

                        var btnObject = this.opts.toolbar[btnName];
                        this.$toolbar.append($('<li>').append(this.button.build(btnName, btnObject)));

                    }, this));
                },
                append: function()
                {
                    if (this.opts.toolbarExternal)
                    {
                        this.$toolbar.addClass('redactor-toolbar-external');
                        $(this.opts.toolbarExternal).html(this.$toolbar);
                    }
                    else
                    {
                        this.$box.prepend(this.$toolbar);
                    }
                },
                setFixed: function()
                {
                    if (!this.utils.isDesktop()) return;
                    if (this.opts.toolbarExternal) return;
                    if (!this.opts.toolbarFixed) return;

                    this.toolbar.observeScroll();
                    $(this.opts.toolbarFixedTarget).on('scroll.redactor.' + this.uuid, $.proxy(this.toolbar.observeScroll, this));

                },
                setOverflow: function()
                {
                    if (this.utils.isMobile() && this.opts.toolbarOverflow)
                    {
                        this.$toolbar.addClass('redactor-toolbar-overflow');
                    }
                },
                isButtonSourceNeeded: function()
                {
                    if (this.opts.source) return;

                    var index = this.opts.buttons.indexOf('html');
                    if (index !== -1)
                    {
                        this.opts.buttons.splice(index, 1);
                    }
                },
                hideButtons: function()
                {
                    if (this.opts.buttonsHide.length === 0) return;

                    $.each(this.opts.buttonsHide, $.proxy(function(i, s)
                    {
                        var index = this.opts.buttons.indexOf(s);
                        this.opts.buttons.splice(index, 1);

                    }, this));
                },
                hideButtonsOnMobile: function()
                {
                    if (!this.utils.isMobile() || this.opts.buttonsHideOnMobile.length === 0) return;

                    $.each(this.opts.buttonsHideOnMobile, $.proxy(function(i, s)
                    {
                        var index = this.opts.buttons.indexOf(s);
                        this.opts.buttons.splice(index, 1);

                    }, this));
                },
                observeScroll: function()
                {
                    var scrollTop = $(this.opts.toolbarFixedTarget).scrollTop();
                    var boxTop = 1;

                    if (this.opts.toolbarFixedTarget === document)
                    {
                        boxTop = this.$box.offset().top;
                    }

                    if (scrollTop > boxTop)
                    {
                        this.toolbar.observeScrollEnable(scrollTop, boxTop);
                    }
                    else
                    {
                        this.toolbar.observeScrollDisable();
                    }
                },
                observeScrollEnable: function(scrollTop, boxTop)
                {
                    var top = this.opts.toolbarFixedTopOffset + scrollTop - boxTop;
                    var left = 0;
                    var end = boxTop + this.$box.height() - 32;
                    var width = this.$box.innerWidth();

                    this.$toolbar.addClass('toolbar-fixed-box');
                    this.$toolbar.css({
                        position: 'absolute',
                        width: width,
                        top: top + 'px',
                        left: left
                    });

                    this.toolbar.setDropdownsFixed();
                    this.$toolbar.css('visibility', (scrollTop < end) ? 'visible' : 'hidden');
                },
                observeScrollDisable: function()
                {
                    this.$toolbar.css({
                        position: 'relative',
                        width: 'auto',
                        top: 0,
                        left: 0,
                        visibility: 'visible'
                    });

                    this.toolbar.unsetDropdownsFixed();
                    this.$toolbar.removeClass('toolbar-fixed-box');


                },
                setDropdownsFixed: function()
                {
                    var top = this.$toolbar.innerHeight() + this.opts.toolbarFixedTopOffset;
                    var position = 'fixed';
                    if (this.opts.toolbarFixedTarget !== document)
                    {
                        top = (this.$toolbar.innerHeight() + this.$toolbar.offset().top) + this.opts.toolbarFixedTopOffset;
                        position = 'absolute';
                    }

                    $('.redactor-dropdown-' + this.uuid).each(function()
                    {
                        $(this).css({ position: position, top: top + 'px' });
                    });
                },
                unsetDropdownsFixed: function()
                {
                    var top = (this.$toolbar.innerHeight() + this.$toolbar.offset().top);
                    $('.redactor-dropdown-' + this.uuid).each(function()
                    {
                        $(this).css({ position: 'absolute', top: top + 'px' });
                    });
                }
            };
        },
        upload: function()
        {
            return {
                init: function(id, url, callback)
                {
                    this.upload.direct = false;
                    this.upload.callback = callback;
                    this.upload.url = url;
                    this.upload.$el = $(id);
                    this.upload.$droparea = $('<div id="redactor-droparea" />');

                    this.upload.$placeholdler = $('<div id="redactor-droparea-placeholder" />').text(this.lang.get('upload_label'));
                    this.upload.$input = $('<input type="file" name="file" />');

                    this.upload.$placeholdler.append(this.upload.$input);
                    this.upload.$droparea.append(this.upload.$placeholdler);
                    this.upload.$el.append(this.upload.$droparea);

                    this.upload.$droparea.off('redactor.upload');
                    this.upload.$input.off('redactor.upload');

                    this.upload.$droparea.on('dragover.redactor.upload', $.proxy(this.upload.onDrag, this));
                    this.upload.$droparea.on('dragleave.redactor.upload', $.proxy(this.upload.onDragLeave, this));

                    // change
                    this.upload.$input.on('change.redactor.upload', $.proxy(function(e)
                    {
                        e = e.originalEvent || e;
                        this.upload.traverseFile(this.upload.$input[0].files[0], e);
                    }, this));

                    // drop
                    this.upload.$droparea.on('drop.redactor.upload', $.proxy(function(e)
                    {
                        e.preventDefault();

                        this.upload.$droparea.removeClass('drag-hover').addClass('drag-drop');
                        this.upload.onDrop(e);

                    }, this));
                },
                directUpload: function(file, e)
                {
                    this.upload.direct = true;
                    this.upload.traverseFile(file, e);
                },
                onDrop: function(e)
                {
                    e = e.originalEvent || e;
                    var files = e.dataTransfer.files;

                    this.upload.traverseFile(files[0], e);
                },
                traverseFile: function(file, e)
                {
                    if (this.opts.s3)
                    {
                        this.upload.setConfig(file);
                        this.upload.s3uploadFile(file);
                        return;
                    }

                    var formData = !!window.FormData ? new FormData() : null;
                    if (window.FormData)
                    {
                        this.upload.setConfig(file);

                        var name = (this.upload.type == 'image') ? this.opts.imageUploadParam : this.opts.fileUploadParam;
                        formData.append(name, file);
                    }

                    this.progress.show();
                    this.core.setCallback('uploadStart', e, formData);
                    this.upload.sendData(formData, e);
                },
                setConfig: function(file)
                {
                    this.upload.getType(file);

                    if (this.upload.direct)
                    {
                        this.upload.url = (this.upload.type == 'image') ? this.opts.imageUpload : this.opts.fileUpload;
                        this.upload.callback = (this.upload.type == 'image') ? this.image.insert : this.file.insert;
                    }
                },
                getType: function(file)
                {
                    this.upload.type = 'image';
                    if (this.opts.imageTypes.indexOf(file.type) == -1)
                    {
                        this.upload.type = 'file';
                    }
                },
                getHiddenFields: function(obj, fd)
                {
                    if (obj === false || typeof obj !== 'object') return fd;

                    $.each(obj, $.proxy(function(k, v)
                    {
                        if (v !== null && v.toString().indexOf('#') === 0) v = $(v).val();
                        fd.append(k, v);

                    }, this));

                    return fd;

                },
                sendData: function(formData, e)
                {
                    // append hidden fields
                    if (this.upload.type == 'image')
                    {
                        formData = this.upload.getHiddenFields(this.opts.uploadImageFields, formData);
                        formData = this.upload.getHiddenFields(this.upload.imageFields, formData);
                    }
                    else
                    {
                        formData = this.upload.getHiddenFields(this.opts.uploadFileFields, formData);
                        formData = this.upload.getHiddenFields(this.upload.fileFields, formData);
                    }

                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', this.upload.url);

                    // complete
                    xhr.onreadystatechange = $.proxy(function()
                    {
                        if (xhr.readyState == 4)
                        {
                            var data = xhr.responseText;

                            data = data.replace(/^\[/, '');
                            data = data.replace(/\]$/, '');

                            var json;
                            try
                            {
                                json = (typeof data === 'string' ? $.parseJSON(data) : data);
                            }
                            catch(err)
                            {
                                json = {
                                    error: true
                                };
                            }


                            this.progress.hide();

                            if (!this.upload.direct)
                            {
                                this.upload.$droparea.removeClass('drag-drop');
                            }

                            this.upload.callback(json, this.upload.direct, e);
                        }
                    }, this);


                    /*
                    xhr.upload.onprogress = $.proxy(function(e)
                    {
                        if (e.lengthComputable)
                        {
                            var complete = (e.loaded / e.total * 100 | 0);
                            //progress.value = progress.innerHTML = complete;
                        }

                    }, this);
                    */


                    xhr.send(formData);
                },
                onDrag: function(e)
                {
                    e.preventDefault();
                    this.upload.$droparea.addClass('drag-hover');
                },
                onDragLeave: function(e)
                {
                    e.preventDefault();
                    this.upload.$droparea.removeClass('drag-hover');
                },
                clearImageFields: function()
                {
                    this.upload.imageFields = {};
                },
                addImageFields: function(name, value)
                {
                    this.upload.imageFields[name] = value;
                },
                removeImageFields: function(name)
                {
                    delete this.upload.imageFields[name];
                },
                clearFileFields: function()
                {
                    this.upload.fileFields = {};
                },
                addFileFields: function(name, value)
                {
                    this.upload.fileFields[name] = value;
                },
                removeFileFields: function(name)
                {
                    delete this.upload.fileFields[name];
                },


                // S3
                s3uploadFile: function(file)
                {
                    this.upload.s3executeOnSignedUrl(file, $.proxy(function(signedURL)
                    {
                        this.upload.s3uploadToS3(file, signedURL);
                    }, this));
                },
                s3executeOnSignedUrl: function(file, callback)
                {
                    var xhr = new XMLHttpRequest();

                    var mark = '?';
                    if (this.opts.s3.search(/\?/) != '-1') mark = '&';

                    xhr.open('GET', this.opts.s3 + mark + 'name=' + file.name + '&type=' + file.type, true);

                    // Hack to pass bytes through unprocessed.
                    if (xhr.overrideMimeType) xhr.overrideMimeType('text/plain; charset=x-user-defined');

                    var that = this;
                    xhr.onreadystatechange = function(e)
                    {
                        if (this.readyState == 4 && this.status == 200)
                        {
                            that.progress.show();
                            callback(decodeURIComponent(this.responseText));
                        }
                        else if (this.readyState == 4 && this.status != 200)
                        {
                            //setProgress(0, 'Could not contact signing script. Status = ' + this.status);
                        }
                    };

                    xhr.send();
                },
                s3createCORSRequest: function(method, url)
                {
                    var xhr = new XMLHttpRequest();
                    if ("withCredentials" in xhr)
                    {
                        xhr.open(method, url, true);
                    }
                    else if (typeof XDomainRequest != "undefined")
                    {
                        xhr = new XDomainRequest();
                        xhr.open(method, url);
                    }
                    else
                    {
                        xhr = null;
                    }

                    return xhr;
                },
                s3uploadToS3: function(file, url)
                {
                    var xhr = this.upload.s3createCORSRequest('PUT', url);
                    if (!xhr)
                    {
                        //setProgress(0, 'CORS not supported');
                    }
                    else
                    {
                        xhr.onload = $.proxy(function()
                        {
                            if (xhr.status == 200)
                            {
                                //setProgress(100, 'Upload completed.');

                                this.progress.hide();

                                var s3file = url.split('?');

                                if (!s3file[0])
                                {
                                     // url parsing is fail
                                     return false;
                                }


                                if (!this.upload.direct)
                                {
                                    this.upload.$droparea.removeClass('drag-drop');
                                }

                                var json = { filelink: s3file[0] };
                                if (this.upload.type == 'file')
                                {
                                    var arr = s3file[0].split('/');
                                    json.filename = arr[arr.length-1];
                                }

                                this.upload.callback(json, this.upload.direct, false);


                            }
                            else
                            {
                                //setProgress(0, 'Upload error: ' + xhr.status);
                            }
                        }, this);

                        xhr.onerror = function()
                        {
                            //setProgress(0, 'XHR error.');
                        };

                        xhr.upload.onprogress = function(e)
                        {
                            /*
                            if (e.lengthComputable)
                            {
                                var percentLoaded = Math.round((e.loaded / e.total) * 100);
                                setProgress(percentLoaded, percentLoaded == 100 ? 'Finalizing.' : 'Uploading.');
                            }
                            */
                        };

                        xhr.setRequestHeader('Content-Type', file.type);
                        xhr.setRequestHeader('x-amz-acl', 'public-read');

                        xhr.send(file);
                    }
                }
            };
        },
        utils: function()
        {
            return {
                isMobile: function()
                {
                    return /(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent);
                },
                isDesktop: function()
                {
                    return !/(iPhone|iPod|iPad|BlackBerry|Android)/.test(navigator.userAgent);
                },
                isString: function(obj)
                {
                    return Object.prototype.toString.call(obj) == '[object String]';
                },
                isEmpty: function(html, removeEmptyTags)
                {
                    html = html.replace(/[\u200B-\u200D\uFEFF]/g, '');
                    html = html.replace(/&nbsp;/gi, '');
                    html = html.replace(/<\/?br\s?\/?>/g, '');
                    html = html.replace(/\s/g, '');
                    html = html.replace(/^<p>[^\W\w\D\d]*?<\/p>$/i, '');
                    html = html.replace(/<iframe(.*?[^>])>$/i, 'iframe');
                    html = html.replace(/<source(.*?[^>])>$/i, 'source');

                    // remove empty tags
                    if (removeEmptyTags !== false)
                    {
                        html = html.replace(/<[^\/>][^>]*><\/[^>]+>/gi, '');
                        html = html.replace(/<[^\/>][^>]*><\/[^>]+>/gi, '');
                    }

                    html = $.trim(html);

                    return html === '';
                },
                normalize: function(str)
                {
                    if (typeof(str) === 'undefined') return 0;
                    return parseInt(str.replace('px',''), 10);
                },
                hexToRgb: function(hex)
                {
                    if (typeof hex == 'undefined') return;
                    if (hex.search(/^#/) == -1) return hex;

                    var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
                    hex = hex.replace(shorthandRegex, function(m, r, g, b)
                    {
                        return r + r + g + g + b + b;
                    });

                    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                    return 'rgb(' + parseInt(result[1], 16) + ', ' + parseInt(result[2], 16) + ', ' + parseInt(result[3], 16) + ')';
                },
                getOuterHtml: function(el)
                {
                    return $('<div>').append($(el).eq(0).clone()).html();
                },
                getAlignmentElement: function(el)
                {
                    if ($.inArray(el.tagName, this.opts.alignmentTags) !== -1)
                    {
                        return $(el);
                    }
                    else
                    {
                        return $(el).closest(this.opts.alignmentTags.toString().toLowerCase(), this.$editor[0]);
                    }
                },
                removeEmptyAttr: function(el, attr)
                {
                    var $el = $(el);
                    if (typeof $el.attr(attr) == 'undefined')
                    {
                        return true;
                    }

                    if ($el.attr(attr) === '')
                    {
                        $el.removeAttr(attr);
                        return true;
                    }

                    return false;
                },
                removeEmpty: function(i, s)
                {
                    var $s = $(s);

                    $s.find('.redactor-invisible-space').removeAttr('style').removeAttr('class');

                    if ($s.find('hr, br, img, iframe, source').length !== 0) return;
                    var text = $.trim($s.text());
                    if (this.utils.isEmpty(text, false))
                    {
                        $s.remove();
                    }
                },

                // save and restore scroll
                saveScroll: function()
                {
                    this.saveEditorScroll = this.$editor.scrollTop();
                    this.saveBodyScroll = $(window).scrollTop();

                    if (this.opts.scrollTarget) this.saveTargetScroll = $(this.opts.scrollTarget).scrollTop();
                },
                restoreScroll: function()
                {
                    if (typeof this.saveScroll === 'undefined' && typeof this.saveBodyScroll === 'undefined') return;

                    $(window).scrollTop(this.saveBodyScroll);
                    this.$editor.scrollTop(this.saveEditorScroll);

                    if (this.opts.scrollTarget) $(this.opts.scrollTarget).scrollTop(this.saveTargetScroll);
                },

                // get invisible space element
                createSpaceElement: function()
                {
                    var space = document.createElement('span');
                    space.className = 'redactor-invisible-space';
                    space.innerHTML = this.opts.invisibleSpace;

                    return space;
                },

                // replace
                removeInlineTags: function(node)
                {
                    var tags = this.opts.inlineTags;
                    tags.push('span');

                    if (node.tagName == 'PRE') tags.push('a');

                    $(node).find(tags.join(',')).not('span.redactor-selection-marker').contents().unwrap();
                },
                replaceWithContents: function(node, removeInlineTags)
                {
                    var self = this;
                    $(node).replaceWith(function()
                    {
                        if (removeInlineTags === true) self.utils.removeInlineTags(this);

                        return $(this).contents();
                    });

                    return $(node);
                },
                replaceToTag: function(node, tag, removeInlineTags)
                {
                    var replacement;
                    var self = this;
                    $(node).replaceWith(function()
                    {
                        replacement = $('<' + tag + ' />').append($(this).contents());

                        for (var i = 0; i < this.attributes.length; i++)
                        {
                            replacement.attr(this.attributes[i].name, this.attributes[i].value);
                        }

                        if (removeInlineTags === true) self.utils.removeInlineTags(replacement);

                        return replacement;
                    });

                    return replacement;
                },

                // start and end of element
                isStartOfElement: function()
                {
                    var block = this.selection.getBlock();
                    if (!block) return false;

                    var offset = this.caret.getOffsetOfElement(block);

                    return (offset === 0) ? true : false;
                },
                isEndOfElement: function(element)
                {
                    if (typeof element == 'undefined')
                    {
                        var element = this.selection.getBlock();
                        if (!element) return false;
                    }

                    var offset = this.caret.getOffsetOfElement(element);
                    var text = $.trim($(element).text()).replace(/\n\r\n/g, '');

                    return (offset == text.length) ? true : false;
                },
                isEndOfEditor: function()
                {
                    var block = this.$editor[0];

                    var offset = this.caret.getOffsetOfElement(block);
                    var text = $.trim($(block).html().replace(/(<([^>]+)>)/gi,''));

                    return (offset == text.length) ? true : false;
                },

                // test blocks
                isBlock: function(block)
                {
                    block = block[0] || block;

                    return block && this.utils.isBlockTag(block.tagName);
                },
                isBlockTag: function(tag)
                {
                    if (typeof tag == 'undefined') return false;

                    return this.reIsBlock.test(tag);
                },

                // tag detection
                isTag: function(current, tag)
                {
                    var element = $(current).closest(tag);
                    if (element.length == 1)
                    {
                        return element[0];
                    }

                    return false;
                },

                // select all
                isSelectAll: function()
                {
                    return this.selectAll;
                },
                enableSelectAll: function()
                {
                    this.selectAll = true;
                },
                disableSelectAll: function()
                {
                    this.selectAll = false;
                },

                // parents detection
                isRedactorParent: function(el)
                {
                    if (!el)
                    {
                        return false;
                    }

                    if ($(el).parents('.redactor-editor').length === 0 || $(el).hasClass('redactor-editor'))
                    {
                        return false;
                    }

                    return el;
                },
                isCurrentOrParentHeader: function()
                {
                    return this.utils.isCurrentOrParent(['H1', 'H2', 'H3', 'H4', 'H5', 'H6']);
                },
                isCurrentOrParent: function(tagName)
                {
                    var parent = this.selection.getParent();
                    var current = this.selection.getCurrent();

                    if ($.isArray(tagName))
                    {
                        var matched = 0;
                        $.each(tagName, $.proxy(function(i, s)
                        {
                            if (this.utils.isCurrentOrParentOne(current, parent, s))
                            {
                                matched++;
                            }
                        }, this));

                        return (matched === 0) ? false : true;
                    }
                    else
                    {
                        return this.utils.isCurrentOrParentOne(current, parent, tagName);
                    }
                },
                isCurrentOrParentOne: function(current, parent, tagName)
                {
                    tagName = tagName.toUpperCase();

                    return parent && parent.tagName === tagName ? parent : current && current.tagName === tagName ? current : false;
                },


                // browsers detection
                isOldIe: function()
                {
                    return (this.utils.browser('msie') && parseInt(this.utils.browser('version'), 10) < 9) ? true : false;
                },
                isLessIe10: function()
                {
                    return (this.utils.browser('msie') && parseInt(this.utils.browser('version'), 10) < 10) ? true : false;
                },
                isIe11: function()
                {
                    return !!navigator.userAgent.match(/Trident\/7\./);
                },
                browser: function(browser)
                {
                    var ua = navigator.userAgent.toLowerCase();
                    var match = /(opr)[\/]([\w.]+)/.exec( ua ) ||
                    /(chrome)[ \/]([\w.]+)/.exec( ua ) ||
                    /(webkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(ua) ||
                    /(webkit)[ \/]([\w.]+)/.exec( ua ) ||
                    /(opera)(?:.*version|)[ \/]([\w.]+)/.exec( ua ) ||
                    /(msie) ([\w.]+)/.exec( ua ) ||
                    ua.indexOf("trident") >= 0 && /(rv)(?::| )([\w.]+)/.exec( ua ) ||
                    ua.indexOf("compatible") < 0 && /(mozilla)(?:.*? rv:([\w.]+)|)/.exec( ua ) ||
                    [];

                    if (browser == 'safari') return (typeof match[3] != 'undefined') ? match[3] == 'safari' : false;
                    if (browser == 'version') return match[2];
                    if (browser == 'webkit') return (match[1] == 'chrome' || match[1] == 'opr' || match[1] == 'webkit');
                    if (match[1] == 'rv') return browser == 'msie';
                    if (match[1] == 'opr') return browser == 'webkit';

                    return browser == match[1];
                }
            };
        }
    };

    $(window).on('load.tools.redactor', function()
    {
        $('[data-tools="redactor"]').redactor();
    });

    // constructor
    Redactor.prototype.init.prototype = Redactor.prototype;

    // LINKIFY
    $.Redactor.fn.formatLinkify = function(protocol, convertLinks, convertUrlLinks, convertImageLinks, convertVideoLinks, linkSize)
    {
        var urlCheck = '((?:http[s]?:\\/\\/(?:www\\.)?|www\\.){1}(?:[0-9A-Za-z\\-%_]+\\.)+[a-zA-Z]{2,}(?::[0-9]+)?(?:(?:/[0-9A-Za-z\\-#\\.%\+_]*)+)?(?:\\?(?:[0-9A-Za-z\\-\\.%_]+(?:=[0-9A-Za-z\\-\\.%_\\+]*)?)?(?:&(?:[0-9A-Za-z\\-\\.%_]+(?:=[0-9A-Za-z\\-\\.%_\\+]*)?)?)*)?(?:#[0-9A-Za-z\\-\\.%_\\+=\\?&;]*)?)';
        var regex = new RegExp(urlCheck, 'gi');
        var rProtocol = /(https?|ftp):\/\//i;
        var urlImage = new RegExp('(?:([^:/?#]+):)?(?:\/\/([^/?#]*))?([^?#]*\\.(?:jpg|gif|png))(?:\\?([^#]*))?(?:#(.*))?', 'gi');

        var childNodes = (this.$editor ? this.$editor[0] : this).childNodes, i = childNodes.length;
        while (i--)
        {
            var n = childNodes[i];

            if (n.nodeType === 3 && n.parentNode !== 'PRE')
            {
                var html = n.nodeValue;

                // youtube & vimeo
                if (convertVideoLinks && html)
                {
                    var iframeStart = '<iframe width="500" height="281" src="',
                        iframeEnd = '" frameborder="0" allowfullscreen></iframe>';

                    if (html.match(reUrlYoutube))
                    {
                        html = html.replace(reUrlYoutube, iframeStart + '//www.youtube.com/embed/$1' + iframeEnd);
                        $(n).after(html).remove();
                    }
                    else if (html.match(reUrlVimeo))
                    {
                        html = html.replace(reUrlVimeo, iframeStart + '//player.vimeo.com/video/$2' + iframeEnd);
                        $(n).after(html).remove();
                    }
                }

                // image
                if (convertImageLinks && html && html.match(urlImage))
                {
                    var matches = html.match(urlImage);
                    html = html.replace(urlImage, '<img src="' + matches + '" />');

                    $(n).after(html).remove();
                    return;
                }

                // link
                if (html.search(/\$/g) != -1) html = html.replace(/\$/g, '&#36;');

                var matches = html.match(regex);
                if (convertUrlLinks && html && matches)
                {
                    var len = matches.length;
                    for (var z = 0; z < len; z++)
                    {
                        // remove dot in the end
                        if (matches[z].match(/\.$/) !== null) matches[z] = matches[z].replace(/\.$/, '');

                        var href = matches[z];
                        var text = href;

                        var space = '';
                        if (href.match(/\s$/) !== null) space = ' ';

                        var addProtocol = protocol + '://';
                        if (href.match(rProtocol) !== null) addProtocol = '';

                        if (text.length > linkSize) text = text.substring(0, linkSize) + '...';
                        text = text.replace(/&#36;/g, '$').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

                        // buffer
                        var buffer = [];
                        var links = html.match('<a(.*?)</a>');
                        if (links !== null)
                        {
                            var len = links.length;
                            for (i = 0; i < len; i++)
                            {
                                buffer[i] = links[i];
                                html = html.replace(links[i], '{abuffer' + i + '}');
                            }
                        }

                        html = html.replace(href, '<a href=\"' + addProtocol + $.trim(href) + '\">' + $.trim(text) + '</a>' + space);

                        // rebuffer
                        $.each(buffer, function(i,s)
                        {
                            html = html.replace('{abuffer' + i + '}', s);
                        });
                    }

                    $(n).after(html).remove();
                }
            }
            else if (n.nodeType === 1 && !/^(pre|a|button|textarea)$/i.test(n.tagName))
            {
                $.Redactor.fn.formatLinkify.call(n, protocol, convertLinks, convertUrlLinks, convertImageLinks, convertVideoLinks, linkSize);
            }
        }
    };

})(jQuery);
define("redactor", function(){});


define('text!scripts/redactor/ueditor-templates.html',[],function () { return '<div>\r\n<!--\r\n\tWrap everything in a div to convert this file\'s content in a jquery element\r\n\tso it is possible to use $.find.\r\n-->\r\n\r\n<script type="text/template" id="link-tpl">\r\n\t<input type="hidden" id="ueditor-link" value="{{url}}">\r\n\t<div class="upfront-field-wrap">\r\n\t\t<input type="radio" name="ueditor-link" value="external" class="upfront-field-radio"  {{link == \'external\' ? \'checked="checked"\' : \'\'}} id="ueditor-link-external">\r\n\t\t<label for="ueditor-link-external">External URL</label>\r\n\t\t<input type="text" value="{{url}}" id="ueditor-link-url" placeholder="Type link URL" style="{{link != \'external\' ? \'display:none\' : \'\'}}" class="upfront-field-text ueditor-link-hidden">\r\n\t</div>\r\n\t<div class="upfront-field-wrap">\r\n\t\t<input type="radio" name="ueditor-link" value="post" class="upfront-field-radio" {{link == \'post\' ? \'checked="checked"\' : \'\'}} id="ueditor-link-post">\r\n\t\t<label for="ueditor-link-post">Post or page</label>\r\n\t\t<a title="Change link" href="#" class="ueditor-change-link-post ueditor-link-hidden" style="{{link != \'post\' ? \'display:none\' : \'\'}}">{{url}}</a>\r\n\t</div>\r\n\r\n\t{[if(anchors.length > 1) { ]}\r\n\t<div class="upfront-field-wrap">\r\n\t\t<input type="radio" name="ueditor-link" value="anchor" class="upfront-field-radio" {{link == \'anchor\' ? \'checked="checked"\' : \'\'}} id="ueditor-link-anchor">\r\n\t\t<label for="ueditor-link-anchor">Anchor</label>\r\n\t\t<div class="ueditor-anchor ueditor-link-hidden" style="{{link != \'anchor\' ? \'display:none\' : \'\'}}">\r\n\t\t\t<select class="ueditor-anchor-selector">\r\n\t\t\t{[ _.each(anchors, function(anchor){ ]}\r\n\t\t\t\t<option value="#{{ anchor }}" {{ url == \'#\' + anchor ? \'selected="selected"\' : \'\' }}>{{anchor}}</option>\r\n\t\t\t{[ }); ]}\r\n\t\t\t</select>\r\n\t\t</div>\r\n\t</div>\r\n\t{[ } ]}\r\n\r\n\t{[if(url) { ]}\r\n\t<div class="upfront-field-wrap">\r\n\t\t<a href="#" class="ueditor-unlink">Unlink</a>\r\n\t</div>\r\n\t{[ } ]}\r\n</script>\r\n\r\n<script type="text/template" id="post-image-insert-tpl">\r\n    <div data-variant="{{variant_id}}" class="ueditor-insert ueditor-insert-variant-group {{style.label_id}} ueditor-insert-float-{{style.group.float}} {{style.group.width_cls}} {{style.group.left_cls}}" style="min-height: {{style.group.height}}px;float:{{style.group.float}}; {[if( style.group.marginRight > 0 ){]}margin-right:{{style.group.marginRight}}px;{[ } ]} {[if( style.group.marginLeft > 0 ) {]}margin-left:{{style.group.marginLeft}}px;{[ } ]}" >\r\n        {[if( style.caption.order == 0 && show_caption) {]}\r\n            <div class="upfront-wrapper wp-caption-text {{style.caption.width_cls}} {{style.caption.left_cls}} {{style.caption.top_cls}}" style="min-height:{{style.caption.height}}px">{{ caption }}</div>\r\n        {[ } ]}\r\n        <div class="upfront-wrapper uinsert-image-wrapper {{style.image.width_cls}} {{style.image.left_cls}} {{style.image.top_cls}} {[ if(!isLocal){ ]}uinsert-image-external{[ } ]}" style="min-height: {{style.image.height}}px;">{[if(linkType != "do_nothing"){ ]}<a href="{{linkUrl}}">{[ } ]}<img class="" data-url="{imageFull.src}"  src="{{image.src}}" {[if(!isLocal){ ]}style="top: {{ externalImage.top }}px; left: {{ externalImage.left }}px; width: {{ externalImage.width }}px; height: {{ externalImage.height }}px"{[ } ]}/>{[if(linkType != "do_nothing"){ ]}</a>{[ } ]}</div>\r\n            {[if( style.caption.order == 1 && show_caption) {]}\r\n                <div class="upfront-wrapper wp-caption-text {{style.caption.width_cls}} {{style.caption.left_cls}} {{style.caption.top_cls}}" style="min-height:{{style.caption.height}}px">{{ caption }}</div>\r\n            {[ } ]}\r\n        <div style="clear:both;"></div>\r\n\r\n    </div>\r\n    <div class="post-images-shortcode" contenteditable="false"></div>\r\n</script>\r\n\r\n<script type="text/template" id="post-image-insert-shortcode-tpl">\r\n    [caption id="{{id}}"  uf_variant="{{variant_id}}" uf_show_caption="{{show_caption}}" ]\r\n        {[if( style.caption.order == 0 ) {]}\r\n            {{ caption }}\r\n        {[ } ]}\r\n        {[if(linkType != "do_nothing"){ ]}<a href="{{linkUrl}}">{[ } ]}\r\n        <img width="{{image.width}}"   src="{{image.src}}"/>\r\n        {[if(linkType != "do_nothing"){ ]}</a>{[ } ]}\r\n\r\n        {[if( style.caption.order == 1 ) {]}\r\n            {{ caption }}\r\n        {[ } ]}\r\n    [/caption]\r\n</script>\r\n<script type="text/template" id="post-image-insert-wp-tpl">\r\n    <div id="attachment_{{attachment_id}}" style="width: {{style.wrapper.width}}px" class="wp-caption {{style.wrapper.alignment}}">\r\n        {[ if(link_url){ ]}<a href="{{link_url}}"> {[ } ]}\r\n            <img src="{{image.src}}" {[ if( image.width ){  ]} width="{{image.width}}" {[ } ]}  class="{{style.image.size_class}} wp-image-{{attachment_id}}" >\r\n        {[ if(link_url){ ]} </a> {[ } ]}\r\n        {[ if(style.caption.show){ ]}\r\n            <p class="wp-caption-text">{{caption}}</p>\r\n        {[ } ]}\r\n    </div>\r\n    <div class="post-images-shortcode-wp" contenteditable="false"></div>\r\n</script>\r\n<script type="text/template" id="post-image-insert-shortcode-wp-tpl">\r\n   [caption id="attachment_{{attachment_id}}" align="{{style.wrapper.alignment}}" width="{{style.wrapper.width}}" show_caption="{{style.caption.show}}" ]\r\n        {[ if(link_url){ ]}<a href="{{link_url}}"> {[ } ]}\r\n            <img  src="{{image.src}}"  width="{{image.width}}" height="{{image.height}}"  class="{{style.image.size_class}}  wp-image-{{attachment_id}}">\r\n       {[ if(link_url){ ]} </a> {[ } ]}\r\n        {{caption}}\r\n   [/caption]\r\n</script>\r\n<script type="text/template" id="image-insert-tpl">\r\n    <div data-variant="{{variant_id}}" class="ueditor-insert ueditor-insert-variant-group {{style.label_id}} ueditor-insert-float-{{style.group.float}} {{style.group.width_cls}} {{style.group.left_cls}}" style="min-height: {{style.group.height}}px;float:{{style.group.float}}; {[if( style.group.marginRight > 0 ){]}margin-right:{{style.group.marginRight}}px;{[ } ]} {[if( style.group.marginLeft > 0 ) {]}margin-left:{{style.group.marginLeft}}px;{[ } ]}" >\r\n        {[if( style.caption.order == 0 && show_caption) {]}\r\n        <div class="upfront-wrapper wp-caption-text c24" style="min-height:{{style.caption.height}}px">{{ caption }}</div>\r\n        {[ } ]}\r\n        <div class="upfront-wrapper uinsert-image-wrapper {{style.image.width_cls}} {{style.image.left_cls}} {{style.image.top_cls}} {[ if(!isLocal){ ]}uinsert-image-external{[ } ]}" style="min-height: {{style.image.height}}px;">{[if(linkType != "do_nothing"){ ]}<a href="{{linkUrl}}">{[ } ]}<img class="" src="{{image.src}}" {[if(!isLocal){ ]}style="top: {{ externalImage.top }}px; left: {{ externalImage.left }}px; width: {{ externalImage.width }}px; height: {{ externalImage.height }}px"{[ } ]}/>{[if(linkType != "do_nothing"){ ]}</a>{[ } ]}</div>\r\n      \r\n        {[if( style.caption.order == 1 && show_caption) {]}\r\n        <div class="upfront-wrapper wp-caption-text c24" style="min-height:{{style.caption.height}}px">{{ caption }}</div>\r\n        {[ } ]}\r\n        <div style="clear:both;"></div>\r\n\r\n    </div>\r\n</script>\r\n<script type="text/template" id="image-link-tpl">\r\n\t<div class="upfront-field-wrap">\r\n\t\t<input type="radio" name="uinsert-image-link" value="do_nothing" class="upfront-field-radio" id="uinsert-image-link-1" {{linkType == \'do_nothing\' ? checked : \'\'}}>\r\n\t\t<label for="uinsert-image-link-1">No link</label>\r\n\t</div>\r\n\t<div class="upfront-field-wrap">\r\n\t\t<input type="radio" name="uinsert-image-link" value="external" class="upfront-field-radio" id="uinsert-image-link-2" {{linkType == \'external\' ? checked : \'\'}}>\r\n\t\t<label for="uinsert-image-link-2">External link</label>\r\n\t\t<input type="text" value="{{linkUrl}}" id="uinsert-image-link-url" placeholder="Type link URL" style="{{linkType != \'external\' ? \'display:none\' : \'\'}}" class="upfront-field-text">\r\n\t</div>\r\n\t<div class="upfront-field-wrap">\r\n\t\t<input type="radio" name="uinsert-image-link" value="post" class="upfront-field-radio" id="uinsert-image-link-3" {{linkType == \'post\' ? checked : \'\'}}>\r\n\t\t<label for="uinsert-image-link-3">Link to a post or page</label>\r\n\t\t<a title="Change link" class="uinsert-change-link-post" style="{{linkType != \'post\' ? \'display:none\' : \'\'}}">{{linkUrl}}</a>\r\n\t</div>\r\n\t<div class="upfront-field-wrap">\r\n\t\t<input type="radio" name="uinsert-image-link" value="show_larger_image" class="upfront-field-radio" id="uinsert-image-link-4" {{linkType == \'show_larger_image\' ? checked : \'\'}}>\r\n\t\t<label for="uinsert-image-link-4">Show larger image</label>\r\n\t</div>\r\n</script>\r\n<script type="text/template" id="embed-insert-tpl">\r\n    <div class="inserted_code_rendered">{{code}}</div>\r\n</script>\r\n<script type="text/template" id="embed-insert-form-tpl">\r\n    <div class="upfront-field-embed_code-wrap">\r\n        <h3>Type or paste the embed code</h3>\r\n        <textarea name="upfront-field-embed_code" class="upfront-field-embed_code" id="upfront-field-embed_code" cols="30" rows="5">{{code}}</textarea>\r\n    </div>\r\n</script>\r\n<script type="text/template" id="font-icons">\r\n    <div class="icons">\r\n        {[ _.each(icons, function(icon){  ]}\r\n        <a href="javascript:void(0);" class="redactor_btn ueditor-font-icon"><span class="uf_font_icon">{{icon}}</span></a>\r\n        {[ }); ]}\r\n    </div>\r\n    <ul class="upfront-font-icons-controlls">\r\n        <li>\r\n            <label>\r\n                Size:\r\n            </label>   \r\n            <input class="upfront-field-number font-icons-size"  type="number" value="27" step="1" min="16" max="200">\r\n        </li>\r\n        <li class="font-icons-top-li">\r\n            <label>\r\n                Top:\r\n            </label>  \r\n            <input class="upfront-field-number font-icons-top"  type="number" value="0" step="1" min="-35" max="45">\r\n        </li>\r\n    </ul>\r\n</script>\r\n\r\n<script type="text/template" id="insert-manager-tpl">\r\n    <div class="ueditor-post-insert-manager">\r\n        <div class="upfront-image-attachment-bits upfront-post-media-trigger"></div>\r\n    </div>\r\n</script>\r\n\r\n<script type="text/template" id="insert-manager-tooltip-tpl">\r\n    <div class="upfront-image-attachment-bits upfront-post-media-trigger"></div>\r\n    <div class="uinsert-selector upfront-ui">\r\n    {[ _.each(inserts, function(insert, type){  ]}\r\n        <a href="#" class="uinsert-selector-option uinsert-selector-{{type}}" data-insert="{{type}}"><span class="uinsert-text">{{names[type]}}</span><span  data-insert="{{type}}" class="uinsert-text-overlay"></span></a>\r\n    {[ }); ]}\r\n    </div>\r\n</script>\r\n\r\n<script type="text/template" id="image-style-tpl">\r\n    {[ _.each(data.variants, function(variant, index){  ]}\r\n    <div class="upfront-field-wrap">\r\n        <input type="radio" name="uinsert-image-style-variant" value="{{variant.vid}}" {{data.selected == variant.vid ? "checked=\'checked\'" : ""}} class="upfront-field-radio" id="uinsert-image-variant-{{variant.vid}}">\r\n        <label for="uinsert-image-variant-{{variant.vid}}">{{variant.label}}</label>\r\n    </div>\r\n    {[ }); ]}\r\n</script>\r\n\r\n<script type="text/template" id="wp-image-style-tpl">\r\n    {[ _.each(data.variants, function(variant, index){  ]}\r\n        <i class="upfront-icon upfront-icon-wp-image-style  {{variant.icon}} {[ if( data.selected == variant.id ) { ]} upfront-icon-wp-image-style-selected {[ } ]}" data-id="{{variant.id}}" title="{{variant.label}}"></i>\r\n    {[ }); ]}\r\n</script>\r\n<script type="text/template" id="upfront-formatting">\r\n    <ul class="upfront-redactor-tag-list">\r\n        <li class="tag-list-section-title">\r\n            {{standard_formatting}}\r\n        </li>\r\n        <li>\r\n            <p  data-tag="p" class="tag-list-tag-p tag-list-tag">{{paragraph}}</p>\r\n        </li>\r\n        <li>\r\n            <h1  data-tag="h1" class="tag-list-tag-h1 tag-list-tag">{{heading_01}}</h1>\r\n        </li>\r\n        <li>\r\n            <h2 data-tag="h2" class="tag-list-tag-h2 tag-list-tag">{{heading_02}}</h2>\r\n        </li>\r\n        <li>\r\n            <h3  data-tag="h3" class="tag-list-tag-h3 tag-list-tag">{{heading_03}}</h3>\r\n        </li>\r\n        <li>\r\n            <h4 data-tag="h4" class="tag-list-tag-h4 tag-list-tag">{{heading_04}}</h4>\r\n        </li>\r\n        <li>\r\n            <h5 data-tag="h5" class="tag-list-tag-h5 tag-list-tag">{{heading_05}}</h5>\r\n        </li>\r\n        <li>\r\n            <h6 data-tag="h6" class="tag-list-tag-h6 tag-list-tag">{{heading_06}}</h6>\r\n        </li>\r\n\r\n        <li>\r\n            <pre data-tag="pre" class="tag-list-tag-pre tag-list-tag">{{preformatted}}</pre>\r\n        </li>\r\n        <li>\r\n            <blockquote data-tag="blockquote" class="tag-list-tag-blockquote tag-list-tag">{{blockquote}}</blockquote>\r\n        </li>\r\n        <!--<li>-->\r\n            <!--<a href="#" data-tag="blockquote">"</a>-->\r\n        <!--</li>-->\r\n    </ul>\r\n    <!--<select name="ufront-formatting-custom-class" class="upfront-field-select ufront-formatting-custom-class">-->\r\n        <!--{[ _.each(custom_classes, function(custom_class, index){  ]}-->\r\n            <!--<option value="{{custom_class}}">{{custom_class}}</option>-->\r\n        <!--{[ }); ]}-->\r\n    <!--</select>-->\r\n</script>\r\n</div>';});

;(function($){
define('scripts/redactor/ueditor-insert',['text!scripts/redactor/ueditor-templates.html'], function(tpls){

/*
An insert is a part of a post content that have special functionality and should be stored in
a different way that it is shown.
A shortcode is a good example of insert:
	- It may have settings
	- It is stored as a string with the format [shortcode]
	- It is displayed as html

Insert purpose is let upfront handle this kind of parts of a post content with ease.

*/
var UeditorInsert = Backbone.View.extend({
    shortcodeName: 'ueditor-insert',
    attributes: {contenteditable: 'false'},
    defaultData : {},
    resizable: false,
	initialize: function(opts){
		opts = opts || {};
		var data = opts.data || {};
		//data = _.extend({}, this.defaultData, data); // lets merge data in the child classes
		if(!data.id){
			data.id = this.generate_new_id();
			//Trigger the insertcount change for updating the server
			Upfront.Events.trigger('content:insertcount:updated');
		}
		this.el.id = data.id;
		this.data = new Backbone.Model(data);
		this.listenTo(this.data, 'change add remove reset', this.render);
		this.createControls();

		if(typeof this.init == 'function')
			this.init( opts );
	},
    generate_new_id: function(){
       return 'uinsert-' + (++Upfront.data.ueditor.insertCount);
    },
	start: function(){
		//Dumb start method returning a resolved promise. Override it if async start needed.
		var deferred = $.Deferred();
		deferred.resolve();
		return deferred.promise();
	},
	getOutput: function(){
		var data = this.data.toJSON(),
			shortcode = '[ueditor-insert type="' + this.type + '"'
		;

		_.each(data, function(value, key){
			shortcode += ' ' + key + '="' + value + '"';
		});

		return shortcode + ']';
	},

	importInserts: function(contentElement){
		var me = this,
			regExp = new RegExp('(\[' + this.shortcodeName.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&') + '[^\]]*?\])', 'ig'),
			content = contentElement.html(),
			container = $('<div></div>')
		;

		content = content.replace(regExp, '<p class="ueditor-insert">$1</p>');

		var inserts = container.html(content).find('p.ueditor-insert');
		inserts.each(function(){
			var shortcode = me.parseShortcode(this.innerHTML);
			if(shortcode.type && insertObjects[shortcode.type]){

			}
		});

	},
	parseShortcode: function(text){
		var regexp = /\[([^\s\]]+)([^\]]*?)\]/i,
			attrRegExp = /(\w+)\s*=\s*"([^"]*)"(?:\s|$)|(\w+)\s*=\s*\'([^\']*)\'(?:\s|$)|(\w+)\s*=\s*([^\s\'"]+)(?:\s|$)|"([^"]*)"(?:\s|$)|(\S+)(?:\s|$)/ig,
			scData = text.match(regexp),
			shortcode = {},
			attrs
		;

		if(!scData)
			return false;

		shortcode.shortcodeName = scData[1];
		attrs = $.trim(scData[2]);
		if(attrs){
			var attrsData = attrs.match(attrRegExp);
			if(attrsData){
				_.each(attrsData, function(attr){
					attr = $.trim(attr);
					var parts = attr.split('=');
					if(parts.length == 1)
						shortcode[attr] = attr;
					else {
						var key = $.trim(parts[0]),
							value = $.trim(parts.slice(1).join('='))
						;
						if(value[0] == '"' && value[value.length -1] == '"' || value[0] == "'" && value[value.length - 1] == "'")
							value = value.slice(1, -1);
						shortcode[key] = value;
					}
				});
			}
		}

		return shortcode;
	},
	createControls: function(){
		var me = this,
			Controls = Upfront.Views.Editor.InlinePanels
		;
		if(this.controls){
			this.controls.remove();
			this.controls = false;
		}

		if(!this.controlsData)
			return;

		this.controls =  Controls.ControlPanel.extend( { position_v: 'top' } );
		this.controls = new this.controls();

		/*
		{
			type: 'simple',
			id: 'controlId',
			icon: 'iconclassname'
			tooltip: 'Awesome tooltip'
		}

		{
			type: 'multi',
			id, icon, tooltip,
			selected: '', // What is the selected item.
			subItems: [...simpleControls...]
		}

		{
			type: 'dialog',
			id, icon, tooltip,
			view: BBView // some Backbone View to be shown inside the tooltip
		}
		 */

		var items = [];
		_.each(this.controlsData, function(controlData){
			var control;
			if(controlData.type == 'simple'){
				control = me.createSimpleControl(controlData);
				me.controls.listenTo(control, 'click', function(){
					me.controls.trigger('control:click', control);
					me.controls.trigger('control:click:' + control.id, control);
				});
			}
			else if(controlData.type == 'multi'){
				control = new Controls.TooltipControl();
				control.selected = controlData.selected;

				if(controlData.subItems){
					var subItems = {};
					_.each(controlData.subItems, function(subItemData){
						subItems[subItemData.id] = me.createSimpleControl(subItemData);
					});
					control.sub_items = subItems;
				}

				me.controls.listenTo(control, 'select', function(item){
					me.controls.trigger('control:select:' + control.id, item);
				});
			}
			else if(controlData.type == 'dialog'){
				control = new Controls.DialogControl();
				control.view = controlData.view;
				me.controls.listenTo(control, 'panel:ok', function(view){
					me.controls.trigger('control:ok:' + control.id, view, control);
				});

				me.controls.listenTo(control, 'panel:open', function(){
					me.controls.$el.addClass('uinsert-control-visible');
					me.$el.addClass('nosortable');
				});
				me.controls.listenTo(control, 'panel:close', function(){
					me.controls.$el.removeClass('uinsert-control-visible');
					me.$el.removeClass('nosortable');
				});
			}

			if(control){
                _.extend(control, controlData);
				items.push(control);
			}
		});

		this.controls.items = _(items);
		this.controls.render();

		if(typeof this.controlEvents == 'function')
			this.controlEvents();

		this.controls.delegateEvents();
	},

	createSimpleControl: function(controlData){
		var control = new Upfront.Views.Editor.InlinePanels.Control();
		control.icon = controlData.icon;
		control.tooltip = controlData.tooltip;
		control.id = controlData.id;
		control.label = controlData.label;
		return control;
	},

	getAligmnentControlData: function(alignments){
		var types = {
				left: {id: 'left', icon: 'alignleft', tooltip: 'Align left'},
				right: {id: 'right', icon: 'alignright', tooltip: 'Align right'},
				center: {id: 'center', icon: 'aligncenter', tooltip: 'Align center'},
				full: {id: 'full', icon: 'alignfull', tooltip: 'Full width'}
			},
			control = {
				id: 'alignment',
				type: 'multi',
				icon: 'alignment',
				tooltip: 'Alignment',
				subItems: []
			}
		;
		_.each(alignments, function(align){
			if(types[align])
				control.subItems.push(types[align]);
		});
		return control;
	},
	getRemoveControlData: function(){
		return {
			id: 'remove',
			type: 'simple',
			icon: 'remove',
			tooltip: 'Delete'
		};
	},
	resizableInsert: function(){
		if( !this.resizable ) return;
		var me = this,
			align = this.data.get('align'),
			leftControl = true,
			rightControl = true,
			targetSelector = '.upfront-icon-control-resize-se',
			handles = {},
			grid = Upfront.Behaviors.GridEditor
		;


		if(this.$el.hasClass('ui-resizable'))
			this.$el.resizable('destroy');

		if(align == 'left')
			leftControl = false;
		else if(align == 'right'){
			rightControl = false;
			targetSelector = '.upfront-icon-control-resize-sw';
		}

		if(this.$(targetSelector).length){
		}
		else{
			if(rightControl){
				this.$el.append('<span class="upfront-icon-control upfront-icon-control-resize-se upfront-resize-handle-se ui-resizable-handle ui-resizable-se nosortable" style="display: inline;"></span>');
				handles.se = '.upfront-icon-control-resize-se';
			}
			if(leftControl){
				this.$el.append('<span class="upfront-icon-control upfront-icon-control-resize-sw upfront-resize-handle-sw ui-resizable-handle ui-resizable-sw nosortable" style="display: inline;"></span>');
				handles.sw = '.upfront-icon-control-resize-sw';
			}
		}

		var resizableOptions = this.getResizableOptions ? this.getResizableOptions() : {};
		resizableOptions.handles = handles;
		resizableOptions.grid = [grid.col_size, grid.baseline];

		this.$el.resizable(resizableOptions);
	}
});


return {
    UeditorInsert: UeditorInsert
};

//End Define
});})(jQuery);

;(function($){
    define('scripts/redactor/ueditor-insert-utils',[
            'text!scripts/redactor/ueditor-templates.html'
        ],
        function(tpls){

var l10n = Upfront.mainData.l10n.global.ueditor;

var BasicImageVariants =  _([
    { vid: "center", label: "Center"  },
    { vid: "left", label: "Left"  },
    { vid: "right", label: "Right"  }
]);

var ImageStylesView = Backbone.View.extend({
    tpl: _.template($(tpls).find('#image-style-tpl').html()),
    initialize: function( options ){
        this.data = new Backbone.Model();
        this.listenTo(this.data, 'change', this.render);
        this.data.set("variants", BasicImageVariants.toArray() );
        this.data.set( "selected", options.get('variant_id') ? options.get('variant_id') : "center" );

    },
    events: {
        'change input[type=radio]': 'update_data',
        'click input[type=radio]': 'on_click'
    },
    render: function(){
        this.$el.html(this.tpl( { data: this.data.toJSON() } ));
        return this;
    },
    on_click: function(e){
        e.stopPropagation();
    },
    update_data: function(e){
        e.stopPropagation();
        this.variant_id = $(e.target).val();
        this._style = BasicImageVariants.findWhere({vid : this.variant_id});
    }
});

var LinkView = Backbone.View.extend({
    tpl: _.template($(tpls).find('#image-link-tpl').html()),
    initialize: function(opts){
        if(opts.data){
            this.model = new Backbone.Model(opts.data);
            this.listenTo(this.model, 'change', this.render);
        }
    },
    events: {
        'change input[type=radio]': 'updateData'
    },
    render: function(){
        this.$el.width('200px');

        var data = this.model.toJSON();
        data.checked = 'checked="checked"';
        this.$el.html(this.tpl(data));
    },
    updateData: function(e){
        var me = this,
            type = this.$('input:checked').val(),
            url = this.$('#uinsert-image-link-url').val()
            ;
        if(type == 'post'){
            var selectorOptions = {postTypes: this.postTypes()};
            Upfront.Views.Editor.PostSelector.open(selectorOptions).done(function(post){
                me.model.set({linkType: 'post', linkUrl: post.get('permalink')});
            });
        } else {
            this.model.set({linkType: type, linkUrl: url});
        }
    },
    postTypes: function(){
        var types = [];
        _.each(Upfront.data.ugallery.postTypes, function(type){
            if(type.name != 'attachment')
                types.push({name: type.name, label: type.label});
        });
        return types;
    }
});

var PostImageStylesView = Backbone.View.extend({
    initialize: function( options ){
        this.data = new Backbone.Model();
        this.data.set( "variants", Upfront.Content.ImageVariants.toJSON());
        this.data.set( "selected", options.get('variant_id') );
    },
    events: {
        //'change input[type=radio]': 'update_data',
        //'click input[type=radio]': 'on_click'
    },
    prepare_values: function(){
        var self = this,
            values = [];
        _.each(this.data.get("variants"), function(val, index){
            values.push(  { value: val.vid, label: val.label } );
        });
        return values;
    },
    get_default_value: function(){
        return this.data.get("selected");
    },
    render: function(){
        var self = this,
            select = new  Upfront.Views.Editor.Field.Select({
                className: 'upfront-field-wrap upfront-field-wrap-image-style-variant',
                label: l10n.choose_image_insert,
                name: "uf_image_style_variants",
                default_value: this.get_default_value(),
                multiple: false,
                values: this.prepare_values(),
                change: function(variant_id){
                    self._style = Upfront.Content.ImageVariants.findWhere({vid : variant_id});
                    self.data.set( "selected", variant_id );
                }
            });

        select.render();
        this.$el.html( select.$el );
        return this;
    },
    on_click: function(e){
        e.stopPropagation();
    }
});

var WP_PostImageStylesView = Backbone.View.extend({
    className: "upfront-wp-image-style-variants",
    tpl: _.template($(tpls).find('#wp-image-style-tpl').html()),
    events: {
        'click .upfront-icon-wp-image-style': 'update_data'
    },
    get_alignments: function(){
      return [
          { id: "alignleft",  label: l10n.align_left, icon: 'upfront-icon-wp-image-style-alignleft' },
          { id: "aligncenter",  label: l10n.align_center, icon: 'upfront-icon-wp-image-style-aligncenter' },
          { id: "alignright",  label: l10n.align_right, icon: 'upfront-icon-wp-image-style-alignright' },
          { id: "alignnone",  label: l10n.align_none, icon: 'upfront-icon-wp-image-style-alignnone' }
      ];
    },
    initialize: function( model ){
        this.data = new Backbone.Model();
        this.data.set( "variants", this.get_alignments());
        this.listenTo(this.data, 'change', this.render);
        this.data.set( "selected", ( this.model.get('variant_id') || this.model.get('style').wrapper.alignment ) );
    },
    get_default_value: function(){
        return this.data.get("selected");
    },
    render: function(){
        this.$el.html( this.tpl( { data: this.data.toJSON() } ) );
        return this;
    },
    on_click: function(e){
        e.stopPropagation();
    },
    update_data: function(e){
        e.preventDefault();
        var $selected = $(e.target),
            selected = $selected.data("id");

        this.data.set("selected", selected);
        this.model.set("variant_id", selected);
    }
});

return {
    LinkView: LinkView,
    ImageStylesView: ImageStylesView,
    PostImageStylesView: PostImageStylesView,
    WP_PostImageStylesView: WP_PostImageStylesView,
    BasicImageVariants: BasicImageVariants
};

//End Define
});
})(jQuery);

;(function($){
    define('scripts/redactor/ueditor-image-insert-base',[
            "scripts/redactor/ueditor-insert",
            "scripts/redactor/ueditor-inserts",
            'text!scripts/redactor/ueditor-templates.html',
            "scripts/redactor/ueditor-insert-utils"
        ],
        function(Insert, Inserts, tpls, utils){
            var l10n = Upfront.Settings && Upfront.Settings.l10n
                    ? Upfront.Settings.l10n.global.ueditor
                    : Upfront.mainData.l10n.global.ueditor
                ;
            var ImageInsertBase = Insert.UeditorInsert.extend({
                $editor: false,
                caption_active: false,
                className: 'ueditor-insert upfront-inserted_image-wrapper',
                tpl: _.template($(tpls).find('#image-insert-tpl').html()),
                resizable: false,
                defaultData: {
                    insert_type: "image_insert",
                    caption: "<p>Default caption</p>",
                    show_caption: 1,
                    imageFull: {src:'', width:100, height: 100},
                    imageThumb: {src:'', width:100, height: 100},
                    selectedImage: {src:'', width:100, height: 100},
                    linkType: 'do_nothing',
                    linkUrl: '',
                    isLocal: 1,
                    alignment: { vid: "center", label: "Center" },
                    externalImage: {
                        top: 0,
                        left: 0,
                        width: 0,
                        height: 0
                    },
                    variant_id : "",
                    style: {
                        label_id: "",
                        vid: "",
                        caption: {
                            "order": 1,
                            "height": 50,
                            "width_cls": "",
                            "left_cls": "ml0",
                            "top_cls": "mt0",
                            "show": 1
                        },
                        group: {
                            "float": "none",
                            "width_cls": "",
                            "left_cls": "ml0",
                            "height": 0,
                            "marginRight": 0,
                            "marginLeft": 0
                        },
                        image: {
                            "width_cls": "",
                            "left_cls": "ml0",
                            "top_cls": "mt0",
                            "src": "",
                            "height": 0
                        }
                    }
                },
                wp_defaults: {
                    insert_type: "wp_default",
                    attachment_id: "",
                    caption: "<p>Default caption</p>",
                    link_url: "",
                    image: {
                        src: "",
                        url: "",
                        width: 0,
                        height: 0
                    },
                    style:{
                        wrapper: {
                            alignment: "alignnone",
                            width: "310"
                        },
                        caption: {
                            show: true
                        },
                        image: {
                            size_class: "size-medium"
                        }
                    }
                },
                events:{
                    "click .ueditor-insert-remove": "click_remove",
                    "dragstart img": "on_image_dragstart"
                },
                /**
                 * Checks if current insert is post image insert
                 * @returns {boolean}
                 */
                is_post_image_insert: function(){
                    return !this.is_image_insert();
                },
                /**
                 * Checks if current insert is simple image insert
                 */
                is_image_insert: function(){
                    return this.$editor.find(".plain-text-container").length;
                },
                /**
                 * Returns type of current image insert
                 * @returns {*}
                 */
                get_type: function(){
                    if( this.$editor && this.$editor.data("ueditor") )
                        return  _.contains( this.$editor.data("ueditor").options.inserts, "image" ) ? Inserts.NAMES.IMAGE : Inserts.NAMES.POSTIMAGE;
                    else
                        return false;
                },
                get_caption_state: function(){
                    if( this.data.get("show_caption")){
                        return 0
                    }else{
                        return 1;
                    }
                },
                click_remove: function( e ){
                    e.preventDefault();
                    this.trigger('remove', this);
                },
                /**
                 * Returns POJO of main model
                 *
                 * @returns {*}
                 */
                get_data_json: function(){
                    return ( typeof this.prepare_data == "function" ? this.prepare_data() : this.data.toJSON() );
                },
                make_caption_editable: function(){
                    var self = this,
                        data = this.data.get("style"),
                        $caption = this.$('.wp-caption-text')
                        ;

                    if (!data) return false;
                    if( !data.caption || !this.data.get("show_caption") || this.$('.wp-caption-text').length === 0) return;


                    //.attr('contenteditable', true)
                    $caption.off('keyup')
                        .on('keyup', function(e){
                            self.data.set('caption', this.innerHTML, {silent: true});
                            //Update event makes InsertManager update its data without rendering.
                            self.data.trigger('update');
                            if( self.render_shortcode )
                                self.render_shortcode( self.get_data_json() );

                        })
                        .ueditor({
                            linebreaks: false,
                            autostart: true,
                            pastePlainText: true,
                            buttons: [],
                            placeholder: self.defaultData.caption,
                            inserts:[],
                            focus: false,
                            paragraphize: false
                        })
                        .attr('contenteditable', false)
                    ;

                    this.caption_ueditor = $caption.data('ueditor');



                    /**
                     * Saves redactor air changes to the caption model
                     */
                    this.caption_ueditor.redactor.events.on("ueditor:change", function(e){
                        self.data.set('caption', self.caption_ueditor.$el.html(), {silent: true});
                        self.data.trigger('update');
                    });

                    this.caption_ueditor.redactor.events.on('ueditor:focus', function(redactor){
                        if( redactor != self.caption_ueditor.redactor || self.caption_active === true)
                            return;


                        var $parent = self.$el.closest('.redactor-editor'),
                            parentUeditor = $parent.data('ueditor'),
                            parentRedactor = parentUeditor ? parentUeditor.redactor : false
                            ;


                        if(!parentRedactor)
                            return;

                        if( redactor.$element.is( $caption ) ){
                            $parent.attr("contenteditable", false);
                            $caption.attr("contenteditable", true);
                            self.caption_active = true;
                        }else{
                            $parent.attr("contenteditable", true);
                            $caption.attr("contenteditable", false);
                            self.caption_active = false;
                        }


                        parentRedactor.$editor.off('drop.redactor paste.redactor keydown.redactor keyup.redactor focus.redactor blur.redactor');
                        parentRedactor.$textarea.on('keydown.redactor-textarea');

                    });

                    this.caption_ueditor.redactor.events.on('ueditor:blur', function(redactor){
                        if( redactor != self.caption_ueditor.redactor ||  self.caption_active === false)
                            return;

                        var $parent = self.$el.closest('.redactor-editor'),
                            parentUeditor = $parent.data('ueditor'),
                            parentRedactor = parentUeditor ? parentUeditor.redactor : false
                            ;


                        if(!parentRedactor)
                            return;


                        if( redactor.$element.is( $caption ) ){
                            $parent.attr("contenteditable", true);
                            $caption.attr("contenteditable", false);
                            self.caption_active = false;
                        }else{
                            $parent.attr("contenteditable", false);
                            $caption.attr("contenteditable", true);
                            self.caption_active = true;
                        }

                        parentRedactor.build.setEvents();
                        //parentRedactor.buildBindKeyboard();

                        //var parentUeditor = me.$el.closest('.ueditable').data('ueditor');

                    });

                    /**
                     * Manage editability on image insert el events
                     */
                    self.$el.on("hover, click", function(e){
                        e.stopPropagation();
                        var $ed = self.$editor.is(".redactor-editor") ? self.$editor :self.$editor.find('.upfront-object-content'); // select the correct editor
                        $caption.attr("contenteditable", true);
                        $ed.attr("contenteditable", false);
                        self.caption_active = true;
                    });


                    /**
                     * Manage editability on $editor events
                     */
                    this.$editor.on("mouseenter, click", function(e){
                        var $ed = $(this).is(".redactor-editor") ? $(this) :$(this).find('.upfront-object-content'); // select the correct editor
                        $caption.attr("contenteditable", false);
                        $ed.attr("contenteditable", true);
                        self.caption_active = false;
                    });


                },
                //this function is called automatically by UEditorInsert whenever the controls are created or refreshed
                controlEvents: function(){
                    var me = this;
                    this.stopListening(this.controls);

                    this.listenTo(this.controls, 'control:ok:link', function(view, control){
                        var url = view.$('input[type=text]').val(),
                            type = view.$('input[type=radio]:checked').val() || 'do_nothing',
                            linkData = {}
                            ;
                        if ("external" === type && !(url.match(/https?:\/\//) || url.match(/\/\/:/))) {
                            // ... check if we want an external URL
                            url = url.match(/^www\./) || url.match(/\./)
                                ? 'http://' + url
                                : url
                            ;
                        }
                        linkData = {
                            linkType: type,
                            linkUrl: url
                        };

                        this.data.set(linkData);
                        view.model.set(linkData);
                        control.close();
                    });

                    /**
                     * Toggle Caption
                     */
                    this.listenTo(this.controls, 'control:click:toggle_caption', function(control){
                        var new_state = 1;
                        if( this.data.get("show_caption") )
                            new_state = 0;

                        this.data.set("show_caption", new_state);

                    });

                    this.listenTo(this.controls, 'control:click:change_image', this.change_image);

                    if( typeof this.control_events === "function")
                        this.control_events();
                },

                updateControlsPosition: function(){
                    //var width = Upfront.Util.grid.col_to_width( this.data.get('style').group.width_cls ),
                    //    controls = this.controls.$el,
                    //    margin = 0
                    //    ;
                    //
                    //margin =   ( width - controls.width()  )  / 2;
                    //
                    //controls.css('margin-left', margin + 'px');
                    this.controls.$el.css({
                        left: 15,
                        top:15
                    });
                },

                getSimpleOutput: function () {
                    var out = this.el.cloneNode(true),
                        data = this.data.toJSON()
                        ;

                    data.image = this.get_proper_image();

                    this.data.set('width', this.$el.width(), {silent: true});
                    this.data.trigger('update');

                    data.isLocal = parseInt(data.isLocal, 10);

                    out.innerHTML = this.tpl(data);
                    $(out).width(this.data.get('width'));
                    // return the HTML in a string
                    return  $('<div>').html(out).html();
                },
                get_proper_image: function(){
                    var data = this.data.toJSON(),
                        image = data.imageFull,
                        grid = Upfront.Settings.LayoutEditor.Grid
                        ;


                    data.style = data.style || {
                        image_col: 0,
                        group: '',
                        image: '',
                        caption: ''
                    };

                    if( data.imageThumb ){
                        if( data.style && data.style.image && data.style.image.col && (data.style.image.col * grid.column_width) <= data.imageThumb.width ){
                            image = data.imageThumb;
                        }
                    }

                    return image;
                },
                getOutput: function(){
                    var out = this.el.cloneNode(),
                        data = this.data.toJSON()
                        ;


                    data.image = this.get_proper_image();
                    if (!data.image) return false;

                    this.data.set('width', this.$el.width(), {silent: true});
                    this.data.trigger('update');

                    data.isLocal = parseInt(data.isLocal, 10);

                    out.innerHTML = this.tpl(data);
                    //$(out).width(this.data.get('width'));
                    // return the HTML in a string
                    return  $('<div>').html(out).html();
                },

                //Extract the needed data from the media library result
                getImageData: function(libraryResult){
                    if(!libraryResult)
                        return false;

                    var imagePost = libraryResult.at(0).toJSON(),
                        image = this.getSelectedImage(imagePost),
                        imageData = this.is_wp ?  _.extend( {}, this.wp_defaults, {
                            attachment_id: imagePost.ID,
                            caption: imagePost.post_excerpt ?  imagePost.post_excerpt : "" ,
                            link_url: "",
                            image: image,
                            style: {
                                caption:{
                                    show: true
                                },
                                wrapper: {
                                    alignment: "alignnone",
                                    width: image.width
                                },
                                image: {
                                    size_class: 'size-' + image.selected_size
                                }
                            }
                        }) : _.extend({}, this.defaultData, {
                            attachmentId: imagePost.ID,
                            title: imagePost.post_tite,
                            imageFull: imagePost.image,
                            imageThumb: this.getThumb(imagePost.additional_sizes),
                            selectedImage: _.isUndefined( imagePost.selected_size ) ? imagePost.image : _.filter(imagePost.additional_sizes, function( size ){
                                var dimensions = imagePost.selected_size.toLowerCase().split("x"),
                                    width = dimensions[0],
                                    height = dimensions[1];
                                return size.width == width && size.height == height;
                            })[0],
                            linkType: 'do_nothing',
                            linkUrl: '',
                            align: 'center'
                        })
                        ;
                    return imageData;
                },

                getThumb: function(images){
                    var selected = {width: 0};
                    _.each(images, function(img){
                        if(img.width <= 500 && img.width > selected.width)
                            selected = img;
                    });
                    return selected;
                },

                //Get the image with the selected size
                getSelectedImage: function(imagePost){
                    // set default _selected_size
                    imagePost.image.selected_size = 'full';

                    if(imagePost.selected_size == 'full')
                        return imagePost.image;


                    var dimensions = imagePost.selected_size
                            ? imagePost.selected_size.split('x')
                            : [],
                        size_names = ["thumbnail", "medium", "large"]
                        ;
                    if(dimensions.length != 2)
                        return imagePost.image;

                    for(var i = 0; i < imagePost.additional_sizes.length; i++){
                        var size = imagePost.additional_sizes[i];
                        size.selected_size = size_names[i];
                        if(size.width == dimensions[0] && size.height == dimensions[1])
                            return size;
                    }
                    return imagePost.image;
                },

                // Parse the content of the post looking for image insert elements.
                // conentElement: jQuery object representing the post content.
                // insertsData: Insert data stored by the editor.
                importInserts: function(contentElement, insertsData, inserts){
                    var me = this,
                        _inserts = {},
                        inserts_from_shortcode = {}// inserts created from caption shortcode
                        remaining_images = contentElement.find('img');
                        ;

                    if( !contentElement.is(".wp-caption-text") ) this.$editor = contentElement;

                    if( me.importFromShortcode && this.is_post_image_insert() ){
                        inserts_from_shortcode = me.importFromShortcode(contentElement, insertsData, inserts);
                    }

                    if( this.is_post_image_insert() ){
                        remaining_images =  contentElement.find('img').filter( function() {
                            return !$(this).closest(".ueditor-insert").length;
                        } );
                    }

                    _.each(remaining_images, function( img ){
                        var insert = false;

                        insert = me.importFromImage(img);

                        if( insert )
                            _inserts[insert.data.id] = insert;
                    });

                    return _.extend(_inserts, inserts_from_shortcode);
                },

                //Import from image insert wrapper
                importFromWrapper: function(wrapper, insertsData, inserts){
                    var id = wrapper.attr('id'),
                        insert = false,
                        align = false,
                        caption = false,
                        child_class = ImageInsert
                        ;

                    if( _.contains(inserts, "postImage") ){
                        child_class = PostImageInsert;
                    }
                    if(insertsData[id]) {
                        insert = new child_class({data: insertsData[id]});
                    } else {
                        insert = this.importFromImage(wrapper.find('img'));
                    }
                    insert.render();
                    wrapper.replaceWith(insert.$el);
                    return insert;
                },

                getLinkView: function(){
                    if(this.linkView)
                        return this.linkView;

                    var view = new utils.LinkView({data: {linkType: this.data.get('linkType'), linkUrl: this.data.get('linkUrl')}});
                    this.linkView = view;

                    //view.on()
                    return view;
                },

                getStyleView: function(){
                    if(this.styleView)
                        return this.styleView;
                    var view = new utils.PostImageStylesView( this.data );
                    this.styleView = view;
                    return view;
                },

                calculateRealSize: function(src){
                    var img = new Image();
                    img.src = src;

                    return {width: img.width, height: img.height};
                },

                generateThumbSrc: function(width, height) {
                    var src = this.data.get('imageFull').src,
                        parts = src.split('.'),
                        extension = parts.pop()
                        ;

                    src = parts.join('.') + '-' + width + 'x' + height + '.' + extension;
                    return src;
                },

                calculateImageResize: function(wrapperSize, imageSize){
                    var pivot = imageSize.width / imageSize.height > wrapperSize.width / wrapperSize.height ? 'height' : 'width',
                        factor = imageSize[pivot] / wrapperSize[pivot],
                        imageData = {
                            width: Math.round(imageSize.width / factor),
                            height: Math.round(imageSize.height / factor)
                        },
                        widthPivot = pivot == 'width'
                        ;

                    imageData.top = widthPivot ? -Math.round((imageData.height - wrapperSize.height) / 2) : 0;
                    imageData.left = widthPivot ? 0 : -Math.round((imageData.width - wrapperSize.width) / 2);

                    return imageData;
                },
                render_shortcode: function(data){
                    if( this.caption_ueditor && !this.caption_ueditor.options.inserts.length ) return; // if "inserts" array is empty or not defined there is no need to render shortcode!
                    data = data instanceof Backbone.Model ? data.toJSON() : data;

                    var html = this.shortcode_tpl(data);

                    //cleanup new lines and unneeded whitespace
                    html = html.replace( /\[caption[\s\S]+?\[\/caption\]/g, function( a ) {
                        return a.replace( /<br([^>]*)>/g, '<wp-temp-br$1>' ).replace( /[\r\n\t]+/, '' );
                    });

                    html = html.replace( /\s*<div/g, '\n<div' );
                    html = html.replace( /<\/div>\s*/g, '</div>\n' );
                    html = html.replace( /\s*\[caption([^\[]+)\[\/caption\]\s*/gi, '\n\n[caption$1[/caption]\n\n' );
                    html = html.replace( /caption\]\n\n+\[caption/g, 'caption]\n\n[caption' );
                    html = html.replace(/\s+/g," ");
                    this.$shortcode_el.html( html );
                },
                on_image_dragstart: function(e){
                    // disable dragging image
                    e.preventDefault();
                },
                change_image: function(){
                    var self = this;
                    Upfront.Media.Manager.open({
                        multiple_selection: false,
                        insert_options: false,
                        button_text: l10n.change_image,
                        hide_sizes: this.data.get("insert_type") === "image_insert"
                    }).done(function (popup, result) {
                        if(_.isEmpty(  result ) ) return;
                        self.start( result );
                    });
                    return false;
                }
            });


            return {
                ImageInsertBase: ImageInsertBase
            };

//End Define
        });
})(jQuery);

;(function($){
define('scripts/redactor/ueditor-image-insert',[
        "scripts/redactor/ueditor-insert",
        "scripts/redactor/ueditor-insert-utils",
        "scripts/redactor/ueditor-image-insert-base",
        'text!scripts/redactor/ueditor-templates.html'
    ],
    function(Insert, utils, base, tpls){


var ImageInsert = base.ImageInsertBase.extend({
    className: 'ueditor-insert upfront-inserted_image-wrapper upfront-inserted_image-basic-wrapper',
    //Called just after initialize
    create_controlls: function(group_width_cls){
        this.controlsData = [
            {id: 'link', type: 'dialog', icon: 'link', tooltip: 'Link image', view: this.getLinkView()},
            {id: 'toggle_caption', type: 'simple', icon: 'caption', tooltip: 'Toggle Caption', active: _.bind( this.get_caption_state, this ) }
        ];

        if( this.allow_alignment( group_width_cls ) )
            this.controlsData.unshift( {id: 'style', type: 'dialog', icon: 'style', tooltip: 'Alignment', view: this.getStyleView()} );

        this.createControls();
    },
    // The user want a new insert. Fetch all the required data to create a new image insert
    start: function( $el ){

        var me = this,
            promise = Upfront.Media.Manager.open({multiple_selection: false })
            ;

        promise.done(function(popup, result){
            var imageData = me.getImageData(result);
            imageData.id = me.data.id;
            me.data.clear({silent: true});
            imageData.style =  me.defaultData.style;
            imageData.variant_id = "basic-image";
            me.$editor = $el.closest(".redactor-box");
            me.data.set(imageData);
        });

        return promise;
    },
    // Insert editor UI
    render: function(){
        var data = _.extend( {}, this.defaultData, this.data.toJSON() ),
            style_variant = data.style,
            alignment = this.data.get("alignment") ;

        if( !style_variant ) return;
        //data.style = style_variant && style_variant.toJSON ? style_variant.toJSON() : {}; // Force this to be POJ object
        data.style.label_id = "ueditor-image-style-center";
        if(  alignment  ){
            data.style.label_id = "ueditor-image-style-" + alignment.vid;
            data.style.group.float = alignment.vid;
        }

        data.image = this.get_proper_image();



        data.style.group.width_cls = this.get_group_width_cls( data.image );


        if( data.show_caption == 0 ){
            data.style.image.width_cls = Upfront.Settings.LayoutEditor.Grid.class + 24;
        }
        var $group = this.$el.find(".ueditor-insert-variant-group"),
            ge = Upfront.Behaviors.GridEditor,
            $parent = $('.upfront-content-marker-contents'),
            padding_left = parseFloat( $(".upfront-content-marker-contents>*").css("padding-left")) / ge.col_size ,
            padding_right = parseFloat( $(".upfront-content-marker-contents>*").css("padding-right")) / ge.col_size,
            parent_col = Upfront.Util.grid.width_to_col( $parent.width(), true ) ,
            max_col =   parent_col  - padding_left - padding_right,
            col_size = $(".upfront-content-marker-contents>*").width()/max_col
            ;


        padding_left = padding_left ? parseInt(padding_left) : 0;
        padding_right = padding_right ? parseInt(padding_right) : 0;

        if (style_variant && style_variant.group && style_variant.group.float) {
            if ( style_variant.group.float == 'left' && padding_left > 0 ){
                data.style.group.marginLeft = ( padding_left - Math.abs(style_variant.group.margin_left) ) * col_size;
                data.style.group.marginRight = 0;
            }
            else if ( style_variant.group.float == 'right' && padding_right > 0 ){
                data.style.group.marginRight = ( padding_right - Math.abs(style_variant.group.margin_right) ) * col_size;
                data.style.group.marginLeft = 0;
            }
            else if ( style_variant.group.float == 'none' && padding_left > 0 ){
                data.style.group.marginLeft = ( padding_left - Math.abs(style_variant.group.margin_left) + Math.abs(style_variant.group.left) ) * col_size;
                data.style.group.marginRight = 0;
            }
        }

        this.$el
            .html(this.tpl(data))
        ;
        this.create_controlls( data.style.group.width_cls );

        this.controls.render();
        this.$(".ueditor-insert-variant-group").append(this.controls.$el);
        this.make_caption_editable();
        this.updateControlsPosition();
        this.$(".ueditor-insert-variant-group").append('<a href="#" contenteditable="false" class="upfront-icon-button upfront-icon-button-delete ueditor-insert-remove"></a>');

    },

    allow_alignment: function( group_width_cls ){
        if( typeof group_width_cls === "undefined" ) return false;

        var group_width_col = parseInt(group_width_cls.replace("c", ""), 10),
            editor_col = Upfront.Util.grid.width_to_col( this.$editor.width() ) ;

        return ( group_width_col + 2 ) <= editor_col;
    },
    //this function is called automatically by UEditorInsert whenever the controls are created or refreshed
    control_events: function(){
        var me = this;

        /**
         * Image style from variants
         */
        this.listenTo(this.controls, 'control:ok:style', function(view, control){
            if( view._style ){
                this.data.set("variant_id", view.variant_id );
                this.data.set("alignment", view._style );

                view.data.set( "selected", view.variant_id   );
            }
            control.close();
        });

    },
    get_group_width_cls: function( image ){
        var image_col = Upfront.Util.grid.width_to_col( image.width),
            editor_col = Upfront.Util.grid.width_to_col( this.$editor.width() ) ;

        if( ( image_col + 1 ) <= editor_col ){
            return Upfront.Settings.LayoutEditor.Grid.class + image_col;
        }else{
            return Upfront.Settings.LayoutEditor.Grid.class + editor_col;
        }
    },
    get_proper_image: function(){
        var data = this.data.toJSON(),
            image = data.imageFull,
            grid = Upfront.Settings.LayoutEditor.Grid,
            editor_col = Upfront.Util.grid.width_to_col( this.$editor.width() )
            ;

        if( !_.isEmpty( data.selectedImage.src  ) ) return  data.selectedImage;

        return image;
    },
    //Import from any image tag
    importFromImage: function(image){
        //var imageData = Upfront.Util.clone(this.defaultData),
        image = image instanceof jQuery ? image : $(image);
        var imageData = _.extend({}, this.defaultData),
            imageSpecs = {
                src: image.attr('src'),
                width: image.width(),
                height: image.height()
            },
            link = $('<a>').attr('href', imageSpecs.src)[0],
            realSize = this.calculateRealSize(imageSpecs.src),
            $group = image.closest(".ueditor-insert-variant-group"),
            group_classes = $group.attr("class"),
            $caption = $group.find(".wp-caption-text"),
            caption_classes = $caption.attr("class"),
            $image_wrapper = $group.find(".uinsert-image-wrapper"),
            image_wrapper_classes = $image_wrapper.attr("class"),
            caption_order = 1
            ;

        if(link.origin != window.location.origin)
            imageData.isLocal = 0;


        imageData.imageThumb = imageSpecs;
        imageData.imageFull = {
            width: realSize.width,
            height: realSize.height,
            src: imageSpecs.src
        };


        var parent = image.parent();

        if(parent.is('a')){
            imageData.linkUrl = parent.attr('href') ;
            imageData.linkType = 'external';
        }

        var attachmentId = image.attr('class');
        if(!attachmentId)
            imageData.attachmentId = false;
        else {
            attachmentId = attachmentId.match(/wp-image-(\d+)/);
            if(attachmentId)
                imageData.attachmentId = attachmentId[1];
            else
                imageData.attachmentId = false;
        }

        imageData.title = image.attr('title');
        if( !_.isEmpty( $caption.text() ) ){
            imageData.caption =  $caption.html();
        }
        


        caption_order = $caption.prev( $image_wrapper).length ? 1 : 0;
        imageData.show_caption = $caption.length;
        if(  $group.length ){
            imageData.style = {
                caption: {
                    "order": 1,
                    "height": $caption.css("minHeight") ? $caption.css("minHeight").replace("px", "") : $caption.height(),
                    "width_cls": Upfront.Util.grid.derive_column_class( caption_classes ),
                    "left_cls": Upfront.Util.grid.derive_marginleft_class( caption_classes ),
                    "top_cls": Upfront.Util.grid.derive_margintop_class( caption_classes ),
                    "show": $caption.length
                },
                group: {
                    "float": $group.css("float"),
                    "width_cls": Upfront.Util.grid.derive_column_class( group_classes ),
                    "left_cls": Upfront.Util.grid.derive_marginleft_class( group_classes ),
                    "height": $group && $group.css("minHeight") ? $group.css("minHeight").replace("px", "") : imageSpecs.height + $caption.height(),
                    "marginRight": 0,
                    "marginLeft": 0
                },
                image: {
                    "width_cls": Upfront.Util.grid.derive_column_class( image_wrapper_classes ),
                    "left_cls": Upfront.Util.grid.derive_marginleft_class( image_wrapper_classes ),
                    "top_cls": Upfront.Util.grid.derive_margintop_class( image_wrapper_classes ),
                    "src": "",
                    "height": 0
                }
            };
            imageData.variant_id = $group.data("variant");
            if( imageData.variant_id  ){
                imageData.alignment = utils.BasicImageVariants.findWhere( { "vid": $group.data("variant") } );
            }
        }else{
            imageData.alignment = utils.BasicImageVariants.first();
            imageData.variant_id = imageData.alignment.vid;
        }


        var insert = new ImageInsert({data: imageData});


        insert.render();
        var replacee = image.hasClass(".upfront-inserted_image-basic-wrapper") ? image : image.closest(".upfront-inserted_image-basic-wrapper");
        replacee.replaceWith( insert.$el );
        return insert;
    },
    getStyleView: function(){
        if(this.styleView)
            return this.styleView;
        var view = new utils.ImageStylesView( this.data );
        this.styleView = view;
        return view;

    }
});

return {
    ImageInsert: ImageInsert
};

//End Define
});
})(jQuery);

;(function($){
define('scripts/redactor/ueditor-image-insert-post',[
        "scripts/redactor/ueditor-insert",
        "scripts/redactor/ueditor-image-insert-base",
        'text!scripts/redactor/ueditor-templates.html',
        "scripts/redactor/ueditor-insert-utils"
    ],
function(Insert, base, tpls, utils){
var l10n = Upfront.Settings && Upfront.Settings.l10n
        ? Upfront.Settings.l10n.global.ueditor
        : Upfront.mainData.l10n.global.ueditor
    ;
var PostImageInsert = base.ImageInsertBase.extend({
    className: 'ueditor-insert upfront-inserted_image-wrapper ueditor-insert-variant ueditor-post-image-insert',
    tpl: _.template($(tpls).find('#post-image-insert-tpl').html()),
    shortcode_tpl: _.template($(tpls).find('#post-image-insert-shortcode-tpl').html().replace(/\s+/g," ")),
    //Called just after initialize
    init: function(opts){
        this.$editor = opts.$editor;
        this.controlsData = [
            {id: 'style', type: 'dialog', icon: 'style', tooltip: l10n.style, view: this.getStyleView()},
            {id: 'change_image', type: 'simple', icon: 'change_image', tooltip: l10n.change_image},
            {id: 'link', type: 'dialog', icon: 'link', tooltip: l10n.link_image, view: this.getLinkView()},
            {id: 'toggle_caption', type: 'simple', icon: 'caption', tooltip: l10n.toggle_caption, active: _.bind( this.get_caption_state, this ) }
        ];
        this.createControls();

        if( opts.start )
            return this.start( opts.start );
    },
    start: function( result ){
        var imageData = this.getImageData(result);
        imageData.id = this.data.id;
        imageData.style = this.data.get("style") ||   Upfront.Content.ImageVariants.first().toJSON();
        imageData.variant_id = imageData.style.vid;
        this.data.clear({silent: true});
        this.data.set(imageData, {silent: true});
        this.set_selected_style();
        this.render();
        return this;
    },
    set_selected_style: function(){
        // set selected item in the styles control data
        _.findWhere(this.controlsData, {id : "style"})
            .view.data.set("selected", this.data.get("variant_id") );
    },
    // Insert editor UI
    render: function(){
        var data = this.prepare_data();

        this.$el
            .html(this.tpl(data))
        ;

        this.$shortcode_el = this.$(".post-images-shortcode");

        this.render_shortcode( data );
        this.createControls();
        this.controls.render();

        var $tools_el = this.$(".ueditor-insert-variant-group");

        $tools_el.append(this.controls.$el);
        this.make_caption_editable();
        this.updateControlsPosition();
        $tools_el.append('<a href="#" contenteditable="false" class="upfront-icon-button upfront-icon-button-delete ueditor-insert-remove"></a>');

    },
    prepare_data: function(){
        var data = _.extend( {}, this.defaultData, this.data.toJSON() ),
            style_variant = data.style;

        if( !style_variant ) return;
        //data.style = style_variant && style_variant.toJSON ? style_variant.toJSON() : {}; // Force this to be POJ object

        data.style.label_id = data.style.label && data.style.label.trim() !== "" ? "ueditor-image-style-" +  data.style.label.toLowerCase().trim().replace(" ", "-") : data.style.vid;
        data.image = this.get_proper_image();

        if( data.linkType == "show_larger_image" )
            data.linkUrl = data.image.src;

        if( data.show_caption == 0 ){
            data.style.image.width_cls = Upfront.Settings.LayoutEditor.Grid.class + 24;
        }
        var $group = this.$el.find(".ueditor-insert-variant-group"),
            ge = Upfront.Behaviors.GridEditor,
            $parent = $('.upfront-content-marker-contents'),
            padding_left = parseFloat( $(".upfront-content-marker-contents>*").css("padding-left")) / ge.col_size ,
            padding_right = parseFloat( $(".upfront-content-marker-contents>*").css("padding-right")) / ge.col_size,
            parent_col = Upfront.Util.grid.width_to_col( $parent.width(), true ) ,
            max_col =   parent_col  - padding_left - padding_right,
            col_size = $(".upfront-content-marker-contents>*").width()/max_col
            ;


        padding_left = padding_left ? parseInt(padding_left) : 0;
        padding_right = padding_right ? parseInt(padding_right) : 0;

        if (style_variant && style_variant.group && style_variant.group.float) {
            if ( style_variant.group.float == 'left' && padding_left > 0 ){
                data.style.group.marginLeft = ( padding_left - Math.abs(style_variant.group.margin_left) ) * col_size;
                data.style.group.marginRight = 0;
            }
            else if ( style_variant.group.float == 'right' && padding_right > 0 ){
                data.style.group.marginRight = ( padding_right - Math.abs(style_variant.group.margin_right) ) * col_size;
                data.style.group.marginLeft = 0;
            }
            else if ( style_variant.group.float == 'none' && padding_left > 0 ){
                data.style.group.marginLeft = ( padding_left - Math.abs(style_variant.group.margin_left) + Math.abs(style_variant.group.left) ) * col_size;
                data.style.group.marginRight = 0;
            }
        }
        return data;
    },
    //this function is called automatically by UEditorInsert whenever the controls are created or refreshed
    control_events: function(){
        /**
         * Image style from variants
         */
        this.listenTo(this.controls, 'control:ok:style', function(view, control){
            if( view._style ){
                var style = view._style.toJSON();
                this.data.set("variant_id", style.vid );
                this.data.set("style", style);
                view.data.set( "selected", style.vid   );
            }
            control.close();
        });

    }

});

var WP_PostImageInsert = base.ImageInsertBase.extend({
    className:  'ueditor-insert upfront-inserted_image-wrapper upfront-wp-inserted_image-wrapper',
    tpl : _.template( $(tpls).find('#post-image-insert-wp-tpl').html() ),
    shortcode_tpl : _.template( $(tpls).find('#post-image-insert-shortcode-wp-tpl').html() ),
    generate_new_id: function(){
        return 'wpinsert-' + (++Upfront.data.ueditor.insertCount);
    },
    init: function(opts){
        this.$editor = opts.$editor;


      if( opts.start )
        return this.start( opts.start );
    },
    prepare_controls: function(){
        this.controlsData = [
            {id: 'wp_style', type: 'dialog', icon:  _.bind( this.get_style_icon, this ), tooltip: 'Style', view: this.getStyleView(), hideOkButton: true },
            {id: 'change_image', type: 'simple', icon: 'change_image', tooltip: l10n.change_image},
            {id: 'link', type: 'dialog', icon: 'link', tooltip: 'Link image', view: this.getLinkView()},
            {id: 'toggle_caption', type: 'simple', icon: 'caption', tooltip: 'Toggle Caption', active: _.bind( this.get_caption_state, this ) }
        ];
    },
    start: function( result ){
        var me = this,
            imageData = me.getImageData(result);



        imageData.id = me.data.id;
        imageData.variant_id = me.data.get("variant_id") || "alignnone";
        me.data.clear({silent: true});
        me.data.set(imageData, {silent: true});
        this.prepare_controls();
        this.createControls();
        this.render();
        return this;
    },
    getImageData: function(libraryResult){
        if(!libraryResult)
            return false;

        var imagePost = libraryResult.at(0).toJSON(),
            image = this.getSelectedImage(imagePost),
            imageData = _.extend( {}, this.wp_defaults, {
                attachment_id: imagePost.ID,
                caption: imagePost.post_excerpt ?  imagePost.post_excerpt : "" ,
                link_url: "",
                image: image,
                style: {
                    caption:{
                        show: true
                    },
                    wrapper: {
                        alignment: "alignnone",
                        width: image.width
                    },
                    image: {
                        size_class: 'size-' + image.selected_size
                    }
                }
            });
        return imageData;
    },
    render: function(){
        var data = this.data.toJSON();

        // Set alignment to style
        if( data.variant_id )
            data.style.wrapper.alignment = data.variant_id;

        this.$el
            .html(this.tpl(data))
        ;

        this.$shortcode_el = this.$(".post-images-shortcode-wp");

        this.render_shortcode(data);
        this.prepare_controls();
        this.createControls();
        this.controls.render();


        var $tools_el = this.$(".wp-caption");
        $tools_el.append(this.controls.$el);
        this.make_caption_editable();
        this.updateControlsPosition();
        $tools_el.append('<a href="#" contenteditable="false" class="upfront-icon-button upfront-icon-button-delete ueditor-insert-remove"></a>');

    },
    getStyleView: function(){
        if(this.styleView)
            return this.styleView;
        var view = new utils.WP_PostImageStylesView( {model: this.data} );
        this.styleView = view;
        return view;
    },
    get_caption_state: function(){
        if( this.data.get("style").caption.show ){
            return 0
        }else{
            return 1;
        }
    },
    get_style_icon: function(){
      var icon = "wp-style";

        if( this.data && this.data.get('style') )
            icon += ( " " + this.data.get('style').wrapper.alignment );

        return icon;
    },
    controlEvents: function(){
        /**
         * Toggle Caption
         */
        this.listenTo(this.controls, 'control:click:toggle_caption', function(control){
            var new_state = 1,
                style = Upfront.Util.clone( this.data.toJSON().style ); //  cloning to make it trigger the BB model change event
            if( !this.get_caption_state() )
                new_state = 0;

            style.caption.show = new_state;
            this.data.set("style", style);
        });

        this.listenTo(this.controls, 'control:ok:link', function(view, control){
            var type = view.$('input[type=radio]:checked').val() || 'do_nothing',
                url = type === "do_nothing" ? "" :  view.$('input[type=text]').val(),
                link_url = ""
                ;

            //linkData = {
            //    linkType: type,
            //    linkUrl: url
            //};

            if( type == "show_larger_image" )
                url = this.data.get("image").src;

            this.data.set('link_url', url);
            //view.model.set(linkData);
            control.close();
        });

        this.listenTo(this.controls, 'control:click:change_image', this.change_image);

    },
    get_url_type: function( url, image_src ){
        // Create a url parser
        var type = "",
            parsed = document.createElement('a')
            ;

        parsed.href = url;

        if(parsed.origin != window.location.origin)
            type = 'external';

        if(parsed.origin == window.location.origin && image_src != url )
            type = 'post';

        if(parsed.origin == window.location.origin && image_src == url )
            type = 'show_larger_image';


        return type;
    }

});

return {
    PostImageInsert: PostImageInsert,
    WP_PostImageInsert: WP_PostImageInsert
};

//End Define
});
})(jQuery);

;(function($){
define('scripts/redactor/ueditor-embed-insert',[
        "scripts/redactor/ueditor-insert",
        'text!scripts/redactor/ueditor-templates.html'
    ],
    function(Insert, tpls){
/*
var EmbedInsert = UeditorInsert.extend({
		type: 'embed',
		className: 'ueditor-insert upfront-inserted_embed-wrapper uinsert-drag-handle',
		tpl: _.template($(tpls).find('#embed-insert-tpl').html()),
		defaultData : {
			code : " "
		},
		//Called just after initialize
		init: function(){
				var align = this.getAligmnentControlData(['left', 'center', 'full', 'right']);
			align.selected = this.data.get('align') || 'center',

			this.controlsData = [
				align,
			   {id: 'code', type: 'dialog', icon: 'embed', tooltip: 'Change code', view: this.getFormView()},
			   this.getRemoveControlData()
			];

			//this.createControls();
		},

		// Insert editor UI
		render: function(){
			var data = this.data.toJSON();
			this.$el
				.html(this.tpl(data))
				.removeClass('aligncenter alignleft alignright alignfull')
				.addClass('align' + this.data.get('align'))
			;

			this.controls.render();
			this.$el.append(this.controls.$el);
		},

		//this function is called automatically by UEditorInsert whenever the controls are created or refreshed
		controlEvents: function(){
			this.stopListening(this.controls);
			this.listenTo(this.controls, 'control:click:remove', function(control){
				this.trigger('remove', this);
			});

			this.listenTo(this.controls, 'control:select:alignment', function(control){
				this.data.set('align', control);
			});
			this.listenTo(this.controls, 'control:ok:code', function(view, control){
				var data = {
					code: view.$('textarea').val()
				};
				this.data.set(data);
				control.close();
			});
		},
		start: function(){
			//Dumb start method returning a resolved promise. Override it if async start needed.
			var deferred = $.Deferred();
			deferred.resolve();
			this.onStartActions();
			return deferred.promise();
		},
		onStartActions : function() {
			var self = this;

			//Show the embed form after clicking on embed element
			this.controls.$el.show(function(){
				self.controls.$el.find(".upfront-icon-region-embed").next(".uimage-control-panel").show();
				self.controls.$el.find(".upfront-icon-region-embed").click();
				self.controls.$el.find(".upfront-field-embed_code").focus();
			});
		},
		// Returns output for the element to inserted into the dome
		// @returns html
	getOutput: function(){
		var out = this.el.cloneNode(),
			data = this.data.toJSON()
		;

		out.innerHTML = this.tpl(data);
		// return the HTML in a string
		return  $('<div>').html(out).html();
	},


	// Parse the content of the post looking for embed insert elements.
	importInserts: function(contentElement, insertsData){
		var me = this,
			codes = contentElement.find('.upfront-inserted_embed-wrapper'),
			inserts = {}
			;
		codes.each(function(){
			var $code = $(this),
				insert = false
				;

			if($code.length)
				insert = me.importFromWrapper($(this), insertsData);
			else
				insert = EmbedInsert({data: "Default data"});

			inserts[insert.data.id] = insert;
		});

		return inserts;
	},
	//Import from embed insert wrapper
	importFromWrapper: function(wrapper, insertsData){
		var id = wrapper.attr('id'),
			insert = false,
			align = false
			;
		insert = new EmbedInsert({data: insertsData[id]});
		insert.render();
		wrapper.replaceWith(insert.$el);
		return insert;
	},

	 getFormView: function(){
		 if(this.formView)
			 return this.formView;

		 var view = new EmbedFormView({data: {code: this.data.get('code')}});
		 this.formView = view;

		 view.on();
		 return view;
	 }
});

var EmbedFormView = Backbone.View.extend({
	tpl: _.template($(tpls).find('#embed-insert-form-tpl').html()),
	initialize: function(opts){
		if(opts.data){
			this.model = new Backbone.Model(opts.data);
			this.listenTo(this.model, 'change', this.render);
		}
	},
	events: {
		//'change input[type=radio]': 'updateData'
	},
	render: function(){
		this.$el.width('400px');
		var data = this.model.toJSON();
		this.$el.html(this.tpl(data));
	}
});
*/

var EmbedInsert = Insert.UeditorInsert.extend({
	type: 'embed',
	className: 'ueditor-insert upfront-inserted_embed-wrapper uinsert-drag-handle',

	defaultData: {
		code: ''
	},

	start: function () {
		var me = this,
			manager = new EmbedManager({code: this.data.get("code")}),
			deferred = new $.Deferred()
		;
		manager.on("done", function (embed) {
			me.data.set({code: embed});
			manager.remove();
			deferred.resolve(this, embed);
		});
		manager.on("render", function (main, bar, ok) {
			me.trigger("manager:rendered", manager, main, bar, ok);
		});
		Upfront.Events.on("upfront:element:edit:stop", function () {
			manager.remove();
			deferred.resolve();
		});

		this.get_manager = function () {
			return manager;
		}

		return deferred;
	},

	/**
	 * Gets internal manager object.
	 *
	 * See `start()` method for how this gets monkeypatched
	 *
	 * @return {Object} Internal EmbedManager object
	 */
	get_manager: function () { return {}; }, // Default to passthrough

	render: function () {
		var me = this,
			code = this.data.get("code"),
			$code = $("<div />").append(code)
		;
		this.$el.empty();

		if (!code) return;
		
		$code.append('<div class="upfront-edit_insert">edit</div>');
		this.$el.append(
			$("<div />").append($code).html()
		);

		this.$el
			.off("click", ".upfront-edit_insert")
			.on("click", ".upfront-edit_insert", function (e) {
				e.preventDefault();
				e.stopPropagation();
				me.start();
			})
		;
	},

	getOutput: function () { return this._get_output(); },
	getSimpleOutput: function () { return this._get_output(); },

	_get_output: function () {
		var code = this.data.get("code"),
			$out = $("<div />").append('<div class="upfront-inserted_embed">' + code + '</div>')
		;
		return code ? $out.html() : '';
	},

	importInserts: function(contentElement, insertsData){
		var inserts = {};
		contentElement.find('.upfront-inserted_embed').each(function () {
			var $code = $(this),
				insert = new EmbedInsert({data: {code: $code.html()}})
			;
			inserts[insert.data.id] = insert;
			insert.render();
			$code.replaceWith(insert.$el);
		});
		return inserts;
	}
});

var EmbedManager = Backbone.View.extend({
	className: "upfront-inserts-markup-editor",
	initialize: function (opts) {
		var me = this,
			code = opts && opts.code ? opts.code : ''
		;
		require([
			Upfront.Settings.ace_url
		], function () {
			me.render(code);
		});
	},
	render: function (code) {
		var me = this,
			main = new EmbedViews.Main({code: code}),
			bar = new EmbedViews.Bar(),
			ok = new EmbedViews.OK()
		;
		main.render();
		bar.render();
		ok.render();
		this.$el
			.empty()
			.append(bar.$el)
			.append(ok.$el)
			.append(main.$el)
		;

		$("body").append(this.$el);
		main.boot_editor();
		
		//Set correct width without sidebar
		this.$el.width($(window).width() - $('#sidebar-ui').width() -1);
		bar.on("insert", function (stuff) {
			main.insert(stuff);
		});

		this._main = main;

		ok.on("done", this.done, this);
		this.trigger("render", main, bar, ok);
	},
	done: function () {
		if (!(this._main && this._main.get_value)) return false;
		var value = this._main.get_value();
		this.trigger("done", value);		
	}
});

var EmbedViews = {
	l10n: Upfront.Settings.l10n.markup_embeds,

	OK: Backbone.View.extend({
		className: 'upfront-inserts-markup-apply',
		events: { click: 'propagate_apply' },
		propagate_apply: function (e) {
			e.stopPropagation();
            e.preventDefault();
			this.trigger("done");
		},
		render: function () {
			this.$el.empty().append(
				'<a href="#">' + EmbedViews.l10n.done + '</a>'
			);
		}
	}),

	Bar: Backbone.View.extend({
		className: 'upfront-inserts-markup-bar',
		events: {
			click: 'stop_prop',
			'click .inserts-shortcode': 'request_shortcode',
			'click .inserts-image': 'request_image',
		},
		stop_prop: function (e) { e.stopPropagation(); },
		render: function () {
			this.$el.empty().append(
				'<ul>' +
					'<li><a href="#" class="inserts-shortcode">' + EmbedViews.l10n.insert_shortcode + '</a></li>' +
					'<li><a href="#" class="inserts-image">' + EmbedViews.l10n.insert_image + '</a></li>' +
				'</ul>'
			);
		},
		request_shortcode: function (e) {
			e.stopPropagation();
			e.preventDefault();
			var me = this;
			Upfront.Popup.open(function () {
				var me = this,
					shortcode = new EmbedViews.ShortcodesList()
				;
				shortcode.render();
				shortcode.on("done", function (code) {
					Upfront.Popup.close(code);
				});
				$(this).empty().append(shortcode.$el);
			}, {}, 'embed-shortcode').done(function (pop, code) {
				me.trigger("insert", code);
			});
		},
		request_image: function (e) {
			e.stopPropagation();
			e.preventDefault();
			var me = this;
			Upfront.Media.Manager.open({
				multiple_selection: false,
				media_type: ["images"],
				hold_editor: true
			}).done(function (pop, result) {
				if(!result) return;
				var imageModel = result.models[0],
					url = imageModel.get('image').src
				;
				url = url.replace(document.location.origin, '');
				me.trigger("insert", url);
			});
		}
	}),

	Main: Backbone.View.extend({
		className: 'upfront-embed_editor',
		events: { click: 'stop_prop' },
		code: '',
		initialize: function (opts) {
			if (opts && opts.code) this.code = opts.code;
		},
		stop_prop: function (e) { e.stopPropagation(); },
		render: function () {
			this.$el.empty()
				.append(
					'<div class="upfront-inserts-markup active">' +
						'<div class="upfront-inserts-ace"></div>' +
					'</div>'
				)
				.show()
			;
		},
		boot_editor: function () {
			var $editor_outer = this.$el,
				$editor = $editor_outer.find('.upfront-inserts-ace')
			;
			var html = $editor.html(),
				editor = ace.edit($editor.get(0)),
				syntax = $editor.data('type')
			;
			editor.getSession().setUseWorker(false);
			editor.setTheme("ace/theme/monokai");
			editor.getSession().setMode("ace/mode/html");
			editor.setShowPrintMargin(false);
			editor.getSession().setValue(this.code);

			editor.renderer.scrollBar.width = 5;
			editor.renderer.scroller.style.right = "5px";

			$editor.height($editor_outer.height());
			editor.resize();

			editor.focus();

			this.editor = editor;
		},
		insert: function (stuff) {
			this.editor.insert(stuff);
		},
		get_value: function () {
			return this.editor.getValue();
		}
	}),

	ShortcodesList: Backbone.View.extend({
		events: { click: 'stop_prop' },
		stop_prop: function (e) { e.stopPropagation(); },
		render: function () {
			var me = this;
			this.$el.empty().append(EmbedViews.l10n.waiting);
			Upfront.Util.post({action: "upfront_list_shortcodes"}).done(function (response) {
				me.$el
					.empty()
					.append('<div class="shortcode-types" />')
					.append('<div class="shortcode-list" />')
				;
				me.render_types(response.data);
				me.render_list();
			});
		},
		render_types: function (types) {
			var me = this,
				values = [{label: EmbedViews.l10n.select_area, value: 0}],
				$root = this.$el.find(".shortcode-types")
			;
			_.each(_.keys(types), function (key) {
				values.push({label: key, value: key});
			});
			var selection = new Upfront.Views.Editor.Field.Select({
				label: '',
				name: "shortcode-selection",
				width: '100%',
				values: values,
				multiple: false,
				change: function(){
					var key = this.get_value();
					if (!(key in types)) return false;
					me.render_list(types[key]);
				}
			});
			selection.render();
			$root.empty().append(selection.$el);
		},
		render_list: function (shortcodes) {
			var me = this,
				$root = this.$el.find(".shortcode-list")
			;
			$root.empty();
			if (empty(shortcodes)) return false;
			_.each(shortcodes, function (code) {
				var code = new EmbedViews.Shortcode({code: code});
				code.render();
				code.on("done", function (code) {
					me.trigger("done", code);
				});
				$root.append(code.$el);
			});
		}
	}),

	Shortcode: Backbone.View.extend({
		tagName: 'pre',
		events: { click: 'send_shortcode' },
		initialize: function (opts) {
			this.code = opts.code;
		},
		send_shortcode: function (e) {
			e.stopPropagation();
			e.preventDefault();
			if (!this.code) return false;
			this.trigger("done", '[' + this.code + ']');
		},
		render: function () {
			this.$el.empty().append('<code>[' + this.code + ']</code>');
		}
	})
};

return {
    EmbedInsert: EmbedInsert
};

//End Define
});})(jQuery);

;(function($){
define('scripts/redactor/ueditor-post-image-insert-manager',[
        "scripts/redactor/ueditor-insert",
        "scripts/redactor/ueditor-image-insert-base",
        'text!scripts/redactor/ueditor-templates.html',
        "scripts/redactor/ueditor-image-insert-post"
    ],
function(Insert, base, tpls, post_inserts){

var PostImageInsert     = post_inserts.PostImageInsert,
    WP_PostImageInsert  = post_inserts.WP_PostImageInsert;

    /**
     * Base class for image inserts and serves as image insert manager
     */
var PostImageInsert_Manager = base.ImageInsertBase.extend({

    /**
     * Adds a new image insert using popup
     *
     * @param InsertManagerInserts $manager_el jquery object
     * @param Ueditor $editor content el jquery object
     * @returns {*}
     */
    start: function($manager_el, $editor){
        var me = this,
            promise = Upfront.Media.Manager.open({multiple_selection: false, insert_options: true}),
            deferred = $.Deferred()
            ;

        promise.done(function(popup, result){
            if(_.isEmpty(  result ) ) return;
            var is_wp = result.at(0).get("insert_option") === "wp_default";
            if( is_wp ) {
                var insert = new WP_PostImageInsert({start: result, $editor: $editor});
                deferred.resolve(insert);
            }else{
                var insert = new PostImageInsert({start: result, $editor: $editor});
                deferred.resolve(insert);

            }
        });

        return $.when( promise, deferred.promise() );
    },
    /**
     * Imports images using caption shortcode
     *
     * @param $contentEl
     * @param insertsData
     * @param inserts
     * @returns {*}
     */
    importFromShortcode: function($contentEl, insertsData, inserts){
        var self = this,
            insert,
            inserts = {};
        // set editor
        this.$editor = $contentEl;

        //lookup caption shortcodes and start parsing them
        var content = wp.shortcode.replace("caption", $contentEl.html(), function( shortcode_data ){

            shortcode_data.parse_content = $.parseHTML( shortcode_data.content );

            if( shortcode_data.get("id").indexOf("uinsert-") !== -1 ){ // if it's a UF caption shortcode
                insert =  self.importFromShortcode_UF( shortcode_data );
            }else{ // it's a wp caption shortcode
                insert = self.importFromShortcode_WP( shortcode_data );
            }

            // add this insert to the pull of inserts
            inserts[insert.data.id] = insert;

            // return insert el's outerHtml to replace the shortcode
            return insert.el.outerHTML;
        });

        $contentEl.html( content );
        return inserts;
    },

    /**
     * Imports from captions shortcode with uf specific id
     *
     * @param shortcode_data
     * @returns {post_inserts.PostImageInsert}
     */
    importFromShortcode_UF: function( shortcode_data ){
        var imageData = _.extend({}, this.defaultData ),
            realSize = this.calculateRealSize( imageData.imageThumb.src )
            ;

        imageData.imageThumb.src = this.get_shortcode_image_src( shortcode_data.content );
        imageData.caption = this.get_shortcode_caption_text( shortcode_data.parse_content );

        imageData = this.populate_link(shortcode_data.content, imageData);

        imageData.imageFull = {
            width: realSize.width,
            height: realSize.height,
            src: imageData.imageThumb.src
        };

        imageData.style = Upfront.Content.ImageVariants.findWhere({ 'vid': shortcode_data.get("uf_variant") }).toJSON();

        imageData.style.caption.show =  shortcode_data.get("uf_show_caption");


        imageData.variant_id = imageData.style.vid;
        var insert = new PostImageInsert({data: imageData, $editor: this.$editor});

        insert.render();
        return insert;

    },

    /**
     * Imports from wp caption short code
     * @param shortcode_data
     * @returns {post_inserts.WP_PostImageInsert}
     */
    importFromShortcode_WP: function( shortcode_data ){
        var data = _.extend( {}, this.wp_defaults, {
            attachment_id: shortcode_data.get("id").replace("attachment_", ""),
            caption:  this.get_shortcode_caption_text( $.parseHTML( shortcode_data.content ) ),
            link_url: this.get_shortcode_url( shortcode_data.content ),
            image: {
                height: this.get_shortcode_content_image_height( shortcode_data.content ),
                width:  shortcode_data.get("width"),
                src: this.get_shortcode_image_src( shortcode_data.content )
            },
            style: {
                caption:{
                    show: parseInt( shortcode_data.get("show_caption"), 10 )
                },
                wrapper: {
                    alignment: shortcode_data.get("align"),
                    width: parseInt( shortcode_data.get("width"), 10 )
                },
                image: {
                    size_class: this.get_shortcode_content_image_size_class( shortcode_data.content )
                }
            }
        } );

        var insert = new WP_PostImageInsert({data: data, $editor: this.$editor });

        insert.render();
        return insert;
    },
    /**
     * Extracts image src from shorcdode's content
     *
     * @param  html content
     * @returns string|bool image src value
     */
    get_shortcode_image_src: function( content ){
        return $("<div>").html(content).find("img").attr("src");
    },

    /**
     * Extracts shortcode caption text from jquery parsed html
     *
     * @param parsed_content jquery parsed html
     * @returns {string}
     */
    get_shortcode_caption_text: function( parsed_content ){
        var html = "";
        _.each(parsed_content, function( el, i ){
            if( el.innerHtml )
                html += el.innerHtml;

            if( el.textContent )
                html += el.textContent;
        });

        return html;
    },

    get_shortcode_content_image_size_class: function( content ){
        var regex = /(?:^|\W)size-(\w+)(?!\w)/g,
            $img = $("<div>").html(content).find("img"),
            reg_result = $img.length ? $img.attr("class").match( regex ) : false;
        return reg_result ? reg_result[0] : "";
    },

    get_shortcode_content_image_height: function( content ){
        var $img = $("<div>").html(content).find("img");
        return ($img.length ? $img.attr("height") : "") || "auto";
    },
    /**
     * Populates proper data regarding linking of the image
     *
     * @param content
     * @param imageData
     * @returns {*}
     */
    populate_link: function( content, imageData ){
        imageData.linkUrl = this.get_shortcode_url( content );

        if( !imageData.linkUrl ) return imageData; // if there is no href then there is no link

        // Create a url parser
        var parsed = document.createElement('a');
        parsed.href = imageData.linkUrl;

        if(parsed.origin != window.location.origin)
            imageData.linkType = 'external';

        if(parsed.origin == window.location.origin && imageData.imageThumb.src != imageData.linkUrl )
            imageData.linkType = 'post';

        if(parsed.origin == window.location.origin && imageData.imageThumb.src == imageData.linkUrl )
            imageData.linkType = 'show_larger_image';

        return imageData;
    },
    /**
     * Extracts anchor's href attribute
     * @param content
     * @returns {*}
     */
    get_shortcode_url: function( content ){
        return $("<div>").html(content).find("a").attr("href");
    },
    /**
     * Returns image size class by parsing img tag classes
     *
      * @param img
     * @returns {*}
     */
    get_image_size_class: function( img ){
        var regex = /(?:^|\W)size-(\w+)(?!\w)/g,
            reg_result = img.className ? img.className.match( regex ) : false;
        return reg_result ? reg_result[0] : "";
    },
    /**
     * Returns image attachment id by parsing img tag classes
     * @param img
     * @returns {*}
     */
    get_image_attachment_id: function( img ){
        var regex = /(?:^|\W)wp-image-(\w+)(?!\w)/g,
            reg_result = img.className ? img.className.match( regex ) : false;
        return reg_result ? reg_result[0] : "";
    },
    importFromImage: function( img ){
        var $img = $(img),
             data = _.extend( {}, this.wp_defaults, {
            attachment_id: this.get_image_attachment_id( img ),
            caption: $.trim( "" ||  $img.attr("alt") ),
            link_url: img.src,
            image: {
                height: parseInt( $img.height(), 10 ),
                width:   parseInt( $img.width(), 10 ),
                src:  img.src
            },
            style: {
                caption:{
                    show: false
                },
                wrapper: {
                    alignment: "alignnone",
                    width: parseInt( $img.width(), 10 )
                },
                image: {
                    size_class: this.get_image_size_class( img )
                }
            }
        } );

        var insert = new WP_PostImageInsert({data: data, $editor: this.$editor });

        insert.render();
        $img.replaceWith( insert.$el );
        return insert;
    },
    //Import from any image tag
    importFromImage_prev: function(image){
        //var imageData = Upfront.Util.clone(this.defaultData),
        var imageData = _.extend({}, this.defaultData),
            imageSpecs = {
                src: image.attr('src'),
                width: image.width(),
                height: image.height()
            },
            link = $('<a>').attr('href', imageSpecs.src)[0],
            realSize = this.calculateRealSize(imageSpecs.src),
            $group = image.closest(".ueditor-insert-variant-group"),
            group_classes = $group.attr("class"),
            $caption = $group.find(".wp-caption-text"),
            caption_classes = $caption.attr("class"),
            $image_wrapper = $group.find(".uinsert-image-wrapper"),
            image_wrapper_classes = $image_wrapper.attr("class"),
            caption_order = 1
            ;

        if(link.origin != window.location.origin)
            imageData.isLocal = 0;

        this.calculateRealSize(imageSpecs.src);

        imageData.imageThumb = imageSpecs;
        imageData.imageFull = {
            width: realSize.width,
            height: realSize.height,
            src: imageSpecs.src
        };


        var parent = image.parent();

        if(parent.is('a')){
            imageData.linkUrl = parent.attr('href') ;
            imageData.linkType = 'external';
        }

        var attachmentId = image.attr('class');
        if(!attachmentId)
            imageData.attachmentId = false;
        else {
            attachmentId = attachmentId.match(/wp-image-(\d+)/);
            if(attachmentId)
                imageData.attachmentId = attachmentId[1];
            else
                imageData.attachmentId = false;
        }

        imageData.title = image.attr('title');
        if( !_.isEmpty( $caption.text() ) ){
            imageData.caption =  $caption.html();
        }

        caption_order = $caption.prev( $image_wrapper).length ? 1 : 0;
        if( $caption.length === 0){
            caption_order = 1;
        }
        if(  $group.length ){
            imageData.style = {
                caption: {
                    "order": caption_order,
                    "height": $caption.css("minHeight") ? $caption.css("minHeight").replace("px", "") : $caption.height(),
                    "width_cls": Upfront.Util.grid.derive_column_class( caption_classes ),
                    "left_cls": Upfront.Util.grid.derive_marginleft_class( caption_classes ),
                    "top_cls": Upfront.Util.grid.derive_margintop_class( caption_classes ),
                    "show": $caption.length
                },
                group: {
                    "float": $group.css("float"),
                    "width_cls": Upfront.Util.grid.derive_column_class( group_classes ),
                    "left_cls": Upfront.Util.grid.derive_marginleft_class( group_classes ),
                    "height": $group && $group.css("minHeight") ? $group.css("minHeight").replace("px", "") : imageSpecs.height + $caption.height(),
                    "marginRight": 0,
                    "marginLeft": 0
                },
                image: {
                    "width_cls": Upfront.Util.grid.derive_column_class( image_wrapper_classes ),
                    "left_cls": Upfront.Util.grid.derive_marginleft_class( image_wrapper_classes ),
                    "top_cls": Upfront.Util.grid.derive_margintop_class( image_wrapper_classes ),
                    "src": "",
                    "height": 0
                }
            };
            imageData.variant_id = $group.data("variant");
        }else{
            imageData.style = Upfront.Content.ImageVariants.first().toJSON();
            imageData.variant_id = imageData.style.vid;
        }


        var insert = new PostImageInsert({data: imageData});

        insert.render();
        image.replaceWith(insert.$el);
        return insert;
    }

});

return {
    PostImageInsert_Manager: PostImageInsert_Manager
};

//End Define
});
})(jQuery);

;(function($){
define('scripts/redactor/ueditor-inserts',[
    "scripts/redactor/ueditor-insert",
    "scripts/redactor/ueditor-image-insert",
    "scripts/redactor/ueditor-image-insert-post",
    "scripts/redactor/ueditor-embed-insert",
    "scripts/redactor/ueditor-post-image-insert-manager"
], function(Insert, ImageInsert, ImageInsertPost, EmbedInsert, PostImageInsertManager){

var TYPES = {
	IMAGE: 'image',
    POSTIMAGE: 'postImage',
    EMBED : 'embed'
};

var insertObjects = {};
var insertNames = {};
insertObjects[TYPES.POSTIMAGE] = PostImageInsertManager.PostImageInsert_Manager;
insertObjects[TYPES.IMAGE] = ImageInsert.ImageInsert;
insertObjects[TYPES.EMBED] = EmbedInsert.EmbedInsert;

insertNames[TYPES.POSTIMAGE] = "Image";
insertNames[TYPES.IMAGE] = "Image";
insertNames[TYPES.EMBED] = "Embed";

return {
	UeditorInsert: Insert.UeditorInsert,
	inserts: insertObjects,
	TYPES: TYPES,
	NAMES: insertNames
};

//End Define
});})(jQuery);

;(function($){
var l10n = Upfront.Settings && Upfront.Settings.l10n
	? Upfront.Settings.l10n.global.ueditor
	: Upfront.mainData.l10n.global.ueditor
;

define("redactor_plugins", [
	'text!scripts/redactor/ueditor-templates.html',
	"scripts/upfront/link-model"
], function(tpl, LinkModel) {

var UeditorEvents = _.extend({}, Backbone.Events);
    /* Panel helper
     ------------------------------*/

var UeditorPanel = Backbone.View.extend({
    initialize: function(options){
        var me = this;

        me.redactor = options.redactor;
        me.button = options.button;
        me.panel = options.panel;

        this.on('open', function(redactor){
            me.$el.trigger('open', redactor);
        });
        this.on('closed', function(redactor){
            me.$el.trigger('closed', redactor);
        });

        if( typeof this.init === "function" ){
            this.init();
        }

        this.render();
    },

    openToolbar: function(openPanel){
        var me = this;
        //me.redactor.$air.show();
        //if(openPanel){
        //    setTimeout(function(){
        //        if(!me.panel.is(':visible'))
        //            me.button.click();
        //    }, 300);
        //}
    },

    closeToolbar: function(){
        this.redactor.$air.fadeOut(100);
        this.redactor.dropdown.hideAll();
        this.$el.trigger('toolbarClosed', this.redactor);
    },

    closePanel: function(){
        if(this.panel.is(':visible'))
            this.button.click();
    },

    disableEditorStop: function(){
        this.redactor.ueditor.disableStop = true;
    },

    enableEditorStop: function(){
        var me = this;
        setTimeout(function(){
            me.redactor.ueditor.disableStop = false;
        }, 300);
    },
    appendOkButton: function(text){
        var me = this;
        if(!me.$el.siblings('.ueditor-ok').length){
            text = text || 'Ok';
            var button = $('<a class="ueditor-ok">' + text + '</a>').on('click', function(e){
                me.$el.trigger('ok');
            });
            button.insertAfter(me.$el);
        }
    }
});


    /*-----------------------------
     PLUGINS
     -------------------------------*/

if (!RedactorPlugins) var RedactorPlugins = {};


/*
 STATE BUTTONS PLUGIN
 */
RedactorPlugins.stateButtons = function() {

    return {
        init: function () {
            if( !this.$toolbar  ) return;
            this.$air = this.$toolbar.closest(".redactor_air");
            this.stateButtons.addStateButtons();
            this.stateButtons.startStateObserver();
        },
        addStateButtons: function () {
            //if (this.stateButtons)
            //    return;

            var me = this;
            //this.stateButtons = {};
            $.each(this.opts.stateButtons, function (id, data) {
                if ($.inArray(id, me.opts.airButtons) !== -1) {
                    var button = new me.stateButtons.StateButton(id, data);
                    var btn = me.button.add(id, data.title);
                    me.button.addCallback( btn, function () {
                        me.stateButtons.stateCallback(id, button)
                    });
                    // set state of button
                    me.$air.on("show", function () {
                        button.guessState(me);
                    });
                }

            });
        },
        stateCallback: function (id, button) {
            button.guessState(this);
            button.callback(id, this.button.get(id), button);
        },
        startStateObserver: function () {
            var observer = $.proxy(this.stateObserver, this);
            this.$element.on('mouseup.redactor keyup.redactor', observer);
        },

        stateObserver: function () {
            var me = this;
            $.each(this.stateButtons.stateButtons, function (id, button) {
                button.guessState(me);
            });
            me.waitForMouseUp = false; //Prevent handler bound to document.mouseup
        },

        StateButton: function (id, data) {
            var me = this,
                nextStates = {},
                previousState = false;
            firstState = false;
            ;

            me.id = id;
            me.currentState = data.defaultState;
            me.states = data.states;
            me.iconClasses = '';
            me.defaultState = data.defaultState;

            $.each(me.states, function (id, state) {
                if (previousState) {
                    nextStates[previousState] = id;
                }
                else
                    firstState = id;
                me.iconClasses += ' ' + state.iconClass;
                previousState = id;
            });
            nextStates[previousState] = firstState;

            me.nextStates = nextStates;

            me.nextState = function (el) {
                this.setState(me.nextStates[this.currentState], el);
            };
            me.setState = function (id, el) {
                this.currentState = id;
                el.removeClass(this.iconClasses)
                    .addClass(this.states[this.currentState].iconClass)
                ;
            };
            me.triggerState = function (redactor, name, el, button) {
                var callback = $.proxy(this.states[this.currentState].callback, redactor);
                callback(name, el, button);
            };
            me.guessState = function (redactor) {
                var found = false;
                $.each(this.states, function (id, state) {
                    found = state.isActive(redactor) ? id : found;
                });
                if (!found)
                    found = this.defaultState;
                this.setState(found, redactor.button.get(this.id));
            };
            me.getElement = function (redactor) {
                return redactor.button.get(this.id);
                return redactor.$toolbar.find('.re-' + this.id);
            };
            return {
                id: id,
                title: data.title,
                callback: function (name, el, button) {
                    button.nextState(el);
                    button.triggerState(this, name, el, button);
                },
                nextState: $.proxy(me.nextState, me),
                setState: $.proxy(me.setState, me),
                triggerState: $.proxy(me.triggerState, me),
                guessState: $.proxy(me.guessState, me)
            }
        }
    }
};



/*--------------------
 ALIGMENT BUTTON
 --------------------- */
RedactorPlugins.stateAlignment = function() {
    return {
        init: function(){
            if( !this.$toolbar  ) return;
            var self = this;
            this.opts.stateButtons.stateAlign = {
                title: l10n.text_align,
                defaultState: 'left',
                states: {
                    left: {
                        iconClass: 'ueditor-left',
                        isActive: function(redactor){
                            var $parent = $(redactor.selection.getBlock());
                            if($parent.length && $parent[0].nodeType == 3)
                                $parent = $parent.parent();
                            return $parent.length && $parent.css('text-align') == 'left';
                        },
                        callback: function(name, el , button){
                            if( !self.utils.isCurrentOrParent("li") ){
                                self.alignment.set('left');
                            }else{
                                $(self.selection.getCurrent()).css('text-align', "left");
                            }
                        }
                    },
                    center: {
                        iconClass: 'ueditor-center',
                        isActive: function(redactor){
                            var $parent = $(redactor.selection.getBlock());
                            if($parent.length && $parent[0].nodeType == 3)
                                $parent = $parent.parent();
                            return $parent.length && $parent.css('text-align') == 'center';
                        },
                        callback: function(name, el , button){
                            if( !self.utils.isCurrentOrParent("li") ){
                                self.alignment.center();
                            }else{
                                $(self.selection.getCurrent()).css('text-align', "center");
                            }
                        }
                    },
                    right: {
                        iconClass: 'ueditor-right',
                        isActive: function(redactor){
                            var $parent = $(redactor.selection.getBlock());
                            if($parent.length && $parent[0].nodeType == 3)
                                $parent = $parent.parent();
                            return $parent.length && $parent.css('text-align') == 'right';
                        },
                        callback: function(name, el , button){
                            if( !self.utils.isCurrentOrParent("li") ){
                                self.alignment.right();
                            }else{
                                $(self.selection.getCurrent()).css('text-align', "right");
                            }
                        }
                    },
                    justify: {
                        iconClass: 'ueditor-justify',
                        isActive: function(redactor){
                            var $parent = $(redactor.selection.getBlock());
                            if($parent.length && $parent[0].nodeType == 3)
                                $parent = $parent.parent();
                            return $parent.length && $parent.css('text-align') == 'justify';
                        },
                        callback: function(name, el , button){
                            if( !self.utils.isCurrentOrParent("li") ){
                                self.alignment.justify();
                            }else{
                                $(self.selection.getCurrent()).css('text-align', "justify");
                            }


                        }
                    }
                }
            }
        }
    }
};

RedactorPlugins.stateAlignmentCTA = {
    beforeInit: function(){
        if( !this.$toolbar  ) return;
        var self = this;
        this.opts.stateButtons.stateAlignCTA = {
            title: l10n.text_align,
            defaultState: 'left',
            states: {
                left: {
                    iconClass: 'ueditor-left',
                    isActive: function(redactor){
                        return self.$element.length && self.$element.css('text-align') == 'left';

                    },
                    callback: function(name, el , button){

                        self.$element.css('text-align', 'left');
                        //.alignmentLeft();
                    }
                },
                center: {
                    iconClass: 'ueditor-center',
                    isActive: function(redactor){

                        return self.$element.length && self.$element.css('text-align') == 'center';

                    },
                    callback: function(name, el , button){

                        self.$element.css('text-align', 'center');

                    }
                },
                right: {
                    iconClass: 'ueditor-right',
                    isActive: function(redactor){

                        return self.$element.length && self.$element.css('text-align') == 'right';

                    },
                    callback: function(name, el , button){

                        self.$element.css('text-align', 'right');
                    }
                },
                justify: {
                    iconClass: 'ueditor-justify',
                    isActive: function(redactor){

                        return self.$element.length && self.$element.css('text-align') == 'justify';

                    },
                    callback: function(name, el , button){
                        self.$element.css('text-align', 'justify');
                    }
                }
            }
        }
    }
};

RedactorPlugins.stateLists = function() {

    return {
        init: function () {
            var self = this;
            this.opts.stateButtons.stateLists = {
                title: l10n.list_style,
                defaultState: 'none',
                states: {
                    none: {
                        iconClass: 'ueditor-nolist',
                        isActive: function (redactor) {
                            var $parent = $(redactor.selection.getParent());
                            return $parent.length && $parent.css('text-align') == 'left';
                        },
                        callback: function (name, el, button) {
                            self.list.toggle("orderedlist");
                        }
                    },
                    unordered: {
                        iconClass: 'ueditor-unorderedlist',
                        isActive: function (redactor) {
                            var $parent = $(redactor.selection.getParent());
                            if ($parent.length) {
                                var list = $parent.closest('ul');
                                if (list.length)
                                    return list.closest('.ueditable').length;
                            }
                            return false;
                        },
                        callback: function (name, el, button) {
                            self.list.toggle("unorderedlist");
                        }
                    },
                    ordered: {
                        iconClass: 'ueditor-orderedlist',
                        isActive: function (redactor) {
                            var $parent = $(redactor.selection.getParent());
                            if ($parent.length) {
                                var list = $parent.closest('ol');
                                if (list.length)
                                    return list.closest('.ueditable').length;
                            }
                            return false;
                        },
                        callback: function (name, el, button) {
                            self.list.toggle("orderedlist");
                        }

                    }
                }
            }
        }
    }
};


RedactorPlugins.upfrontImages = {

    beforeInit: function () {
        if( !this.$toolbar  ) return;
        var redactor = this;
        redactor.events.on("ueditor:stop", function () {
            ImagesHelper.Image.unbind_events();
        });
        redactor.events.on("ueditor:insert:media", function () {
            ImagesHelper.Gallery.to_html(redactor);
            ImagesHelper.Slider.to_html(redactor);
        });
        ImagesHelper.Image.redactor = redactor;
        ImagesHelper.Image.create_dialog();
        ImagesHelper.Image.bind_events();

        Upfront.Media.Transformations.add(ImagesHelper.Image.cleanup);
        Upfront.Media.Transformations.add(ImagesHelper.Gallery.from_html);
        Upfront.Media.Transformations.add(ImagesHelper.Slider.from_html);

        Upfront.Events.on("upfront:editor:image_align", function (el, align) { // Can we refactor upfront:editor:* events?
            var margin = false;
            if ("left" === align) margin = "margin-right";
            else if ("right" === align) margin = "margin-left";
            if (!margin) return false;
            $(el).css(margin, "15px");
        });
    }
};


RedactorPlugins.upfrontSink = {
    beforeInit: function(){
        var me = this;
        if(!Upfront.data.ueditor)
            Upfront.data.ueditor = {sink: false};
        this.opts.buttonsCustom.upfrontSink = {
            title: l10n.more_tools
        };
    },
    init: function(){
        if( !this.$toolbar  ) return;
        var me = this,
            $button = this.$toolbar.find('.redactor_btn_upfrontSink').parent().addClass('upfront-sink-button'),
            sinkElements = this.$toolbar.find('.upfront-sink-button ~ li'),
            sink = $('<div class="ueditor-sink"></div>')
            ;

        $button.on('click', function(){
            if(Upfront.data.ueditor.sink){
                me.closeSink();
            }
            else{
                me.openSink();
            }
        });

        sinkElements.detach().appendTo(sink);
        this.$toolbar.append(sink);
        if(Upfront.data.ueditor.sink)
            this.$toolbar.addClass('ueditor-sink-open');

        sinkElements.each(function(){
            var link = $(this).find('a').attr('class').match(/redactor_btn_[^\s]*/g),
                id = false,
                box = false
                ;
            if(link.length)
                id = link[0].replace('redactor_btn_', '');

            box = me.$toolbar.find('.redactor-dropdown-box-' + id);
            if(box.length)
                box.css({'margin-top': '40px'});
        });
        this.$air.on('show', function(){
            if(Upfront.data.ueditor.sink)
                me.$air.css({top: me.$air.offset().top - 40});
        });
    },
    openSink: function(){
        Upfront.data.ueditor.sink = true;
        this.$toolbar.addClass('ueditor-sink-open');
        this.$air.css({top: this.$air.offset().top - 40});
    },
    closeSink: function(){
        Upfront.data.ueditor.sink = false;
        this.$toolbar.removeClass('ueditor-sink-open');
        this.$air.css({top: this.$air.offset().top + 40});
    }
};


RedactorPlugins.upfrontPlaceholder = function() {
    return {
        init: function () {
            var me = this;
            var placeholder = this.placeholderText;//opts.placeholder;
            if (this.$element.attr('placeholder')) placeholder = this.$element.attr('placeholder');
            if (placeholder === '') placeholder = false;
            if (placeholder !== false)
            {
                //this.placeholderRemoveFromEditor();
                this.$editor.find('span.redactor_placeholder').remove();
                this.$editor.off('focus.redactor_placeholder');

                this.$placeholder = this.$editor.clone(false);

                this.$placeholder.attr('contenteditable', false).removeClass('ueditable redactor_editor').addClass('ueditor-placeholder').html( placeholder);//this.opts.linebreaks ? placeholder : placeholder );
                this.$editor.after(this.$placeholder);
                if ( this.$editor.css('position') == 'static' )
                    this.$editor.css('position', 'relative');
                this.$editor.css('z-index', 1);
                var editor_pos = this.$editor.position();
                this.$placeholder.css({
                    'position': 'absolute',
                    'z-index': '0',
                    'top': editor_pos.top,
                    'left': editor_pos.left,
                    'right': this.$box.outerWidth() - (editor_pos.left + this.$editor.outerWidth())
                });
                this.opts.placeholder = placeholder;
                function placeholderUpdate() {
                    me.code.sync(); // sync first before get

                    var html = me.$editor.text().trim();//$source.val();//this.get();

                    if ( html == '' || html == '&nbsp;' )
                        me.$placeholder.show();
                    else
                        me.$placeholder.hide();
                    }
                }
								var proxyPlaceholderUpdate = $.proxy(placeholderUpdate, this);
                this.$editor.on('keyup', proxyPlaceholderUpdate);
								this.events.on('cleanUpListeners', function() {
									me.$editor.off('keyup', proxyPlaceholderUpdate);
									me.events.off('cleanUpListeners');
								});
                placeholderUpdate();
        },
       /* placeholderUpdate: function () {
            this.code.sync(); // sync first before get
            var html = this.get();
            if ( html == '' )
                this.$placeholder.show();
            else
                this.$placeholder.hide();

        }*/
    }
};

/*-------------------
 Panel Buttons
 -------------------*/

RedactorPlugins.panelButtons = function () {

    return {
        init: function () {
            if( !this.$toolbar  ) return;
            var self = this;

            $.each(this.opts.buttonsCustom, function (id, b) {
                if (b.panel) {
                    var $panel = $('<div class="redactor-dropdown ueditor_panel redactor-dropdown-box-' + id + ' redactor-dropdown-' + self.uuid +' " style="display: none;">'),
                        $button = self.button.get(id),
                        addMethod = _.isUndefined(  b.first ) ? "add" : "addFirst"
                        ;
                    b.panel = new b.panel({redactor: self, button: $button, panel: $panel});
                    $panel.html(b.panel.$el);
                    $panel.appendTo( self.$toolbar );
                    b.dropdown = true;

                    $button.on('click', function () {
                        if ($button.hasClass('dropact')) {
                            self.selection.removeMarkers();
                            b.panel.trigger('open', self);
                        }
                        else {
                            b.panel.trigger('closed', self);
                        }
                    });
                    self.$editor.on('mouseup.redactor keyup.redactor', function () {
                        if ($button.hasClass('dropact')) { //It's open, so we close it
                            self.dropdownHideAll();
                            b.panel.trigger('closed', self);
                        }
                    });

                    $panel
                        .on('click keydown keyup', function (e) {
                            e.stopPropagation();
                        })
                    ;
                    if ($.inArray(id, self.opts.airButtons) === -1) return;
                    var btn = self.button[addMethod](id, b.title);
                    self.button.addCallback( btn, function () {
                        var $button = self.button.get(id),
                            left = $button.position().left;

                        $(".re-icon").removeClass("redactor_act dropact");
                        $button.addClass("redactor_act dropact");
                        $(".redactor-dropdown").not($panel).hide();

                        $panel.css("left", left + "px").toggle();


                        /**
                         * Triggers panel open or close events
                         */
                        if ($panel.is(":visible") && typeof b.panel.open === "function") {
                            b.panel.open.apply(b.panel, [jQuery.Event("open"), self]);
                        } else {
                            if (typeof b.panel.close === "function") {
                                b.panel.close.apply(jQuery.Event("close"), [$.Event, self]);
                            }
                        }

                        /**
                         * Makes sure the last button's panel is kept under the toolbar
                         * @type {[type]}
                         */
                        var $last = $(".redactor-dropdown.ueditor_panel").last(),
                            lastDropdownLeft = left - $last.innerWidth() + $button.width();
                        $last.css("left", lastDropdownLeft + "px");
                    } );

                }
            });
        }
    }
};

/*--------------------
 Font icons button
 -----------------------*/
RedactorPlugins.upfrontIcons = function() {
    return {
        $sel: false,
        init: function () {
            this.opts.buttonsCustom.upfrontIcons = {
                title: l10n.icons,
                panel: this.upfrontIcons.panel
            };
            UeditorEvents.on("ueditor:key:down", function (redactor, e) {
                if ($(redactor.selection.getParent()).hasClass("uf_font_icon") || $(redactor.selection.getCurrent()).hasClass("uf_font_icon")) {
                    if (!( e.keyCode < 48 || e.keyCode > 90 )) {
                        e.preventDefault();
                    }
                }
            });
        },
        panel: UeditorPanel.extend(_.extend({}, Upfront.Views.Mixins.Upfront_Scroll_Mixin, {
            $sel: false,
            tpl: _.template($(tpl).find('#font-icons').html()),
            events: {
                'click .ueditor-font-icon': 'insert_icon',
                'open': 'open',
                'toolbarClosed': "close",
                'change .upfront-font-icons-controlls input': "input_change"
            },
            render: function (options) {
                this.$el.html(this.tpl({icons: Upfront.mainData.font_icons }));
                this.stop_scroll_propagation(this.$el);
            },
            open: function (e, redactor) {
                this.redactor = redactor;
                this.redactor.selection.restore();
                this.redactor.buffer.set();
                this.redactor.selection.save();
                this.set_current_icon();
                this.$el.parent().css({
                    left: 193
                });
            },
            close: function () {
                if (this.redactor) {
                    //this.redactor.selection.restore();
                    this.$sel = false;
                }
            },
            insert_icon: function (e) {
                var $icon = $($(e.target).hasClass("ueditor-font-icon") ? $(e.target).html() : $(e.target).closest(".ueditor-font-icon").html()),
                    fontSize = this.$(".font-icons-size").val(),
                    top = this.$(".font-icons-top").val();
                $icon.css({
                    "font-size": fontSize + "px",
                    "top": top + "px"
                });
                var html = $icon[0].outerHTML;
                //var inserted = this.redactor.insert.html($icon[0].outerHTML); //inserted false instead of true to retain the selected content
                /**
                 * insert.html may use document's insertHtml command which may result in the $icon to lose the uf_font_icon
                 * and that's why we're using insert.execHtml from now on
                 */
                 this.redactor.insert.execHtml(html);

                this.redactor.code.sync();


                this.redactor.selection.restore();

                this.closeToolbar();
            },
            input_change: function(e){
                var $sel = this.$sel;
                e.stopPropagation();
                e.preventDefault();
                var $input = $(e.target),
                    val = $input.val() + "px";

                if ($input.hasClass("font-icons-size")) {
                    $sel.css("font-size", val);
                }

                if ($input.hasClass("font-icons-top")) {
                    $sel.css("top", val);
                }
                this.redactor.code.sync();
            },
            set_current_icon: function () {
                var $sel = $(this.redactor.selection.getCurrent()).last(),
                    self = this;

                if (!$sel.hasClass("uf_font_icon")) {
                    $sel = $(this.redactor.selection.getInlines()).filter( ".uf_font_icon").last();
                }
                if ($sel.hasClass("uf_font_icon")) {
                    this.$sel = $sel;
                    this.$(".font-icons-size").val(parseFloat($sel.css("font-size")));
                    this.$(".font-icons-top").val(parseFloat($sel.css("top")));
                }
            }

        }))
    }
};

/*--------------------
 Upfront link panel button
 -----------------------*/
RedactorPlugins.upfrontLink = function() {

	return {
		init: function () {
			this.opts.buttonsCustom.upfrontLink = {
				title: l10n.link,
				panel: this.upfrontLink.panel
			};
		},
		openPanel: function () {
			var left = this.button.get("link").position().left;
			$(".redactor-dropdown-box-upfrontLink").css("left", left + "px").toggle();
		},
		panel: UeditorPanel.extend({
			tpl: _.template($(tpl).find('#link-tpl').html()),
			events: {
				open: 'open'
			},

			initialize: function () {
				UeditorPanel.prototype.initialize.apply(this, arguments);
			},

			open: function (e, redactor) {
				this.redactor = redactor;
				redactor.selection.save();

				var me = this,
					// Defaults
					href = '',
					type = 'external',
					target = '_self';

				this.selectedLink = redactor.utils.isCurrentOrParent('A');

				if (this.selectedLink) {
					// Get values from existing link
					href = $(this.selectedLink).attr('href');
					target = $(this.selectedLink).attr('target');

					if (!_.isUndefined($(this.selectedLink).attr('data-upfront-link-type'))) {
						// New linking is used, there is exact value
						type = $(this.selectedLink).attr('data-upfront-link-type');
					} else {
						// Old linking, guess link type
						type = this.guessLinkType(href);
					}
				}

				this.linkModel = new LinkModel({
					type: type,
					url: href,
					target: target
				});

				this.listenTo(this.linkModel, 'change', function (dontflag) {
                    me.redactor.buffer.set();
                    me.redactor.selection.save();
					if (me.linkModel.get('type') === 'unlink') {
						me.unlink();
					} else {
						me.link(dontflag);
					}

					// me.closeToolbar(); // should we do this?
				});


				this.render();
			},

			render: function () {
                // this function is better called in 'this.open()', no point having it executed without a linkModel.
                if(typeof(this.linkModel) === 'undefined')
                    return;
                
				var linkTypes = {},
					me = this;

				if (this.redactor.$element.hasClass('mfp-title')) {
					linkTypes = {
						anchor: false,
						lightbox: false
					};
					// Prevent magnific focus handler to mess up everything
					$(document).off('focusin');
				}

				this.linkPanel = new Upfront.Views.Editor.LinkPanel({
					model: this.linkModel,
					linkTypes: linkTypes,
					button: true
				});

				// Close on panel ok
				this.listenTo(this.linkPanel, 'linkpanel:close', function() {
					// Didn't find any function to do this, so go raw
					$('a.re-upfrontLink').click().removeClass('dropact redactor_act');
				});

				this.linkPanel.render();
				this.$el.html(this.linkPanel.el);
				this.linkPanel.delegateEvents();
			},

			close: function (e, redactor) {
				redactor.selection.restore();
			},

			unlink: function (e) {
				if (e) {
					e.preventDefault();
				}

				var text = this.redactor.selection.getHtml();
				this.redactor.selection.restore();
				if (text !== '' && $.parseHTML(text).length > 1) {// there is html inside
					this.redactor.insert.html(text, true);
				} else {
					this.redactor.link.unlink();
				}

				this.redactor.$element.focus();
				this.updateMissingLightboxFlag();
			},

			link: function (dontflag) {
				var selectedText;

				if (typeof this.linkModel.get('url') === 'undefined') {
					return;
				}

				this.redactor.selection.restore();

				if (this.selectedLink) {
					// Update selected link
					$(this.selectedLink).attr('href', this.linkModel.get('url'))
						.attr('target', this.linkModel.get('target'));
				} else {
// Origin story, Episode #0 - In The Beginning
// This does not work because redactor will try to destroy HTML tags in link text
// - see redactor.js:5418 for more info
/*
                    // Create new link
                    selectedText = this.redactor.selection.getHtml();
*/

// Fix approach, Episode #1 - Nuclear Wasteland (drop all HTML)
/*
                    // ^ instead of the HTML approach above, go with getText()
					selectedText = this.redactor.selection.getText();
                    this.redactor.selection.replaceWithHtml(selectedText); // Also reset the selection to the text-only representation
*/

// Fix approach, Episode #2 - Lizard Spooks Spock (camouflage the HTML)
                    // Somewhere along the line, the non-printable chars, spaces and stuff get all normalized,
                    // hence the printable default/fallback string
                    // Downside: if something goes wrong, it won't be a pretty sight at all :/
                    var rx_special = /[-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, // This will be used to encode regex special chars
                        rx_replacement = '\\$&', // Second part of regex special chars encoding (result)
                        otm = ((Upfront.Settings || {}).Editor || {}).OPEN_TAG_RPL_MARK || '{{UPFRONT_OPEN_TAG_MARK}}', // Open Tag Mark - either from settings or fallback
                        ctm = ((Upfront.Settings || {}).Editor || {}).CLOSE_TAG_RPL_MARK || '{{UPFRONT_CLOSE_TAG_MARK}}', // Close Tag Mark - either from settings or fallback
                        rx_otm = new RegExp(otm.replace(rx_special, rx_replacement), 'g'), // OTM regex representation - note the "g" parameter
                        rx_ctm = new RegExp(ctm.replace(rx_special, rx_replacement), 'g') // CTM regex representation - note the "g" parameter
                    ;
                    selectedText = this.redactor.selection.getHtml(); // Get HTML, yeah
                    // Now, let's nerf the HTML stuff
                    selectedText = selectedText
                        // Clever, ain't it?
                        .replace(/</g, otm)
                        .replace(/>/g, ctm)
                    ;
                    this.redactor.selection.replaceWithHtml(selectedText);
                    
					this.redactor.link.set(selectedText, this.linkModel.get('url'), this.linkModel.get('target'));
					// Now select created link
					this.selectedLink = this.redactor.utils.isCurrentOrParent('A');

// Episode #2a, The Sad Saga of Spock's Debilitating Phobia Continues (de-camo the HTML)
                    selectedText = this.redactor.selection.getHtml(); // Get the HTML once more, it's now fake HTML
                    // Now, let's de-camouflage it
                    selectedText = selectedText
                        .replace(rx_otm, '<')
                        .replace(rx_ctm, '>')
                    ;
                    this.redactor.selection.replaceWithHtml(selectedText);
// Episode #2 concludes, Spock dies in the end :(

					// Update selection, new link is created it messes up selection
					this.redactor.selection.save();
				}

				$(this.selectedLink).attr('data-upfront-link-type', this.linkModel.get('type'));

				// Do redactor stuff
				this.redactor.$element.focus();
                // dontflag is sent while creation of lightbox from link-panel.js
                if(typeof(dontflag) === 'undefined')
				    this.updateMissingLightboxFlag();
				this.redactor.code.sync();

			},
			bindEvents: function () {
			},
			guessLinkType: function(url){
				if(!$.trim(url) || $.trim(url) == '#')
					return 'unlink';
				if(url.length && url[0] == '#')
					return url.indexOf('#ltb-') > -1 ? 'lightbox' : 'anchor';
				if(url.substring(0, location.origin.length) == location.origin)
					return 'entry';
				if (url.match(/^mailto/)) {
					return 'email';
				}

				return 'external';
			},
            updateMissingLightboxFlag: function() {
                var link = this.redactor.utils.isCurrentOrParent('A');

                if(link && $(link).attr('href').indexOf('#ltb-') > -1 ) {
                    if(!Upfront.Util.checkLightbox($(link).attr('href')))
                        $(link).addClass('missing-lightbox-warning');
                    else
                        $(link).removeClass('missing-lightbox-warning');
                }
            }
		})
	}
};

RedactorPlugins.upfrontColor = function() {

    return {
        init: function () {
            this.opts.buttonsCustom.upfrontColor = {
                title: l10n.color,
                panel: this.upfrontColor.panel
            };
        },
        panel: UeditorPanel.extend({
            current_color: false,
            current_bg: false,
            events: {
                'open': 'open'
            },
            init: function(){
              this.listenTo( UeditorEvents, "ueditor:air:show", this.on_air_show );
							var me = this;
							this.listenTo( UeditorEvents, 'cleanUpListeners', function() {
								me.stopListening();
							});
            },
            on_air_show: function(e){
                this.redactor.selection.save();
                this.updateIcon();
            },
            close: function (e, redactor) {
                redactor.selection.restore();
            },
            setCurrentColors: function () {
                var current = this.redactor.selection.getCurrent();
                current = $(current).prop('tagName') ? current : $(current).parent();
                if ( current && ( ['SPAN', 'DIV', 'INLINE'].indexOf(  $(current).prop('tagName')  ) !== -1 || $(current).hasClass(".upfront_theme_colors") ) ) {

                    var bg_color = tinycolor($(current).css('background-color'));
                    this.current_color = $(current).css('color');
                    if (bg_color.getAlpha() > 0)
                        this.current_bg = $(current).css('background-color');
                }
                else {
                    this.current_color = this.current_bg = false;
                }
            },
            open: function (e, redactor) {
                this.updateIcon();
                this.redactor.selection.save();
                var self = this,
                    theme_colors = Upfront.Views.Theme_Colors.colors.pluck("color").length ? Upfront.Views.Theme_Colors.colors.pluck("color") : [],
                    foreground_picker = new Upfront.Views.Editor.Field.Color({
                        spectrum: {
                            flat: true,
                            showAlpha: true,
                            appendTo: "parent",
                            showPalette: true,
                            localStorageKey: "spectrum.recent_colors",
                            palette: theme_colors,
                            maxSelectionSize: 10,
                            preferredFormat: "hex",
                            chooseText: "Ok",
                            showInput: true,
                            allowEmpty: true,
                            change: function (color) {
                                self.current_color = color;
                            },
                            move: function (color) {
                                self.current_color = color;
                            }
                        }
                    }),
                    background_picker = new Upfront.Views.Editor.Field.Color({
                        blank_alpha: 0,
                        spectrum: {
                            flat: true,
                            showAlpha: true,
                            appendTo: "parent",
                            showPalette: true,
                            palette: theme_colors,
                            localStorageKey: "spectrum.recent_bgs",
                            maxSelectionSize: 10,
                            preferredFormat: "hex",
                            chooseText: "Ok",
                            showInput: true,
                            allowEmpty: true,
                            change: function (color) {
                                self.current_bg = color;
                            },
                            move: function (color) {
                                self.current_bg = color;
                            }
                        }
                    });

                foreground_picker.render();
                this.$("#tabforeground-content").html(foreground_picker.el);

                background_picker.render();
                this.$("#tabbackground-content").html(background_picker.el);

                if (this.current_color) {
                    var color = tinycolor(self.current_color);
                    foreground_picker.$(".upfront-field-color").spectrum("option", "color", self.current_color);
                    foreground_picker.$(".upfront-field-color").spectrum("set", color);
                    foreground_picker.$(".sp-input").css({
                        "border-left-color": self.current_color
                    });
                    foreground_picker.render_sidebar_rgba(color.toRgb());
                    foreground_picker.update_input_val(color.toHexString());
                }
                else {
                    var color = tinycolor("#000000");
                    foreground_picker.$(".upfront-field-color").spectrum("option", "color", "#000000");
                    foreground_picker.$(".upfront-field-color").spectrum("set", color);
                    background_picker.$(".sp-input").css({
                        "border-left-color": "#000000"
                    });
                    foreground_picker.render_sidebar_rgba(color.toRgb());
                    foreground_picker.update_input_val(color.toHexString());
                }

                if (this.current_bg) {
                    var color = tinycolor(self.current_bg);
                    background_picker.$(".upfront-field-color").spectrum("option", "color", self.current_bg);
                    background_picker.$(".upfront-field-color").spectrum("set", color);
                    background_picker.$(".sp-input").css({
                        "border-left-color": self.current_bg
                    });
                    background_picker.render_sidebar_rgba(color.toRgb());
                    background_picker.update_input_val(color.toHexString());
                }
                else {
                    var color = tinycolor("rgba(0, 0, 0, 0)");
                    background_picker.$(".upfront-field-color").spectrum("option", "color", "rgba(0, 0, 0, 0)");
                    background_picker.$(".upfront-field-color").spectrum("set", color);
                    background_picker.$(".sp-input").css({
                        "border-left-color": "rgba(0, 0, 0, 0)"
                    });
                    background_picker.render_sidebar_rgba(color.toRgb());
                    background_picker.update_input_val(color.toHexString());
                }


                this.$(".sp-choose").on("click", function ( e ) {
                    e.preventDefault();
                    self.updateColors();
                    self.closePanel();
                    self.closeToolbar();
                    self.redactor.dropdown.hideAll();
                });
            },
            render: function () {

                var tabforeground = $('<li id="tabforeground" class="active">').html(l10n.text_color);
                var tabbackground = $('<li id="tabbackground">').html(l10n.text_background);
                var tablist = $('<ul class="tablist">').append(tabforeground).append(tabbackground);

                var tabs = $('<ul class="tabs">').append($('<li id="tabforeground-content" class="active">').html('<input class="foreground" type="text">')).append($('<li id="tabbackground-content">').html('<input class="background" type="text">'));

                var redac = this.redactor;
                var self = this;

                //redac.bufferAirBindHide = this.redactor.airBindHide;

                //redac.airBindHide = function () {
                //    self.updateIcon();
                //    redac.bufferAirBindHide();
                //};

                tablist.children('li').on('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    tablist.children('li').removeClass('active');
                    $(this).addClass('active');
                    tabs.children('li').removeClass('active');
                    tabs.children('li#' + $(this).attr('id') + '-content').addClass('active');

                    self.$('input.foreground').spectrum('option', 'color', typeof(self.current_color) == 'object' ? self.current_color.toRgbString() : self.current_color);
                    self.$('input.background').spectrum('option', 'color', typeof(self.current_bg) == 'object' ? self.current_bg.toRgbString() : self.current_bg);
                });

                this.$el.html(tablist).append(tabs);
                //redac.selectionSave();

            },
            updateIcon: function () {
                var self = this;
                self.setCurrentColors();
                if (self.current_bg) {
                    var color = tinycolor(self.current_bg);
                    if (color.getAlpha() === 0) {
                        this.redactor.$toolbar.find('.re-icon.re-upfrontColor').addClass('transparent').css('border-color', "");
                    } else {
                        this.redactor.$toolbar.find('.re-icon.re-upfrontColor').removeClass('transparent').css('border-color', color.toRgbString());
                    }
                }
                else {
                    this.redactor.$toolbar.find('.re-icon.re-upfrontColor').addClass('transparent').css('border-color', '');
                }


                if (self.current_color)
                    this.redactor.$toolbar.find('.re-icon.re-upfrontColor').css('color', self.current_color);
                else
                    this.redactor.$toolbar.find('.re-icon.re-upfrontColor').css('color', '');

            },
            updateColors: function () {
                this.redactor.buffer.set();
                this.redactor.selection.save();
                var theme_color_index = Upfront.Views.Theme_Colors.colors.is_theme_color(this.current_color);
                if( theme_color_index !== false ){
                    this.current_color.is_theme_color = true;
                    this.current_color.theme_color = "#ufc" + theme_color_index;
                    this.current_color.theme_color_code = Upfront.Util.colors.convert_string_ufc_to_color( this.current_color.theme_color);
                }else{
                    this.current_color.is_theme_color = false;
                }

                theme_color_index = Upfront.Views.Theme_Colors.colors.is_theme_color(this.current_bg);
                if( theme_color_index !== false ){
                    this.current_bg.is_theme_color = true;
                    this.current_bg.theme_color = "#ufc" + theme_color_index;
                    this.current_bg.theme_color_code = Upfront.Util.colors.convert_string_ufc_to_color(this.current_bg.theme_color);
                }else{
                    this.current_bg.is_theme_color = false;
                }

                var self = this,
                    current = self.redactor.selection.getText(),
                    bg_cleanup = "color",
                    font_cleanup = "color",
                    change_color = false,
                    change_bgcolor = false,
                    class_set = function( cls ){
                        self.redactor.inline.format('div', 'class', cls);
                    },
                    color_set = function(rule, raw_value) {
                        var theme_color = false, cls = false, is_bg = !!rule.match(/background/);

                        if (raw_value.is_theme_color) {
                            cls = Upfront.Views.Theme_Colors.colors.get_css_class(raw_value, is_bg);
                            if (!cls) theme_color = raw_value.theme_color;
                        } else {
                            theme_color = raw_value.toRgbString();
                        }

                        var wrapper = document.createElement("span"),
                            //contents = document.createRange().createContextualFragment( self.redactor.selection.getHtml() ),
                            contents = self.redactor.range.extractContents(),
                            //contents = self.redactor.range.cloneContents(),
                            range = self.redactor.range,
                            $range = range.commonAncestorContainer ? $(range.commonAncestorContainer) : false,
                            apply_to_wrapper = function($wrapper){
                                if (cls) {
                                    $wrapper
                                        .addClass(cls)
                                    ;
                                } else if (!!theme_color) {
                                    $wrapper
                                        .attr("style", rule + ':' + theme_color) // use color otherwise
                                    ;
                                }
                            }
                        ;

                        // Todo Ve: Removing this would allow changing the color of part of a block which already has color i.e
                        // You have "This is my whole text" and it's aready red, but you wanna change the color of "whole" word

                        //if ($range && $range.length && $range.is("span")) {
                        //    range.selectNode(range.commonAncestorContainer);
                        //    Upfront.Views.Theme_Colors.colors.remove_theme_color_classes($range, is_bg);
                        //    $range.attr("style", "");
                        //    wrapper = $range.get(0);
                        //
                        //}



                        //if( contents.childNodes[0] && _.indexOf(["p", "li"], contents.childNodes[0].tagName.toLowerCase() ) !== -1 ){ //  make sure use can set color to multiple paragraphs at once
                        if( contents.childNodes[0] && self.redactor.utils.isBlock( contents.childNodes[0] )  ){ //  make sure use can set color to multiple blocks at once

                            while( self.redactor.selection.getParent() ){// try to remove selected nodes as long as we have any selected node
                                $( self.redactor.selection.getBlocks()).remove();
                            }
                            var _nodes = [];

                            /**
                             * Prepare nodes and wrap them into wrappers
                             *
                             */
                            _.each(  contents.childNodes, function(node, index) {
                                var wrapper = document.createElement("span"),
                                    first_child = node.childNodes[0];

                                if(_.isUndefined(node) ) return;

                                if( first_child  && first_child.tagName &&  first_child.tagName.toLowerCase() === "span" && ( first_child.className.match(/upfront_theme_/) || first_child.style.cssText.match(/color/) ) ){ // if already color is applied
                                    wrapper.innerHTML = first_child.innerHTML;
                                }else{
                                    wrapper.innerHTML =  node.innerHTML;
                                }

                                node.innerHTML = "";
                                node.appendChild( wrapper );
                                _nodes.push({
                                    node: node,
                                    wrapper: wrapper
                                });

                            } );
                            /**
                             * Insert nodes back to where they were
                             * Reverse them since insertNode adds nodes to the beginning
                             *
                             *
                             */
                            _.each( _nodes.reverse(),  function( _node, index){
                                var node = _node.node,
                                    wrapper = _node.wrapper;

                                self.redactor.range.insertNode(node);
                                //container.appendChild(node);
                                var $wrapper = $(wrapper);

                                apply_to_wrapper( $wrapper );
                            } );
                        }else{
                            wrapper.appendChild(contents);
                            self.redactor.range.insertNode(wrapper);

                            apply_to_wrapper( $(wrapper) );
                        }

                        self.redactor.selection.restore();
                        self.redactor.code.sync();
                    },
                    color_remove = function(rule)
                    {
                        //self.redactor.inline.removeStyleRule(rule);
                    };


                /**
                 * Background color
                 */
                if (self.current_bg && typeof(self.current_bg) == 'object') {

                    change_bgcolor = true;
                    var bg_class = Upfront.Views.Theme_Colors.colors.get_css_class(self.current_bg.toHexString(), true);
                    //color_remove( 'background-color' );
                    //if (bg_class) {
                    //    class_set( bg_class );
                    //    bg_cleanup = "theme_color";
                    //} else {
                    //
                    //}
                    if(self.current_bg.reset === true){
                        self.reset_bg_color();
                    }else{
                        color_set( 'background-color', self.current_bg  );
                    }
                }

                /**
                 * Font color
                 */
                if (self.current_color && typeof(self.current_color) == 'object') {
                    change_color = true;
                    var theme_color_classname = Upfront.Views.Theme_Colors.colors.get_css_class(self.current_color.toHexString());
                    color_remove( 'color' );
                    //if (theme_color_classname) {
                    //    class_set( theme_color_classname );
                    //}else{
                    //    color_set( 'color',  self.current_color.toRgbString() );
                    //}
                    if( self.current_color.reset === true ){
                        this.reset_color();
                    }else{
                        color_set( 'color', self.current_color );
                    }
                }

                /**
                 * Clean up
                 */
                if( change_color && !change_bgcolor){
                    var replacees = [];
                    $(this.redactor.selection.getCurrent()).parents("[data-redactor-style^='color']").each( function(){
                        var $this = $(this);
                        if( $this.text() === self.redactor.selection.getText() ){
                            replacees.push( this );
                        }
                    } );

                    var current = this.redactor.selection.getCurrent(),
                        $last_el = $( _.last( replacees ) ),
                        $bg_children = $last_el.children("[data-redactor-style^='background-color'], [ style^='background-color']");


                    $bg_children = $bg_children.length === 0 &&  $last_el.is("[data-redactor-style^='background-color'], [ style^='background-color']") ? $last_el : $bg_children;

                    if( $bg_children.length > 0 ){
                        var bg_color = $( _.first( $bg_children )).css("background-color");
                        current = $( current).css( { backgroundColor: bg_color } );
                    }

                    $( $last_el ).replaceWith( current );
                }

                if( change_bgcolor && !change_color){
                    var replacees = [];
                    $(this.redactor.selection.getCurrent()).parents("[data-redactor-style^='background-color']").each( function(){
                        var $this = $(this);
                        if( $this.text() === self.redactor.selection.getText() ){
                            replacees.push( this );
                        }
                    } );

                    var current = this.redactor.selection.getCurrent(),
                        $last_el = $( _.last( replacees ) ),
                        $color_children = $last_el.children("[data-redactor-style^='color'], [ style^='color']");

                    $color_children = $color_children.length === 0 &&  $last_el.is("[data-redactor-style^='color'], [ style^='color']") ? $last_el : $color_children;

                    if( $color_children.length > 0 ){
                        var color = $( _.first( $bg_children )).css("color");
                        current = $( current ).css( { color: color } );
                    }

                    $( $last_el ).replaceWith( current );
                }

                if( change_bgcolor && change_color){
                    var replacees = [];
                    $(this.redactor.selection.getCurrent()).parents("[data-redactor-style^='color'], [data-redactor-style^='background-color']").each( function(){
                        var $this = $(this);
                        if( $this.text() === self.redactor.selection.getText() ){
                            replacees.push( this );
                        }
                    } );

                    $( _.last( replacees ) ).replaceWith( $( this.redactor.selection.getCurrent()).css( {
                        backgroundColor: self.current_bg.is_theme_color ? self.current_bg.theme_color_code : self.current_bg.toHexString()
                    } ) );
                }

                /**
                 * End of clean up
                 */

                self.updateIcon();
            },
            reset_bg_color: function(){
                this.redactor.inline.removeFormat("backgroundColor");
                return;
            },
            reset_color: function(){
                this.redactor.selection.removeMarkers();
                var current = this.redactor.selection.getCurrent(),
                    current_html = $(current).html(),
                    html = this.redactor.selection.getHtml();

                //if( html.replace(/(\r\n|\n|\r)/gm,"").trim() === $(current).html().replace(/(\r\n|\n|\r)/gm,"").trim() && !_.isEmpty( current.style.color ) ){
                this.redactor.inline.removeFormat("color");
                //}else{
                //}
                $(this.redactor.selection.getCurrent()).find("font").each(function(){
                   var $this = $(this),
                        color = $this.attr("color"),
                        html = $this.html(),
                        span = document.createElement("span");
                    span.style.color = color;
                    span.innerHTML = html;
                    $this.replaceWith( span );
                });

                return;
            }
        })
    }
};


RedactorPlugins.upfrontFormatting = function() {

    return {

        init: function () {

            this.opts.buttonsCustom.upfrontFormatting = {
                title: l10n.formatting.title,
                panel: this.upfrontFormatting.panel,
                first: true
            };
        },
        panel: UeditorPanel.extend(_.extend({}, Upfront.Views.Mixins.Upfront_Scroll_Mixin, {
            selected_class: "",
            tpl: _.template($(tpl).find('#upfront-formatting').html()),
            className: "ufront-air-formatting",
            init: function(){
                this.custom_classes = ["first-class", "second-class", "third-class"];

            },
            events: {
                "click li *" : "select_tag",
                "change .ufront-formatting-custom-class": "change_custom_class"
            },
            render: function (options) {
                this.$el.html(this.tpl( _.extend({}, {
                    custom_classes: this.custom_classes,
                    selected_class: this.selected_class
                }, l10n.formatting) ));
                return this;
            },
            open: function (e, redactor) {
                this.redactor = redactor;
                this.set_previously_selected_tag();
                this.set_previously_selected_class();
            },
            close: function () {
                if (this.redactor) {
                    this.redactor.selection.restore();
                    this.$sel = false;
                }
            },
            set_previously_selected_tag: function(){
                var tag = $(this.redactor.selection.getBlock()).length ? $(this.redactor.selection.getBlock())[0].tagName : false;
                if (tag) {
                    tag = tag.toLowerCase();
                    this.$("[data-tag]").removeClass("dropact");
                    this.$("[data-tag='" + tag + "']").addClass("dropact");
                }
                this.redactor.selection.save();
            },
            set_previously_selected_class: function(){
                var self = this,
                    selected_class = $(this.redactor.selection.getBlock()).length ? $(this.redactor.selection.getBlock())[0].className : false;
                if( selected_class ){
                    this.selected_class = selected_class.split(" ").filter( function(cls){
                        return self.custom_classes.indexOf( cls ) !== -1;
                    });

                    if( this.selected_class.length === 1){

                        this.$("option").map(function(){
                            var $this = $(this);
                            if($this.val() === self.selected_class[0]){
                                $this.attr("selected", true);
                            }else{
                                $this.attr("selected", false);
                            }
                        });
                    }
                }
            },
            select_tag: function( e ){
                e.preventDefault();
                this.redactor.buffer.set();
                this.redactor.$editor.focus();
                var tag = $(e.target).data("tag");

                if (!this.redactor.utils.browser('msie')) this.redactor.$editor.focus();

                this.redactor.block.blocks = this.redactor.selection.getBlocks();

                this.redactor.block.blocksSize = this.redactor.block.blocks.length;
                this.redactor.block.type = "";
                this.redactor.block.value = "";

                this.redactor.buffer.set();
                this.redactor.selection.save();

                var block = this.redactor.block.blocks[0];

                var $formatted = this.redactor.utils.replaceToTag(block, tag);
                //this.redactor.block.toggle($formatted);

                if (tag == 'p' || this.redactor.block.headTag) $formatted.find('p').contents().unwrap();

                this.redactor.code.sync();
                this.close();
                this.redactor.dropdown.hideAll();
            },
            change_custom_class: function(e){
                var self = this,
                    custom_class = $(e.target).val();

                this.redactor.buffer.set();
                this.redactor.$editor.focus();
                _(this.custom_classes).each( function(custom_class){
                    self.redactor.block.removeClass( custom_class );
                });
                this.redactor.block.setClass(custom_class);
                this.redactor.dropdown.hideAll();
            }
        })
        )

    }
};

RedactorPlugins.blockquote = function() {

    return {
        init: function () {

            var me = this;
            this.opts.stateButtons.blockquote = {
                title: l10n.blockquote,
                defaultState: 'noquote',
                states: {
                    noquote: {
                        iconClass: 'ueditor-noquote',
                        isActive: function (redactor) {
                            var quote = redactor.blockquote.getQuote();
                            return !quote;
                        },
                        callback: function (name, el, button) {
                            if( me.utils.isCurrentOrParent(['BLOCKQUOTE']) ){
                                //me.block.formatBlockquote('blockquote');
                                //$( me.selection.getCurrent()).unwrap("<blockquote></blockquote>");
                                me.utils.replaceToTag(me.selection.getBlock(), 'p');
                            }
                        }
                    },
                    quote: {
                        iconClass: 'ueditor-quote',
                        isActive: function (redactor) {
                            var quote = redactor.blockquote.getQuote();
                            return quote && !$(quote).hasClass('upfront-quote-alternative');
                        },
                        callback: function (name, el, button) {
                            me.block.formatBlockquote('blockquote');
                        }
                    },
                    alternative: {
                        iconClass: 'ueditor-quote-alternative',
                        isActive: function (redactor) {
                            var quote = redactor.blockquote.getQuote();
                            return quote && $(quote).hasClass('upfront-quote-alternative');
                        },
                        callback: function (name, el, button) {
                            me.blockquote.getQuote().addClass('upfront-quote-alternative');
                        }
                    }
                }
            };

        },
        getQuote: function () {
            var quote = $(this.selection.getParent());
            if (quote.prop('tagName') == 'BLOCKQUOTE')
                return quote;
            quote = quote.closest('blockquote');
            return quote.closest('.redactor-box').length ? quote : false;
        }
    }
};

    window.RedactorPlugins = RedactorPlugins;
    return {
        UeditorEvents: UeditorEvents
    };
}); //End require

}(jQuery));

;(function($){
define("ueditor", [ // For require to include scripts in build and not load them separately they must be passes as an array and not variable that points to array
	'text!scripts/redactor/ueditor-templates.html',
	'scripts/redactor/ueditor-inserts',
    'redactor_plugins'
], function(tpl, Inserts, redactor_plugins){
var hackedRedactor = false;
var UeditorEvents = redactor_plugins.UeditorEvents;
$.fn.ueditor = function(options){
	var isMethod = false,
		elements = this,
		result
	;
	//Modify redactor to work as we need
	if(!hackedRedactor)
		hackRedactor();


	if (typeof options === 'string'){
		isMethod = true;
	}

	this.each(function(){
		var $el = $(this),
			ueditor = $el.data('ueditor')
		;
		if(ueditor){
			if(isMethod)
				result = ueditor.callMethod(options);
			else
				$.error('Ueditor is already instantiated');
		}
		else{
			if(isMethod)
				$.error('Can\'t call the ueditor method ' + options + '. Ueditor not initialized');
			else {
				// Initialize editor
				$el.data('ueditor', new Ueditor($el, options));
				if( options.autostart ){
					$el.data('ueditor').start();
				}
				Ueditor.prototype.redactorInitialized = true;
			}
		}
	});

	if ( this.length == 1 && typeof result != 'undefined' )
		return result;
	return this;
};

var hackRedactor = function(){
    
    // These lines override the Redactor's prefFormatting
    var clean = $.Redactor.prototype.clean();
    
    clean.savePreFormatting = function(html) {
        return html;
    };

    $.Redactor.prototype.clean = function () { return clean };
    
	// Make click consistent
	$.Redactor.prototype.airBindHide = function () {
		if (!this.opts.air || !this.$toolbar) return;

		var self = this,
            hideHandler = $.proxy(function(doc) {
			$(doc).on('mouseup.redactor', $.proxy(function (e) {
				if ($(e.target).closest(this.$toolbar).length === 0
					&& $(e.target).parents("#upfront-popup.upfront-postselector-popup").length === 0)
				{
					if (!self.selection.getText()) {

						if(self.$element.closest('li').hasClass('menu-item')) {
				    		var menu_item = self.$element.closest('li.menu-item').data('backboneview');
				    		menu_item.model['being-edited'] = false;
				    	}

						self.$air.fadeOut(100);
						$(".redactor-dropdown").hide();
						self.$toolbar.find(".dropact").removeClass("dropact");
						$(doc).off(e);
					}
				}
			}, this)).on('keydown.redactor', $.proxy(function (e) {
				if(e.keyCode === 91 && e.metaKey) return;
				if (e.which === this.keyCode.ESC) {
					//self.getSelection().collapseToStart();
				}
				self.$air.fadeOut(100);
				$(doc).off(e);
			}, this));
		}, this);

		// Hide the toolbar at events in all documents (iframe)
		hideHandler(document);
		if (this.opts.iframe) hideHandler(this.document);
	};

	//Change the position of the air toolbar
	$.Redactor.prototype.airShow = function (e, keyboard)
    {
        if( typeof e !== "undefined" && ( $(e.target).parents().is(".uimage-control-panel") || $(e.target).is(".upfront-icon") || $(e.target).is(".upfront-icon-button") || ( !_.isUndefined(e.target.contentEditable) && e.target.contentEditable === "false" ) || $(e.target).closest(".redactor-editor").attr("contentEditable") === "false"  ) ) return;
        //if( $(e.target).parents().is(".uimage-control-panel") || $(e.target).is(".upfront-icon") || $(e.target).is(".upfront-icon-button")) return;

        if (!this.opts.air || !( this.opts.buttons.length || this.opts.airButtons.length ) || !this.$toolbar) return;

		if(this.$element.closest('li').hasClass('menu-item')) {
    		var menu_item = this.$element.closest('li.menu-item').data('backboneview');

    		menu_item.model['being-edited'] = true;
    	}


        $('.redactor_air').hide();
        this.selection.createMarkers();
        var width = this.$air.width(),
            m1 = this.$editor.find('#selection-marker-1').offset(),
            m2 = this.$editor.find('#selection-marker-2').offset()
        ;
        // Make sure we have both dimentions before proceeding
        if (!m1 || !m2) {
            return false;
        }

        var bounds = m2.top < m1.top ? {top: m2.top - 55, left: m2.left, right: m1.left, i:2} : {top: m1.top - 55, left: m1.left, right: m2.left, i:1},
            atRight = false,
            $win = $(window),
            winRight = $win.width() + $win.scrollLeft(),
            center, parent
        ;
        //Hack to place the bar correctly with floating images
        if(m1.top != m2.top && bounds.left > bounds.right)
            bounds.right = bounds.left + 50;

        if(!this.airWidth){
            this.airWidth = width;
            this.$air.width(width);
        }
        if(bounds.right < bounds.left || bounds.right > winRight){
            var parent = this.$editor.find('#selection-marker-' + bounds.i).parent();
            bounds.right =  Math.min(winRight, parent.offset().left + parent.width());
        }

        center = Math.floor((bounds.right + bounds.left + 1) / 2);

        if(center + width / 2 > winRight){
            this.$air.addClass('at-right');
            if(center > winRight)
                center = winRight - 5;
            bounds.left = center - width;
        }
        else {
            this.$air.removeClass('at-right');
            bounds.left = center - Math.floor((width + 1) / 2);
        }




        this.$air.css({
            left: bounds.left  + 'px',
            top: bounds.top + 'px'
        }).show();

        /**
         * If redactor is to high for the user to see it, show it under the selected text
         */
        if( this.$air.offset().top < 0 ){
            var ey = e && e.clientY ? e.clientY : this.$box.height();
            this.$air.css({
                top : ey + 14 + this.$box.position().top + "px"
            });
            this.$air.addClass("under");
        }else{
            this.$air.removeClass("under");
        }

        this.airBindHide();
        this.$air.trigger('show');
        this.dropdown.hideAll();
        UeditorEvents.trigger("ueditor:air:show", this);
        this.selection.restore();
    };


	hackedRedactor = true;

    /**
     * Overrides Redactor internal methods
     *
     * Override redactor methods by adding them in here and then change the body of method
     *
     * @type {{inline: {format: Overriden_Methods.inline.format}}}
     */
    var Overriden_Methods = {
        inline: {
            format: function(tag, type, value)
            {
                // Stop formatting pre and headers
                //if (this.utils.isCurrentOrParent('PRE') || this.utils.isCurrentOrParentHeader()) return;

                var tags = ['b', 'bold', 'i', 'italic', 'underline', 'strikethrough', 'deleted', 'superscript', 'subscript'];
                var replaced = ['strong', 'strong', 'em', 'em', 'u', 'del', 'del', 'sup', 'sub'];

                for (var i = 0; i < tags.length; i++)
                {
                    if (tag == tags[i]) tag = replaced[i];
                }

                this.inline.type = type || false;
                this.inline.value = value || false;

                this.buffer.set();

                if (!this.utils.browser('msie'))
                {
                    this.$editor.focus();
                }

                 this.selection.get();

                if (this.range.collapsed)
                {
                    this.inline.formatCollapsed(tag);
                }
                else
                {
                    this.inline.formatMultiple(tag);
                }

                if( tag && -1 !== _.indexOf( ["em", "italic"],tag.toLowerCase() ) ){ // add fix for em to make it work with list tags
                        this.selection.selectElement( $(this.selection.getInlines()).find("em") );
                }

                if( tag &&  -1 !== _.indexOf( ["strong", "bold"], tag.toLowerCase() )  ){ //  add fix for strong to make it work with list tags
                    this.selection.selectElement( $(this.selection.getInlines()).find("strong") );
                }
            }
        }
    };

	$.Redactor.prototype.events = UeditorEvents;

	// This method is only triggered via keyboard shortcuts, so override this
	// rather than overriding and re-implementing the shortcut dispatch.
	$.Redactor.prototype.shortcutsLoadFormat = function (e, cmd) {
		//e.preventDefault();
		Upfront.Util.log("Block styles keyboard shortcuts have been disabled");
	};

	$.Redactor.prototype.placeholderStart = function (html) {
		console.log('do nothing');
	};

	$.Redactor.prototype.button = function() {
		return {
            build: function(btnName, btnObject)
            {
                var $button = $('<a href="#" class="re-icon re-' + btnName + '" rel="' + btnName + '" title="'+btnObject.title+'" />').attr('tabindex', '-1');

                if (btnObject.func || btnObject.command || btnObject.dropdown)
                {
                    $button.on('touchstart click', $.proxy(function(e)
                    {
                        if ($button.hasClass('redactor-button-disabled')) return false;

                        var type = 'func';
                        var callback = btnObject.func;
                        if (btnObject.command)
                        {
                            type = 'command';
                            callback = btnObject.command;
                        }
                        else if (btnObject.dropdown)
                        {
                            type = 'dropdown';
                            callback = false;
                        }

                        this.button.onClick(e, btnName, type, callback);

                    }, this));
                }

                // dropdown
                if (btnObject.dropdown)
                {
                    var $dropdown = $('<div class="redactor-dropdown redactor-dropdown-box-' + btnName + '" style="display: none;">');
                    $button.data('dropdown', $dropdown);
                    this.dropdown.build(btnName, $dropdown, btnObject.dropdown);
                }



                return $button;
            },

            onClick: function(e, btnName, type, callback)
            {
                this.button.caretOffset = this.caret.getOffset();

                e.preventDefault();

                if (this.utils.browser('msie')) e.returnValue = false;

                if (type == 'command')
                {
                    this.inline.format(callback);
                }
                else if (type == 'dropdown')
                {
                    this.dropdown.show(e, btnName);
                }
                else
                {
                    var func;

                    if ($.isFunction(callback))
                    {
                        callback.call(this, btnName);
                        this.observe.buttons(e, btnName);
                    }
                    else if (callback.search(/\./) != '-1')
                    {
                        func = callback.split('.');
                        if (typeof this[func[0]] != 'undefined')
                        {
                            this[func[0]][func[1]](btnName);
                            this.observe.buttons(e, btnName);
                        }
                    }
                    else
                    {
                        this[callback](btnName);
                        this.observe.buttons(e, btnName);
                    }
                }
            },
            get: function(key)
            {
                return this.$toolbar.find('a.re-' + key);
            },
            setActive: function(key)
            {
                this.button.get(key).addClass('redactor-act');
            },
            setInactive: function(key)
            {
                this.button.get(key).removeClass('redactor-act');
            },
            setInactiveAll: function(key)
            {
                if (typeof key == 'undefined')
                {
                    this.$toolbar.find('a.re-icon').removeClass('redactor-act');
                }
                else
                {
                    this.$toolbar.find('a.re-icon').not('.re-' + key).removeClass('redactor-act');
                }
            },
            setActiveInVisual: function()
            {
                this.$toolbar.find('a.re-icon').not('a.re-html').removeClass('redactor-button-disabled');
            },
            setInactiveInCode: function()
            {
                this.$toolbar.find('a.re-icon').not('a.re-html').addClass('redactor-button-disabled');
            },
            changeIcon: function(key, classname)
            {
                this.button.get(key).addClass('re-' + classname);
            },
            removeIcon: function(key, classname)
            {
                this.button.get(key).removeClass('re-' + classname);
            },
            setAwesome: function(key, name)
            {
                var $button = this.button.get(key);
                $button.removeClass('redactor-btn-image').addClass('fa-redactor-btn');
                $button.html('<i class="fa ' + name + '"></i>');
            },
            addCallback: function($btn, callback)
            {
                var type = (callback == 'dropdown') ? 'dropdown' : 'func';
                var key = $btn.attr('rel');
                $btn.on('touchstart click', $.proxy(function(e)
                {
                    if ($btn.hasClass('redactor-button-disabled')) return false;
                    this.button.onClick(e, key, type, callback);

                }, this));
            },
            addDropdown: function($btn, dropdown)
            {
                var key = $btn.attr('rel');
                this.button.addCallback($btn, 'dropdown');

                var $dropdown = $('<div class="redactor-dropdown redactor-dropdown-box-' + key + '" style="display: none;">');
                $btn.data('dropdown', $dropdown);

                if (dropdown)
                {
                    this.dropdown.build(key, $dropdown, dropdown);
                }

                return $dropdown;
            },
            add: function(key, title)
            {
                if (!this.opts.toolbar) return;

                var btn = this.button.build(key, { title: title });
                btn.addClass('redactor-btn-image');

                this.$toolbar.append($('<li>').append(btn));

                return btn;
            },
            addFirst: function(key, title)
            {
                if (!this.opts.toolbar) return;

                var btn = this.button.build(key, { title: title });
                this.$toolbar.prepend($('<li>').append(btn));

                return btn;
            },
            addAfter: function(afterkey, key, title)
            {
                if (!this.opts.toolbar) return;

                var btn = this.button.build(key, { title: title });
                var $btn = this.button.get(afterkey);

                if ($btn.size() !== 0) $btn.parent().after($('<li>').append(btn));
                else this.$toolbar.append($('<li>').append(btn));

                return btn;
            },
            addBefore: function(beforekey, key, title)
            {
                if (!this.opts.toolbar) return;

                var btn = this.button.build(key, { title: title });
                var $btn = this.button.get(beforekey);

                if ($btn.size() !== 0) $btn.parent().before($('<li>').append(btn));
                else this.$toolbar.append($('<li>').append(btn));

                return btn;
            },
            remove: function(key)
            {
                this.button.get(key).remove();
            }
        };
	};


    $.Redactor.prototype.bindModuleMethods =  function(module)
    {

        if (typeof this[module] == 'undefined') return;

        // init module
        this[module] = this[module]();

        var methods = this.getModuleMethods(this[module]);
        var len = methods.length;

        // bind methods
        for (var z = 0; z < len; z++)
        {
            var method = this[module][methods[z]];
            if( Overriden_Methods[module] && Overriden_Methods[module][methods[z]] )
                method =  Overriden_Methods[module][methods[z]];

            this[module][methods[z]] = method.bind(this);
        }
    };

    var l10n = Upfront.Settings && Upfront.Settings.l10n
        ? Upfront.Settings.l10n.global.ueditor
        : Upfront.mainData.l10n.global.ueditor
    ; 

    /**
     * Proxy the Redactor l10n
     * This is so we're using Redactor string handling
     * with our own delivery mechanism.
     */
    $.Redactor.opts.langs['upfront'] = $.extend({}, $.Redactor.opts.langs['en'], {
        bold: l10n.bold,
        italic: l10n.italic
    });


};

var Ueditor = function($el, options) {
    this.active = false;
	//Allow user disable plugins
	var plugins = this.pluginList(options),
        self = this,
        unique_id = Upfront.Util.get_unique_id("redactor");
    this.$el = $el;
    this.$air = $("<div class='redactor_air upfront-ui'></div>").attr("id", unique_id ).hide();
    $("body").append(this.$air);
    if( !_.isEmpty(options.airButtons) ){
        options.buttons = options.airButtons;
    }
    this.options = $.extend({
			// Ueditor options
			autostart: true, //If false ueditor start on dblclick and stops on blur
			stateButtons: {},
            toolbarExternal: "#" + unique_id,
            // toolbarFixedTopOffset: 100,
        	// Redactor options
			air:true,
			linebreaks: true,
			disableLineBreak: false,
			focus: true,
			cleanup: false,
			plugins: plugins,
			airButtons: ['upfrontFormatting', 'bold', 'italic', 'blockquote', 'upfrontLink', 'stateLists', 'stateAlign', 'upfrontColor', 'upfrontIcons'],
            buttons: [ 'upfrontFormatting', 'bold', 'italic', 'blockquote', 'upfrontLink', 'stateLists', 'stateAlign', 'upfrontColor', 'upfrontIcons'],
			//buttons: ['formatting', 'bold', 'italic', 'deleted'],
			buttonsCustom: {},
			activeButtonsAdd: {},
			observeLinks: false,
			observeImages: false,
			formattingTags: ['h1', 'h2', 'h3', 'h4', 'p', 'pre'],
            inserts: ["image", "embed"],
            linkTooltip: false,
            cleanOnPaste: true, // font icons copy and paste wont work without this set to true - BUT, with it set to true, paste won't work AT ALL!!!
            replaceDivs: false,
            pastePlainText: false,
			imageEditable: false,
            replaceDivs: false,
            //cleanStyleOnEnter: false,
            //removeDataAttr: false,
            removeEmpty: false,
            imageResizable: false,
            lang: 'upfront' // <-- This is IMPORTANT. See the l10n proxying bit in `hackRedactor`
		}, options)
	;
	/* --- Redactor allows for single callbacks - let's dispatch events instead --- */
	this.options.dropdownShowCallback = function () { UeditorEvents.trigger("ueditor:dropdownShow", this); };
	this.options.dropdownHideCallback = function () { UeditorEvents.trigger("ueditor:dropdownHide", this); };
	this.options.initCallback = function () { UeditorEvents.trigger("ueditor:init", this); };
	this.options.changeCallback = function (e) { UeditorEvents.trigger("ueditor:change", this, e); };
	//this.options.pasteBeforeCallback = function (html) { UeditorEvents.trigger("ueditor:paste:before", this, html); }; //events can return anything so it's useless
	//this.options.pasteCallback = function (html) { UeditorEvents.trigger("ueditor:paste:after", this, html); }; //events can return anything so it's useless
	this.options.focusCallback = function () { UeditorEvents.trigger("ueditor:focus", this); };
	this.options.blurCallback = function () { UeditorEvents.trigger("ueditor:blur", this); };
	this.options.keyupCallback = function (e) { UeditorEvents.trigger("ueditor:key:up", this); };
	this.options.keydownCallback = function (e) { UeditorEvents.trigger("ueditor:key:down", this, e); };
	this.options.textareaKeydownCallback = function () { UeditorEvents.trigger("ueditor:key:down:textarea", this); };
	this.options.syncBeforeCallback = function (html) { UeditorEvents.trigger("ueditor:sync:before", this, html); return html; }; // <-- OOOH this one is different
	this.options.syncCallback = function (html) { UeditorEvents.trigger("ueditor:sync:after", this, html); $el.trigger('syncAfter', html); }; //Added syncAfter for east saving.
	this.options.autosaveCallback = function () { UeditorEvents.trigger("ueditor:autosave", this); };
	this.options.execCommandCallback = function (cmd, param) { UeditorEvents.trigger("ueditor:exec:" + cmd, this, param); }; // Do we need this? Yes, restore inserts on undo
	this.options.destroyCallback = function () { UeditorEvents.trigger("ueditor:destroy", this); };
	this.options.clickCallback = function (e) { UeditorEvents.trigger("ueditor:click", this, e); };
	// Also available ueditor events (not redactor callbacks:
		// ueditor:start
		// ueditor:stop
		// ueditor:method:<method>

	this.id = 'ueditor' + (Math.random() * 10000);

	if(this.options.autostart){
		if(this.options.startoninit)
			this.start();

		//this.startPlaceholder();
	}
	else {
		this.bindStartEvents();
		this.startPlaceholder();
	}

	//this.startPlaceholder();
	this.options.pasteCallback = function (html) {

        /** 
         * When pasting unformatted text with line breaks, the lines get wrapped
         * in DIV tags. This is due to browser's handling of pasted content inside
         * div having contenteditable=true. For our requirement, we have to replace
         * it with P tags instead, in addition we have to make custom replacements
         * for different use cases.
         */
        html = html.replace(/<div>/g, "<p>").replace(/<\/div>/g,"</p>");

        // release br caught within empty p tags
        html = html.replace(/<p><br><\/p>/g, "<br>");
        html = html.replace(/<p ([^>]*)><br><\/p>/g, "<br>");

        // if two consecutive paragraphs without a line break inbetween
        // merge the paragraphs and sepearate text with a br
        html = html.replace(/<\/p><p>/g, "<br>");
        html = html.replace(/<\/p><p ([^>]*)>/g, "<br>");

        // if a single line break between two paragraph
        // take out the line break
        html = html.replace(/<\/p><br><p>/g, "</p><p>");
        html = html.replace(/<\/p><br><p ([^>]*)>/g, "</p><p $1>");

        // if multile breaks between 2 paragraphs, replace with blank paragraph
        html = html.replace(/<\/p>([<br>])*<p>/g, "</p><p></p><p>");
        html = html.replace(/<\/p>([<br>])*<p ([^>]*)>/g, "</p><p></p><p $1>");

    

		/**
		 * If a font icon is copied to clipboard, paste it
		 */
		if( typeof self.font_icon !== "undefined" && self.font_icon !== false){
			return self.font_icon;
		}
		return html;
	};



    // Enter callback inside lists 
    this.options.enterCallback = function (e) { 
        // Current Block is a list item
        if(this.keydown.block.tagName === 'LI') {
            var current = this.selection.getCurrent(),
                $parent = $(current).closest('li'),
                $list = $parent.parent('ul,ol'),
                $listlist = $list.parent('li').parent('ul,ol'),
                emptyList = '<li>&#x200b;</li>'
            ;

            // Sublist to list
            if (
                $parent.length !== 0 && 
                $listlist.length !== 0 &&
                this.utils.isEmpty($parent.html()) && 
                $list.next().length === 0
            ) {
                var node = $(emptyList);
                $listlist.append(node);
                this.caret.setStart(node);
                $parent.remove();

                return false;
            }
            // List to paragraph
            else if (
                $parent.length !== 0 && 
                this.utils.isEmpty($parent.html()) && 
                $list.next().length === 0
            ) {
                var node = $(this.opts.emptyHtml);
                $list.after(node);
                this.caret.setStart(node);
                $parent.remove();

                return false;
            }
            // List 
            else {
                UeditorEvents.trigger("ueditor:enter", this, e);
            }
        }
        // Default
        else {        
            UeditorEvents.trigger("ueditor:enter", this, e);
        }
    };

};


/**
 * Make sure selection of text show's the air buttons
 */
UeditorEvents.on("ueditor:key:up", function(redactor){
    if( !_.isEmpty( redactor.selection.getText() ) ){
        redactor.airShow();
    }
});


Ueditor.prototype = {
	disableStop: false,
	mouseupListener: false,

	start: function(){
		var self = this;
		this.stopPlaceholder();
		this.hideLinkFlags();
        this.$el.addClass('ueditable')
			.removeClass('ueditable-inactive')
			.attr('title', '')
			.redactor(this.options)
		;
		this.$el.trigger('start', this);
		this.redactor = this.$el.data('redactor');
        this.redactor.$air = this.$air;
        this.redactor.ueditor = this;
		this.preventDraggable();
		UeditorEvents.trigger('ueditor:start', this.redactor);

		if(!Upfront.data.Ueditor)
			Upfront.data.Ueditor = {instances: {}};
		Upfront.data.Ueditor.instances[this.id] = this;

		//Open the toolbar when releasing selection outside the element
		this.mouseupListener = $.proxy(this.listenForMouseUp, this);
		this.$el.on('mousedown', this.mouseupListener);


		this.$el.on('keydown', function(e){
			self.cmdKeyA = false;
			self.cmdKey = false;

            /**
             * Clean unverified spans and remove their style attr
             */
            _.delay(function() {
                if (e.keyCode === 8) {
                    self.redactor.clean.clearUnverified();
                    self.redactor.$editor.find('span').not('[data-verified="redactor"]').removeAttr('style');
                }
            }, 2);

			setTimeout(function(){
				if(e.keyCode === 65 && e.metaKey ){
					self.cmdKeyA = true;
				}

				if(e.keyCode === 91 && e.metaKey ){
					self.cmdKey = true;
				}

				if(e.keyCode === 67 && e.metaKey ){
					self.onCopy(e);
				}
			});

            // Expand known text patterns
            if (32 === e.keyCode) self.expand_known_text_patterns();

			if(e.keyCode != 37 && e.keyCode != 39) {
				var current = $(self.redactor.selection.getCurrent());
				if(current.hasClass('uf_font_icon')) {
					self.redactor.caret.setAfter(current);
				}
				else if(current.parent().hasClass('uf_font_icon')) {
					self.redactor.caret.setAfter(current.parent());
				}

			}

		});


        // Open air when selecting text with keyboard
		this.$el.on('keyup', function(e){
			if(self.redactor && self.redactor.selection.getText() &&  [37, 38, 39, 40].indexOf( e.keyCode ) !== -1 || (e.keyCode === 65 && e.ctrlKey) || (self.cmdKeyA)  ){
				self.redactor.airShow(e);
			}
		});

		if(this.options.inserts){
			this.insertsSetUp();
		}

		//Listen for outer clicks to stop the editor if necessary
		if(!this.options.autostart)
			this.listenToOuterClick();

		$(document).on("keyup", $.proxy(this.stopOnEscape, this));

		this.active = true;

        this.$el.on('keyup', function(e) {
            /**
             * Make sure return doesn't delete the last charactor
             */
            if (13 === e.keyCode ) {
                self.redactor.utils.removeEmpty();
                $(self.redactor.selection.getCurrent()).append("&nbsp;")
            }
        });

	},
	stopOnEscape: function(e) {
			if(e.keyCode === 27 && !( $(".upfront-content-marker-contents").length && $(".upfront-content-marker-contents").data("ueditor") ) ){
				this.stop();
			}
	},

    /**
     * Expand the known text patterns in current block element
     */
    expand_known_text_patterns: function (e) {
        var redactor = this.redactor,
            rpl = {
                '##': {tag: 'h2'},
                '###': {tag: 'h3'},
                '####': {tag: 'h4'},
                '#####': {tag: 'h5'},
                '######': {tag: 'h6'},
                '>': {tag: 'blockquote'},
                '-': {tag: 'ul', nest: 'li'},
                '*': {tag: 'ul', nest: 'li'},
                '1.': {tag: 'ol', nest: 'li'},
                '1)': {tag: 'ol', nest: 'li'}
            }
        ;
        if (!redactor) return;

        redactor.selection.get();

        var node = redactor.selection.getBlock(),
            caret, $el, check
        ;
        if (!node) return;

        caret = redactor.caret.getOffsetOfElement(node);
        if (!caret) return;
        
        $el = $(node).clone();
        check = $el.text().substr(0, caret);

        if (!check) return;

        $.each(rpl, function (src, target) {
            if (src !== check) return true;

            var $node = $(node),
                rx = new RegExp('^' + src.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1") + ' ?'),
                text = $node.text().replace(rx, '')
            ;

            // Let's not do nested lists
            // or expansion within lists in general
            // or in PRE tags
            if ($node.is("li,ul,ol,pre")) return false;

            // Replace the selection tag with the one from the replacement map
            if ("nest" in target && target.nest) {
                $node.html(
                    '<' + target.tag + '><' + target.nest + '>' +
                        text + 
                    '</' + target.nest + '></' + target.tag + '>'
                );
            } else {
                var _node = document.createElement(target.tag);
                _node.innerHTML = text;
                $node.replaceWith( _node );

            }

            // Set caret position to end of the target
            redactor.caret.setEnd(
                "nest" in target && target.nest
                    ? $node.find(target.nest).last().get()
                    : _node
            );

            redactor.code.sync();
            /**
             * Make sure the created node doesn't contain the space created by the spacebar!
             */
            _.delay( function(){
               $(redactor.selection.getBlock()).html(text);
            }, 3 );


            return false;
        });
    },

	stop: function(){
		if(this.redactor){
			UeditorEvents.trigger('ueditor:stop', this.redactor);
			this.$el.trigger('stop');
			this.restoreDraggable();
			this.redactor.core.destroy();
            this.$air.remove();
            this.$el.removeClass('ueditable');
            this.redactor = false;
		}
		if ("undefined" !== typeof Upfront.data.Ueditor) delete Upfront.data.Ueditor.instances[this.id];
		this.startPlaceholder();
		$("html").off('mousedown', this.stopOnOutsideClick);
		$(document).off('keyup', this.stopOnEscape);
        this.active = false;
	},

	bindStartEvents: function() {
		var me = this;

		me.$el.addClass('ueditable-inactive')
			.attr('title', 'Double click to edit the text')
            .addClass('uf-click-to-edit-text')
			.one('dblclick', function(e){
				e.preventDefault();
				e.stopPropagation();
				if(!me.redactor)
					me.start(e);
			})
		;



		if(me.$el.prop('tagName') == 'DIV') {
			me.$el.on('click', 'i.visit_link', function() {
				me.visitLink($(this).attr('data-href'));
			});

			me.$el.on('mouseover', function() {
				if(me.$el.hasClass('ueditable-inactive'))
					me.displayLinkFlags();
			});
			me.$el.on('mouseout', function(e) {
				if($(e.relatedTarget).hasClass('visit_link'))
					return;
				me.hideLinkFlags();

			});
		}

        // Add warning flags to all the lightbox links if the lightbox is missing
        this.$el.find('a').each(function(){
            var href = $(this).attr('href');
            if(href && href.indexOf('#ltb-') > -1 && !Upfront.Util.checkLightbox(href))
                $(this).addClass('missing-lightbox-warning');
        });
	},
	displayLinkFlags: function() {
		var me = this;
		this.$el.find('a').each(function(){
			if($(this).find('i.visit_link').length > 0 || !$(this).attr('href') || $(this).text().trim() == '')
				return;
			$(this).css('position', 'relative');
			$(this).append('<i class="visit_link visit_link_'+me.guessLinkTypeTag($(this))+'" data-href="'+$(this).attr('href')+'"></i>');
			$(this).removeAttr('href');
			//$(this).attr('onclick', 'return false;');
		});
	},
	hideLinkFlags: function(area)  {
		this.$el.find('a').each(function() {
			$(this).css('position', '');
			$(this).attr('href', $(this).children('i.visit_link').attr('data-href'));
			$(this).children('i.visit_link').remove();
			//$(this).attr('onclick', '');
		});
	},
	visitLink: function(url) {
		var me = this;
		var linktype = me.guessLinkType(url);
		if(linktype == 'lightbox') {
			var regions = Upfront.Application.layout.get('regions');
			region = regions ? regions.get_by_name(me.getUrlanchor(url)) : false;
			if(region){
				//hide other lightboxes
				_.each(regions.models, function(model) {
					if(model.attributes.sub == 'lightbox')
						Upfront.data.region_views[model.cid].hide();
				});
				var regionview = Upfront.data.region_views[region.cid];
				regionview.show();
			}
		}
		else if(linktype == 'anchor') {
			var anchors = me.get_anchors();
			$('html,body').animate({scrollTop: $('#'+me.getUrlanchor(url)).offset().top},'slow');
		}
		else if(linktype == 'entry')
			window.location.href = url.replace('&editmode=true', '').replace('editmode=true', '')+((url.indexOf('?')>0)?'&editmode=true':'?editmode=true');
		else
			window.open(url);
	},
    /*validateEmail: function (email) {
        var re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(email);
    },*/
    guessLinkTypeTag: function(item){
        return item.data('upfront-link-type');
    },
	guessLinkType: function(url){
        var anchor = false;
		if(!$.trim(url) || $.trim(url) == '#')
			return 'unlink';

        if(url.indexOf('#') > -1) {
            anchor =this.getUrlanchor(url);
        }

		if(anchor) {
			return url.indexOf('ltb-') > -1 ? 'lightbox' : 'anchor';
        }
        // is it an email.
        if(url.indexOf('mailto:') === 0) {
            return 'email';
        }

		if(url.substring(0, location.origin.length) == location.origin)
			return 'entry';

		return 'external';
	},
	get_anchors: function () {
		var regions = Upfront.Application.layout.get("regions"),
			anchors = [];
		;
		regions.each(function (r) {
			r.get("modules").each(function (module) {
				if(module.get("objects")) {
                    module.get("objects").each(function (object) {
    					var anchor = object.get_property_value_by_name("anchor");
    					if (anchor && anchor.length) anchors[anchor] = object;
    				});
                }
			});
		});
		return anchors;
	},
	getUrlanchor: function(url) {
		// this does almost the opposite of the above function

		if(typeof(url) == 'undefined') var url = $(location).attr('href');

		if(url.indexOf('#') >=0) {
			var tempurl = url.split('#');
			return tempurl[1];
		} else return false;
	},
	insertsSetUp: function(){
		var me = this,
			manager = new InsertManager({el: this.$el, insertsData: this.options.insertsData, inserts: this.options.inserts, ueditor: this}),
			redactorEvents = this.redactor.events
		;

		this.insertManager = manager;

		var handler = $.proxy(manager.bindTriggerEvents, manager);
		redactorEvents.on("ueditor:init", handler);
		redactorEvents.on("ueditor:enter", handler);
		redactorEvents.on("ueditor:insert:media", handler);
		redactorEvents.on("ueditor:sync:after", function(){
			me.insertManager.parseMarkup();
		});

		manager.on('insert:prechange', function(){
			//TODO: focus before bufferSet

			//Store the state to allow undo
			var selection = me.redactor.selection.get();
			me.redactor.buffer.set();
		});
		this.manager = manager;
		this.redactorEvents = redactorEvents;
		manager.on('insert:added insert:removed', function(){
			me.redactor.events.trigger("ueditor:insert:media");
			if (me.redactor.code && me.redactor.code.sync) me.redactor.code.sync();
		});
		UeditorEvents.on( 'cleanUpListeners', $.proxy(this.cleanUpListeners, this));
	},
	cleanUpListeners: function() {
		this.redactorEvents.off("ueditor:init");
		this.redactorEvents.off("ueditor:enter");
		this.redactorEvents.off("ueditor:insert:media");
		this.redactorEvents.off("ueditor:sync:after");
		this.manager.off('insert:prechange');
		this.manager.off('insert:added insert:removed');
		$("html").off('mousedown', this.stopOnOutsideClick);
		this.redactorEvents.off('cleanUpListeners');
		$(document).off('click.redactor-image-delete');
	},

	listenToOuterClick: function(){
		var me = this;
		if(!this.checkInnerClick){
			this.checkInnerClick = function(e){
				//Check we are not selecting text
				/*var selection = document.getSelection ? document.getSelection() : document.selection;
				if(selection && selection.type == 'Range')
					return;
				*/
				//Check if the click has been inner, or inthe popup, otherwise stop the editor
				if(!me.options.autostart && me.redactor){
					//var $target = $(e.target);
					//if(!me.disableStop && !$target.closest('.redactor_air').length && !$target.closest('.ueditable').length){
					//	me.stop();
					//	me.bindStartEvents();
					//}
					me.stop();
				}
			};
		}
		$("html").on('mousedown', {ueditor : me}, this.stopOnOutsideClick);
	},
	stopOnOutsideClick: function(e){
		if( !( $(e.target).hasClass("redactor_box")
				|| $(e.target).parents().hasClass("redactor-box")
				|| $(e.target).parents().hasClass("redactor_air")
                || $(e.target).parents().hasClass("redactor-toolbar")
                || $(e.target).parents().hasClass("use_selection_container") // Todo Sam:, make this more general
                || $(e.target).parents().is("#upfront-popup")
                || $(e.target).parents().hasClass("upfront-inserts-markup-editor")
				|| $(e.target).parents().hasClass("redactor-dropdown"))
			&& $(e.target).parents("#upfront-popup.upfront-postselector-popup").length === 0)
		{
			e.data.ueditor.stop();
		}
	},
	callMethod: function(method){
		var result = this.$el.redactor(method);
		UeditorEvents.trigger("ueditor:method:" + method, this.$el.redactor);
		return result;
	},
	startPlaceholder: function() {

		var placeholder = this.options.placeholder;
		if (this.$el.attr('placeholder')) placeholder = this.$el.attr('placeholder');
		if (placeholder === '') placeholder = false;
		if (placeholder !== false && $.trim(this.$el.text()).length === 0)
		{
			//remove existing placeholder
			this.$el.parent().children('.ueditor-placeholder').remove();
			this.$placeholder = this.$el.clone(false);
			this.$placeholder.attr('contenteditable', false).removeClass('ueditable redactor_editor').addClass('ueditor-placeholder').html(placeholder);
			this.$el.after(this.$placeholder);

			var $parent = this.$el.parent();
			if ($parent.css('position') == 'static')
				$parent.css('position', 'relative');
			if (this.$el.css('position') == 'static' )
				this.$el.css('position', 'relative');
			this.$el.css('z-index', 1);
			var pos = this.$el.position();
			this.$placeholder.css({
				'position': 'absolute',
				'z-index': '0',
				'top': pos.top,
				'left': pos.left,
				'right': $parent.outerWidth() - (pos.left + this.$el.outerWidth())
			});

			//Make sure that the editor has one line of text
			this.$el.html('&nbsp;');
			this.options.placeholder = placeholder;
			var me = this;

			//setTimeout(function() { console.log(me.$el.parent().html());}, 200);
		}
	},
	stopPlaceholder: function() {
		if (this.$placeholder)
			this.$placeholder.remove();
		if(this.$el.html() == '&nbsp;')
			this.$el.html('');
	},
	preventDraggable: function(){
		//Prevent dragging from editable areas
		var draggable = this.$el.closest('.ui-draggable'),
			cancel = draggable.draggable('option', 'cancel')
		;
		if(_.isString(cancel) && cancel.indexOf('.ueditable') == -1){
			draggable.draggable('option', 'cancel', cancel + ',.ueditable');
		}
	},
	restoreDraggable: function(){
		var draggable = this.$el.closest('.ui-draggable'),
			cancel = draggable.draggable('option', 'cancel')
		;
		if(_.isString(cancel) && cancel.indexOf('.ueditable') != -1){
			draggable.draggable('option', 'cancel', cancel.replace(/,\.ueditable/g, ''));
		}
	},
	pluginList: function(options){
		var allPlugins = ['stateAlignmentCTA', 'stateAlignment', 'stateLists', 'blockquote', 'stateButtons', 'upfrontLink', 'upfrontColor', 'upfrontFormatting', 'upfrontIcons', 'upfrontSink', 'upfrontPlaceholder',  'panelButtons'],

			pluginList = []
		;
		$.each(allPlugins, function(i, name){
			if(typeof options[name] == 'undefined' || options[name])
				pluginList.push(name);
		});
		return pluginList;
	},
	listenForMouseUp: function(){
		var me = this;
		if(!me.redactor)
			me.redactor = me.$el.data('redactor');
		if(me.redactor)
			me.redactor.waitForMouseUp = true;

		$(document).one('mousedown', function(e) {
			if(!me.clickcount)
				me.clickcount = 0;
			me.clickcount = me.clickcount+1;
			me.lastmousedown = {x: e.pageX, y: e.pageY};
			if(me.clickcount > 0)
				setTimeout(function() { me.clickcount = 0 }, 400);
		});

		$(document).one('mouseup', function(e){
            if(!me.redactor)
                return;
			//var is_selection = ((Math.abs(e.pageX-me.lastmousedown.x) + Math.abs(e.pageY-me.lastmousedown.y)) > 2);
            var is_selection = !!me.redactor.selection.getText();

			if((is_selection || me.clickcount > 1) && me.redactor && me.redactor.waitForMouseUp && me.redactor.selection.getText()){
				me.redactor.airShow(e);
				me.redactor.$element.trigger('mouseup.redactor');
			}
			else
				$('.redactor_air').hide();

			if($(e.target).hasClass('uf_font_icon')) {
                // Todo Gagan: had to comment the following to allow the font icon to be selected, hope this doesn't brean anything
				//if(e.pageX < ($(e.target).offset().left + $(e.target).width()/2))
				//	me.redactor.caret.setBefore($(e.target));
				//else
				//	me.redactor.caret.setAfter($(e.target));
			}
		});

	},
	getValue: function(is_simple_element){
		var html = this.redactor.$element.html();
		if(this.insertManager)
			html = this.insertManager.insertExport(html, is_simple_element),
            $html =  $("<div>").html( html );

        $html.find(".redactor-selection-marker").remove();
        /**
         * Make sure the wrapping .plain-text-container is not being returned as html
         */
        return $.trim(
            // Conditionally nuke the wrapper - only if we actually have it
            $(html).find(".plain-text-container").length
                ? $html.find(".plain-text-container").last().html()
                : $html.html()
        );
	},
	getInsertsData: function(){
		var insertsData = {};
		if(!this.insertManager)
			return {};

		_.each(this.insertManager._inserts, function(insert){
			insertsData[insert.data.id] = insert.data.toJSON();
		});

		return insertsData;
	},
	onCopy: function(e){
		var sel = window.getSelection(),
			self = this;
		self.font_icon = false;
		if(!_.isUndefined(  sel.anchorNode ) && sel.anchorNode.className === "uf_font_icon" ){
			var icon = document.createElement("span");
			icon.className = "uf_font_icon";
			icon.style.cssText = sel.anchorNode.style.cssText;
			var html = $.trim(sel.toString());
			html = html.replace(/\$/g, '&#36;');
			html = html.replace(/”/g, '"');
			html = html.replace(/“/g, '"');
			html = html.replace(/‘/g, '\'');
			html = html.replace(/’/g, '\'');

			icon.innerHTML = html;

			setTimeout( function(){
				if( self.redactor.$pasteBox === false ){
					self.redactor.paste.createPasteBox();
				}
				self.redactor.$pasteBox.html(icon);
				self.font_icon = icon.outerHTML;
			}, 1 );

		}
	}
};

var InsertManagerInserts = Backbone.View.extend({
    tpl: _.template($(tpl).find('#insert-manager-tooltip-tpl').html()),
    className: "ueditor-post-insert-manager",
    $block: false,
    initialize: function(options){
        this.insertsData = options.insertsData || {};
        this.inserts = options.inserts || {};
        this.redactor = options.redactor;
        this.onRemoveInsert = options.onRemoveInsert;
        this.listenTo( UeditorEvents, "ueditor:insert:relocate", this.insert_relocate );
				var me = this;
				this.listenTo( UeditorEvents, 'cleanUpListeners', function() {
					me.stopListening();
				});
    },
    events:{
        "click .uinsert-selector-option": "on_insert_click",
        "click .upfront-post-media-trigger": "toggle_inserts"
    },
    render: function(){
      this.$el.html( this.tpl( { inserts: _.pick(Inserts.inserts, this.inserts), names: Inserts.NAMES } ) );
    },
    insert_relocate: function( $current ){
      this.$block = $current;
    },
    toggle_inserts: function(e){
        e.preventDefault();
        e.stopPropagation();
        this.$el.find(".uinsert-selector").toggle();
    },
    on_insert_click: function( e ){
        e.preventDefault();
        e.stopPropagation();
        var type = $(e.target).data('insert'),
            insert = new Inserts.inserts[type](),
            self = this
            ;

        /**
         * Todo Sam: remove __insert and try to find why sometimes insert doesn't get found inside the done event
         */
        this.__insert = insert;
        insert.start( this.$el, this.redactor.$editor )
            .done(function(args, resolved_insert){

                /**
                 * Allows to get resolved insert from inserts with insert managers
                 */
                if(_.isArray(args) ){
                    var popup = args[0],
                        results = args[0],
                        insert = resolved_insert;
                }else{
                    var popup = args,
                        results = resolved_insert,
                        insert = insert || self.__insert
                    ;

                }

                // if(!results) Let's allow promises without result for now!
                //	return;
                self.inserts[insert.cid] = insert;
                //Allow to undo
                //this.trigger('insert:prechange'); // "this" is the embedded image object
                //self.trigger('insert:prechange'); // "self" is the view
                //Create the insert
                //insert.render();
                if( self.is_last_p() ){
					self.$block.before(insert.$el);
                }else{

                    if(self.redactor.$element.find(self.$block).length < 1) {
/*                        if(self.redactor.$element.hasClass('redactor-placeholder')) {
                    
                            var f = jQuery.Event("keydown");
                            f.which = 65;
                            f.keyCode = 65;// # Some key code value
                              
                            
                            
                            self.redactor.$element.trigger(f);

                        }
*/
                        self.redactor.$element.append(self.$block);  
                    }

                    self.$block.replaceWith(insert.$el);
				}

                self.$block.prev("br").remove();
                //self.trigger('insert:added', insert);
                self.insertsData[insert.data.id] = insert.data.toJSON();
                self.listenTo(insert.data, 'change add remove update', function(){
                    self.insertsData[insert.data.id] = insert.data.toJSON();
                });

                setTimeout(function(){
                    $(".uinsert-selector").hide();
                    $(".ueditor-post-insert-manager").hide();
                }, 100);

                self.redactor.code.sync();
                self.listenTo(insert, 'remove', self.onRemoveInsert);
            })
        ;
    },
	is_last_p: function(  ){
		var $ps = this.redactor.$element.find("p");
		return _.indexOf( $ps, this.$block[0] ) === ( $ps.length - 1 );
	}

});
var InsertManager = Backbone.View.extend({
    tpl: _.template($(tpl).find('#insert-manager-tpl').html()),
	initialize: function(opts){
		this.inserts = opts.inserts || {};
        this._inserts = {};
        this.ueditor = opts.ueditor;
		this.onRemoveInsert = _.bind(this.removeInsert, this);
		this.insertsData = opts.insertsData || {};
		this.deletedInserts = {};
		this.$el.children().addClass('nosortable');
		this.insertLookUp();
		this.bindTriggerEvents();
		this.refreshTimeout = false;
		this.sortableInserts();
		this.render_tooltips();

		if( opts.ueditor.options.inserts ){
			this.listenTo( UeditorEvents, "ueditor:click", this.position_tooltips );
			this.listenTo( UeditorEvents, "ueditor:key:up", this.position_tooltips );
		}
		var me = this;
		this.listenTo( UeditorEvents, 'cleanUpListeners', function() {
			me.stopListening();
		});
	},
    render_tooltips: function(){
        if( !this.ueditor.options.inserts ||  this.ueditor.options.inserts.length === 0 ) return;

        var self = this,
            tooltips = new InsertManagerInserts({
            insertsData: this.insertsData,
            inserts: this.inserts,
            redactor: this.ueditor.redactor,
            onRemoveInsert: this.onRemoveInsert
        });
        tooltips.render();
        this.ueditor.$el.after( tooltips.$el );
        this.$tooltips = tooltips.$el;
    },
    position_tooltips: function(redactor){
        if( !this.$tooltips ) return;

        var $current = $( redactor.selection.getCurrent());
        if( this.show_tooltip_in_this_location( redactor ) ){
			if( typeof $current[0] === "undefined" || !_.isElement($current[0]) ) return;
            var css = _.extend( $current.position(), { marginLeft: _.isArray($current) && _.isElement($current[0]) ?   $current.css("padding-left") : 0 } );
            this.$tooltips.css( css );
            this.$tooltips.show();
            UeditorEvents.trigger("ueditor:insert:relocate", $current);
        }else{
            this.$tooltips.hide();
        }
    },
	bindTriggerEvents: function (redactor) {
		var me = this,
			parent = this.$el.parent(),
			root_offset = this.$el.offset(),
			updateTrigger = $.proxy(this.updateMediaTriggerPosition, this),
			onMousemove = function(e){
				if($(e.target).parent()[0] != me.$el[0] || !me.currentBlock)
					return;

				if(!this.ticking){
					Upfront.Util.requestAnimationFrame(updateTrigger);
					ticking = true;
				}
				var height = me.currentBlock.height(),
					position = e.offsetY / height
				;

				me.triggerPosition = height > 60 ? position : Math.round(position);
			},
			onMouseenter = function(e){
				if($(e.target).parent()[0] != me.$el[0])
					return;
				me.currentBlock = $(e.currentTarget);
			},
			onMouseleave = function(e){
				if($(e.target).parent()[0] != me.$el[0] || !me.currentBlock)
					return;

				me.lastBlock = me.currentBlock;
				if(me.currentBlock[0] == e.currentTarget){
					me.currentBlock = false;
					me.mediaTrigger.removeClass('upfront-post-media-trigger-visible');
				}
			},
			bindMouseEvents = function(){
				me.$el
					.on('mousemove', 'p,div:not(.ueditor-insert),ul,ol', onMousemove)
					.on('mouseenter', 'p,div:not(.ueditor-insert),ul,ol', onMouseenter)
					.on('mouseleave', 'p,div:not(.ueditor-insert),ul,ol', onMouseleave)
				;
			}
		;
		var ed = this.$el.data("ueditor");
		// Since callback was commented out, I [Ivan] ditched this whole if statement.
		// If it's ever re-enabled than it needs to clean up after itself i.e.
		// remove 'on' listener for 'ueditor:stop', otherwise it causes Redactor node leak
		// if (ed && ed.redactor) {
			// ed.redactor.events.on("ueditor:stop", function () {
				// //me.currentBlock = me.lastBlock = false;
			// });
		// }

		this.ticking = false;

		//Left marker used to place the trigger correctly when
		// there is an isert floated to the left
		this.leftMarker = $('<span style="float:left">');

		//bindMouseEvents();


	},

	updateMediaTriggerPosition: function(){
		var marginLeft,
			leftMarker = this.leftMarker
		;
		if(this.currentBlock){
			if(this.triggerPosition > 0.7){
				this.currentBlock.append(leftMarker);
				marginLeft = leftMarker.offset().left - this.currentBlock.offset().left;
				leftMarker.detach();
				this.mediaTrigger
					.addClass('upfront-post-media-trigger-visible upfront-post-media-trigger')
					.data('insert', 'after')
					.css({top: this.currentBlock.position().top + this.currentBlock.height(), 'margin-left': marginLeft + 'px'});
			}
			else if(this.triggerPosition < 0.3){
				this.currentBlock.prepend(leftMarker);
				marginLeft = leftMarker.offset().left - this.currentBlock.offset().left;
				leftMarker.detach();
				this.mediaTrigger
					.addClass('upfront-post-media-trigger-visible upfront-post-media-trigger')
					.data('insert', 'before')
					.css({top: this.currentBlock.position().top, display: 'block', 'margin-left': marginLeft + 'px'});
			}
			else
				this.mediaTrigger.removeClass('upfront-post-media-trigger-visible');
		}
	},

	insertLookUp: function(){
		var me = this,
			insertsData = _.extend({}, me.insertsData, me.deletedInserts)
		;

		_.each(_.pick(Inserts.inserts, this.inserts), function(Insert){
			_.extend(me._inserts, Insert.prototype.importInserts(me.$el, insertsData, me.inserts));
		});

		_.each(me._inserts, function(insert){
			me.insertsData[insert.data.id] = insert.data.toJSON();

			// Listen to the inserts model to update the data on any change
			me.stopListening(insert.data);
			me.listenTo(insert.data, 'change add remove update', function(){
				if(me.insertsData[insert.data.id])
					me.insertsData[insert.data.id] = insert.data.toJSON();
			});

			me.listenTo(insert, 'remove', me.onRemoveInsert);
		});

		//Force first sync
		this.trigger('insert:added');
	},

	removeInsert: function(insert){
		this.trigger('insert:prechange');
		insert.$el.detach();
		this.trigger('insert:removed');
	},

	insertExport: function(html, is_simple_element){
		var $html = $('<div>').html(html);
		$html.find('.nosortable').removeClass('nosortable');
		_.each(this._inserts, function(insert){
			var elementId = '#' + insert.data.id,
				out = is_simple_element ? insert.getSimpleOutput() : insert.getOutput()
			;
			$html.find(elementId).replaceWith(out);
		});
		return $html.html();
	},

	parseMarkup: function(){
		var me = this;
		if(this.refreshTimeout)
			clearTimeout(this.refreshTimeout);

		this.refreshTimeout = setTimeout(function(){
			_.each(me.deletedInserts, function(insert, id){
				var element = me.$el.find('#' + id);
				if(element.length){
					me._inserts[id] = insert;
					delete me.deletedInserts[id];/*

					//We need to re-create the controls in order to make them work again
					element.replaceWith(insert.el);
					insert.createControls();
					if(insert.controls)
						insert.$el.append(insert.controls.el);
					insert.delegateEvents();*/
				}
			});
			_.each(me._inserts, function(insert, id){
				if(!insert.$el.parent().length){
					var element = me.$el.find('#' + id);
					if(element.length){
						element.replaceWith(insert.el);
						insert.delegateEvents();
						insert.controls.delegateEvents();
						if(insert.controlEvents)
							insert.controlEvents();
					}
					else{
						me.deletedInserts[id] = insert;
						delete me._inserts[id];
					}
				}
			});
			me.$el.children(':not(.ueditor-insert), :not(.ueditor-post-insert-manager)').addClass('nosortable');
		}, 600);
	},

	sortableInserts: function(){
		var me = this;
		me.$el.sortable({cancel: '.nosortable', helper: 'clone', handle: '.uinsert-drag-handle'})
			.on('sortstart', function(e, ui){
				console.log('Sort start');
				ui.placeholder.width(ui.helper.width());
				if(ui.item.css('float') != 'none')
					ui.helper.css({marginTop: e.offsetY});
			});
	},
	show_tooltip_in_this_location: function(redactor){
		var $block = $( redactor.selection.getCurrent());

		if(_.isEmpty( $block ) ) return false;

		var $image_embed_insert_wrappers = $(".upfront-inserted_image-wrapper, .upfront-inserted_embed-wrapper"),
			block_top = $block.offset().top,
			show_tooltip = true;
		$image_embed_insert_wrappers.each(function(){
			var $this = $(this),
				height = $this.find(".ueditor-insert-variant-group").height(),
				top = $this.offset().top;
			if( block_top <= ( height + top + 20) && block_top >= ( top - 5)  ){
				show_tooltip = false;
			}
		});

		return 	show_tooltip
				&& 	$block.closest(".ueditor-insert").length === 0
				&&  ( $.trim( $block.html() ) === "<br>" || ( typeof $block.closest("p.nosortable").html() !== "undefined" &&  $.trim( $block.closest("p.nosortable").html() ) === "" ) ) ;
	}
});

var ImagesHelper = {
	Image: {
		redactor: false,
		selector: ".upfront-inserted_image-wrapper",
		bind_events: function () {
			this.unbind_events();
			this.redactor.$editor
				.on("mouseover", this.selector, this, this.hover_on)
				.on("mouseout", this.selector, this, this.hover_off)

				.on("mouseenter", ":not(" + this.selector + ")", this, this.hover_off)
			;
		},
		unbind_events: function () {
			this.redactor.$editor
				.off("mouseover", this.selector, this.hover_on)
				.off("mouseout", this.selector, this.hover_off)

				.off("mouseenter", ":not(" + this.selector + ")", this, this.hover_off)
			;
			this.remove_dialog();
		},
		hover_on: function (e) {
			var $me = $(e.target),
				$dialog = $("#upfront-image-details")
			;
			if (!$me.is(e.data.selector)) $me = $me.closest(e.data.selector);
			if (!$me.find('img').length) return;

			e.data.show_dialog($me);

			Upfront.Events.trigger("upfront:editor:image_on", $me.get());
		},
		hover_off: function (e) {
			var $me = $(e.target);
				$isParent = $(e.toElement).closest("#upfront-image-details")
			;
			if (!$isParent.length) e.data.remove_dialog();
		},
		create_dialog: function () {
			if ( $("#upfront-image-details").length ) return;
			var $dialog = $("<div id='upfront-image-details' class='upfront-ui' />");
			$dialog.append(
				'<div class="upfront-image-orientation">' +
					'<div class="upfront-image-align-left upfront-icon upfront-icon-image-left">left</div>' +
					'<div class="upfront-image-align-center upfront-icon upfront-icon-image-center">center</div>' +
					'<div class="upfront-image-align-right upfront-icon upfront-icon-image-right">right</div>' +
					'<div class="upfront-image-align-full upfront-icon upfront-icon-image-full">full width</div>' +
				'</div>' +
				'<div class="upfront-image-actions">' +
					'<div class="upfront-image-action-change upfront-icon upfront-icon-image-select">Change Image</div>' +
					'<div class="upfront-image-action-details upfront-icon upfront-icon-image-detail">Image Details</div>' +
				'</div>' +
				'<div class="upfront-image-delete upfront-icon-button upfront-icon-button-delete"></div>'
			);
			$('body').append($dialog);
			$dialog
				.find(".upfront-image-align-left").on("click", this, this.Align.left).end()
				.find(".upfront-image-align-center").on("click", this, this.Align.center).end()
				.find(".upfront-image-align-right").on("click", this, this.Align.right).end()
				.find(".upfront-image-align-full").on("click", this, this.Align.full).end()

				.find(".upfront-image-action-change").on("click", this, this.change_image).end()
				.find(".upfront-image-action-details").on("click", this, this.Details.toggle).end()

				.find(".upfront-image-delete").on("click", this, this.delete_image).end()
			;
			$dialog.hide();
		},
		remove_dialog: function (force, del) {
			var $dialog = $("#upfront-image-details"),
				$details = $("#upfront-image-details-image_details")
			;
			if (!$details.length){
				$dialog.hide();
				$('#upfront-inline-slider-nav').hide();
			}
			else if (force) {
				$details.remove();
				$dialog.hide();
			}
			if (force && del)
				$dialog.remove();
		},
		show_dialog: function ($wrap) {
			var $dialog = $("#upfront-image-details");
			$dialog.data('ref', $wrap.get(0));
			if ( $wrap.hasClass('upfront-inserted_image-slider') || $wrap.hasClass('upfront-inserted_image-gallery') )
				$dialog.addClass('no-orientation');
			else
				$dialog.removeClass('no-orientation');

			var off = $wrap.offset(),
				height = $wrap.outerHeight(),
				width = $wrap.outerWidth(),
				dialog_height = $dialog.outerHeight();

			$dialog.css({
				top: off.top + ( dialog_height > height ? 0 : height-dialog_height ),
				left: off.left,
				width: width
			});
			$dialog.show();
		},
		get_target: function (target){
			return $($(target).closest("#upfront-image-details").data('ref'));
		},
		change_image: function (e) {
			var $img = e.data.get_target(e.target);
			Upfront.Media.Manager.open({
				multiple_selection: false,
				button_text: "Change image"
			}).done(function (popup, result) {
				if (!result) return false;
				if (!result.length) return false;
				var html = Upfront.Media.Manager.results_html(result);
				$img.replaceWith(html);
				e.data.redactor.code.sync();
				e.data.bind_events();
			});
			return false;
		},
		delete_image: function (e) {
			var $img = e.data.get_target(e.target),
				$wrapper = $img.parent(),
				is_on_slider = $wrapper.hasClass('upfront-inline_post-slider'),
				is_on_gallery = $wrapper.hasClass('upfront-inline_post-gallery');
			if ( ( is_on_slider || is_on_gallery ) && $wrapper.find('img') == 1 )
				$wrapper.remove();
			else
				$img.remove();
			if ( is_on_slider )
				Slider.reset_nav($wrapper);
			e.data.redactor.code.sync();
			e.data.redactor.focus();
			return false;
		},
		Align: {
			_apply: function ($img, data) {
				data = $.extend({
					float: "",
					"text-align": "",
					"width": ""
				}, data);
				$img.css(data);
			},
			left: function (e) {
				var $wrap = e.data.get_target(e.target),
					$img = $wrap.find('img');
				e.data.Align._apply($wrap, {float: "left"});
				e.data.Align._apply($img, {});
				e.data.show_dialog($wrap);
				Upfront.Events.trigger("upfront:editor:image_align", $wrap.get(), 'left');
				e.data.redactor.code.sync();
				return false;
			},
			center: function (e) {
				var $wrap = e.data.get_target(e.target),
					$img = $wrap.find('img');
				e.data.Align._apply($wrap, {
					"text-align": "center"
				});
				e.data.Align._apply($img, {});
				e.data.show_dialog($wrap);
				Upfront.Events.trigger("upfront:editor:image_align", $wrap.get(), 'center');
				e.data.redactor.code.sync();
				return false;
			},
			right: function (e) {
				var $wrap = e.data.get_target(e.target),
					$img = $wrap.find('img');
				e.data.Align._apply($wrap, {float: "right"});
				e.data.Align._apply($img, {});
				e.data.show_dialog($wrap);
				Upfront.Events.trigger("upfront:editor:image_align", $wrap.get(), 'right');
				e.data.redactor.code.sync();
				return false;
			},
			full: function (e) {
				var $wrap = e.data.get_target(e.target),
					$img = $wrap.find('img');
				e.data.Align._apply($wrap, {});
				//e.data.Align._apply($img, {width: "100%"});
				e.data.show_dialog($wrap);
				Upfront.Events.trigger("upfront:editor:image_align", $wrap.get(), 'full');
				e.data.redactor.code.sync();
				return false;
			}
		},
		Details: {
			toggle: function (e) {
				var $dialog = $("#upfront-image-details"),
					$details = $("#upfront-image-details-image_details")
				;
				if ($details.length) e.data.Details.close(e);
				else e.data.Details.open(e);
				return false;
			},
			open: function (e) {
				var $wrapper = e.data.get_target(e.target),
					$img = $wrapper.find("img"),
					$dialog = $("#upfront-image-details"),
					$button = $dialog.find('.upfront-image-action-details'),
					$details = $('<div id="upfront-image-details-image_details" />'),
				// Gather data for form preset population
					$link = $wrapper.find("a"),
					no_link = !$link.length ? 'checked="checked"' : '',
					popup_link = $link.length && $link.is(".popup") ? 'checked="checked"' : '',
					link_link = $link.length && $link.attr("href").match(/^[^#]+/) ? 'checked="checked"' : '',
					link_value = $link.length && !!link_link ? $link.attr("href") : ''
				;
				$details.append(
					'<div class="upfront-image-detail-alt">' +
						'<label class="upfront-field-label">Image Details:</label>' +
						'<input class="upfront-field upfront-field-text" type="text" placeholder="Alt" value="' + $img.attr("alt") + '" />' +
					'</div>' +
					'<div class="upfront-image-detail-link">' +
						'<label class="upfront-field-label">Image links to:</label>' +
						'<ul>' +
							'<li><label><input class="upfront-field-radio" type="radio" ' + no_link + ' name="link_to" value="" /> No link</label></li>' +
							'<li><label><input class="upfront-field-radio" type="radio" ' + popup_link + ' name="link_to" value="popup" /> Larger version (opens in lightbox)</label></li>' +
							'<li><label><input class="upfront-field-radio" type="radio" ' + link_link + ' name="link_to" value="link" /> Link <input class="upfront-field upfront-field-text" type="text" placeholder="http://www.google.com" value="' + link_value + '" /></label></li>' +
							'<li><label><input class="upfront-field-radio" type="radio" name="link_to" value="post" /> Post or page <em>/your-cool-post/</em></label></li>' +
						'</ul>' +
					'</div>' +
					'<button class="upfront-image-detail-button" type="button">OK</button>'
				);
				/*$details.on('focus', '.upfront-image-detail-link li :text', function(e){
					$(this).siblings(':radio').prop('checked', true);
				});*/
				$details.css({
					position: "absolute",
					top: $button.offset().top + $button.height(),
					"z-index": 99
				});
				$("body").append($details);
				$details.css({
					left: $button.offset().left + 46 - ($details.width()/2),
				});
				$button.addClass('upfront-image-action-details-active');

				$details.on("click", "button", e.data, e.data.Details.apply_details);
			},
			close: function (e) {
				var $dialog = $("#upfront-image-details"),
					$button = $dialog.find('.upfront-image-action-details'),
					$details = $("#upfront-image-details-image_details");
				$button.removeClass('upfront-image-action-details-active');
				$details.remove();
			},
			apply_details: function (e) {
				var $dialog = $("#upfront-image-details"),
					$details = $("#upfront-image-details-image_details"),
					$wrapper = $($dialog.data('ref')),
					$img = $wrapper.find("img"),
					$old_link = $wrapper.find("a"),
				// Data changes to apply
					alt = $details.find(".upfront-image-detail-alt :text").val(),
					link_to = $details.find(".upfront-image-detail-link :radio:checked").val(),
					link_url = $details.find(".upfront-image-detail-link :text").val()
				;

				$img.attr("alt", alt);

				if (link_to) {
					var $link = $old_link.length ? $old_link : $('<a href="#" />');
					switch (link_to) {
						case "popup":
							$link.addClass("popup");
							break;
						case "link":
							$link.attr("href", link_url);
							break;
						case "post":
							$link.attr("href", 'http://localhost/upfront/edit/post/8');
							break;
					}
					if (!$old_link.length) $img.wrapAll($link);
				} else if ($old_link.length) {
					$old_link.replaceWith($img);
				}
				e.data.redactor.code.sync();
				return e.data.Details.close(e);
			}
		},
		cleanup: function (content) {
			var $cnt = $("<div />").append(content);
			$cnt.find("#upfront-image-details").remove();
			return $cnt.html();
		}
	},
	Gallery: {
		to_html: function (redactor) {
			var content = redactor.$editor.html(),
				edited = content.replace(
					/\[upfront-gallery\](.*?)\[\/upfront-gallery\]/,
					'<div class="upfront-inline_post-gallery clearfix">$1</div>'
				)
			;
			redactor.$editor.html(edited);
			redactor.code.sync();
		},
		from_html: function (content) {
			var $c = $("<div />").append(content),
				$repl = $c.find(".upfront-inline_post-gallery")
			;
			if (!$repl.length) return content;

			$repl.each(function () {
				var $me = $(this),
					gallery = ''
				;
				gallery = $me.html();
				$me.replaceWith('[upfront-gallery]' + gallery + '[/upfront-gallery]');
			});
			return $c.html();
		}
	},
	Slider: {
		to_html: function (redactor) {
			var content = redactor.$editor.html(),
				edited = content.replace(
					/\[upfront-slider\](.*?)\[\/upfront-slider\]/,
					'<div class="upfront-inline_post-slider clearfix">$1</div>'
				)
			;
			redactor.$editor.html(edited);
			redactor.code.sync();
			this.init_sliders_edit(redactor);
		},
		init_sliders_edit: function (redactor) {
			var $sliders = redactor.$editor.find('.upfront-inline_post-slider'),
				$slider_nav = $('<div id="upfront-inline-slider-nav" class="upfront-default-slider-nav upfront-ui" />');
			$('body').append($slider_nav);
			$sliders.each(function(){
				var $slider = $(this),
					$items = $slider.find('.upfront-inserted_image-wrapper'),
					max_height = 0;
				calc_height();
				$slider.find('img').on('load', calc_height);
				function calc_height () {
					$slider.css('height', 9999);
					$items.each(function(index){
						var $img = $(this).find('img'),
							img_h = $img.height();
						max_height = max_height > img_h ? max_height : img_h;
					});
					$slider.css('height', Math.ceil(max_height/15)*15);
					redactor.code.sync();
				}
			});
			$(document)
				.on('mouseenter', '.upfront-inline_post-slider', this, this.hover_on)
				.on('mouseleave', '.upfront-inline_post-slider', this, this.hover_off)
			;
			$slider_nav.on('click', '.upfront-default-slider-nav-item', this, this.slide_switch);
		},
		hover_on: function (e) {
			var $slider = $(this),
				$slider_nav = $('#upfront-inline-slider-nav'),
				off = $slider.offset(),
				height = $slider.outerHeight(),
				width = $slider.outerWidth(),
				me = e.data;
			$slider_nav.css({
				top: off.top + height,
				left: off.left,
				width: width
			});
			$slider_nav.show();
			if ( me.$current_slider && me.$current_slider.get(0) == $slider.get(0) )
				return;
			me.$current_slider = $slider;
			me.reset_nav($slider);
		},
		hover_off: function (e) {

		},
		slide_switch: function (e) {
			var $nav_item = $(this),
				nav_index = $nav_item.attr('data-slider-index'),
				$slider_nav  = $('#upfront-inline-slider-nav'),
				me = e.data;
			me.$current_slider.find('.slide-edit-active').removeClass('slide-edit-active');
			me.$current_slider.find('.upfront-inserted_image-wrapper').eq(nav_index).addClass('slide-edit-active');
			$slider_nav.find('.upfront-default-slider-nav-item-selected').removeClass('upfront-default-slider-nav-item-selected');
			$nav_item.addClass('upfront-default-slider-nav-item-selected');
			ImagesHelper.Image.remove_dialog();
			$slider_nav.show();
		},
		reset_nav: function ($slider) {
			var $slider_nav  = $('#upfront-inline-slider-nav');
			$slider_nav.html('');
			$slider.find('.upfront-inserted_image-wrapper').each(function(index){
				$slider_nav.append('<i class="upfront-default-slider-nav-item" data-slider-index="' + index + '">' + index + '</i>');
			});
			$slider_nav.find('.upfront-default-slider-nav-item:first').trigger('click');
		},
		from_html: function (content) {
			var $c = $("<div />").append(content),
				$repl = $c.find(".upfront-inline_post-slider")
			;
			if (!$repl.length) return content;

			$repl.each(function () {
				var $me = $(this),
					slider = ''
				;
				slider = $me.html();
				$me.replaceWith('[upfront-slider]' + slider + '[/upfront-slider]');
			});
			return $c.html();
		}
	}
};



}); //End require

}(jQuery));

define('elements/upfront-text/js/model',[],function() {
	var UtextModel = Upfront.Models.ObjectModel.extend({
		init: function () {
			this.init_property("type", "PlainTxtModel");
			this.init_property("view_class", "PlainTxtView");
			this.init_property("element_id", Upfront.Util.get_unique_id("text-object"));
			this.init_property("class", "c24 upfront-plain_txt");
			this.init_property("has_settings", 1);
			this.init_property("id_slug", "plain_text");
		}
	});

	return UtextModel;
});

define('elements/upfront-text/js/element',[
	'elements/upfront-text/js/model'
], function(UtextModel) {
	var l10n = Upfront.Settings.l10n.text_element;

	var TextElement = Upfront.Views.Editor.Sidebar.Element.extend({
		priority: 10,
		render: function () {
			this.$el.addClass('upfront-icon-element upfront-icon-element-text');
			this.$el.html(l10n.element_name);
		},
		add_element: function () {
			var object = new UtextModel({
					"name": "",
					"properties": [
						{"name": "content", "value": l10n.default_content}
					]
				}),
				module = new Upfront.Models.Module({
					"name": "",
					"properties": [
						{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
						{"name": "class", "value": "c11"},
						{"name": "row", "value": Upfront.Util.height_to_row(75)},
						{"name": "has_settings", "value": 0}
					],
					"objects": [
						object
					]
				})
			;
			this.add_module(module);
		}
	});

	return TextElement;
});


define('text!elements/upfront-text/tpl/preset-style.html',[],function () { return '#page .upfront-output-plaintxt.<?php echo $properties[\'id\'] ?>, #page .upfront-output-object.upfront-output-plaintxt.<?php echo $properties[\'id\'] ?> {\r\n\t<?php if(!empty($properties[\'bg_color\'])) { ?>\r\n\tbackground: <?php echo $properties[\'bg_color\']  ?>;\r\n\t<?php } ?>\r\n\r\n\t<?php if(!empty($properties[\'useborder\'])) { ?>\r\n        <?php if(!empty($properties[\'border_width\']) && !empty($properties[\'border_style\']) && !empty($properties[\'border_color\'])) { ?>border: <?php echo $properties[\'border_width\'] ?>px <?php echo $properties[\'border_style\'] ?> <?php echo $properties[\'border_color\'] ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        border: none;\r\n    <?php } ?>\r\n}\r\n\r\n<?php if(!empty($properties[\'usetypography\'])) { ?>\r\n\r\n#page .upfront-object.<?php echo $properties[\'id\'] ?> h1, #page .upfront-output-object.<?php echo $properties[\'id\'] ?> h1 {\r\n\t<?php if(!empty($properties[\'h1-color\'])) { ?>color: <?php echo $properties[\'h1-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'h1-fontface\'])) { ?>font-family: <?php echo $properties[\'h1-fontface\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'h1-fontsize\'])) { ?>font-size: <?php echo $properties[\'h1-fontsize\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'h1-weight\'])) { ?>font-weight: <?php echo $properties[\'h1-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'h1-style\'])) { ?>font-style: <?php echo $properties[\'h1-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'h1-lineheight\'])) { ?>line-height: <?php echo $properties[\'h1-lineheight\']  ?>;<?php } ?>\r\n}\r\n\r\n#page .upfront-object.<?php echo $properties[\'id\'] ?> h2, #page .upfront-output-object.<?php echo $properties[\'id\'] ?> h2 {\r\n\t<?php if(!empty($properties[\'h2-color\'])) { ?>color: <?php echo $properties[\'h2-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'h2-fontface\'])) { ?>font-family: <?php echo $properties[\'h2-fontface\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'h2-fontsize\'])) { ?>font-size: <?php echo $properties[\'h2-fontsize\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'h2-weight\'])) { ?>font-weight: <?php echo $properties[\'h2-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'h2-style\'])) { ?>font-style: <?php echo $properties[\'h2-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'h2-lineheight\'])) { ?>line-height: <?php echo $properties[\'h2-lineheight\']  ?>;<?php } ?>\r\n}\r\n\r\n#page .upfront-object.<?php echo $properties[\'id\'] ?> h3, #page .upfront-output-object.<?php echo $properties[\'id\'] ?> h3 {\r\n\t<?php if(!empty($properties[\'h3-color\'])) { ?>color: <?php echo $properties[\'h3-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'h3-fontface\'])) { ?>font-family: <?php echo $properties[\'h3-fontface\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'h3-fontsize\'])) { ?>font-size: <?php echo $properties[\'h3-fontsize\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'h3-weight\'])) { ?>font-weight: <?php echo $properties[\'h3-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'h3-style\'])) { ?>font-style: <?php echo $properties[\'h3-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'h3-lineheight\'])) { ?>line-height: <?php echo $properties[\'h3-lineheight\']  ?>;<?php } ?>\r\n}\r\n\r\n#page .upfront-object.<?php echo $properties[\'id\'] ?> h4, #page .upfront-output-object.<?php echo $properties[\'id\'] ?> h4 {\r\n\t<?php if(!empty($properties[\'h4-color\'])) { ?>color: <?php echo $properties[\'h4-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'h4-fontface\'])) { ?>font-family: <?php echo $properties[\'h4-fontface\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'h4-fontsize\'])) { ?>font-size: <?php echo $properties[\'h4-fontsize\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'h4-weight\'])) { ?>font-weight: <?php echo $properties[\'h4-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'h4-style\'])) { ?>font-style: <?php echo $properties[\'h4-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'h4-lineheight\'])) { ?>line-height: <?php echo $properties[\'h4-lineheight\']  ?>;<?php } ?>\r\n}\r\n\r\n#page .upfront-object.<?php echo $properties[\'id\'] ?> h5, #page .upfront-output-object.<?php echo $properties[\'id\'] ?> h5 {\r\n\t<?php if(!empty($properties[\'h5-color\'])) { ?>color: <?php echo $properties[\'h5-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'h5-fontface\'])) { ?>font-family: <?php echo $properties[\'h5-fontface\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'h5-fontsize\'])) { ?>font-size: <?php echo $properties[\'h5-fontsize\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'h5-weight\'])) { ?>font-weight: <?php echo $properties[\'h5-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'h5-style\'])) { ?>font-style: <?php echo $properties[\'h5-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'h5-lineheight\'])) { ?>line-height: <?php echo $properties[\'h5-lineheight\']  ?>;<?php } ?>\r\n}\r\n\r\n#page .upfront-object.<?php echo $properties[\'id\'] ?> h6, #page .upfront-output-object.<?php echo $properties[\'id\'] ?> h6 {\r\n\t<?php if(!empty($properties[\'h6-color\'])) { ?>color: <?php echo $properties[\'h6-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'h6-fontface\'])) { ?>font-family: <?php echo $properties[\'h6-fontface\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'h6-fontsize\'])) { ?>font-size: <?php echo $properties[\'h6-fontsize\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'h6-weight\'])) { ?>font-weight: <?php echo $properties[\'h6-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'h6-style\'])) { ?>font-style: <?php echo $properties[\'h6-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'h6-lineheight\'])) { ?>line-height: <?php echo $properties[\'h6-lineheight\']  ?>;<?php } ?>\r\n}\r\n\r\n#page .upfront-object.<?php echo $properties[\'id\'] ?> p, #page .upfront-output-object.<?php echo $properties[\'id\'] ?> p {\r\n\t<?php if(!empty($properties[\'p-color\'])) { ?>color: <?php echo $properties[\'p-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'p-fontface\'])) { ?>font-family: <?php echo $properties[\'p-fontface\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'p-fontsize\'])) { ?>font-size: <?php echo $properties[\'p-fontsize\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'p-weight\'])) { ?>font-weight: <?php echo $properties[\'p-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'p-style\'])) { ?>font-style: <?php echo $properties[\'p-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'p-lineheight\'])) { ?>line-height: <?php echo $properties[\'p-lineheight\']  ?>;<?php } ?>\r\n}\r\n\r\n#page .upfront-object.<?php echo $properties[\'id\'] ?> a, #page .upfront-output-object.<?php echo $properties[\'id\'] ?> a {\r\n\t<?php if(!empty($properties[\'a-color\'])) { ?>color: <?php echo $properties[\'a-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'a-fontface\'])) { ?>font-family: <?php echo $properties[\'a-fontface\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'a-fontsize\'])) { ?>font-size: <?php echo $properties[\'a-fontsize\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'a-weight\'])) { ?>font-weight: <?php echo $properties[\'a-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'a-style\'])) { ?>font-style: <?php echo $properties[\'a-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'a-lineheight\'])) { ?>line-height: <?php echo $properties[\'a-lineheight\']  ?>;<?php } ?>\r\n}\r\n\r\n#page .upfront-object.<?php echo $properties[\'id\'] ?> a:hover, #page .upfront-output-object.<?php echo $properties[\'id\'] ?> a:hover {\r\n\t<?php if(!empty($properties[\'a-hover-color\'])) { ?>color: <?php echo $properties[\'a-hover-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'a-hover-fontface\'])) { ?>font-family: <?php echo $properties[\'a-hover-fontface\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'a-hover-fontsize\'])) { ?>font-size: <?php echo $properties[\'a-hover-fontsize\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'a-hover-weight\'])) { ?>font-weight: <?php echo $properties[\'a-hover-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'a-hover-style\'])) { ?>font-style: <?php echo $properties[\'a-hover-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'a-hover-lineheight\'])) { ?>line-height: <?php echo $properties[\'a-hover-lineheight\']  ?>;<?php } ?>\r\n}\r\n\r\n#page .upfront-object.<?php echo $properties[\'id\'] ?> ul, #page .upfront-output-object.<?php echo $properties[\'id\'] ?> ul {\r\n\t<?php if(!empty($properties[\'ul-color\'])) { ?>color: <?php echo $properties[\'ul-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'ul-fontface\'])) { ?>font-family: <?php echo $properties[\'ul-fontface\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'ul-fontsize\'])) { ?>font-size: <?php echo $properties[\'ul-fontsize\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'ul-weight\'])) { ?>font-weight: <?php echo $properties[\'ul-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'ul-style\'])) { ?>font-style: <?php echo $properties[\'ul-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'ul-lineheight\'])) { ?>line-height: <?php echo $properties[\'ul-lineheight\']  ?>;<?php } ?>\r\n}\r\n\r\n#page .upfront-object.<?php echo $properties[\'id\'] ?> ol, #page .upfront-output-object.<?php echo $properties[\'id\'] ?> ol {\r\n\t<?php if(!empty($properties[\'ol-color\'])) { ?>color: <?php echo $properties[\'ol-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'ol-fontface\'])) { ?>font-family: <?php echo $properties[\'ol-fontface\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'ol-fontsize\'])) { ?>font-size: <?php echo $properties[\'ol-fontsize\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'ol-weight\'])) { ?>font-weight: <?php echo $properties[\'ol-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'ol-style\'])) { ?>font-style: <?php echo $properties[\'ol-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'ol-lineheight\'])) { ?>line-height: <?php echo $properties[\'ol-lineheight\']  ?>;<?php } ?>\r\n}\r\n\r\n#page .upfront-object.<?php echo $properties[\'id\'] ?> blockquote, #page .upfront-output-object.<?php echo $properties[\'id\'] ?> blockquote {\r\n\t<?php if(!empty($properties[\'blockquote-color\'])) { ?>color: <?php echo $properties[\'blockquote-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'blockquote-fontface\'])) { ?>font-family: <?php echo $properties[\'blockquote-fontface\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'blockquote-fontsize\'])) { ?>font-size: <?php echo $properties[\'blockquote-fontsize\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'blockquote-weight\'])) { ?>font-weight: <?php echo $properties[\'blockquote-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'blockquote-style\'])) { ?>font-style: <?php echo $properties[\'blockquote-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'blockquote-lineheight\'])) { ?>line-height: <?php echo $properties[\'blockquote-lineheight\']  ?>;<?php } ?>\r\n}\r\n\r\n#page .upfront-object.<?php echo $properties[\'id\'] ?> blockquote.upfront-quote-alternative, #page.upfront-output-object .<?php echo $properties[\'id\'] ?> blockquote.upfront-quote-alternative {\r\n\t<?php if(!empty($properties[\'blockquote-alternative-color\'])) { ?>color: <?php echo $properties[\'blockquote-alternative-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'blockquote-alternative-fontface\'])) { ?>font-family: <?php echo $properties[\'blockquote-alternative-fontface\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'blockquote-alternative-fontsize\'])) { ?>font-size: <?php echo $properties[\'blockquote-alternative-fontsize\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'blockquote-alternative-weight\'])) { ?>font-weight: <?php echo $properties[\'blockquote-alternative-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'blockquote-alternative-style\'])) { ?>font-style: <?php echo $properties[\'blockquote-alternative-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'blockquote-alternative-lineheight\'])) { ?>line-height: <?php echo $properties[\'blockquote-alternative-lineheight\']  ?>;<?php } ?>\r\n}\r\n\r\n<?php } ?>\r\n\r\n<?php if(!empty($properties[\'preset_style\'])) { ?><?php echo $properties[\'preset_style\'] ?><?php } ?>\r\n';});

define('elements/upfront-text/js/settings',[
	'scripts/upfront/element-settings/settings',
	'scripts/upfront/preset-settings/util',
	'text!elements/upfront-text/tpl/preset-style.html'
], function(ElementSettings, Util, styleTpl) {
	var l10n = Upfront.Settings.l10n.text_element;

	var TextSettings = ElementSettings.extend({
		panels: {
			Appearance: {
				mainDataCollection: 'textPresets',
				styleElementPrefix: 'text-preset',
				ajaxActionSlug: 'text',
				panelTitle: l10n.settings,
				presetDefaults: Upfront.mainData.presetDefaults.text,
				styleTpl: styleTpl,
				stateModules: {
					Global: [
						{
							moduleType: 'Colors',
							options: {
								title: l10n.settings.colors_label,
								multiple: false,
								single: true,
								abccolors: [
									{
										name: 'bg_color',
										label: l10n.settings.content_area_bg
									},
								]
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'static',
								title: '',
								fields: {
									use: 'useborder',
									width: 'border_width',
									type: 'border_style',
									color: 'border_color',
								}
							}
						},
						{
							moduleType: 'Typography',
							options: {
								state: 'static',
								title: l10n.settings.typography_label,
								toggle: true,
								global_typography: true,
								fields: {
									typeface: 'fontface',
									fontstyle: 'fontstyle',
									weight: 'weight',
									style: 'style',
									size: 'fontsize',
									line_height: 'lineheight',
									color: 'color',
									use: 'usetypography'
								},
								default_element: 'h1',
								elements: [
									{ label: l10n.h1, value: "h1" },
									{ label: l10n.h2, value: "h2" },
									{ label: l10n.h3, value: "h3" },
									{ label: l10n.h4, value: "h4" },
									{ label: l10n.h5, value: "h5" },
									{ label: l10n.h6, value: "h6" },
									{ label: l10n.p, value: "p" },
									{ label: l10n.a, value: "a" },
									{ label: l10n.ahover, value: "a-hover" },
									{ label: l10n.ul, value: "ul" },
									{ label: l10n.ol, value: "ol" },
									{ label: l10n.bq, value: "blockquote" },
									{ label: l10n.bqalt, value: "blockquote-alternative" },
								],
							}
						},
					]
				},
				
				migrateElementStyle: function(styles) {
					//replace container class
					styles = styles.replace(/upfront-plain_txt/, 'plain-text-container');
					
					return styles;
				},
				
				migratePresetProperties: function(newPreset) {
					var props = {},
						useBorder = '';

					this.model.get('properties').each( function(prop) {
						props[prop.get('name')] = prop.get('value');
					});
					
					if(typeof props.border_width !== "undefined" &&
						typeof props.border_style !== "undefined" &&
						typeof props.border_style !== "undefined") {
							useBorder = 'yes';
						}

					newPreset.set({
						'useborder': useBorder,
						'bg_color': props.background_color,
						'border_width': props.border_width,
						'border_style': props.border_style,
						'border_color': props.border_color,
					});
				},
				
				getModifiedProperties: function() {
					var props = {};

					this.model.get('properties').each( function(prop) {
						props[prop.get('name')] = prop.get('value');
					});

					if(typeof props.theme_style !== "undefined" && props.theme_style !== "_default") {
						return true;
					}
					
					if((typeof props.border_color !== "undefined" && props.border_color !== "rgba(0, 0, 0, 0)") || 
					   (typeof props.border_style !== "undefined" && props.border_style !== "none") || 
					   (typeof props.border_width !== "undefined" && props.border_width !== 1)) {
						return true;
					}
					
					if(typeof props.bg_color !== "undefined" && props.bg_color !== "rgba(0, 0, 0, 0)") {
						return true;
					}

					return false;
				}
			}
		},
		title: l10n.appearance
	});

	// Generate presets styles to page
	Util.generatePresetsToPage('text', styleTpl);

	return TextSettings;
});

define('elements/upfront-text/js/menulist',[], function() {
	var l10n = Upfront.Settings.l10n.text_element;

	var TextMenuList = Upfront.Views.ContextMenuList.extend({
			initialize: function() {
				var me = this;
				this.menuitems = _([
					new Upfront.Views.ContextMenuItem({
						get_label: function() {
							return l10n.edit_text;
						},
						action: function() {
							var editor = me.for_view.$el.find('div.upfront-object-content').data('ueditor');
							if(!me.for_view.$el.find('div.upfront-object-content').data('redactor')){
								editor.start();
								$(document).on('click', function(e){
									//Check if the click has been inner, or inthe popup, or the context menu, otherwise stop the editor
									if(!editor.options.autostart && editor.redactor){
										var $target = $(e.target);
										if(!editor.disableStop && !$target.closest('li').length && !$target.closest('.redactor_air').length && !$target.closest('.ueditable').length){
											editor.stop();
										}
									}
								});
							}
						}
					})
				]);
			}
		});

	return TextMenuList;
});

define('elements/upfront-text/js/menu',[
	'elements/upfront-text/js/menulist'
], function(TextMenuList) {
	var l10n = Upfront.Settings.l10n.text_element;

	var TextMenu = Upfront.Views.ContextMenu.extend({
		initialize: function() {
			this.menulists = _([
				new TextMenuList()
			]);
		}
	});

	return TextMenu;
});


define('text!elements/upfront-text/tpl/utext.html',[],function () { return '{[ if (usingNewAppearance == false) { ]}\r\n{[ if(background_color || border) { ]}<div class=\'plaintxt_padding\' style=\'background-color: {{background_color}}; border: {{border}};\'> {[ } ]}\r\n{[ } else { ]}\r\n<div class=\'plaintxt_padding\'>\r\n{[ } ]}\r\n<div class=\'plain-text-container\'>\r\n{{content}}\r\n</div>\r\n</div>\r\n';});

(function ($) {
	define('utext',[
		'elements/upfront-text/js/model',
		'elements/upfront-text/js/element',
		'elements/upfront-text/js/settings',
		'elements/upfront-text/js/menu',
		'text!elements/upfront-text/tpl/utext.html',
		'scripts/upfront/preset-settings/util'
	], function(UtextModel, TextElement, TextSettings, TextMenu, textTpl, PresetUtil) {

		var l10n = Upfront.Settings.l10n.text_element;

		var TextView = Upfront.Views.ObjectView.extend({
			// className: 'upfront-plain_txt', THIS ONE TRIPLICATES CLASSNAME MAKING CSS A HELL
			initialize: function() {
				this.constructor.__super__.initialize.apply(this, arguments);

				if(! (this.model instanceof UtextModel)){
					this.model = new UtextModel({properties: this.model.get('properties')});
				}

				/**
				 * Commenting the following because it caused the ueditor to restore draggablity while it was still editable
				 */
				//this.on('deactivated', function() {
				//	console.log('deactivating the text element editor');
				//	Upfront.Events.trigger('upfront:element:edit:stop');
				//}, this);
				this.listenTo(Upfront.Events, "theme_colors:update", this.update_colors, this);
				this.listenTo(Upfront.Events, 'upfront:lightbox:show', this.on_lightbox_show);
			},
			on_lightbox_show: function() {
				// Turn off the editor, hide the redactor bars, clean up the view
				ed = this.$el.find('.upfront-object-content').data("ueditor");

				if(!ed.options.autostart && ed.redactor){
					ed.stop();
				}
			},
			get_preset_properties: function() {
				var preset = this.model.get_property_value_by_name("preset"),
					props = PresetUtil.getPresetProperties('text', preset) || {};

				return props;
			},
			get_content_markup: function () {
				var content = this.model.get_content(),
					$content,
					data;

				// Fix tagless content causes WSOD
				try {
				  $content = $(content);
				} catch (error) {
					$content = $('<p>' + content + '</p>');
				}

				if($content.hasClass('plaintxt_padding')) {
					content = $content.html();
				}

				if (this.model.get_property_value_by_name('usingNewAppearance') !== true && this.model.get_property_value_by_name('usingNewAppearance') !== 'true') {
					data = {
						"content" : content,
						"background_color" : this.model.get_property_value_by_name("background_color"),
						"border" : this.model.get_property_value_by_name("border"),
						"usingNewAppearance": false
					};
				} else {
					data = {
						"content" : content,
						usingNewAppearance: true
					};
				}
				var rendered = '';
				rendered = _.template(textTpl, data);
				return rendered + ( !this.is_edited() || $.trim(content) == '' ? '<div class="upfront-quick-swap"><p>' + l10n.dbl_click + '</p></div>' : '');
			},
			is_edited: function () {
				var is_edited = this.model.get_property_value_by_name('is_edited');
				return is_edited ? true : false;
			},
			on_render: function() {
				var me = this,
				blurTimeout = false;

				this.$el.find('.upfront-object-content')
					// .addClass('upfront-plain_txt') // WHY DO THIS, IT MESSES UP THE CSS LOGIC SINCE THAN WE HAVE DUPLICATED CLASS
					.ueditor({
						linebreaks: false,
						//airButtons : ["upfrontFormatting"],
						autostart: false,
						paragraphize: false,
						focus: false,
						placeholder: l10n.default_content
					})
					.on('start', function(){
						var $swap = $(this).find('.upfront-quick-swap');
						if ( $swap.length ){
							$swap.remove();
						}
						me.model.set_property('is_edited', true, true);
						Upfront.Events.trigger('upfront:element:edit:start', 'text');
					})
					.on('stop', function(){
						var ed = me.$el.find('.upfront-object-content').data("ueditor"),
							tag = ed.redactor.$element[0].firstChild.tagName,
							text = '';

						if(tag === "PRE") {
							//Remove markers markup leaking in PRE element
							ed.redactor.selection.removeMarkers();
						}

						text = ed.getValue(true);

						if (text === '' && arguments[0] && arguments[0].currentTarget) text = arguments[0].currentTarget.innerHTML;
						me.model.set_content(text);

						Upfront.Events.trigger('upfront:element:edit:stop');
						ed.redactor.events.trigger('cleanUpListeners');
						me.render();
					})
					.on('syncAfter', function(){
						var ed = me.$el.find('.upfront-object-content').data("ueditor"),
							text = ed.getValue(true)
						;
						if (text === '' && typeof arguments[1] === 'string' && arguments[1] !== '') text = arguments[1];
						if (!text.match(/[<>]/)) {
							text = ed.redactor.paragraphize.load(text);
							ed.redactor.code.set(text);

							// Now, set the caret at the end
							ed.redactor.selection.selectAll();
							var blocks = ed.redactor.selection.getBlocks(),
								block = blocks.pop()
							;
							ed.redactor.selection.remove();
							if (block) {
								ed.redactor.caret.setAfter(block);
							}
							// done
						}

						me.model.set_content(ed.getValue(true) || text, {silent: true});
					})
				;

				me.update_colors();

				if (this.model.get_property_value_by_name('preset')) {
					this.$el.find('.upfront-output-plaintxt').addClass(this.model.get_property_value_by_name('preset'));
				}
			},
			update_colors: function () {
				var me = this;

				var bg = me.model.get_property_value_by_name("background_color");
				if (bg && Upfront.Util.colors.is_theme_color(bg)) {
					bg = Upfront.Util.colors.get_color(bg);

					me.model.set_property("bg_color", bg);
				}

				var border = me.model.get_property_value_by_name("border"),
					matches = border ? border.match(/#ufc\d+/) : false
				;
				if (border && matches && matches.length) {
					var color = Upfront.Util.colors.get_color(matches[0]);
					border = border.replace(new RegExp(matches[0]), color);

					me.model.set_property("border_color", color);
				}

			}
		});

		Upfront.Application.LayoutEditor.add_object("PlainTxt", {
			"Model": UtextModel,
			"View": TextView,
			"Element": TextElement,
			"Settings": TextSettings,
			"ContextMenu": TextMenu,
			cssSelectors: {
				'.plain-text-container': {label: l10n.css.container_label, info: l10n.css.container_info},
				'.plain-text-container p': {label: l10n.css.p_label, info: l10n.css.p_info},
			},
			cssSelectorsId: 'PlainTxtModel'
		});

		Upfront.Models.UtextModel = UtextModel;
		Upfront.Views.PlainTxtView = TextView;

	});
})(jQuery);


define('text!elements/upfront-comment/templates/preset-style.html',[],function () { return '<?php if(!empty($properties[\'preset_style\'])) { ?><?php echo $properties[\'preset_style\'] ?><?php } ?>\r\n';});

(function ($) {

define('ucomment',[
	'scripts/upfront/element-settings/settings',
	'scripts/upfront/preset-settings/util',
	'text!elements/upfront-comment/templates/preset-style.html'
], function(ElementSettings, Util, styleTpl) {

var l10n = Upfront.Settings.l10n.comments_element;

var UcommentModel = Upfront.Models.ObjectModel.extend({
	/**
	 * The init function is called after the contructor and Model intialize.
	 * Here the default values for the model properties are set.
	 */
	init: function () {
		var properties = _.clone(Upfront.data.ucomments.defaults);
		properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + '-object');
		this.init_properties(properties);
	}
});

var UcommentView = Upfront.Views.ObjectView.extend({
	initialize: function(options){
		if(! (this.model instanceof UcommentModel)){
			this.model = new UcommentModel({properties: this.model.get('properties')});
		}

		this.constructor.__super__.initialize.call(this, [options]);
	},

	get_content_markup: function () {
		var comment_data = $(document).data('upfront-comment-' + _upfront_post_data.post_id);
		return comment_data ? comment_data : l10n.loading;
	},

	on_render: function () {
		if ( !$(document).data('upfront-comment-' + _upfront_post_data.post_id) )
			this._get_comment_markup();
		var discussion_settings = Upfront.Settings.Application.PERMS.OPTIONS
			? new DiscussionSettings_View({model: this.model})
			: new DiscussionFallback_View({model: this.model})
		;
		discussion_settings.render();
		this.$el.append(discussion_settings.$el);
	},

	_get_comment_markup: function () {
		var me = this,
			post_id = _upfront_post_data.post_id
		;
		if (!post_id && "themeExporter" in Upfront && Upfront.Application.mode.current === Upfront.Application.MODE.THEME) {
			post_id = 'fake_post';
		}
		Upfront.Util.post({"action": "ucomment_get_comment_markup", "data": JSON.stringify({"post_id": post_id})})
			.success(function (ret) {
				var html = ret.data.replace(/<script.*?>.*?<\/script>/gim, ''); // strip script
				$(document).data('upfront-comment-' + _upfront_post_data.post_id, html || '&nbsp;');
				me.render();
			})
			.error(function (ret) {
				Upfront.Util.log(l10n.loading_error);
			})
		;
	}
});

var DiscussionSettings_Model = Upfront.Models.ObjectModel.extend({
	cache: false,
	load: function () {
		this.loading = $.Deferred();
		if (this.cache) {
			this._populate();
		} else {
			var me = this;
			Upfront.Util.post({action: "upfront-discussion_settings-get"}).done(function (response) {
				me.cache = response.data;
				me._populate();
			});
		}
		return this.loading;
	},
	_populate: function () {
		if (!(_.isObject(this.cache) && "avatar_defaults" in this.cache)) {
			this.loading.reject();
			return false;
		}
		var avatars = _(this.cache.avatar_defaults).map(function (avatar) {
			if (avatar.icon) avatar.icon = avatar.icon.match(/^https?:\/\//) ? avatar.icon : $(avatar.icon).attr("src");
			return avatar;
		});
		this.set({
			properties: new Upfront.Collections.Properties(_(this.cache.properties).values()),
			avatars: _(avatars).values()
		});
		this.loading.resolve();
	}
});

var GlobalSettings_View = Backbone.View.extend({
	className: "upfront-global_settings",
	events: {
		"click a.settings": "popup_open"
	},
	initialize: function() {
		Upfront.Events.on("popup:closed", this.onPopupClosed, this);
	},
	onPopupClosed: function() {
		//Remove discussion-settings-wrapper when dicussion settings popup is closed
		$('#upfront-popup-content').removeClass('discussion-settings-wrapper');
	},
	render: function () {
		this.$el.empty().append('<a href="#" class="settings">' + this.label + '</a>');
	},
	popup_open: function (e) {
		e.preventDefault();
		e.stopPropagation();
		var me = this,
			pop = Upfront.Popup.open(function (data, $top, $bottom) {
				me.out = this;
				me.popup_data = data;
				/*
				me.popup_data.$top = $top;
				me.popup_data.$bottom = $bottom;
				*/
				me.setup_tabs($top);
				me.setup_actions($bottom);
				me.setup_content();
			}, {}, "discussion-popup")
		;
		this.popup = this;
	},
	setup_tabs: function ($el) {},
	setup_actions: function ($el) {},
	setup_content: function () {},
	save_settings: function () {},
});

var DiscussionFallback_View = GlobalSettings_View.extend({
	label: l10n.discussion_settings,
	setup_content: function () {
		$(this.out)
			.empty()
			.append(
				'<p class="settings-disabled">' + l10n.settings_disabled + '</p>'
			)
		;
	}
});

var DiscussionSettings_View = GlobalSettings_View.extend({
	label: l10n.discussion_settings,
    initialize: function () {
    	GlobalSettings_View.prototype.initialize.call(this);
    	this.on("settings:tabs:switch_to:settings", this.render_settings_content, this);
    	this.on("settings:tabs:switch_to:avatars", this.render_avatars_content, this);
    	this.on("settings:save", this.save_settings, this);
    },
	setup_tabs: function ($el) {
		this.tabs = new DiscussionSettings_Tabs_View();
		this.tabs.parent_view = this;
		this.tabs.render();
		$el.append(this.tabs.$el);
	},
	setup_actions: function ($el) {
		var actions = new DiscussionSettings_Actions_View();
		actions.parent_view = this;
		actions.render();
		$el.empty().append(actions.$el);
	},
	setup_content: function () {
		this.render_settings_content();
		this.tabs.activate_tab('settings');
	},
	render_settings_content: function () {
		var settings = new DiscussionSettings_Settings_View({
			el: this.out,
			model: new DiscussionSettings_Model()
		});
		settings.render();
		this.active_view = settings;
	},
	render_avatars_content: function () {
		var avatars = new DiscussionSettings_Avatars_View({
			el: this.out,
			model: new DiscussionSettings_Model()
		});
		avatars.render();
		this.active_view = avatars;
	},
	save_settings: function () {
		var data = {
			action: 'upfront-discussion_settings-' + this.active_view.type + '-save',
			data: this.active_view.get_data()
		}
		Upfront.Util.post(data).done(function () {
			Upfront.Popup.close();
		});
	}
});
var DiscussionSettings_Tabs_View = Backbone.View.extend({
	tagName: "ul",
	className: "upfront-tabs upfront-ucomment-tabs",
	events: {
		"click li": "switch_to"
	},
	render: function () {
		this.$el
			.empty()
			.append('<li class="settings">' + l10n.discussion_settings + '</li>')
			.append('<li class="avatars">' + l10n.avatars + '</li>')
		;
	},
	switch_to: function (e) {
		e.preventDefault();
		e.stopPropagation();
		var $tgt = $(e.target),
			target = $tgt.is(".settings") ? "settings" : "avatars"
		;
		this.activate_tab(target);
		this.parent_view.trigger("settings:tabs:switch_to:" + target);
	},
	activate_tab: function (tab) {
		var $tab = this.$el.find('li.' + tab);
		this.$el.find("li").removeClass("active");
		$tab.addClass("active");
	}
});
var DiscussionSettings_Actions_View = Backbone.View.extend({
	className: "use_selection_container",
	events: {
		"click a": "trigger_settings_save"
	},
	render: function () {
		this.$el.empty().append('<a href="#">' + l10n.ok + '</a>');
	},
	trigger_settings_save: function (e) {
		e.preventDefault();
		e.stopPropagation();
		this.parent_view.trigger("settings:save");
	}
});

var DiscussionSettings_ActionView = Backbone.View.extend({
	templates: {
		section_label: '<h3>{{label}}</h3>'
	},
	initialize: function () {
		var me = this;
		this.model.load().done(function () {
			me.render_final();
		});
	},
	render_final: function () {
		var me = this;
		this.populate_sections();
		this.$el.empty();
		this.$el.addClass('discussion-settings-wrapper');

		this.sections.each(function (section) {
			if (section.label) me.$el.append(_.template(me.templates.section_label, {label: section.label}));
			section.fields.each(function (field) {
				field.render();
				me.$el.append(field.$el);
			});
		});
	},
	get_data: function () {
		var data = {};
		this.sections.each(function (section) {
			section.fields.each(function (field) {
				if (field.get_name) data[field.get_name()] = field.get_value();
				else data = _.extend(data, field.get_value());
			});
		});
		return data;
	},
	render: function () {
		this.$el.empty().append(l10n.please_wait);
	}
});

var DiscussionSettings_Avatars_View = DiscussionSettings_ActionView.extend({
	type: 'avatars',
	populate_sections: function () {
		this.sections = _([
			{
				label: l10n.avatar_settings,
				fields: _([
					new CheckboxField({
						model: this.model,
						property: 'show_avatars',
						values: [{label: l10n.show_avatars, value: '1'}]
					}),
				])
			},
			{
				label: l10n.max_rating,
				fields: _([
					new Upfront.Views.Editor.Field.Radios({
						model: this.model,
						property: 'avatar_rating',
						layout: "vertical",
						values: [
							{label: l10n.rating.g, value: 'G', icon: 'http://1.gravatar.com/avatar/31cb559695bfc798dbf0981a52c7a748?s=32&d=&r=G&forcedefault=1'},
							{label: l10n.rating.pg, value: 'PG', icon: 'http://1.gravatar.com/avatar/31cb559695bfc798dbf0981a52c7a748?s=32&d=&r=G&forcedefault=1'},
							{label: l10n.rating.r, value: 'R', icon: 'http://1.gravatar.com/avatar/31cb559695bfc798dbf0981a52c7a748?s=32&d=&r=G&forcedefault=1'},
							{label: l10n.rating.x, value: 'X', icon: 'http://1.gravatar.com/avatar/31cb559695bfc798dbf0981a52c7a748?s=32&d=&r=G&forcedefault=1'},
						]
					}),
				])
			},
			{
				label: l10n.default_avatar,
				fields: _([
					new Upfront.Views.Editor.Field.Radios({
						model: this.model,
						property: 'avatar_default',
						layout: "vertical",
						values: this.model.get("avatars")
					}),
				])
			}
		]);
	}
});
var DiscussionSettings_Settings_View = DiscussionSettings_ActionView.extend({
	type: "settings",
	spawn_checkbox: function (label, prop, value) {
		value = value || "1";
		return new Upfront.Views.Editor.Field.Checkboxes({
			multiple: false,
			model: this.model,
			property: prop,
			values: [
				{label: label, value: value}
			]
		});
	},
	populate_sections: function () {
		this.sections = _([
			{
				label: l10n.article.label,
				fields: _([
					this.spawn_checkbox(l10n.article.pingback, 'default_pingback_flag'),
					this.spawn_checkbox(l10n.article.ping_status, 'default_ping_status', 'open'),
					this.spawn_checkbox(l10n.article.comment_status, 'default_comment_status', 'open'),
					this.spawn_checkbox(l10n.article.attachments, 'allow_attachments'),
					this.spawn_checkbox(l10n.article.email, 'show_email_subscription_field'),
				])
			},
			{
				label: l10n.other.label,
				fields: _([
					this.spawn_checkbox(l10n.other.require_name_email, 'require_name_email'),
					this.spawn_checkbox(l10n.other.comment_registration, 'comment_registration'),
					new BooleanSubfieldField({
						model: this.model,
						property: '',
						field: new Upfront.Views.Editor.Field.Checkboxes({
							model: this.model,
							property: "close_comments_for_old_posts",
							values: [
								{label: l10n.other.autoclose, value: "1"}
							]
						}),
						subfield: new CounterField({
							model: this.model,
							property: "close_comments_days_old"
						})
					}),
					new BooleanSubfieldField({
						model: this.model,
						property: '',
						field: new Upfront.Views.Editor.Field.Checkboxes({
							model: this.model,
							property: "thread_comments",
							values: [
								{label: l10n.other.thread_comments, value: "1"}
							]
						}),
						subfield: new CounterField({
							model: this.model,
							property: "thread_comments_depth"
						})
					}),
					new PagedCommentsField({
						model: this.model,
						field: new Upfront.Views.Editor.Field.Checkboxes({
							model: this.model,
							property: "page_comments",
							values: [
								{label: l10n.other.page_comments, value: "1"}
							]
						}),
						depth: new CounterField({
							model: this.model,
							property: "default_comments_page",
						}),
						page: new Upfront.Views.Editor.Field.Select({
							model: this.model,
							property: "default_comments_page",
							values: [
								{label: l10n.other.last, value: 'newest'},
								{label: l10n.other.first, value: 'oldest'}
							]
						}),
					}),
					new Upfront.Views.Editor.Field.Select({
						model: this.model,
						property: "comment_order",
						label: l10n.other.order,
						values: [
							{label: l10n.other.older, value: 'asc'},
							{label: l10n.other.newer, value: 'desc'}
						]
					}),

				])
			},
			{
				label: l10n.other.email_me,
				fields: _([
					this.spawn_checkbox(l10n.other.comments_notify, 'comments_notify'),
					this.spawn_checkbox(l10n.other.moderation_notify, 'moderation_notify')
				])
			},
			{
				label: l10n.other.before_comment_appears,
				fields: _([
					this.spawn_checkbox(l10n.other.comment_moderation, 'comment_moderation'),
					this.spawn_checkbox(l10n.other.comment_whitelist, 'comment_whitelist'),
				])
			},
			{
				label: l10n.other.moderation_label,
				fields: _([
					new LabeledCounterField({
						model: this.model,
						property: "comment_max_links",
						label: l10n.other.max_links
					}),
					new Upfront.Views.Editor.Field.Textarea({
						model: this.model,
						property: 'moderation_keys',
						label: l10n.other.moderation_keys
					}),
					new Upfront.Views.Editor.Field.Textarea({
						model: this.model,
						property: 'blacklist_keys',
						label: l10n.other.blacklist_keys
					})
				])
			}
		]);
	}
});

var BooleanSubfieldField = Backbone.View.extend({
	className: "upfront-field-complex_field",
	initialize: function(opts){
		this.options = opts;
	},
	render: function () {
		this.$el.empty();
		this.$el.append(this.get_field_html());
		this.$el.on("click", '[name="' + this.options.subfield.get_name() + '"]', this.stop_prop);
	},
	stop_prop: function (e) { e.stopPropagation(); e.preventDefault(); },
	get_field_html: function () {
		this.options.subfield.render();
		this.options.field.render();
		return _.template(this.options.field.$el.html(), {subfield: this.options.subfield.$el.html()});
	},
	get_value: function () {
		var data = {}
			$field = this.$el.find('[name="' + this.options.field.get_name() + '"]')
			$subfield = this.$el.find('[name="' + this.options.subfield.get_name() + '"]')
		;
		data[this.options.field.get_name()] = $field.is(":checkbox") ? ($field.is(":checked") ? 1 : 0) : $field.val();
		data[this.options.subfield.get_name()] = $subfield.val();
		return data;
	}
});
var CheckboxField = Upfront.Views.Editor.Field.Checkboxes.extend({
	multiple: false
});
var CounterField = Upfront.Views.Editor.Field.Text.extend({
	get_label_html: function () {},
	get_field_html: function () {
			var attr = {
				'type': 'number',
				'class': 'upfront-field upfront-field-counter',
				'min': 0,
				'step': 1,
				'id': this.get_field_id(),
				'name': this.get_field_name(),
				'value': this.get_saved_value()
			};
			return '<input ' + this.get_field_attr_html(attr) + ' />';
		}
});
var LabeledCounterField = CounterField.extend({
	className: "upfront-field-labeled_counter_field",
	get_field_html: function () {},
	get_label_html: function () {
		var field = CounterField.prototype.get_field_html.call(this);
		return _.template(Upfront.Views.Editor.Field.Text.prototype.get_label_html.call(this), {field: field});
	}
});
var PagedCommentsField = BooleanSubfieldField.extend({
	render: function () {
		this.$el.empty();
		this.$el.append(this.get_field_html());
		this.$el.on("click", '[name="' + this.options.depth.get_name() + '"]', this.stop_prop);
		this.$el.on("click", '[name="' + this.options.page.get_name() + '"]', this.stop_prop);
	},
	stop_prop: function (e) { e.stopPropagation(); e.preventDefault(); },
	get_field_html: function () {
		this.options.depth.render();
		this.options.page.render();
		this.options.field.render();
		return _.template(this.options.field.$el.html(), {
			depth: this.options.depth.$el.html(),
			page: this.options.page.$el.html()
		});
	},
	get_value: function () {
		var data = {},
			$field = this.$el.find('[name="' + this.options.field.get_name() + '"]'),
			$depth = this.$el.find('[name="' + this.options.depth.get_name() + '"]'),
			$page = this.$el.find('[name="' + this.options.page.get_name() + '"]')
		;
		data[this.options.field.get_name()] = $field.is(":checkbox") ? ($field.is(":checked") ? 1 : 0) : $field.val();
		data[this.options.depth.get_name()] = $depth.val();
		data[this.options.page.get_name()] = $page.val();
		return data;
	}
});

var Settings = ElementSettings.extend({
	panels: {
		Appearance: {
			mainDataCollection: 'ucommentPresets',
			styleElementPrefix: 'ucomment-preset',
			ajaxActionSlug: 'ucomment',
			panelTitle: l10n.settings,
			presetDefaults: Upfront.mainData.presetDefaults.ucomment,
			styleTpl: styleTpl,
		},
	},
	title: l10n.settings
});

var UcommentElement = Upfront.Views.Editor.Sidebar.Element.extend({

	render: function () {
		this.$el.addClass('upfront-icon-element upfront-icon-element-comment');
		this.$el.html(l10n.element_name);
	},

	add_element: function () {
		var object = new UcommentModel(),
			module = new Upfront.Models.Module({
				"name": "",
				"properties": [
					{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
					{"name": "class", "value": "c11 upfront-comment_module"},
					{"name": "has_settings", "value": 0},
					{"name": "row", "value": Upfront.Util.height_to_row(375)}
				],
				"objects": [
					object
				]
			})
		;
		this.add_module(module);
	}
});


function add_comment () {
	if (
		_upfront_post_data.post_id
		||
		(Upfront.Application.get_current() === Upfront.Application.MODE.THEME && 'type' in _upfront_post_data.layout && 'single' === _upfront_post_data.layout.type)
	) {
		Upfront.Application.LayoutEditor.add_object("Ucomment", {
			"Model": UcommentModel,
			"View": UcommentView,
			"Element": UcommentElement,
			"Settings": Settings
		});
	}
	// Generate presets styles to page
	Util.generatePresetsToPage('ucomment', styleTpl);
}
Upfront.Events.on("application:mode:after_switch", function () {
	if (Upfront.Application.get_current() !== Upfront.Application.MODE.THEME) return false;
	add_comment();
});
add_comment();

Upfront.Models.UcommentModel = UcommentModel;
Upfront.Views.UcommentView = UcommentView;

});
})(jQuery);


define('text!elements/upfront-contact-form/templates/preset-style.html',[],function () { return '/* Contact presets Typography Normal state */\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container label {\r\n\t<?php if(!empty($properties[\'field-labels-static-font-family\'])) { ?>font-family: <?php echo $properties[\'field-labels-static-font-family\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'field-labels-static-font-size\'])) { ?>font-size: <?php echo $properties[\'field-labels-static-font-size\']  ?>px; <?php } ?>\r\n    <?php if(!empty($properties[\'field-labels-static-weight\'])) { ?>font-weight: <?php echo $properties[\'field-labels-static-weight\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-labels-static-style\'])) { ?>font-style: <?php echo $properties[\'field-labels-static-style\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-labels-static-line-height\'])) { ?>line-height: <?php echo $properties[\'field-labels-static-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'field-labels-static-font-color\'])) { ?>color: <?php echo $properties[\'field-labels-static-font-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'hover-use-transition\']) && !empty($properties[\'hover-transition-duration\']) && !empty($properties[\'hover-transition-easing\'] )) { ?>\r\n\t\ttransition: all <?php echo $properties[\'hover-transition-duration\'] ?>s <?php echo $properties[\'hover-transition-easing\']  ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container input,\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container textarea {\r\n\t<?php if(!empty($properties[\'field-values-static-font-family\'])) { ?>font-family: <?php echo $properties[\'field-values-static-font-family\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'field-values-static-font-size\'])) { ?>font-size: <?php echo $properties[\'field-values-static-font-size\']  ?>px; <?php } ?>\r\n    <?php if(!empty($properties[\'field-values-static-weight\'])) { ?>font-weight: <?php echo $properties[\'field-values-static-weight\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-values-static-style\'])) { ?>font-style: <?php echo $properties[\'field-values-static-style\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-values-static-line-height\'])) { ?>line-height: <?php echo $properties[\'field-values-static-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'field-values-static-font-color\'])) { ?>color: <?php echo $properties[\'field-values-static-font-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'hover-use-transition\']) && !empty($properties[\'hover-transition-duration\']) && !empty($properties[\'hover-transition-easing\'] )) { ?>\r\n\t\ttransition: all <?php echo $properties[\'hover-transition-duration\'] ?>s <?php echo $properties[\'hover-transition-easing\']  ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container.upfront-submit-container .button{\r\n\t<?php if(!empty($properties[\'button-static-font-family\'])) { ?>font-family: <?php echo $properties[\'button-static-font-family\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'button-static-font-size\'])) { ?>font-size: <?php echo $properties[\'button-static-font-size\']  ?>px; <?php } ?>\r\n    <?php if(!empty($properties[\'button-static-weight\'])) { ?>font-weight: <?php echo $properties[\'button-static-weight\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'button-static-style\'])) { ?>font-style: <?php echo $properties[\'button-static-style\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'button-static-line-height\'])) { ?>line-height: <?php echo $properties[\'button-static-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'button-static-font-color\'])) { ?>color: <?php echo $properties[\'button-static-font-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'hover-use-transition\']) && !empty($properties[\'hover-transition-duration\']) && !empty($properties[\'hover-transition-easing\'] )) { ?>\r\n\t\ttransition: all <?php echo $properties[\'hover-transition-duration\'] ?>s <?php echo $properties[\'hover-transition-easing\']  ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n/* Contact presets Typography Hover state */\r\n\r\n<?php if(!empty($properties[\'hover-use-typography\']) && $properties[\'hover-use-typography\'] == \'yes\') { ?>\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container label:hover {\r\n\t<?php if(!empty($properties[\'field-labels-hover-font-family\'])) { ?>font-family: <?php echo $properties[\'field-labels-hover-font-family\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'field-labels-hover-font-size\'])) { ?>font-size: <?php echo $properties[\'field-labels-hover-font-size\']  ?>px; <?php } ?>\r\n    <?php if(!empty($properties[\'field-labels-hover-weight\'])) { ?>font-weight: <?php echo $properties[\'field-labels-hover-weight\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-labels-hover-style\'])) { ?>font-style: <?php echo $properties[\'field-labels-hover-style\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-labels-hover-line-height\'])) { ?>line-height: <?php echo $properties[\'field-labels-hover-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'field-labels-hover-font-color\'])) { ?>color: <?php echo $properties[\'field-labels-hover-font-color\']  ?>; <?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container input:hover,\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container textarea:hover {\r\n\t<?php if(!empty($properties[\'field-values-hover-font-family\'])) { ?>font-family: <?php echo $properties[\'field-values-hover-font-family\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'field-values-hover-font-size\'])) { ?>font-size: <?php echo $properties[\'field-values-hover-font-size\']  ?>px; <?php } ?>\r\n    <?php if(!empty($properties[\'field-values-hover-weight\'])) { ?>font-weight: <?php echo $properties[\'field-values-hover-weight\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-values-hover-style\'])) { ?>font-style: <?php echo $properties[\'field-values-hover-style\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-values-hover-line-height\'])) { ?>line-height: <?php echo $properties[\'field-values-hover-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'field-values-hover-font-color\'])) { ?>color: <?php echo $properties[\'field-values-hover-font-color\']  ?>; <?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container.upfront-submit-container .button:hover {\r\n\t<?php if(!empty($properties[\'button-hover-font-family\'])) { ?>font-family: <?php echo $properties[\'button-hover-font-family\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'button-hover-font-size\'])) { ?>font-size: <?php echo $properties[\'button-hover-font-size\']  ?>px; <?php } ?>\r\n    <?php if(!empty($properties[\'button-hover-weight\'])) { ?>font-weight: <?php echo $properties[\'button-hover-weight\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'button-hover-style\'])) { ?>font-style: <?php echo $properties[\'button-hover-style\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'button-hover-line-height\'])) { ?>line-height: <?php echo $properties[\'button-hover-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'button-hover-font-color\'])) { ?>color: <?php echo $properties[\'button-hover-font-color\']  ?>; <?php } ?>\r\n}\r\n\r\n<?php } else { ?>\r\n\r\n/* If typography checkbox is unchecked use normal state settings on hover */\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container label:hover {\r\n\t<?php if(!empty($properties[\'field-labels-static-font-family\'])) { ?>font-family: <?php echo $properties[\'field-labels-static-font-family\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'field-labels-static-font-size\'])) { ?>font-size: <?php echo $properties[\'field-labels-static-font-size\']  ?>px; <?php } ?>\r\n    <?php if(!empty($properties[\'field-labels-static-weight\'])) { ?>font-weight: <?php echo $properties[\'field-labels-static-weight\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-labels-static-style\'])) { ?>font-style: <?php echo $properties[\'field-labels-static-style\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-labels-static-line-height\'])) { ?>line-height: <?php echo $properties[\'field-labels-static-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'field-labels-static-font-color\'])) { ?>color: <?php echo $properties[\'field-labels-static-font-color\']  ?>; <?php } ?>\r\n}\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container input:hover,\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container textarea:hover {\r\n\t<?php if(!empty($properties[\'field-values-static-font-family\'])) { ?>font-family: <?php echo $properties[\'field-values-static-font-family\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'field-values-static-font-size\'])) { ?>font-size: <?php echo $properties[\'field-values-static-font-size\']  ?>px; <?php } ?>\r\n    <?php if(!empty($properties[\'field-values-static-weight\'])) { ?>font-weight: <?php echo $properties[\'field-values-static-weight\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-values-static-style\'])) { ?>font-style: <?php echo $properties[\'field-values-static-style\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-values-static-line-height\'])) { ?>line-height: <?php echo $properties[\'field-values-static-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'field-values-static-font-color\'])) { ?>color: <?php echo $properties[\'field-values-static-font-color\']  ?>; <?php } ?>\r\n}\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container.upfront-submit-container .button:hover {\r\n\t<?php if(!empty($properties[\'button-static-font-family\'])) { ?>font-family: <?php echo $properties[\'button-static-font-family\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'button-static-font-size\'])) { ?>font-size: <?php echo $properties[\'button-static-font-size\']  ?>px; <?php } ?>\r\n    <?php if(!empty($properties[\'button-static-weight\'])) { ?>font-weight: <?php echo $properties[\'button-static-weight\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'button-static-style\'])) { ?>font-style: <?php echo $properties[\'button-static-style\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'button-static-line-height\'])) { ?>line-height: <?php echo $properties[\'button-static-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'button-static-font-color\'])) { ?>color: <?php echo $properties[\'button-static-font-color\']  ?>; <?php } ?>\r\n}\r\n\r\n<?php } ?>\r\n\r\n/* Contact presets Typography Focus state */\r\n\r\n<?php if(!empty($properties[\'focus-use-typography\']) && $properties[\'focus-use-typography\'] == \'yes\') { ?>\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container input:focus,\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container textarea:focus {\r\n\t<?php if(!empty($properties[\'field-values-focus-font-family\'])) { ?>font-family: <?php echo $properties[\'field-values-focus-font-family\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'field-values-focus-font-size\'])) { ?>font-size: <?php echo $properties[\'field-values-focus-font-size\']  ?>px; <?php } ?>\r\n    <?php if(!empty($properties[\'field-values-focus-weight\'])) { ?>font-weight: <?php echo $properties[\'field-values-focus-weight\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-values-focus-style\'])) { ?>font-style: <?php echo $properties[\'field-values-focus-style\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-values-focus-line-height\'])) { ?>line-height: <?php echo $properties[\'field-values-focus-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'field-values-focus-font-color\'])) { ?>color: <?php echo $properties[\'field-values-focus-font-color\']  ?>; <?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container.upfront-submit-container .button:focus {\r\n\t<?php if(!empty($properties[\'button-focus-font-family\'])) { ?>font-family: <?php echo $properties[\'button-focus-font-family\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'button-focus-font-size\'])) { ?>font-size: <?php echo $properties[\'button-focus-font-size\']  ?>px; <?php } ?>\r\n    <?php if(!empty($properties[\'button-focus-weight\'])) { ?>font-weight: <?php echo $properties[\'button-focus-weight\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'button-focus-style\'])) { ?>font-style: <?php echo $properties[\'button-focus-style\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'button-focus-line-height\'])) { ?>line-height: <?php echo $properties[\'button-focus-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'button-focus-font-color\'])) { ?>color: <?php echo $properties[\'button-focus-font-color\']  ?>; <?php } ?>\r\n}\r\n\r\n<?php } else { ?>\r\n\r\n/* If typography checkbox is unchecked use normal state settings on focus */\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container input:focus,\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container textarea:focus {\r\n\t<?php if(!empty($properties[\'field-values-static-font-family\'])) { ?>font-family: <?php echo $properties[\'field-values-static-font-family\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'field-values-static-font-size\'])) { ?>font-size: <?php echo $properties[\'field-values-static-font-size\']  ?>px; <?php } ?>\r\n    <?php if(!empty($properties[\'field-values-static-weight\'])) { ?>font-weight: <?php echo $properties[\'field-values-static-weight\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-values-static-style\'])) { ?>font-style: <?php echo $properties[\'field-values-static-style\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'field-values-static-line-height\'])) { ?>line-height: <?php echo $properties[\'field-values-static-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'field-values-static-font-color\'])) { ?>color: <?php echo $properties[\'field-values-static-font-color\']  ?>; <?php } ?>\r\n}\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container.upfront-submit-container .button:focus {\r\n\t<?php if(!empty($properties[\'button-static-font-family\'])) { ?>font-family: <?php echo $properties[\'button-static-font-family\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'button-static-font-size\'])) { ?>font-size: <?php echo $properties[\'button-static-font-size\']  ?>px; <?php } ?>\r\n    <?php if(!empty($properties[\'button-static-weight\'])) { ?>font-weight: <?php echo $properties[\'button-static-weight\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'button-static-style\'])) { ?>font-style: <?php echo $properties[\'button-static-style\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'button-static-line-height\'])) { ?>line-height: <?php echo $properties[\'button-static-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'button-static-font-color\'])) { ?>color: <?php echo $properties[\'button-static-font-color\']  ?>; <?php } ?>\r\n}\r\n\r\n<?php } ?>\r\n\r\n/* Colors module */\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container input,\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container textarea {\r\n\t<?php if(!empty($properties[\'static-field-bg\'])) { ?>background: <?php echo $properties[\'static-field-bg\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'hover-use-transition\']) && !empty($properties[\'hover-transition-duration\']) && !empty($properties[\'hover-transition-easing\'] )) { ?>\r\n\t\ttransition: all <?php echo $properties[\'hover-transition-duration\'] ?>s <?php echo $properties[\'hover-transition-easing\']  ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container input:hover,\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container textarea:hover {\r\n\t<?php if(!empty($properties[\'hover-use-color\']) && $properties[\'hover-use-color\'] == \'yes\') { ?>\r\n\t\t<?php if(!empty($properties[\'hover-field-bg\'])) { ?>background: <?php echo $properties[\'hover-field-bg\']  ?>;<?php } ?>\r\n\t<?php } else { ?>\r\n\tbackground: <?php echo $properties[\'static-field-bg\']  ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container input:focus,\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container textarea:focus {\r\n\t<?php if(!empty($properties[\'focus-use-color\']) && $properties[\'focus-use-color\'] == \'yes\') { ?>\r\n\t\t<?php if(!empty($properties[\'focus-field-bg\'])) { ?>background: <?php echo $properties[\'focus-field-bg\']  ?>;<?php } ?>\r\n\t<?php } else { ?>\r\n\tbackground: <?php echo $properties[\'static-field-bg\']  ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n.upfront-contact-form.<?php echo $properties[\'id\'] ?> .upfront-field-container.upfront-submit-container .button {\r\n\t<?php if(!empty($properties[\'static-button-bg\'])) { ?> background: <?php echo $properties[\'static-button-bg\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'hover-use-transition\']) && !empty($properties[\'hover-transition-duration\']) && !empty($properties[\'hover-transition-easing\'] )) { ?>\r\n\t\ttransition: all <?php echo $properties[\'hover-transition-duration\'] ?>s <?php echo $properties[\'hover-transition-easing\']  ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n.upfront-contact-form.<?php echo $properties[\'id\'] ?> .upfront-field-container.upfront-submit-container .button:hover {\r\n\t<?php if(!empty($properties[\'hover-use-color\']) && $properties[\'hover-use-color\'] == \'yes\') { ?>\r\n\t\t<?php if(!empty($properties[\'hover-button-bg\'])) { ?>background: <?php echo $properties[\'hover-button-bg\']  ?>;<?php } ?>\r\n\t<?php } else { ?>\r\n\tbackground: <?php echo $properties[\'static-button-bg\']  ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n.upfront-contact-form.<?php echo $properties[\'id\'] ?> .upfront-field-container.upfront-submit-container .button:focus {\r\n\t<?php if(!empty($properties[\'focus-use-color\']) && $properties[\'focus-use-color\'] == \'yes\') { ?>\r\n\t\t<?php if(!empty($properties[\'focus-button-bg\'])) { ?>background: <?php echo $properties[\'focus-button-bg\']  ?>;<?php } ?>\r\n\t<?php } else { ?>\r\n\tbackground: <?php echo $properties[\'static-button-bg\']  ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n/* Borders Module */\r\n\r\n/* Fields */\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container input,\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container textarea {\r\n<?php if(!empty($properties[\'static-fields-useborder\']) && $properties[\'static-fields-useborder\'] == \'yes\') { ?>\r\n\t<?php if(!empty($properties[\'static-fields-borderwidth\']) && !empty($properties[\'static-fields-bordertype\']) && !empty($properties[\'static-fields-bordercolor\'])) { ?>\r\n\t\tborder: <?php echo $properties[\'static-fields-borderwidth\'] ?>px <?php echo $properties[\'static-fields-bordertype\'] ?> <?php echo $properties[\'static-fields-bordercolor\'] ?>;\r\n\t<?php } ?>\r\n<?php } else { ?>\r\n\t\tborder: none;\r\n<?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container input:hover,\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container textarea:hover {\r\n<?php if(!empty($properties[\'hover-fields-useborder\']) && $properties[\'hover-fields-useborder\'] == \'yes\') { ?>\r\n\t<?php if(!empty($properties[\'hover-fields-borderwidth\']) && !empty($properties[\'hover-fields-bordertype\']) && !empty($properties[\'hover-fields-bordercolor\'])) { ?>\r\n\t\tborder: <?php echo $properties[\'hover-fields-borderwidth\'] ?>px <?php echo $properties[\'hover-fields-bordertype\'] ?> <?php echo $properties[\'hover-fields-bordercolor\'] ?>;\r\n\t<?php } ?>\r\n<?php } else { ?>\r\n\t<?php if(!empty($properties[\'static-fields-useborder\'])) { ?>\r\n\t\t<?php if(!empty($properties[\'static-fields-borderwidth\']) && !empty($properties[\'static-fields-bordertype\']) && !empty($properties[\'static-fields-bordercolor\'])) { ?>\r\n\t\t\tborder: <?php echo $properties[\'static-fields-borderwidth\'] ?>px <?php echo $properties[\'static-fields-bordertype\'] ?> <?php echo $properties[\'static-fields-bordercolor\'] ?>;\r\n\t\t<?php } ?>\r\n\t<?php } else { ?>\r\n\t\tborder: none;\r\n\t<?php } ?>\r\n<?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container input:focus,\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container textarea:focus {\r\n<?php if(!empty($properties[\'focus-fields-useborder\']) && $properties[\'focus-fields-useborder\'] == \'yes\') { ?>\r\n\t<?php if(!empty($properties[\'focus-fields-borderwidth\']) && !empty($properties[\'focus-fields-bordertype\']) && !empty($properties[\'focus-fields-bordercolor\'])) { ?>\r\n\t\tborder: <?php echo $properties[\'focus-fields-borderwidth\'] ?>px <?php echo $properties[\'focus-fields-bordertype\'] ?> <?php echo $properties[\'focus-fields-bordercolor\'] ?>;\r\n\t<?php } ?>\r\n<?php } else { ?>\r\n\t<?php if(!empty($properties[\'static-fields-useborder\'])) { ?>\r\n\t\t<?php if(!empty($properties[\'static-fields-borderwidth\']) && !empty($properties[\'static-fields-bordertype\']) && !empty($properties[\'static-fields-bordercolor\'])) { ?>\r\n\t\t\tborder: <?php echo $properties[\'static-fields-borderwidth\'] ?>px <?php echo $properties[\'static-fields-bordertype\'] ?> <?php echo $properties[\'static-fields-bordercolor\'] ?>;\r\n\t\t<?php } ?>\r\n\t<?php } else { ?>\r\n\t\tborder: none;\r\n\t<?php } ?>\r\n<?php } ?>\r\n}\r\n\r\n/* Button */\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container.upfront-submit-container .button {\r\n<?php if(!empty($properties[\'static-button-useborder\']) && $properties[\'static-button-useborder\'] == \'yes\') { ?>\r\n\t<?php if(!empty($properties[\'static-button-borderwidth\']) && !empty($properties[\'static-button-bordertype\']) && !empty($properties[\'static-button-bordercolor\'])) { ?>\r\n\t\tborder: <?php echo $properties[\'static-button-borderwidth\'] ?>px <?php echo $properties[\'static-button-bordertype\'] ?> <?php echo $properties[\'static-button-bordercolor\'] ?>;\r\n\t<?php } ?>\r\n<?php } else { ?>\r\n\t\tborder: none;\r\n<?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container.upfront-submit-container .button:hover {\r\n<?php if(!empty($properties[\'hover-button-useborder\']) && $properties[\'hover-button-useborder\'] == \'yes\') { ?>\r\n\t<?php if(!empty($properties[\'hover-button-borderwidth\']) && !empty($properties[\'hover-button-bordertype\']) && !empty($properties[\'hover-button-bordercolor\'])) { ?>\r\n\t\tborder: <?php echo $properties[\'hover-button-borderwidth\'] ?>px <?php echo $properties[\'hover-button-bordertype\'] ?> <?php echo $properties[\'hover-button-bordercolor\'] ?>;\r\n\t<?php } ?>\r\n<?php } else { ?>\r\n\t<?php if(!empty($properties[\'static-button-useborder\'])) { ?>\r\n\t\t<?php if(!empty($properties[\'static-button-borderwidth\']) && !empty($properties[\'static-button-bordertype\']) && !empty($properties[\'static-button-bordercolor\'])) { ?>\r\n\t\t\tborder: <?php echo $properties[\'static-button-borderwidth\'] ?>px <?php echo $properties[\'static-button-bordertype\'] ?> <?php echo $properties[\'static-button-bordercolor\'] ?>;\r\n\t\t<?php } ?>\r\n\t<?php } else { ?>\r\n\t\tborder: none;\r\n\t<?php } ?>\r\n<?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-field-container.upfront-submit-container .button:focus {\r\n<?php if(!empty($properties[\'focus-button-useborder\']) && $properties[\'focus-button-useborder\'] == \'yes\') { ?>\r\n\t<?php if(!empty($properties[\'focus-button-borderwidth\']) && !empty($properties[\'focus-button-bordertype\']) && !empty($properties[\'focus-button-bordercolor\'])) { ?>\r\n\t\tborder: <?php echo $properties[\'focus-button-borderwidth\'] ?>px <?php echo $properties[\'focus-button-bordertype\'] ?> <?php echo $properties[\'focus-button-bordercolor\'] ?>;\r\n\t<?php } ?>\r\n<?php } else { ?>\r\n\t<?php if(!empty($properties[\'static-button-useborder\'])) { ?>\r\n\t\t<?php if(!empty($properties[\'static-button-borderwidth\']) && !empty($properties[\'static-button-bordertype\']) && !empty($properties[\'static-button-bordercolor\'])) { ?>\r\n\t\t\tborder: <?php echo $properties[\'static-button-borderwidth\'] ?>px <?php echo $properties[\'static-button-bordertype\'] ?> <?php echo $properties[\'static-button-bordercolor\'] ?>;\r\n\t\t<?php } ?>\r\n\t<?php } else { ?>\r\n\t\tborder: none;\r\n\t<?php } ?>\r\n<?php } ?>\r\n}\r\n\r\n/* Custom CSS */\r\n<?php if(!empty($properties[\'preset_style\'])) { ?><?php echo $properties[\'preset_style\'] ?><?php } ?>\r\n';});

define('elements/upfront-contact-form/js/settings',[
	'scripts/upfront/element-settings/settings',
	'scripts/upfront/element-settings/root-settings-panel',
	'scripts/upfront/preset-settings/util',
	'text!elements/upfront-contact-form/templates/preset-style.html'
], function(ElementSettings, RootSettingsPanel, Util, styleTpl) {
	var l10n = Upfront.Settings.l10n.contact_element;

	var GeneralPanel = RootSettingsPanel.extend({
		label: 'Empty label',
		title: l10n.general.label,
		settings: [
			{
				type: 'SettingsItem',
				title: l10n.contact_details,
				className: 'general_settings_item',
				fields: [
					{
						type: 'Email',
						property: 'form_email_to',
						label: l10n.general.send_to
					}
				]
			},
			{
				type: 'SettingsItem',
				title: l10n.fields.label,
				className: 'general_settings_item multiple_radio_no_padding',
				fields: [
					{
						type: 'Optional',
						property: 'show_subject',
						relatedField: 'form_subject_label',
						values: [
							{
								label: l10n.fields.show_subject,
								value: 'true'
							}
						]
					},
					{
						type: 'Optional',
						property: 'show_captcha',
						relatedField: 'form_captcha_label',
						values: [
							{
								label: l10n.fields.show_captcha,
								value: 'true'
							}
						],
					},
					{
						type: 'Select',
						className: 'contact_label_position',
						layout: "vertical",
						label: l10n.fields.label_localtion,
						change : function(value, parent){
							parent.model.set_property("form_label_position", value);
						},
						property: 'form_label_position',
						values: [
							{
								label: l10n.apr.above,
								value: 'above',
								icon: 'contact-above-field'
							},
							{
								label: l10n.apr.over,
								value: 'over',
								icon: 'contact-over-field'
							},
							{
								label: l10n.apr.inline,
								value: 'inline',
								icon: 'contact-inline-field'
							}
						]
					}
				]
			},
			{
				type: 'SettingsItem',
				title: l10n.validation.label,
				className: 'general_settings_item',
				fields: [
					{
						type: 'Radios',
						className: 'inline-radios plaintext-settings',
						property: 'form_validate_when',
						values: [
							{
								label: l10n.validation.on_field,
								value: 'field'
							},
							{
								label: l10n.validation.on_submit,
								value: 'submit'
							}
						]
					}
				]
			}
		]
	});

	var ContactFormSettings = ElementSettings.extend({
		panels: {
			General: GeneralPanel,
			Appearance: {
				mainDataCollection: 'contactPresets',
				styleElementPrefix: 'contact-preset',
				ajaxActionSlug: 'contact',
				panelTitle: l10n.settings,
				presetDefaults: Upfront.mainData.presetDefaults.contact,
				styleTpl: styleTpl,
				stateModules: {
					Static: [
						{
							moduleType: 'Colors',
							options: {
								title: l10n.colors_label,
								multiple: false,
								single: false,
								abccolors: [
									{
										name: 'static-field-bg',
										label: l10n.field_bg_label
									},
									{
										name: 'static-button-bg',
										label: l10n.button_bg_label
									},
								]
							}
						},
						{
							moduleType: 'Typography',
							options: {
								title: l10n.typography_label,
								state: 'static',
								toggle: false,
								fields: {
									typeface: 'static-font-family',
									fontstyle: 'static-font-style',
									weight: 'static-weight',
									style: 'static-style',
									size: 'static-font-size',
									line_height: 'static-line-height',
									color: 'static-font-color',
								},
								default_element: "field-labels",
								elements: [
									{ label: l10n.field_labels_label, value: "field-labels" },
									{ label: l10n.field_values_label, value: "field-values" },
									{ label: l10n.button_label, value: "button" },
								],
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'static-fields',
								title: '',
								label: 'Fields Border',
								fields: {
									use: 'static-fields-useborder',
									width: 'static-fields-borderwidth',
									type: 'static-fields-bordertype',
									color: 'static-fields-bordercolor',
								},
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'static-button',
								title: '',
								label: 'Button Border',
								fields: {
									use: 'static-button-useborder',
									width: 'static-button-borderwidth',
									type: 'static-button-bordertype',
									color: 'static-button-bordercolor',
								},
							}
						}
					],

					Hover: [
						{
							moduleType: 'Colors',
							options: {
								title: l10n.colors_label,
								multiple: false,
								single: false,
								toggle: true,
								prepend: 'hover-',
								prefix: 'static',
								fields: {
									use: 'hover-use-color',
								},
								abccolors: [
									{
										name: 'hover-field-bg',
										label: l10n.field_bg_label
									},
									{
										name: 'hover-button-bg',
										label: l10n.button_bg_label
									},
								]
							}
						},
						{
							moduleType: 'Typography',
							options: {
								title: l10n.typography_label,
								state: 'hover',
								toggle: true,
								prepend: 'hover-',
								prefix: 'static',
								fields: {
									use: 'hover-use-typography',
									typeface: 'hover-font-family',
									fontstyle: 'hover-font-style',
									weight: 'hover-weight',
									style: 'hover-style',
									size: 'hover-font-size',
									line_height: 'hover-line-height',
									color: 'hover-font-color',
								},
								default_element: "field-labels",
								elements: [
									{ label: l10n.field_labels_label, value: "field-labels" },
									{ label: l10n.field_values_label, value: "field-values" },
									{ label: l10n.button_label, value: "button" },
								],
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'hover-fields',
								title: '',
								label: 'Fields Border',
								prepend: 'hover-',
								prefix: 'static',
								fields: {
									use: 'hover-fields-useborder',
									width: 'hover-fields-borderwidth',
									type: 'hover-fields-bordertype',
									color: 'hover-fields-bordercolor',
								},
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'hover-button',
								title: '',
								label: 'Button Border',
								prepend: 'hover-',
								prefix: 'static',
								fields: {
									use: 'hover-button-useborder',
									width: 'hover-button-borderwidth',
									type: 'hover-button-bordertype',
									color: 'hover-button-bordercolor',
								},
							}
						},
						{
							moduleType: 'HovAnimation',
							options: {
								state: 'hover',
								title: '',
								toggle: true,
								fields: {
									use: 'hover-use-transition',
									duration: 'hover-transition-duration',
									easing: 'hover-transition-easing',
								}
							}
						}
					],

					Focus: [
						{
							moduleType: 'Colors',
							options: {
								title: l10n.colors_label,
								multiple: false,
								single: false,
								toggle: true,
								prepend: 'focus-',
								prefix: 'static',
								fields: {
									use: 'focus-use-color',
								},
								abccolors: [
									{
										name: 'focus-field-bg',
										label: l10n.field_bg_label
									},
									{
										name: 'focus-button-bg',
										label: l10n.button_bg_label
									},
								]
							}
						},
						{
							moduleType: 'Typography',
							options: {
								title: l10n.typography_label,
								state: 'focus',
								prepend: 'focus-',
								prefix: 'static',
								toggle: true,
								fields: {
									use: 'focus-use-typography',
									typeface: 'focus-font-family',
									fontstyle: 'focus-font-style',
									weight: 'focus-weight',
									style: 'focus-style',
									size: 'focus-font-size',
									line_height: 'focus-line-height',
									color: 'focus-font-color',
								},
								default_element: "field-labels",
								elements: [
									{ label: l10n.field_values_label, value: "field-values" },
									{ label: l10n.button_label, value: "button" },
								],
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'focus-fields',
								title: '',
								label: 'Fields Border',
								prepend: 'focus-',
								prefix: 'static',
								fields: {
									use: 'focus-fields-useborder',
									width: 'focus-fields-borderwidth',
									type: 'focus-fields-bordertype',
									color: 'focus-fields-bordercolor',
								},
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'focus-button',
								title: '',
								label: 'Button Border',
								prepend: 'focus-',
								prefix: 'static',
								fields: {
									use: 'focus-button-useborder',
									width: 'focus-button-borderwidth',
									type: 'focus-button-bordertype',
									color: 'focus-button-bordercolor',
								},
							}
						}
					]
				}
			}
		},
		title: 'Contact Element'
	});

	// Generate presets styles to page
	Util.generatePresetsToPage('contact', styleTpl);

	return ContactFormSettings;
});

(function($) {

// Require the Upfront data, so the template resolution can work minified too
define('ucontact',[
	'upfront-data',
	'elements/upfront-contact-form/js/settings',
	'text!elements/upfront-contact-form/templates/preset-style.html',
	'scripts/upfront/preset-settings/util',
], function (upfront_data, Settings, settingsStyleTpl, PresetUtil) {
var template = upfront_data.data && upfront_data.data.ucontact && upfront_data.data.ucontact.template ?
	upfront_data.data.ucontact.template
	: 'elements/upfront-contact-form/templates/ucontact.html'
;
require(['text!' + template], function(tpl){

var l10n = Upfront.Settings.l10n.contact_element;

/**
 * Define the model for Upfront Contact form, initializing the properities
 * to their default values.
 * @type {Upfront.Models.ObjectModel}
 */
var UcontactModel = Upfront.Models.ObjectModel.extend({
	/**
	 * The init function is called after the contructor and Model intialize.
	 * Here the default values for the model properties are set.
	 */
	init: function () {
		var properties = _.clone(Upfront.data.ucontact.defaults);
		properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + "-object");
		this.init_properties(properties);
	}
});

/**
 * View instance. Contact form structure and behaviour.
 * @type {Upfront.Views.ObjectView}
 */
var UcontactView = Upfront.Views.ObjectView.extend({
	tpl: Upfront.Util.template(tpl),

	initialize: function(options){
		if(! (this.model instanceof UcontactModel)){
			this.model = new UcontactModel({properties: this.model.get('properties')});
		}

		this.constructor.__super__.initialize.call(this, [options]);
		Upfront.Events.on('command:layout:save_success', this.checkDeleteElement, this);

		this.events = _.extend({}, this.events, {
			'click button.submit-field' : 'handleButtonclick',
			'click .upfront-field-container label': 'handleButtonclick',
			'dblclick button.submit-field' : 'editButtontext',
			'dblclick .upfront-field-container > label' : 'editLabeltext'
		});

		this.delegateEvents();

		this.listenTo(Upfront.Events, "theme_colors:update", this.update_colors, this);
	},

	update_colors: function () {

		var me = this,
			preset = this.model.get_property_value_by_name("preset"),
			props = PresetUtil.getPresetProperties('contact', preset) || {}
		;

		if (_.size(props) <= 0) return false; // No properties, carry on

		PresetUtil.updatePresetStyle('contact', props, settingsStyleTpl);

	},

	on_render: function() {

		var me = this;
		$button = this.$el.find('button.submit-field > span');

		$button.ueditor({
			linebreaks: true,
			disableLineBreak: true,
			//focus: true,

			airButtons: ['upfrontLink', 'stateAlignCTA', 'upfrontIcons'],
			autostart: false
		})
		.on('stop', function() {

			var ed = $button.data("ueditor"),
					text = ''
				;

			try { text = $button.text(); } catch (e) { text = ''; }

			if (text) me.model.set_property('form_button_text', text, true);
		})
		;

		$labels = this.$el.find('.upfront-field-container > label');

		$labels.each(function() {
			//var content = $(this).html();
			//$(this).html('').append($('<div>').html(content));
			$label = $(this);//.children('div');
			$label.ueditor({
				linebreaks: true,
				disableLineBreak: true,
				//focus: true,

				airButtons: ['upfrontIcons'],
				autostart: false
			})
			.on('start', function(e) {
				$(e.target).closest('.upfront-field-container').children('input, textarea').attr('placeholder', '');
				$(e.target).css('opacity', 1);

			})
			.on('stop', function(e) {
				$label = $(this);

				var ed = $label.data("ueditor"),
						text = ''
					;

				if(me.model.get_property_value_by_name('form_label_position') == 'over') {
					$label.find('span').remove();
					text = $label.text();

					$(e.target).closest('.upfront-field-container').children('input, textarea').attr('placeholder', text);

					$(e.target).css('opacity', 0 );
				}
				else {

					try { text = $label.text() } catch (e) { text = ''; }
				}

				var targetproperty = false;

				if($label.attr('for') == 'sendername')
					targetproperty = 'form_name_label';
				else if($label.attr('for') == 'senderemail')
					targetproperty = 'form_email_label';
				else if($label.attr('for') == 'sendermessage')
					targetproperty = 'form_message_label';
				else if($label.attr('for') == 'subject')
					targetproperty = 'form_subject_label';
				else if($label.attr('for') == 'realPerson')
					targetproperty = 'form_captcha_label';

				if (text && targetproperty) me.model.set_property(targetproperty, text, true);
			})
			;

			if(me.model.get_property_value_by_name('form_label_position') == 'over') {
				$label.css('opacity', 0 );
				$label.siblings('input, textarea').attr('placeholder', $label.text());
			}
		});
	},
	handleButtonclick: function(e) {
		e.preventDefault();
	},
	editButtontext: function(e) {
		e.preventDefault();
		e.stopPropagation();

		$button = this.$el.find('button.submit-field > span');
		var ueditor = $button.data('ueditor');
		
		//Check if ueditor is defined ( prevent JS error when double click for select all )
		if(typeof ueditor !== "undefined") {
			ueditor.start();
		}
	},
	editLabeltext: function(e) {
		e.preventDefault();
		e.stopPropagation();

		$label = $(e.target);
		$label.css('opacity', 1);
		var ueditor = $label.data('ueditor');

		ueditor.start();


	},
	checkDeleteElement: function() {
	},
	get_content_markup: function() {
		var args = _.extend({}, this.extract_properties(), {
			message: false,
			field_classes: this.getFieldStyleClass(),
			validate: '',
			entity_id: '',
			placeholders: { },
			/*	name: this.getPlaceholder('form_name_label'),
				email: this.getPlaceholder('form_email_label'),
				subject: this.getPlaceholder('form_subject_label'),
				message: this.getPlaceholder('form_message_label')
			},*/
			ids: {
				name: 'sendername',
				email:  'senderemail',
				message: 'sendermessage',
				subject: 'subject',
				captcha: 'realPerson'
			},
			values: {}
		});

		args.preset = args.preset || 'default';

		args.show_subject = args.show_subject && args.show_subject.length;
		args.show_captcha = args.show_captcha && args.show_captcha.length;
		args.form_add_title = args.form_add_title && args.form_add_title.length;

		args.l10n = l10n.template;

		return this.tpl(args);
	},
	/**
	 * A shorcut for the this.model.get_property_value_by_name function
	 * @param  {String} property Property name
	 * @return {String}          The value of the property. False if the property doesn't exists.
	 */
	property_value: function(property){
		return this.model.get_property_value_by_name(property);
	},

	extract_properties: function() {
		var props = {};
		this.model.get('properties').each(function(prop){
			props[prop.get('name')] = prop.get('value');
		});
		return props;
	},

	/**
	 * Get the classes for the field container tags, based on the element properties.
	 * The label position depends on this function.
	 * @return {String} Classes for the field container tags.
	 */
	getFieldStyleClass: function () {
		return ' ucontact-label-' + this.property_value('form_label_position');
	},

	/**
	 * Get the placeholders for the form inputs when the labels are over the fields.
	 * @param  {String} field Label property name.
	 * @return {String}       The HTML placeholder attribute if it is needed.
	 */
	getPlaceholder: function (field) {
		if(this.property_value('form_label_position') == 'over')
			return 'placeholder="' + this.property_value(field)  + '"';
		return '';
	}
});

/**
 * The upfront editor element class. This will be used to add a contact form element
 * @type {Upfront.Views.Editor.Sidebar.Element}
 */
var UcontactElement = Upfront.Views.Editor.Sidebar.Element.extend({
    priority: 110,
	/**
	 * Print the draggable element into the sidebar panel.
	 * @return {null}
	 */
	render: function () {
		this.$el.addClass('upfront-icon-element upfront-icon-element-contact');
		this.$el.html(l10n.element_name);
	},

	/**
	 * Insantiates a module with the contact form instance and add it to the workspace.
	 * @return {null}
	 */
	add_element: function() {
		var object = new UcontactModel(),
			module = new Upfront.Models.Module({
				"name": "",
				"properties": [
					{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
					{"name": "class", "value": "c12 upfront-contact_form_module"},
					{"name": "has_settings", "value": 0},
					{"name": "row", "value": Upfront.Util.height_to_row(435)}
				],
				"objects": [
					object // The anonymous module will contain our contact form object model
				]
			})
		;
		this.add_module(module);
	}
});

// ----- Bringing everything together -----
// The definitions part is over.
// Now, to tie it all up and expose to the Subapplication.

Upfront.Application.LayoutEditor.add_object("Ucontact", {
	"Model": UcontactModel,
	"View": UcontactView,
	"Element": UcontactElement,
	"Settings": Settings,
	cssSelectors: {
		'label': {label: l10n.css.labels_label, info: l10n.css.labels_info},
		'.ucontact-input': {label: l10n.css.fields_label, info: l10n.css.fields_info},
		'.textarea-field' : {label: l10n.css.msg_label, info: l10n.css.msg_info},
		'.ucontact-field-error': {label: l10n.css.err_label, info: l10n.css.err_info},
		'.submit-field': {label: l10n.css.send_label, info: l10n.css.send_info}
	},
	cssSelectorsId: Upfront.data.ucontact.defaults.type
});

Upfront.Models.UcontactModel = UcontactModel;
Upfront.Views.UcontactView = UcontactView;

}); // End define
}); // End require

})(jQuery);


define('text!elements/upfront-gallery/tpl/ugallery.html',[],function () { return '<div\r\n\tclass="ugallery ugallery_publish <?php if(!empty($in_editor)) { ?>ugallery-in-editor<?php } ?>"\r\n\tdata-thumb-padding="<?php echo $thumbPadding ?>"\r\n\tdata-thumb-side-padding="<?php echo $sidePadding ?>"\r\n\tdata-thumb-bottom-padding="<?php echo $bottomPadding ?>"\r\n\tdata-thumb-proportions="<?php echo $thumbProportions ?>"\r\n\tdata-thumb-lock-padding="<?php echo $lockPadding ?>"\r\n\tdata-lightbox-show-close="<?php echo $lightbox_show_close ? \'true\' : \'false\' ?>"\r\n\tdata-lightbox-click-out-close="<?php echo $lightbox_click_out_close ? \'true\' : \'false\' ?>"\r\n\tdata-lightbox-show-image-count="<?php echo $lightbox_show_image_count ? \'true\' : \'false\' ?>"\r\n\tdata-lightbox-active-area-bg="<?php echo $lightbox_active_area_bg ?>"\r\n\tdata-lightbox-overlay-bg="<?php echo $lightbox_overlay_bg ?>"\r\n\tdata-styles="<?php echo $styles ?>"\r\n>\r\n<?php if ($labelFilters[\'length\'] || !empty($in_editor)){ ?>\r\n<div class="ugallery_labels <?php if($in_editor) { ?>ugallery_labels-enabled-<?php echo $labelFilters[\'length\'] ?><?php } ?>">\r\n\t<?php for($i=0; $i<$labels_length; $i++) { ?>\r\n\t\t<a href="#" class="ugallery_label_filter <?php echo $i == 0 ? \'filter_selected\' : \'\' ?>" rel="label_<?php echo $labels[$i][\'id\'] ?>"><?php echo $labels[$i][\'text\'] ?></a>\r\n\t<?php } ?>\r\n\t</div>\r\n<?php } ?>\r\n<?php if($imagesLength){ ?>\r\n\t<div class="ugallery_items ugallery_grid" rel="<?php echo $element_id ?>">\r\n\t<?php for($i=0; $i<$imagesLength; $i++) { ?>\r\n\t<div class="ugallery_item ugallery_item_<?php echo !empty($images[$i][\'imageLinkType\']) && $images[$i][\'imageLinkType\'] == \'image\' ? \'image\' : $images[$i][\'imageLinkType\'] ?> <?php if($captionType === \'over\') { ?>ugallery_caption_on_hover_<?php echo $showCaptionOnHover[\'length\'] ?><?php } ?>" style="position:relative; width:<?php echo $thumbWidth ?>px;" rel="<?php echo $images[$i][\'id\'] ?>" data-groups=\'[<?php echo $image_labels[$images[$i][\'id\']] ?>]\'>\r\n\t\t<?php $images[$i][\'imageLinkType\'] = !empty($images[$i][\'imageLinkType\']) ? $images[$i][\'imageLinkType\'] : false; ?>\r\n\t\t  <?php if ($images[$i][\'imageLinkType\'] !== \'unlink\') { ?>\r\n\t\t\t<a class="ugallery_link ugallery_link<?php echo !empty($images[$i][\'imageLinkType\']) && $images[$i][\'imageLinkType\'] == \'image\' ? \' ugallery_lightbox_link\' : $images[$i][\'imageLinkType\'] ?>" href="<?php echo $images[$i][\'imageLinkUrl\'] ?>" target="<?php echo $images[$i][\'imageLinkTarget\'] ?>" title="">\r\n\t\t\t<?php } ?>\r\n\t\t\t\t<img src="<?php echo $images[$i][\'src\'] ?>" alt="" class="ugallery-image" style="<?php echo !empty($images[$i][\'loading\']) && $images[$i][\'loading\'] ? \'display:none;\' : \'\' ?> margin-left:<?php echo $images[$i][\'margin\'][\'left\'] ?>px;  margin-top:<?php echo $images[$i][\'margin\'][\'top\'] ?>px;width:<?php echo $thumbWidth ?>px; height:<?php echo $thumbHeight ?>px">\r\n\t\t\t\t<?php if(!empty($in_editor)) { ?>\r\n\t\t\t\t<i class="remove-image"></i>\r\n\t\t\t\t<?php } ?>\r\n\r\n\t\t\t\t<?php if ($usingNewAppearance === false) { ?>\r\n\t\t\t\t\t<?php if($captionType != \'none\' || !empty($in_editor)) { ?>\r\n\t\t\t\t\t<div class="ugallery-thumb-title <?php if($captionType === \'over\') { ?>ugallery-caption-on-hover-<?php echo $showCaptionOnHover[\'length\'] ?><?php } ?> ugallery-caption-<?php echo $captionType ?><?php echo $captionUseBackground ? \' ugallery-padded-caption\' : \'\' ?>"><?php echo $images[$i][\'title\'] ?></div>\r\n\t\t\t\t\t<?php } ?>\r\n\t\t\t\t<?php } else { ?>\r\n\t\t\t\t\t<?php if(($properties[\'captionType\'] != \'none\' || !empty($in_editor)) && !empty($properties[\'use_captions\'])) { ?>\r\n\t\t\t\t\t<div class="ugallery-thumb-title <?php if($properties[\'captionType\'] === \'over\') { ?>ugallery-caption-on-hover-<?php echo $properties[\'showCaptionOnHover\'] ?><?php } ?> ugallery-caption-<?php echo $properties[\'captionType\'] ?>"><?php echo $images[$i][\'title\'] ?></div>\r\n\t\t\t\t\t<?php } ?>\r\n\t\t\t\t<?php } ?>\r\n\t\t\t<?php if($linkTo == \'image\'){ ?>\r\n\t\t\t<div class="ugallery_lb_text" rel="<?php echo $images[$i][\'id\'] ?>"><?php if (!$editing && $images[$i][\'caption\'] != \'Image description\') { ?><?php echo $images[$i][\'caption\'] ?><?php } ?></div>\r\n\t\t\t<?php } ?>\r\n\r\n\t\t\t<?php if ($images[$i][\'imageLinkType\'] !== \'unlink\') { ?>\r\n\t\t\t</a>\r\n\t\t\t<?php } ?>\r\n\t\t</div><?php } ?>\r\n\t</div>\r\n<?php } else { ?>\r\n\t<?php if(! $editing) { ?>\r\n\t\t<?php echo $l10n[\'no_images\'] ?>\r\n\t<?php } else { ?>\r\n\t\t<div class="ugallery-starting-wrapper upfront-ui upfront-initial-overlay-wrapper">\r\n\t\t\t\t<div class="ugallery-starting-container upfront-initial-overlay-wrapper">\r\n\t\t\t\t\t<span class="upfront-image-resizethiselement"><?php echo $l10n[\'add_img\'] ?></span>\r\n\t\t\t\t\t<div class=""><a class="upfront-image-select button" href="#" title="<?php echo $l10n[\'add_images\'] ?>">+</a></div>\r\n\t\t\t\t</div>\r\n\t\t</div>\r\n\t<?php } ?>\r\n<?php } ?>\r\n</div>\r\n<?php if ($usingNewAppearance === false) { ?>\r\n<style>\r\n#<?php echo $element_id ?> .ugallery-thumb-title {\r\n\tbackground: <?php echo  $captionBackground ?>;\r\n\t<?php if($fitThumbCaptions[0] === \'true\') { ?>\r\n\toverflow: hidden;\r\n\theight: <?php echo $thumbCaptionsHeight ?>px;\r\n\t<?php } ?>\r\n}\r\n</style>\r\n<?php } ?>\r\n';});


define('text!elements/upfront-gallery/tpl/sorting-style.html',[],function () { return '<style id="sorting-style">\r\n\t#{{ element_id }} .ugallery_item {\r\n\t\tmargin-right: {{ thumbPadding }}px;\r\n\t\t{[ if (even_padding.length) { ]}\r\n\t\tmargin-bottom: {{ thumbPadding }}px;\r\n\t\t{[ } ]}\r\n\t}\r\n\t#{{ element_id }} .ugallery_item:nth-child({{ itemsInRow }}n) {\r\n\t\tmargin-right: 0;\r\n\t}\r\n</style>\r\n';});


define('text!elements/upfront-gallery/tpl/ugallery_editor.html',[],function () { return '<div>\r\n<!--\r\n\tWrap everything in a div to convert this file\'s content in a jquery element\r\n\tso it is possible to use $.find.\r\n-->\r\n\r\n<script type="text/template" id="selector-tpl">\r\n\t<div id="upront-image-placeholder" class="upfront-image-section">\r\n\t\t<div class="upfront-image-selector-container">\r\n\t\t\t<h2>{{ l10n.drop_images }}</h2>\r\n\t\t\tor<br>\r\n\t\t\t<a class="button select-files" href="#">{{ l10n.select_images }}</a>\r\n\t\t\t<div id="upfront-image-maxsize">{{ l10n.max_upload_size }}</div>\r\n\t\t\t{{ l10n.or_browse }}\r\n\t\t\t<div class="upfront-image-media-container">\r\n\t\t\t<i class="icon-picture"></i> <a class="open-media-gallery" href="#">{{ l10n.media_gallery }}</a>\r\n\t\t\t</div>\r\n\t\t\t<span class="dragimagehand"></span>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="progress-tpl">\r\n\t<div id="upfront-image-uploading" class="upfront-image-section">\r\n\t\t<h2>{{ l10n.uploading }}</h2>\r\n\t\t<div class="upfront-progress-container">\r\n\t\t\t<div id="upfront-progress"></div>\r\n\t\t</div>\r\n\t</div>\r\n</script>\r\n\r\n<script type="text/template" id="editor-tpl">\r\n\t<div id="upfront-image-edit" class="upfront-image-section">\r\n\t\t<div id="uimage-canvas-container" style="position:absolute">\r\n\t\t\t<div id="uimage-canvas" style="position:relative; overflow:hidden;">\r\n\t\t\t\t<img class="uimage-img {{ rotation }}" src="{{src}}" style="width:{{size.width}}px; height:{{size.height}}px;position:absolute">\r\n\t\t\t\t<div id="uimage-mask" class="image-edit-mask" style="position:absolute; top:{{offset.top}}px; left:{{offset.left}}px"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class="image-edit-resize image-edit-control"><i class="icon-resize-full ui-resizable-handle ui-resizable-handle-se"></i></div>\r\n\t\t\t<div class="image-edit-rotate image-edit-control"><i class="icon-repeat"></i></div>\r\n\t\t</div>\r\n\t\t<div class="image-edit-save-container">\r\n\t\t\t<div class="no-shadow">\r\n\t\t\t\t<a class="image-edit-save" href="#"><i class="icon-ok"></i> {{ l10n.like }}</a>\r\n\t\t\t\t<a class="image-edit-change" href="#"><i class="icon-upload-alt "></i> {{ l10n.upload_different }}</a>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</script>\r\n\r\n\r\n<script type="text/template" id="upload-form-tpl">\r\n<form id="upfront-upload-image" name="upfront-upload-image" enctype="multipart/form-data" method="post" action="{{url}}">\r\n\t<input type="file" name="media[]" id="upfront-image-file-input" multiple="multiple">\r\n\t<input type="hidden" name="action" value="upfront-media-upload">\r\n\t<input type="submit" value="{{ l10n.upload }}">\r\n</form>\r\n</script>\r\n\r\n<script type="text/template" id="details-tpl">\r\n<div class="upfront-settings-panel">\r\n\t<input type="hidden" id="ugallery-image-id" value="{{id}}">\r\n\t<h3>{{ l10n.edit_details }}</h3>\r\n\t<div class="upfront-field-wrap">\r\n\t\t<label for="ugallery-image-title">{{ l10n.title }}</label>\r\n\t\t<input type="text" name="ugallery-image-title" value="{{title}}" class="upfront-field-text">\r\n\t</div>\r\n\t<div class="upfront-field-wrap">\r\n\t\t<label for="ugallery-image-title">{{ l10n.caption }}</label>\r\n\t\t<input type="text" name="ugallery-image-caption" value="{{caption}}" class="upfront-field-text">\r\n\t</div>\r\n\t<div class="upfront-field-wrap">\r\n\t\t<label for="ugallery-image-title">{{ l10n.alt }}</label>\r\n\t\t<input type="text" name="ugallery-image-alt" value="{{alt}}" class="upfront-field-text">\r\n\t</div>\r\n\t<div class="upfront-settings-button_panel">\r\n\t\t<button type="button" class="upfront-save_settings"><i class="icon-ok"></i> {{ l10n.ok }}</button>\r\n\t</div>\r\n\r\n\t<div class="upfront-field-wrap upfront-additive_multiselection upfront-media-controls ">\r\n\t\t<label for="ugallery-image-labels">{{ l10n.labels }}</label>\r\n\t\t<div class="existing_labels">\r\n\t\t<a href="#remove" class="upfront-icon upfront-icon-media-label-delete" data-idx="2">{{ l10n.wtf }}</a>\r\n\t\t</div>\r\n\t\t<div class="label_selector">\r\n\t\t\t<input type="text" name="ugallery-image-labels" placeholder="{{ l10n.add_new_label }}" class="upfront-field-text">\r\n\t\t\t<div class="labels_list">\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\r\n</div>\r\n</script>\r\n\r\n</div>\r\n';});


define('text!elements/upfront-gallery/tpl/lightbox_settings.html',[],function () { return '<div id="gallery-lb-settings-button" class="upfront-icon-button upfront-icon-button-setting"></div>\r\n<div class="upfront-inline-modal-wrap" id="gallery-lb-settings">\r\n\t<div class="upfront-inline-modal-content">\r\n\t\t<div class="upfront-region-bg-setting-name">\r\n\t\t\t<div class="upfront-region-bg-setting-name-edit">\r\n\t\t\t\t<span class="upfront-region-name-edit-value">Gallery Lightbox</span>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\r\n\t\t<div class="upfront-region-bg-setting-lightbox-region clearfix"></div>\r\n\r\n\t\t<div class="upfront-region-bg-setting-footer clearfix">\r\n\t\t\t<div class="upfront-region-bg-setting-edit-css upfront-icon upfront-icon-edit-css edit-lightbox-css">\r\n\t\t\t\t<span>{{edit_lightbox_css}}</span>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<button type="button" class="upfront-inline-modal-save">Ok</button>\r\n\t</div>\r\n</div>\r\n';});

define('elements/upfront-gallery/js/settings/thumbnail-fields',[
	'scripts/upfront/element-settings/root-settings-panel'
], function(RootSettingsPanel) {
	var l10n = Upfront.Settings.l10n.gallery_element;

	var updateFromSlider = function(model, name, value, eventName) {
		model.set_property(name, value);
		model.trigger(eventName);
	};

	var debouncedUpdateFromSlider = _.debounce(updateFromSlider, 1000);

	var ThumbnailFields = RootSettingsPanel.extend({
		className: 'ugallery-thumbnail-fields upfront-settings_panel',
		settings: [
			{
				type: 'SettingsItem',
				className: 'general_settings_item',
				title: l10n.thumb.thumb_settings,
				fields: [
					{
						type: 'Select',
						className: 'thumb-propostions',
						property: 'thumbProportions',
						label: l10n.thumb.ratio,
						layout: 'vertical',
						default_value: '1',
						values: [
							{
								label: l10n.thumb.theme,
								value: 'theme',
								icon: 'gallery-crop-theme'
							},
							{
								label: '1:1',
								value: '1',
								icon: 'gallery-crop-1_1'
							},
							{
								label: '2:3',
								value: '0.66',
								icon: 'gallery-crop-2_3'
							},
							{
								label: '4:3',
								value: '1.33',
								icon: 'gallery-crop-4_3'
							}
						],
						change: function(value, me) {
							me.model.set_property('thumbProportions', value);
							me.model.trigger('change:thumbProportions');
						}
					}
				]
			},
			{
				type: 'SettingsItem',
				className: 'general_settings_item',
				title: l10n.thumb.size,
				fields: [
					{
						type: 'Slider',
						property: 'thumbWidth',
						className: 'thumb-size-slider',
						min: 100,
						max: 250,
						step: 5,
						label: l10n.thumb.size,
						default_value: 150,
						change: function(value, me)
						{
							var f = me.settings._wrapped[1].fields._wrapped[1];
							f.get_field().val(value);
							debouncedUpdateFromSlider(me.model, 'thumbWidth', value, 'change:thumbWidth');
						}
					},
					{
						type: 'Number',
						className: 'thumb-size-number',
						property: 'thumbWidthNumber',
						default_value: 0,
						min: 100,
						max: 250,
						change: function(value, me) {
							//Update slider value
							var s = me.settings._wrapped[1].fields._wrapped[0];
							s.$el.find('#'+s.get_field_id()).slider('value', value);
							s.get_field().val(value);
							s.trigger('changed');

							//Update slider number value
							var f = me.settings._wrapped[1].fields._wrapped[1];
							f.get_field().val(value);

							// Lower opacity if value is bigger than the slider MAX_VALUE
							if(value > 250) {
								me.$el.find('.thumb-size-slider').css('opacity', 0.6);
							} else {
								me.$el.find('.thumb-size-slider').css('opacity', 1);
							}
							debouncedUpdateFromSlider(me.model, 'thumbWidth', value, 'change:thumbWidth');
						}
					}
				]
			},
			{
				type: 'SettingsItem',
				className: 'general_settings_item',
				title: l10n.thumb.spacing,
				fields: [
					{
						type: 'Checkboxes',
						className: 'gallery-padding-lock',
						property: 'lockPadding',
						label: "",
						default_value: 1,
						multiple: false,
						values: [
							{ label: '', value: 'yes' }
						],
						change: function(value, me) {
							me.model.set_property('lockPadding', value);
						},
						show: function(value, me) {
							//Toggle border radius fields
							if(value == "yes") {
								me.$el.find('.thumb-padding-slider').show();
								me.$el.find('.thumb-padding-number').show();
								me.$el.find('.thumb-side-padding-slider').hide();
								me.$el.find('.thumb-side-padding-number').hide();
								me.$el.find('.thumb-bottom-padding-slider').hide();
								me.$el.find('.thumb-bottom-padding-number').hide();
							} else {
								me.$el.find('.thumb-padding-slider').hide();
								me.$el.find('.thumb-padding-number').hide();
								me.$el.find('.thumb-side-padding-slider').show();
								me.$el.find('.thumb-side-padding-number').show();
								me.$el.find('.thumb-bottom-padding-slider').show();
								me.$el.find('.thumb-bottom-padding-number').show();
							}
						}
					},
					{
						type: 'Slider',
						property: 'thumbPadding',
						className: 'thumb-padding-slider',
						min: 0,
						max: 50,
						step: 1,
						label: l10n.thumb.spacing,
						default_value: 15,
						valueTextFilter: function(value){
							return value + 'px';
						},
						change: function(value, me) {
							var f = me.settings._wrapped[2].fields._wrapped[2];
							f.get_field().val(value);
							// me.model.set_property('thumbPaddingNumber', value);
							debouncedUpdateFromSlider(me.model, 'thumbPadding', value, 'change:thumbPadding');
						}
					},
					{
						type: 'Number',
						className: 'thumb-padding-number',
						property: 'thumbPaddingNumber',
						default_value: 15,
						change: function(value, me) {
							//Update slider value
							var s = me.settings._wrapped[2].fields._wrapped[1];
							s.$el.find('#'+s.get_field_id()).slider('value', value);
							s.get_field().val(value);
							s.trigger('changed', value);

							var f = me.settings._wrapped[2].fields._wrapped[2];
							f.get_field().val(value);

							//Lower opacity if value is bigger than the slider MAX_VALUE
							if(value > 50) {
								me.$el.find('.thumb-padding-slider').css('opacity', 0.6);
							} else {
								me.$el.find('.thumb-padding-slider').css('opacity', 1);
							}
							// me.model.set_property('thumbPaddingNumber', value);
							debouncedUpdateFromSlider(me.model, 'thumbPadding', value, 'change:thumbPadding');
						}
					},
					{
						type: 'Slider',
						property: 'sidePadding',
						className: 'thumb-side-padding-slider',
						min: 0,
						max: 50,
						step: 1,
						label: l10n.thumb.side_spacing,
						change: function(value, me) {
							var f = me.settings._wrapped[2].fields._wrapped[4];
							f.get_field().val(value);
							// me.model.set_property('thumbSidePaddingNumber', value);
							debouncedUpdateFromSlider(me.model, 'sidePadding', value, 'change:thumbPadding');
						}
					},
					{
						type: 'Number',
						className: 'thumb-side-padding-number',
						property: 'thumbSidePaddingNumber',
						default_value: 0,
						change: function(value, me) {
							var f = me.settings._wrapped[2].fields._wrapped[4];
							f.get_field().val(value);

							//Update slider value
							var s = me.settings._wrapped[2].fields._wrapped[3];
							s.$el.find('#'+s.get_field_id()).slider('value', value);
							s.get_field().val(value);
							s.trigger('changed', value);

							//Lower opacity if value is bigger than the slider MAX_VALUE
							if(value > 50) {
								me.$el.find('.thumb-side-padding-slider').css('opacity', 0.6);
							} else {
								me.$el.find('.thumb-side-padding-slider').css('opacity', 1);
							}
							// me.model.set_property('thumbSidePaddingNumber', value);
							debouncedUpdateFromSlider(me.model, 'sidePadding', value, 'change:thumbPadding');
						}
					},
					{
						type: 'Slider',
						property: 'bottomPadding',
						className: 'thumb-bottom-padding-slider',
						min: 0,
						max: 50,
						step: 1,
						label: l10n.thumb.bottom_spacing,
						change: function(value, me) {
							var f = me.settings._wrapped[2].fields._wrapped[6];
							f.get_field().val(value);
							// me.model.set_property('thumbBottomPaddingNumber', value);
							debouncedUpdateFromSlider(me.model, 'bottomPadding', value, 'change:thumbPadding');
						}
					},
					{
						type: 'Number',
						className: 'thumb-bottom-padding-number',
						property: 'thumbBottomPaddingNumber',
						default_value: 0,
						change: function(value, me) {
							var f = me.settings._wrapped[2].fields._wrapped[6];
							f.get_field().val(value);

							//Update slider value
							var s = me.settings._wrapped[2].fields._wrapped[5];
							s.$el.find('#'+s.get_field_id()).slider('value', value);
							s.get_field().val(value);
							s.trigger('changed', value);

							//Lower opacity if value is bigger than the slider MAX_VALUE
							if(value > 50) {
								me.$el.find('.thumb-bottom-padding-slider').css('opacity', 0.6);
							} else {
								me.$el.find('.thumb-bottom-padding-slider').css('opacity', 1);
							}
							// me.model.set_property('thumbBottomPaddingNumber', value);
							debouncedUpdateFromSlider(me.model, 'bottomPadding', value, 'change:thumbPadding');
						}
					}
				]
			}
		],
		title: 'General Settings'
	});

	return ThumbnailFields;
});


define('text!elements/upfront-gallery/tpl/preset-style.html',[],function () { return '.<?php echo $properties[\'id\'] ?> .ugallery_item {\r\n\t <?php if(!empty($properties[\'useborder\'])) { ?>\r\n        <?php if(!empty($properties[\'borderwidth\']) && !empty($properties[\'bordertype\']) && !empty($properties[\'bordercolor\'])) { ?>border: <?php echo $properties[\'borderwidth\'] ?>px <?php echo $properties[\'bordertype\'] ?> <?php echo $properties[\'bordercolor\'] ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        border: none;\r\n    <?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .ugallery_item {\r\n\t<?php if(!empty($properties[\'useradius\'])) { ?>\r\n        border-radius: <?php echo $properties[\'borderradius1\'] ? $properties[\'borderradius1\'] : 0 ?>px <?php echo $properties[\'borderradius2\'] ? $properties[\'borderradius2\'] : 0 ?>px <?php echo $properties[\'borderradius4\'] ? $properties[\'borderradius4\'] : 0 ?>px <?php echo $properties[\'borderradius3\'] ? $properties[\'borderradius3\'] : 0 ?>px;\r\n    <?php } else { ?>\r\n        border-radius: 0px;\r\n    <?php } ?>\r\n\toverflow: hidden;\r\n}\r\n\r\n.upfront-output-ugallery.<?php echo $properties[\'id\'] ?> .ugallery-thumb-title p,\r\n.upfront-output-ugallery.<?php echo $properties[\'id\'] ?> .ugallery-thumb-title,\r\n.upfront-object.upfront-gallery.<?php echo $properties[\'id\'] ?> .ugallery-thumb-title p,\r\n.upfront-object.upfront-gallery.<?php echo $properties[\'id\'] ?> .ugallery-thumb-title\r\n{\r\n\t<?php if(!empty($properties[\'caption-text\'])) { ?>\r\n\tcolor: <?php echo $properties[\'caption-text\']  ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n.upfront-output-ugallery.<?php echo $properties[\'id\'] ?> .ugallery-thumb-title,\r\n.upfront-object.upfront-gallery.<?php echo $properties[\'id\'] ?> .ugallery-thumb-title \r\n{\r\n\t<?php if(!empty($properties[\'caption-bg\'])) { ?>\r\n\tbackground: <?php echo $properties[\'caption-bg\'] ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n.upfront-output-ugallery.<?php echo $properties[\'id\'] ?> .ugallery-thumb-title, \r\n.upfront-object.upfront-gallery.<?php echo $properties[\'id\'] ?> .ugallery-thumb-title\r\n{\r\n\t<?php if($properties[\'caption-height\'] == \'fixed\' && !empty($properties[\'thumbCaptionsHeight\'])) { ?>\r\n\t\toverflow: hidden;\r\n\t\theight: <?php echo $properties[\'thumbCaptionsHeight\'] ?>px;\r\n\t<?php } ?>\r\n}\r\n\r\n/* Custom CSS */\r\n<?php if(!empty($properties[\'preset_style\'])) { ?><?php echo $properties[\'preset_style\'] ?><?php } ?>\r\n';});

define('elements/upfront-gallery/js/settings',[
	'scripts/upfront/preset-settings/util',
	'elements/upfront-gallery/js/settings/thumbnail-fields',
	'scripts/upfront/element-settings/settings',
	'text!elements/upfront-gallery/tpl/preset-style.html'
], function(Util, ThumbnailFields, ElementSettings, presetTpl) {
	var l10n = Upfront.Settings.l10n.gallery_element;

	var UgallerySettings = ElementSettings.extend({
		panels: {
			Thumbnail: ThumbnailFields,
			Appearance: {
				mainDataCollection: 'galleryPresets',
				styleElementPrefix: 'gallery-preset',
				ajaxActionSlug: 'gallery',
				panelTitle: l10n.settings,
				presetDefaults: Upfront.mainData.presetDefaults.gallery,
				styleTpl: presetTpl,
				stateModules: {
					Global: [
						{
							moduleType: 'Radius',
							options: {
								state: 'global',
								max_value: 100,
								fields: {
									use: 'useradius',
									lock: 'borderradiuslock',
									radius: 'radius',
									radius_number: 'radius_number',
									radius1: 'borderradius1',
									radius2: 'borderradius2',
									radius3: 'borderradius3',
									radius4: 'borderradius4'
								}
							}
						},
						{
							moduleType: 'Colors',
							options: {
								title: l10n.panel.content_area_label,
								multiple: false,
								single: false,
								abccolors: [
									{
										name: 'caption-text',
										label: l10n.panel.caption_text_label
									},
									{
										name: 'caption-bg',
										label: l10n.panel.caption_bg_label
									},
								]
							}
						},
						{
							moduleType: 'GalleryCaptionLocation',
							options: {
								state: 'global',
								fields: {
									caption: 'image-caption'
								}
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'global',
								title: '',
								fields: {
									use: 'useborder',
									width: 'borderwidth',
									type: 'bordertype',
									color: 'bordercolor',
								}
							}
						}
					]
				},

				migratePresetProperties: function(newPreset) {
					var props = {},
						useCaption = '',
						caption_height = 'auto';

					this.model.get('properties').each( function(prop) {
						props[prop.get('name')] = prop.get('value');
					});

					if(typeof props.thumbCaptionsHeight !== "undefined") {
						caption_height = 'fixed'
					}

					if(typeof props.captionType !== "undefined") {
						useCaption = 'yes';
					}

					newPreset.set({
						'use_captions': useCaption,
						'captionType': props.captionType,
						'showCaptionOnHover': props.showCaptionOnHover && props.showCaptionOnHover[0] && props.showCaptionOnHover[0] === "true" ? '1' : '0',
						'caption-height': caption_height,
						'thumbCaptionsHeight': props.thumbCaptionsHeight,
						'caption-bg': props.captionBackground,
						'caption-text': props.captionColor
					});
				},
			}
		},
		title: l10n.settings
	});

	// Generate presets styles to page
	Util.generatePresetsToPage('gallery', presetTpl);

	return UgallerySettings;
});


define('elements/upfront-gallery/js/model',[],function() {
	var UgalleryModel = Upfront.Models.ObjectModel.extend({
		init: function () {
			var properties = _.clone(Upfront.data.ugallery.defaults);
			properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + '-object');
			this.init_properties(properties);
		}
	});

	return UgalleryModel;
});


define('text!elements/upfront-gallery/js/templates/label-editor-template.html',[],function () { return '<div class="ugallery-magnific-labels upfront-ui">\r\n\t<div class="ugallery-magnific-panel upfront-media-controls">\r\n\t\t<div class="ugallery-magnific-wrapper existing_labels">\r\n\t\t\t{{labels}}\r\n\t\t</div>\r\n\t\t<div class="ugallery-magnific-add">\r\n\t\t\t<span class="ugallery-magnific-addform label_selector">\r\n\t\t\t\t<input type="text" class="ugallery-addlabels" class="upfront-field-text" name="ugallery-image-labels" placeholder="{{ l10n.add_label }}"><div class="ugallery-magnific-addbutton">{{ l10n.add_label }}</div>\r\n\t\t\t\t<span class="labels_list"></span>\r\n\t\t\t</span>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n';});


define('text!elements/upfront-gallery/js/templates/label-selector-template.html',[],function () { return '<ul {{labels.length ? \'\' : \'class="empty"\'}}>\r\n{[ _.each(labels, function(label){ ]}\r\n\t<li><label rel="{{label.id}}">{{label.text}}</label></li>\r\n{[ }) ]}\r\n</ul>\r\n';});


define('text!elements/upfront-gallery/js/templates/labels-template.html',[],function () { return '<span class="existing-labels-title">Image Labels</span>\r\n{[ if (labels.length) { ]}\r\n\t{[ _.each(labels, function(label){ ]}\r\n\t\t<a href="#remove" title="Remove" class="upfront-icon upfront-icon-media-label-delete" data-idx="{{label.id}}">{{label.text}}</a>\r\n\t{[ }) ]}\r\n{[ } else { ]}\r\n\t<span class=\'no-labels-notice\'>There are currently no labels added to this image...</span>\r\n{[ } ]}\r\n';});

(function ($) {
define('elements/upfront-gallery/js/label-editor',[
	'text!elements/upfront-gallery/js/templates/label-editor-template.html',
	'text!elements/upfront-gallery/js/templates/label-selector-template.html',
	'text!elements/upfront-gallery/js/templates/labels-template.html'
], function(labelEditorTpl, labelSelectorTpl, labelsTpl) {
	var l10n = Upfront.Settings.l10n.gallery_element;

	var LabelEditor = Backbone.View.extend({
		template: _.template(labelEditorTpl),
		labelSelectorTpl: _.template(labelSelectorTpl),

		events: {
			'keyup input[name="ugallery-image-labels"]': 'fillLabelSuggestionList',
			'keydown input[name="ugallery-image-labels"]': 'onNameFieldKeydown',
			'click input[name="ugallery-image-labels"]': 'onNameFieldClick',
			'click label': 'onLabelClick',
			'click .existing_labels a': 'removeLabel',
			'click .ugallery-magnific-addbutton': 'focusNameField'
		},

		initialize: function(options) {
			this.options = options || {};
			this.gallery = options.gallery;
			this.labels = options.labels;
			this.imageId = options.imageId;
		},

		/*?
		 * Prevent crazy click hijack that navigates and reloads the page.
		 */
		onNameFieldClick: function(event) {
			$(event.target).focus();
			event.preventDefault();
			event.stopPropagation();
			return false;
		},

		updateLabels: function() {
			this.$el.find('.ugallery-magnific-wrapper').html(_.template(labelsTpl, {labels: this.labels, l10n: l10n.template}));
			if (this.labels.length) {
				this.$el.parents('.inline-panel-control-dialog')
					.siblings('.upfront-icon-region-edit-labels-no-labels')
					.removeClass('upfront-icon-region-edit-labels-no-labels')
					.addClass('upfront-icon-region-edit-labels');
			} else {
				this.$el.parents('.inline-panel-control-dialog')
					.siblings('.upfront-icon-region-edit-labels')
					.removeClass('.upfront-icon-region-edit-labels')
					.addClass('upfront-icon-region-edit-labels-no-labels');
			}
 		},

		render: function() {
      this.$el.html(this.template({
				labels: _.template(labelsTpl, {labels: this.labels, l10n: l10n.template}),
				imageId: this.imageId,
				l10n: l10n.template
			}));

			return this;
		},

		focusNameField: function() {
			var $addlabels = this.$el.find('.ugallery-addlabels');
			if ( $addlabels.val() == '' )
				$addlabels.focus();
			else
				this.addLabel($addlabels);
		},

		fillLabelSuggestionList: function(e) {
			var me = this;

			if([9, 13, 38, 40, 27].indexOf(e.which) !== -1) {
				return;
			}

			var val = $(e.target).val(),
				allLabels = _.keys(Upfront.data.ugallery.label_names),
				labels = [];

			if(val.length < 2) {
				return $('.labels_list').html('');
			}

			_.each(allLabels, function(label){
				if(label.indexOf(val) !== -1){
					var lab = Upfront.data.ugallery.label_names[label];

					if(!_.findWhere(me.labels, { id: lab.id + '' }) && !_.findWhere(me.labels, { id: parseInt(lab.id, 10)})){
						labels.push({
							id: lab.id,
							text: lab.text.replace(val, '<span class="selection">' + val + '</span>')
						});
					}
				}
			});

			this.$el.find('.labels_list').html(me.labelSelectorTpl({labels: labels, l10n: l10n.template}));
		},

		selectNextSuggestion: function() {
			var selected,
				suggestions,
				currentIdx = -1,
				idx = 0;

			suggestions = this.$el.find('.labels_list li');

			if(!suggestions.length){
				return;
			}

			selected = suggestions.find('label.selected');

			if(selected.length){
				selected.removeClass('selected');
			}

			while(idx < suggestions.length && currentIdx === -1){
				currentIdx = suggestions[idx] === selected.parent()[0] ? idx : -1;
				idx++;
			}

			if(currentIdx === -1) {
				$(suggestions[0]).find('label').addClass('selected');
			} else if(currentIdx < suggestions.length - 1) {
				$(suggestions[currentIdx + 1]).find('label').addClass('selected');
			}
		},

		selectPreviousSuggestion: function() {
			var selected,
				suggestions,
				currentIdx = -1,
				idx = 0;

			suggestions = this.$el.find('.labels_list li');

			selected = suggestions.find('label.selected');

			if(selected.length){
				selected.removeClass('selected');
			}

			while(idx < suggestions.length && currentIdx === -1){
				currentIdx = suggestions[idx] === selected.parent()[0] ? idx : -1;
				idx++;
			}

			if(currentIdx === -1) {
				$(suggestions[suggestions.length -1]).find('label').addClass('selected');
			} else if(currentIdx > 0) {
				$(suggestions[currentIdx - 1]).find('label').addClass('selected');
			}
		},

		onNameFieldKeydown: function(e) {
			if (_.indexOf([13, 9, 40, 38, 27], e.which) !== -1) {
				e.preventDefault();
			}

			switch (e.which) {
				case 13: // Enter
					this.addLabel($(e.target));
					break;
				case 9: // Tab
				case 40: // Down
					this.selectNextSuggestion();
					break;
				case 38: // Up
					this.selectPreviousSuggestion();
					break;
				case 27: // Escape
					this.clearSuggestions();
			}
		},

		clearSuggestions: function() {
			this.$el.find('.labels_list').html('');
		},

		addLabel: function($nameField) {
			var selected = this.$el.find('.labels_list label.selected'),
				me = this,
				label,
				labelId;

			if(!selected.length){
				label = $.trim($nameField.val());
				if(label.length){
					$nameField.val('').siblings('.labels_list').html('');
					$.when(this.gallery.addLabel(label, this.imageId)).done(function(label) {
						me.labels.push(label);
						me.updateLabels();
						$nameField.val('').siblings('.labels_list').html('');
					});
				}

				return;
			}

			labelId = selected.attr('rel');
			label = Upfront.data.ugallery.label_ids[labelId];

			this.labels.push(label);
			this.updateLabels();

			$nameField.val('').siblings('.labels_list').html('');
			this.gallery.addLabel(label.text, this.imageId);
		},

		onLabelClick: function(e){
			var me = this,
				$label = $(e.target).hasClass('selection') ? $(e.target).parent() : $(e.target);

			// Prevent click hijack that reloads the page
			e.preventDefault();
			e.stopPropagation();

			var labelId = $label.attr('rel');
			if (labelId) {
				var label = Upfront.data.ugallery.label_ids[labelId];
				this.gallery.addLabel(label.text, this.imageId);
				$.when(this.gallery.addLabel(label.text, this.imageId)).done(function(label) {
					me.labels.push(label);
					me.updateLabels();
					me.$el.find('.labels_list').html('');
					me.$el.find('.ugallery-addlabels').val('');
				});
			}
		},

		removeLabel: function(e){
			e.preventDefault();

			var $label = $(e.target),
				me = this,
				labelId = $label.data('idx'),
				data,
				label;

			data = {
				action: 'upfront-media-disassociate_label',
				'term': labelId,
				'post_id': this.imageId
			};

			Upfront.Util.post(data);
			label = _.findWhere(this.labels, { id: labelId + ''}) || _.findWhere(this.labels, { id: parseInt(labelId, 10)});
			this.labels = _.without(this.labels, label);

			this.gallery.deleteLabel(labelId, this.imageId);

			$label.fadeOut('fast', function(){
				$(this).remove();
				if (me.labels.length === 0) {
					me.updateLabels();
				}
			});
		}
	});

	return LabelEditor;
});
})(jQuery);

define('elements/upfront-gallery/js/element',[
	'elements/upfront-gallery/js/model'
], function(UgalleryModel) {
	var l10n = Upfront.Settings.l10n.gallery_element;

	var UgalleryElement = Upfront.Views.Editor.Sidebar.Element.extend({
		priority: 30,
		render: function () {
			this.$el.addClass('upfront-icon-element upfront-icon-element-gallery');
			this.$el.html(l10n.element_name);
		},
		add_element: function () {
			var object = new UgalleryModel(),
				module = new Upfront.Models.Module({
					'name': '',
					'properties': [
						{'name': 'element_id', 'value': Upfront.Util.get_unique_id('module')},
						{'name': 'class', 'value': 'c24 upfront-ugallery_module'},
						{'name': 'has_settings', 'value': 0},
						{'name': 'row', 'value': Upfront.Util.height_to_row(240)}
					],
					'objects': [
						object
					]
				})
			;
			this.add_module(module);
		}
	});

	return UgalleryElement;
});

/*global ugalleries */
(function ($) {
define('ugallery',[
	'text!elements/upfront-gallery/tpl/ugallery.html', // Front
	'text!elements/upfront-gallery/tpl/sorting-style.html',
	'text!elements/upfront-gallery/tpl/ugallery_editor.html',
	'text!elements/upfront-gallery/tpl/lightbox_settings.html',
	'elements/upfront-gallery/js/settings',
	'elements/upfront-gallery/js/model',
	'elements/upfront-gallery/js/label-editor',
	'elements/upfront-gallery/js/element',
	'text!elements/upfront-gallery/tpl/preset-style.html',
	'scripts/upfront/preset-settings/util',
	"scripts/upfront/link-model"
], function(galleryTpl, sortingStyleTpl, editorTpl, lightboxTpl, UgallerySettings, UgalleryModel, LabelEditor, UgalleryElement, settingsStyleTpl, PresetUtil, LinkModel) {

var l10n = Upfront.Settings.l10n.gallery_element;
var globalL10n = Upfront.Settings && Upfront.Settings.l10n
	? Upfront.Settings.l10n.global.views
	: Upfront.mainData.l10n.global.views;

var UgalleryImage = Backbone.Model.extend({
	defaults: Upfront.data.ugallery.imageDefaults
});

var UgalleryImages = Backbone.Collection.extend({
	model: UgalleryImage
});


/* View */
var UgalleryView = Upfront.Views.ObjectView.extend({
	model: UgalleryModel,
	tpl: Upfront.Util.template(galleryTpl), //PHP compatible templates
	selectorTpl: _.template($(editorTpl).find('#selector-tpl').html()),
	progressTpl: _.template($(editorTpl).find('#progress-tpl').html()),
	editorTpl: _.template($(editorTpl).find('#editor-tpl').html()),
	formTpl: _.template($(editorTpl).find('#upload-form-tpl').html()),
	detailsTpl: _.template($(editorTpl).find('#details-tpl').html()),
	sortMode: false,
	lastThumbnailSize: false,
	imageLabels: {},

	reopenSettings: false,
	initialize: function(options){
		var me = this,
			elementId = this.property('element_id'),
			raw_labels,
			images;

		if(! (this.model instanceof UgalleryModel)){
			this.model = new UgalleryModel({properties: this.model.get('properties')});
		}

		this.constructor.__super__.initialize.call(this, [options]);
		this.events = _.extend({}, this.events, {
			'click a.upfront-image-select': 'openImageSelector',
			'click .add-item': 'openImageSelector',
			'click .toggle-sorting': 'toggleSorting',
			'click .ugallery_op_link': 'imageEditLink',
			'click .ugallery_op_mask': 'imageEditMask',
			'click .remove-image': 'removeImage',
			'click .ugallery_item': 'selectItem',
			'click .upfront-quick-swap': 'openImageSelector',
			'click': 'preventNavigation',
			'dblclick .ugallery-thumb-title': 'startCaptionEditor',
      'click .ugallery_item_lightbox': 'openLightbox'
		});

		images = this.property('images');

		// Ensure images are using new linking
		_.each(images, function(image, index) {
			if (image.imageLink === false || typeof image.imageLink === 'undefined') {
				// Create imageLink from properties, backward compat
				images[index]['imageLink'] = {
					type: image.urlType,
					url: image.url,
					target: image.linkTarget
				};
			}
		});

		this.images = new UgalleryImages(images);


		this.listenTo(this.images, 'add remove reset change', this.imagesChanged);
		this.property('images', this.images.toJSON()); // Hack to add image defaults;

		if (typeof this.property('thumbPadding') === 'undefined') {
			this.property('thumbPadding', 15);
		}

		$('body').on('click', this.closeTooltip);

		this.listenTo(Upfront.Events, 'entity:settings:activate', this.closeTooltip);
		this.listenTo(Upfront.Events, 'entity:activated', this.closeTooltip);
		this.listenTo(Upfront.Events, 'entity:deactivated', this.closeTooltip);
		this.listenTo(Upfront.Events, 'entity:region:activated', this.closeTooltip);
		this.listenTo(Upfront.Events, 'upfront:layout_size:change_breakpoint', this.rebindShuffle);

		this.listenTo(Upfront.Events, "theme_colors:update", this.update_colors, this);

		this.listenTo(this.model, "preset:updated", this.preset_updated);

		this.lastThumbnailSize = {width: this.property('thumbWidth'), height: this.property('thumbHeight')};

		if (typeof ugalleries !== 'undefined' && ugalleries[elementId]) {
			if(ugalleries[elementId].labels) {
				this.labels = ugalleries[elementId].labels;
			}
			if(ugalleries[elementId].image_labels) {
				this.imageLabels = ugalleries[elementId].image_labels;
			}
		} else {
			if ('undefined' === typeof ugalleries || !ugalleries) {
				ugalleries = {};
			}

			ugalleries[elementId] = {};

			raw_labels = ['All'];
			_.each(this.images.models, function(image) {
				raw_labels = _.union(raw_labels, image.get('tags'));
			});
			this.labels = [];
			_.each(raw_labels, function(label, index) {
				this.labels[index] = {
					id: index,
					text: label
				};
			}, this);
			this.imageLabels = {};
			_.each(this.images.models, function(image) {
				var imageLabels = [];
				_.each(this.labels, function(label) {
					if (_.indexOf(image.get('tags'), label.text) > -1) {
						imageLabels.push('label_' + label.id);
					}
				});
				this.imageLabels[image.get('id')] = 'label_0,' + imageLabels.join(',');
			}, this);

			ugalleries[elementId].labels = this.labels;
			ugalleries[elementId].imageLabels = this.imageLabels;
		}

		this.on('deactivated', this.sortCancel, this);

		this.listenTo(this.model, 'settings:closed', function(e){
			me.checkRegenerateThumbs(e);
			if (this.property('labelFilters').length) {
				Upfront.frontFunctions.galleryBindShuffle();
			}
		});

		this.listenTo(this.model, 'change:thumbProportions', function() {
			me.onThumbChangeProportions();
		});
		this.listenTo(this.model, 'change:thumbWidth', function() {
			me.onThumbChangeSize();
			me.render();
		});
		this.listenTo(this.model, 'change:thumbPadding', function() {
			me.updateThumbPadding();
		});
		this.listenTo(this.model, 'change:even_padding', function() {
			me.updateEvenPadding();
		});

		this.listenTo(this.model, 'change:labelFilters', function() {
			me.updateShowFilters();
		});

		this.listenTo(this.model, 'change:showCaptionOnHover', function() {
			me.updateShowCaptionOnHover();
		});

		this.listenTo(this.model, 'change:captionType', function() {
			me.updateCaptionType();
		});

		this.listenTo(this.model, 'change:fitThumbCaptions', function() {
			me.updateFitThumbCaptions();
		});

		this.listenTo(this.model, 'change:thumbCaptionsHeight', function() {
			me.updateThumbCaptionsHeight();
		});

		if (this.property('status') !== 'ok' || !this.images.length) {
			this.property('has_settings', 0);
		}

		Upfront.Events.on('upfront:layout_size:change_breakpoint', function() {
			setTimeout(function() {
				me.render();
			}, 100);
		});
		this. debouncedRender = _.debounce(this.render, 300);
	},

	onThumbChangeProportions: function(e) {
		var factor = this.property('thumbProportions'),
			width = this.property('thumbWidth');

		if(factor === 'theme') {
			factor = 1;
		}

		this.property('thumbProportions', factor);
		this.onThumbChangeSize();

		this.render();
	},
	onThumbChangeSize: function(){
		var factor = this.property('thumbProportions'),
			width = this.property('thumbWidth'),
			height = Math.round(width / factor);

		if(factor === 'theme') {
			factor = 1;
		}

		this.property('thumbWidth', width, false);
		this.property('thumbHeight', height);
		this.checkRegenerateThumbs();
	},

	get_preset_properties: function() {
		var preset = this.model.get_property_value_by_name("preset") || 'default',
			props = PresetUtil.getPresetProperties('gallery', preset) || {};

		return props;
	},

	preset_updated: function() {
		this.debouncedRender();
	},

	update_colors: function () {

		var props = this.get_preset_properties();

		if (_.size(props) <= 0) return false; // No properties, carry on

		PresetUtil.updatePresetStyle('gallery', props, settingsStyleTpl);
	},

	preventClose: function(event) {
		event.stopPropagation();
	},

	// Remove default dblclick behavior because it messes up things
	on_edit: function() {},

	/****************************************************/
	/*          Settings change live callbacks          */
	/****************************************************/
	updateThumbPadding: function() {
		this.$el.find('.ugallery').data('thumb-padding', this.property('thumbPadding'));
		this.$el.find('.ugallery').data('thumb-bottom-padding', this.property('bottomPadding'));
		this.$el.find('.ugallery').data('thumb-side-padding', this.property('sidePadding'));
		this.debouncedRender();
	},
	updateCaptionType: function() {
		var classes,
			suffix;

		this.$el.find('.ugallery-thumb-title')
			.removeClass('ugallery-caption-over ugallery-caption-below ugallery-caption-none')
			.addClass('ugallery-caption-' + this.property('captionType'));

		if (this.property('captionType') !== 'over') {
			classes = 'ugallery_caption_on_hover_1 ugallery_caption_on_hover_0 ugallery-caption-on-hover-1 ugallery-caption-on-hover-0';
			this.$el.find('.ugallery_item, .ugallery-thumb-title').removeClass(classes);
		} else {
			suffix = this.property('showCaptionOnHover').length;
			this.$el.find('.ugallery_item').addClass('ugallery_caption_on_hover_' + suffix);
			this.$el.find('.ugallery-thumb-title').addClass('ugallery-caption-on-hover-' + suffix);
		}
	},

	updateFitThumbCaptions: function() {
		this.debouncedRender();
	},

	updateThumbCaptionsHeight: function() {
		this.debouncedRender();
	},

	updateShowCaptionOnHover: function() {
		var classes = 'ugallery_caption_on_hover_1 ugallery_caption_on_hover_0 ugallery-caption-on-hover-1 ugallery-caption-on-hover-0',
			suffix = this.property('showCaptionOnHover').length;

		this.$el.find('.ugallery_item, .ugallery-thumb-title').removeClass(classes);

		this.$el.find('.ugallery_item').addClass('ugallery_caption_on_hover_' + suffix);
		this.$el.find('.ugallery-thumb-title').addClass('ugallery-caption-on-hover-' + suffix);
	},

	updateEvenPadding: function() {
		this.render();
	},

	updateShowFilters: function() {
		if (this.property('labelFilters')[0] === 'true') {
			this.$el.find('.ugallery_labels').show();
			this.$el.find('.ugallery-magnific-labels').parents('.upfront-inline-panel-item').show();
			Upfront.frontFunctions.galleryBindShuffle();
		} else {
			this.$el.find('.ugallery_labels').hide();
			this.$el.find('.ugallery-magnific-labels').parents('.upfront-inline-panel-item').hide();
		}

	},
	/****************************************************/
	/*        End settings change live callbacks        */
	/****************************************************/

	selectItem: function(e) {
		var item = $(e.target).hasClass('gallery_item') ? $(e.target) : $(e.target).closest('.ugallery_item');
		item.siblings().removeClass('ugallery_selected');
		if (!$(e.target).closest('.ugallery-controls').length) {
			item.toggleClass('ugallery_selected');
		}
		e.gallerySelected = true;
	},

	createControlsEach: function(image) {
		var panel = new Upfront.Views.Editor.InlinePanels.ControlPanel();

		panel.items = _([
			this.createControl('crop', l10n.ctrl.edit_image, 'imageEditMask'),
			this.createLinkControl(image)
		]);

		if (this.property('labelFilters')[0] === 'true') {
			panel.items.push(this.createLabelControl(image));
		}

		if (image.get('imageLink').type === 'image' || image.get('imageLink').type === 'lightbox' || -1 !== ['image', 'lightbox'].indexOf( this.property( "linkTo" ) ) ) {
			panel.items.push(this.createControl('fullscreen', l10n.ctrl.show_image, 'openImageLightbox'));
		}

		return panel;
	},

	createControl: function(icon, tooltip, click_callback) {
		var me = this,
			item = new Upfront.Views.Editor.InlinePanels.Control();

		item.icon = icon;
		item.tooltip = tooltip;
		if(click_callback) {
			this.listenTo(item, 'click', function(e){
				me[click_callback](e);
			});
		}

		return item;
	},

	createLabelControl: function(image){
		var control = new Upfront.Views.Editor.InlinePanels.DialogControl(),
			me = this;

		control.hideOkButton = true;
		control.hideOnClick = false;

		control.view = this.createLabelEditor(image);

		control.image = image;

		if (control.view.options.labels.length) {
			control.icon = 'edit-labels';
		} else {
			control.icon = 'edit-labels-no-labels';
		}
		control.tooltip = l10n.ctrl.edit_labels;
		control.id = 'edit_labels';

		me.listenTo(control, 'panel:open', function(){
			control.$el
				.closest('.ugallery-controls')
					.addClass('upfront-control-visible');
		});

		me.listenTo(control, 'panel:close', function(){
			control.$el
				.closest('.ugallery-controls')
					.removeClass('upfront-control-visible');
		});


		return control;
	},

	createLinkControl: function(image){
		var me = this,
			linkControl = new Upfront.Views.Editor.InlinePanels.DialogControl(),
			imageLink = new LinkModel(image.get('imageLink'));

		linkControl.view = linkPanel = new Upfront.Views.Editor.LinkPanel({
			model: imageLink,
			linkTypes: { image: true },
			imageUrl: image.get('srcFull')
		});




		this.listenTo(linkPanel.model, "change", function( model ){
			/**
			 * Response properly when selected link type is a post or page ( entry )
			 */
			if( 'entry' ===  model.get("type") ){
				setTimeout(function() {
					var $item = linkControl.$el.closest(".ugallery_item");
					me.add_controls_to_item( image, $item );
				}, 50);
			}
		});

		this.listenTo(imageLink, 'change', function(){
			image.set({'imageLink': imageLink.toJSON()});
		});

		this.listenTo(linkControl, 'panel:ok', function(){
			linkControl.close();
		});

		me.listenTo(linkControl, 'panel:open', function(){
			linkControl.$el
				.parents('.ugallery_item')
					.addClass('upfront-control-visible').end()
				.closest('.ugallery_link')
					.removeAttr('href') //Deactivate link when the panel is open
			;

			me.$el.closest('.ui-draggable').draggable('disable');
		});

		me.listenTo(linkControl, 'panel:ok', function(){
			linkControl.$el
				.parents('.ugallery_item')
					.removeClass('upfront-control-visible');

			setTimeout(function() {
				linkControl.$el.closest('.ugallery-controls').siblings('.ugallery_link')
					.attr('href', imageLink.get('url'))
					.attr('target', imageLink.get('target'))
					.attr('class', 'ugallery_link ugallery_link' + imageLink.get('type'));

					var $item = linkControl.$el.closest(".ugallery_item");

				/**
				 * Refresh the controlls when Ok is clicked
				 */
					me.add_controls_to_item( image, $item );
			}, 50);

			me.$el.closest('.ui-draggable').draggable('enable');
		});

		linkControl.icon = 'link';
		linkControl.tooltip = l10n.ctrl.image_link;
		linkControl.id = 'link';

		return linkControl;
	},

  openLightbox: function(event) {
		var gallery, magOptions;
			gallery = false;
			magOptions = ugalleries[galleryId].magnific;
  },

	openImageLightbox: function(e) {
		var me = this,
			lightboxName,
			item = $(e.target).closest('.ugallery_item'),
			image = me.images.get(item.attr('rel')),
			titleUpdated = false,
			resizeWithText = function() {
				var caption = this.content.find('figcaption'),
					maxHeight = this.wH - 120 - caption.outerHeight(),
					maxWidth = $(window).width() - 200
				;

				this.content.find('img').css({
					'max-width': maxWidth,
					'max-height': maxHeight
				});
			}
		;

		if (image.get('imageLink').type === 'lightbox') {
			lightboxName = image.get('imageLink').url.substring(1);
			Upfront.Application.LayoutEditor.openLightboxRegion(lightboxName);
			return;
		}

		$.magnificPopup.open({
			closeOnBgClick: _.isTrue( this.model.get_property_value_by_name('lightbox_click_out_close')[0] ),
			items: {
				src: image.get("srcFull")
			},
			type: 'image',
			image: {
				titleSrc: function() {
					return image.get('caption');
				},
				markup: Upfront.data.ugallery.lightboxTpl
			},
			callbacks: {
				open: function() {
					me.setupLightbox();
					me.createLightboxSettings();
					// Prevent lightbox from closing when clicking on image or caption
					$('.glb-content-container').click(me.preventClose);
					$('.glb-image-container').click(me.preventClose);
					$('.glb-caption-container').click(me.preventClose);
					// Prevent magnific from capturing focus
					setTimeout(function() {
						$(document).off('focusin');
					}, 500);
				},
				imageLoadComplete: function() {
					var title = $(this.container).find('.mfp-title');

					if(title.length){
						title.ueditor({
								linebreaks: false,
								autostart: false,
								upfrontMedia: false,
								upfrontImages: false
							})
							.on('start', function(){
								titleUpdated = true;
							})
							.on('syncAfter', function(){
								image.set('caption', title.html());
							})
						;
					}
				},
				beforeClose: function() {
					if (titleUpdated) {
						Upfront.Views.Editor.notify(l10n.desc_update_success);
					}
				},
				resize: resizeWithText,
				afterChange: resizeWithText
			}
		});
	},

	setupLightbox: function() {
		var containerClass ='gallery-' + this.property('element_id') + '-lightbox',
			currentLightbox;

		$('.mfp-bg, .mfp-wrap').addClass(containerClass);

		currentLightbox = $('.' + containerClass);

		currentLightbox.find('.mfp-counter').html('1 of 2');

		if (this.property('lightbox_show_close')[0] === 'true') {
			currentLightbox.find('.mfp-close').show();
		} else {
			currentLightbox.find('.mfp-close').hide();
		}

		if (this.property('lightbox_show_image_count')[0] === 'true') {
			currentLightbox.find('.mfp-counter').show();
		} else {
			currentLightbox.find('.mfp-counter').hide();
		}

		$('.glb-content-container').css({
			'background': this.property('lightbox_active_area_bg')
		});
		$('.mfp-bg').css('background', this.property('lightbox_overlay_bg'));
		if( $('.mfp-container').find('.mfp-arrow.mfp-arrow-left.mfp-prevent-close').length === 0 )
			$('.mfp-container').append('<button title="Previous (Left arrow key)" type="button" class="mfp-arrow mfp-arrow-left mfp-prevent-close"></button>');
		if( $('.mfp-container').find('.mfp-arrow.mfp-arrow-right.mfp-prevent-close').length === 0 )
			$('.mfp-container').append('<button title="Next (Right arrow key)" type="button" class="mfp-arrow mfp-arrow-right mfp-prevent-close"></button>');

		if ($('style#' + containerClass).length === 0) {
			$('body').append('<style id="' + containerClass + '"></style>');
		}
		$('style#' + containerClass).html(this.property('styles'));
	},

	createLightboxSettings: function () {
		$('.mfp-container').append(_.template(lightboxTpl, {
			edit_lightbox_css: l10n.lightbox.edit_css,
			lightbox_title: l10n.lightbox.title
		}));

		var $lightbox = $('.mfp-container').find('.upfront-region-bg-setting-lightbox-region');

		var me = this,
			fields;

		fields = {
			lightbox_click_out_close: new Upfront.Views.Editor.Field.Checkboxes({
				model: this.model,
				property: 'lightbox_click_out_close',
				label: "",
				values: [
					{
						label: globalL10n.click_close_ltbox,
						value: 'true',
						checked: this.model.get_property_value_by_name('lightbox_click_out_close')[0] === 'true' ? 'checked' : false
					}
				],
				change: function(value) {
					me.property('lightbox_click_out_close', value);
					this.model.set('lightbox_click_out_close', value, true);
					me.setupLightbox();
				}
			}),

			lightbox_show_close: new Upfront.Views.Editor.Field.Checkboxes({
				model: this.model,
				className: 'gallery-lb-show_close upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes',
				property: 'lightbox_show_close',
				label: "",
				values: [
					{
						label: globalL10n.show_close_icon,
						value: 'true',
						checked: this.model.get_property_value_by_name('lightbox_show_close')[0] === 'true' ? 'checked' : false
					}
				],
				change: function(value) {
					me.property('lightbox_show_close', value);
					me.setupLightbox();
				}
			}),

			lightbox_show_image_count: new Upfront.Views.Editor.Field.Checkboxes({
				model: this.model,
				className: 'gallery-lb-show_image_count upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes',
				property: 'lightbox_show_image_count',
				label: "",
				values: [
					{
						label: l10n.lightbox.show_image_count,
						value: 'true',
						checked: this.model.get_property_value_by_name('lightbox_show_image_count')[0] === 'true' ? 'checked' : false
					}
				],
				change: function(value) {
					me.property('lightbox_show_image_count', value);
					me.setupLightbox();
				}
			}),
		};

		fields.lightbox_active_area_bg = new Upfront.Views.Editor.Field.Color({
			model: this.model,
			property: 'lightbox_active_area_bg',
			className: 'upfront-field-wrap upfront-field-wrap-color sp-cf overlay_color',
			label: l10n.lightbox.active_area_bg + ":",
			spectrum: {
				move: function(color) {
					me.property('lightbox_active_area_bg', color.toRgbString());
					me.setupLightbox();
				},
				change: function(color) {
					me.property('lightbox_active_area_bg', color.toRgbString());
					me.setupLightbox();
				}
			}
		});

		fields.lightbox_overlay_bg = new Upfront.Views.Editor.Field.Color({
			model: this.model,
			property: 'lightbox_overlay_bg',
			label: l10n.lightbox.overlay_bg + ":",
			change: me.updateProperty,
			spectrum: {
				move: function(color) {
					me.property('lightbox_overlay_bg', color.toRgbString());
					me.setupLightbox();
				},
				change: function(color) {
					me.property('lightbox_overlay_bg', color.toRgbString());
					me.setupLightbox();
				}
			}
		});

		_.each(fields, function(field){
			field.render();
			field.delegateEvents();
			if( $lightbox.find( field.$el).length === 0 )
				$lightbox.append(field.$el);
		});

		$('#gallery-lb-settings-button').toggle(
			function() {
				$('#gallery-lb-settings').show();
			},
			function() {
				$('#gallery-lb-settings').hide();
			}
		);

		$('#gallery-lb-settings .upfront-inline-modal-save').click( function() {
			$('#gallery-lb-settings-button').click();
			if (me.galleryLightboxCssEditor) {
				me.galleryLightboxCssEditor.close();
			}
		});

		$('#gallery-lb-settings').click( function(event) {
			event.stopPropagation();
		});

		$('#gallery-lb-settings').find('.edit-lightbox-css').click( function(event) {
			me.galleryLightboxCssEditor = new Upfront.Views.Editor.GeneralCSSEditor({
				model: me.model,
				page_class: 'gallery-' + me.property('element_id') + '-lightbox',
				type: "GalleryLightbox",
				sidebar: true,
				global: false,
				toolbar: true,
				cssSelectors: {
					'.mfp-close': {label: l10n.css.lightbox_close, info: l10n.css.lightbox_close},
					'.glb-content-container': {label: l10n.css.lightbox_content_wrapper, info: l10n.css.lightbox_content_wrapper_info},
					'.glb-image-container': {label: l10n.css.lightbox_image_wrapper, info: l10n.css.lightbox_image_wrapper},
					'.glb-caption-container': {label: l10n.css.lightbox_caption_wrapper, info: l10n.css.lightbox_caption_wrapper},
					'.mfp-title': {label: l10n.css.lightbox_caption, info: l10n.css.lightbox_caption},
					'.mfp-arrow-left:before': {label: l10n.css.lightbox_arrow_left, info: l10n.css.lightbox_arrow_left},
					'.mfp-arrow-right:before': {label: l10n.css.lightbox_arrow_right, info: l10n.css.lightbox_arrow_right},
					'.mfp-counter': {label: l10n.css.lightbox_image_count, info: l10n.css.lightbox_image_count},
				},
				change: function(content) {
					me.property('styles', content);
					me.setupLightbox();
				},
				onClose: function() {
					$('.mfp-content').css({
						'margin-bottom': 0,
						'margin-top': 0
					});
				}
			});
			$('.mfp-content').css({
				'margin-bottom': 250,
				'margin-top': 50
			});
		});
	},

	createLabelEditor: function(image) {
		var labelEditor = new LabelEditor({
			gallery: this,
			labels: this.extractImageLabels(image.id),
			imageId: image.id
		});

		return labelEditor;
	},

	openLightboxLabels: function(e){
		this.openImageLightbox(e, true);
	},

	getPropertiesForTemplate: function() {
		var props = this.extract_properties();

		props.properties = this.get_preset_properties();

		props.imagesLength = props.images.length;
		props.editing = true;

		props.labels = this.labels;
		props.labels_length = this.labels.length;
		props.image_labels = this.imageLabels;

		// In case the image doesn't have the `imageLink` populated, use the element-wide fallback as default
		var fallback_type = this.property('linkTo');
		_.each(props.images, function(image, index) {
			props.images[index]['imageLinkType'] = image.imageLink.type || fallback_type;
			props.images[index]['imageLinkUrl'] = image.imageLink.url;
			props.images[index]['imageLinkTarget'] = image.imageLink.target;
		});

		props.usingNewAppearance = props.usingNewAppearance || false;

		props.l10n = l10n.template;
		props.in_editor = true;
		if (!props.even_padding) {
			props.even_padding = ['false'];
		}

		return props;
	},

	get_content_markup: function() {
		return this.tpl(this.getPropertiesForTemplate());
	},

	on_render: function() {
		var me = this,
			resizingFunction;

		//Bind resizing events
		if (me.parent_module_view && !me.parent_module_view.$el.data('resizeHandling')) {
			resizingFunction = $.proxy(me.onElementResizing, me);
			me.parent_module_view.$el
				.on('resize', resizingFunction)
				.on('resizestop', $.proxy(me.onElementResizeStop, me))
				.data('resizeHandling', true)
			;
		}

		/**
			The following is being done so that the gallery
			items inside a lightbox can shuffle after
			the lightbox shows up, in order to expand
			around in the available space
		**/
		Upfront.Events.on('upfront:lightbox:show', function(e) {
			setTimeout(function(){
				$(window).trigger('resize');
			}, 300);
		});

		this.images.each(function(image) {
			if(image.get('loading') && 0 === me.$('.ugallery_item[rel="' + image.id  + '"]').find( '.ugallery-image-loading').length ){
				me.$('.ugallery_item[rel="' + image.id  + '"]')
					.append('<p class="ugallery-image-loading">' + l10n.loading + '</p>');
			}
		});

		if(_.indexOf(['ok', 'starting'], me.property('status')) === -1 && 0 === me.$('.upfront-gallery').find( '.upfront-quick-swap').length ) {
			me.$('.upfront-gallery').append('<div class="upfront-quick-swap"><p>' + l10n.personalize + '</p></div>');
		}

		// if (this.images && this.images.length) {
		// 	var $upfrontObjectContent = this.$el.find('.upfront-object-content');
		// 	if (this.$el.find('a.toggle-sorting').length < 1) {
		// 		$('<b class="upfront-entity_meta upfront-ui toggle_sorting" title="Toggle drag\'n\'drop sorting of images"><a href="" class="upfront-icon-button toggle-sorting"></a></b>').insertBefore($upfrontObjectContent);
		// 	}
		// 	if (this.$el.find('a.add-item').length < 1) {
		// 		$('<b class="upfront-entity_meta upfront-ui add_item"><a href="" class="upfront-icon-button add-item"></a></b>').insertBefore($upfrontObjectContent);
		// 	}
		// }

		setTimeout(function() {
			me.rebindShuffle();
			var items = me.$('.ugallery_item');
			_.each(items, function(item) {
				var $item = $(item),
					image = me.images.get($item.attr('rel')),
					title = $item.find('.ugallery-thumb-title'),
					controls = me.add_controls_to_item( image, $item)
						.setWidth( $item.width() );

				me.ensureCaptionEditorExists(title, image);

				if(image.controls) {
					image.controls.remove();
				}
				image.controls = controls;
			});


		}, 300);

		if (this.isSortingActive === true) {
			this.activateSortable();
		} else {
			this.cleanupSortable();
		}

		if (this.property('linkTo') === false) {
			this.showSelectType();
		}
	},

	ensureCaptionEditorExists: function(title, image) {
		var me = this;

		if (!title.data('ueditor')) {
			title.ueditor({
				linebreaks: false,
				autostart: false,
				upfrontMedia: false,
				upfrontImages: false
			})
			.on('start', function() {
				me.$el.addClass('upfront-editing');
			})
			.on('stop', function() {
				setTimeout(function() {
					// Prevent on hover caption shows constantly
					title.removeAttr('style');
				}, 10);

				me.$el.removeClass('upfront-editing');
			})
			.on('syncAfter', function() {
				image.set('title', title.html());
				image.set('caption', title.html());
			})
			;
		}
	},

	onElementResizing: function(){
		this.$('.ugallery_items').width($('html').find('.upfront-resize').width() - 30);
	},

	onElementResizeStop: function(){
		// Not gonna do this because render will be triggered by parent class model changing
		// 'row' property on resize.
		// this.render(); <-- this is redundant and creates misscalculation of padding
	},

	toggleSorting: function(event) {
		if (event) {
			event.preventDefault();
		}
		this.isSortingActive = !this.isSortingActive;
		this.itemsInRow = this.$el.find('.ugallery_item').filter(function(){ return $(this).css('top') === '0px'; }).length;
		this.render();
		if(this.isSortingActive) {
			this.controls.$el.find('.upfront-icon-region-toggle-sorting').addClass('upfront-icon-region-sorting-active');
		}
		else {
			this.controls.$el.find('.upfront-icon-region-toggle-sorting').removeClass('upfront-icon-region-sorting-active');
		}
	},

	rebindShuffle: function() {
		if (!this.isSortingActive) {
			Upfront.frontFunctions.galleryBindShuffle(this.$el.find('.ugallery_grid'), true);
		}
	},

	preventNavigation: function(e){
		this.constructor.__super__.constructor.__super__.on_click.call(this, e);
		if(e.target.tagName.toUpperCase() === 'INPUT') {
			return;
		}

		if(e.target.tagName.toUpperCase() === 'A' || $(e.target).closest('a').length) {
			e.preventDefault();
		}
	},

	getLabelSelector: function(imageId){
		var tpl = $($.trim(this.labelsTpl({labels: this.extractImageLabels(imageId), l10n: l10n.template})));
		return tpl;
	},

	extractImageLabels: function(imageId){
		var ids = !_.isUndefined( this.imageLabels[imageId] ) ?  this.imageLabels[imageId].match(/-?\d+/g) : false,
			labels = []
		;

		if(ids){
			_.each(this.labels, function(label){
				if(ids.indexOf(label.id.toString()) !== -1 && label.id !== '0') {
					labels.push(label);
				}
			});
		}

		return labels;
	},

	openImageSelector: function(event, replaceId){
		var me = this,
			selectorOptions = {
				multiple: true,
				preparingText: l10n.preparing,
				customImageSize: {width: this.property('thumbWidth'), height: this.property('thumbHeight')},
				element_id: this.model.get_property_value_by_name('element_id')
			}
		;

		if (event) {
			event.preventDefault();
		}

		Upfront.Views.Editor.ImageSelector.open(selectorOptions).done(function(images, response){
			me.addImages(images, replaceId);
			if (response.given !== response.returned) {
				Upfront.Views.Editor.notify(l10n.not_all_added, 'warning');
			}

			Upfront.Views.Editor.ImageSelector.close();
		});

	},
	addImages: function(images, replaceId){
		var me = this,
			models = [],
			element_id = this.model.get_property_value_by_name('element_id');

		this.getNewLabels(_.keys(images));

		_.each(images, function(image, id) {
			var model = new UgalleryImage({
				id: id,
				srcFull: image.full[0],
				sizes: image,
				size: image.custom.editdata.resize,
				cropSize: image.custom.crop,
				cropOffset: image.custom.editdata.crop,
				src: image.custom.url,
				loading: false,
				status: 'ok',
				element_id: element_id,
				urlType: me.property('linkTo'),
				url: image.full[0],
			});
			// Also initialize image link defaults here
			model.set('imageLink', {
				type: me.property('linkTo'),
				url: model.get("url"),
				target: model.get("linkTarget")
			});
			models.push(model);
		});

		if (me.property('status') !== 'ok') {
			me.property('status', 'ok');
			me.property('has_settings', 1);
			me.images.reset(models);
		} else if (replaceId) {
			var item = me.images.get(replaceId),
				idx = me.images.indexOf(item);

			me.images.remove(replaceId);
			me.images.add(models, {at: idx});
		} else {
			me.images.add(models);
		}

		me.render();
	},

	showSelectType: function() {
		var me = this,
			selector = $('<div class="upfront-ui ugallery-onclick"><div class="ugallery-onclick-dialog"><span>' + l10n.thumbnail_clicked +
				'</span><div class="ugallery-onclick-options"><a href="#" class="ugallery-lager_image" rel="image">' + l10n.show_larger +
				'</a><a href="#" class="ugallery-linked_page" rel="external">' + l10n.go_to_linked + '</a></div></div></div>');

		selector.on('click', 'a', function(e){
			e.preventDefault();
			var value = $(e.target).attr('rel');
			me.property('linkTo', value, false);
			_.each(me.images.models, function(image) {
				image.set({'urlType': value}, {silent:true});
			});
			me.property('images', me.images.toJSON());


			setTimeout(function(){
				selector.fadeOut('fast', function(){
					selector.remove();
					me.render();
				});
			}, 100);
		});

		if( 0 === this.$( '.ugallery').find( ".upfront-ui.ugallery-onclick").length )
			this.$('.ugallery').append(selector.hide());

		selector.fadeIn();
	},

	getNewLabels: function(ids){
		var data = {
				action: 'upfront-media_get_image_labels',
				post_ids: ids
			},
			me = this
		;
		Upfront.Util.post(data).done(function(results){
			var images = results.data;
			_.each(images, function(labels, imageId){
				var imageLabels = [];

				imageLabels.push('"label_0"');

				_.each(labels, function(label){
					var globals = Upfront.data.ugallery,
						newLabel = {id: label.term_id, text: label.name}
					;

					if(!globals.label_names[label.name]) {
						globals.label_names[label.name] = newLabel;
					}

					if(!globals.label_ids[label.term_id]) {
						globals.label_ids[label.term_id] = newLabel;
					}

					if(!me.isLabelInGallery(newLabel)) {
						me.labels.push(newLabel);
					}

					imageLabels.push('"label_' + label.term_id + '"');
				});

				me.imageLabels[imageId] = imageLabels.join(', ');
			});
		});
	},

	isLabelInGallery: function(label){
		var me = this,
			labelInGallery = false,
			i = 0
		;
		while(i<me.labels.length && !labelInGallery){
			labelInGallery = me.labels[i].id === label.id;
			i++;
		}

		return labelInGallery;
	},

	getCropOffset: function(size, fullSize){
		var pivot = fullSize.width / size.width > fullSize.height / size.height ? 'height' : 'width',
			factor = fullSize[pivot] / size[pivot],
			reducedSize, offset
		;

		if(factor > 0){
			reducedSize = {width: Math.floor(fullSize.width / factor), height: Math.floor(fullSize.height / factor)};
			offset = {left: (reducedSize.width - size.width) / 2, top: (reducedSize.height - size.height) / 2};
		}
		else{
			reducedSize = size;
			offset = {left:0, top:0};
		}

		return {size: reducedSize, offset: offset};
	},

	centeredPosition: function(imgSize){
		var wrapperSize = {
			width: this.property('thumbWidth'),
			height: this.property('thumbHeight')
		};

		return {
			top: ((wrapperSize.height - imgSize.height) / 2) / wrapperSize.height * 100,
			left: ((wrapperSize.width - imgSize.width) / 2) / wrapperSize.width * 100
		};
	},

	checkRegenerateThumbs: function(e, imageIds){
		var me = this;
		if (!(
			imageIds
			||
			this.lastThumbnailSize.width !== this.property('thumbWidth')
			||
			this.lastThumbnailSize.height !== this.property('thumbHeight')
		)) return false;

		var editOptions = {
				images: this.getRegenerateData(imageIds),
				action: 'upfront-media-image-create-size'
			},
			loading = new Upfront.Views.Editor.Loading({
				loading: l10n.regenerating,
				done: l10n.regenerating_done,
				fixed: false
			})
		;

		loading.render();
		if (!this.parent_module_view.$el.find( loading.$el).length) {
			this.parent_module_view.$el.append(loading.$el);
		}

		Upfront.Util.post(editOptions).done(function(response) {
			loading.done();
			var images = response.data.images,
				models = []
			;

			_.each(editOptions.images, function(image){
				var model = me.images.get(image.id),
					changes = images[image.id]
				;

				if(!changes.error){
					model.set({
						src: changes.url,
						srcFull: changes.urlOriginal,
						size: image.resize,
						cropPosition: {top: image.crop.top, left: image.crop.left}
					}, {silent: true});
				}
				models.push(model);
			});

			me.images.set(models, {remove: false});
			me.imagesChanged();
			me.render();
			me.lastThumbnailSize = {width: me.property('thumbWidth'), height: me.property('thumbHeight')};
		});
	},

	getRegenerateData: function(imageIds){
		var me = this,
			widthFactor = this.property('thumbWidth') / this.lastThumbnailSize.width,
			heightFactor = this.property('thumbHeight') / this.lastThumbnailSize.height,
			factor = widthFactor > heightFactor ? widthFactor : heightFactor,
			imageData = [],
			images = this.images,
			element_id = this.model.get_property_value_by_name('element_id')
		;

		if(imageIds){
			images = [];
			_.each(imageIds, function(id){
				images.push(me.images.get(id));
			});

			images = new UgalleryImages(images);
		}

		images.each(function(image){
			var size = image.get('size'),
				offset = image.get('cropOffset'),
				editorOpts = {
					id: image.id,
					rotate:image.get('rotation'),
					resize: {width: size.width * factor, height: size.height * factor},
					crop: {
						top: Math.round(offset.top * factor),
						left: Math.round(offset.left * factor),
						width: me.property('thumbWidth'),
						height: me.property('thumbHeight')
					},
					element_id: element_id
				}
			;
			imageData.push(editorOpts);
		});

		return imageData;
	},

	imageEditMask: function(e) {
		var me = this,
			item = $(e.target).closest('.ugallery_item'),
			image = this.images.get(item.attr('rel')),
			editorOpts;

		if(image.get('status') !== 'ok'){
			var selectorOptions = {
				multiple: false,
				preparingText: l10n.preparing,
				element_id: this.model.get_property_value_by_name('element_id')
			};
			return Upfront.Views.Editor.ImageSelector.open(selectorOptions).done(function(images){
				me.addImages(images);

				var index = me.images.indexOf(image);

				me.images.remove(image, {silent:true});

				var newImage = me.images.at(me.images.length -1);

				me.images.remove(newImage, {silent:true});

				me.images.add(newImage, {at: index});

				Upfront.Views.Editor.ImageSelector.close();
			});
		}

		editorOpts = this.getEditorOptions(image);
		e.preventDefault();
		Upfront.Views.Editor.ImageEditor.open(editorOpts)
			.done(function(result){
				image.set({
					src: result.src,
					srcFull: result.src,
					cropSize: result.cropSize,
					size: result.imageSize,
					cropOffset: result.imageOffset,
					margin: {left: Math.max(0-result.imageOffset.left, 0), top: Math.max(0-result.imageOffset.top, 0)},
					rotation: result.rotation
				});
				me.render();
			}).fail(function(data){
				if(data && data.reason === 'changeImage') {
					me.openImageSelector(false, data.id);
				} else {
					me.render();
				}
			});
	},

	getEditorOptions: function(image){
		var $img = this.$('.ugallery_item[rel=' + image.id + '] img'),
			full = image.get('sizes').full;

		return {
			id: image.id,
			maskSize: {width: $img.width(), height: $img.height()},
			maskOffset: $img.offset(),
			position: image.get('cropOffset'),
			size: image.get('size'),
			fullSize: {width: full[1], height: full[2]},
			src: image.get('src'),
			srcOriginal: full[0],
			rotation: image.get('rotation'),
			element_id: this.model.get_property_value_by_name('element_id')
		};
	},

	imagesChanged: function() {
		this.property('images', this.images.toJSON());
		this.rebindShuffle();
	},

	/**
	 * Delete a label from the gallery if no other image has the label
	 * @param  {int} labelId Label id
	 * @param  {int} imageId Image id
	 * @return {null}
	 */
	deleteLabel: function(labelId, imageId) {
		var me = this,
			deleteLabel = true;

		me.images.each(function(image){
			if(image.id !== imageId && me.imageLabels[image.id].indexOf('"label_' + labelId + '"') !== -1){
				deleteLabel = false;
			}
		});

		if(deleteLabel){
			for(var idx in me.labels){
				if(me.labels[idx] && me.labels[idx].id === labelId) {
					me.labels.splice(idx, 1);
				}
			}
		}
	},

	addLabel: function(text, imageId){
		var label = Upfront.data.ugallery.label_names[text],
			labelId;

		if (!label) {
			return this.createLabel(text, imageId);
		}

		labelId = '"label_' + label.id + '"';

		this.addToGalleryLabels(label);

		this.associateLabelWithImage(imageId, labelId, label);

		return label;
	},

	associateLabelWithImage: function(imageId, labelId, label) {
		var data;

		if (!this.imageLabels[imageId]) {
			this.imageLabels[imageId] = labelId;
		}

		if (this.imageLabels[imageId].indexOf(labelId) === -1) {
			this.imageLabels[imageId] += ', ' + labelId;
		}

		data = {
			'action': 'upfront-media-associate_label',
			'term': label.id,
			'post_id': imageId
		};
		Upfront.Util.post(data);
	},

	addToGalleryLabels: function(label) {
		var labelInGallery = false,
			i = 0;

		while (i < this.labels.length && !labelInGallery) {
			labelInGallery = this.labels[i].id === label.id;
			i++;
		}

		if (!labelInGallery) {
			this.labels.push({
				id: label.id,
				text: label.text
			});
		}
	},

	createLabel: function(text, imageId) {
		//Push a label with a temp id
		var me = this,
			tempId = -parseInt(Math.random() * 100, 10),
			label,
			data;

		label = {
			id: tempId,
			term_id: tempId,
			text: text
		};

		data = {
			'action': 'upfront-media-add_label',
			'term': text,
			'post_id': imageId
		};

		Upfront.data.ugallery.label_names[text] = label;
		Upfront.data.ugallery.label_ids[tempId] = label;

		this.labels.push(label);
		this.imageLabels[imageId] = this.imageLabels[imageId] ? this.imageLabels[imageId] + ', "label_' + tempId + '"' : '"label_' + tempId + '"';

		var deferred = $.Deferred();
		Upfront.Util.post(data)
		.success(function (response) {
			//Replace the temp label
			var thisLabels = response.data[imageId],
			imageLabels = [],
			newId = 0,
			newLabel = {}
			;

			_.each(thisLabels, function(label){
				imageLabels.push('"label_' + label + '"');
				if(!Upfront.data.ugallery.label_ids[label]) {
					newId = label;
				}
			});

			imageLabels = imageLabels.join(', ');
			newLabel = {
				id: newId,
				text: text
			};

			deferred.resolve(newLabel);

			Upfront.data.ugallery.label_names[text] = newLabel;
			Upfront.data.ugallery.label_ids[newLabel.id] = newLabel;
			delete(Upfront.data.ugallery.label_ids[tempId]);

			me.imageLabels[imageId] = imageLabels;

			_.each(me.labels, function(label){
				if(label.text === text) {
					label.id = newLabel.id;
				}
			});

			me.render();
		});

		return deferred.promise();
	},

	postTypes: function(){
		var types = [];
		_.each(Upfront.data.ugallery.postTypes, function(type){
			if(type.name !== 'attachment') {
				types.push({name: type.name, label: type.label});
			}
		});
		return types;
	},

	getItemElement: function(e){
		return $(e.target).closest('.ugallery_item');
	},

	removeImage: function(e){
		var me = this,
			item = this.getItemElement(e);
		e.preventDefault();
		item.fadeOut('fast', function() {
			var imageId = item.attr('rel');
			me.images.remove(imageId);
			me.imagesChanged();
			if (!me.images.length) {
				me.property('has_settings', 0);
				me.property('status', 'starting');
			}

			//Remove labels
			var labels = me.imageLabels[imageId].split(',');
			_.each(labels, function(label){
				var labelId = $.trim(label.replace('"label_', '').replace('"', ''));
				me.deleteLabel(labelId, imageId);
			});
			me.imageLabels[imageId] = '';

			me.render();
		});
	},

	activateSortable: function(){
		var me = this;

		this.$('.ugallery').sortable({
			items: 'div.ugallery_item:not(.ugallery_addmore)',
			start: function(){
				me.$el.addClass('ugallery_sorting');
			},
			stop: function (){
				me.$el.removeClass('ugallery_sorting');
			},
			update: function() {
				me.sortOk();
			},
			change: function(){
			},
			delay: 500,
			cancel: '.ugallery-thumb-title'
		});

		this.$('.ugallery_item_removing').removeClass('ugallery_item_removing');

		this.$el.addClass('image-sorting-active');
		this.$el.find('.toggle_sorting').addClass('sorting-active');
		$('body').append(_.template(sortingStyleTpl, {
			element_id: this.model.get_property_value_by_name('element_id'),
			thumbPadding: this.model.get_property_value_by_name('thumbPadding'),
			even_padding: this.model.get_property_value_by_name('even_padding'),
			itemsInRow: this.itemsInRow
		}));
	},

	cleanupSortable: function() {
		this.$el.removeClass('image-sorting-active');
		this.$el.find('.toggle_sorting').removeClass('sorting-active');
		if ($('#sorting-style').length > 0) {
			$('#sorting-style').remove();
		}
	},

	sortOk: function() {
		var items = this.$('.ugallery_item'),
			newOrder = [],
			me = this
		;
		_.each(items, function(item){
			var id = $(item).attr('rel');
			if(id) {
				newOrder.push(me.images.get(id));
			}
		});

		this.images.reset(newOrder);
	},

	activateLightbox: function(){
		var items = [];
		this.$('.ugallery_item').each(function(i, item){
			items.push({
				el: $(item),
				src: $(item).find('a.ugallery_link').attr('href')
			});
			$(item).find('.upfront-icon-region-fullscreen').attr('href', $(item).find('a.ugallery_link').attr('href'));
		});

		this.$('.ugallery').magnificPopup({
			gallery: {enabled: true},
			type: 'image',
			delegate: '.upfront-icon-region-fullscreen',
			items: items
		});
	},

	startCaptionEditor: function(event) {
		var $target = $(event.target),
			$caption = $target.hasClass('ugallery-thumb-title') ? $target : $target.closest('.ugallery-thumb-title'),
			image;

		if (!$caption.length) {
			return;
		}

		if ($caption.data('ueditor') && !$caption.data('ueditor').active ) {
			$caption.data('ueditor').start();
		} else {
			image = this.images.get($caption.closest('.ugallery_item').attr('rel'));
			this.ensureCaptionEditorExists($caption, image);
            if( !$caption.data('ueditor').active )
			    $caption.data('ueditor').start();
		}
	},

	cleanup: function(){
		this.images.each(function(image){
			if(image.controls) {
				image.controls.remove();
			}
		});
		$('body').off('click', this.closeTooltip);
	},

	/*
	Returns an object with the properties of the model in the form {name:value}
	*/
	extract_properties: function() {
		var props = {};
		this.model.get('properties').each(function(prop){
			props[prop.get('name')] = prop.get('value');
		});
		props.preset = props.preset || 'default';
		return props;
	},

	/*
	Shorcut to set and get model's properties.
	*/
	property: function(name, value, silent) {
		if(typeof value !== 'undefined'){
			if(typeof silent === 'undefined') {
				silent = true;
			}
			this.model.set_property(name, value, silent);
			return;
		}
		return this.model.get_property_value_by_name(name);
	},

	getControlItems: function(){
		return _([
			this.createControl('add', l10n.template.add_img, 'openImageSelector'),
			this.createControl('toggle-sorting', l10n.toggle_dnd, 'toggleSorting'),
			this.createPaddingControl(),
			this.createControl('settings', l10n.settings, 'on_settings_click')
		]);
	},
	/**
	 * Adds proper controll panel to the image
	 *
	 * @param image BB-model, one single image
	 * @param $item jQuery object of a single image
	 * @returns controls of of the single image
	 */
	add_controls_to_item: function(image, $item){
		var controls = this.createControlsEach(image);
		controls.render();
		$item.find('.ugallery-controls').remove();
		$item.append($('<div class="ugallery-controls upfront-ui"></div>').append(controls.$el));

		return controls;
	}
});

//Make the element parts available
Upfront.Application.LayoutEditor.add_object('Ugallery', {
	'Model': UgalleryModel,
	'View': UgalleryView,
	'Element': UgalleryElement,
	'Settings': UgallerySettings,
	cssSelectors: {
		'.ugallery': {label: l10n.css.container_label, info: l10n.css.container_info},
		'.ugallery .ugallery_item': {label: l10n.css.elements_label, info: l10n.css.elements_info},
		'.ugallery img.ugallery-image': {label: l10n.css.images_label, info: l10n.css.images_info},
		'.ugallery .ugallery-thumb-title': {label: l10n.css.captions_label, info: l10n.css.captions_info},
		'.ugallery .ugallery_labels': {label: l10n.css.lblcnt_label, info: l10n.css.lblcnt_info},
		'.ugallery .ugallery_label_filter': {label: l10n.css.labels_label, info: l10n.css.labels_info}
	},
	cssSelectorsId: Upfront.data.ugallery.defaults.type
});

Upfront.Models.UgalleryModel = UgalleryModel;
Upfront.Views.UgalleryView = UgalleryView;

}); //End require


})(jQuery);


define('text!elements/upfront-image/tpl/image.html',[],function () { return '<div class="<?php echo $preset ?>">\r\n\t<?php if($usingNewAppearance === false) { ?>\r\n\t<div class="uimage uimage-<?php echo $caption_position ?> uimage-status-<?php echo $image_status ?> uimage-caption-<?php echo $caption_position ?>-<?php echo $caption_alignment ?><?php echo $gifImage ?> <?php echo $placeholder_class ?>" style="text-align: <?php echo $align ?>;">\r\n\t<?php } else { ?>\r\n\t<div class="upfront-image-wrapper uimage uimage-<?php echo $properties[\'caption-position\'] ?> uimage-status-<?php echo $image_status ?> uimage-caption-<?php echo $properties[\'caption-position\'] ?>-<?php echo $properties[\'caption-alignment\'] ?><?php echo $gifImage ?> <?php echo $placeholder_class ?>" style="text-align: <?php echo $align ?>;">\r\n\t<?php } ?>\r\n\t\t<div class="upfront-image-caption-container" style="margin-top:<?php echo $marginTop ?>px">\r\n\t\t\t<?php if($url && !$in_editor) { ?>\r\n\t\t\t<a href="<?php echo $url ?>" target="<?php echo $link_target ?>">\r\n\t\t\t\t<?php } ?>\r\n\t\t\t\t<?php if($src){ ?>\r\n\t\t\t\t<div class="upfront-image-container" <?php if ($containerWidth) { ?>style="width:<?php echo $containerWidth ?>px;"<?php } ?>>\r\n\t\t\t\t<img src="<?php echo $src ?>" alt="<?php echo $alternative_text ?>" title="<?php echo $image_title ?>" <?php if($imgWidth) { ?>style="width:<?php echo $imgWidth ?>;"<?php } ?>/>\r\n\t\t</div>\r\n\t\t<?php } else { ?>\r\n\t\t<div class="upfront-image-starting_placeholder"><p>Image placeholder</p></div>\r\n\t\t<?php } ?>\r\n\r\n\t\t<?php if($usingNewAppearance !== true) { ?>\r\n\t\t\t<?php if($include_image_caption) { ?>\r\n\t\t\t\t<div class="wp-caption uimage-<?php echo $caption_alignment ?> uimage-<?php echo $caption_trigger ?> uimage-padded-caption" style="background:<?php echo $captionBackground == \'1\' ? $background : \'rgba(255, 255, 255, 0)\' ?>; ">\r\n\t\t\t\t\t<?php if($cover_caption) { ?>\r\n\t\t\t\t\t<div class="uimage-caption-cover">\r\n\t\t\t\t\t\t<?php } ?>\r\n\t\t\t\t\t\t<?php echo $image_caption ?>\r\n\t\t\t\t\t\t<?php if($cover_caption) { ?>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<?php } ?>\r\n\t\t\t\t</div>\r\n\t\t\t<?php } ?>\r\n\t\t<?php } else { ?>\r\n\t\t<?php if( !empty($properties[\'use_captions\']) && $display_caption === \'showCaption\' )  { ?>\r\n\t\t<div class="wp-caption uimage-<?php echo $properties[\'caption-alignment\'] ?> uimage-<?php echo $properties[\'caption-trigger\'] ?> uimage-padded-caption">\r\n\t\t\t<?php if($cover_caption) { ?>\r\n\t\t\t<div class="uimage-caption-cover">\r\n\t\t\t\t<?php } ?>\r\n\t\t\t\t<?php echo $image_caption ?>\r\n\t\t\t\t<?php if($cover_caption) { ?>\r\n\t\t\t</div>\r\n\t\t\t<?php } ?>\r\n\t\t</div>\r\n\t\t<?php } ?>\r\n\t\t<?php } ?>\r\n\r\n\t\t<?php if($url && !$in_editor) { ?>\r\n\t\t</a>\r\n\t\t<?php } ?>\r\n\t</div>\r\n</div>\r\n</div>\r\n\r\n<?php if($gifImage){ ?>\r\n<style>\r\n\t#<?php echo $element_id ?> .uimage-gif .upfront-image-container {\r\n\t\theight: <?php echo $element_size[\'height\'] ?>px;\r\n\t\twidth: <?php echo $element_size[\'width\'] ?>px;\r\n\t}\r\n\r\n\t#<?php echo $element_id ?> .uimage-gif img {\r\n\t\t   height: <?php echo $size[\'height\'] ?>px;\r\n\t\t   width: <?php echo $size[\'width\'] ?>px !important;\r\n\t\t   margin-top: <?php echo $gifTop ?>;\r\n\t\t   margin-left: <?php echo $gifLeft ?>;\r\n\t   }\r\n</style>\r\n<?php } ?>\r\n';});


define('text!elements/upfront-image/tpl/image_editor.html',[],function () { return '<div>\r\n<!--\r\n\tWrap everything in a div to convert this file\'s content in a jquery element\r\n\tso it is possible to use $.find.\r\n-->\r\n\r\n<script type="text/template" id="selector-tpl">\r\n\t<div id="upront-image-placeholder" class="upfront-image-section">\r\n\t\t<div class="upfront-image-selector-container">\r\n\r\n\t\t\t<h2>{{ l10n.drop_files }}</h2>\r\n\t\t\t<p>{{ l10n.max_file_size }}</p>\r\n\t\t\t<ul>\r\n\t\t\t\t<li>\r\n\t\t\t\t\t<a class="select-files" href="#">{{ l10n.select_files }}</a>\r\n\t\t\t\t</li>\r\n\t\t\t\t<!-- {{ l10n.or_browse }} -->\r\n\t\t\t\t<li>\r\n\t\t\t\t\t<a class="open-media-gallery" href="#">{{ l10n.media_gallery }}</a>\r\n\t\t\t\t</li>\r\n\t\t\t</ul>\r\n\t\t\t<!-- <span class="dragimagehand"></span> -->\r\n\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="progress-tpl">\r\n\t<div id="upfront-image-uploading" class="upfront-image-section">\r\n\t\t<h2>{{ l10n.uploading }}</h2>\r\n\t\t<div class="upfront-progress-container">\r\n\t\t\t<div id="upfront-progress"></div>\r\n\t\t</div>\r\n\t</div>\r\n</script>\r\n\r\n<script type="text/template" id="editor-tpl">\r\n\t<div id="uimage-cover" style="position:absolute; top:{{maskOffset.top}}px; left:{{maskOffset.left}}px; height: {{maskSize.height}}px; width: {{maskSize.width}}px"></div>\r\n\t<div id="uimage-canvas" style="position:absolute; overflow:hidden; top:{{offset.top}}px; left:{{offset.left}}px; height: {{size.height}}px; width: {{size.width}}px">\r\n\t\t<img class="uimage-img {{ rotation }}" src="{{src}}" style="width:100%; height:100%; position:absolute">\r\n\t</div>\r\n\r\n\t<div id="uimage-mask" class="image-edit-mask" style="position:absolute; top:{{maskOffset.top}}px; left:{{maskOffset.left}}px; height: {{maskSize.height}}px; width: {{maskSize.width}}px"></div>\r\n\r\n\t<div id="uimage-drag-handle" style="width:{{size.width}}px; height:{{size.height}}px;position:absolute; top:{{offset.top}}px; left:{{offset.left}}px">\r\n\t\t<div class="image-edit-resize image-edit-control"><i class="ui-resizable-handle ui-resizable-handle-se"></i></div>\r\n\t\t<!-- <div class="image-edit-rotate image-edit-control"><i class=""></i></div> -->\r\n\t</div>\r\n\r\n\t<div id="image-edit-buttons" style="position: absolute; top:{{maskOffset.top}}px; left: {{maskOffset.left + maskSize.width + 5}}px;">\r\n\t\t{[ for (var i = 0; i < buttons.length; i++) { ]}\r\n\t\t<a class="image-edit-button" id="{{buttons[i].id}}" title="{{buttons[i].tooltip}}">{{buttons[i].text}}</a>\r\n\t\t{[ } ]}\r\n\t</div>\r\n\t<div id="image-edit-buttons-bottom" style="z-index: 11; position: absolute; top:{{maskSize.width < 200 ? maskOffset.top : maskOffset.top + maskSize.height + 5}}px; left:{{maskSize.width < 200 ? maskOffset.left - 205 : maskOffset.left}}px; width: 200px" class="{{maskSize.width < 200 ? \'image-edit-buttons-toleft\' : \'\' }}">\r\n\t\t<a class="image-edit-button" id="image-edit-button-swap" title="Use a different image">Change IMG</a>\r\n\t\t<a class="image-edit-button" id="image-edit-button-align" title="Align image" ></a>\r\n\t</div>\r\n</script>\r\n\r\n<script type="text/template" id="upload-form-tpl">\r\n<form id="upfront-upload-image" name="upfront-upload-image" enctype="multipart/form-data" method="post" action="{{url}}" data-url="{{url}}?action=upfront-media-upload">\r\n\t<input type="file" name="media" id="upfront-image-file-input" multiple >\r\n\t<input type="hidden" name="action" value="upfront-media-upload">\r\n\t<input type="submit" value="Upload">\r\n</form>\r\n</script>\r\n\r\n<script type="text/template" id="sizehint-tpl">\r\n\t<b>w:</b>{{width}}{[ if(width.toString().indexOf("%") === -1){ ]}px{[ } ]}\r\n\t<b>h:</b>{{height}}{[ if(height.toString().indexOf("%") === -1){ ]}px{[ } ]}\r\n</div>\r\n</script>\r\n\r\n<script type="text/template" id="fullwidth-alert-tpl">\r\n\t<div class="uimage-fullwidth-alert">\r\n\t\t<p>{{ l10n.move_image_nag }}</p>\r\n\t\t<div class="clearfix">\r\n\t\t\t<div class="uimage-fullwidth-info uimage-fullwidth-info-1"></div>\r\n\t\t\t<div class="uimage-fullwidth-info uimage-fullwidth-info-2"></div>\r\n\t\t\t<div class="uimage-fullwidth-info uimage-fullwidth-info-3"></div>\r\n\t\t</div>\r\n\t\t<div style="margin-top:10px">\r\n\t\t\t<input class="upfront-field-checkbox" type="checkbox" id="uimage-fullwidth-noalert" value="1">\r\n\t\t\t<label for="uimage-fullwidth-noalert">{{ l10n.dont_show_again }}</label>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n</script>\r\n\r\n</div>\r\n';});

define('elements/upfront-image/js/context-menu/list',[],function() {
	var l10n = Upfront.Settings.l10n.image_element;
	// Context Menu for the Image element
	var ImageMenuList = Upfront.Views.ContextMenuList.extend({
		initialize: function(opts) {
			this.options = opts;
			this.for_view = this.options.for_view;
			var me = this;
			var menuitemsarray = [
						new Upfront.Views.ContextMenuItem({
					get_label: function() {
            if (me.for_view.isThemeImage()) {
							return l10n.ctrl.edit_image;
            }
						if(me.for_view.$el.find('div.upfront-image-container > img').length > 0) {
							return l10n.ctrl.edit_image;
						} else {
							return l10n.ctrl.add_image;
						}
					},
					action: function() {
            if (me.for_view.isThemeImage()) {
              me.for_view.replaceImage();
              return;
            }
						if(me.for_view.$el.find('div.upfront-image-container > img').length > 0) {
							me.for_view.editRequest();
						} else {
							me.for_view.openImageSelector();
						}
					}
				})
					];

			if(this.for_view.$el.find('div.upfront-image-container > img').length > 0) {
				menuitemsarray.push( new Upfront.Views.ContextMenuItem({
						get_label: function() {
							if(me.for_view.$el.find('div.upfront-image-container div.wp-caption').length > 0) {
								return l10n.ctrl.edit_caption;
							} else {
								return l10n.ctrl.add_caption;
							}
						},
						action: function() {
							if(me.for_view.$el.find('div.upfront-image-container > div.wp-caption').length > 0) {
								me.for_view.$el.find('div.upfront-image-container > div.wp-caption').data('ueditor').start();
							} else {
							 me.for_view.controls.items.value()[2].selected='topOver';
							 me.for_view.controls.items.value()[2].trigger('select');

							 me.for_view.property('include_image_caption', [1]);
							 me.for_view.property('caption_position', 'over_image');
							 me.for_view.property('caption_alignment', 'top');
							 me.for_view.render();

							}

						}
					}));
			}

			this.menuitems = _(menuitemsarray);
		}
	});

	return ImageMenuList;
});

define('elements/upfront-image/js/image-context-menu',[
	'elements/upfront-image/js/context-menu/list'
], function(ImageContextMenuList) {

	var ImageContextMenu = Upfront.Views.ContextMenu.extend({
		initialize: function(opts) {
			this.options = opts;
			this.for_view = this.options.for_view;
			this.menulists = _([
				new ImageContextMenuList({for_view: this.for_view})
			]);
		}
	});

	return ImageContextMenu;
});


define('text!elements/upfront-image/tpl/preset-style.html',[],function () { return '.<?php echo $properties[\'id\'] ?> .upfront-image-caption-container .wp-caption p,\r\n.<?php echo $properties[\'id\'] ?> .upfront-image-caption-container .wp-caption {\r\n\t<?php if(!empty($properties[\'caption-text\'])) { ?>\r\n\tcolor: <?php echo $properties[\'caption-text\']  ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-image-caption-container .wp-caption {\r\n\t<?php if(!empty($properties[\'caption-bg\'])) { ?>\r\n\tbackground: <?php echo $properties[\'caption-bg\'] ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-image-caption-container {\r\n\t <?php if(!empty($properties[\'useborder\'])) { ?>\r\n        <?php if(!empty($properties[\'borderwidth\']) && !empty($properties[\'bordertype\']) && !empty($properties[\'bordercolor\'])) { ?>border: <?php echo $properties[\'borderwidth\'] ?>px <?php echo $properties[\'bordertype\'] ?> <?php echo $properties[\'bordercolor\'] ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        border: none;\r\n    <?php } ?>\r\n}\r\n\r\n.<?php echo $properties[\'id\'] ?> .upfront-image-caption-container {\r\n\t<?php if(!empty($properties[\'useradius\'])) { ?>\r\n        border-radius: <?php echo $properties[\'borderradius1\'] ? $properties[\'borderradius1\'] : 0 ?>px <?php echo $properties[\'borderradius2\'] ? $properties[\'borderradius2\'] : 0 ?>px <?php echo $properties[\'borderradius4\'] ? $properties[\'borderradius4\'] : 0 ?>px <?php echo $properties[\'borderradius3\'] ? $properties[\'borderradius3\'] : 0 ?>px;\r\n    <?php } else { ?>\r\n        border-radius: 0px;\r\n    <?php } ?>\r\n\toverflow: hidden;\r\n}\r\n\r\n/* Custom CSS */\r\n<?php if(!empty($properties[\'preset_style\'])) { ?><?php echo $properties[\'preset_style\'] ?><?php } ?>\r\n';});

define('elements/upfront-image/js/image-settings',[
	'scripts/upfront/preset-settings/util',
	'scripts/upfront/element-settings/settings',
	'text!elements/upfront-image/tpl/preset-style.html'
], function(Util, ElementSettings, styleTpl) {
	var l10n = Upfront.Settings.l10n.image_element;

	var ImageSettings = ElementSettings.extend({
		panels: {
			Appearance: {
				mainDataCollection: 'imagePresets',
				styleElementPrefix: 'image-preset',
				ajaxActionSlug: 'image',
				panelTitle: l10n.settings,
				presetDefaults: Upfront.mainData.presetDefaults.image,
				styleTpl: styleTpl,
				stateModules: {
					Global: [
						{
							moduleType: 'Selectbox',
							options: {
								state: 'global',
								default_value: 'default',
								title: l10n.settings.image_style_label,
								custom_class: 'image_style',
								label: l10n.settings.image_style_info,
								fields: {
									name: 'imagestyle'
								},
								values: [
									{ label: "Default", value: 'default' },
									{ label: "Square", value: 'square' },
								]
							}
						},
						{
							moduleType: 'Radius',
							options: {
								state: 'global',
								max_value: 100,
								fields: {
									use: 'useradius',
									lock: 'borderradiuslock',
									radius: 'radius',
									radius_number: 'radius_number',
									radius1: 'borderradius1',
									radius2: 'borderradius2',
									radius3: 'borderradius3',
									radius4: 'borderradius4'
								}
							}
						},
						{
							moduleType: 'CaptionLocation',
							options: {
								state: 'global',
								fields: {
									caption: 'image-caption'
								}
							}
						},
						{
							moduleType: 'Colors',
							options: {
								title: l10n.settings.content_area_colors_label,
								multiple: false,
								single: false,
								abccolors: [
									{
										name: 'caption-text',
										label: l10n.settings.caption_text_label
									},
									{
										name: 'caption-bg',
										label: l10n.settings.caption_bg_label
									},
								]
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'global',
								title: '',
								fields: {
									use: 'useborder',
									width: 'borderwidth',
									type: 'bordertype',
									color: 'bordercolor',
								}
							}
						}
					]
				},
				
				migrateElementStyle: function(styles) {
					//replace image wrapper class
					styles = styles.replace(/upfront-image/, 'upfront-image-wrapper');
					
					return styles;
				},
				
				migratePresetProperties: function(newPreset) {
					var props = {},
						useCaption = captionValue = '';

					this.model.get('properties').each( function(prop) {
						props[prop.get('name')] = prop.get('value');
					});
					
					if(props.caption_position && props.caption_trigger) {
						useCaption = 'yes';
					}
					
					//Determinate caption value from settings
					if(props.caption_position === 'over_image' && props.caption_alignment === 'top') {
						captionValue = 'topOver';
					} else if(props.caption_position === 'over_image' && props.caption_alignment === 'bottom') {
						captionValue = 'bottomOver';
					} else if(props.caption_position === 'over_image' && props.caption_alignment === 'fill') {
						captionValue = 'topCover';
					} else if(props.caption_position === 'over_image' && props.caption_alignment === 'fill_middle') {
						captionValue = 'middleCover';
					} else if(props.caption_position === 'below_image' && props.caption_alignment === 'fill_bottom') {
						captionValue = 'bottomCover';
					} else {
						captionValue = 'below';
					}

					newPreset.set({
						'use_captions': useCaption,
						'caption-position-value': captionValue,
						'caption-position': props.caption_position,
						'caption-alignment': props.caption_alignment,
						'caption-trigger': props.caption_trigger,
						'caption-bg' : props.background,
					});
				},
				
				getModifiedProperties: function() {
					var props = {};

					this.model.get('properties').each( function(prop) {
						props[prop.get('name')] = prop.get('value');
					});

					if(typeof props.theme_style !== "undefined" && props.theme_style !== "_default") {
						return true;
					}
					
					if((typeof props.caption_position !== "undefined" && props.caption_position !== false) || 
					   (typeof props.caption_alignment !== "undefined" && props.caption_alignment !== false) || 
					   (typeof props.caption_trigger !== "undefined" && props.caption_trigger !== "always_show")) {
						return true;
					}
					
					if(typeof props.background !== "undefined" && props.background !== "#000000") {
						return true;
					}

					return false;
				}
			}
		},
		
		title: l10n.settings.label
	});

	// Generate presets styles to page
	Util.generatePresetsToPage('image', styleTpl);

	return ImageSettings;
});

(function ($) {
define('elements/upfront-image/js/image-selector',[
	'text!elements/upfront-image/tpl/image_editor.html'
], function(editorTpl) {
	var l10n = Upfront.Settings.l10n.image_element;

	var ImageSelector = Backbone.View.extend({
		selectorTpl: _.template($(editorTpl).find('#selector-tpl').html()),
		progressTpl: _.template($(editorTpl).find('#progress-tpl').html()),
		formTpl: _.template($(editorTpl).find('#upload-form-tpl').html()),
		deferred: $.Deferred(),
		defaultOptions: {multiple: false, multiple_sizes: true, preparingText: l10n.sel.preparing},
		options: {},


		initialize: function(){
			// Set the form up
			this.setup_upload_form();
		},
		setup_upload_form : function(){
				var me = this;
				if ($('#upfront-upload-image').length === 0) {
				$('body').append(me.formTpl({url: Upfront.Settings.ajax_url, l10n: l10n.template}));
				
				$('body').bind( 'keyup', function( event ) {
					if ( event.keyCode === 27 )
						me.closeOverlay();
				});
				
				var progress = $('#upfront-progress'),
					fileInput = $('#upfront-image-file-input'),
					form = $('#upfront-upload-image')
				;

				if (!!form.fileupload) {
					form.fileupload({
							sequentialUploads: true,
							formData: _.extend({action: 'upfront-media-upload'}, Upfront.Media.Ref),
							fileInput: null, // disable change listener, we handle it below
							paramName: 'media[]' // due to previous options we have to set this manually
						})
						.bind('fileuploadstart', function () {
							progress.css('width', '0');
						})
						.bind('fileuploadprogressall', function (e, data) {
							var percent = parseInt(data.loaded / data.total * 100, 10);
							progress.css('width', percent + '%');
						})
						.bind('fileuploaddone', function (e, data) {
							var response = data.result;
							progress.css('width', '100%');
							$('#upfront-image-uploading h2').html(l10n.sel.preparing);
							Upfront.Views.Editor.ImageEditor.getImageData(response.data, me.options.customImageSize)
								.done(function(response){
									me.deferred.resolve(response.data.images, response);
								})
								.error(function(){
									Upfront.Views.Editor.notify(l10n.sel.upload_error, 'error');
									me.openSelector();
								});
							form[0].reset();
							//$('#upfront-upload-image').remove();
						})
						.bind('fileuploadfail', function (e, response) {
							var error = response.jqXHR.responseJSON.error;
							Upfront.Views.Editor.notify(error, 'error');
							me.openSelector();
							form[0].reset();
							//$('#upfront-upload-image').remove();
						});
				}

				fileInput.on('change', function(){
					if (this.files.length) {
						if(XMLHttpRequest && (new XMLHttpRequest()).upload) { //XHR uploads!
							me.uploadImage(this.files);
						} else {
							me.openProgress(function() {
								form.fileupload('add', {
									fileInput: fileInput
								});
							});
						}
					}
				});
			}
		},
		open: function(options) {
			this.deferred = $.Deferred();

			if(! _.isObject(options)) {
				options = {};
			}

			this.options = _.extend({}, this.defaultOptions, options);

			this.openSelector();

			Upfront.Events.trigger('upfront:element:edit:start', 'media-upload');

			return this.deferred.promise();
		},

		openSelector: function() {
			var me = this;
			this.openOverlaySection(this.selectorTpl, {}, function() {
				var input = $('#upfront-image-file-input');
				if (me.options.multiple === true) {
					input.attr('multiple','multiple');
					input.attr('name', 'media[]');
				} else {
					input.attr('multiple', false);
					input.removeAttr('multiple');
					input.attr('name', 'media');
				}

				$('#upront-image-placeholder')
					.on('dragenter', function(e){
						e.preventDefault();
						e.stopPropagation();
					})
					.on('dragleave', function(e){
						e.preventDefault();
						e.stopPropagation();
						$(this).css('border-color', '#C3DCF1');
						$(this).css('background', 'none');
					})
					.on('dragover', function(e){
						e.preventDefault();
						e.stopPropagation();
						$(this).css('border-color', '#1fcd8f');
						$(this).css('background', 'rgba(255,255,255,.1)');
						$(this).find();
					})
					.on('drop', function(e){
						var files;
						e.preventDefault();
						e.stopPropagation();
						if (e.originalEvent.dataTransfer) {
							files = e.originalEvent.dataTransfer.files;

							// Only call the handler if 1 or more files was dropped.
							if (files.length) {
									//input[0].files = files;
									me.uploadImage(files);
							}
						}
					});

				me.resizeOverlay();
			});
		},

		openProgress: function(callback){
			var me = this;
			this.openOverlaySection(this.progressTpl, {}, function() {
				me.resizeOverlay();
				callback();
			});
		},

		resizeOverlay: function(){
			var overlay = $('#upfront-image-overlay');
			if(!overlay.length) {
				return;
			}

			var placeholder = $('#upront-image-placeholder'),
				uploading = $('#upfront-image-uploading'),
				phcss = {},
				left = $('#sidebar-ui').width(),
				style = {
					left: left,
					width: $(window).width() - left,
					height: $(window).height()
				},
				ptop = (style.height / 2 - 220)
			;

			if(ptop > 0){
				overlay.removeClass('small_placeholder');
				ptop += 'px';
			}
			else {
				overlay.addClass('small_placeholder');
				ptop = (style.height / 2 - 140) + 'px';
			}

			overlay.css(style);
			phcss = {
				height: style.height - 100,
				'padding-top':  ptop
			};

			placeholder.css(phcss);
			uploading.css(phcss);
		},

		close: function() {
			this.closeOverlay();
		},

		cancelOverlay: function(e) {
			if(e.target === e.currentTarget) {
				this.closeOverlay(e);
			}
		},
		closeOverlay: function(){
			$('#upfront-image-overlay')
				.off('click')
				.fadeOut('fast', function(){
					$(this).remove();
					$('#upfront-image-overlay').remove();
				})
			;

			$('html').css({
				overflow: this.bodyOverflow ? this.bodyOverflow : 'auto',
				height: 'auto',
				width: 'auto'
			});

			$('body').removeClass('upfront-image-upload-open');

			if(this.reopenSettings){
				$('#settings').fadeIn();
				this.reopenSettings = false;
			}

			//Restart draggable
			//this.parent_module_view.$('.upfront-editable_entity:first').draggable('enable');

			$(window).off('resize', this.resizeOverlay);
			Upfront.Events.trigger('upfront:element:edit:stop');
		},

		openOverlaySection: function(tpl, tplOptions, callback){
			var me = this,
				settings = $('#settings'),
				overlay = $('#upfront-image-overlay')
				//,parent = this.parent_module_view.$('.upfront-editable_entity:first')
			;

			tplOptions.l10n = l10n.template;

			/*
			if(!this.elementSize.width)
				this.setElementSize();
			*/
			if(overlay.length){
				$('.upfront-image-section').fadeOut('fast', function(){
					var content = $(tpl(tplOptions)).hide();
					overlay.append(content);
					content.fadeIn('fast');
					$(this).remove();
					if(callback){
						callback(overlay);
					}
				});
				return;
			}

			this.bodyOverflow = $('html').css('overflow');
			$('html')
				.css({
					overflow: 'hidden',
					width: $(window).width() + 'px',
					height: $(window).height() + 'px'
				})
			;

			//Stop draggable
			/*
			if (parent.is(".ui-draggable"))
				parent.draggable('disable');
			*/

			overlay = $('<div id="upfront-image-overlay" class="upfront-ui"></div>').append(tpl(tplOptions)).hide();

			$('body')
				.append(overlay)
				.addClass('upfront-image-upload-open')
			;


			this.setOverlayEvents();

			overlay.fadeIn('fast');
			this.resizeOverlay();

			$(window)
				.on('resize', function(e){
					if(e.target === window){
						me.resizeOverlay();
					}
				})
			;

			if(settings.is(':visible')){
				settings.fadeOut();
				this.reopenSettings = true;
			}

			if(callback) {
				callback(overlay);
			}
		},
		setOverlayEvents: function() {
			var me = this;
			$('#upfront-image-overlay')
				.on('click', function(e){
					me.cancelOverlay(e);
				})
				.on('click', 'a.select-files', function(e){
					me.openFileBrowser(e);
				})
				.on('click', 'a.image-edit-change', function(e){
					me.openImageSelector(e);
				})
				.on('click', 'a.open-media-gallery', function(e){
					me.openMediaGallery(e);
				})
			;
		},
		openMediaGallery: function(e) {
			var me = this,
				opts = {
					multiple_selection: this.options.multiple,
					multiple_sizes: this.options.multiple_sizes,
					media_type:['images']
				}
			;
			e.preventDefault();

			Upfront.Media.Manager.open(opts)
				.done(function(popup, result){
					if(result && result.length > 0){
						var ids = [];
						result.each(function(image){
							ids.push(image.get('ID'));
						});
						// We really should be having the element_id in our context by now...
						Upfront.Views.Editor.ImageEditor.getImageData(ids, me.options.customImageSize, me.options.element_id)
							.done(function(response){
								me.deferred.resolve(response.data.images, response);
							})
						;

						me.openProgress(function(){
							$('#upfront-image-uploading h2').html(me.options.preparingText);
						});
					}
				})
			;
		},
		openFileBrowser: function(e){
			e.preventDefault();
			$('#upfront-image-file-input').click();
		},
		checkFileUpdate: function(){
			 return true;
		},
		uploadImage: function(files){
			var me = this;
			me.setup_upload_form();
			this.openProgress(function() {
				$('#upfront-upload-image').fileupload('send', {files: files});
			});
		}
	});

	return ImageSelector;
});
})(jQuery);

(function ($) {
define('elements/upfront-image/js/image-editor',[
	'text!elements/upfront-image/tpl/image_editor.html'
], function(editorTpl) {
	var l10n = Upfront.Settings.l10n.image_element;
	var breakpointColumnPadding = Upfront.Views.breakpoints_storage.get_breakpoints().get_active().get('column_padding');
	breakpointColumnPadding = parseInt(breakpointColumnPadding, 10);
	breakpointColumnPadding = _.isNaN(breakpointColumnPadding) ? 15 : breakpointColumnPadding;

	/**
	 * The image editor needs the image to be uploaded as an attachment to WP in order to work.
	 * The open method must receive the following options in an array:
	 * {
	 * 		id: The image attachment id. It is mandatory for the edition in the server side.
	 * 		maskOffset: and array with the offset of the mask element relative to the top left of the page
	 * 	 	maskSize: an array with the size of the mask
	 * 	 	position: (optional:[{top:0, left:0}]) if the image is cropped is the offset of the crop relative to the original size of the image
	 * 	 	size: the size of the image if it wasn't cropped
	 * 	 	fullSize: the size of the original image
	 * 	 	srcOriginal: the source url of the original image (the best to edit)
	 * 	 	src: the source url of the image in the page
	 * 	 	rotation: (optional:[0]) The angle of rotation of the image on the page relative to the original
	 * 	 	align: (optional:['left']) alignment of the image (used if the image is smaller than the mask)
	 * 	 	setImageSize: (optional:[false]) Boolean to tell the editor to calculates an initial size for the image. Default false.
	 * 	 	buttons: (optional:[[]]) An array with extra buttons for the editor. Every button is an object with
	 * 	 		'id': HTML id for the button
	 * 	 		'text': Tooltip text for the button
	 * 	 		'callback': A function to be called when clicked.
	 * 	 	resizeElement: (ObjectView): An element to resize when the image is smaller than the element or it is expanded to 100%
	 *
	 * }
	 * @return Promise When edition is successful an response object is return as parameter for the promise with the following attributes:
	 * {
	 * 		imageId: The attachment id
	 * 		imageSize: The result image size without cropping
	 * 		imageOffset: The offset of the crop relative to the top-left of the image.
	 * 		maskSize: The size of the mask
	 * 		cropSize: The size of the crop
	 * 		src: The source url of the crop
	 * 		srcFull: The source url of the full version. It may be a rotated version of the original.
	 * 		rotation: Angle of rotation relative to the original image
	 * 		fullSize: the size of the original image
	 * 		align: alignment for the image
	 * 		stretch: Whether the image is wider than the mask. If the image is narrower should be aligned instead of stretched when resizing.
	 * }
	 */
	var ImageEditor = Backbone.View.extend({
		id: 'upfront-image-edit',
		rotation: 0,
		mode: 'big', // big | small | vertical | horizontal
		invert: false,
		tpl: _.template($(editorTpl).find('#editor-tpl').html()),
		src: '#',
		bordersWidth: 0,
		response: false,
		fullSize: {width: 0, height:0},
		buttons: [],
		sizes: false,

		events: {
			'click #image-edit-button-ok': 'imageOk',
			'click #image-edit-button-reset': 'image100', //'resetImage',
			'click #image-edit-button-fit': 'fitImage',
			'click #image-edit-button-align': 'selectAlign',
			// 'click .image-edit-rotate': 'rotate',
			'click .image-fit-element-button': 'fitMask',
			'click #image-edit-button-swap': 'changeImage'
		},

		initialize: function(){
			var me = this;
			this.$el.on('click', function(e){
				if(e.target === e.currentTarget){
					if(me.saveOnClose) {
						me.imageOk();
					} else if(!me.isResizing && !me.isDragged) {
						me.cancel();
					}
				}
				me.isResizing = false;
				me.isDragged = false;
			});

			$('body').bind( 'keyup', function( event ) {
				if ( event.keyCode === 27) {
					if('undefined' !== typeof me.element_id) {
						me.close();
					}
				}
			});
		},

		resetDefaults: function(){
			this.rotation = 0;
			this.mode = 'big';
			this.invert = false;
			this.src = '#';
			//this.response = false;
			this.fullSize = {width: 0, height:0};
			this.setImageInitialSize = false;
			this.buttons = [
				{id: 'image-edit-button-fit', text: l10n.btn.fit_label, tooltip: l10n.btn.fit_info},
				{id: 'image-edit-button-reset', text: l10n.btn.exp_label, tooltip: l10n.btn.exp_info},
				{id: 'image-edit-button-ok', text: l10n.btn.save_label, tooltip: l10n.btn.save_info}
			];
			this.sizes = false;
			//this.promise = false;
			this.align = 'left';
			this.saveOnClose = false;
			this.elementSize = false;
			this.fitImageButton = true;
		},

		centerImageOffset: function(imageSize, maskSize){
			return {
				top: - (imageSize.height - maskSize.height) / 2,
				left: - (imageSize.width - maskSize.width) / 2
			};
		},

		open: function(options){
			// When image element is bigger than image it contains mask will be smaller than element.
			// If than user uploads bigger image in that image element mask should expand to element
			// size so that new image will not be cut off in image element.
			if (options.maskSize && options.editElement && options.editElement.elementSize && // safe guards
					options.maskSize.height < options.editElement.elementSize.height &&
					options.editElement.elementSize.height < options.fullSize.height) {
				options.maskSize.width = options.editElement.elementSize.width + 2;
				options.maskSize.height = options.editElement.elementSize.height;
			}

			this.resetDefaults();
			this.options = options;
			this.src = options.src;
			this.saveOnClose = options.saveOnClose;

			options.maskOffset.top += this.fixImageTop(options.maskOffset);

			this.setOptions(options);

			var resizedElement = this.maybeResizeElement(options);
			if(resizedElement){
				options.position = {top: 0, left: 0};
				options.maskSize = resizedElement.maskSize;
				options.size = resizedElement.imageSize;
				options.setImageSize = false;
				options.align = 'left';
				options.resizedElement = true;

				return this.open(options);
			}

			if(!this.options.editElement) {
				this.buttons = [{id: 'image-edit-button-ok', text: l10n.btn.save_label, tooltip: l10n.btn.save_info}];
			}

			var halfBorder = this.bordersWidth /2,
				maskOffset = {
					top: parseInt(options.maskOffset.top, 10) - halfBorder,
					left: parseInt(options.maskOffset.left, 10) - halfBorder
				},
				maskSize = {
					width: parseInt(options.maskSize.width, 10) + this.bordersWidth,
					height: parseInt(options.maskSize.height, 10) + this.bordersWidth
				}
			;

			if(!options.position) {
				options.position = this.centerImageOffset(options.size, maskSize);
			}

			var canvasOffset = {
					top: parseInt(maskOffset.top, 10) - options.position.top + halfBorder,
					left: parseInt(maskOffset.left, 10) - options.position.left + halfBorder
				},
				canvasSize = {
					width: parseInt(options.size.width, 10),
					height: parseInt(options.size.height, 10)
				}
			;

			this.imageId = options.id;
			this.src = options.srcOriginal;

			this.fullSize = options.fullSize;
			if(options.align) {
				this.align = options.align;
			}


			if(this.setImageInitialSize){
				var fullImageProps = this.getFullWidthImage();
				canvasSize = fullImageProps.size;
				canvasOffset.left = fullImageProps.left;
			}
			else if(options.imageFit){
				canvasSize = this.initialImageSize(0, false, maskSize);
			}

			var tplOptions = {
				size: canvasSize,
				offset: canvasOffset,
				maskOffset: maskOffset,
				rotation: 'rotate_' + this.rotation,
				src: this.src,
				maskSize: maskSize,
				buttons: this.buttons,
				fitMask: options.fitMaskColumns
			};

			this.$el.html(this.tpl(tplOptions)).find('div').hide();
			if(!this.$el.closest('body').length){
				this.response = $.Deferred();
				$('body').append(this.$el);
			}

			this.addGridLines(maskOffset.top, maskSize.height);

			this.$el.css({
				height: $(document).height(),
				width: $(document).width()
			}).find('div').fadeIn(200);

			this.selectMode(canvasSize);
			this.startEditorUI();
			this.selectMode(canvasSize, true);

			this.setImageSize(canvasSize);

			//this.setAlign(this.align);
			this.$('#image-edit-button-align').addClass('align-' + this.align);

			if(this.setImageInitialSize){
				this.resetImage(false, false);
			}

			if(options.editElement){
				this.check100ButtonActivation();
			}

			return this.response.promise();
		},

		setOptions: function(options) {
			var me = this;
			if(typeof options.rotation !== 'undefined') {
				this.setRotation(options.rotation);
			} else {
				this.setRotation(0);
			}

			if(options.setImageSize) {
				this.setImageInitialSize = true;
			}

			if(options.extraButtons && options.extraButtons.length){
				_.each(options.extraButtons, function(button){
					me.buttons.push({id: button.id, text: button.text});
					me.$el
						.off('click', '#' + button.id)
						.on('click', '#' + button.id, function(e){
							button.callback(e, me);
						})
					;
				});
			}
			this.element_id = options.element_id || false;
		},

		check100ButtonActivation: function(){
			var full = this.getFullWidthImage(this.options.fullSize).size,
				fullColsRows = this.getCurrentImageRowsCols(full.width, full.height),
				button = this.$('#image-edit-button-reset')
			;
			if(this.elementSize.columns === fullColsRows.columns && this.elementSize.rows === fullColsRows.rows) {
				button.addClass('deactivated expanded').attr('title', l10n.image_expanded);
			} else if(this.elementSize.columns === this.elementSize.maxColumns && this.elementSize.columns < fullColsRows.columns && this.elementSize.rows === fullColsRows.rows) {
				button.addClass('deactivated').attr('title', l10n.cant_expand);
			}
		},

		/**
		 * Return the new mask size if the element could be resized in order to fit the current image.
		 * Also it iset the elementSize property.
		 * @param  {Object} options
		 * @return {Mixed} False if the current size is ok or the {width, height} hash if it can be improved
		 */
		maybeResizeElement: function(options, stretch){
			if(!options.editElement) {
				return false;
			}

			var elementView = options.editElement,
				elementSize = {
					maxColumns: elementView.get_element_max_columns(),
					maxRows: elementView.get_element_max_rows(),
					rowHeight: breakpointColumnPadding
				}
			;

			if(!elementSize.maxRows) {
				elementSize.maxRows = elementView.get_element_rows();
			}

			elementSize.columnWidth = elementView.get_element_max_columns_px() / elementSize.maxColumns;

			elementSize.rows = Math.round(options.maskSize.height / breakpointColumnPadding) + 2;
			elementSize.columns = Math.ceil(options.maskSize.width / elementSize.columnWidth);

			this.elementSize = elementSize;

			// If the image is not new we are done
			if(!options.setImageSize) {
				return false;
			}

			var fullGrid = this.getFullWidthImage(options.fullSize).size,
				current = this.getCurrentImageRowsCols(fullGrid.width, fullGrid.height),
				maskSize = {
					width: current.columns * this.elementSize.columnWidth - (2 * breakpointColumnPadding),
					height: (current.rows - 2) * this.elementSize.rowHeight
				}
			;

			if(current.columns > elementSize.columns || current.rows > elementSize.rows) {
				return false;
			}

			if(!stretch){
				maskSize = {
					width: Math.max(current.columns, elementSize.columns) * elementSize.columnWidth - (2 * breakpointColumnPadding),
					height: (Math.min(current.rows, elementSize.rows) - 2) * breakpointColumnPadding
				};
			}
			else if(this.elementSize.maxColumns < current.columns){
				var maskWidth = this.elementSize.maxColumns * this.elementSize.columnWidth - (2 * breakpointColumnPadding);
				maskSize = {
					width:  maskWidth,
					height: fullGrid.height
				};
			}

			return {
				maskSize: maskSize,
				imageSize: fullGrid
			};
		},

		imageOk: function() {
			var results = this.getEditorResults(),
				me = this,
				loading = new Upfront.Views.Editor.Loading({
					loading: l10n.saving,
					done: l10n.saving_done,
					fixed: false
				}),
				mask = this.$('#uimage-mask')
			;

			if(results.imageId){
				loading.render();
				mask.append(loading.$el);
				this.saveImageEdition(
					results.imageId,
					results.rotation,
					results.imageSize,
					{
						top: results.imageOffset.top,
						left: results.imageOffset.left,
						width: results.maskSize.width,
						height: results.maskSize.height
					}
				)
				.done(function(result){
					var imageData = result.data.images[results.imageId];

					loading.done();

					if(imageData.error){
						Upfront.Views.Editor.notify('Image failed to process. ' + imageData.msg, 'error', 15*1000);
						me.close();
						return;
					}

					results.src = imageData.url;
					results.srcFull = imageData.urlOriginal;
					results.cropSize = imageData.crop;
					results.gif = imageData.gif || 0;
					if(me.options.resizedElement) {
						results.elementSize = me.getCurrentMaskRowsCols();
					}
					me.response.resolve(results);
					me.close();
				});
			}
		},

		close: function(reason) {
			var me = this;
			this.unfixImageTop();
			this.$('div').fadeOut(200, function(){
				me.$el.detach();
			});
			this.options = false;
			me.response.reject({reason: reason, id: this.imageId});
		},

		cancel: function(reason){
			this.close(reason);
		},

		changeImage: function(e){
			e.preventDefault();
			this.close('changeImage');
		},

		getEditorResults: function() {
			var canvas = this.$('#uimage-canvas'),
				img = canvas.find('img'),
				mask = this.$('#uimage-mask'),
				src = img.attr('src'),
				halfBorder = this.bordersWidth / 2
			;

			return {
				imageSize: {width: Math.round(this.invert ? img.height() : img.width()), height: Math.round(this.invert ? img.width() : img.height())},
				imageOffset: {
					top: mask.offset().top - canvas.offset().top + halfBorder,
					left: mask.offset().left - canvas.offset().left + halfBorder
				},
				maskSize: {
					width: mask.width(),
					height: mask.height()
				},
				rotation: this.rotation,
				imageId: this.imageId,
				fullSize: this.fullSize,
				srcOriginal: src,
				align: this.align,
				stretch : this.mode === 'big' || this.mode === 'horizontal',
				vstretch: this.mode === 'big' || this.mode === 'vertical',
				mode: this.mode
			};
		},

		rotate: function(e){
			var rotation = this.rotation,
				img = this.$('.uimage-img'),
				rotationClass = '',
				size = {width: img.width(), height: img.height()},
				canvas = this.$('#uimage-canvas'),
				handler = this.$('#uimage-drag-handle')
			;

			if(e){
				e.preventDefault();
				e.stopPropagation();
			}

			rotation = rotation === 270 ? 0 : rotation + 90;

			if(rotation) {
				rotationClass = 'rotate_' + rotation;
			}

			img.removeClass()
				.addClass('uimage-img ' + rotationClass);

			this.setRotation(rotation);

			if(this.invert){
				canvas.css({
					height: size.width,
					width: size.height
				});
				handler.css({
					height: size.width,
					width: size.height
				});
				img.css({
					height: size.height,
					width: size.width
				});
				//$('#uimage-drag-handle').resizable('option', 'aspectRatio', size.height / size.width);
			}
			else{
				canvas.css(size);
				handler.css(size);
				img.css({
					height: '100%',
					width: '100%'
				});
				//$('#uimage-drag-handle').resizable('option', 'aspectRatio', size.width / size.height);
			}

			img.css(this.imgOffset({width: img.width(), height: img.height()}));

			this.selectMode({width: canvas.width(), height: canvas.height()});

			//this.centerImage(true);

			$('#uimage-drag-handle').draggable('option', 'containment', this.getContainment());
			this.setResizingLimits();
		},

		setRotation: function(rotation){
			this.rotation = rotation;
			this.invert = [90,270].indexOf(rotation) !== -1;
		},

		imgOffset: function(size) {
			if(! this.invert) {
				return {top: 0, left: 0};
			}
			return {
				top: Math.floor((size.width - size.height) / 2),
				left: Math.floor((size.height - size.width) / 2)
			};
		},

		startEditorUI: function() {
			var me = this,
				canvas = this.$('#uimage-canvas')
			;
			$('#uimage-drag-handle')
				.resizable({
					handles: {se: $('.image-edit-resize i')},
					autoHide: 0,
					aspectRatio: true, //(me.fullSize.width + me.bordersWidth) / (me.fullSize.height + me.bordersWidth),
					start: function() {
						me.$('#image-edit-button-reset')
							.attr('class', 'image-edit-button')
							.attr('title', l10n.btn.exp_info)
						;
						//Prevent editor closing after resizing. It is set to false by the initialize method.
						me.isResizing = true;
					},
					resize: function(e, ui){
						canvas.css(ui.size);
						me.setImageSize(ui.size);
					},
					stop: function(e, ui){
						var dragHandle = me.$('#uimage-drag-handle');
						e.preventDefault();
						//Recalculate dimensions from the original size
						var imageSize = {
								width: (me.invert ? ui.size.height : ui.size.width),
								height: (me.invert ? ui.size.width : ui.size.height)
							},
							factor = me.fullSize.width / Math.floor(imageSize.width),
							canvasSize
						;
						imageSize = {
							width: Math.floor(imageSize.width),
							height: Math.round(me.fullSize.height / factor)
						};

						canvasSize = {
							width: (me.invert ? imageSize.height : imageSize.width),
							height: (me.invert ? imageSize.width : imageSize.height)
						};

						canvas.css(canvasSize);
						dragHandle.css(canvasSize);
						me.selectMode(canvasSize, true);
						me.setImageSize(canvasSize);
						if(me.mode === 'small' || me.mode === 'vertical') {
							me.centerImage(false);
						}

						$('#uimage-drag-handle').draggable('option', 'containment', me.getContainment());
					}
				})
				.draggable({
					opacity:1,
					start: function(){
						//Prevent editor closing during cropping. It is set to false by the initialize method.
						me.isDragged = true;
					},
					drag: function(e, ui){
						canvas.css({
							top: ui.position.top,
							left: ui.position.left
						});
					},
					stop: function(e, ui){
						canvas.css({
							top: ui.position.top,
							left: ui.position.left
						});
						me.setResizingLimits();
					},
					containment: me.getContainment()
				})
			;
			me.setResizingLimits();

		},

		addGridLines: function(initialPoint, maskHeight){
			var step = breakpointColumnPadding,
				height = maskHeight - this.bordersWidth,
				current = this.bordersWidth / 2
			;

			while(current <= height + step){
				this.$el.append('<div class="gridline" style="position: absolute;width: 100%; height: 0; top:' + (initialPoint + current) + 'px"></div>');
				current = current + step;
			}
		},

		selectMode: function(size, constraints) {
			var mode = 'small',
				mask = this.$('#uimage-mask'),
				maskSize = {
					width: mask.width(),
					height: mask.height()
				}
			;

			if(size.width >= maskSize.width){
				if(size.height >= maskSize.height) {
					mode = 'big';
				} else {
					mode = 'horizontal';
				}
			} else if(size.height >= maskSize.height) {
				mode = 'vertical';
			}

			this.setMode(mode, constraints);
		},

		setMode: function(mode, constraints){
			var editor = $('#uimage-drag-handle'),
				centerImage = (mode === 'small' || mode === 'vertical') && mode !== this.mode
			;
			this.$el
				.removeClass('uimage-mode-big uimage-mode-small uimage-mode-vertical uimage-mode-horizontal uimage-mode-tiny')
				.addClass('uimage-mode-' + mode)
			;
			if(editor.width() < 40 || editor.height() < 40) {
				this.$el.addClass('uimage-mode-tiny');
			}

			this.mode = mode;
			if(constraints){
				if(this.mode === 'horizontal' || this.mode === 'small') {
					editor.draggable('option', {snap: '.gridline', snapMode: 'outer', snapTolerance: 6});
				} else {
					editor.draggable('option', {snap: false});
				}
			}

			if(centerImage){
				this.centerImage(false);
			}

		},

		setImageSize: function(size){
			if(this.invert){
				var invertSize = {
					width: size.height,
					height: size.width
				};

				this.$('.uimage-img')
					.css(invertSize)
					.css(this.imgOffset(invertSize))
				;
			}
		},

		getContainment: function(){
			var canvas = this.$('#uimage-canvas'),
				mask = this.$('#uimage-mask'),
				initPoint = mask.offset(),
				halfBorder = this.bordersWidth / 2
			;


			if(this.mode === 'big'){
				return [
					initPoint.left - canvas.width() + mask.width() + halfBorder,
					initPoint.top - canvas.height() + mask.height() + halfBorder,
					initPoint.left + halfBorder,
					initPoint.top + halfBorder
				];
			}
			if(this.mode === 'horizontal') {
				return [
					initPoint.left - canvas.width() + mask.width() + halfBorder,
					initPoint.top,
					initPoint.left + halfBorder,
					initPoint.top - canvas.height() + mask.height()
				];
			}

			var left = this.align === 'left' ? initPoint.left: (this.align === 'right' ? initPoint.left + mask.width() - canvas.width() : initPoint.left + (mask.width() - canvas.width()) / 2);
			left += halfBorder;

			if(this.mode === 'vertical') {
				return [
					left,
					initPoint.top - canvas.height() + mask.height() + halfBorder,
					left,
					initPoint.top + halfBorder
				];
			}

			return [
				left,
				initPoint.top,
				left,
				initPoint.top - canvas.height() + mask.height()
			];
		},

		setResizingLimits: function() {
			var canvas = this.$('#uimage-canvas'),
				mask = this.$('#uimage-mask'),
				initPoint = mask.offset(),
				limits = {
					minWidth: breakpointColumnPadding,
					minHeight: breakpointColumnPadding
				}
			;
			if(this.mode === 'big'){
				limits = {
					minWidth: mask.width() + initPoint.left - canvas.offset().left + this.bordersWidth,
					minHeight: mask.height() + initPoint.top - canvas.offset().top + this.bordersWidth
				};
			}

			$('#uimage-drag-handle').resizable('option', limits);
		},

		resetImage: function(e, alert){
			if(e){
				e.preventDefault();
				e.stopPropagation();
			}
			this.setRotation(270);
			this.rotate(); //Set rotation to 0
			this.setImageFullSize(e, alert);
			this.centerImage(true);
		},

		image100: function(e){
			if($(e.target).hasClass('deactivated')){
				if($(e.target).hasClass('expanded')) {
					return;
				}
				return this.showExpandAlert();
			}

			var fullGrid = this.getFullWidthImage().size,
				current = this.getCurrentImageRowsCols(fullGrid.width, fullGrid.height),
				maskSize = current
			;

			if(this.elementSize.maxColumns < current.columns){
				var maskHeight = fullGrid.height;
				maskSize = {columns: this.elementSize.maxColumns, rows: Math.ceil(maskHeight / this.elementSize.rowHeight) + 2};
			}

			// Don't allow changing width mask size anymore
			maskSize.columns = this.elementSize.maxColumns;

			if(maskSize.columns !== this.elementSize.columns || maskSize.rows !== this.elementSize.rows) {
				this.resizeMask(maskSize.columns, maskSize.rows);
			} else{
				var maskOffset = this.$('#uimage-mask').offset();
				fullGrid.top = maskOffset.top;
				fullGrid.left = maskOffset.left;
				this.$('#uimage-canvas').css(fullGrid);
				this.$('#uimage-drag-handle').css(fullGrid);
			}

			if(maskSize.columns !== 22 && current.columns > maskSize.columns) {
				this.showExpandAlert();
			}
		},

		getCurrentImageRowsCols: function(width, height){
			var img = this.$('#uimage-canvas'),
				imgWidth = width ? width : img.width(),
				imgHeight = height ? height : img.height()
			;

			return {
				rows: Math.ceil(imgHeight / this.elementSize.rowHeight) + 2,
				columns: Math.ceil((imgWidth + (2 * breakpointColumnPadding))/ this.elementSize.columnWidth)
			};
		},

		getCurrentMaskRowsCols: function(){
			var mask = this.$('#uimage-mask');
			return this.getCurrentImageRowsCols(mask.width(), mask.height());
		},

		showExpandAlert: function(){
			if(this.ignoreFullwidthAlert) {
				return;
			}
			var me = this;
			Upfront.Popup.open(function(){}, {width: 320}, 'warning_img')
				.progress(function(progress){
					if(progress === 'before_close') {
						me.ignoreFullwidthAlert = $('#upfront-popup-content').find('input:checked').length;
					}
				})
			;

			$('#upfront-popup-content')
				.append(_.template($(editorTpl).find('#fullwidth-alert-tpl').html(), {l10n: l10n.template}));
		},

		resizeMask: function(columns, rows){
			var options = this.options;

			options.maskSize = {
				width: this.elementSize.columnWidth * columns - (2 * breakpointColumnPadding),
				height: this.elementSize.rowHeight * (rows - 2)
			};

			options.size = this.getFullWidthImage().size;
			options.position = {left: 0, top: 0};
			options.setImageSize = false;
			options.resizedElement = true;

			this.open(options);
		},

		fitImage: function(e){
			e.preventDefault();
			e.stopPropagation();

			if(!this.fitImageButton){
				var button = $('#image-edit-button-fit');
				button.text(l10n.btn.fit_element);
				this.fitImageButton = true;

				return this.resetImage();
			}

			var canvas = this.$('#uimage-canvas'),
				mask = this.$('#uimage-mask'),
				handler = this.$('#uimage-drag-handle'),
				size = this.getResizeImageDimensions(this.fullSize, {width: mask.width(), height: mask.height()}, 'inner', 0)
			;

			if(this.invert){
				size = {
					width: size.height,
					height: size.width
				};
			}

			canvas.css(size);
			handler.css(size);

			this.setImageSize(size);
			this.centerImage(true);

			this.selectMode(size, true);

			this.centerImage(true);

			this.setResizingLimits();
			$('#uimage-drag-handle').draggable('option', 'containment', this.getContainment());

			$('#image-edit-button-fit')
				.attr('title', l10n.btn.restore_label)
				.text(l10n.btn.restore_info)
			;
			$('#image-edit-button-reset')
				.attr('class', 'image-edit-button')
				.attr('title', l10n.btn.exp_info)
			;
			this.fitImageButton = false;

		},

		//TODO: remove this. This method is deprecated, since the fit mask button is not used anymore
		fitMask: function(){
			var canvas = $('#uimage-canvas'),
				mask = $('#uimage-mask'),
				columnWidth = Math.round((mask.width() + (2 * breakpointColumnPadding)) / this.options.fitMaskColumns),
				canvasSize = {width: canvas.width(), height: canvas.height()},
				rowHeight = breakpointColumnPadding,
				elementColumns = Math.ceil((canvasSize.width + (2 * breakpointColumnPadding)) / columnWidth),
				maskNewSize = {
					height: Math.ceil(canvasSize.height / rowHeight) * rowHeight,
					width: elementColumns * columnWidth - (2 * breakpointColumnPadding)
				},
				optionsNew = this.options
			;

			optionsNew.position = {top: 0, left: 0};
			optionsNew.size = canvasSize;
			optionsNew.maskSize = maskNewSize;
			optionsNew.align = 'left';
			optionsNew.setImageSize = false;
			optionsNew.rotation = this.rotation;
			optionsNew.elementColumns = elementColumns;

			this.open(optionsNew);

		},

		setImageFullSize: function(e) {
			if(e) {
				e.preventDefault();
			}

			var img = this.$('.uimage-img'),
				mask = this.$('#uimage-mask'),
				canvas = this.$('#uimage-canvas'),
				handle = this.$('#uimage-drag-handle'),
				size = this.initialImageSize(100, false, {width: mask.width(), height: mask.height()})
			;

			canvas.css(size);
			handle.css(size);

			img.css({
				height: '100%',
				width: '100%'
			});

			this.selectMode(size, true);

			this.setResizingLimits();
			$('#uimage-drag-handle').draggable('option', 'containment', this.getContainment());
		},

		centerImage: function(vertical) {
			var canvas = this.$('#uimage-canvas'),
				mask = this.$('#uimage-mask'),
				handle = this.$('#uimage-drag-handle'),
				border = this.bordersWidth / 2,
				position = {
					top: canvas.offset().top
				}
			;
			if(vertical) {
				position.top = mask.offset().top - ((canvas.height() - mask.height()) / 2) + border;
			}

			if((this.mode !== 'vertical' && this.mode !== 'small') || this.align === 'center') {
				position.left = mask.offset().left - ((canvas.width() -  mask.width()) / 2);
			} else if(this.align === 'left') {
				position.left = mask.offset().left;
			} else {
				position.left = mask.offset().left + mask.width() - canvas.width();
			}

			position.left += border;

			canvas.css(position);
			handle.css(position);
		},

		getFullWidthImage: function(fullSize) {
			var grid = $(document.querySelector('.upfront-grid-layout')),
				gridWidth = grid.width() - (2 * breakpointColumnPadding),
				size = fullSize || this.fullSize
			;

			if(size.width > gridWidth) {
				size = {width: gridWidth, height: Math.round(size.height / (size.width / gridWidth))};
			}


			return {
				size: size,
				left: grid.offset().left + breakpointColumnPadding
			};
		},

		initialImageSize: function(overflow, stretch, maskDimensions) {
			var mask = this.$('#uimage-mask'),
				size = {
					width: 0,
					height: 0
				},
				maskSize = maskDimensions ? maskDimensions : {
					width: mask.width(),
					height: mask.height()
				},
				pivot, factor, invertPivot,
				stretchImage = !!stretch
			;

			//prevent strange behaviors
			overflow = overflow ? overflow : 0;

			//this.fullSize = this.getImageFullSize();

			pivot = maskSize.width / maskSize.height < this.fullSize.width / this.fullSize.height ? 'height' : 'width';
			invertPivot = this.invert ? (pivot === 'width' ? 'height' : 'width') : pivot;

			factor = this.fullSize[pivot] / (maskSize[invertPivot] + overflow);

			if(!stretchImage && factor < 1) {
				size = this.fullSize;
			} else {
				size = {
					width: Math.ceil(this.fullSize.width / factor),
					height: Math.ceil(this.fullSize.height / factor)
				};
			}

			return size;
		},

		getResizeImageDimensions: function(imageDim, wrapperDim, fittingType, overflow){
			var imageFactor = imageDim.width / imageDim.height,
				wrapperFactor = wrapperDim.width / wrapperDim.height,
				type = fittingType && fittingType === 'outer' ? 'outer' : 'inner',
				pivot = type === 'inner'  ? (imageFactor > wrapperFactor ? 'width' : 'height') : (imageFactor > wrapperFactor ? 'height' : 'width'),
				padding = overflow || 0,
				targetDim = wrapperDim[pivot] + padding
			;
	/*
			if(imageDim[pivot] <= targetDim)
				return imageDim;
	*/
			var factor = targetDim / imageDim[pivot];

			return {width: Math.round(imageDim.width * factor), height: Math.round(imageDim.height * factor)};
		},

		getImageData: function(ids, customImageSize, element_id) {
			var options = {
					action: 'upfront-media-image_sizes',
					item_id: JSON.stringify(ids),
					element_id: element_id
				};

			if(customImageSize) {
				options.customSize = customImageSize;
			}

			return Upfront.Util.post(options);
		},

		saveImageEdition: function(imageId, rotate, resize, crop){
			var opts = {
					action: 'upfront-media-image-create-size',
					images: [{
						element_id: this.element_id,
						id: imageId,
						rotate: rotate,
						resize: resize,
						crop: crop
					}]
				}
			;

			return Upfront.Util.post(opts);
		},
		selectAlign: function(){
			if(this.align === 'left') {
				this.setAlign('center');
			} else if(this.align === 'center') {
				this.setAlign('right');
			} else if(this.align === 'right') {
				this.setAlign('left');
			}
		},

		setAlign: function(direction){
			var mask = this.$('#uimage-mask'),
				canvas = this.$('#uimage-canvas'),
				handle = this.$('#uimage-drag-handle'),
				position = canvas.position()
			;

			this.$('#image-edit-button-align').removeClass('align-left align-right align-center').addClass('align-' + direction);

			if(direction !== 'left' && direction !== 'center' && direction !== 'right') {
				return false;
			}
			this.align = direction;

			if(this.align === 'center') {
				position.left = mask.offset().left - ((canvas.width() -  mask.width()) / 2);
			} else if(this.align === 'left') {
				position.left = mask.offset().left;
			} else {
				position.left = mask.offset().left + mask.width() - canvas.width();
			}

			position.left += this.bordersWidth / 2;

			canvas.css(position);
			handle.css(position);

			this.$('#uimage-drag-handle').draggable('option', 'containment', this.getContainment());
		},

		keyMove: function(e) {
			switch(e.which){
				case 40: //down
					this.maskOffset.top--;
					this.positionEditorElements();
					break;
				case 39: //right
					this.maskOffset.left--;
					this.positionEditorElements();
					break;
				case 37: //left
					this.maskOffset.left++;
					this.positionEditorElements();
					break;
				case 38: //up
					this.maskOffset.top++;
					this.positionEditorElements();
			}
		},

		fixImageTop: function(offset){
			if(offset && typeof offset.top !== 'undefined'){
				if(offset.top < 120){
					var margin = $('body').css('marginTop');
					margin = parseInt(margin.replace('px', ''), 10);
					if(!isNaN(margin)){
						this.fixTop = 120 - offset.top;
						$('body').css(('marginTop'), margin + this.fixTop);
						return this.fixTop;
					}
				}
			}
			return 0;
		},

		unfixImageTop: function(){
			if(this.fixTop){
				var margin = $('body').css('marginTop');
				margin = parseInt(margin.replace('px', ''), 10);
				if(!isNaN(margin)){
					$('body').css(('marginTop'), margin - this.fixTop);
				}
				this.fixTop = 0;
			}
		}
	});

	return ImageEditor;
});
})(jQuery);

define('elements/upfront-image/js/model',[],function() {
	var Model = Upfront.Models.ObjectModel.extend({
		init: function () {
			var properties = _.clone(Upfront.data.uimage.defaults);
			properties.element_id = Upfront.Util.get_unique_id(properties.id_slug);
			/**
			 * Init with caption in p block so that block level formatting will work for the caption without any issues
			 * @type {string}
             */
			properties.image_caption = "<p>$s</p>".replace("$s", properties.image_caption);
			this.init_properties(properties);
		}
	});

	return Model;
});

define('elements/upfront-image/js/image-element',[
	'elements/upfront-image/js/model'
], function(ImageModel) {
	var l10n = Upfront.Settings.l10n.image_element;

	var ImageElement = Upfront.Views.Editor.Sidebar.Element.extend({
		priority: 20,
		render: function () {
			this.$el.addClass('upfront-icon-element upfront-icon-element-image');
			this.$el.html(l10n.element_name);
		},
		add_element: function () {
			var object = new ImageModel(),
				module = new Upfront.Models.Module({
					'name': '',
					'properties': [
						{'name': 'element_id', 'value': Upfront.Util.get_unique_id('module')},
						{'name': 'class', 'value': 'c24 upfront-image_module'},
						{'name': 'has_settings', 'value': 0},
						{'name': 'row', 'value': Upfront.Util.height_to_row(255)}
					],
					'objects': [
						object
					]
				})
			;
			this.add_module(module);
		}
	});

	return ImageElement;
});

(function ($) {
define('uimage',[
	'text!elements/upfront-image/tpl/image.html',
	'text!elements/upfront-image/tpl/image_editor.html',
	'elements/upfront-image/js/image-context-menu',
	'elements/upfront-image/js/image-settings',
	'elements/upfront-image/js/image-selector',
	'elements/upfront-image/js/image-editor',
	'elements/upfront-image/js/image-element',
	"scripts/upfront/link-model",
	'elements/upfront-image/js/model',
	'text!elements/upfront-image/tpl/preset-style.html',
	'scripts/upfront/preset-settings/util'
], function(imageTpl, editorTpl, ImageContextMenu, ImageSettings, ImageSelector, ImageEditor, ImageElement, LinkModel, UimageModel, settingsStyleTpl, PresetUtil) {

	var l10n = Upfront.Settings.l10n.image_element;
	var breakpointColumnPadding = Upfront.Views.breakpoints_storage.get_breakpoints().get_active().get('column_padding');
	breakpointColumnPadding = parseInt(breakpointColumnPadding, 10);
	breakpointColumnPadding = _.isNaN(breakpointColumnPadding) ? 15 : breakpointColumnPadding;

	var UimageView = Upfront.Views.ObjectView.extend({
		model: UimageModel,
		imageTpl: Upfront.Util.template(imageTpl),
		sizehintTpl: _.template($(editorTpl).find('#sizehint-tpl').html()),
		cropTimeAfterResize: 1,// making this longer makes image resize not save

		// Disable size hint as image element already has it's own
		display_size_hint: false,

		// Property used to speed resizing up;
		resizingData: {},

		initialize: function() {
			var me = this;
			this.setDefaults();

			if(! (this.model instanceof UimageModel)){
				this.model = new UimageModel({properties: this.model.get('properties')});
			}
			this.events = _.extend({}, this.events, {
				'click a.upfront-image-select': 'openImageSelector',
				'click div.upfront-quick-swap': 'openImageSelector',
				'dblclick .wp-caption': 'editCaption',
				'click a': 'handleLinkClick',
				'click .swap-image-overlay': 'openImageSelector'
			});
			this.delegateEvents();

			this.bodyEventHandlers = {
				dragover: function(e){
					e.preventDefault();
					me.handleDragEnter(e);
				},
				dragenter: function(e){
					me.handleDragEnter(e);
				},
				dragleave: function(e){
					me.handleDragLeave(e);
				}
			};

			$('body').on('dragover', this.bodyEventHandlers.dragover)
				.on('dragenter', this.bodyEventHandlers.dragenter)
				.on('dragleave', this.bodyEventHandlers.dragleave)
				.on('drop', this.bodyEventHandlers.drop)
			;

			// Set the full size current size if we don't have attachment id
			if (!this.property('image_id')) {
				this.property('srcFull', this.property('src'));
			}

			this.listenTo(this.model.get('properties'), 'change', this.update);
			this.listenTo(this.model.get('properties'), 'add', this.update);
			this.listenTo(this.model.get('properties'), 'remove', this.update);

			this.listenTo(this.model, 'uimage:edit', this.editRequest);

			//this.controls = this.createControls();

			if(this.property('image_status') !== 'ok' || this.property('quick_swap') || (this.isThemeImage() && !Upfront.themeExporter)) {
				this.property('has_settings', 0);
			}
			else {
				this.property('has_settings', 1);
			}

			this.listenTo(Upfront.Events, 'upfront:element:edit:start', this.on_element_edit_start);
			this.listenTo(Upfront.Events, 'upfront:element:edit:stop', this.on_element_edit_stop);

			this.listenTo(Upfront.Events, 'command:layout:save', this.saveResizing);
			this.listenTo(Upfront.Events, 'command:layout:save_as', this.saveResizing);

			this.listenTo(Upfront.Events, 'upfront:layout_size:change_breakpoint', function(newMode){
				if(newMode.id !== 'desktop') {
					this.setMobileMode();
				} else {
					this.unsetMobileMode();
				}
			});

			if (this.property('link') === false) {
				this.link = new LinkModel({
					type: this.property('when_clicked'),
					url: this.property('image_link'),
					target: this.property('link_target'),
				});
				this.property('link', this.link.toJSON());
			} else {
				this.link = new LinkModel(this.property('link'));
			}

			me.listenTo(this.link, 'change', function() {
				me.property('link', me.link.toJSON());
			});

			this.listenTo(Upfront.Events, 'entity:module:update', this.on_uimage_update);
			this.listenTo(this.model, "preset:updated", this.preset_updated);
		},

		get_preset_properties: function() {
			var preset = this.model.get_property_value_by_name("preset"),
				props = PresetUtil.getPresetProperties('image', preset) || {};

			return props;
		},

		get_preset_property: function(prop_name) {
			var preset = this.model.get_property_value_by_name("preset"),
				props = PresetUtil.getPresetProperties('image', preset) || {};

			return props[prop_name];
		},
		preset_updated: function() {
			this.render();
		},

		update_colors: function () {

			var props = this.get_preset_properties();

			if (_.size(props) <= 0) return false; // No properties, carry on

			PresetUtil.updatePresetStyle('gallery', props, settingsStyleTpl);

		},

		setDefaults: function(){
			this.sizes = false;
			this.elementSize = {width: 0, height: 0};
			this.imageId = 0;
			this.imageSize = {width: 0, height: 0};
			this.imageOffset = {top: 0, left: 0};
			this.maskOffset = {top: 0, left: 0};
			this.imageInfo  = false;
			this.controls = false;
			this.editor = false;

			//Temporary props for element resizing and cropping
			this.temporaryProps = {
				size: false,
				position: false
			};
			this.cropTimer = false;
			this.stoppedTimer  = false;
		},

		getSelectedAlignment: function(){
			if(!this.property('include_image_caption') && this.get_preset_property("caption-position") === false && this.property('caption_alignment') === false) {
				return 'nocaption';
			}
			if(this.get_preset_property("caption-position") === 'below_image') {
				return 'below';
			}

			var align = this.property('caption_alignment');

			switch(align){
				case 'top':
					return 'topOver';
				case 'bottom':
					return 'bottomOver';
				case 'fill':
					return 'topCover';
				case 'fill_middle':
					return 'middleCover';
				case 'fill_bottom':
					return 'bottomCover';
			}

			return 'nocaption';
		},

		isThemeImage: function() {
			return this.property('srcFull') && this.property('srcFull').match('wp-content/themes/');
		},

		replaceImage: function() {
			this.openImageSelector();
		},

		createLinkControl: function(){
			var me = this,
				control = new Upfront.Views.Editor.InlinePanels.DialogControl(),
				linkPanel;

			control.view = linkPanel = new Upfront.Views.Editor.LinkPanel({
				model: this.link,
				linkTypes: { image: true },
				imageUrl: this.property('srcFull')
			});

			this.listenTo(control, 'panel:ok', function() {
				if(linkPanel.model.get('type') == 'lightbox' && linkPanel.$el.find('.js-ulinkpanel-lightbox-input').val() != '') {
					linkPanel.createLightBox();
				}
				control.close();
				this.render();
			});

			this.listenTo(control, 'panel:open', function() {
				me.$el.closest('.ui-draggable').draggable('disable');
				_.delay( function() {
					me.controls.$el.parent().parent().addClass('upfront-control-visible');
				}, 1000);
			});

			me.listenTo(control, 'panel:close', function(){
				me.controls.$el.parent().parent().removeClass('upfront-control-visible');
				me.$el.closest('.ui-draggable').draggable('enable');
			});

			control.icon = 'link';
			control.tooltip = l10n.ctrl.image_link;
			control.id = 'link';

			return control;
		},

		postTypes: function(){
			var types = [];
			_.each(Upfront.data.ugallery.postTypes, function(type){
				if(type.name !== 'attachment') {
					types.push({name: type.name, label: type.label});
				}
			});
			return types;
		},

		editCaption: function(){
			var me = this,
				captionEl = $('#' + this.property('element_id')).find('.wp-caption')
			;


			if(captionEl.find('.uimage-caption-cover').length) {
				captionEl = captionEl.find('.uimage-caption-cover');
			}

			if(captionEl.data('ueditor') || ! captionEl.length) { //Already instantiated
				return;
			}

			captionEl.ueditor({
					autostart: false,
					focus: false,
					upfrontMedia: false,
					upfrontImages: false,
					linebreaks: false,
					airButtons: ['upfrontFormatting', 'bold', 'italic', 'stateAlign', 'upfrontLink', 'upfrontColor', 'upfrontIcons']
				})
				.on('start', function(){
					me.$el.addClass('upfront-editing');
				})
				.on('stop', function(){
					me.$el.removeClass('upfront-editing');
					me.render();
				})
				.on('syncAfter', function(){
					me.property('image_caption', captionEl.html());
				})
			;
		},

		createControl: function(icon, tooltip, click){
			var me = this,
				item = new Upfront.Views.Editor.InlinePanels.Control();
			item.icon = icon;
			item.tooltip = tooltip;
			if(click){
				this.listenTo(item, 'click', function(e){
					me[click](e);
				});
			}

			return item;
		},

		setImageInfo: function(){
			var maskSize, maskOffset,
				starting = this.$('.upfront-image-starting-select'),
				size = this.temporaryProps.size, //this.property('size'),
				position = this.temporaryProps.position, //this.property('position'),
				captionHeight = this.get_preset_property("caption-position") === 'below_image' ? this.$('.wp-caption').outerHeight() : 0
			;

			if (starting.length) {
				maskSize = {
					width: starting.outerWidth(),
					height: starting.outerHeight()
				};
				maskOffset = starting.offset();
				position = false;
			} else {
				starting = this.$('.uimage');
				maskSize = {
					width: starting.width(),
					height: starting.height() - captionHeight
				};
				maskOffset = {
					top: starting.offset().top,
					left: starting.offset().left
				};
			}
	/*
			//Fix for responsive images
			if(img.length){
				size = {
					width: img.width(),
					height: img.height()
				},
				position = {
					top: -img.position().top,
					left: -img.position().left
				}

			}
	*/
			this.imageInfo = {
				id: this.property('image_id'),
				src: this.property('src'),
				srcFull: this.property('srcFull'),
				srcOriginal: this.property('srcOriginal'),
				size: size,
				position: position,
				rotation: this.property('rotation'),
				fullSize: this.property('fullSize'),
				align: this.property('align'),
				maskSize: maskSize,
				maskOffset: maskOffset
			};

		},

		isSmallImage: function() {
			var elementSize = this.property('element_size');
			if (this.resizingData.data && this.resizingData.data.elementSize) {
				elementSize = this.resizingData.data.elementSize;
			}
			return elementSize.width < 100 || elementSize.height < 50;
		},

		disableCaption: function() {
			this.property('include_image_caption', false);
		},

		enableCaption: function() {
			this.property('include_image_caption', true);
		},

		hasCaptionPosition: function() {
			return this.get_preset_property("caption-position") !== false || this.property('caption_alignment') !== false;
		},

		setupBySize: function() {
			if (this.isSmallImage()) {
				this.disableCaption();
				this.parent_module_view.$el.addClass('uimage-small');
			} else if(this.hasCaptionPosition()) {
				this.enableCaption();
			}

			if (!this.isSmallImage()) {
				this.parent_module_view.$el.removeClass('uimage-small');
			}
		},

		get_content_markup: function () {
			var elementSize = this.property('element_size'),
				me = this,
				props = this.extract_properties(),
				rendered,
				smallSwap,
				render,
				size,
				img;

			this.setupBySize();

			if(!this.temporaryProps || !this.temporaryProps.size) {
				this.temporaryProps = {
					size: props.size,
					position: props.position
				};
			}

			props = this.extract_properties();

			props.properties = this.get_preset_properties();

			props.url = this.property('when_clicked') ? this.property('image_link') : false;
			props.url = this.link.get('type') !== 'unlink' ? this.link.get('url') : false;
			props.link_target = this.link.get('target');
			props.size = this.temporaryProps.size;
			props.position = this.temporaryProps.position;
			props.marginTop = Math.max(0, -props.position.top);

			props.in_editor = true;

			props.cover_caption = this.get_preset_property("caption-position") !== 'below_image';

			if(props.stretch) {
				props.imgWidth = '100%';
			} else {
				props.imgWidth = props.size.width + 'px';
			}

			props.containerWidth = Math.min(props.size.width, elementSize.width);

			props.display_caption = this.property('display_caption') ? this.property('display_caption') : 'showCaption';

			//Gif image handled as normal ones in the backend
			props.gifImage = '';
			props.gifLeft = 0;
			props.gifTop = 0;

			/* Commented to allow caption below image to have background
			if (props.caption_position === 'below_image') {
				props.captionBackground = false;
			}
			*/

			props.l10n = l10n.template;

			props.usingNewAppearance = props.usingNewAppearance || false;

			if (props.usingNewAppearance === false && props.image_caption === '<p>My awesome image caption</p>') {
				props.include_image_caption = false;
			}

			rendered = this.imageTpl(props);

			if (this.property('quick_swap')) {
				smallSwap = props.element_size.width < 150 || props.element_size.height < 90 ? 'uimage-quick-swap-small' : '';

				rendered += '<div class="upfront-quick-swap ' + smallSwap + '"><p>Change this image</p></div>';
			} else if (this.property('image_status') === 'starting') {
				rendered = '<div class="upfront-image-starting-select upfront-ui" style="height:' + props.element_size.height + 'px"><div class="uimage-centered">' +
						'<span class="upfront-image-resizethiselement">' + l10n.ctrl.add_image + '</span><div class=""><a class="upfront-image-select" href="#" title="' + l10n.ctrl.add_image + '">+</a></div>'+
				'</div></div>';
			} else {
				render = $('<div></div>').append(rendered);
				size = props.size;
				img = render.find('img');
				props = this.temporaryProps;

				var newElementSize = this.update_style();

				if(newElementSize) {
					elementSize = newElementSize;
					size = this.temporaryProps.size;
				}

				// Let's load the full image to improve resizing
				render.find('.upfront-image-container').css({
					overflow: 'hidden',
					position: 'relative',
					width: Math.min(elementSize.width, size.width),
					height: Math.min(elementSize.height, size.height)
				});

				img.attr('src', me.property('srcFull'))
					.css({
						width: size.width,
						height: size.height,
						position: 'absolute',
						top: Math.min(0, -props.position.top),
						left: Math.min(0, -props.position.left),
						'margin-top': 0,
						'max-height': 'none',
						'max-width': 'none'
					})
				;

				rendered = render.html();
			}

			return rendered;
		},
		toggle_caption_controls: function(){
			var me = this,
				panel = new Upfront.Views.Editor.InlinePanels.Panel()
				;

			panel.items = this.getControlItems();
			panel.render();
			_.delay( function(){
				me.controls.$el.html( panel.$el )
			}, 400);
		},
		getElementShapeSize: function (elementSize) {
			var $container = this.$el.find('.upfront-image-container'),
				props = this.get_preset_properties(),
				newSize = {};

			if (props.imagestyle === "square") {
				newSize.height = elementSize.width;
				newSize.width = elementSize.width;

				if (elementSize.width !== elementSize.height) {
					// Keep old height in case style switches to default
					newSize.defaultHeight = elementSize.height;
				} else if (elementSize.defaultHeight) {
					newSize.defaultHeight = elementSize.defaultHeight;
				}

				return newSize;
			} else {
				if (elementSize.defaultHeight) {
					newSize = {
						width: elementSize.width,
						height: elementSize.defaultHeight
					};
					return newSize;
				}
			}

			return false;
		},

		update_style: function() {
			var elementSize = this.property('element_size'),
				newSize = this.getElementShapeSize(elementSize)
			;

			if ( false !== newSize ) {
				if ( elementSize.width != newSize.width || elementSize.height != newSize.height ) {
					if ( ! this.resizeImage(newSize) ) {
						// Can't resize? At least set the element_size
						this.property('element_size', newSize);
					}
				}
				return newSize;
			}

			return false;
		},

		on_render: function() {
			var me = this,
				onTop = ['bottom', 'fill_bottom'].indexOf(this.property('caption_alignment')) !== -1 || this.get_preset_property("caption-position") === 'below_image' ? ' sizehint-top' : '',
				elementSize = this.property('element_size');

			//Bind resizing events
			if (!this.parent_module_view.$el.data('resizeHandling')) {
				this.parent_module_view.$el
					//.on('resizestart', $.proxy(this.onElementResizeStart, this))
					//.on('resize', $.proxy(this.onElementResizing, this))
					//.on('resizestop', $.proxy(this.onElementResizeStop, this))
					.data('resizeHandling', true);
			}

			if(this.property('when_clicked') === 'lightbox') {
				this.$('a').addClass('js-uimage-open-lightbox');
			}

			var newElementSize = this.update_style();

			if(newElementSize) {
				elementSize = newElementSize;
			}

			if (this.isThemeImage() && !Upfront.themeExporter) {
				this.$el.addClass('image-from-theme');
				this.$el.find('b.upfront-entity_meta').after('<div class="swap-image-overlay"><p class="upfront-icon upfront-icon-swap-image"><span>Click to </span>Swap Image</p></div>');
			} else {
				var resizeHint = $('<div>').addClass('upfront-ui uimage-resize-hint' + onTop);
				this.$el.append(resizeHint);
				// this.applyElementSize(elementSize.width, elementSize.height)
				setTimeout( function () {
					me.applyElementSize();
				}, 300 );
			}

			if(this.property('image_status') !== 'ok') {
				var starting = this.$('.upfront-image-starting-select');
				if(!this.elementSize.height){
					this.setElementSize();
					starting.height(this.elementSize.height);
				}
				return;
			}

			if (this.property('quick_swap')) { // Do not show image controls for swappable images.
				return false;
			}

			setTimeout(function() {
				me.updateControls();
				me.$el.removeClass('upfront-editing');

				me.editCaption();
			}, 300);

			// Show full image if we are in mobile mode
			if (this.mobileMode) {
				this.$('.uimage').addClass('uimage-mobile-mode');
				this.setMobileMode();
			}

			this.setStuckToTop();

			setTimeout( function() {
				me.$el.closest('.ui-draggable').on('dragstop', function() {
					setTimeout(function() {
						me.setStuckToTop();
					}, 10);
				});

				me.$el.closest('.upfront-module-view').addClass('uimage-upfront-module-view');
			}, 100);

			setTimeout(function() {
				me.toggleResizableHandles();
			}, 100);

			this.toggle_caption_controls();
		},

		toggleResizableHandles: function() {
			var container = this.$el.parents('.upfront-objects_container');
			if (this.isThemeImage() && !Upfront.themeExporter) {
				container.siblings('.ui-resizable-handle').addClass('ui-resizable-handle-hidden');
			} else {
				container.siblings('.ui-resizable-handle').removeClass('ui-resizable-handle-hidden');
			}
		},

		setStuckToTop: function() {
			if (this.$el.offset().top + this.parent_module_view.$el.offset().top < 25) {
				this.$el.addClass('stuck-to-top');
			} else {
				this.$el.removeClass('stuck-to-top');
			}
		},

		updateControls: function() {
			var elementControlsTpl = '<div class="upfront-element-controls upfront-ui"></div>';

			if(this.paddingControl && typeof this.paddingControl.isOpen !== 'undefined' && this.paddingControl.isOpen)	return;

			// if (!this.controls) {
				this.controls = this.createControls(); // It seems to be needed for image only so caption item shows up when it should
			// }

			if (this.controls === false) return;

			this.controls.render();
			if (!this.$control_el || this.$control_el.length === 0) {
				this.$control_el = this.$el;
			}
			if (this.$control_el.find('>.upfront-element-controls').length === 0) {
				this.$control_el.append(elementControlsTpl);
				// this.$control_el.find('>.upfront-element-controls').html('').append(this.controls.$el);
			}
			this.$control_el.find('>.upfront-element-controls').html('').append(this.controls.$el); // we need to refresh controls because caption item has to be activated or deactivate depending on the `show caption`
			this.controls.delegateEvents();
		},


		on_edit: function(){
			return false;
		},

		extract_properties: function() {
			var props = {};
			this.model.get('properties').each(function(prop){
				props[prop.get('name')] = prop.get('value');
			});
			props.preset = props.preset || 'default';
			return props;
		},

		handleDragEnter: function(){
			var me = this;
			// todo Sam: re-enable this and start bug fixing
			return; // disabled for now
			if(!this.$('.uimage-drop-hint').length){
				var dropOverlay = $('<div class="uimage-drop-hint"><div>' + l10n.drop_image + '</div></div>')
					.on('drop', function(e){
						e.preventDefault();
						e.stopPropagation();
						me.openImageSelector();
						$('.uimage-drop-hint').remove();
						if(e.originalEvent.dataTransfer){
							var files = e.originalEvent.dataTransfer.files;
							// Only call the handler if 1 or more files was dropped.
							if (files.length){
								Upfront.Views.Editor.ImageSelector.uploadImage(files);
										}
								}
					})
					.on('dragenter', function(e){
						e.preventDefault();
						e.stopPropagation();
						$(this).addClass('uimage-dragenter');
					})
					.on('dragleave', function(e){
						e.preventDefault();
						e.stopPropagation();
						$(this).removeClass('uimage-dragenter');
						$(this).removeClass('uimage-drageover');
					}).on('dragover', function (e) {
											e.preventDefault();
											$(this).addClass('uimage-drageover');
									})
				;
				this.$('.upfront-image').append(dropOverlay);
			}
			if(this.dragTimer){
				clearTimeout(this.dragTimer);
				this.dragTimer = false;
			}
		},

		handleDragLeave: function(){
			var me = this;
			this.dragTimer = setTimeout(function(){
					me.$('.uimage-drop-hint').remove();
					this.dragTimer = false;
				}, 200)
			;
		},

		setMobileMode: function(){
			this.mobileMode = true;
			this.$el
				.find('.uimage-resize-hint').hide().end()
				.find('.uimage').css('min-height', 'none')
				.find('.upfront-image-caption-container').css('width', '100%').end()
				.find('.upfront-image-container').css('width', '100%').css('height', 'auto').end()
				.find('img')
					.css({
						position: 'static',
						maxWidth: '100%',
						height: 'auto'
					})
					.attr('src', this.property('src'))
			;
		},

		unsetMobileMode: function(){
			this.mobileMode = false;
			if(this.parent_module_view){
				this.render();
			}
		},

		updateBreakpointPadding: function(breakpointColumnPadding) {
			var image_el = this.$el.find('.upfront-image');

			if(image_el.css("padding") !== "") {
				return parseInt(image_el.css("padding"), 10);
			}

			return breakpointColumnPadding;
		},

		/***************************************************************************/
		/*           Handling element resize events (jQuery resizeable)            */
		/***************************************************************************/

		on_element_resize_start: function(attr) {
			if(this.mobileMode) {
				return;
			}

			var starting = this.$('.upfront-image-starting-select'); // Add image panel

			if(this.get_preset_property("caption-position") !== 'below_image') {
				this.$('.wp-caption').fadeOut('fast');
			}

			// Store variables used in resize event handlers
			this.resizingData = {
				starting: starting,
				data: {
					position: this.property('position'),
					size: this.property('size'),
					stretch: this.property('stretch'),
					vstretch: this.property('vstretch')
				},
				img: this.$('img'),
				setTextHeight: this.get_preset_property("caption-position") === 'below_image'
			};

			if(this.cropTimer) {
				clearTimeout(this.cropTimer);
				this.cropTimer = false;
			}

			if(starting.length) {
				return;
			}

			//let's get rid of the image-caption-container to proper resizing
			this.$('.upfront-image-caption-container, .upfront-image-container').css({
				width: '100%',
				height: '100%',
				marginTop: 0
			});
			this.$('.uimage').css('min-height', 'auto');
		},

		on_element_resizing: function(attr) {
			if(this.mobileMode) {
				return;
			}

			var starting = this.resizingData.starting,
				data = this.resizingData.data,
				img = this.resizingData.img,
				captionHeight = this.get_preset_property("caption-position") === 'below_image' ? this.$('.wp-caption').outerHeight() : 0,
				// padding = this.property('no_padding') == 1 ? 0 : this.updateBreakpointPadding(breakpointColumnPadding),
				column_padding = Upfront.Settings.LayoutEditor.Grid.column_padding,
				hPadding = parseInt( this.model.get_breakpoint_property_value('left_padding_num') || column_padding ) + parseInt( this.model.get_breakpoint_property_value('right_padding_num') || column_padding ),
				vPadding = parseInt( this.model.get_breakpoint_property_value('top_padding_num') || column_padding ) + parseInt( this.model.get_breakpoint_property_value('bottom_padding_num') || column_padding ),
				ratio,
				newSize;

			// data.elementSize = {width: attr.width - (2 * padding), height: attr.height - (2 * padding) - captionHeight};
			data.elementSize = {width: parseInt(attr.width) - hPadding, height: parseInt(attr.height) - vPadding - captionHeight};
			newSize = this.getElementShapeSize(data.elementSize);
			if ( false !== newSize ) {
				data.elementSize = newSize;
			}

			this.applyElementSize();

			if(starting.length){
				return starting.outerHeight(data.elementSize.height);
			}

			//Wonderful stuff from here down
			this.$('.uimage').css('height', data.elementSize.height);

			//Resizing the stretching dimension has priority, the other dimension just alter position
			if(data.stretch && !data.vstretch){
				this.resizingH(img, data, true);
				this.resizingV(img, data);
			} else if(!data.stretch && data.vstretch){
				this.resizingV(img, data, true);
				this.resizingH(img, data);
			} else {
				//Both stretching or not stretching, calculate ratio difference
				ratio = data.size.width / data.size.height - data.elementSize.width / data.elementSize.height;

				//Depending on the difference of ratio, the resizing is made horizontally or vertically
				if(ratio > 0 && data.stretch || ratio < 0 && ! data.stretch){
					this.resizingV(img, data, true);
					this.resizingH(img, data);
				}
				else {
					this.resizingH(img, data, true);
					this.resizingV(img, data);
				}
			}

			this.updateControls();
			this.setupBySize();
		},

		on_element_resize: function(attr) {
			if(this.mobileMode) {
				return;
			}
			if(!this.resizingData || !this.resizingData.img || !this.resizingData.img.length) {
				return;
			}

			var starting = this.resizingData.starting,
				me = this,
				img = this.resizingData.img,
				imgSize = {width: img.width(), height: img.height()},
				imgPosition = img.position(),
				padding = this.property('no_padding') == 1 ? 0 : this.updateBreakpointPadding(breakpointColumnPadding);

			if(starting.length){
				this.elementSize = {
					height: attr.height - (2 * padding),
					width: attr.width - (2 * padding)
				};
				this.property('element_size', this.elementSize);
				return;
			} else if (this.property('quick_swap')) {
				return;
			}

			// Save resizing, be sure we have the good dimensions
			this.on_element_resizing(attr);

			// Change the sign
			imgPosition.top = -imgPosition.top;
			imgPosition.left = -imgPosition.left;

			this.temporaryProps = {
				size: imgSize,
				position: imgPosition
			};

			this.property('element_size', this.resizingData.data.elementSize);

			this.cropTimer = setTimeout(function(){
				me.saveTemporaryResizing();
			}, this.cropTimeAfterResize);

			this.resizingData = {};
			this.showCaption();
		},

		on_uimage_update: function (view) {
			if ( !this.parent_module_view || this.parent_module_view != view ) return;

			this.applyElementSize();
		},

		showCaption: function() {
			this.$('.wp-caption').fadeIn('fast');
		},

		resizingH: function(img, data, size) {
			var elWidth = data.elementSize.width,
				width = size ? data.size.width : img.width(), // The width has been modified if we don't need to set the size
				left = data.position.left,
				css = {},
				align;

			if(data.stretch) {
				if(elWidth < width - left) {
					css.left = -left;
					if(size) {
						css.width = width;
					}
				} else if(width > elWidth && elWidth >= width - left) {
					css.left = elWidth - width;
					if(size) {
						css.width = width;
					}
				} else {
					css.left = 0;
					if(size) {
						css.width = elWidth;
					}
				}
				if(size) {
					css.height = 'auto';
				}
				img.css(css);
				return;
			}

			if(elWidth > width) {
				align = this.property('align');
				if(align === 'left') {
					css.left = 0;
				} else if(align === 'center') {
					css.left = (elWidth - width) / 2;
				} else {
					css.left = 'auto';
					css.right = 0;
				}
				if(size) {
					css.width = width;
					css.height = 'auto';
				}
				img.css(css);
				return;
			}

			css.left = 0;
			if(size) {
				css.width = elWidth;
				css.height = 'auto';
			}
			img.css(css);
		},

		resizingV: function(img, data, size) {
			var elHeight = data.elementSize.height,
				height = size ? data.size.height : img.height(),
				top = data.position.top,
				css = {};

			if(data.vstretch) {
				if(elHeight < height - top) {
					css.top = -top;
					if(size) {
						css.height = height;
					}
				} else if(height > elHeight && elHeight >= height - top){
					css.top = elHeight - height;
					if(size) {
						css.height = height;
					}
				} else{
					css.top = 0;
					if(size) {
						css.height = elHeight;
					}
				}
				if(size) {
					css.width = 'auto';
				}
				img.css(css);
				return;
			}

			if(elHeight > height - top) {
				css.top = -top;
				if(size) {
					css.height = height;
				}
			} else if(height - top >= elHeight && elHeight > height){
				css.top = elHeight - height;
				if(size) {
					css.height = height;
				}
			} else {
				css.top = 0;
				if(size) {
					css.height = elHeight;
				}
			}

			if(size) {
				css.width = 'auto';
			}
			img.css(css);
		},
		/***************************************************************************/
		/*       End Handling element resize events (jQuery resizeable)            */
		/***************************************************************************/

		saveTemporaryResizing: function() {
			var me = this,
				elementSize = me.property('element_size'),
				crop = {},
				imageId = me.property('image_id'),
				resize = me.temporaryProps.size,
				position = me.temporaryProps.position,
				deferred = $.Deferred(),
				import_deferred = $.Deferred(),
				import_promise = import_deferred.promise()
			;


			crop.top = position.top;
			crop.left = position.left;

			crop.width = Math.min(elementSize.width, resize.width);
			crop.height = Math.min(elementSize.height, resize.height);

			import_promise.done(function(){
				imageId = me.property('image_id');
				Upfront.Views.Editor.ImageEditor.saveImageEdition(
					imageId,
					me.property('rotation'),
					resize,
					crop
				).done(function(results){
					var imageData = results.data.images[imageId];

					if(imageData.error){
						Upfront.Views.Editor.notify(l10n.process_error, 'error');
						return;
					}

					me.property('size', resize);
					me.property('position', position);
					me.property('src', imageData.url);
					me.property('srcFull', imageData.urlOriginal, false);
					me.property('stretch', resize.width >= elementSize.width);
					me.property('vstretch', resize.height >= elementSize.height);
					me.property('gifImage', imageData.gif);
					clearTimeout(me.cropTimer);
					me.cropTimer = false;
					deferred.resolve();
				});
			});

			if ( this.isThemeImage && 'themeExporter' in Upfront ) {
				this.importImage().always(function(){
					import_deferred.resolve();
				});
			}
			else {
				import_deferred.resolve();
			}

			return deferred.promise();
		},

		saveResizing: function() {
			var me = this;
			if(this.cropTimer){
				clearTimeout(this.cropTimer);
				this.cropTimer = false;

				this.saveTemporaryResizing().done(function(){
					var saveData = {
						element: JSON.stringify(Upfront.Util.model_to_json(me.model)),
						action: 'upfront_update_layout_element'
					};
					Upfront.Util.post(saveData);
				});
			}
		},

		resizeImage: function (size) {
			var img = this.$('img'),
				data,
				imgSize,
				imgPosition
			;

			if ( img.length > 0 ) {
				data = {
					position: this.property('position'),
					size: this.property('size'),
					stretch: this.property('stretch'),
					vstretch: this.property('vstretch'),
					elementSize: size
				};

				if(data.stretch && !data.vstretch){
					this.resizingH(img, data, true);
					this.resizingV(img, data);
				} else if(!data.stretch && data.vstretch){
					this.resizingV(img, data, true);
					this.resizingH(img, data);
				} else {
					//Both stretching or not stretching, calculate ratio difference
					ratio = data.size.width / data.size.height - data.elementSize.width / data.elementSize.height;

					//Depending on the difference of ratio, the resizing is made horizontally or vertically
					if(ratio > 0 && data.stretch || ratio < 0 && ! data.stretch){
						this.resizingV(img, data, true);
						this.resizingH(img, data);
					}
					else {
						this.resizingH(img, data, true);
						this.resizingV(img, data);
					}
				}

				imgSize = {width: img.width(), height: img.height()};
				imgPosition = img.position();

				// Change the sign
				imgPosition.top = -imgPosition.top;
				imgPosition.left = -imgPosition.left;

				this.temporaryProps = {
					size: imgSize,
					position: imgPosition
				};
				this.property('element_size', size);
				this.saveTemporaryResizing();
				return true;
			}
			return false;
		},

		setElementSize: function(ui) {
			var me = this,
				parent = this.parent_module_view.$('.upfront-editable_entity:first'),
				resizer = ui ? $('.upfront-resize') : parent,
				padding = this.property('no_padding') == 1 ? 0 : this.updateBreakpointPadding(breakpointColumnPadding)
			;

			me.elementSize = {
				width: resizer.width() - (2 * padding) + 2,
				height: resizer.height() - (2 * padding)
			};

			if(this.get_preset_property("caption-position") === 'below_image') {
				this.elementSize.height -= parent.find('.wp-caption').outerHeight();
			}

			if(this.property('image_status') === 'starting') {
				this.$('.upfront-object-content').height(me.elementSize.height);
			}

		},
		applyElementSize: function (width, height) {
			var me = this,
				parent = this.parent_module_view.$('.upfront-editable_entity:first'),
				resizer = parent,
				captionHeight = this.get_preset_property("caption-position") === 'below_image' ? this.$('.wp-caption').outerHeight() : 0,
				// padding = this.property('no_padding') == 1 ? 0 : this.updateBreakpointPadding(breakpointColumnPadding),
				borderWidth = parseInt(this.$el.find('.upfront-image-caption-container').css('borderWidth'), 10),
				column_padding = Upfront.Settings.LayoutEditor.Grid.column_padding,
				hPadding = parseInt( this.model.get_breakpoint_property_value('left_padding_num') || column_padding ) + parseInt( this.model.get_breakpoint_property_value('right_padding_num') || column_padding ),
				vPadding = parseInt( this.model.get_breakpoint_property_value('top_padding_num') || column_padding ) + parseInt( this.model.get_breakpoint_property_value('bottom_padding_num') || column_padding ),
				// elementSize = {width: resizer.width() - (2 * padding), height: resizer.height() - (2 * padding) - captionHeight}
				elementSize = {width: ( width && !isNaN(width) ? width : resizer.width() ) - hPadding, height: ( height && !isNaN(height) ? height : resizer.height() ) - vPadding - captionHeight - (2 * borderWidth)}
			;
			this.property('element_size', elementSize);
			this.$el.find('.uimage-resize-hint').html(this.sizehintTpl({
					width: elementSize.width,
					height: elementSize.height,
					l10n: l10n.template
				})
			);
		},

		openImageSelector: function(e){
			var me = this;
			if (e && e.preventDefault) e.preventDefault();

			Upfront.Views.Editor.ImageSelector.open({
				multiple_sizes: false,
			}).done(function(images){
				var sizes = {};
				_.each(images, function(image, id){
					sizes = image;
					me.imageId = id;
				});

				var	imageInfo = {
						src: sizes.medium ? sizes.medium[0] : sizes.full[0],
						srcFull: sizes.full[0],
						srcOriginal: sizes.full[0],
						fullSize: {width: sizes.full[1], height: sizes.full[2]},
						size: sizes.medium ? {width: sizes.medium[1], height: sizes.medium[2]} : {width: sizes.full[1], height: sizes.full[2]},
						position: false,
						rotation: 0,
						id: me.imageId
					}
				;
				$('<img>')
					.load(function(){
						Upfront.Views.Editor.ImageSelector.close();
						me.openEditor(true, imageInfo);
					})
					.on("error", function () {
						Upfront.Views.Editor.ImageSelector.close();
						Upfront.Views.Editor.notify(l10n.process_error, 'error');
					})
					.attr('src', imageInfo.srcFull)
				;
			});
		},

		handleEditorResult: function(result){
			this.property('image_status', 'ok', true);
			this.property('has_settings', 1);
			this.property('src', result.src, true);
			this.property('srcFull', result.srcFull, true);
			this.property('srcOriginal', result.srcOriginal, true);
			this.property('size', result.imageSize, true);
			this.property('position', result.imageOffset, true);
			var marginTop = result.mode === 'horizontal' || result.mode === 'small' ? result.imageOffset.top * -1 : 0;
			this.property('marginTop', marginTop, true);
			this.property('rotation', result.rotation, true);
			this.property('fullSize', result.fullSize, true);

			this.property('element_size', result.maskSize, true);

			this.property('align', result.align, true);
			this.property('stretch', result.stretch, true);
			this.property('vstretch', result.vstretch, true);
			this.property('quick_swap', false, true);
			if(result.imageId) {
				this.property('image_id', result.imageId, true);
			}

			this.property('gifImage', result.gif);

			this.temporaryProps = false;
			this.render();

			if(result.elementSize){
				this.set_element_size(result.elementSize.columns, result.elementSize.rows, 'all', true);
			}
		},

		editRequest: function () {
			var me = this;
			if(this.property('image_status') === 'ok' && this.property('image_id')) {
				if (this.isThemeImage() && 'themeExporter' in Upfront) {
					this.importImage().always(function(){
						me.openEditor();
					});
				}
				else {
					this.openEditor();
				}
				return;
			}

			Upfront.Views.Editor.notify(l10n.external_nag, 'error');
		},

		getElementColumns: function(){
			var module = this.$el.closest('.upfront-module'),
				classes,
				found = false
			;

			if(!module.length) {
				return -1;
			}

			classes = module.attr('class').split(' ');

			_.each(classes, function(c){
				if(c.match(/^c\d+$/)) {
					found = c.replace('c', '');
				}
			});
			return found || -1;
		},

		openEditor: function(newImage, imageInfo){
			if(Upfront.Application.responsiveMode !== 'desktop') {
				return Upfront.Views.Editor.notify(l10n.desktop_nag, 'error');
			}

			var me = this,
				options = {
					setImageSize: newImage,
					saveOnClose: newImage,
					editElement: this
				}
			;

			this.setElementSize();
			this.setImageInfo();

			if(imageInfo) {
				_.extend(options, this.imageInfo, imageInfo);
			} else {
				_.extend(options, this.imageInfo);
			}

			if(this.cropTimer){
				this.stoppedTimer = true;
				clearTimeout(this.cropTimer);
				this.cropTimer = false;
			}

			options.element_id = me.model.get_property_value_by_name('element_id');

			Upfront.Views.Editor.ImageEditor.open(options)
				.done(function(result){
					me.handleEditorResult(result);
					this.stoppedTimer = false;
				})
				.fail(function(data){
					if(data && data.reason === 'changeImage') {
						me.openImageSelector();
					} else if(me.stoppedTimer) {
						me.saveTemporaryResizing();
						me.stoppedTimer = false;
					}
				})
			;
		},

		handleLinkClick: function(event){
			var lightboxName;


			if (this.link.get('type') !== 'lightbox') {
				return;
			}

			event.preventDefault();

			lightboxName = this.link.get('url').substring(1);
			Upfront.Application.LayoutEditor.openLightboxRegion(lightboxName);
		},

		importImage: function () {
			var me = this,
				image_id = this.property('image_id'),
				opts = {
					action: 'upfront-media-image-import',
					images: [{
						element_id: this.property('element_id'),
						id: image_id,
						src: this.property('srcFull')
					}]
				},
				deferred = $.Deferred()
			;
			Upfront.Util.post(opts).done(function(response){
				var images = response.data.images;
				if ( image_id in images ) {
					var status = images[image_id].status;
					if ( status == 'imported') {
						me.property('image_id', images[image_id].id);
						me.property('srcFull', images[image_id].src);
						me.property('srcOriginal', images[image_id].src);
					}
					else if ( status == 'exists' ) {
						me.property('image_id', images[image_id].id);
					}
					else if ( status == 'fail' ) {
						deferred.reject();
						return;
					}
					deferred.resolve(me.property('image_id'));
					return;
				}
				deferred.reject();
			});
			return deferred.promise();
		},

		cleanup: function(){
			// The default images on a new theme installation do not have controlls created, so putting a check here.
			if(this.controls)
				this.controls.remove();
			// if(this.bodyEventHandlers){
			//  _.each(this.bodyEventHandlers, function(f, ev){
			//    $('body').off(ev, f);
			//  });
			// }
		},

		property: function(name, value, silent) {
			if(typeof value !== 'undefined'){
				if(typeof silent === 'undefined') {
					silent = true;
				}
				return this.model.set_property(name, value, silent);
			}
			return this.model.get_property_value_by_name(name);
		},

		getControlItems: function(){
			var me = this,
				panel = new Upfront.Views.Editor.InlinePanels.ControlPanel(),
				captionControl = new Upfront.Views.Editor.InlinePanels.TooltipControl()
			;

			captionControl.sub_items = {
				nocaption: this.createControl('nocaption', l10n.ctrl.no_caption),
				showCaption: this.createControl('showCaption', l10n.ctrl.show_caption)
			};


			captionControl.icon = 'caption';
			captionControl.tooltip = l10n.ctrl.caption_position;
			captionControl.selected = this.property("display_caption");

			this.listenTo(captionControl, 'select', function(item){
				switch(item){
					case 'showCaption':
						me.property('display_caption', 'showCaption');
						break;
					default:
						me.property('display_caption', "nocaption");
						break;
				}
				me.render();
			});

			var controlls =  _([
				this.createControl('crop', l10n.ctrl.edit_image, 'editRequest'),
				this.createLinkControl(),
				captionControl,
				this.createPaddingControl(),
				this.createControl('settings', Upfront.Settings.l10n.global.views.settings, 'on_settings_click')
			]);

		if( "yes" !== this.get_preset_property("use_captions") )
			controlls = _( controlls.without( captionControl ) );

		return controlls;
		}
	});

	Upfront.Application.LayoutEditor.add_object('Uimage', {
		'Model': UimageModel,
		'View': UimageView,
		'Element': ImageElement,
		'Settings': ImageSettings,
		'ContextMenu': ImageContextMenu,
		cssSelectors: {
			'.upfront-image-wrapper': {label: l10n.css.image_label, info: l10n.css.image_info},
			'.wp-caption': {label: l10n.css.caption_label, info: l10n.css.caption_info},
			'.upfront-image-container': {label: l10n.css.wrapper_label, info: l10n.css.wrapper_info}
		},
		cssSelectorsId: Upfront.data.uimage.defaults.type
	});

	Upfront.Views.Editor.ImageEditor = new ImageEditor();
	Upfront.Views.Editor.ImageSelector = new ImageSelector();
	Upfront.Models.UimageModel = UimageModel;
	Upfront.Views.UimageView = UimageView;

});
})(jQuery);
//@ sourceURL=uimage.js
;
(function ($) {
  define('upfront-like-box',[
		'scripts/upfront/element-settings/settings',
		'scripts/upfront/element-settings/root-settings-panel'
	], function(ElementSettings, RootSettingsPanel) {

	var l10n = Upfront.Settings.l10n.like_box_element;

	/**
	 * Define the model - initialize properties to their default values.
	 * @type {Upfront.Models.ObjectModel}
	 */

	var LikeBoxModel = Upfront.Models.ObjectModel.extend({
		/**
		 * A quasi-constructor, called after actual constructor *and* the built-in `initialize()` method.
		 * Used for setting up instance defaults, initialization and the like.
		 */
		init: function () {
			var properties = _.clone(Upfront.data.ulikebox.defaults);
			properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + '-object');
			this.init_properties(properties);
		}
	});

	/**
	 * View instance - what the element looks like.
	 * @type {Upfront.Views.ObjectView}
	 */
	var LikeBoxView = Upfront.Views.ObjectView.extend({

		model: LikeBoxModel,
		elementSize: {width: 0, height: 0},

		initialize: function(options){
			if(! (this.model instanceof LikeBoxModel)){
				this.model = new LikeBoxModel({properties: this.model.get('properties')});
			}

			this.constructor.__super__.initialize.call(this, [options]);

			this.listenTo(Upfront.Events, 'entity:resize_start', this.hideFrame);
			this.listenTo(Upfront.Events, 'entity:resize_stop', this.onElementResize);
		},
		
		on_element_resize_start: function (attr) {
			this.hideFrame(this, this.model);
		},
		
		on_element_resize: function (attr) {
			this.onElementResize(this, this.model);
		},

		setUrl: function(){
			this.property('facebook_url' , Upfront.data.social.panel.model.get_property_value_by_name('global_social_media_services-facebook-url'));
		},
		hideFrame: function(view, model) {
			if (this.parent_module_view == view) {
				this.$el.find('iframe').css('display', 'none');
			}
		},
		showFrame: function () {
			var $frame = this.$el.find("iframe");
			if (!$frame.is(":visible")) $frame.show();
		},
		onElementResize: function(view, model){
			this.setElementSize();
			this.showFrame();
		},
		setElementSize: function(){
			var me = this,
				parent = this.parent_module_view.$('.upfront-editable_entity:first')
				;
			if(parent.length && parent.height()){
				this.elementSize.height = parent.height();
				//setTimeout(function(){
					var size = me.get_element_size_px(false);
					if(size.row === 0) {
						size.row = parent.height();
					}

					if(size.col != 0){
						me.property('element_size', {
							width: size.col,
							height: size.row,
						});
					}

				//}, 1000);
			}
		},
		property: function(name, value) {
			if(typeof value != "undefined")
				return this.model.set_property(name, value);
			return this.model.get_property_value_by_name(name);
		},
		events: function(){
			return _.extend({},Upfront.Views.ObjectView.prototype.events,{
				'click a.back_global_settings' : 'backToGlobalSettings'
			});
		},
		backToGlobalSettings: function(e){
			e.preventDefault();
			Upfront.data.social.panel.popupFunc();
		},

		getGlobalFBUrl: function(){
			if(!Upfront.data.usocial.globals)
				return false;
			var services = Upfront.data.usocial.globals.services,
				url = false;

			_(services).each( function( s ) {
				if(s.id == 'facebook')
					url = s.url;
			});

			return url;
		},

		/**
		 * Element contents markup.
		 * @return {string} Markup to be shown.
		 */
		get_content_markup: function () {
			var me = this,

			fbUrl = this.model.get_property_value_by_name('facebook_url');

			//if(!fbUrl || fbUrl=='')
			//	fbUrl = this.getGlobalFBUrl();

			if(fbUrl){
				var splitted = fbUrl.split('/');
				var pageName = _.last(splitted);

				if(_.isEmpty(pageName)) {
					splitted.splice(splitted.length-1, 1);
					pageName = _.last(splitted);
				}

				var wide = 	this.model.get_property_value_by_name('element_size').width-30;

				if(wide>500)
					wide=500;

				/*if(wide%53 > 0)
					wide = parseInt(wide/53)*53+22;
				else
					wide = this.model.get_property_value_by_name('element_size').width;
				*/
				//return '<iframe src="//www.facebook.com/plugins/likebox.php?href=https%3A%2F%2Fwww.facebook.com%2F'+ (pageName ? pageName : 'wpmudev' )+'&amp;width='+wide+'&amp;height='+this.model.get_property_value_by_name('element_size').height+'&amp;show_faces=true&amp;colorscheme=light&amp;stream=false&amp;show_border=true&amp;header=false" scrolling="no" frameborder="0" style="border:none; overflow:hidden; float:left; width:'+wide+'px; height:'+this.model.get_property_value_by_name('element_size').height+'px;"" allowTransparency="true"></iframe><div class="upfront-like-box_overlay"></div>'+ (!pageName ? '<span class="alert-url">!</span>' : '' );


				var hide_cover = this.model.get_property_value_by_name('hide_cover')=='yes'?'true':'false';
				var show_friends = this.model.get_property_value_by_name('show_friends')=='yes'?'true':'false';
				var small_header = this.model.get_property_value_by_name('small_header')=='yes'?'true':'false';
				var show_posts = this.model.get_property_value_by_name('show_posts')=='yes'?'true':'false';

				return '<iframe src="//www.facebook.com/v2.5/plugins/page.php?adapt_container_width=true&amp;container_width='+wide+'&amp;width='+wide+'&amp;height='+(this.model.get_property_value_by_name('element_size').height-30)+'&amp;hide_cover='+hide_cover+'&amp;href=https%3A%2F%2Fwww.facebook.com%2F'+ (pageName ? pageName : 'wpmudev' )+'&amp;show_facepile='+show_friends+'&amp;show_posts='+show_posts+'&amp;small_header='+small_header+'" scrolling="no" frameborder="0" style="border:none; display:block; overflow:hidden; margin:auto; width:'+wide+'px; height:'+(this.model.get_property_value_by_name('element_size').height-30)+'px;"" allowTransparency="true"></iframe><div class="upfront-like-box_overlay"></div>'+ (!pageName ? '<span class="alert-url">!</span>' : '' );

			}else{
				this.model.set_property('facebook_url', '', true);
				return '<div class="upfront-likebox-overlay upfront-initial-overlay-wrapper" style="min-height: 200px;">' +
						'<div class="upfront-like-box_placeholder upfront-initial-overlay-wrapper" style="height: 150px;">' +
						'<div class="upfront-like-box_placeholder_guide">'+l10n.placeholder_guide+'</div>' +
						'<div class="upfront-like-box_url_wrapper"><input type="text" class="upfront-like-box_url" placeholder="' + l10n.placeholder + '" /></div>' +
						'<button type="button" class="upfront-like-box_button">'+l10n.ok+'</button></div></div>';
			}
		},

		on_render: function(){
			var parent = this.parent_module_view, me = this;
			
			this.setElementSize();

			//Prevent iframe hijacking of events when dragging
			if(!parent.$el.data('dragHandler')){
				parent.$el.on('dragstart', this.coverIframe);
				parent.$el.data('dragHandler', true);
			}

			this.$el.find('.upfront-like-box_button').on('click', function(e) {
				me.property('facebook_url', $(this).parent().find('input.upfront-like-box_url').val());
			});
			this.$el.find('.upfront-like-box_url').on('keydown', function(e) {
				if(e.which == 13) {
					me.$el.find('.upfront-like-box_button').click();
					Upfront.Events.trigger("upfront:element:edit:stop");
				}
			});
		},

		on_after_layout_render: function () {
			this.setElementSize();
		},

		//Prevent iframe hijacking of events when dragging
		coverIframe: function(e, ui){
			ui.helper.append('<div class="upfront-iframe-draggable" style="width:100%;height:100%;position:absolute;top:0;left:0:z-index:1"></div>');
		}

	});

	/**
	 * Sidebar element class - this let you inject element into
	 * sidebar elements panel and allow drag and drop element adding
	 * @type {Upfront.Views.Editor.Sidebar.Element}
	 */
	var LikeBoxElement = Upfront.Views.Editor.Sidebar.Element.extend({
		priority: 100,
		render: function () {
			this.$el.addClass('upfront-icon-element upfront-icon-element-likebox');
			this.$el.html(l10n.element_name);
		},
		add_element: function () {
			var object = new LikeBoxModel(),
				module = new Upfront.Models.Module({
					"name": "",
					"properties": [
						{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
						{"name": "class", "value": "c7 upfront-like-box_module"},
						{"name": "has_settings", "value": 0},
						{"name": "row", "value": Upfront.Util.height_to_row(200)}
					],
					"objects": [
						object // The anonymous module will contain our search object model
					]
				});
			// We instantiated the module, add it to the workspace
			this.add_module(module);
		}
	});


	// ----- Settings API -----
	// We'll be working from the bottom up here.
	// We will first define settings panels, and items for each panel.
	// Then we'll slot in the panels in a settings instance.

	/**
	 * Layout Style settings - Facebook Page URL item
	 * @type {Upfront.Views.Editor.Settings.Item}
	 */

	/**
	 * Social Media settings hub, populated with the panels we'll be showing.
	 * @type {Upfront.Views.Editor.Settings.Settings}
	 */
	var GeneralPanel = RootSettingsPanel.extend({
		className: 'uyoutube-settings',
		tabbed: false,
		title: l10n.general_settings,
		initialize: function (opts) {
			this.options = opts;
			
			me = this,
			SettingsItem =  Upfront.Views.Editor.Settings.Item,
			Fields = Upfront.Views.Editor.Field
			;

			this.settings = _([
				new SettingsItem({
					className: 'upfront-social-services-item general_settings_item',
					title: l10n.facebook_account,
					label: l10n.opts.page_url,
					fields: [
						new Fields.Text({
							model: this.model,
							className: 'facebook-url',
							property: 'facebook_url',
							label: l10n.opts.url_sample,
							compact: true,
							change: function(value) {
								this.model.set_property('facebook_url', value);
							}
						}),

						new Fields.Checkboxes({
							model: this.model,
							className: 'show-friends',
							property: 'show_friends',
							label: "",
							values: [
								{ label: l10n.opts.show_friends, value: 'yes' }
							],
							change: function(value) {
								this.model.set_property('show_friends', value);
							}
						}),

						new Fields.Checkboxes({
							model: this.model,
							className: 'small-header',
							property: 'small_header',
							label: "",
							values: [
								{ label: l10n.opts.small_header, value: 'yes' }
							],
							change: function(value) {
								this.model.set_property('small_header', value);
							}
						}),

						new Fields.Checkboxes({
							model: this.model,
							className: 'hide-cover',
							property: 'hide_cover',
							label: "",
							values: [
								{ label: l10n.opts.hide_cover, value: 'yes' }
							],
							change: function(value) {
								this.model.set_property('hide_cover', value);
							}
						}),

						new Fields.Checkboxes({
							model: this.model,
							className: 'show-posts',
							property: 'show_posts',
							label: "",
							values: [
								{ label: l10n.opts.show_posts, value: 'yes' }
							],
							change: function(value) {
								this.model.set_property('show_posts', value);
							}
						}),

						new Upfront.Views.Editor.Settings.Settings_CSS({model: this.model }),
					]
				})
			]);
		},

		get_title: function () {
			return l10n.general_settings;
		},
	});
	var LikeBoxSettings = ElementSettings.extend({
		panels: {
			'General': GeneralPanel
		},
		title: l10n.settings
	});



// ----- Bringing everything together -----
// The definitions part is over.
// Now, to tie it all up and expose to the Subapplication.

	Upfront.Application.LayoutEditor.add_object("LikeBox", {
			"Model": LikeBoxModel,
			"View": LikeBoxView,
			"Element": LikeBoxElement,
			"Settings": LikeBoxSettings,
			cssSelectors: {
				'iframe': {label: l10n.container_label, info: l10n.container_info}
			},
			cssSelectorsId: Upfront.data.ulikebox.defaults.type
	});

	Upfront.Models.LikeBoxModel = LikeBoxModel;
	Upfront.Views.LikeBoxView = LikeBoxView;

  });

})(jQuery);


define('text!elements/upfront-login/css/edit.css',[],function () { return '.upfront_login-settings-panel .upfront-settings_panel {\r\n\twidth: 290px;\r\n}\r\n\r\n.upfront_login-fields-complex_boolean {\r\n\twidth: 48%;\r\n\tfloat: left;\r\n}\r\n.upfront_login-fields-complex_boolean .upfront-field-wrap-radios {\r\n\tfloat: left;\r\n}\r\n.upfront_login-fields-complex_boolean .upfront-field-wrap-text {\r\n\twidth: 80%;\r\n\tfloat: left;\r\n}\r\n.upfront_login-fields-complex_boolean.upfront_login-appearance-icon {\r\n\twidth: 60%;\r\n}\r\n.upfront_login-fields-complex_boolean.upfront_login-appearance-icon .upfront-field-text {\r\n\twidth: 80%;\r\n}\r\n.upfront_login-fields-complex_boolean.upfront_login-appearance-label {\r\n\twidth: 40%;\r\n}\r\n.upfront_login-fields-complex_boolean.upfront_login-appearance-icon .upfront_login-icon {\r\n\tfloat: left;\r\n\twidth: 85%;\r\n}\r\n.upfront_login-fields-complex_boolean.upfront_login-appearance-icon .upfront_login-icon input {\r\n\twidth: 80%;\r\n}\r\n\r\n.upfront_login-item-display_behavior .upfront-field-multiple,\r\n.upfront_login-logout_style .upfront-field-multiple {\r\n\tmax-width: 48%;\r\n\tmargin-right: 1%;\r\n\tfloat: left;\r\n}\r\n\r\n.upfront_login-logout_text {\r\n\tclear:both;\r\n} \r\n\r\ndiv.upfront_login-item-display_behavior div.upfront-settings-item-title > span {\r\n  display: block;\r\n  color: #7d99b3;\r\n  font-size: 11px;\r\n  font-weight: bold;\r\n  font-family: verdana, sans-serif;\r\n  line-height: 1;\r\n  margin-bottom: 0 !important;\r\n  text-transform: none;\r\n}\r\n\r\n\r\ndiv.upfront_login-item-display_behavior div.upfront-settings-item-title:after {\r\n  display:none;\r\n}\r\n\r\ndiv.upfront_login-item-display_trigger div.upfront-field-wrap-text {\r\n  margin-top:0 !important;\r\n}\r\n\r\ndiv.upfront_login-item-display_trigger div.upfront-settings-item {\r\n  padding-top: 0;\r\n}';});


define('text!elements/upfront-login/css/public.css',[],function () { return '/* GENERAL FORM STYLE \r\n\t ================== */\r\n.upfront_login-form form input {\r\n\theight:40px;\r\n\tborder:3px solid #ceddea;\r\n\tbackground-color: #fff;\r\n\tpadding:0 10px;\r\n}\r\n.upfront_login-form form input:hover, .upfront_login-form form input:focus { \r\n\tborder-color: #aec4d8;\r\n\toutline:none;\r\n}\r\n.upfront_login-form form input[type="submit"]{\r\n\tborder: 2px solid #269a47;\r\n\tbackground-color: #2cad4a;\r\n\tcolor: #fff;\r\n\twidth: 100%;\r\n\ttext-align: center;\r\n}\r\n.upfront_login-form form input[type="submit"]:hover {\r\n\tbackground-color: #269a47;\r\n}\r\n.upfront_login-form form input[type="checkbox"]{\r\n\theight:20px;\r\n\tmargin-bottom:15px;\r\n\tposition: relative;\r\n\ttop: 3px;\r\n}\r\n/*.upfront_login-form form label, .upfront_login-form p { color:#6486a6; }*/\r\n.upfront_login-form p { margin-bottom: 0; text-align: center; }\r\n.upfront_login-form p a { color:#39a678; }\r\n\r\n\r\n/* HOVER FORM \r\n\t ========== */\r\n\r\n.upfront_login.upfront_login-hover,\r\n.upfront_login.upfront_login-click { position: relative; }\r\n.upfront_login.upfront_login-hover .upfront_login-form-wrapper,\r\n.upfront_login.upfront_login-click .upfront_login-form-wrapper\r\n {\r\n\t display: none; \r\n}\r\n.upfront_login.upfront_login-hover .upfront_login-form-wrapper,\r\n.upfront_login.upfront_login-click .upfront_login-form-wrapper { \r\n\tposition: absolute;\r\n\tz-index: 1;\r\n\ttop:15px;\r\n\twidth:210px;\r\n\tleft:-50px;\r\n}\r\n\r\n.upfront_login.upfront_login-hover:hover .upfront_login-form-wrapper,\r\n.upfront_login.upfront_login-click.active .upfront_login-form-wrapper {\r\n\tdisplay: block;\r\n}\r\n\r\n/* login panel styling */\r\n.upfront_login.upfront_login-hover .upfront_login-form,\r\n.upfront_login.upfront_login-click .upfront_login-form {\r\n\tposition: relative;\r\n\tdisplay: block;\r\n\tbackground-color: #fff;\r\n\tborder-radius: 3px;\r\n\tcursor: default;\r\n\tborder:2px solid #527caa;\r\n\ttop:20px;\r\n\tleft:0;\r\n\tpadding:15px;\r\n\tpadding-bottom: 5px;\r\n}\r\n\r\n/* triangular tooltip */\r\n.upfront_login.upfront_login-hover:hover .upfront_login-form:before,\r\n.upfront_login.upfront_login-click.active .upfront_login-form:before {\r\n\tcontent:\'\';\r\n\tdisplay:inline-block;\r\n\twidth:10px;\r\n\theight:10px;\r\n\tbackground-color:#fff;\r\n\ttransform:rotate(45deg);\r\n\t-webkit-transform:rotate(45deg);\r\n\tborder-top:2px solid #527caa;\r\n\tborder-left:2px solid #527caa;\r\n\tposition:absolute;\r\n\ttop:-7px;\r\n\tleft:25%;\r\n}\r\n.upfront_login.upfront_login-hover .upfront_login-form label,\r\n.upfront_login.upfront_login-click .upfront_login-form label\r\n { text-align: left; display: block;}\r\n\r\n.upfront_login.upfront_login-hover:hover .upfront_login-trigger,\r\n.upfront_login.upfront_login-click.active .upfront_login-trigger {\r\n\tdisplay: inline-block;\r\n}\r\n\r\n/* Click */\r\n/*\r\n.upfront_login.upfront_login-click .upfront_login-form form input[type="submit"]{\r\n\twidth: 70%;\r\n}\r\n.upfront_login.upfront_login-click .login-username, \r\n.upfront_login.upfront_login-click .login-password { margin-bottom: 15px; }\r\n.upfront_login.upfront_login-click .upfront_login-form {\r\n\tdisplay: none;\r\n}\r\n.upfront_login.upfront_login-click {\r\n\tz-index: 0;\r\n}\r\n.upfront_login.upfront_login-click.active {\r\n\tbackground: rgba(38,58,77,.8);\r\n\tposition: fixed;\r\n\ttop: 0; left: 0;\r\n\tbottom: 0; right: 0;\r\n\tz-index: 9;\r\n\tpadding-top: 5em;\r\n}*/\r\n/*.upfront_login.upfront_login-click.active .upfront_login-form {\r\n\tdisplay: block;\r\n\tbackground: #fff;\r\n\tz-index: 10;\r\n\twidth: 80%;\r\n\tmax-width: 350px;\r\n\tmargin: 0 auto;\r\n\tpadding: 2em;\r\n}*/\r\n/*.upfront_login.upfront_login-click.active .upfront_login-trigger {\r\n\tdisplay: none;\r\n}*/\r\n\r\n/* css animation */\r\n.upfront_login.upfront_login-hover .upfront_login-form,\r\n.upfront_login.upfront_login-click .upfront_login-form {-webkit-animation-fill-mode:both;-moz-animation-fill-mode:both;-ms-animation-fill-mode:both;-o-animation-fill-mode:both;animation-fill-mode:both;-webkit-animation-duration:0.5s;-moz-animation-duration:0.5s;-ms-animation-duration:0.5s;-o-animation-duration:0.5s;animation-duration:0.5s;}\r\n@-webkit-keyframes fadeInDown {\r\n\t0% {\r\n\t\topacity: 0;\r\n\t\t-webkit-transform: translateY(-10px);\r\n\t}\t100% {\r\n\t\topacity: 1;\r\n\t\t-webkit-transform: translateY(0);\r\n\t}\r\n}\r\n\r\n@-moz-keyframes fadeInDown {\r\n\t0% {\r\n\t\topacity: 0;\r\n\t\t-moz-transform: translateY(-10px);\r\n\t}\r\n\t\r\n\t100% {\r\n\t\topacity: 1;\r\n\t\t-moz-transform: translateY(0);\r\n\t}\r\n}\r\n\r\n@-o-keyframes fadeInDown {\r\n\t0% {\r\n\t\topacity: 0;\r\n\t\t-o-transform: translateY(-10px);\r\n\t}\r\n\t\r\n\t100% {\r\n\t\topacity: 1;\r\n\t\t-o-transform: translateY(0);\r\n\t}\r\n}\r\n\r\n@keyframes fadeInDown {\r\n\t0% {\r\n\t\topacity: 0;\r\n\t\ttransform: translateY(-10px);\r\n\t}\r\n\t\r\n\t100% {\r\n\t\topacity: 1;\r\n\t\ttransform: translateY(0);\r\n\t}\r\n}\r\n\r\n.fadeInDown, .upfront_login.upfront_login-hover:hover .upfront_login-form {\r\n\t-webkit-animation-name: fadeInDown;\r\n\t-moz-animation-name: fadeInDown;\r\n\t-o-animation-name: fadeInDown;\r\n\tanimation-name: fadeInDown;\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\ndiv.upfront-output-upfront-login_element form#loginform input:not([type=checkbox]) {\r\n  width: 100%;\r\n  padding:0 10px;\r\n  box-sizing: border-box;\r\n}\r\n\r\n\r\ndiv.upfront-output-upfront-login_element form#loginform p {\r\n  text-align:left;\r\n  line-height: 1.2;\r\n  margin-top:1em\r\n}\r\n\r\ndiv.upfront-output-upfront-login_element form#loginform label {\r\n\tmargin-bottom:0.3em;\r\n\tdisplay: inline-block;\r\n\tfont-weight: 100;\r\n}\r\ninput#rememberme {\r\n  width:18px;\r\n  height:18px;  \r\n  vertical-align:middle;\r\n  margin-right:10px\r\n}\r\ninput#rememberme:before {\r\n  content:\'\';\r\n  display: block;\r\n  width:100%;\r\n  height:100%;\r\n  border:3px solid #CEDDEA;\r\n  background-color:#fff;\r\n}\r\ninput#rememberme:checked:before {\r\n\tbackground-position: -733px -138px;\r\n\tbackground-image: url(\'../../../img/uf-ui-sprite.svg\');\r\n\tbackground-repeat: no-repeat;\r\n}';});

(function ($) {
define('upfront_login',[
	'text!elements/upfront-login/css/edit.css',
	'text!elements/upfront-login/css/public.css',
	'scripts/upfront/element-settings/settings',
	'scripts/upfront/element-settings/root-settings-panel',
	'scripts/upfront/element-settings/advanced-settings'
], function (editor_style, public_style, ElementSettings, RootSettingsPanel, AdvancedSettings) {

	$("head").append("<style>" + editor_style + "</style>");
	$("head").append("<style>" + public_style + "</style>");

	var l10n = Upfront.Settings.l10n.login_element;

	var LoginModel = Upfront.Models.ObjectModel.extend({
		init: function () {
			var properties = _.clone(Upfront.data.upfront_login.defaults);
			properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + '-object');
			this.init_properties(properties);
		}
	});

	var LoginView = Upfront.Views.ObjectView.extend({
		markup: false,

		initialize: function () {
			if(! (this.model instanceof LoginModel)){
				this.model = new LoginModel({properties: this.model.get('properties')});
			}
			Upfront.Views.ObjectView.prototype.initialize.call(this);
			var me = this;
			this.model.get("properties").on("change", function (model) {
				if (!model || !model.get) return true;
				if ("row" != model.get("name")) {
					me.markup = false;
					me.render();
				}
			});
			this.model.get('properties').bind('change', this.handle_visual_padding_hint, this);
		},

		render: function () {
			if (!this.markup) {
				var me = this,
					options = Upfront.Util.model_to_json(this.model)
				;

				Upfront.Util.post({
					"action": "upfront-login_element-get_markup",
					properties: options.properties
				}).done(function (response) {
					me.markup = response.data;

					Upfront.Views.ObjectView.prototype.render.call(me);
				});
			}
			Upfront.Views.ObjectView.prototype.render.call(this);
		},
		get_content_markup: function () {

			return !!this.markup ? this.markup : l10n.hold_on;
		}
	});

	var Login_Fields_FieldAppearance_Icon_Image = Upfront.Views.Editor.Field.Text.extend({
		className: 'upfront-field-wrap upfront-field-wrap-appearance-icon-image',
		get_field_html: function () {
			return '<div class="upfront_login-icon">' +
					'<img src="' + Upfront.data.upfront_login.root_url + 'img/icon.png" />' +
					Upfront.Views.Editor.Field.Text.prototype.get_field_html.call(this) +
				'</div>'
			;
		},
		get_saved_value: function () {
			var prop = this.property ? this.property.get('value') : (this.model ? this.model.get(this.name) : '');
			return 'icon' === prop ? '' : prop;
		},
		get_value: function () {
			return this.$el.find("input").val() || 'icon';
		}
	});

	var Login_SettingsItem_ComplexItem = Upfront.Views.Editor.Settings.Item.extend({
		save_fields: function () {
			var model = this.model;
			this.fields.each(function (field) {
				var data = field.get_value();
				if (!_.isObject(data)) return;
				_(data).each(function (val, idx) {
					if ('appearance' == idx && !val) return true;
					model.set_property(idx, val);
				});
			});
		}
	});

	var Login_Fields_Complex_BooleanField = Backbone.View.extend({
		className: "upfront_login-fields-complex_boolean clearfix",
		initialize: function (opts) {
			this.options = opts;
			var model = opts.model,
				boolean_values = opts.boolean_field.values || []
			;
			if (!boolean_values.length) {
				boolean_values.push({label: "", value: "1"});
			}

			this.options.field = new Upfront.Views.Editor.Field.Radios(_.extend(
				opts.boolean_field, {
					model: model,
					mutiple: false,
					values: boolean_values
			}));
		},
		render: function () {
			this.$el.empty();

			this.options.subfield.render();
			this.options.field.render();

			this.$el.append(this.options.field.$el);
			this.$el.append(this.options.subfield.$el);

			if (this.options.additional_class) this.$el.addClass(this.options.additional_class);
		},
		get_value: function () {
			var data = {};
			data[this.options.field.get_name()] = this.options.field.get_value();
			data[this.options.subfield.get_name()] = this.options.subfield.get_value();
			return data;
		}
	});


	var LoginSettings = ElementSettings.extend({
		title: l10n.settings,
		
		initialize: function (opts) {
			this.has_tabs = false;
			this.options = opts;
			var panel = new LoginSettings_Panel({model: this.model});
			this.panels = [
				panel,
				new AdvancedSettings({model: this.model})
			];
		},
		
		get_title: function () {
			return l10n.settings;
		}
	});
	
	var LoginSettings_Panel = RootSettingsPanel.extend({
		title: l10n.general_settings,
		initialize: function (opts) {
			this.options = opts;
			var appearance = new LoginSettings_Field_DisplayAppearance({model: this.model}),
				behavior = new LoginSettings_Field_DisplayBehavior({model: this.model}),
				trigger = new LoginSettings_Field_DisplayTrigger({model: this.model}),
				me = this
			;
			this.settings = _([
				appearance,
				behavior,
				trigger,
				new Upfront.Views.Editor.Settings.Item({
					model: this.model,
					title: l10n.logged_in_preview,
					fields: [
						new Upfront.Views.Editor.Field.Checkboxes({
							//className: "upfront_login-logout_style upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios",
							model: this.model,
							property: 'logged_in_preview',
							label: "",
							values: [
								{ label: l10n.preview, value: 'yes' }
							],
							change: function() {
								this.property.set({'value': this.get_value()}, {'silent': false});
							}
						}),
						new Upfront.Views.Editor.Field.Radios({
							className: "upfront_login-logout_style upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios",
							model: this.model,
							property: "logout_style",

							values: [
								{label: l10n.nothing, value: "nothing"},
								{label: l10n.log_out_link, value: "link"}
							],
							change: function() {
								this.property.set({'value': this.get_value()}, {'silent': false});
							}
						}),
						new Upfront.Views.Editor.Field.Text({
							className: "upfront_login-logout_text upfront-field-wrap upfront-field-wrap-text",
							model: this.model,
							property: 'logout_link',
							label: l10n.log_out_label,
							change: function() {
								this.property.set({'value': this.get_value()}, {'silent': false});
							}
						}),

					]

				}),
				new Upfront.Views.Editor.Settings.Settings_CSS({model: this.model }),
			]);
			appearance.on("login:appearance:changed", behavior.update, behavior);
			appearance.on("login:appearance:changed", trigger.update, trigger);
			appearance.on("login:appearance:changed", function () {
				me.trigger("upfront:settings:panel:refresh", me);
			})
		},
		render: function () {
			RootSettingsPanel.prototype.render.call(this);
			this.$el.addClass("upfront_login-settings-panel");
			this.settings.each(function (setting) {
				if (setting.update) setting.update();
			});
		},
		get_label: function () {
			return l10n.display;
		},
		get_title: function () {
			return l10n.display;
		}
	});
	
	var LoginSettings_Field_DisplayBehavior = Upfront.Views.Editor.Settings.Item.extend({
		className: 'display_behavior',
		events: function () {
			return _.extend({},
				Upfront.Views.Editor.Settings.Item.prototype.events,
				{"click": "register_change"}
			);
		},
		initialize: function () {
			var style = this.model.get_property_value_by_name("style");
			var hover_disabled = !style || "popup" == style;
			var behaviors = [
				{label: l10n.show_on_hover, value: "hover", disabled: hover_disabled},
				{label: l10n.show_on_click, value: "click"},
			];
			this.fields = _([
				new Upfront.Views.Editor.Field.Radios({
					model: this.model,
					property: "behavior",
					values: behaviors
				}),
			]);
		},
		render: function () {
			Upfront.Views.Editor.Settings.Item.prototype.render.call(this);
			this.$el
				.addClass("upfront_login-item-display_behavior")
				.find(".upfront-settings-item-content").addClass("clearfix").end()
				.hide()
			;

		},
		get_title: function () {
			return "Show Drop-Down Form on:";
		},
		register_change: function () {
			this.fields.each(function (field) {
				field.property.set({'value': field.get_value()}, {'silent': false});
			});
			this.trigger("login:behavior:changed");
		},
		update: function () {
			var style = this.model.get_property_value_by_name("style");
			this.initialize();
			this.$el.empty();
			this.render();
			if ("form" != style) this.$el.show();
		}
	});
	
	var LoginSettings_Field_DisplayAppearance = Login_SettingsItem_ComplexItem.extend({
		/*events: function () {
			return _.extend({},
				Upfront.Views.Editor.Settings.Item.prototype.events,
				{"change": "register_change"}
			);
		}*/
		initialize: function () {
			var me = this;
			var styles = [
				{label: l10n.on_page, value: "form"},
				{label: l10n.dropdown, value: "dropdown"},
				/*{label: l10n.in_lightbox, value: "popup"},*/
			];
			this.fields = _([
				new Upfront.Views.Editor.Field.Radios({
					model: this.model,
					property: "style",

					values: styles,
					change: function() { me.register_change(me) }
				}),
				new Upfront.Views.Editor.Field.Text({
					model: this.model,
					property: 'label_text',
					label: l10n.log_in_button,
					change: function() { me.register_change(me) }
				}),
			]);
		},
		render: function () {
			Upfront.Views.Editor.Settings.Item.prototype.render.call(this);
			this.$el.find(".upfront-settings-item-content").addClass("clearfix");
		},
		get_title: function () {
			return l10n.appearance;
		},
		register_change: function () {

			this.fields.each(function (field) {
				field.property.set({'value': field.get_value()}, {'silent': false});
			});
			this.trigger("login:appearance:changed");
		}
	});
	
	var LoginSettings_Field_DisplayTrigger = Login_SettingsItem_ComplexItem.extend({
		className: 'upfront_login-item-display_trigger',
		initialize: function () {
			var me = this;
			this.fields = _([
				new Upfront.Views.Editor.Field.Text({
					model: this.model,
					property: 'trigger_text',
					label: l10n.log_in_trigger,
					change: function() { me.register_change(me) }
				}),
			]);
		},
		register_change: function () {
			this.fields.each(function (field) {
				field.property.set({'value': field.get_value()}, {'silent': false});
			});
			//this.trigger("login:behavior:changed");
		},
		update: function () {
			var style = this.model.get_property_value_by_name("style");
			this.initialize();
			this.$el.empty();
			this.render();
			if ("form" != style) this.$el.show();
		},
		render: function () {
			Upfront.Views.Editor.Settings.Item.prototype.render.call(this);
			this.$el
				.find(".upfront-settings-item-content").addClass("clearfix").end()
				.hide()
			;
			this.$el.find('.upfront-settings-item-title').remove();
		},
		get_title: function () {
			return "";
		}
	});


	var LoginElement = Upfront.Views.Editor.Sidebar.Element.extend({
		priority: 160,

		render: function () {
			this.$el.addClass('upfront-icon-element upfront-icon-element-login');
			this.$el.html(l10n.element_name);
		},

		add_element: function () {

			var object = new LoginModel(),
				module = new Upfront.Models.Module({
					name: "",
					properties: [
						{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
						{"name": "class", "value": "c24 upfront-login_element-module"},
						{"name": "has_settings", "value": 0},
						{"name": "row", "value": Upfront.Util.height_to_row(210)}
					],
					objects: [object]
				})
			;
			this.add_module(module);
		}
	});
	Upfront.Application.LayoutEditor.add_object("Login", {
		"Model": LoginModel,
		"View": LoginView,
		"Element": LoginElement,
		"Settings": LoginSettings,
		cssSelectors: {
			'.upfront_login-form p': {label: l10n.css.containers, info: l10n.css.containers_info},
			'.upfront_login-form form label': {label: l10n.css.labels, info: l10n.css.labels_info},
			'.upfront_login-form form input:not([type=submit]):not([type=checkbox])': {label: l10n.css.inputs, info: l10n.css.inputs_info},
			'.upfront_login-form form  input[type=submit]': {label: l10n.css.button, info: l10n.css.button_info},
			'.upfront_login-form form  input[type=checkbox]': {label: l10n.css.remember, info: l10n.css.remember_info},
			'.login-lostpassword': {label: l10n.css.pwd_wrap, info: l10n.css.pwd_wrap_info},
			'.upfront_login-form p .login-lostpassword-link': {label: l10n.css.pwd_link, info: l10n.css.pwd_link_info},
			'.upfront_login-trigger': {label: l10n.css.close, info: l10n.css.close_info}
		},
		cssSelectorsId: Upfront.data.upfront_login.defaults.type
	});
	Upfront.Models.LoginModel = LoginModel;
	Upfront.Views.LoginView = LoginView;

});
})(jQuery);


define('text!elements/upfront-maps/css/edit.css',[],function () { return '.upfront-editable_entity .ufm-gmap-container img {\r\n  max-width: none !important;\r\n  max-height: none !important;\r\n}\r\n.upfront_map-fields-simple_location .upfront-field-wrap-text {\r\n\tfloat: left;\r\n\twidth: 80%;\r\n}\r\n.upfront_map-fields-simple_location .upfront-field-wrap-refresh button {\r\n\twidth: 24px;\r\n\theight: 30px;\r\n\tborder: none;\r\n\tbackground: none;\r\n\tpadding: 0;\r\n}\r\n#settings .upfront-settings-item-maps_element-location .upfront-settings-item {\r\n\tborder: none;\r\n\tpadding-right: 0;\r\n}\r\n#settings .ufpront-maps_element-settings_panel .upfront-settings_panel {\r\n\twidth: 240px;\r\n}\r\n#settings .ufpront-maps_element-settings_panel .upfront-settings_panel .upfront-settings_panel_scroll {\r\n\tmin-width: 240px;\r\n}\r\n.ufpront-maps_element-settings_panel .upfront-settings-css .upfront-field-select-single {\r\n  width: 180px;\r\n}\r\n\r\n.ufpront-maps_element-settings_panel .upfront-field-select {\r\n\twidth: 100%;\r\n}\r\n\r\n.ufm-context-menu{\r\nbackground:white;\r\n-webkit-border-radius: 3px;\r\n-moz-border-radius: 3px;\r\nborder-radius: 3px;\r\n}\r\n.ufm-context-menu-item{\r\npadding:0px 10px;\r\n}\r\n\r\n.ufm-context-menu-item:hover{\r\nbackground:#f0f0f0;\r\n}\r\n\r\n.ufm-context-menu .ufm-context-menu-item:first-child{\r\n-webkit-border-top-left-radius: 3px;\r\n-webkit-border-top-right-radius: 3px;\r\n-moz-border-radius-topleft: 3px;\r\n-moz-border-radius-topright: 3px;\r\nborder-top-left-radius: 3px;\r\nborder-top-right-radius: 3px;\r\n}\r\n.ufm-context-menu .ufm-context-menu-item:last-child{\r\n-webkit-border-bottom-right-radius: 3px;\r\n-webkit-border-bottom-left-radius: 3px;\r\n-moz-border-radius-bottomright: 3px;\r\n-moz-border-radius-bottomleft: 3px;\r\nborder-bottom-right-radius: 3px;\r\nborder-bottom-left-radius: 3px;\r\n}\r\n\r\n.ufm-map-marker-select{\r\nposition:absolute;\r\nbackground:white;\r\nborder:1px solid #cccccc;\r\npadding:10px;\r\n}\r\n\r\n.ufm-map-marker-select .marker-url label{\r\ndisplay: block;\r\nline-height: 20px;\r\n}\r\n\r\n.ufm-map-marker-select .marker-url [name="marker-url"]{\r\nwidth:100%;\r\nheight:44px;\r\n}\r\n\r\n.ufm-map-marker-select .marker-url{\r\nmargin-top: 10px;\r\n}\r\n\r\n.ufm-marker-demo{\r\nwidth:38px;\r\nheight:38px;\r\nline-height: 35px;\r\nborder:1px solid transparent;\r\n\r\ntext-align:center;\r\ndisplay:inline-block;\r\n}\r\n.ufm-marker-demo img{\r\ndisplay:inline-block;\r\nvertical-align: middle;\r\n}\r\n.ufm-marker-demo:hover{\r\nborder: 1px solid #cccccc;\r\ncursor: pointer;\r\n}\r\n.ufm-marker-demo.ufm-current{\r\nborder: 1px dashed #cccccc;\r\n}\r\n.ufm-marker-demo.ufm-current:hover{\r\nborder: 1px solid red;\r\n}\r\n\r\n\r\n\r\n.ufm-rounded{\r\n-webkit-border-radius: 3px;\r\n-moz-border-radius: 3px;\r\nborder-radius: 3px;\r\n}\r\n\r\n\r\n/* override upfront styles that cause visual google maps bugs */\r\n.upfront-map_module .upfront-editable_entity img {\r\nmax-width: none;\r\n}\r\n\r\n.marker-imgs{\r\nmax-height:120px;\r\noverflow-x: auto;\r\n}\r\n\r\n/* triagnle pointer */\r\n.ufm-map-marker-select{\r\nposition: relative;\r\n}\r\n.ufm-map-marker-select:after{\r\ncontent: \'\';\r\ndisplay: block;\r\nposition: absolute;\r\ntop: -20px;\r\nleft: 159px;\r\nwidth: 0;\r\nheight: 0;\r\nborder-color: transparent transparent #ffffff transparent;\r\nborder-style: solid;\r\nborder-width: 10px;\r\n}\r\n\r\n.ufm-map-marker-select:before{\r\ncontent: \'\';\r\ndisplay: block;\r\nposition: absolute;\r\ntop: -23px;\r\nleft: 158px;\r\nwidth: 0;\r\nheight: 0;\r\nborder-color: transparent transparent #cccccc transparent;\r\nborder-style: solid;\r\nborder-width: 11px;\r\n}\r\n\r\n.ufm-map-main img {\r\n\theight: auto;\r\n\twidth: auto;\r\n}\r\n\r\n/* initial experience layout */\r\n\r\n#upfront_map-location_overlay-wrapper,\r\n.uf_el_map_initial-overlay {\r\n\tfont-weight: 300;\r\n\tfont-size:20px;\r\n}\r\n\r\n.uf_el_map_initial-overlay {\r\n\theight: 150px;\r\n\tpadding:15px;\r\n}\r\n\r\n/* address input */\r\n.uf_el_map_initial-overlay input[type="text"] {\r\n\tbackground:rgb(201,201,195);\r\n\tfont-size: 1em;\r\n\twidth:100%;\r\n}\r\n.uf_el_map_initial-overlay input[type="text"]:focus {\r\n\tbackground:rgb(255,255,255);\r\n\tcolor:rgb(100,100,100);\r\n}\r\n\r\n/* refresh button */\r\n.uf_el_map_initial-overlay button {\r\n\tposition: absolute;\r\n\ttop: 0;\r\n\tright: 0;\r\n\tbackground-color: transparent;\r\n\tpadding: 10px;\r\n}\r\n\r\n.uf_el_map_initial-overlay button ,\r\n.uf_el_map_initial-overlay .uf-current-location {\r\n\tmargin:0;\r\n}\r\n\r\n.uf_el_map_initial-overlay .uf-address  {\r\n\tmargin:0 auto;\r\n\tmax-width:500px;\r\n\tposition: relative;\r\n\tmargin-bottom: 10px;\r\n}\r\n\r\n.uf-current-location {\r\n\tfont-size: 0.8em;\r\n\tmargin-top:10px;\r\n}\r\n/* Use My Location */\r\n.uf-current-location a {\r\n\tbackground:transparent;\r\n\tcolor:#395269;\r\n\ttext-decoration: underline;\r\n\tpadding:0;\r\n\tmargin:0;\r\n}\r\n.uf-current-location a:hover { cursor: pointer; }\r\n\r\n.uf_el_map_initial-overlay button,\r\n.uf_el_map_initial-overlay input { outline:none; }\r\n\r\n/* Missing default styles */\r\n.uf_el_map_initial-overlay input {\r\n\tpadding: 10px;\r\n\tborder: 1px solid #d0d0d0;\r\n}\r\n.uf_el_map_initial-overlay button {\r\n\tborder: 0;\r\n\tborder-radius: 2px;\r\n\tcursor: pointer;\r\n}\r\n\r\n/* Check your internet connection message */\r\n\r\n.ufm-gmap-container {\r\n\tbackground-color: rgb(227, 227, 220);\r\n\tdisplay:table;\r\n}\r\n\r\n.ufm-gmap-container p {\r\n\tdisplay: table-cell;\r\n\tvertical-align: middle;\r\n\ttext-align: center;\r\n}\r\n\r\n.ufm-gmap-container .upfront-util-icon:before {\r\n\tcontent: " ";\r\n\twidth:40px;\r\n\theight:40px;\r\n\tbackground-position: -472px -193px;\r\n\tbackground-color: rgb(255, 255, 255);\r\n\tposition: absolute;\r\n\ttop:15px;\r\n\tleft:15px;\r\n}\r\n\r\n.map_location {\r\n\tmargin-top: 10px;\r\n}\r\n\r\n.map-style, .map-zoom-level {\r\n\twidth: 225px;\r\n}\r\n\r\n.open-map-code-panel-button {\r\n\tmargin-top: -5px;\r\n\tpadding: 5px 0px 5px 10px;\r\n\tposition: relative;\r\n\ttop: 0px;\r\n\tborder-left: 2px solid #dae6f2;\r\n}\r\n\r\n.upfront_map-fields-simple_location .upfront-field-wrap-refresh button {\r\n\tbackground-image: linear-gradient(-179deg, #fafdff 0%, #f3faff 100%) !important;\r\n    border: 1px solid #a2bfda;\r\n\tborder-left: none;\r\n\theight: 26px;\r\n\twidth: 30px;\r\n}\r\n\r\n.draggable-checkbox {\r\n\tmargin-top: 15px;\r\n}\r\n\r\n.upfront_map-fields-simple_location .upfront-field-wrap-refresh button img {\r\n\topacity: 0.7;\r\n\twidth: 15px;\r\n\tmargin-top: 3px;\r\n}\r\n\r\n.upfront_map-fields-simple_location .upfront-field-wrap-text {\r\n\twidth: 84% !important;\r\n}\r\n\r\n.open-map-code-panel-button {\r\n\tmargin-top: -5px;\r\n\tpadding: 5px 0px 5px 10px;\r\n\tposition: relative;\r\n\ttop: 0px;\r\n\tborder-left: 2px solid #dae6f2;\r\n}\r\n\r\n.open-map-code-panel-button input {\r\n\tdisplay: inline-block;\r\n\theight: 26px;\r\n\tmax-height: 26px;\r\n\tborder-radius: 3px;\r\n\tfont-size: 11px;\r\n\tfont-weight: normal;\r\n\tfont-family: verdana, sans-serif;\r\n\tbackground-image: linear-gradient(-179deg, #fafdff 0%, #f3faff 100%);\r\n    border: 1px solid #a2bfda;\r\n    border-radius: 5px;\r\n    color: #6486a6;\r\n    padding: 4px 8px;\r\n    position: relative;\r\n}\r\n\r\n.open-map-code-panel-button input:hover {\r\n\tborder: 1px solid #a2bfda;\r\n}';});

(function ($) {

// I have removed logic that checks if google maps are loaded. In current
// app setup maps will always we loaded before this script.
define('upfront_maps',[
	'maps_context_menu',
	'text!elements/upfront-maps/css/edit.css',
	'scripts/upfront/element-settings/settings',
	'scripts/upfront/element-settings/root-settings-panel',
	'scripts/upfront/inline-panels/map-editor'
], function (_ctx, maps_style, ElementSettings, RootSettingsPanel, MapEditorView) {

	var DEFAULTS = {
		OPTIMUM_MAP_HEIGHT: 300,
		center: [-37.8180, 144.9760],
		zoom: 10,
		style: 'ROADMAP',
		use_custom_map_code: false,
		controls: {
			pan: false,
			zoom: false,
			map_type: false,
			scale: false,
			street_view: false,
			overview_map: false
		}
	};

	var l10n = Upfront.Settings.l10n.maps_element;

	$("head").append("<style>" + maps_style + "</style>");

	var MapModel = Upfront.Models.ObjectModel.extend({
		init: function () {
			var properties = _.clone(Upfront.data.umaps.defaults);

			DEFAULTS.center = properties.map_center; // Keep the center position as set on PHP side
			if (navigator && navigator.geolocation) delete(properties.map_center); // ... but do NOT initialize it as a model property

			properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + "-object");
			this.init_properties(properties);
		}
	});

	var Maps_Fields_Simple_Checkbox = Upfront.Views.Editor.Field.Checkboxes.extend({
		multiple: false
	});

	var Map_Fields_Simple_Refresh = Upfront.Views.Editor.Field.Text.extend({
		className: 'upfront-field-wrap upfront-field-wrap-refresh',
		events: function () {
			return _.extend(
				{},
				Upfront.Views.Editor.Field.Text.prototype.events,
				{click: "propagate_activation_request"}
			);
		},
		get_field_html: function () {
			return '<button type="button"><img src="' + Upfront.data.upfront_maps.root_url + 'img/refresh.png" /></button>';
		},
		propagate_activation_request: function (e) {
			e.preventDefault();
			e.stopPropagation();
			this.trigger("refresh");
		}
	});

	var Map_Fields_Simple_Location = Backbone.View.extend({
		className: "upfront_map-fields-simple_location map_location clearfix",
		events: {
			keypress: "wait_for_enter"
		},
		initialize: function (opts) {
			this.options = opts;
			if(! (this.model instanceof MapModel)){
				this.model = new MapModel({properties: this.model.get('properties')});
			}

			var options = _.extend({}, opts);

			this.options.field = new Upfront.Views.Editor.Field.Text(options);
			this.options.locate = new Map_Fields_Simple_Refresh(options);

			this.property = this.options.field.property;

			this.options.locate.on("refresh", this.geocode, this);
			this.model.on("options:location:geocode", this.geocode, this);
		},
		wait_for_enter: function (e) {
			if (13 == e.which) {
				e.stopPropagation();
				e.preventDefault();
				this.geocode();
			}
		},
		render: function () {
			this.$el.empty();

			this.options.locate.render();
			this.options.field.render();

			var address = this.model.get_property_value_by_name("address") || '';
			this.options.field.set_value(address);

			this.$el.append(this.options.field.$el);
			this.$el.append(this.options.locate.$el);
		},
		get_value: function () { return this.options.field.get_value(); },
		get_saved_value: function () { return this.options.field.get_saved_value(); },
		geocode: function () {
			if ("undefined" === typeof window.google) return false;
			var location = this.options.field.get_value(),
				element_id = this.model.get_property_value_by_name("element_id"),
				old_location = $(document).data(element_id + "-location"),
				old_address = this.model.get_property_value_by_name("address"),
				geocoder = new google.maps.Geocoder(),
				me = this
			;
			if (!location || location === old_location) return false;
			if (location === old_address) return false; // Do not re-geocode the same location
			if (this._geocoding_in_progress) return false;
			this._geocoding_in_progress = true;
			geocoder.geocode({address: location}, function (results, status) {
				if (status != google.maps.GeocoderStatus.OK) return false;
				var pos = results[0].geometry.location;
				var markers = me.model.get_property_value_by_name("markers") || [];
				markers.push({lat:pos.lat(), lng:pos.lng()});
				me.model.set_property("markers", markers, true);
				me.model.set_property("address", location, true);

				me.model.set_property("map_center", [pos.lat(), pos.lng()], false);

				$(document).data(element_id + "-location", location);
				me._geocoding_in_progress = false;
			});
		}
	});

	var UmapView = Upfront.Views.ObjectView.extend({
		map: false,

		init: function () {
			this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.refresh_map);
		},

		on_element_resize: function (attr) {
			//Refresh Map size when resize finish
			this.refresh_map();
		},

		on_render: function () {
			this.update_properties();
			var me = this,
				$el = this.$el.find('.ufm-gmap-container:first'),
				height = (this.model.get_breakpoint_property_value("row", true) ? this.model.get_breakpoint_property_value("row", true) : this.parent_module_view.model.get_breakpoint_property_value("row", true)),
				controls = this.model.get_property_value_by_name("controls") || [],
				props = {
					center: this.model.get_property_value_by_name("map_center") || DEFAULTS.center,
					zoom: parseInt(this.model.get_property_value_by_name("zoom"), 10) || DEFAULTS.zoom,
					type: this.model.get_property_value_by_name("style") || DEFAULTS.style,
					panControl: controls.indexOf("pan") >= 0 || DEFAULTS.controls.pan,
					zoomControl: controls.indexOf("zoom") >= 0 || DEFAULTS.controls.zoom,
					mapTypeControl: controls.indexOf("map_type") >= 0 || DEFAULTS.controls.map_type,
					scaleControl: controls.indexOf("scale") >= 0 || DEFAULTS.controls.scale,
					streetViewControl: controls.indexOf("street_view") >= 0 || DEFAULTS.controls.street_view,
					overviewMapControl: controls.indexOf("overview_map") >= 0 || DEFAULTS.controls.overview_map,
					style_overlay: (this.model.get_property_value_by_name("use_custom_map_code") ? JSON.parse(this.model.get_property_value_by_name("map_styles")) || false : false),
					draggable: !!this.model.get_property_value_by_name("draggable"),
					scrollwheel: !!this.model.get_property_value_by_name("scrollwheel")
				}
			;
			height = height ? parseInt(height,10) * Upfront.Settings.LayoutEditor.Grid.baseline : DEFAULTS.OPTIMUM_MAP_HEIGHT;
			$el.css({
				'width': '100%',
				'height': height + 'px'
			});
			$el.on('click mousedown mouseup', function(e){
			//$el.on('click', function(e){
				e.cancelBubble = true;
				if (e.stopPropagation) {
					e.stopPropagation();
				}
			});
			if ("undefined" !== typeof window.google) {
				this.map = new google.maps.Map($el.get(0), {
					center: new google.maps.LatLng(props.center[0], props.center[1]),
					zoom: props.zoom,
					mapTypeId: google.maps.MapTypeId[props.type],
					panControl: props.panControl,
					zoomControl: props.zoomControl,
					mapTypeControl: props.mapTypeControl,
					scaleControl: props.scaleControl,
					streetViewControl: props.streetViewControl,
					overviewMapControl: props.overviewMapControl,
					draggable: props.draggable,
					scrollwheel: props.scrollwheel
				});
				if (props.style_overlay) {
					this.map.setOptions({styles: props.style_overlay});
				}
				if (!this.model.get_property_value_by_name("map_center")) {
					this.add_location_overlay();
				}
				// Re-render the map when needed
				setTimeout(function () {
					var center = me.map.getCenter();
					google.maps.event.trigger(me.map, 'resize');
					me.map.setCenter(center);
				}, 300);
				this.add_stored_markers();
				this.init_rightclick_context_menu();
			} else {
				$el.html("<p class='upfront-util-icon'>" + l10n.connectivity_warning + "</p>");
			}
		},

		refresh_map: function () {
			var $el = this.$el.find('.ufm-gmap-container:first'),
				height = (this.model.get_breakpoint_property_value("row", true) ? this.model.get_breakpoint_property_value("row", true) : this.parent_module_view.model.get_breakpoint_property_value("row", true));
			height = height ? parseInt(height,10) * Upfront.Settings.LayoutEditor.Grid.baseline : DEFAULTS.OPTIMUM_MAP_HEIGHT;
			$el.css({
				'height': height + 'px'
			});
			google.maps.event.trigger(this.map, 'resize');
		},

		add_location_overlay: function () {
			var me = this,
				$location = this.$el.find("#upfront_map-location_overlay-wrapper")
			;
			if (!$location.length) {
				this.$el.append(
					'<div id="upfront_map-location_overlay-wrapper" class="upfront-initial-overlay-wrapper">' +
						'<div id="upfront_map-location_overlay" class="uf_el_map_initial-overlay upfront-initial-overlay-wrapper">' +
							'<p id="upfront_map-location_overlay-instruction">' + l10n.instructions + '</p>' +
							'<div id="upfront_map-location_overlay-address" class="upfront-ui uf-address">' +
								'<input type="text" id="upfront_map-location_overlay-location" placeholder="' + l10n.placeholder + '" />' +
								'<button type="button" id="upfront_map-location_overlay-use_location" class="upfront-field-icon upfront-icon-map-refresh"></button></div>' +
								'<span class="uf-current-location">' + l10n.or + ' <a id="upfront_map-location_overlay-use_current">' + l10n.use_current_location + '</a></span>' +
						'</div>' +
					'</div>'
				);
				$location = this.$el.find("#upfront_map-location_overlay-wrapper");
			}
			$location
				.find("#upfront_map-location_overlay-use_location").off("click").on("click", function () {
					var $address = me.$el.find("#upfront_map-location_overlay-wrapper #upfront_map-location_overlay-location"),
						geocoder = new google.maps.Geocoder(),
						element_id = me.model.get_property_value_by_name("element_id"),
						add = $address.length ? $address.val() : ''
					;
					if (!add) return false;

					geocoder.geocode({address: add}, function (results, status) {
						if (status != google.maps.GeocoderStatus.OK) return false;
						var pos = results[0].geometry.location;

						var markers = me.model.get_property_value_by_name("markers") || [];
						markers.push({lat:pos.lat(), lng:pos.lng()});
						me.model.set_property("markers", markers, true);
						me.model.set_property("address", add, true);

						me.model.set_property("map_center", [pos.lat(), pos.lng()], false);

						$(document).data(element_id + "-location", location);
					});
				}).end()
				.find("#upfront_map-location_overlay-location")
					.off("keydown").on("keydown", function (e) {
						if (13 === e.which) {
							$location.find("#upfront_map-location_overlay-use_location").click();
							Upfront.Events.trigger("upfront:element:edit:stop"); // Trigger this so we can drag maps with enter-submitted locations
						}
					})
					.off("click").on("click", function (e) {
						$(this).focus();
					})
				.end()
				.find("#upfront_map-location_overlay-use_current").off("click").on("click", function () {
					if (!(navigator && navigator.geolocation)) return false;
					var markers = me.model.get_property_value_by_name("markers") || [];
					navigator.geolocation.getCurrentPosition(function(position) {
						markers.push({lat:position.coords.latitude, lng:position.coords.longitude});
						me.model.set_property("markers", markers, true);
						me.model.set_property("map_center", [position.coords.latitude, position.coords.longitude], false);
					});
				}).end()
				.off("dblclick").on("dblclick", function (e) {
					e.preventDefault();
					e.stopPropagation();
				})
			;
			this.$el.find(".upfront-entity_meta").hide();
		},

		get_content_markup: function () {
			return '<div class="ufm-gmap-container"><p>' + l10n.hold_on + '</p></div>';
		},

		update_properties: function () {
			this.model.trigger("options:location:geocode");
		},

		center_map: function (lat, lng) {
			var pos = new google.maps.LatLng(lat, lng);
			this.map.setCenter(pos);
			this.model.set_property("map_center", [lat, lng]);
		},

		init_rightclick_context_menu: function () {
			//	create the ContextMenuOptions object
			var contextMenuOptions = {};
			contextMenuOptions.classNames={menu:'ufm-context-menu', menuSeparator:'context_menu_separator'};

			//	create an array of ContextMenuItem objects
			var menuItems=[];
			menuItems.push({className:'ufm-context-menu-item', eventName:'center_map', label:l10n.menu.center_map});
			menuItems.push({className:'ufm-context-menu-item', eventName:'add_marker', label:l10n.menu.add_marker});
			contextMenuOptions.menuItems=menuItems;

			//	create the ContextMenu object
			var contextMenu = new ContextMenu(this.map, contextMenuOptions);

			//	display the ContextMenu on a Map right click
			google.maps.event.addListener(this.map, 'rightclick', function (mouseEvent) {
				contextMenu.show(mouseEvent.latLng);
			});

			//	listen for the ContextMenu 'menu_item_selected' event
			var me = this;
			google.maps.event.addListener(contextMenu, 'menu_item_selected', function(latLng, eventName){
				//	latLng is the position of the ContextMenu
				//	eventName is the eventName defined for the clicked ContextMenuItem in the ContextMenuOptions
				switch(eventName){
					case 'add_marker':
						me.add_marker(latLng.lat(), latLng.lng());
					break;
					case 'center_map':
						me.center_map(latLng.lat(), latLng.lng());
					break;
				}
			});
		},

		init_marker_context_menu: function (marker) {
			var contextMenuOptions={};
			contextMenuOptions.classNames={menu:'ufm-context-menu', menuSeparator:'context_menu_separator'};

			//	create an array of ContextMenuItem objects
			var menuItems=[];
			menuItems.push({className:'ufm-context-menu-item', eventName:'remove_marker', label:l10n.menu.remove_marker});
			menuItems.push({className:'ufm-context-menu-item', eventName:'change_icon', label:l10n.menu.change_icon});
			contextMenuOptions.menuItems=menuItems;

			// create next context menu based on marker state
			var contextMenu = new ContextMenu(this.map, contextMenuOptions);

			google.maps.event.addListener(marker, 'rightclick', function(mouseEvent){
				contextMenu.show(mouseEvent.latLng);
			});

			var me = this;
			google.maps.event.addListener(contextMenu, 'menu_item_selected', function(latLng, eventName){
				switch(eventName){
					case 'remove_marker':
						me.remove_map_marker(marker);
						break;
					case 'change_icon':
						me.show_icon_select(marker);
						break;
				}
			});
		},

		add_marker: function (lat, lng) {
			var markers = this.model.get_property_value_by_name("markers") || [];
			markers.push({lat:lat, lng:lng});
			this.model.set_property("markers", markers);
			this.add_map_marker({lat:lat, lng:lng});
		},

		update_marker: function (marker) {
			var markers = this.model.get_property_value_by_name("markers") || [];
			_(markers).each(function (mrk, idx) {
				if (mrk.lat === marker.lat && mrk.lng === marker.lng) markers[idx] = marker;
			});
			this.model.set_property("markers", markers);
		},

		add_map_marker: function (marker) {
			if (!!this.model.get_property_value_by_name("hide_markers")) return false;
			var me = this,
				mrk = new google.maps.Marker({
					position: new google.maps.LatLng(marker.lat, marker.lng),
					draggable: false,
					icon: marker.icon ? marker.icon : '',
					map: this.map
				}),
				$info = $('<div contenteditable="true">' + (marker.content ? marker.content : l10n.edit_this) + '</div>'),
				info = new google.maps.InfoWindow({
					content: $info.get(0)
				})
			;
			mrk._raw = marker;
			$info.on('input', function () {
				marker.content = $info.text();
				me.update_marker(marker);
			});
			if (marker.is_open) info.open(me.map, mrk);
			google.maps.event.addListener(mrk, 'click', function() {
				if (!marker.is_open) {
					info.open(me.map, mrk);
					marker.is_open = true;
				} else {
					marker.is_open = false;
					info.close();
				}
				me.update_marker(marker);
			});
			this.init_marker_context_menu(mrk);
		},

		remove_map_marker: function (marker) {
			var pos = marker._raw,
				markers = this.model.get_property_value_by_name("markers") || [],
				new_markers = []
			;
			_(markers).each(function (mrk, idx) {
				if (mrk.lat !== pos.lat || mrk.lng !== pos.lng) new_markers.push(mrk);
			});
			this.model.set_property("markers", new_markers);
			marker.setMap(null);
		},

		add_stored_markers: function () {
			var me = this,
				markers = this.model.get_property_value_by_name("markers") || []
			;
			_(markers).each(function (marker) {
				me.add_map_marker(marker);
			});
		},

		show_icon_select: function (marker) {
			var IconSelectOverlay = this.get_icon_select_overlay();
			this.icon_select_overlay = new IconSelectOverlay(this.map, marker);
		},

		// Returns a function that is a subclass of google.maps.OverlayView.
		// The custom OverlayView displays alternative icons for map markers.
		get_icon_select_overlay: function (marker) {
			var map = this.map,
				me = this
			;
			function a(map, marker) {
				this.map = map;
				this.marker = marker;
				this.div = null;
				this.setMap(map);
			}

			a.prototype = new google.maps.OverlayView();

			a.prototype.onAdd = function() {
				var self = this;

				// create DOM node for overlay
				var t = $(
					'<div class="ufm-map-marker-select ufm-rounded">' +
						'<div class="marker-imgs"></div>' +
						'<div class="marker-url">' +
							'<label for="marker-url">' + l10n.image_url + '</label>' +
							'<textarea id="marker-url" name="marker-url" value="" rows="4"/></textarea>' +
						'</div>' +
					'</div>'
				); // t = template instance
				this.div = t.get(0);

				// add images
				var img_names = ['POI.png', 'arts.png', 'bar.png', 'blue-dot.png', 'blue-pushpin.png', 'blue.png', 'bus.png', 'cabs.png', 'camera.png', 'campfire.png', 'campground.png', 'casetta_base.png', 'casetta_brown.png', 'casetta_green.png', 'casetta_red.png', 'casetta_yellow.png', 'caution.png', 'coffeehouse.png', 'convienancestore.png', 'cycling.png', 'dollar.png', 'drinking_water.png', 'earthquake.png', 'electronics.png', 'euro.png', 'fallingrocks.png', 'ferry.png', 'firedept.png', 'fishing.png', 'flag.png', 'gas.png', 'golfer.png', 'grocerystore.png', 'hiker.png', 'homegardenbusiness.png', 'hospitals.png', 'info_circle.png', 'man.png', 'marina.png', 'marker.png', 'plane.png', 'snack_bar.png', 'sportvenue.png', 'toilets.png', 'trail.png', 'tree.png', 'wheel_chair_accessible.png', 'woman.png'],
					img_dir = Upfront.data.upfront_maps.markers,
					all_imgs = '';

				_.each(img_names, function(img){
					all_imgs = all_imgs + '<div class="ufm-marker-demo ufm-rounded"> <img src="'+img_dir+img+'" /> </div>';
				});

				$('.marker-imgs', t).html(all_imgs);

				// on image click set icon img src
				$('.marker-imgs img', t).on('click dblclick', function(){
					var contain = $(this).parent(),
						v = contain.hasClass('ufm-current') ?
								'' :
								$(this).attr('src');

					$('div', contain.parent()).removeClass('ufm-current');

					if(v!==''){
						contain.addClass('ufm-current');
					}
					url_textarea.val(v).trigger('change');

				});

				// close window on icon dbl click, or OK btn click
				$('.marker-imgs img', t).on('dblclick', function(){
					self.setMap(null);
				});
				$('.marker-url button', t).click(function(){
					self.setMap(null);
				});

				var url_textarea = $('.marker-url [name="marker-url"]', t);

				var a = this.marker.getIcon(),
					src = typeof a === 'string' ? a : '';

				$('img[src="'+src+'"]',t).parent().addClass('ufm-current');
				url_textarea.val(src);

				url_textarea.click(function(){this.focus();});

				url_textarea.on('input propertychange change', function(){
					var url = $(this).val();
					url = url === '' ? null : url;

					if(/png$/.test(url) || url === null){
						self.marker._raw.icon = url;
						me.update_marker(self.marker._raw);
						self.marker.setIcon(url);
					}
				});

				// prevent map zoom or pan when events occur on overlay DOM node
				var stopPropagation = function(e){
					e.cancelBubble = true;
					if (e.stopPropagation) {
						e.stopPropagation();
					}
				};
				google.maps.event.addDomListener(this.div, 'click', stopPropagation);
				google.maps.event.addDomListener(this.div, 'dblclick', stopPropagation);
				$(this.div).on('click mousedown mouseup', stopPropagation);

				// close overlay when user clicks on map
				var closeOverlay = function(e){
					self.setMap(null);
				};
				google.maps.event.addListener(this.map, 'click', closeOverlay);
				google.maps.event.addListener(this.map, 'rightclick', closeOverlay);

				var panes = this.getPanes();
				panes.floatPane.appendChild(this.div);
			};

			a.prototype.draw = function(){

				// Size and position the overlay. We use a southwest and northeast
				// position of the overlay to peg it to the correct position and size.
				// We need to retrieve the projection from this overlay to do this.
				var overlayProjection = this.getProjection();

				// Retrieve the southwest and northeast coordinates of this overlay
				// in latlngs and convert them to pixels coordinates.
				// We'll use these coordinates to resize the DIV.
				var latlng = this.marker.getPosition();
				var xy = overlayProjection.fromLatLngToDivPixel(latlng);

				// Resize the image's DIV to fit the indicated dimensions.
				var div = this.div;
				div.style.left = (xy.x-170) + 'px';
				div.style.top = (xy.y + 15) + 'px';
				div.style.width = '320px';
			};

			a.prototype.onRemove = function(){
				this.div.parentNode.removeChild(this.div);
				this.div = null;
			};

			return a;
		}
	});

	var MapElement = Upfront.Views.Editor.Sidebar.Element.extend({
		priority: 50,
		render: function () {
			this.$el.addClass('upfront-icon-element upfront-icon-element-maps');
			this.$el.html(l10n.element_name);
		},

		add_element: function () {
			var object = new MapModel(),
				module = new Upfront.Models.Module({
					"name": "",
					"properties": [
						{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
						{"name": "class", "value": "c12 upfront-map_element-module"},
						{"name": "has_settings", "value": 0},
						{"name": "row", "value": Upfront.Util.height_to_row(330)}
					],
					"objects": [object]
				})
			;
			this.add_module(module);
		}
	});

	var MapSettings_Panel = RootSettingsPanel.extend({
		title: l10n.general_settings,
		initialize: function (opts) {
			this.options = opts;
			this.settings = _([
				new MapSettings_Field_Location({model: this.model}),
				new MapSettings_Settings({model: this.model}),
				new Upfront.Views.Editor.Settings.Settings_CSS({model: this.model }),
			]);
		},

		get_label: function () {
			return l10n.label;
		},
		get_title: function () {
			return l10n.label;
		}
	});

	var MapSettings = ElementSettings.extend({
		panels: {
			'Settings' : MapSettings_Panel
		},
		title: l10n.settings
	});

	var MapSettings_Field_Location = Upfront.Views.Editor.Settings.Item.extend({
		className: "upfront-settings-item-maps_element-location general_settings_item",
		initialize: function () {
			this.fields = _([
				new Map_Fields_Simple_Location({
					model: this.model,
					hide_label: true,
					property: 'location'
				})
			]);
		},
		get_title: function () {
			return l10n.location_label;
		}
	});

	var MapSettings_Settings = Upfront.Views.Editor.Settings.Item.extend({
		events: {
			"click .open-map-code-panel-button": "init_code_panel"
		},
		className: "general_settings_item",
		initialize: function () {
			var zooms = [],
				saved_zoom = this.model.get_property_value_by_name("zoom")
			;
			if (!saved_zoom) this.model.set_property("zoom", DEFAULTS.zoom, true);
			_(_.range(1,19)).each(function (idx) {
				zooms.push({label: idx, value: idx});
			});
			var saved_style = this.model.get_property_value_by_name("style"),
				styles = [
					{label: l10n.style.roadmap, value: "ROADMAP"},
					{label: l10n.style.satellite, value: "SATELLITE"},
					{label: l10n.style.hybrid, value: "HYBRID"},
					{label: l10n.style.terrain, value: "TERRAIN"},
				]
			;
			if (!saved_style) this.model.set_property("style", DEFAULTS.style, true);
			var controls = [
				{label: l10n.ctrl.pan, value: "pan"},
				{label: l10n.ctrl.zoom, value: "zoom"},
				{label: l10n.ctrl.type, value: "map_type"},
				{label: l10n.ctrl.scale, value: "scale"},
				{label: l10n.ctrl.street_view, value: "street_view"},
				{label: l10n.ctrl.overview, value: "overview_map"},
			];
			this.fields = _([
				new Upfront.Views.Editor.Field.Slider({
					className: 'upfront-field-wrap upfront-field-wrap-slider map-zoom-level',
					model: this.model,
					label: l10n.zoom_level,
					property: 'zoom',
					min: 1,
					max: 19,
					change: function () { this.property.set({value: this.get_value()}); }
				}),
				new Upfront.Views.Editor.Field.Select({
					model: this.model,
					label: l10n.map_style,
					className: 'map-style',
					property: 'style',
					values: styles,
					change: function () { this.property.set({value: this.get_value()}); }
				}),
				new Upfront.Views.Editor.Field.Multiple_Chosen_Select({
					model: this.model,
					label: l10n.map_controls,
					placeholder: "Choose map controls",
					property: 'controls',
					select_width: '225px',
					multiple: true,
					values: controls,
					change: function () { this.property.set({value: this.get_value()}); }
				}),
				new Upfront.Views.Editor.Field.Checkboxes({
					model: this.model,
					label: l10n.draggable_map,
					property: "draggable",
					className: 'draggable-checkbox',
					hide_label: true,
					values: [{label: l10n.draggable_map, value: 1}],
					multiple: false,
					change: function () { this.property.set({value: this.get_value()}); }
				}),
				new Upfront.Views.Editor.Field.Checkboxes({
					model: this.model,
					label: l10n.hide_markers,
					className: 'markers-checkbox',
					property: "hide_markers",
					hide_label: true,
					values: [{label: l10n.hide_markers, value: 1}],
					multiple: false,
					change: function () { this.property.set({value: this.get_value()}); }
				}),
				new Upfront.Views.Editor.Field.Checkboxes({
					model: this.model,
					label: l10n.use_custom_map_code,
					property: "use_custom_map_code",
					className: "upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes custom-map-code",
					hide_label: true,
					values: [{label: l10n.use_custom_map_code + '<span class="checkbox-info" title="' + l10n.use_custom_map_code_info + '"></span>', value: 1}],
					multiple: false,
					change: function () {
						var value = this.get_value();

						this.property.set({value: value});
					},
					show: function (value, $el) {
						if(value == 1) {
							$('.open-map-code-panel-button', $el.parent()).show();
						}
						else {
							$('.open-map-code-panel-button', $el.parent()).hide();
						}
					}
				}),
				new Upfront.Views.Editor.Field.Button({
					model: this.model,
					label: l10n.open_map_code_panel,
					className: "open-map-code-panel-button",
					compact: true
				}),
			]);
		},
		get_title: function () {
			return l10n.settings;
		},
		init_code_panel: function () {
			var view = new MapEditorView({model: this.model});
			view.render();
		}
	});

	Upfront.Application.LayoutEditor.add_object("Map", {
		"Model": MapModel,
		"View": UmapView,
		"Element": MapElement,
		"Settings": MapSettings,
		cssSelectors: {
			'.ufm-gmap-container': {label: l10n.css.label, info: l10n.css.info}
		},
		cssSelectorsId: Upfront.data.umaps.defaults.type
	});
	Upfront.Models.MapModel = MapModel;
	Upfront.Views.UmapView = UmapView;
});

})(jQuery);

define('elements/upfront-newnavigation/js/menuitem',[
	"scripts/upfront/link-model"
], function(LinkModel) {
return (function ($) {
	var l10n = Upfront.Settings.l10n.newnavigation_element;

	var MenuItemView = Backbone.View.extend({
		tagName: 'li',
		contextmenuContext: [],
		removeContexts: true,

		events: {
			'click i.delete_menu_item' : 'deleteMenuItem',
			'click i.navigation-add-item': 'addMenuItem',
			"contextmenu a.menu_item": "on_context_menu",
			"click a.menu_item": "on_click",
			"touchstart a.menu_item": "on_click",
			'click a.redactor_act': 'onOpenPanelClick',
			'click .sub-menu': 'onOpenPanelSubMenu',
			'click .upfront-save_settings': 'onOpenPanelSubMenu',
			'click .upfront-save_settings': 'processPanelsOnSave',
			'click > .open-item-controls': 'onOpenItemControlsClick',
			'mouseover': 'onItemOver',
			'mouseout': 'onItemOut'
		},
		initialize: function(options) {
			var me = this;

			// Ensure that there is a link property
			if (typeof options.model.link === 'undefined') {
				options.model.link = {
					'type': Upfront.Util.guessLinkType(this.model['menu-item-url']),
					'url': this.model['menu-item-url'],
					'target': this.model['menu-item-target']
				};
			}

			this.link = new LinkModel(this.model.link);

			this.parent_view = options.parent_view;
			this.newitem = options.newitem;
			this.level = options.level;
			_.bindAll(this, 'render');

			var ContextMenuList = Upfront.Views.ContextMenuList.extend({
				initialize: function(opts) {
					this.options = opts;
					this.for_view = this.options.for_view;
					this.menuitems = _([
						new Upfront.Views.ContextMenuItem({
							get_label: function() {
								var linktype = me.model.link.type;
								if(linktype == 'lightbox')
									return 'Open Lightbox';
								else if(linktype == 'anchor')
									return 'Scroll to Anchor';
								else if(linktype == 'entry')
									return 'Visit Post/Page';
								else
									return 'Visit Link';
							},
							action: function() {
								Upfront.Util.visitLink(me.model.link.url);
							}
						}),
						new Upfront.Views.ContextMenuItem({
							get_label: function() {
								return l10n.edit_url;
							},
							action: function() {
								me.removeContexts = false;
								me.editMenuItem();
							}
						}),
						new Upfront.Views.ContextMenuItem({
							get_label: function() {
								return l10n.create_dropdown;
							},
							action: function() {
								me.removeContexts = false;
								me.createDropDown(me.event);
							}
						})
					]);
				}
			});

			this.ContextMenu = Upfront.Views.ContextMenu.extend({
				initialize: function(opts) {
					this.options = opts;
					this.for_view = this.options.for_view;

					this.menulists = _([
						new ContextMenuList({for_view: this.for_view})
					]);

				}
			});

			Upfront.Events.on("entity:contextmenu:deactivate", this.remove_context_menu, this);
		},

		loadContexts: function(element) {
			if(this.contextmenuContext.length > 10) return;

			var menu = element.parent().parent('ul');

			if(menu.length > 0 && menu.hasClass('sub-menu')) {
				menu.addClass('time_being_display');
				this.contextmenuContext.push(menu);
				this.loadContexts(menu);
			}
		},
		on_click: function(e) {

			//e.preventDefault();

			var linkitem = $(e.target).parent('li.menu-item');
			//console.log(linkitem);
			//console.log(linkitem.closest('.upfront-output-unewnavigation').data('style'))
			if(linkitem.hasClass('parent') && linkitem.closest('.upfront-output-unewnavigation').data('style') == 'burger') {
				e.stopPropagation();

				if(linkitem.hasClass('burger_sub_display'))
					linkitem.removeClass('burger_sub_display');
				else
					linkitem.addClass('burger_sub_display');

				var menu = linkitem.closest('ul.menu');
				var menucontainer = linkitem.closest('div.upfront-output-unewnavigation');

				if(menucontainer.data('burger_over') == 'pushes' && (menucontainer.data('burger_alignment') == 'top' || menucontainer.data('burger_alignment') == 'whole')) {

					$('section.upfront-layout').css('margin-top', menu.height());


					var topbar_height = $('div#upfront-ui-topbar').outerHeight();
					var ruler_height = $('.upfront-ruler-container').outerHeight();
					menu.offset({top:topbar_height+ruler_height, left:$('section.upfront-layout').offset().left});


				}
			}
		},
		on_context_menu: function(e) {
			if (Upfront.Settings.Application.no_context_menu) return;

			e.stopPropagation();
			if(this.parent_view.$el.find('ul.menu').hasClass('edit_mode')) return;

			this.closeTooltip();
			e.preventDefault();

			if($(e.target).closest('ul').hasClass('sub-menu')) {
				this.contextmenuContext.push($(e.target).closest('ul').addClass('time_being_display'));
				this.loadContexts($(e.target).closest('ul'));
			}

			this.event = e;
			context_menu_view = new this.ContextMenu({
				model: this.model,
				for_view: this,
				el: $(Upfront.Settings.LayoutEditor.Selectors.contextmenu)
			});
			this.context_menu_view = context_menu_view;
			context_menu_view.render();

		},
		remove_context_menu: function(e) {
			if (!this.context_menu_view) return false;

			if(this.contextmenuContext.length > 0) {
				if(this.removeContexts) for(var i = 0; i < 	this.contextmenuContext.length; i++) {
					this.contextmenuContext[i].removeClass('time_being_display');
				}
				this.contextmenuContext = [];
				this.removeContexts = true;
			}

			$(Upfront.Settings.LayoutEditor.Selectors.contextmenu).html('').hide();
			this.context_menu_view = false;
		},

		onOpenPanelClick: function(event) {
			event.preventDefault();
			this.toggleLinkPanel();
		},

		onOpenPanelSubMenuClick: function(event) {
			//event.preventDefault();
			this.onOpenPanelSubMenu();
		},

		onOpenPanelSubMenu: function() {
			var me = this;
			if (this.$el.hasClass('ui-sortable-handle') && this.$el.children('ul').children('li').hasClass('controls-visible')) {
				this.$el.children('ul').sortable('disable');
			} else {
				this.$el.addClass('ui-sortable-handle');
				//this.$el.children('ul').sortable('enable');
				//this.$el.parent('ul').sortable('enable');
			}
		},
		processPanelsOnSave: function() {
			this.parent_view.$el.find('ul.time_being_display').removeClass('time_being_display');
			this.toggleLinkPanel();
			this.$el.removeClass('controls-visible');
			this.setItemControlsState();
		},
		toggleLinkPanel: function() {
			var me = this;
			if (this.$el.hasClass('ui-sortable-handle')) {
				this.$el.removeClass('ui-sortable-handle');
				this.$el.addClass('stayOpen controls-visible');
				this.$el.parents('.menu').sortable('disable');
				this.$el.find('.linkingPanelGoesHere').show();
			} else {
				this.$el.addClass('ui-sortable-handle');
				this.$el.removeClass('stayOpen');
				this.$el.parents('.menu').sortable('enable');
				this.$el.find('.linkingPanelGoesHere').hide();
			}
		},

		render: function (event) {
			var me = this;
			var content = '<a class="menu_item uf-click-to-edit-text';

			if(me.newitem) content = content + ' new_menu_item menu_item_placeholder';

			content = content+'" >'+this.model['menu-item-title']+'</a><i class="delete_menu_item">x</i><span class="open-item-controls"></span>';

			if(this.model.link['url'].indexOf('#ltb-') > -1 && !Upfront.Util.checkLightbox(this.model.link['url']))
					content = content + '<span class="missing-lightbox-warning"></span>';

			$(this.el).html(content).addClass('menu-item-depth-'+me.level);
			$(this.el).data('depth', me.level);
			this.createInlineControlPanel();

			$(this.el).data('backboneview', me).addClass('menu-item');
			if(me.newitem) $(this.el).addClass('new_menu_item');

			return this;
		},

		onOpenItemControlsClick: function() {
			var parent = this.$el.parent('ul');
			if(typeof parent !== "undefined" && parent.hasClass('time_being_display')) {
				parent.removeClass('time_being_display');
			}
			this.$el.toggleClass('controls-visible');
			this.setItemControlsState();
		},

		setItemControlsState: function() {
			if (this.$el.hasClass('controls-visible')) {
				this.controlsVisible = true;
				this.$el.siblings().removeClass('controls-visible');
				this.$el.data('linkpanel').render();

				this.$el.parents('.menu').sortable('disable');

				var currentcontext = this.$el.closest('ul');

				while(currentcontext.length > 0 && currentcontext.hasClass('sub-menu')) {
					currentcontext.addClass('time_being_display');
					currentcontext = currentcontext.parent().parent('ul');
				}

			} else {
				this.controlsVisible = false;
				if (this.$el.parents('.menu').find('.controls-visible').length === 0) {
					this.$el.parents('.menu').sortable('enable');
				}
			}
		},

		createInlineControlPanel: function() {
			var panel = new Upfront.Views.Editor.InlinePanels.ControlPanel(),
				visitLinkControl = new Upfront.Views.Editor.InlinePanels.Controls.VisitLink({
					url: this.model.link['url']
				}),
				linkPanelControl = new Upfront.Views.Editor.InlinePanels.Controls.LinkPanel({
					model: this.link,
					button: false,
					icon: 'link',
					tooltip: 'link',
					id: 'link'
				}),
				me = this;

			panel.items = _([
				linkPanelControl,
				visitLinkControl
			]);

			this.listenTo(this.link, 'change', function() {
				me.model.link = me.link.toJSON();
				me.model['menu-item-url'] = me.model.link.url;
				me.model['menu-item-target'] = me.model.link.target;
				visitLinkControl.setLink(me.model.link.url, me.model.link.type);
				me.saveLink();
			});

			this.$el.data('linkpanel', linkPanelControl);
			var imageControlsTpl = '<div class="uimage-controls image-element-controls upfront-ui"></div>';
			this.$el.append(imageControlsTpl);
			panel.render();
			this.$el.find('.uimage-controls').append(panel.el);
			panel.delegateEvents();
		},

		createDropDown: function(e) {
			var placeholder = $('<ul>').addClass('sub-menu').addClass('time_being_display');
			$(e.target).closest('li').append(placeholder);
			this.parent_view.addMenuItem(placeholder);
			this.parent_view.makeSortable();
		},

		addMenuItem: function(e) {
			e.preventDefault();
			e.stopPropagation();
			this.parent_view.addMenuItem(e);
		},

		deleteMenuItem: function(e) {

			var me = this;

			var parentlist = me.$el.parent('ul');
			var newitemicon = me.$el.parent('ul').find('i.navigation-add-item');
			var removeparent = false;
			var parentview = this.parent_view;

			if(me.$el.siblings().length < 1) {
				removeparent = true;
			}

			var neworder = parentview.new_menu_order(me.model['menu-item-db-id']);
			this.closeTooltip();
			me.$el.remove();

			if(removeparent) parentlist.remove();

			parentlist.children('li:last').append(newitemicon);

			if(typeof me.model['menu-item-db-id'] != 'undefined') {
				//console.log('ajax call to set delete menu item');
				Upfront.Util.post({"action": "upfront_new_delete_menu_item", "menu_item_id": me.model['menu-item-db-id'], "new_menu_order" : neworder})
					.success(function (ret) {
						if(me.$el.find('ul.sub-menu').length > 0)
							parentview.render();
					})
					.error(function (ret) {
						Upfront.Util.log("Error Deleting Menu Item");
					})
				;
			}

			setTimeout(function(){
				Upfront.Events.trigger("menu_element:edit");
			}, 100);
		},

		editMenuItem: function() {
			console.log('toggleLinkPanel');
			this.toggleLinkPanel();
		},

		getCleanurl: function(url) {
			//this one removes any existing # anchor postfix from the url
			var urlParts;
			if(!url){
				url = location.href;
			}

			if(url.indexOf('?dev=true') != -1) url = url.replace('?dev=true', '');

			if(url.indexOf('#') == -1) return url;

			urlParts = url.split('#');

			if(urlParts[0].trim() != '')
				return urlParts[0];
			else
				return location.href.replace('?dev=true', '');
		},

		saveLink: function(remove, keep) {
			var me = this;

			if(typeof(remove) != 'undefined' && remove) {
				me.deleteMenuItem();
				return;
			}

			me.$el.find('a.new_menu_item').removeClass('new_menu_item');
			me.$el.removeClass('new_menu_item');

			//me.parent_view.$el.find('ul.time_being_display').removeClass('time_being_display');

			var menu_item = ($(this.el).children('a.menu_item').length > 0) ?
				$(this.el).children('a.menu_item'):$(this.el).children('div').children('a.menu_item');

			if (!menu_item.hasClass('menu_item_placeholder') && menu_item.next('a.ueditor-placeholder').length < 1) {
				this.model['menu-item-title'] = menu_item.text();
			} else {
				this.model['menu-item-title'] = '';
			}

			if ($(this.el).children('div.redactor_box').length > 0) {
				menu_item.blur();
			}

			if (me.model['menu-item-title'].trim() == '') {
				if (typeof(keep) != 'undefined' && keep) {
					var title_text = menu_item.next('a.ueditor-placeholder').text() || (menu_item.is("a.menu_item_placeholder") ? menu_item.text() : '');
					me.model['menu-item-title'] = title_text;
				} else {
					me.deleteMenuItem();
					return;
				}
			}

			var postdata = {
				'action': "upfront_new_update_menu_item",
				'menu': me.parent_view.model.get_property_value_by_name('menu_id') ,
				'menu-item': this.model
			}

			if (typeof this.model['menu-item-db-id'] != 'undefined') {
				postdata['menu-item-id'] = me.model['menu-item-db-id'];
			}

			//console.log('ajax call to new update menu item');
			Upfront.Util.post(postdata)
				.success(function (ret) {
					me.model['menu-item-db-id'] = ret.data;
					//Triggering this event is causing nav to re-render and hide Link Panel
					//Upfront.Events.trigger("menu_element:edit");
				})
				.error(function (ret) {
					Upfront.Util.log("Error updating menu item");
				})
			;
		},

		openTooltip: function(content, element) {
			var tooltip = $('#unewnavigation-tooltip'),
				elementPosition = element.offset(),
				tooltipPosition = {
					top: elementPosition.top + element.outerHeight() + 11,
					left: elementPosition.left - 98 + Math.floor(element.outerWidth() / 2)
				},
				tooltipClass = 'unewnavigation-tooltip-bottom',
				me = this
			;
			if(!tooltip.length){
				tooltip = $('<div id="unewnavigation-tooltip" class="upfront-ui"></div>');
				$('body').append(tooltip);
			}
			tooltip.hide().html(content);
			elementPosition.right = elementPosition.left + element.width();
			if(elementPosition.left - 280 < 0){
				tooltipPosition.left = elementPosition.left + element.width() + 20;
				tooltipClass = 'unewnavigation-tooltip-bottom';
			}
			tooltip
				.css(tooltipPosition)
				.addClass(tooltipClass)
				.show()
				.on('click', function(e){
					e.stopPropagation();
				})
				.on('closed', function(e){
					me.$el.removeClass('tooltip-open');
				})
			;

			this.$el.addClass('tooltip-open');

			val = $('#unewnavigation-tooltip').find('input[name=unavigation-link-type]:checked').val();
			if( val == 'anchor') {
				this.addAnchorsselect();
			}
			if( val == 'lightbox') {
				this.addLightboxselect();
			}
			Upfront.Events.trigger("entity:settings:deactivate");
		},

		closeTooltip: function(){
			var tooltip = $('#unewnavigation-tooltip');
			tooltip.hide().trigger('closed');
			setTimeout(function(){
				tooltip.remove();
			}, 100);
		},

		onItemOver: function(){
			this.$el.parents('.upfront-module').find('.upfront-resize-handle-s').addClass('active-menu-item');
		},

		onItemOut: function(){
			this.$el.parents('.upfront-module').find('.upfront-resize-handle-s').removeClass('active-menu-item');
		},
	});

	return MenuItemView;
})(jQuery);
});

define('elements/upfront-newnavigation/js/model',[],function() {
	var UnewnavigationModel = Upfront.Models.ObjectModel.extend({
		/**
		 * A quasi-constructor, called after actual constructor *and* the built-in `initialize()` method.
		 * Used for setting up instance defaults, initialization and the like.
		 */
		init: function () {
			var properties = _.clone(Upfront.data.unewnavigation.defaults);
			properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + "-object");
			this.init_properties(properties);

		}
	});

	return UnewnavigationModel;
});
define('elements/upfront-newnavigation/js/element',[
	'elements/upfront-newnavigation/js/model'
], function(UnewnavigationModel) {
	
	var l10n = Upfront.Settings.l10n.newnavigation_element;

	var UnewnavigationElement = Upfront.Views.Editor.Sidebar.Element.extend({
			priority: 60,
		/**
		 * Set up element appearance that will be displayed on sidebar panel.
		 */
		render: function () {
			this.$el.addClass('upfront-icon-element upfront-icon-element-nav');
			this.$el.html(l10n.element_name);
		},

		/**
		 * This will be called by editor to request module instantiation, set
		 * the default module appearance here
		 */
		add_element: function () {
			var object = new UnewnavigationModel(), // Instantiate the model
				// Since newnavigation entity is an object,
				// we don't need a specific module instance -
				// we're wrapping the newnavigation entity in
				// an anonymous general-purpose module
				module = new Upfront.Models.Module({
					"name": "",
					"properties": [
						{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
						{"name": "class", "value": "c24 upfront-newnavigation_module"},
						{"name": "has_settings", "value": 0},
						{"name": "row", "value": Upfront.Util.height_to_row(75)}
					],
					"objects": [
						object // The anonymous module will contain our newnavigation object model
					]
				})
			;
			// We instantiated the module, add it to the workspace
			this.add_module(module);
		}
	});

	return UnewnavigationElement;
});

define('text!elements/upfront-newnavigation/tpl/preset-style.html',[],function () { return 'div.<?php echo $properties[\'id\'] ?> ul.menu {\r\n\t<?php if(!empty($properties[\'static-nav-bg\'])) { ?>\r\n\tbackground: <?php echo $properties[\'static-nav-bg\'] ?>;\r\n\t<?php } ?>\r\n\t<?php if(!empty($properties[\'breakpoint\']) && !empty($properties[\'breakpoint\'][\'desktop\']) && !empty($properties[\'breakpoint\'][\'desktop\'][\'menu_alignment\'])) { ?>\r\n\t\ttext-align: <?php echo $properties[\'breakpoint\'][\'desktop\'][\'menu_alignment\'] ?> !important;\r\n\t<?php } else if(!empty($properties[\'breakpoint\']) && !empty($properties[\'breakpoint\'][\'table\']) && !empty($properties[\'breakpoint\'][\'table\'][\'menu_alignment\'])) { ?>\r\n\t\ttext-align: <?php echo $properties[\'breakpoint\'][\'table\'][\'menu_alignment\'] ?> !important;\r\n\t<?php } else if(!empty($properties[\'breakpoint\']) && !empty($properties[\'breakpoint\'][\'mobile\']) && !empty($properties[\'breakpoint\'][\'mobile\'][\'menu_alignment\'])) { ?>\r\n\t\ttext-align: <?php echo $properties[\'breakpoint\'][\'mobile\'][\'menu_alignment\'] ?> !important;\r\n\t<?php } else { ?>\r\n\t\ttext-align: <?php echo $properties[\'menu_alignment\'] ?> !important;\r\n\t<?php } ?>\r\n}\r\n\r\ndiv.<?php echo $properties[\'id\'] ?> ul.menu > li.menu-item > a {\r\n\t<?php if(!empty($properties[\'static-font-color\'])) { ?>color: <?php echo $properties[\'static-font-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'static-font-family\'])) { ?>font-family: <?php echo $properties[\'static-font-family\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'static-font-size\'])) { ?>font-size: <?php echo $properties[\'static-font-size\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'static-weight\'])) { ?>font-weight: <?php echo $properties[\'static-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'static-style\'])) { ?>font-style: <?php echo $properties[\'static-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'static-line-height\'])) { ?>line-height: <?php echo $properties[\'static-line-height\']  ?>;<?php } ?>\r\n}\r\n\r\ndiv.<?php echo $properties[\'id\'] ?> ul.menu > li.menu-item > a:hover, div.upfront-navigation.<?php echo $properties[\'id\']  ?>.live-preview-hover ul.menu > li.menu-item > a {\r\n\t<?php if(!empty($properties[\'hover-use-typography\'])) { ?>\r\n\t\t<?php if(!empty($properties[\'hover-font-color\'])) { ?>color: <?php echo $properties[\'hover-font-color\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-font-family\'])) { ?>font-family: <?php echo $properties[\'hover-font-family\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-font-size\'])) { ?>font-size: <?php echo $properties[\'hover-font-size\']  ?>px; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-weight\'])) { ?>font-weight: <?php echo $properties[\'hover-weight\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-style\'])) { ?>font-style: <?php echo $properties[\'hover-style\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-line-height\'])) { ?>line-height: <?php echo $properties[\'hover-line-height\']  ?>;<?php } ?>\r\n\t<?php } else { ?>\r\n\t\t<?php if(!empty($properties[\'static-font-color\'])) { ?>color: <?php echo $properties[\'static-font-color\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-font-family\'])) { ?>font-family: <?php echo $properties[\'static-font-family\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-font-size\'])) { ?>font-size: <?php echo $properties[\'static-font-size\']  ?>px; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-weight\'])) { ?>font-weight: <?php echo $properties[\'static-weight\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-style\'])) { ?>font-style: <?php echo $properties[\'static-style\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-line-height\'])) { ?>line-height: <?php echo $properties[\'static-line-height\']  ?>;<?php } ?>\r\n\t<?php } ?>\r\n}\r\n\r\ndiv.<?php echo $properties[\'id\'] ?> ul.menu > li.menu-item > a:focus, div.upfront-navigation.<?php echo $properties[\'id\']  ?>.live-preview-focus ul.menu > li.menu-item > a {\r\n\t<?php if(!empty($properties[\'focus-use-typography\'])) { ?>\r\n\t\t<?php if(!empty($properties[\'focus-font-color\'])) { ?>color: <?php echo $properties[\'focus-font-color\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'focus-font-family\'])) { ?>font-family: <?php echo $properties[\'focus-font-family\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'focus-font-size\'])) { ?>font-size: <?php echo $properties[\'focus-font-size\']  ?>px; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'focus-weight\'])) { ?>font-weight: <?php echo $properties[\'focus-weight\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'focus-style\'])) { ?>font-style: <?php echo $properties[\'focus-style\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'focus-line-height\'])) { ?>line-height: <?php echo $properties[\'focus-line-height\']  ?>;<?php } ?>\r\n\t<?php } else { ?>\r\n\t\t<?php if(!empty($properties[\'static-font-color\'])) { ?>color: <?php echo $properties[\'static-font-color\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-font-family\'])) { ?>font-family: <?php echo $properties[\'static-font-family\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-font-size\'])) { ?>font-size: <?php echo $properties[\'static-font-size\']  ?>px; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-weight\'])) { ?>font-weight: <?php echo $properties[\'static-weight\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-style\'])) { ?>font-style: <?php echo $properties[\'static-style\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-line-height\'])) { ?>line-height: <?php echo $properties[\'static-line-height\']  ?>;<?php } ?>\r\n\t<?php } ?>\r\n}\r\n\r\n<?php if(!empty($properties[\'tablet\'])) { ?>\r\n.tablet-breakpoint div.<?php echo $properties[\'id\'] ?> ul.menu {\r\n\t<?php if(!empty($properties[\'tablet\'][\'menu_alignment\'])) { ?>text-align: <?php echo $properties[\'tablet\'][\'menu_alignment\'] ?>!important;<?php } ?>\r\n}\r\n<?php if(!empty($properties[\'tablet\'][\'preset_style\'])) { ?><?php echo $properties[\'tablet\'][\'preset_style\'] ?><?php } ?>\r\n<?php } ?>\r\n\r\n<?php if(!empty($properties[\'mobile\'])) { ?>\r\n.mobile-breakpoint div.<?php echo $properties[\'id\'] ?> ul.menu {\r\n\t<?php if(!empty($properties[\'mobile\'][\'menu_alignment\'])) { ?>text-align: <?php echo $properties[\'mobile\'][\'menu_alignment\'] ?>!important;<?php } ?>\r\n}\r\n<?php if(!empty($properties[\'mobile\'][\'preset_style\'])) { ?><?php echo $properties[\'mobile\'][\'preset_style\'] ?><?php } ?>\r\n<?php } ?>\r\n\r\n<?php if(!empty($properties[\'breakpoint\']) && !empty($properties[\'breakpoint\'][\'desktop\']) && !empty($properties[\'breakpoint\'][\'desktop\'][\'preset_style\'])) { ?>\r\n\t<?php if(!empty($properties[\'breakpoint\'][\'desktop\'][\'preset_style\'])) { ?><?php echo $properties[\'breakpoint\'][\'desktop\'][\'preset_style\'] ?><?php } ?>\r\n<?php } else { ?>\r\n\t<?php if(!empty($properties[\'preset_style\'])) { ?><?php echo $properties[\'preset_style\'] ?><?php } ?>\r\n<?php } ?>';});

define('elements/upfront-newnavigation/js/settings/appearance-panel',[
	'scripts/upfront/preset-settings/util',
	'text!elements/upfront-newnavigation/tpl/preset-style.html'
], function(Util, styleTpl) {
		var l10n = Upfront.Settings.l10n.newnavigation_element;

		var AppearancePanel = {
			mainDataCollection: 'navPresets',
			styleElementPrefix: 'nav-preset',
			ajaxActionSlug: 'nav',
			panelTitle: l10n.settings,
			presetDefaults: Upfront.mainData.presetDefaults.nav,
			styleTpl: styleTpl,
			stateModules: {
				Global: [
					{
						moduleType: 'MenuStyle',
						options: {
							title: l10n.panel.menu_kind_label,
							state: 'global',
						}
					},
				],
				Static: [
					{
						moduleType: 'Typography',
						options: {
							title: l10n.panel.typography_label,
							state: 'static',
							toggle: false,
							fields: {
								typeface: 'static-font-family',
								fontstyle: 'static-font-style',
								weight: 'static-weight',
								style: 'static-style',
								size: 'static-font-size',
								line_height: 'static-line-height',
								color: 'static-font-color',
							}
						}
					},
					{
						moduleType: 'Colors',
						options: {
							title: l10n.panel.colors_label,
							multiple: false,
							single: true,
							abccolors: [
								{
									name: 'static-nav-bg',
									label: l10n.panel.background_label
								},
							]
						}
					},
				],
				Hover: [
					{
						moduleType: 'Typography',
						options: {
							title: l10n.panel.typography_label,
							state: 'hover',
							toggle: true,
							prepend: 'hover-',
							prefix: 'static',
							fields: {
								use: 'hover-use-typography',
								typeface: 'hover-font-family',
								fontstyle: 'hover-font-style',
								weight: 'hover-weight',
								style: 'hover-style',
								size: 'hover-font-size',
								line_height: 'hover-line-height',
								color: 'hover-font-color',
							}
						}
					},
					{
						moduleType: 'Colors',
						options: {
							title: l10n.panel.colors_label,
							multiple: false,
							single: true,
							toggle: true,
							prepend: 'hover-',
							prefix: 'static',
							fields: {
								use: 'hover-use-color',
							},
							abccolors: [
								{
									name: 'hover-nav-bg',
									label: l10n.panel.background_label
								},
							]
						}
					},
				],
				Focus: [
					{
						moduleType: 'Typography',
						options: {
							title: l10n.panel.typography_label,
							state: 'focus',
							toggle: true,
							prepend: 'focus-',
							prefix: 'static',
							fields: {
								use: 'focus-use-typography',
								typeface: 'focus-font-family',
								fontstyle: 'focus-font-style',
								weight: 'focus-weight',
								style: 'focus-style',
								size: 'focus-font-size',
								line_height: 'focus-line-height',
								color: 'focus-font-color',
							}
						}
					},
					{
						moduleType: 'Colors',
						options: {
							title: l10n.panel.colors_label,
							multiple: false,
							single: true,
							toggle: true,
							prepend: 'focus-',
							prefix: 'static',
							fields: {
								use: 'focus-use-color',
							},
							abccolors: [
								{
									name: 'focus-nav-bg',
									label: l10n.panel.background_label
								},
							]
						}
					},
				],
			},

			migratePresetProperties: function(newPreset) {
				var props = {};

				this.model.get('properties').each( function(prop) {
					props[prop.get('name')] = prop.get('value');
				});

				if (props.breakpoint) {
					// Convert "burger_menu" and "menu_style" properties to "menu_style" property
					if (props.breakpoint.desktop) {
						if (props.breakpoint.desktop.burger_menu === 'yes') {
							props.breakpoint.desktop.menu_style = 'burger';
						}
						delete props.breakpoint.desktop.burger_menu;
					}
					if (props.breakpoint.tablet) {
						if (props.breakpoint.tablet.burger_menu === 'yes') {
							props.breakpoint.tablet.menu_style = 'burger';
						}
						delete props.breakpoint.tablet.burger_menu;
					}
					if (props.breakpoint.mobile) {
						if (props.breakpoint.mobile.burger_menu === 'yes') {
							props.breakpoint.mobile.menu_style = 'burger';
						}
						delete props.breakpoint.mobile.burger_menu;
					}
				} else {
					props.breakpoint = {
						desktop: {},
						tablet: {},
						mobile: {}
					};
				}

				// Setup breakpoint property for preset
				newPreset.set({'breakpoint': props.breakpoint});
			}

		};

		// Generate presets styles to page
		Util.generatePresetsToPage('nav', styleTpl);

		return AppearancePanel;
});

define('elements/upfront-newnavigation/js/settings',[
	'scripts/upfront/element-settings/settings',
	'scripts/upfront/element-settings/root-settings-panel',
	'elements/upfront-newnavigation/js/settings/appearance-panel',
	'elements/upfront-newnavigation/js/menu-util'
], function(ElementSettings, RootSettingsPanel, AppearancePanel, MenuUtil) {
	var l10n = Upfront.Settings.l10n.newnavigation_element;

	var getSelectMenuOptions = function() {
		return _.union([{label: l10n.create_new, value: -1}], MenuUtil.getSelectMenuOptions());
	};

	var Menu_Panel = RootSettingsPanel.extend({
		className: 'upfront-settings_panel_wrap menu-settings',
		title: l10n.mnu.title,
		initialize: function(options) {
			var me = this;
			this.constructor.__super__.initialize.call(this, options);
			Upfront.Events.on('menu_element:menu_created', function(menuData) {
				var selectMenuField = me.getSelectMenuField();
				selectMenuField.options.values = getSelectMenuOptions();
				selectMenuField.render();
				selectMenuField.set_value(menuData.term_id);
			});
			this.listenTo(this.model.get('properties'), 'change', function(property) {
				if (!property) return;
				if (property.get('name') !== 'menu_slug' && property.get('name') !== 'menu_id') {
					return;
				}
				var selectMenuField = me.getSelectMenuField();
				selectMenuField.set_value(me.model.get('properties').findWhere({'name': 'menu_id'}).get('value'));
			});
		},

		getSelectMenuField: function() {
			var selectMenuModule = this.settings.findWhere({identifier: 'selectMenuModule'});
			return selectMenuModule.fields.findWhere({identifier: 'selectMenuField'});
		},

		settings: [
			{
				type: 'SettingsItem',
				identifier: 'selectMenuModule',
				className: 'select-menu-box select-presets',
				fields: [
					{
						type: 'Select',
						property: 'menu_id',
						label: l10n.mnu.load,
						className: 'select-menu-field',
						identifier: 'selectMenuField',
						values: getSelectMenuOptions,
						change: function(value, me) {
							if (value == -1) {
								me.model.set_property('menu_slug', false, true);
								me.model.set_property('menu_id', false);
								me.$el.find('.select-menu-box').addClass('create-new');
								return;
							}
							me.$el.find('.select-menu-box').removeClass('create-new');
							// Menu slug is dependent on menu id, update it here
							var slug = MenuUtil.getMenuSlugById(value);
							me.model.set_property('menu_id', value, true);
							me.model.set_property('menu_slug', slug);
						}
					},
					{
						type: 'Button',
						label: l10n.mnu.delete_menu,
						className: 'delete-menu-button delete_preset',
						on_click: function() {
							if (confirm(l10n.are_you_sure_nag)) {
								//Remove navigation
								var menu_id = this.model.get_property_value_by_name('menu_id');
								Upfront.Events.trigger("menu_element:delete", menu_id);

								//Re-render select field
								var selectMenuField = this.panel.getSelectMenuField();
								selectMenuField.options.values = getSelectMenuOptions();
								selectMenuField.render();
								selectMenuField.set_value('-1');
							}
						}
					}
				]
			},
			{
				type: 'MenuStructure',
				identifier: 'menuStructureModule'
			}
		],

		save_settings: function(){
			Upfront.Events.trigger("menu_element:settings:saving");
			Menu_Panel.__super__.save_settings.apply(this, arguments);
			this.model.set_property('menu_items', false, true);
		}
	});

	var NavigationSettings = ElementSettings.extend({
		initialize: function(opts) {
			this.constructor.__super__.initialize.call(this, opts);
			var me = this;

			/** before the appearance pannel settings for the menu are being rendered
				for a particular breakpoint, check, if a preset already exists for that
				particular breakpoint. If not, copy one from the preset for the next
				higher breakpoint.
			**/

			this.listenTo(this.appearancePanel, 'upfront:presets:setup-items', function() {
				var panel = me.appearancePanel;
				var preset = panel.property('preset') ? panel.clear_preset_name(panel.property('preset')) : 'default',
					presetModel = panel.presets.findWhere({id: preset}),
					allBreakpoints = Upfront.Views.breakpoints_storage.get_breakpoints(),
					currentBreakpoint = allBreakpoints.get_active(),
					breakpointsData = presetModel.get('breakpoint') || {},
					changed = false
				;

				if (!breakpointsData[currentBreakpoint.id] || !breakpointsData[currentBreakpoint.id].menu_style) {

					var higherBPs = _.filter(allBreakpoints.models, function(breakpoint) {
						return breakpoint.get('width') > currentBreakpoint.get('width');
					});

					higherBPs = _.sortBy(higherBPs, function(item) {
						return item.get('width');
					});

					for (var i = 0; i < higherBPs.length; i++) {
						breakpointsData[currentBreakpoint.id] = _.clone(breakpointsData[higherBPs[i].id]);
						if(breakpointsData[currentBreakpoint.id]) {
							console.log("from "+higherBPs[i].id+" to "+currentBreakpoint.id);
							break;
						}
					}

					// if really did acquire settings from the upper bp
					if (breakpointsData[currentBreakpoint.id]) {
						changed = true;
					}


				}


				/** when a preset is being saved with menu_style set to burger,
					make sure that it saves burger_alignment as well
				**/

				if (breakpointsData[currentBreakpoint.id] && breakpointsData[currentBreakpoint.id].menu_style === 'burger' && !breakpointsData[currentBreakpoint.id].burger_alignment ) {
					breakpointsData[currentBreakpoint.id].burger_alignment = 'left';
					changed = true;
				}

				if (changed) {
					presetModel.set('breakpoint', breakpointsData);
				}

			});



		},
		hasBreakpointSettings: true,
		breakpointSpecificPresetSettings: [
			{
				name: 'menu_alignment'
			},
			{
				name: 'burger_alignment'
			},
			{
				name: 'is_floating'
			},
			{
				name: 'burger_over'
			},
			{
				name: 'menu_style'
			},
			{
				name: 'width'
			}
		],
		panels: {
			General: Menu_Panel,
			Appearance: AppearancePanel
		},
		onSaveSettings: function() {
			// Update slug because it's depending on id and has to be updated properly
			var themenu = _.findWhere(this.for_view.existingMenus, {term_id: this.model.get_property_value_by_name('menu_id')});
			if (themenu) {
				this.model.set_property('menu_slug', themenu.slug, true);
			}
		},
		/**
		 * Get the title (goes into settings title area)
		 * @return {string} Title
		 */
		title: l10n.settings
	});


	return NavigationSettings;
});

(function ($) {
	define('elements/upfront-newnavigation/js/floating',[], function() {
		var $win = $(window),
			_cache = {}
		;
		var FloatNav = function ($el) {
			var toolbarsheight = 0;
			var start_position = {
				top: 0,
				left: 0
			};
			var start_size = {
				width: 0,
				height: 0
			};
			var $root = $el;

			var start_floating = function () {

				$current_offset = $root.offset();

				$root.attr("data-already_floating", "yes");

				$root.closest('.upfront-wrapper').css('z-index', 999);

				if($root.hasClass('responsive_nav_toggler'))
					$root.offset($current_offset);
				else
					$root.css(start_size);

				if(toolbarsheight > 0)
					$root.css('margin-top', toolbarsheight);
			};

			var stop_floating = function () {
				$root
					.attr("style", "")
					.attr("data-already_floating", "no")
				;
				$root.closest('.upfront-wrapper').css('z-index', '');

				if(toolbarsheight > 0)
					$root.css('margin-top', '');
			}

			var dispatch_movement = function () {
				var top = $win.scrollTop();
				var top_offset = $('section.upfront-layout').css('margin-top')?parseInt($('section.upfront-layout').css('margin-top')):0;
				if (top > (start_position.top+top_offset-toolbarsheight) && !$root.is('[data-already_floating="yes"]')) start_floating();
				else if (top <= (start_position.top+top_offset-toolbarsheight) && $root.is('[data-already_floating="yes"]')) stop_floating();
			};

			var destroy = function () {		
				start_position = {
					top: 0,
					left: 0
				};
				start_size = {
					width: 0,
					height: 0
				};
				$root = false;
				$win.off("scroll", dispatch_movement);
			};

			var init = function () {
				
				start_position = $root.offset();
				start_size = {width: $root.width(), height: $root.height()};
				$win
					.off("scroll", dispatch_movement)
					.on("scroll", dispatch_movement)
				;
				var toptoolbarheight = ($('#upfront-ui-topbar').length > 0)?$('#upfront-ui-topbar').outerHeight():0;
				var rulerheight = ($('.upfront-ruler-container').length > 0)?$('.upfront-ruler-container').outerHeight():0;
				toolbarsheight = toptoolbarheight+rulerheight;
			};

			init();

			return {
				destroy: destroy
			}
		};

		
		return FloatNav;
	});

})(jQuery);
(function ($) {
define('unewnavigation',[
	'elements/upfront-newnavigation/js/menuitem',
	'elements/upfront-newnavigation/js/model',
	'elements/upfront-newnavigation/js/element',
	'elements/upfront-newnavigation/js/settings',
	'text!elements/upfront-newnavigation/tpl/preset-style.html',
	'scripts/upfront/preset-settings/util',
	'elements/upfront-newnavigation/js/floating',
	'elements/upfront-newnavigation/js/menu-util'
], function(MenuItemView, UnewnavigationModel, UnewnavigationElement, NavigationSettings, settingsStyleTpl, PresetUtil, NavigationFloating, MenuUtil) {

var l10n = Upfront.Settings.l10n.newnavigation_element;

/**
 * View instance - what the element looks like.
 * @type {Upfront.Views.ObjectView}
 */
var singleclickcount = 0;
var elementClasses = '';
var UnewnavigationView = Upfront.Views.ObjectView.extend({
	elementSize: {width: 0, height: 0},

	initialize: function(options){
		var me = this;

		//Get all element classes without preset
		this.elementClasses = this.$el.attr('class');

		if(!(this.model instanceof UnewnavigationModel)){
			this.model = new UnewnavigationModel({properties: this.model.get('properties')});
		}
		Upfront.Views.ObjectView.prototype.initialize.call(this);

		this.events = _.extend({}, this.events, {
			'click a.menu_item' : 'exitEditMode',
			'dblclick a.menu_item' : 'editMenuItem'/*,
			'click a.newnavigation-add-item': 'addPrimaryMenuItem'*/
		});

		this.listenTo(Upfront.Events, "theme_colors:update", this.update_colors, this);
		this.listenTo(Upfront.Events, "menu_element:delete", this.delete_menu, this);

		this.listenTo(this.model, "preset:updated", this.preset_updated);

		// get all menus
		var menu_id = this.model.get_property_value_by_name('menu_id');

		// call this function on allow_new_pages change
		if (!!this.model.get_property_by_name('allow_new_pages')) {
			this.model.get_property_by_name('allow_new_pages').on('change', this.update_auto_add_pages, this);
		}

		this.property('menu_items', false, true);

		this.on('deactivated', this.onDeactivate, this);
		this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", function(current, previous) {
			me.render();

			setTimeout( function() {
				me.activate_responsive_nav(me.$el.find(".upfront-output-unewnavigation"), current.width);
			}, 100);
		});
		this.listenTo(Upfront.Events, "application:mode:before_switch", function(){
			if (!Upfront.Application.layout_ready) return;
			var currentBreakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_active();
			me.render();

			setTimeout( function() {
				me.activate_responsive_nav(me.$el.find(".upfront-output-unewnavigation"), currentBreakpoint.get('width'));
			}, 100);

		});

		this.listenTo(Upfront.Events, 'entity:drag_stop', this.onElementReposition);
	},

	on_element_resize: function (attr) {
		this.processFloatStatus();
	},

	get_preset_properties: function() {
		var preset = this.model.get_property_value_by_name("preset"),
			props = PresetUtil.getPresetProperties('nav', preset) || {};
		return props;
	},

	preset_updated: function() {
		this.render();
	},

	update_colors: function () {

		var props = this.get_preset_properties();

		if (_.size(props) <= 0) return false; // No properties, carry on

		PresetUtil.updatePresetStyle('nav', props, settingsStyleTpl);

	},

	onElementReposition: function() {
		this.processFloatStatus();
	},

	processFloatStatus: function() {
		if (this.floating_cache) this.floating_cache.destroy();
		$upfrontObjectContent = this.$el.find('.upfront-object-content');
		var isFloating = $upfrontObjectContent.data('isfloating');

		if(isFloating && isFloating == 'yes') {
			if (this.property('preset') && this.property('preset') !== 'default') {
				if (this.get_preset_properties().breakpoint[Upfront.Views.breakpoints_storage.get_breakpoints().get_active().id].menu_style === 'burger') {
					this.floating_cache = new  NavigationFloating($upfrontObjectContent.children('.responsive_nav_toggler'));
				} else {
					this.floating_cache = new  NavigationFloating($upfrontObjectContent);
				}
			} else {
				if(this.property('burger_menu') == 'yes')
					this.floating_cache = new  NavigationFloating($upfrontObjectContent.children('.responsive_nav_toggler'));
				else
					this.floating_cache = new  NavigationFloating($upfrontObjectContent);
			}
		}
	},
	exitEditMode: function(e) {
		var me = this;
		var thelink = $(e.target).closest('li').data('backboneview');

		if(!$(e.target).hasClass('ueditable')) {
			var editablefound = false;
			this.$el.find('a.ueditable').each(function() {
				try {
					$(this).data('ueditor').stop();
					$(this).closest('li').removeClass('edit_mode');
					$(this).closest('li').data('backboneview').model['being-edited'] = false;
				} catch (err) { }
				editablefound = true;
			});
			if(editablefound) return;
		}

		if($(e.target).closest('.redactor_box').length > 0) {
			return;
		}


	},
	editMenuItem: function(e) {

		this.editModeOn(e);
		var me = this;
		var target;
		if(typeof e.target == 'undefined' || e.target.trim == '') target = $(e);
		else target = $(e.target);

		if(target.closest('li').hasClass('edit_mode')) {
			return;
		}
		if(typeof e.target != 'undefined') {
			e.preventDefault();
			e.stopPropagation();
		}
		if(target.hasClass('ueditor-placeholder'))
			target = target.siblings('a.menu_item');

		target.closest('li').addClass('edit_mode');

		var ueditor = target.data('ueditor');
		ueditor = null;
		target.data('ueditor', '');

		if(!target.data('ueditor')) {
			target.ueditor({
				linebreaks: true,
				disableLineBreak: true,
				focus: true,
				tabFocus: false,
				air: false,
				allowedTags: ['h5'],
				placeholder: 'Link Name',

			}).on('start', function(e) {
				target.attr('tabIndex', 1); // Necessary for IE before triggering focus event 
				target.focus();
			}).on('keydown', function(e){
				if (e.which == 8) {
					setTimeout(function() {

						if(target.text() == '' && !target.hasClass('menu_item_placeholder')) {
							var e = jQuery.Event("keydown");
							e.which = 8;
							target.trigger(e);
						}
					}, 100);
				}
				else if (e.which == 27) {
					if(target.hasClass('new_menu_item')) {
						target.closest('li').data('backboneview').saveLink(true);
					}
				}
				else if (e.which == 9) {
					e.preventDefault();
					if(!target.hasClass('new_menu_item')) {
					target.blur();
					target.closest('ul').children('li:last').children('i.navigation-add-item').trigger('click');}
				}
				else if(e.which == 13) {

					target.closest('li').data('backboneview').model['being-edited'] = false;
					setTimeout(function() {target.blur();}, 100);

				}
				if(target.text().trim() != '') target.removeClass('menu_item_placeholder');
				else target.addClass('menu_item_placeholder');
			}).on('blur', function(e) {

					var being_edited = false;
					if(target.closest('li').data('backboneview').model['being-edited'])
						being_edited = target.closest('li').data('backboneview').model['being-edited'];




					if($(e.relatedTarget).closest('.redactor_toolbar').length > 0 || being_edited || ($('#upfront-popup').hasClass('upfront-postselector-popup') && $('#upfront-popup').css('display')== 'block')) {
						return;
					}

					target.data('ueditor').stop();

					target.closest('li').removeClass('edit_mode');
					if(!target.hasClass('new_menu_item')) {
						target.closest('li').data('backboneview').saveLink();
					}


			}).on('stop', function() {

				me.editModeOff();
			});

			target.data('ueditor').start();
			target.focus();
		} else {
			target.data('ueditor').start();
			target.focus();
		}

		var currentcontext = target.closest('ul');

		while(currentcontext.length > 0 && currentcontext.hasClass('sub-menu')) {
			currentcontext.addClass('time_being_display');
			currentcontext = currentcontext.parent().parent('ul');
		}
	},
	editModeOn: function(e) {
		this.$el.find('.upfront-object-content ul').each(function() {
			if($(this).hasClass('ui-sortable')) $(this).sortable('disable');
		});
	},
	editModeOff: function() {
		var me = this;
		this.$el.find('.upfront-object-content ul').each(function() {
			if ($(this).hasClass('redactor-toolbar') || $(this).hasClass('upfront-field-select-options')) {
				return;
			}
			if(me.$el.find('li.menu-item.controls-visible').length < 1 )
				if($(this).hasClass('ui-sortable')) $(this).sortable('enable');
		});
	},
	onDeactivate: function(e) {

		//if($(e.target).closest('form').length > 0)
		//	return;

		if(this.$el.find('li.edit_mode').data('backboneview'))
			this.$el.find('li.edit_mode').data('backboneview').model['being-edited']= false;
		this.$el.find('li.edit_mode a.menu_item').blur();
		this.editModeOff();
		if(!$('#upfront-popup').hasClass('upfront-postselector-popup') || !$('#upfront-popup').css('display')== 'block')
			this.$el.find('.time_being_display').removeClass('time_being_display');

		var currentControlsItem = this.$el.find('li.controls-visible');
		if(currentControlsItem.length > 0) {
			currentControlsItem.removeClass('controls-visible');
			currentControlsItem.data('backboneview').setItemControlsState();
		}
	},
	property: function(name, value, silent) {
		if(typeof value != "undefined") return this.model.set_property(name, value, silent);
		return this.model.get_property_value_by_name(name);
	},
	update_auto_add_pages: function(){
		var menu_id = this.model.get_property_value_by_name('menu_id'),
			allow_new_pages = this.property('allow_new_pages'),
			nav_menu_option = Upfront.data.navigation.auto_add['auto_add'],
			key
		;

		if(!menu_id) return false;

		menu_id = parseInt(this.model.get_property_value_by_name('menu_id'), 10);

		if ( !nav_menu_option ) nav_menu_option = [];
		if ( allow_new_pages[0] == ['yes'] ) {
			if ( nav_menu_option.indexOf(menu_id) == -1 ) nav_menu_option.push(menu_id);
		} else {
			if ( -1 !== ( key = nav_menu_option.indexOf(menu_id) ) ) nav_menu_option.splice(key, 1);
		}

		if(!Upfront.data.navigation.auto_add){
			Upfront.data.navigation.auto_add = {0:false, auto_add:[]};
		}else{
			Upfront.data.navigation.auto_add['auto_add'] = nav_menu_option;
		}
		Upfront.Util.post({"action": "upfront_new_update_auto_add_pages", "nav_menu_option": JSON.stringify(Upfront.data.navigation.auto_add)})
			.error(function(res){
				Upfront.Util.log("Cannot update auto add pages!");
			})
		;
	},
	auto_add_pages: function(){
		var menu_id = parseInt(this.model.get_property_value_by_name('menu_id'),10);
		// checking auto add option for current menu
		if ( !Upfront.data.navigation.auto_add['auto_add']  ) {
			this.model.set_property(
				'allow_new_pages',
				['no'],
				true
			);
		} else if ( -1 !== Upfront.data.navigation.auto_add['auto_add'].indexOf(menu_id) ) {
			this.model.set_property(
				'allow_new_pages',
				['yes'],
				true
			);
		} else {
			this.model.set_property(
				'allow_new_pages',
				['no'],
				true
			);
		}
	},
	display_menu_list: function () {
		var me = this,
			menuItemsValues = [{label:l10n.choose_existing_menu, value: 0}],
			menuList = MenuUtil.getSelectMenuOptions()
		;
		var clubbedvalues = [];
		if(typeof(menuList) != 'undefined'){

			clubbedvalues = menuItemsValues.concat(menuList);
		}


		me.$el.find('div.upfront-object-content').html('');

		var menuItems = new Upfront.Views.Editor.Field.Select({
			model: me.model,
			label: "",
			className: "existing_menu_list",
			values: clubbedvalues
		});

		menuItems.render();

		me.$el.find('div.upfront-object-content').append(menuItems.el).append('<span> or </span>');

		var newMenuName = new Upfront.Views.Editor.Field.Text({
			model: me.model,
			label: l10n.new_menu_name,
			className: "new_menu_name",
			compact: true
		});

		newMenuName.render();

		me.$el.find('div.upfront-object-content').append(newMenuName.el);

		var newMenuButton = new Upfront.Views.Editor.Field.Button({
			model: me.model,
			label: l10n.create_new,
			className: "new_menu_button",
			compact: true
		});

		newMenuButton.render();
		me.$el.find('div.upfront-object-content').append(newMenuButton.el);

		me.$el.find('div.upfront-object-content > div.new_menu_name').on('mouseover', function() {
			me.$el.parent().parent().parent().draggable('disable');
		}).on('keydown', function(e) {if(e.which == 13) me.$el.find('div.upfront-object-content > div.new_menu_button > input').trigger('click');});

		me.$el.find('div.upfront-object-content > div.new_menu_name').on('mouseout', function() {
			me.$el.parent().parent().parent().draggable('enable');
		});

		me.$el.find('div.upfront-object-content > div.existing_menu_list').on('mouseover', function() {
			me.$el.parent().parent().parent().draggable('disable');
		});

		me.$el.find('div.upfront-object-content > div.existing_menu_list').on('mouseout', function() {
			me.$el.parent().parent().parent().draggable('enable');
		});

		me.$el.find('div.upfront-object-content > div.existing_menu_list > div').on('click', function() {
			me.parent_module_view.$el.parent().trigger('mouseup');
		});

		me.$el.find('div.upfront-object-content > div.new_menu_button > input').on('click', function() {
			if(me.$el.find('div.upfront-object-content > div.new_menu_name input').val()!='') {
				me.create_new_menu(me.$el.find('div.upfront-object-content > div.new_menu_name input').val());
			}
		});

		me.$el.find('div.upfront-object-content > div.existing_menu_list input').on('change', function() {
			me.$el.parent().parent().parent().draggable('enable');
			if(me.$el.find('div.upfront-object-content > div.existing_menu_list input:checked').val() != 0) {
				var id = me.$el.find('div.upfront-object-content > div.existing_menu_list input:checked').val();
				me.property('menu_id', id, true);
				me.property('menu_slug', MenuUtil.getMenuSlugById(id));
			}
		});
	},
	create_new_menu: function(MenuName) {
		var me = this;
		// Ajax call for creating menu
		var newMenu = Upfront.Util.post({"action": "upfront_new_create_menu", "menu_name": MenuName})
			.success(function (ret) {
				me.property('menu_slug', ret.data.slug, true);
				me.property('menu_id', ret.data.term_id);
				Upfront.Events.trigger("menu_element:menu_created", ret.data);
			})
			.error(function (ret) {
				Upfront.Util.log("Error creating menu");
			})
		;
	},
	delete_menu: function(menu_id) {
		var me = this;
		// Ajax call for delete menu by ID
		var newMenu = Upfront.Util.post({"action": "upfront_new_delete_menu", "menu_id": menu_id})
			.success(function (ret) {
				Upfront.Events.trigger("menu_element:menu_deleted", ret.data);
			})
			.error(function (ret) {
				Upfront.Util.log("Error deleting menu");
			})
		;
	},
	get_content_markup: function () {

		var menu_id = this.model.get_property_value_by_name('menu_id'),
			me = this
		;
		var menu_slug =  this.model.get_property_value_by_name('menu_slug');

		properties = this.get_preset_properties();

		if ( !menu_id ) {
			if(typeof(menu_slug != 'undefined') && menu_slug != '') this.set_menu_id_from_slug(menu_slug);
			return "";
		}
		Upfront.Util.post({"action": "upfront_new_load_menu_array", "data": menu_id})
			.success(function (ret) {
				if(!ret.data){
					me.$el.find('.upfront-object-content').html('Please add menu items');
					return;
				}
				me.property('menu_items', ret.data, true);
				me.generate_menu();

			})
			.error(function (ret) {
				Upfront.Util.log("Error loading menu");
			})
		;
		return 'Loading';
	},
	set_menu_id_from_slug: function(slug) {
		var me = this;
		Upfront.Util.post({"action": "upfront_new_menu_from_slug", "data": slug})
			.success(function (ret) {
				me.property('menu_id', ret.data);
			})
			.error(function (ret) {
				Upfront.Util.log("Error loading menu from slug");
			})
		;
	},

	on_render: function() {

		var me = this;

		var props = this.get_preset_properties();

		if(!this.property('menu_id')) {
			this.display_menu_list();
		}

		var menuStyle,
			allowSubNav = this.property("allow_sub_nav"),
			isFloating = this.property("is_floating"),
			$upfrontObjectContent
		;

		if (_.isUndefined(props.breakpoint)) {
			props.breakpoint = {
				desktop: {},
				tablet: {},
				mobile: {}
			};
		}
		if (_.isUndefined(props.breakpoint.desktop)) {
			props.breakpoint.desktop = {};
		}

		menuStyle = props.breakpoint.desktop.menu_style;
		menuStyle = menuStyle ? menuStyle : this.property('menu_style');

		if (!props.breakpoint.desktop.menu_alignment) {
			props.breakpoint.desktop.menu_alignment = this.property('menu_alignment');
		}

		$upfrontObjectContent = this.$el.find('.upfront-object-content');
		// if(this.$el.find('a.newnavigation-add-item').length < 1) {
		// 	$('<b class="upfront-entity_meta newnavigation_add add_item upfront-ui"><a href="#" class="upfront-icon-button newnavigation-add-item add-item"></a></b>').insertBefore($upfrontObjectContent);
		// }

		setTimeout(function() {
			var breakpointsData = me.model.get_property_value_by_name('breakpoint');
			var currentBreakpoint = Upfront.Views.breakpoints_storage.get_breakpoints().get_active();

			if (breakpointsData) {
				$upfrontObjectContent.attr('data-breakpoints', JSON.stringify(breakpointsData));
				if (me.property('preset') && me.property('preset') !== 'default') {
					$upfrontObjectContent.attr('data-breakpoints', JSON.stringify(props.breakpoint));
				}
				setTimeout( function() {
					me.activate_responsive_nav($upfrontObjectContent, currentBreakpoint.get('width'));
				}, 100);
			} else if (me.property('preset') /*&& me.property('preset') !== 'default'*/) {
				$upfrontObjectContent.attr('data-breakpoints', JSON.stringify(props.breakpoint));
				setTimeout( function() {
					me.activate_responsive_nav($upfrontObjectContent, currentBreakpoint.get('width'));
				}, 100);
			}

			//Make sure parent module have high z-index to prevent dropdown under elements
			me.$el.closest('.upfront-module').addClass('upfront-module-has-nav');

		}, 300);

		$upfrontObjectContent.attr('data-stylebk',(menuStyle ? menuStyle : 'horizontal'));
		$upfrontObjectContent.attr('data-style',(menuStyle ? menuStyle : 'horizontal'));
		$upfrontObjectContent.attr('data-alignment', props.breakpoint.desktop.menu_alignment);
		$upfrontObjectContent.attr('data-isfloating',(isFloating ? isFloating : 'no'));
		$upfrontObjectContent.attr('data-allow-sub-nav',(allowSubNav.length !== 0 && allowSubNav[0] == 'yes' ? allowSubNav[0] : 'no'));

		setTimeout(function() {
			if(me.$el.height() < 80) {
				me.$el.closest('div.upfront-module').addClass('newnavigation_squished');
			}
			else {
				me.$el.closest('div.upfront-module').removeClass('newnavigation_squished');
			}

		}, 200);

		this.$el.off('click', '.responsive_nav_toggler, .burger_overlay');
		this.$el.on('click', '.responsive_nav_toggler, .burger_overlay', function(event) {
			me.toggle_responsive_nav(event);
			event.stopPropagation();
		});

		this.$el.find('.upfront-output-unewnavigation').addClass('upfront-navigation');
	},

	renderResponsiveNavigation: function(selector) {
		var me = this,
			regions_off = $('div.upfront-regions').offset(),
			regions_width = $('div.upfront-regions').outerWidth(),
			win_width = $(window).width(),
			sidebar_width = $('div#sidebar-ui').outerWidth(),
			topbar_height = ( $('div#upfront-ui-topbar').length > 0 ? $('div#upfront-ui-topbar').outerHeight() : 0 ),
			ruler_height = ( $('.upfront-ruler-container').length > 0 ? $('.upfront-ruler-container').outerHeight() : 0 ),
			allBreakpoints = Upfront.Views.breakpoints_storage.get_breakpoints(),
			currentBreakpoint = allBreakpoints.get_active(),
			breakpoints = this.get_preset_properties().breakpoint || this.fallbackBreakpointData(),
			breakpoint = breakpoints[currentBreakpoint.id],
			breakpointWidth = currentBreakpoint.get_property_value_by_name('width'),
			currentwidth = typeof breakpointWidth !== 'undefined' && !currentBreakpoint.get('default') ? parseInt(breakpointWidth, 10) : $(window).width()
		;


		/** if breakpoint data is not available, use data from
			the wider breakpoint that has data available.
		**/
		if(!breakpoint || !breakpoint.menu_style) {
			var higherBPs = _.filter(allBreakpoints.models, function(breakpoint) {
				return breakpoint.get('width') > currentBreakpoint.get('width');
			});

			higherBPs = _.sortBy(higherBPs, function(item) {
				return item.get('width');
			});

			for(var i = 0; i < higherBPs.length; i++) {
				breakpoint = breakpoints[higherBPs[i].id];

				if(breakpoint) {
					break;
				}
			}

		}
		/** if breakpoint has menu_style set to burger, but no
			burger_alignment is defined, set it to default
		**/
		if(breakpoint && breakpoint.menu_style === 'burger' && !breakpoint.burger_alignment ) {
			breakpoint.burger_alignment= 'left';
		}

		if (breakpoint.menu_style === 'burger') {
			selector.addClass('triggered-menu');
			selector.attr('data-style', 'burger');
			selector.attr('data-burger_alignment', breakpoint.burger_alignment);
			selector.attr('data-burger_over', breakpoint.burger_over);
			selector.attr('data-alignment', breakpoint.menu_alignment);

			// Add responsive nav toggler
			if(!selector.find('div.responsive_nav_toggler').length)
				selector.prepend($('<div class="responsive_nav_toggler"><div></div><div></div><div></div></div>').data('view', me));

			// clone sub-menu's parent's link (if any) on top of the sub-menu's items, and make the parent clickable to toggle the appearance of sub-menu. Only on front end.
			selector.find('li.menu-item-has-children').each(function() {
				if(selector.children('a').length && selector.children('a').attr('href')) {
					var itemclone = selector.clone().removeClass('menu-item-has-children').addClass('active-clone').removeAttr('id');
					itemclone.children('ul').remove();
					selector.children('ul').prepend(itemclone);
					selector.children('a').removeAttr('href');
				}
			});


			if (selector.hasClass('upfront-output-unewnavigation')) {
				$('head').find('style#responsive_nav_sidebar_offset').remove();
				
				var responsive_css = 'div.upfront-navigation div[data-style="burger"][ data-burger_alignment="top"] ul.menu, div.upfront-navigation div[data-style="burger"][data-burger_alignment="whole"] ul.menu {left:'+parseInt(regions_off.left, 10)+'px;} ';
				responsive_css = responsive_css + 'div.upfront-navigation div[data-style="burger"][ data-burger_alignment="top"] ul.menu, div.upfront-navigation div[data-style="burger"][ data-burger_alignment="whole"] ul.menu {right: inherit; width:'+((parseInt(currentwidth) < parseInt(win_width-sidebar_width))?parseInt(currentwidth):parseInt(win_width-sidebar_width)) +'px !important; } ';
				responsive_css = responsive_css + 'div.upfront-navigation div[data-style="burger"][ data-burger_alignment="left"] ul.menu {left:'+parseInt(regions_off.left)+'px !important; right:inherit !important; width:'+(parseInt(30/100*regions_width)+40)+'px !important;} ';
				responsive_css = responsive_css + 'div.upfront-navigation div[data-style="burger"][ data-burger_alignment="right"] ul.menu {left:inherit !important; right:'+((parseInt((win_width-currentwidth-sidebar_width) / 2) > 0)?parseInt((win_width-currentwidth-sidebar_width) / 2 -(($(document).width() > (win_width+6))?30:0)):0)+'px !important; width:'+(parseInt(30/100*regions_width)+40)+'px !important; } ';
				responsive_css = responsive_css + 'div.upfront-navigation div[data-style="burger"]:not([data-burger_over="pushes"]) ul.menu {top:'+(parseInt(topbar_height) + parseInt(ruler_height))+'px !important; } ';

				$('head').append($('<style id="responsive_nav_sidebar_offset">'+responsive_css+'</style>'));
			}
			//Z-index the container module to always be on top, in the layout edit mode
			//selector.closest('div.upfront-newnavigation_module').css('z-index', 3);

			me.hideMenu(selector.find('ul.menu'));
		} else {
			selector.removeClass('triggered-menu');
			selector.attr('data-style', breakpoint.menu_style);
			selector.attr('data-alignment', breakpoint.menu_alignment);

			selector.removeAttr('data-burger_alignment');
			selector.removeAttr('data-burger_over');

			// Remove responsive nav toggler
			selector.find('div.responsive_nav_toggler').remove();
			me.showMenu(selector.find('ul.menu'));

			//remove any sub-menu item's parent's clones
			selector.find('li.active-clone').each(function() {
				selector.parent().parent().children('a').attr('href', selector.children('a').attr('href'));
				selector.remove();
			});

			//remove any display:block|none specifications from the sub-menus
			selector.find('ul.menu, ul.sub-menu').each(function() {
				selector.css('display', '');
			});

			// remove any adjustments done because of the sidebar or the adminbar
			if($('div#wpadminbar').length) {
				selector.find('ul.menu').css('margin-top', '');
			}

			//remove the z-index from the container module
			//selector.closest('div.upfront-newnavigation_module').css('z-index', '');
		}

		selector.attr('data-isfloating', breakpoint.is_floating);
		Upfront.Events.trigger('entity:object:refresh', this);
	},

	fallbackBreakpointData: function () {
		var breakpoints = this.property('breakpoint');
		if ( breakpoints !== false && _.isObject(breakpoints) && "desktop" in breakpoints ) {
			for ( key in breakpoints ) {
				if ( "burger_menu" in breakpoints[key] && breakpoints[key].burger_menu === 'yes' ) {
					breakpoints[key].menu_style = 'burger';
					delete breakpoints[key].burger_menu;
				}
			}
			return breakpoints;
		}
		return {
			desktop: {},
			tablet: {},
			mobile: {}
		};
	},

	activate_responsive_nav: function(selector, bpwidth) {

		// If there is preset setup use new rendering
		
		/**
		 * Even the new Responsive Nav comes with 'default' presets
		 * so, it should be allowed to use the new rendering technique
		 */

		if (this.property('preset')) {
			this.renderResponsiveNavigation(selector);
			return;
		}
		
		this.fallbackToOldResponsiveNav(selector, bpwidth);
	},

	/**
	 * DO NOT CHANGE ANYTHING IN THIS FUNCTION!!!
	 * This is just for compatibility with old settings.
	 * Changes for new settings rendering are to be done in
	 * renderResponsiveNavigation function.
	 */
	fallbackToOldResponsiveNav: function(selector, bpwidth) {
		var me = this;
		var breakpoints = selector.data('breakpoints');

		var bparray = new Array();

		var currentwidth = (typeof(bpwidth) != 'undefined') ? parseInt(bpwidth):$(window).width();

		for (var key in breakpoints) {
			bparray.push(breakpoints[key])
		}

		bparray.sort(function(a, b) {
			return a.width - b.width;
		});

		var regions_off = $('div.upfront-regions').offset(),
			regions_width = $('div.upfront-regions').outerWidth(),
			win_width = $(window).width(),
			sidebar_width = $('div#sidebar-ui').outerWidth(),
			topbar_height = $('div#upfront-ui-topbar').outerHeight();
			ruler_height = $('.upfront-ruler-container').outerHeight();

		for (var key in bparray) {
			if(parseInt(currentwidth) >= parseInt(bparray[key]['width'])) {

				if(bparray[key]['burger_menu'] == 'yes') {
					selector.addClass('triggered-menu');
					selector.attr('data-style', 'burger')
					selector.attr('data-burger_alignment', bparray[key]['burger_alignment']);
					selector.attr('data-burger_over', bparray[key]['burger_over']);
					selector.attr('data-alignment', ( bparray[key]['menu_alignment'] ?
							bparray[key]['menu_alignment'] : selector.data('alignmentbk') ));

					// Add responsive nav toggler
					if(!selector.find('div.responsive_nav_toggler').length)
						selector.prepend($('<div class="responsive_nav_toggler"><div></div><div></div><div></div></div>').data('view', me));

					// clone sub-menu's parent's link (if any) on top of the sub-menu's items, and make the parent clickable to toggle the appearance of sub-menu. Only on front end.
					selector.find('li.menu-item-has-children').each(function() {
						if(selector.children('a').length && selector.children('a').attr('href')) {
							var itemclone = selector.clone().removeClass('menu-item-has-children').addClass('active-clone').removeAttr('id');
							itemclone.children('ul').remove();
							selector.children('ul').prepend(itemclone);
							selector.children('a').removeAttr('href');
						}
					});

					if(selector.hasClass('upfront-output-unewnavigation')) {
						$('head').find('style#responsive_nav_sidebar_offset').remove();
						var responsive_css = 'div.upfront-navigation div[data-style="burger"][ data-burger_alignment="top"][data-burger_over="over"] ul.menu, div.upfront-navigation div[data-style="burger"][data-burger_over="over"][data-burger_alignment="whole"] ul.menu {left:'+parseInt(regions_off.left)+'px !important;} ';
						responsive_css = responsive_css + 'div.upfront-navigation div[data-style="burger"][ data-burger_alignment="top"] ul.menu, div.upfront-navigation div[data-style="burger"][ data-burger_alignment="whole"] ul.menu {right: inherit; width:'+((parseInt(currentwidth) < parseInt(win_width-sidebar_width))?parseInt(currentwidth):parseInt(win_width-sidebar_width)) +'px !important; } ';
						responsive_css = responsive_css + 'div.upfront-navigation div[data-style="burger"][ data-burger_alignment="left"] ul.menu {left:'+parseInt(regions_off.left)+'px !important; right:inherit !important; width:'+(parseInt(30/100*regions_width)+40)+'px !important;} ';
						responsive_css = responsive_css + 'div.upfront-navigation div[data-style="burger"][ data-burger_alignment="right"] ul.menu {left:inherit !important; right:'+((parseInt((win_width-currentwidth-sidebar_width) / 2 - 30) > 0)?parseInt((win_width-currentwidth-sidebar_width) / 2 - 30):0)+'px !important; width:'+(parseInt(30/100*regions_width)+40)+'px !important; } ';
						responsive_css = responsive_css + 'div.upfront-navigation div[data-style="burger"][data-burger_over="over"] ul.menu {top:'+(parseInt(topbar_height) + parseInt(ruler_height))+'px !important; } ';

						$('head').append($('<style id="responsive_nav_sidebar_offset">'+responsive_css+'</style>'));
					}
					//Z-index the container module to always be on top, in the layout edit mode
					selector.closest('div.upfront-newnavigation_module').css('z-index', 3);

					me.hideMenu(selector.find('ul.menu'));
				}
				else {
					selector.removeClass('triggered-menu');
					selector.attr('data-style', bparray[key]['menu_style']);
					selector.attr('data-alignment', bparray[key]['menu_alignment']);


					selector.removeAttr('data-burger_alignment','');
					selector.removeAttr('data-burger_over', '');

					// Remove responsive nav toggler
					selector.find('div.responsive_nav_toggler').remove();
					me.showMenu(selector.find('ul.menu'));

					//remove any sub-menu item's parent's clones
					selector.find('li.active-clone').each(function() {
						selector.parent().parent().children('a').attr('href', selector.children('a').attr('href'));
						selector.remove();
					});

					//remove any display:block|none specifications from the sub-menus
					selector.find('ul.menu, ul.sub-menu').each(function() {
						selector.css('display', '');
					});

					// remove any adjustments done because of the sidebar or the adminbar
					if($('div#wpadminbar').length) {
						selector.find('ul.menu').css('margin-top', '');
					}


					//remove the z-index from the container module
					selector.closest('div.upfront-newnavigation_module').css('z-index', '');
				}

				selector.attr('data-isfloating', bparray[key]['is_floating']);

			}
		}
		Upfront.Events.trigger('entity:object:refresh', this);
	},

	hideMenu: function(menu) {
		var $nav = this.$el.find('.upfront-output-unewnavigation');
		menu.hide();

		if (menu.siblings('.burger_overlay').length > 0) {
			var burger_overlay = menu.siblings('.burger_overlay');
			burger_overlay.hide();
		}
		if($nav.attr('data-burger_alignment') === 'top' || $nav.attr('data-burger_alignment') === 'whole') {
			$('section.upfront-layout').css('margin-top', 0);
		}
	},

	showMenu: function(menu) {
		if (menu.siblings('.burger_overlay').length > 0) {
			var burger_overlay = menu.siblings('.burger_overlay');

			burger_overlay.show();
		}

		menu.show();
	},

	toggle_responsive_nav: function(e) {
		var me = this;
		var region_container = this.$el.closest('.upfront-region-container');
		var group = this.$el.closest('.upfront-module-group');
		var module = this.$el.closest('.upfront-module');
		var $menu = this.$el.find('ul.menu');
		var $nav = this.$el.find('.upfront-output-unewnavigation');

		if ($menu.css('display') == 'none' && typeof(e) != 'undefined') {
			this.showMenu($menu);
			var offset = $menu.position();

			var close_icon = $('<i class="burger_nav_close"></i>');
			$menu.prepend($('<li>').addClass('wrap_burger_nav_close').append(close_icon));

			close_icon.bind('touchstart click', function() {
				$(e.target).closest('.responsive_nav_toggler').trigger('click');
				if ($nav.attr('data-burger_alignment') === 'top' || $nav.attr('data-burger_alignment') === 'whole') {
					$('section.upfront-layout').css('margin-top', 0);
				}
			});

			$nav.attr('data-burger_open', "1");

			region_container.addClass('upfront-region-container-has-nav');
			region_container.addClass('upfront-region-container-nav-open');
			if ( group.length > 0 ) {
				group.addClass('upfront-module-group-nav-open');
			}
			module.addClass('upfront-module-nav-open');

			if($nav.attr('data-burger_over') === 'pushes' && $nav.attr('data-burger_alignment') === 'top' || $nav.attr('data-burger_alignment') === 'whole') {
				if ( $nav.attr('data-burger_alignment') === 'top' ) {
					$('section.upfront-layout').css('margin-top', $menu.outerHeight());
				}

				var topbar_height = $('div#upfront-ui-topbar').outerHeight();
				var ruler_height = $('.upfront-ruler-container').outerHeight();
				$menu.offset({top:topbar_height+ruler_height, left:$('section.upfront-layout').offset().left});
			}
			Upfront.Events.trigger("entity:navigation:responsive_open", $nav);
		} else {
			this.hideMenu($menu);
			this.$el.find('i.burger_nav_close').parent('li.wrap_burger_nav_close').remove();

			$nav.removeAttr('data-burger_open');

			this.$el.find('ul.sub-menu').css('display', '');
			if(this.$el.find('ul.sub-menu').length < 1 ) {
				region_container.removeClass('upfront-region-container-has-nav');
			}
			region_container.removeClass('upfront-region-container-nav-open');
			if ( group.length > 0 ) {
				group.removeClass('upfront-module-group-nav-open');
			}
			module.removeClass('upfront-module-nav-open');

			if($nav.attr('data-burger_over') === 'pushes') {
				$('section.upfront-layout').css('margin-top', '');
			}
			Upfront.Events.trigger("entity:navigation:responsive_close", $nav);
		}
	},

	generate_menu: function() {
		var me = this;
		var menu_id = this.model.get_property_value_by_name('menu_id');
		if(!menu_id) return;
		var container = this.$el.find('.upfront-object-content');;


		this.$el.find('.upfront-object-content').html('');


		if(this.property('menu_items').length > 0) {
			var menu = this.renderMenu(this.property('menu_items'), 'menu');
			container.append(menu);
		}
		else
		{

			container.append(this.renderMenu(this.property('menu_items'), 'menu'));

			setTimeout(function() {
				// me.$el.find('a.newnavigation-add-item').trigger('click');
				me.$el.closest('.upfront-module').find('i.upfront-icon-region-add').trigger('click');
			}, 200);
		}

		var preset = this.model.get_property_value_by_name("preset");
		var presetProperties = this.get_preset_properties();

		setTimeout(function() {
			me.clearPresetClass(me.$el);
			me.$el.addClass(me.property('theme_style'));
			me.$el.addClass(preset);
		}, 50);

		//Work around for having the region container have a higher z-index if it contains the nav, so that the dropdowns, if overlapping to the following regions should not loose "hover" when the mouse travels down to the next region.

		var region_container = this.$el.closest('.upfront-region-container, .upfront-region-sub-container');
		if(this.$el.find('ul.sub-menu').length > 0 ) {
			region_container.addClass('upfront-region-container-has-nav');
		}
		else {
			region_container.removeClass('upfront-region-container-has-nav');
		}


		var breakpoint = Upfront.Settings.LayoutEditor.CurrentBreakpoint;

		presetProperties.breakpoint = presetProperties.breakpoint || this.fallbackBreakpointData();
		if (!breakpoint || breakpoint.default) {
			if (
				presetProperties.breakpoint.desktop.menu_style === 'burger'&&
				presetProperties.breakpoint.desktop.burger_over !== 'pushes' &&
				presetProperties.breakpoint.desktop.burger_alignment !== 'whole'
			) {
				this.$el.find('.upfront-object-content').append($('<div class="burger_overlay"></div>'));
			}
			if (presetProperties.breakpoint.desktop.menu_style === 'burger') {
				container.prepend($('<div>').addClass("responsive_nav_toggler").data('view', me).append('<div></div><div></div><div></div>'));
				me.hideMenu(this.$el.find('ul.menu'));
			}
		} else {
			breakpoint_data = presetProperties.breakpoint[breakpoint.id] || {};

			var menu_style = typeof breakpoint_data.menu_style === 'undefined' ? (this.model.get_breakpoint_property_value('burger_menu') === 'yes' ? 'burger' : '') : breakpoint_data.menu_style;
			var burger_over = typeof breakpoint_data.burger_over === 'undefined' ? this.model.get_breakpoint_property_value('burger_over') : breakpoint_data.burger_over;
			var burger_alignment = typeof breakpoint_data.burger_alignment === 'undefined' ? this.model.get_breakpoint_property_value('burger_alignment') : breakpoint_data.burger_alignment;
			if (
				menu_style === 'burger'&&
				burger_over !== 'pushes' &&
				burger_alignment !== 'whole'
			) {
				this.$el.find('.upfront-object-content').append($('<div class="burger_overlay"></div>'));
			}
			if(menu_style === 'burger') {
				container.prepend($('<div>').addClass("responsive_nav_toggler").data('view', me).append('<div></div><div></div><div></div>'));
				me.hideMenu(this.$el.find('ul.menu'));
			}
		}
		//clear any top margin applied to the layout for accomodating a burger menu when set to "push content"
		$('section.upfront-layout').css('margin-top', '');

		this.makeSortable();

		this.processFloatStatus();
	},
	clearPresetClass: function($el) {
		$el.removeClass();
		$el.addClass(this.elementClasses);
	},
	makeSortable: function() {
		var me = this;
		this.$el.find('.upfront-object-content ul').each(function() {
			if ($(this).hasClass('redactor-toolbar') || $(this).hasClass('upfront-field-select-options')) {
				return;
			}
			if(!$(this).hasClass('ui-sortable')) {
				$(this).sortable({
					start: function ( event, ui ) {
						ui.item.find('i.navigation-add-item').css('display', 'none');
					},
					stop: function( event, ui ) {
						ui.item.find('i.navigation-add-item').css('display', 'block');
						ui.item.parent('ul').children('li:last').append(ui.item.parent('ul').children('li').children('i.navigation-add-item'));
						me.saveMenuOrder();
					}
				});
			}
		});
	},
	saveMenuOrder: function() {
		var me = this;
		Upfront.Util.post({"action": "upfront_new_update_menu_order", "menu_items": me.new_menu_order()})
			.success(function (ret) {
				Upfront.Events.trigger("menu_element:edit");
			})
			.error(function (ret) {
				Upfront.Util.log("Error updating menu");
			})
		;
	},
	new_menu_order: function(removed) {
		var i = 0;

		var new_menu_order = new Array();
		this.$el.find('.upfront-object-content ul li').each(function() {
			var bbview = $(this).data('backboneview');
			if (!(bbview && bbview.model)) return true;

			if($(this).parent().parent('li').length > 0) {
				$(this).data('backboneview').model['menu-item-parent-id'] = $(this).parent().parent('li').data('backboneview').model['menu-item-db-id'];
			} else {
				$(this).data('backboneview').model['menu-item-parent-id'] = 0;
			}

			new_menu_order[i] = {};

			if(typeof(removed) != 'undefined') {
				if($(this).data('backboneview').model['menu-item-parent-id'] == parseInt(removed)) {
					$(this).data('backboneview').model['menu-item-parent-id'] = 0;
				}
			}

			if(typeof(removed) == 'undefined' || $(this).data('backboneview').model['menu-item-db-id'] != removed) {
				new_menu_order[i]['menu-item-db-id'] =  $(this).data('backboneview').model['menu-item-db-id'];
				new_menu_order[i]['menu-item-parent-id'] = $(this).data('backboneview').model['menu-item-parent-id'];

				$(this).data('backboneview').model['menu-item-position'] = i;
				i++;
			}
		});
		return new_menu_order;
	},
	renderMenu: function(list, classname, level){

		if(typeof(level) == 'undefined')
			level = 0;
		var me = this,
			$dom = $('<ul>').addClass(classname)
		;
		if(classname=='menu') $dom.addClass('drag_mode');
		_(list).each(function (model) {
			var $li = me.renderMenuItem(model, false, level);
			if($li && $li.length && !(typeof model.sub === 'undefined')) {
				if (model.sub && model.sub.length) $li.addClass('parent').append(me.renderMenu(model.sub, 'sub-menu', level+1));
			}
			$dom.append($li);
		});

		$dom.children('li:last').append('<i class="navigation-add-item"></i>');

		return $dom;
	},

	renderMenuItem: function (model, newitem, level){
		if(typeof(level) == 'undefined')
			level = 0;

		var me = this;

		if(typeof newitem == 'undefined') newitem = false;

		var view = new MenuItemView({model: model, parent_view: me, newitem: newitem, level: level});
		return view.render().$el;
	},
	menuItemTemplate: function() {
		return {
			"menu-item-parent-id": "0",
			"menu-item-target": "",
			"menu-item-title": "",
			"menu-item-type": "custom",
			"menu-item-url": "#"
		};
	},
	addPrimaryMenuItem : function(e) {

		e.preventDefault();
		if(this.$el.find('ul.menu > li > i.navigation-add-item').length > 0) {

			this.$el.find('ul.menu > li > i.navigation-add-item').trigger('click');
		}
		else {

			this.addMenuItem(e);
		}
	},
	addMenuItem : function(e) {

		var me = this;
		var menuItemId = false;
		var menu_id = this.model.get_property_value_by_name('menu_id');

		me.$el.find('a.new_menu_item').removeClass('new_menu_item');
		var parent_level = 0;
		var parent_level = 0;
		var menu_item = this.menuItemTemplate();
		var newmenuitem;

		if(typeof e.target == 'undefined' && e.parent('li').length > 0) {
			parent_level = e.parent('li').data('depth');
			menu_item["menu-item-parent-id"] = e.parent('li').data('backboneview').model["menu-item-db-id"];
			e.append(this.renderMenuItem(menu_item, true, parent_level+1));
			e.children('li:last').append('<i class="navigation-add-item"></i>');
		} else {
			if($(e.target).parent('li').parent('ul').parent('li').length > 0) {
				menu_item["menu-item-parent-id"] = $(e.target).parent('li').parent('ul').parent('li').data('backboneview').model["menu-item-db-id"];
				$(e.target).parent('li').parent('ul').addClass('time_being_display');
			}
			if($(e.target).parent('li').length == 0) {
				$(e.target).closest('div.upfront-module').find('ul.menu').append(this.renderMenuItem(menu_item, true));
			}
			else {
				$(e.target).parent('li').parent('ul').append(this.renderMenuItem(menu_item, true, 0));
				$(e.target).parent('li').next('li').append(e.target);
			}
		}
		me.editMenuItem(me.$el.find('a.new_menu_item').removeClass('new_menu_item')); //linkPanel does not popup on new menu creation because of this class being removed
	},

	getControlItems: function(){
		return _([
			this.createControl('add', l10n.add_item, 'addPrimaryMenuItem'),
			this.createPaddingControl(),
			this.createControl('settings', l10n.settings, 'on_settings_click')
		]);
	}

});





// ----- Bringing everything together -----
// The definitions part is over.
// Now, to tie it all up and expose to the Subapplication.

Upfront.Application.LayoutEditor.add_object("Unewnavigation", {
	"Model": UnewnavigationModel,
	"View": UnewnavigationView,
	"Element": UnewnavigationElement,
	"Settings": NavigationSettings,
	cssSelectors: {
		"[data-style='horizontal'] ul.menu, div[data-style='vertical'] ul.menu": {label: l10n.css.bar_label, info: l10n.css.bar_info},
		"[data-style='horizontal'] ul.menu > li.menu-item > a, div[data-style='vertical'] ul.menu > li.menu-item > a": {label: l10n.css.item_label, info: l10n.css.item_info},
		"[data-style='horizontal'] ul.menu > li.menu-item:hover > a, div[data-style='vertical'] ul.menu > li.menu-item:hover > a": {label: l10n.css.hover_label, info: l10n.css.hover_info},
		"[data-style='horizontal'] ul.sub-menu > li.menu-item > a, div[data-style='vertical'] ul.sub-menu > li.menu-item > a": {label: l10n.css.subitem_label, info: l10n.css.subitem_info},
		"[data-style='horizontal'] ul.sub-menu > li.menu-item:hover > a, div[data-style='vertical'] ul.sub-menu > li.menu-item:hover > a": {label: l10n.css.subitem_hover_label, info: l10n.css.subitem_hover_info},


		"[data-style='burger'] ul.menu": {label: l10n.css.responsive_bar_label, info: l10n.css.bar_info},
		".upfront-output-unewnavigation .responsive_nav_toggler": {label: l10n.css.responsive_trigger, info: l10n.css.hover_info},
		".upfront-output-unewnavigation div.responsive_nav_toggler > div": {label: l10n.css.responsive_trigger_bars, info: l10n.css.hover_info},
		".upfront-output-unewnavigation i.burger_nav_close": {label: l10n.css.responsive_nav_close, info: l10n.css.close_info},
		"[data-style='burger'] ul.menu > li.menu-item > a": {label: l10n.css.responsive_item_label, info: l10n.css.item_info},
		"[data-style='burger'] ul.menu > li.menu-item:hover > a": {label: l10n.css.responsive_hover_label, info: l10n.css.hover_info},
		"[data-style='burger'] ul.sub-menu > li.menu-item > a": {label: l10n.css.responsive_subitem_label, info: l10n.css.subitem_info},
		"[data-style='burger'] ul.sub-menu > li.menu-item:hover > a": {label: l10n.css.responsive_subitem_hover_label, info: l10n.css.subitem_hover_info}
	},
	cssSelectorsId: Upfront.data.unewnavigation.defaults.type
});
Upfront.Models.UnewnavigationModel = UnewnavigationModel;
Upfront.Views.UnewnavigationView = UnewnavigationView;


});
})(jQuery);

define('elements/upfront-button/js/model',[],function() {
	var ButtonModel = Upfront.Models.ObjectModel.extend({
		init: function () {
			var properties = _.clone(Upfront.data.ubutton.defaults);

			var defaults = Upfront.data.ubutton.defaults;
			
			properties.content = _.clone(defaults.content);

			properties.element_id = Upfront.Util.get_unique_id('button-object');
			
			this.init_properties(properties);
		}
	});

	return ButtonModel;
});

define('elements/upfront-button/js/element',[
	'elements/upfront-button/js/model'
], function(ButtonModel) {
	var l10n = Upfront.Settings.l10n.button_element;
	
	var ButtonElement = Upfront.Views.Editor.Sidebar.Element.extend({
		priority: 260,
		render: function () {
			this.$el.addClass('upfront-icon-element upfront-icon-element-button');
			this.$el.html(l10n.element_name);
		},
		add_element: function () {
			var object = new ButtonModel(),
				module = new Upfront.Models.Module({
					"name": "",
					"properties": [
						{"name": "content", "value": l10n.dbl_click},
						{"name": "href", "value": ""},
						{"name": "align", "value": "center"},
						{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
						{"name": "class", "value": "c4 button-style"},
						{"name": "row", "value": Upfront.Util.height_to_row(55)},
						{"name": "has_settings", "value": 0}
					],
					"objects": [
						object
					]
				})
			;
			this.add_module(module);
		}
	});

	return ButtonElement;
});


define('text!elements/upfront-button/tpl/preset-style.html',[],function () { return '#page .upfront-button .button-preset-<?php echo $properties[\'id\'] ?>.upfront_cta {\r\n    <?php if(!empty($properties[\'color\'])) { ?>color: <?php echo $properties[\'color\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'fontface\'])) { ?>font-family: <?php echo $properties[\'fontface\']  ?>; <?php } ?>\r\n    <?php if(!empty($properties[\'fontsize\'])) { ?>font-size: <?php echo $properties[\'fontsize\']  ?>px; <?php } ?>\r\n    <?php if(!empty($properties[\'fontstyle_weight\'])) { ?>font-weight: <?php echo $properties[\'fontstyle_weight\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'fontstyle_style\'])) { ?>font-style: <?php echo $properties[\'fontstyle_style\']  ?>;<?php } ?>\r\n    <?php if(!empty($properties[\'lineheight\'])) { ?>line-height: <?php echo $properties[\'lineheight\']  ?>;<?php } ?>\r\n\r\n    <?php if(!empty($properties[\'useborder\'])) { ?>\r\n        <?php if(!empty($properties[\'borderwidth\']) && !empty($properties[\'bordertype\']) && !empty($properties[\'bordercolor\'])) { ?>border: <?php echo $properties[\'borderwidth\'] ?>px <?php echo $properties[\'bordertype\'] ?> <?php echo $properties[\'bordercolor\'] ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        border: none;\r\n    <?php } ?>\r\n\r\n    <?php if(!empty($properties[\'useradius\'])) { ?>\r\n        border-radius: <?php echo $properties[\'borderradius1\'] ? $properties[\'borderradius1\'] : 0 ?>px <?php echo $properties[\'borderradius2\'] ? $properties[\'borderradius2\'] : 0 ?>px <?php echo $properties[\'borderradius4\'] ? $properties[\'borderradius4\'] : 0 ?>px <?php echo $properties[\'borderradius3\'] ? $properties[\'borderradius3\'] : 0 ?>px;\r\n    <?php } else { ?>\r\n        border-radius: 0px;\r\n    <?php } ?>\r\n\r\n    <?php if(!empty($properties[\'bgcolor\'])) { ?>background-color: <?php echo $properties[\'bgcolor\'] ?>; <?php } ?>\r\n\r\n\t<?php if(!empty($properties[\'hov_use_animation\'])) { ?>\r\n\t\ttransition: all <?php echo $properties[\'hov_duration\']  ?>s <?php echo $properties[\'hov_transition\']  ?>;\r\n\t<?php } else { ?>\r\n\t\ttransition: none;\r\n\t<?php } ?>\r\n}\r\n\r\n#page .upfront-button .button-preset-<?php echo $properties[\'id\']  ?>.upfront_cta:hover, #page .upfront-button.<?php echo $properties[\'id\']  ?>.live-preview-hover .upfront_cta {\r\n    <?php if(!empty($properties[\'hov_usetypography\']) && $properties[\'hov_usetypography\'] == \'yes\') { ?>\r\n        <?php if(!empty($properties[\'hov_color\'])) { ?>color: <?php echo $properties[\'hov_color\']  ?>; <?php } ?>\r\n        <?php if(!empty($properties[\'hov_fontface\'])) { ?>font-family: <?php echo $properties[\'hov_fontface\']  ?>; <?php } ?>\r\n        <?php if(!empty($properties[\'hov_fontsize\'])) { ?>font-size: <?php echo $properties[\'hov_fontsize\']  ?>px; <?php } ?>\r\n        <?php if(!empty($properties[\'hov_lineheight\'])) { ?>line-height: <?php echo $properties[\'hov_lineheight\']  ?>;<?php } ?>\r\n        <?php if(!empty($properties[\'hov_fontstyle_weight\'])) { ?>font-weight: <?php echo $properties[\'hov_fontstyle_weight\']  ?>;<?php } ?>\r\n        <?php if(!empty($properties[\'hov_fontstyle_style\'])) { ?>font-style: <?php echo $properties[\'hov_fontstyle_style\']  ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        <?php if(!empty($properties[\'color\'])) { ?>color: <?php echo $properties[\'color\']  ?>; <?php } ?>\r\n        <?php if(!empty($properties[\'fontface\'])) { ?>font-family: <?php echo $properties[\'fontface\']  ?>; <?php } ?>\r\n        <?php if(!empty($properties[\'fontsize\'])) { ?>font-size: <?php echo $properties[\'fontsize\']  ?>px; <?php } ?>\r\n        <?php if(!empty($properties[\'fontstyle_weight\'])) { ?>font-weight: <?php echo $properties[\'fontstyle_weight\']  ?>;<?php } ?>\r\n        <?php if(!empty($properties[\'fontstyle_style\'])) { ?>font-style: <?php echo $properties[\'fontstyle_style\']  ?>;<?php } ?>\r\n        <?php if(!empty($properties[\'lineheight\'])) { ?>line-height: <?php echo $properties[\'lineheight\']  ?>;<?php } ?>\r\n    <?php } ?>\r\n\r\n    <?php if(!empty($properties[\'hov_useborder\']) && $properties[\'hov_useborder\'] == \'yes\') { ?>\r\n        <?php if(!empty($properties[\'hov_borderwidth\']) && !empty($properties[\'hov_bordertype\']) && !empty($properties[\'hov_bordercolor\'])) { ?>border: <?php echo $properties[\'hov_borderwidth\'] ?>px <?php echo $properties[\'hov_bordertype\'] ?> <?php echo $properties[\'hov_bordercolor\'] ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        <?php if(!empty($properties[\'useborder\'])) { ?>\r\n            <?php if(!empty($properties[\'borderwidth\']) && !empty($properties[\'bordertype\']) && !empty($properties[\'bordercolor\'])) { ?>border: <?php echo $properties[\'borderwidth\'] ?>px <?php echo $properties[\'bordertype\'] ?> <?php echo $properties[\'bordercolor\'] ?>;<?php } ?>\r\n        <?php } else { ?>\r\n            border: none;\r\n        <?php } ?>\r\n    <?php } ?>\r\n\r\n    <?php if(!empty($properties[\'hov_useradius\']) && $properties[\'hov_useradius\'] == \'yes\') { ?>\r\n        border-radius: <?php echo !empty($properties[\'hov_borderradius1\']) ? $properties[\'hov_borderradius1\'] : 0 ?>px <?php echo !empty($properties[\'hov_borderradius2\']) ? $properties[\'hov_borderradius2\'] : 0 ?>px <?php echo !empty($properties[\'hov_borderradius4\']) ? $properties[\'hov_borderradius4\'] : 0 ?>px <?php echo !empty($properties[\'hov_borderradius3\']) ? $properties[\'hov_borderradius3\'] : 0 ?>px;\r\n    <?php } else { ?>\r\n        <?php if(!empty($properties[\'useradius\'])) { ?>\r\n            border-radius: <?php echo $properties[\'borderradius1\'] ? $properties[\'borderradius1\'] : 0 ?>px <?php echo $properties[\'borderradius2\'] ? $properties[\'borderradius2\'] : 0 ?>px <?php echo $properties[\'borderradius4\'] ? $properties[\'borderradius4\'] : 0 ?>px <?php echo $properties[\'borderradius3\'] ? $properties[\'borderradius3\'] : 0 ?>px;\r\n        <?php } else { ?>\r\n            border-radius: 0px;\r\n        <?php } ?>\r\n    <?php } ?>\r\n\r\n    <?php if(!empty($properties[\'hov_usebgcolor\']) && $properties[\'hov_usebgcolor\'] == \'yes\') { ?>\r\n        <?php if(!empty($properties[\'hov_bgcolor\'])) { ?>background-color: <?php echo $properties[\'hov_bgcolor\'] ?>; <?php } ?>\r\n    <?php } else { ?>\r\n        <?php if(!empty($properties[\'bgcolor\'])) { ?>background-color: <?php echo $properties[\'bgcolor\'] ?>; <?php } ?>\r\n    <?php } ?>\r\n}\r\n\r\n#page .upfront-button .button-preset-<?php echo $properties[\'id\']  ?>.upfront_cta:focus, #page .upfront-button.<?php echo $properties[\'id\']  ?>.live-preview-focus .upfront_cta {\r\n    <?php if(!empty($properties[\'focus_usetypography\']) && $properties[\'focus_usetypography\'] == \'yes\') { ?>\r\n        <?php if(!empty($properties[\'focus_color\'])) { ?>color: <?php echo $properties[\'focus_color\']  ?>; <?php } ?>\r\n        <?php if(!empty($properties[\'focus_fontface\'])) { ?>font-family: <?php echo $properties[\'focus_fontface\']  ?>; <?php } ?>\r\n        <?php if(!empty($properties[\'focus_fontsize\'])) { ?>font-size: <?php echo $properties[\'focus_fontsize\']  ?>px; <?php } ?>\r\n        <?php if(!empty($properties[\'focus_lineheight\'])) { ?>line-height: <?php echo $properties[\'focus_lineheight\']  ?>;<?php } ?>\r\n        <?php if(!empty($properties[\'focus_fontstyle_weight\'])) { ?>font-weight: <?php echo $properties[\'focus_fontstyle_weight\']  ?>;<?php } ?>\r\n        <?php if(!empty($properties[\'focus_fontstyle_style\'])) { ?>font-style: <?php echo $properties[\'focus_fontstyle_style\']  ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        <?php if(!empty($properties[\'color\'])) { ?>color: <?php echo $properties[\'color\']  ?>; <?php } ?>\r\n        <?php if(!empty($properties[\'fontface\'])) { ?>font-family: <?php echo $properties[\'fontface\']  ?>; <?php } ?>\r\n        <?php if(!empty($properties[\'fontsize\'])) { ?>font-size: <?php echo $properties[\'fontsize\']  ?>px; <?php } ?>\r\n        <?php if(!empty($properties[\'fontstyle_weight\'])) { ?>font-weight: <?php echo $properties[\'fontstyle_weight\']  ?>;<?php } ?>\r\n        <?php if(!empty($properties[\'fontstyle_style\'])) { ?>font-style: <?php echo $properties[\'fontstyle_style\']  ?>;<?php } ?>\r\n        <?php if(!empty($properties[\'lineheight\'])) { ?>line-height: <?php echo $properties[\'lineheight\']  ?>;<?php } ?>\r\n    <?php } ?>\r\n\r\n    <?php if(!empty($properties[\'focus_useborder\']) && $properties[\'focus_useborder\'] == \'yes\') { ?>\r\n        <?php if(!empty($properties[\'focus_borderwidth\']) && !empty($properties[\'focus_bordertype\']) && !empty($properties[\'focus_bordercolor\'])) { ?>border: <?php echo $properties[\'focus_borderwidth\'] ?>px <?php echo $properties[\'focus_bordertype\'] ?> <?php echo $properties[\'focus_bordercolor\'] ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        <?php if(!empty($properties[\'useborder\'])) { ?>\r\n            <?php if(!empty($properties[\'borderwidth\']) && !empty($properties[\'bordertype\']) && !empty($properties[\'bordercolor\'])) { ?>border: <?php echo $properties[\'borderwidth\'] ?>px <?php echo $properties[\'bordertype\'] ?> <?php echo $properties[\'bordercolor\'] ?>;<?php } ?>\r\n        <?php } else { ?>\r\n            border: none;\r\n        <?php } ?>\r\n    <?php } ?>\r\n\r\n    <?php if(!empty($properties[\'focus_useradius\']) && $properties[\'focus_useradius\'] == \'yes\') { ?>\r\n        border-radius: <?php echo !empty($properties[\'focus_borderradius1\']) ? $properties[\'focus_borderradius1\'] : 0 ?>px <?php echo !empty($properties[\'focus_borderradius2\']) ? $properties[\'focus_borderradius2\'] : 0 ?>px <?php echo !empty($properties[\'focus_borderradius4\']) ? $properties[\'focus_borderradius4\'] : 0 ?>px <?php echo !empty($properties[\'focus_borderradius3\']) ? $properties[\'focus_borderradius3\'] : 0 ?>px;\r\n    <?php } else { ?>\r\n        <?php if(!empty($properties[\'useradius\'])) { ?>\r\n            border-radius: <?php echo $properties[\'borderradius1\'] ? $properties[\'borderradius1\'] : 0 ?>px <?php echo $properties[\'borderradius2\'] ? $properties[\'borderradius2\'] : 0 ?>px <?php echo $properties[\'borderradius4\'] ? $properties[\'borderradius4\'] : 0 ?>px <?php echo $properties[\'borderradius3\'] ? $properties[\'borderradius3\'] : 0 ?>px;\r\n        <?php } else { ?>\r\n            border-radius: 0px;\r\n        <?php } ?>\r\n    <?php } ?>\r\n\r\n    <?php if(!empty($properties[\'focus_usebgcolor\']) && $properties[\'focus_usebgcolor\'] == \'yes\') { ?>\r\n        <?php if(!empty($properties[\'focus_bgcolor\'])) { ?>background-color: <?php echo $properties[\'focus_bgcolor\'] ?>; <?php } ?>\r\n    <?php } else { ?>\r\n        <?php if(!empty($properties[\'bgcolor\'])) { ?>background-color: <?php echo $properties[\'bgcolor\'] ?>; <?php } ?>\r\n    <?php } ?>\r\n}\r\n\r\n<?php if(!empty($properties[\'preset_style\'])) { ?><?php echo $properties[\'preset_style\'] ?><?php } ?>\r\n';});

define('elements/upfront-button/js/settings',[
	'scripts/upfront/element-settings/settings',
	'scripts/upfront/preset-settings/util',
	'text!elements/upfront-button/tpl/preset-style.html',
], function(ElementSettings, Util, styleTpl) {
	var l10n = Upfront.Settings.l10n.button_element;

	var ButtonSettings = ElementSettings.extend({
		panels: {
			Appearance: {
				mainDataCollection: 'buttonPresets',
				styleElementPrefix: 'button-preset',
				ajaxActionSlug: 'button',
				panelTitle: l10n.settings,
				styleTpl: styleTpl,
				presetDefaults: Upfront.mainData.presetDefaults.button,
				stateModules: {
					Static: [
						{
							moduleType: 'Colors',
							options: {
								title: l10n.settings.colors_label,
								multiple: false,
								single: true,
								abccolors: [
									{
										name: 'bgcolor',
										label: l10n.settings.button_bg_label
									},
								],
								fields: {
									use: 'usebgcolor'
								}
							}
						},
						{
							moduleType: 'Typography',
							options: {
								state: 'static',
								title: l10n.settings.typography_label,
								fields: {
									typeface: 'fontface',
									fontstyle: 'fontstyle',
									weight: 'fontstyle_weight',
									style: 'fontstyle_style',
									size: 'fontsize',
									line_height: 'lineheight',
									color: 'color',
								}
							}
						},
						{
							moduleType: 'Radius',
							options: {
								state: 'static',
								max_value: 100,
								fields: {
									use: 'useradius',
									lock: 'borderradiuslock',
									radius: 'radius',
									radius_number: 'radius_number',
									radius1: 'borderradius1',
									radius2: 'borderradius2',
									radius3: 'borderradius3',
									radius4: 'borderradius4'
								}
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'static',
								fields: {
									use: 'useborder',
									width: 'borderwidth',
									type: 'bordertype',
									color: 'bordercolor',
								}
							}
						}
					],
					Hover: [
						{
							moduleType: 'Colors',
							options: {
								state: 'hover',
								title: l10n.settings.colors_label,
								multiple: false,
								toggle: true,
								single: true,
								prepend: 'hov_',
								abccolors: [
									{
										name: 'hov_bgcolor',
										label: l10n.settings.button_bg_label
									},
								],
								fields: {
									use: 'hov_usebgcolor'
								}
							}
						},
						{
							moduleType: 'Typography',
							options: {
								state: 'hover',
								title: l10n.settings.typography_label,
								toggle: true,
								prepend: 'hov_',
								fields: {
									typeface: 'hov_fontface',
									fontstyle: 'hov_fontstyle',
									weight: 'hov_fontstyle_weight',
									style: 'hov_fontstyle_style',
									size: 'hov_fontsize',
									line_height: 'hov_lineheight',
									color: 'hov_color',
									use: 'hov_usetypography'
								}
							}
						},
						{
							moduleType: 'Radius',
							options: {
								state: 'hover',
								max_value: 100,
								prepend: 'hov_',
								fields: {
									use: 'hov_useradius',
									lock: 'hov_borderradiuslock',
									radius: 'hov_radius',
									radius_number: 'hov_radius_number',
									radius1: 'hov_borderradius1',
									radius2: 'hov_borderradius2',
									radius3: 'hov_borderradius3',
									radius4: 'hov_borderradius4'
								}
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'hover',
								prepend: 'hov_',
								fields: {
									use: 'hov_useborder',
									width: 'hov_borderwidth',
									type: 'hov_bordertype',
									color: 'hov_bordercolor',
								}
							}
						},
						{
							moduleType: 'HovAnimation',
							options: {
								state: 'hover',
								title: '',
								toggle: true,
								fields: {
									use: 'hov_use_animation',
									duration: 'hov_duration',
									easing: 'hov_transition',
								}
							}
						}
					],
					Focus: [
						{
							moduleType: 'Colors',
							options: {
								state: 'focus',
								title: l10n.settings.colors_label,
								multiple: false,
								toggle: true,
								single: true,
								prepend: 'focus_',
								abccolors: [
									{
										name: 'focus_bgcolor',
										label: l10n.settings.button_bg_label
									},
								],
								fields: {
									use: 'focus_usebgcolor'
								}
							}
						},
						{
							moduleType: 'Typography',
							options: {
								state: 'focus',
								title: l10n.settings.typography_label,
								toggle: true,
								prepend: 'focus_',
								fields: {
									typeface: 'focus_fontface',
									fontstyle: 'focus_fontstyle',
									weight: 'focus_fontstyle_weight',
									style: 'focus_fontstyle_style',
									size: 'focus_fontsize',
									line_height: 'focus_lineheight',
									color: 'focus_color',
									use: 'focus_usetypography'
								}
							}
						},
						{
							moduleType: 'Radius',
							options: {
								state: 'focus',
								max_value: 100,
								prepend: 'focus_',
								fields: {
									use: 'focus_useradius',
									lock: 'focus_borderradiuslock',
									radius: 'focus_radius',
									radius_number: 'focus_radius_number',
									radius1: 'focus_borderradius1',
									radius2: 'focus_borderradius2',
									radius3: 'focus_borderradius3',
									radius4: 'focus_borderradius4'
								}
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'focus',
								prepend: 'focus_',
								fields: {
									use: 'focus_useborder',
									width: 'focus_borderwidth',
									type: 'focus_bordertype',
									color: 'focus_bordercolor',
								}
							}
						}
					]
				},
				
				migrateElementStyle: function(styles) {
					//replace button class
					styles = styles.replace(/upfront-button/, 'upfront_cta');
					
					return styles;
				},
				
				migratePresetProperties: function(newPreset) {
					
					var preset = this.property('preset') ? this.clear_preset_name(this.property('preset')) : 'default',
						props = this.presets.findWhere({id: preset}),
						obj = {};

					_.each(props.attributes, function(preset_value, index) {
						
						if(index === 'id' || index === 'name' || index === 'theme_preset') {
							return;
						}
						
						obj[index] = preset_value;
					});
					
					//Migrate properties from existing preset
					newPreset.set(obj);
				},
			}
		},
		title: l10n.settings.label
	});

	// Generate presets styles to page
	Util.generatePresetsToPage('button', styleTpl);

	return ButtonSettings;
});


define('text!elements/upfront-button/tpl/ubutton.html',[],function () { return '<a href="<?php echo $href ?>" target="<?php echo $linkTarget ?>" style="text-align: <?php echo $align ?>;" class="button-style upfront_cta button-preset-<?php echo $preset ?>"><?php echo $content ?></a>';});

(function ($) {
define('ubutton',[
	'elements/upfront-button/js/model',
	'elements/upfront-button/js/element',
	'elements/upfront-button/js/settings',
	'scripts/upfront/link-model',
	'scripts/upfront/preset-settings/util',
	'text!elements/upfront-button/tpl/ubutton.html',
	'text!elements/upfront-button/tpl/preset-style.html'
], function(ButtonModel, ButtonElement, ButtonSettings, LinkModel, PresetUtil, buttonTpl, settingsStyleTpl) {

var l10n = Upfront.Settings.l10n.button_element;

var singleclickcount = 0;
var elementClasses = '';
var ButtonView = Upfront.Views.ObjectView.extend({
	model: ButtonModel,
	className: 'upfront-button',
	buttonTpl: Upfront.Util.template(buttonTpl),
	initialize: function() {
		var me = this;

		//Get all element classes without preset
		this.elementClasses = this.$el.attr('class');

		if(! (this.model instanceof ButtonModel)){
			this.model = new ButtonModel({properties: this.model.get('properties')});
		}

		this.events = _.extend({}, this.events, {
			'click a.uf-click-to-edit-text' : 'placeholderClick',
			'click a.redactor_act': 'onOpenPanelClick',
			'click .upfront-save_settings': 'onOpenPanelClick',
			'click .open-item-controls': 'onOpenItemControlsClick'
		});

		this.delegateEvents();

		this.model.get('properties').bind('change', this.render, this);
		this.model.get('properties').bind('change', this.handle_visual_padding_hint, this);
		this.model.get('properties').bind('add', this.render, this);
		this.model.get('properties').bind('remove', this.render, this);
		this.listenTo(this.model, 'change:preset', this.updatePresetClass);

		Upfront.Events.on('entity:deactivated', this.stopEdit, this);

		this.listenTo(Upfront.Events, "theme_colors:update", this.update_colors, this);

		this.listenTo(Upfront.Events, "theme_colors:update", this.render, this);

		if (this.property('link') === false) {
			this.link = new LinkModel({
				type: Upfront.Util.guessLinkType(this.property('href')),
				url: this.property('href'),
				target: this.property('linkTarget')
			});
			this.property('link', this.link.toJSON());
		} else {
			this.link = new LinkModel(this.property('link'));
		}

		me.listenTo(this.link, 'change', function() {
			me.property('link', me.link.toJSON());
		});

	},

	placeholderClick: function(e) {
		e.preventDefault();
	},

	updatePresetClass: function() {
		this.clearPresetClass(this.$el);
		this.$el.addClass(this.property('preset'));
	},
	
	clearPresetClass: function($el) {
		$el.removeClass();
		$el.addClass(this.elementClasses);
	},

	getCleanurl: function(url) {
		//this one removes any existing # anchor postfix from the url
		var urlParts;
		if(!url){
			url = location.href;
		}

		if(url.indexOf('?dev=true') != -1) url = url.replace('?dev=true', '');

		if(url.indexOf('#') == -1) return url;

		urlParts = url.split('#');

		if(urlParts[0].trim() != '')
			return urlParts[0];
		else
			return location.href.replace('?dev=true', '');
	},

	getUrlanchor: function(url) {
		// this does almost the opposite of the above function

		if(typeof(url) == 'undefined') var url = $(location).attr('href');

		if(url.indexOf('#') >=0) {
			var tempurl = url.split('#');
			return tempurl[1];
		} else return false;
	},

	get_anchors: function () {
		var regions = Upfront.Application.layout.get("regions"),
			anchors = [];
		;
		regions.each(function (r) {
			r.get("modules").each(function (module) {
				module.get("objects").each(function (object) {
					var anchor = object.get_property_value_by_name("anchor");
					if (anchor && anchor.length) anchors[anchor] = object;
				});
			});
		});
		return anchors;
	},

	update_colors: function () {
		var me = this,
			preset = this.model.get_property_value_by_name("preset"),
			props = PresetUtil.getPresetProperties('button', preset) || {}
		;

		if (_.size(props) <= 0) return false; // No properties, carry on

		PresetUtil.updatePresetStyle('button', props, settingsStyleTpl);

	},

	clear_preset_name: function(preset) {
		preset = preset.replace(' ', '-');
		preset = preset.replace(/[^-a-zA-Z0-9]/, '');
		return preset;
	},

	get_content_markup: function () {
		var props = this.extract_properties();

		//Check if preset is empty and set it to currentpreset (porting old data to new preset manager)
		if(props.preset === "" && props.currentpreset != "") {
			props.preset = props.currentpreset;
			this.model.set_property('preset', props.currentpreset)
		}

		props.href = this.link.get('url');
		props.linkTarget = this.link.get('target');

		props.preset = props.preset || 'default';

		props.preset = this.clear_preset_name(props.preset);

		var preset_props = Upfront.Views.Editor.Button.Presets.get(props.preset);

		return this.buttonTpl(props);
	},

	extract_properties: function() {
		var props = {};
		this.model.get('properties').each(function(prop){
			props[prop.get('name')] = prop.get('value');
		});
		return props;
	},

	saveTitle: function(target) {
		this.property('content', target.html());
	},

	is_edited: function () {
		var is_edited = this.model.get_property_value_by_name('is_edited');
		return is_edited ? true : false;
	},

	onOpenPanelClick: function(event) {
		event.preventDefault();
		this.toggleLinkPanel();
	},

	onOpenItemControlsClick: function() {
		this.$el.toggleClass('controls-visible');
		if (this.$el.hasClass('controls-visible')) {
			this.$el.addClass('controls-visible');
			this.controlsVisible = true;
		} else {
			this.controlsVisible = false;
		}
	},

	// createInlineControlPanel: function() {
	// 	var panel = new Upfront.Views.Editor.InlinePanels.ControlPanel(),
	// 		visitLinkControl = new Upfront.Views.Editor.InlinePanels.Controls.VisitLink({
	// 			url: this.link.get('url')
	// 		}),
	// 		linkPanelControl = new Upfront.Views.Editor.InlinePanels.Controls.LinkPanel({
	// 			model: this.link,
	// 			button: false,
	// 			icon: 'link',
	// 			tooltip: 'link',
	// 			id: 'link'
	// 		});
	// 		var me = this;

	// 	this.listenTo(this.link, 'change', function() {
	// 		visitLinkControl.setLink(me.link.get('url'));
	// 		this.$el.find('a').attr('href', me.link.get('url'));
	// 	});

	// 	panel.items = _([
	// 		linkPanelControl,
	// 		visitLinkControl
	// 	]);

	// 	var imageControlsTpl = '<span class="open-item-controls"></span><div class="uimage-controls image-element-controls upfront-ui"></div>';
	// 	this.$el.append(imageControlsTpl);
	// 	panel.render();
	// 	this.$el.find('.uimage-controls').append(panel.el);
	// 	panel.delegateEvents();
	// },

	toggleLinkPanel: function() {
		var me = this;
		if (this.$el.hasClass('stayOpen')) {
			this.$el.removeClass('stayOpen');
			me.render();
		} else {
			this.$el.addClass('stayOpen');
		}
	},


	on_render: function() {
		var me = this,
		blurTimeout = false;
		this.delegateEvents();
		var $target = this.$el.find('.upfront-object-content a.upfront_cta');
		  $target.ueditor({
				linebreaks: true,
				disableLineBreak: true,
				airButtons: ['stateAlignCTA', 'upfrontIcons'],
				placeholder: 'Click here',
				autostart: false
			})
			.on('start', function(){
				Upfront.Events.trigger('upfront:element:edit:start', 'text');
			})
			.on('stop', function(){
				me.property('align', $target.css('text-align'), true);
				Upfront.Events.trigger('upfront:element:edit:stop');
				me.render();
			})
			.on('syncAfter', function(){
				me.saveTitle($(this));
			});

		// this.createInlineControlPanel();
		this.clearPresetClass(this.$el);
		this.$el.find('.upfront-button').addClass(this.property('preset'));
	},
	stopEdit: function() {
		var $target = this.$el.find('.upfront-object-content a.upfront_cta');
		$target.trigger('blur');
		Upfront.Events.trigger('upfront:element:edit:stop');
	},

	property: function(name, value, silent) {
		if(typeof value != "undefined"){
			if(typeof silent == "undefined")
				silent = true;
			return this.model.set_property(name, value, silent);
		}
		return this.model.get_property_value_by_name(name);
	},

	createLinkControl: function() {
		var me = this,
			linkPanelControl = new Upfront.Views.Editor.InlinePanels.Controls.LinkPanel({
				model: this.link,
				button: false,
				icon: 'link',
				tooltip: l10n.edit_link,
				id: 'link'
			})
		;

		this.listenTo(this.link, 'change', function() {
			//Hide LinkTo button
			//this.visitLinkControl.setLink(me.link.get('url'));
			this.$el.find('a').attr('href', me.link.get('url'));
		});


		return linkPanelControl;
	},
	
	/* Hide LinkTo button */
	/*
	createVisitLinkControl: function() {
		var me = this,
			visitLinkControl = new Upfront.Views.Editor.InlinePanels.Controls.VisitLink({
				url: this.link.get('url'),
				icon: 'visit-link',
				tooltip: l10n.visit_link,
				id: 'visit-link',
				linkLabel: {
					unlink: '',
					lightbox: '',
					anchor: '',
					entry: '',
					external: '',
					email: ''
				}
			})
		;

		this.visitLinkControl = visitLinkControl;

		return visitLinkControl;
	},
	*/

	getControlItems: function(){
		return _([
			this.createLinkControl(),
			//this.createVisitLinkControl(),
			this.createPaddingControl(),
			this.createControl('settings', l10n.settings.label, 'on_settings_click')
		]);
	}
});


var ButtonMenuList = Upfront.Views.ContextMenuList.extend({
	initialize: function() {
		var me = this;
		this.menuitems = _([
		    new Upfront.Views.ContextMenuItem({
				get_label: function() {

					var linktype = Upfront.Util.guessLinkType(me.for_view.property('href'));
					if(linktype == 'lightbox')
						return 'Open Lightbox';
					else if(linktype == 'anchor')
						return 'Scroll to Anchor';
					else if(linktype == 'entry')
						return 'Visit Post/Page';
					else
						return 'Visit Link';
				},
				action: function() {
					Upfront.Util.visitLink(me.for_view.property('href'));
				}
		    })
		]);
	}
});

Upfront.Application.LayoutEditor.add_object("Button", {
	"Model": ButtonModel,
	"View": ButtonView,
	"Element": ButtonElement,
	"Settings": ButtonSettings,
	cssSelectors: {
		'.upfront_cta': {label: l10n.css.container_label, info: l10n.css.container_info}
	},
	cssSelectorsId: Upfront.data.ubutton.defaults.type
});
Upfront.Models.ButtonModel = ButtonModel;
Upfront.Views.ButtonView = ButtonView;

});
})(jQuery);


define('text!elements/upfront-posts/tpl/views.html',[],function () { return '<div id="initial">\r\n\t<div class="upfront_posts-initial-wrapper upfront-initial-overlay-wrapper">\r\n\t\t<div class="upfront_posts-initial-content">\r\n\t\t\t<div class="options"></div>\r\n\t\t\t<a class="continue" href="#continue">{{l10n.continue}}&nbsp;&raquo;</a>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n\r\n\r\n<div id="loading">\r\n\t<p class="loading">{{l10n.loading}}</p>\r\n</div>\r\n\r\n\r\n<div id="error">\r\n\t<p class="error">{{l10n.error}}</p>\r\n</div>\r\n\r\n\r\n<div id="list">\r\n\t<ul>\r\n\t\t{{posts}}\r\n\t</ul>\r\n\t{{pagination}}\r\n</div>\r\n\r\n\r\n<div id="single">\r\n\t<ul>\r\n\t\t{{posts}}\r\n\t</ul>\r\n</div>\r\n\r\n\r\n<div id="part-options-part_visible">\r\n\t<div class="name_action_wrapper"></div>\r\n</div>\r\n<div id="part-options-part_name">\r\n\t<span class="part_name">{{part.name}}</span>\r\n</div>\r\n<div id="part-options-part_action">\r\n\t<span class="part_action"><a href="#edit-options">{{l10n.edit}}</a></span>\r\n</div>\r\n<div id="part-options-part_wrapper">\r\n\t<div class="options {{part.part}}-options">\r\n\t\t<div class="option"></div>\r\n\t\t<span class="edit_part"><a href="#edit-html">{{l10n.edit_html}}</a></span>\r\n\t</div>\r\n</div>';});

(function ($) {
define('elements/upfront-posts/js/post-list-views',[
	'text!elements/upfront-posts/tpl/views.html'
], function(tpl) {

var l10n = Upfront.Settings.l10n.posts_element;
var $template = $(tpl);

var Views = {

	DEFAULT: "initial",


	initial: Backbone.View.extend({
		className: 'upfront_posts-initial upfront-initial-overlay-wrapper',
		tpl: _.template($template.filter("#initial").html()),
		events: {
			'click [href="#continue"]': "dispatch",
		},
		render: function () {
			var opts = new Upfront.Views.Editor.Field.Radios({
					model: this.model,
					property: 'display_type',
					label: l10n.display_type_label_initial,
					layout: 'horizontal-inline',
					icon_class: 'upfront-posts-display_type',
					values: [
						{label: l10n.single_post, value: 'single', icon: 'upfront-posts-single'},
						{label: l10n.post_list, value: 'list', icon: 'upfront-posts-list'}
					]
				}),
				row = this.element.parent_module_view.model.get_property_value_by_name('row'),
				height = row ? row * Upfront.Settings.LayoutEditor.Grid.baseline : 0;
			opts.on("changed", function (value) {
				this.model.set_property(this.options.property, value, true);
			}, opts);
			opts.render();

			this.$el.empty().append(this.tpl({l10n: l10n}));
			this.$el.css('min-height', ( height > 150 ? height : 150 ));
			this.$el.find(".options").empty().append(opts.$el);
		},
		dispatch: function (e) {
			e.preventDefault();
			e.stopPropagation();

			var has_type = !!this.model.get_property_value_by_name('display_type');
			if (!has_type) return false;

			this.model.trigger("change");
		},
	}),


	_view: Backbone.View.extend({

		render: function () {
			var me = this,
				model = Upfront.Util.model_to_json(this.model),
				props = model.properties || {},
				query = {}
			;
			if (window._upfront_get_current_query) query = window._upfront_get_current_query();
			//console.log(query);
			this._posts_load = Upfront.Util
				.post({
					action: "upfront_posts-load",
					data: {
						props: props,
						query: query
					}
				})
				.success(function (response) {
					if (response.data && response.data.posts) {
						var posts = '';
						_.each(response.data.posts, function (post) {
							posts += post;
						});
						me.$el.empty().append(me.tpl.main({
							posts: posts,
							pagination: response.data.pagination,
							l10n: l10n
						}));
						// Unbind pagination clicks
						me.$el.find(".uf-pagination a")
							.off("click")
							.on("click", function (e) {
								e.preventDefault();
								e.stopPropagation();
								return false;
							})
						;
					}
					else me.$el.empty().append(me.tpl.error({l10n: l10n}));
				})
				.error(function () {
					me.$el.empty().append(me.tpl.error({l10n: l10n}));
				})
			;
			this.$el.empty().append(this.tpl.load({l10n: l10n}));
		}
	}),

};

Views.list = Views._view.extend({
	className: 'upfront_posts-list',
	tpl: {
		main: _.template($template.filter("#list").html()),
		error: _.template($template.filter("#error").html()),
		load: _.template($template.filter("#loading").html())
	},
});

Views.single = Views._view.extend({
	className: 'upfront_posts-single',
	tpl: {
		main: _.template($template.filter("#single").html()),
		error: _.template($template.filter("#error").html()),
		load: _.template($template.filter("#loading").html())
	},
});

return Views;

});
})(jQuery);

(function ($) {
define('elements/upfront-posts/js/post-list-meta-views',[
	'text!elements/upfront-posts/tpl/views.html',
	'scripts/redactor/ueditor-inserts'
], function(tpl, Inserts) {

	var l10n = Upfront.Settings.l10n.posts_element;
	var $template = $(tpl);

	var Meta = {
		Embed: Inserts.inserts.embed.extend({
			meta_fields: [],
			start: function () {
				var deferred = Inserts.inserts.embed.prototype.start.apply(this),
					me = this
				;
				this.on("manager:rendered", function (manager, main, bar) {
					if (!bar) return false;
					bar.$el
						.find("ul")
						.append('<li><a href="#" class="insert_field">' + l10n.meta_insert + '</a></li>')
						.find(".insert_field").on("click", function (e) {
							e.preventDefault();
							e.stopPropagation();
							me.prepare_fields_box(bar);
							return false;
						})
					;

				});
				return deferred;
			},
			prepare_fields_box: function (bar) {
				var me = this,
					model = Upfront.Util.model_to_json(this.model),
					props = model.properties || {},
					query = {}
				;
				if (window._upfront_get_current_query) query = window._upfront_get_current_query();

				if (!this.meta_fields || !this.meta_fields.length) {
					Upfront.Util
						.post({
							action: 'upfront_posts-list_meta',
							data: {
								props: props,
								query: query
							}
						})
						.success(function (response) {
							if (response && response.data && response.data.fields) me.meta_fields = response.data.fields;
							me.pop_fields_box(bar);
						})
					;
				} else this.pop_fields_box(bar);
			},
			pop_fields_box: function (bar) {
				var fields = this.meta_fields;
				Upfront.Popup.open(function () {
					var me = this,
						selection = new Meta.List({fields: fields})
					;
					selection.render();
					selection.on("done", function (code) {
						Upfront.Popup.close(code);
					});
					$(this).empty().append(selection.$el);
				}, {}, 'embed-shortcode').done(function (pop, code) {
					bar.trigger("insert", code);
				});
			}
		}),

		List: Backbone.View.extend({
			initialize: function (opts) {
				this.options = opts;
			},
			render: function () {
				var me = this,
					fields = this.options.fields,
					cbox = new Upfront.Views.Editor.Field.Checkboxes({
						default_value: 0,
						values: [{label: l10n.meta_toggle, value: 1}],
						change: function (val) {
							val = !!parseInt(val, 10);
							me.toggle_hidden(val);
						}
					})
				;
				cbox.render();
				this.$el
					.empty()
					.append("<h1>" + l10n.meta_fields + "</h1>")
					.append(cbox.$el)
				;
				_(fields).each(function (fld) {
					var field = new Meta.List_Field({code: fld});
					field.render();
					me.$el.append(field.$el);
					field.on("done", function (code) {
						me.trigger("done", code);
					});
				});
			},
			toggle_hidden: function (hide) {
				var $fld = this.$el.find(".wp_internal");
				if (hide) $fld.hide();
				else $fld.show();
			}
		}),

		List_Field: Backbone.View.extend({
			tagName: 'pre',
			events: { click: 'send_code' },
			initialize: function (opts) {
				this.code = opts.code;
			},
			send_code: function (e) {
				e.stopPropagation();
				e.preventDefault();
				if (!this.code) return false;
				this.trigger("done", '{{' + this.code + '}}');
			},
			render: function () {
				this.$el.empty().append('<code>' + this.code + '</code>');
				if ('_' === this.code.substr(0,1)) this.$el.addClass("wp_internal");
			}
		})
	};

	return Meta;
});
})(jQuery);

(function ($) {
define('elements/upfront-posts/js/post-list-settings-parts',[
	'text!elements/upfront-posts/tpl/views.html',
	'scripts/redactor/ueditor-inserts',
	'elements/upfront-posts/js/post-list-meta-views'
], function(tpl, Inserts, Meta) {

var l10n = Upfront.Settings.l10n.posts_element;
var $template = $(tpl);


var Parts = {
	Part: Backbone.View.extend({
		tagName: 'li',
		tpl: {
			top: _.template($template.filter("#part-options-part_visible").html()),
			name: _.template($template.filter("#part-options-part_name").html()),
			action: _.template($template.filter("#part-options-part_action").html()),
			wrapper: _.template($template.filter("#part-options-part_wrapper").html())
		},
		initialize: function (opts) {
			this.options = opts;
			this.set_options();
		},
		set_options: function () {},
		render: function () {
			this.$el
				.empty()
				.attr('data-part', this.options.part)
				.append(
					this.tpl.top({l10n: l10n})
				)
			;
			var $root = this.$el.find(".name_action_wrapper");
			$root
				.append(
					this.tpl.name({part: {name: l10n['part_' + this.options.part]}, l10n: l10n})
				)
				.append(
					this.tpl.action({l10n: l10n})
				)
			;
			this.get_options();
		},
		get_options: function () {
			this.$el.append(
				this.tpl.wrapper({part: {part: this.options.part}, l10n: l10n})
			);
			var $root = this.$el.find('div.' + this.options.part + '-options'),
				$option = $root.find(".option"),
				$action = this.$el.find(".part_action a"),
				me = this
			;

			// Render field (if any)
			if (this.field) {
				this.field.render();
				this.field.on("changed", function (value) {
					me.model.set_property(me.field.options.property, value);
				}, this);
				$option.append(this.field.$el);
			}

			$action.off('click').on("click", function (e) {
				e.preventDefault();
				e.stopPropagation();
				if (!$root.is(":visible")) {
					$root.show();
					me.$el.addClass("active");
				} else {
					$root.hide();
					me.$el.removeClass("active");
				}
				return false;
			});

			$root.find(".edit_part a").on("click", function (e) {
				e.preventDefault();
				e.stopPropagation();
				me.spawn_editor();
				return false;
			});

			$root.hide();
		},
		spawn_editor: function () {
			var me = this,
				tpl_name = 'post-part-' + this.options.part,
				template = this.model.get_property_value_by_name(tpl_name),
				embed_object = ('meta' === this.options.part ? Meta.Embed : Inserts.inserts.embed),
				editor = new embed_object({data: {code: template}, model: this.model})
			;
			editor
				.start()
				.done(function (view, code) {
					me.model.set_property(tpl_name, code);
				})
			;

			// Zero timeout, just shift off the queue
			setTimeout(function () {
				var manager = editor.get_manager ? editor.get_manager() : {};
				if (!manager.done) return false;
				// Listen to event
				return me.listenTo(Upfront.Events, 'element:settings:saved', function () {
					return manager.done();
				});
			});
		}
	})
};

Parts.Part_Author = Parts.Part.extend({});
Parts.Part_Title = Parts.Part.extend({});
Parts.Part_Read_more = Parts.Part.extend({});
Parts.Part_Meta = Parts.Part.extend({});

Parts.Part_Date_posted = Parts.Part.extend({
	set_options: function () {
		this.field = new Upfront.Views.Editor.Field.Text({
			model: this.model,
			label: l10n.format,
			label_style: 'inline',
			property: "date_posted_format"
		});
	}
});

Parts.Part_Categories = Parts.Part.extend({
	set_options: function () {
		this.field = new Upfront.Views.Editor.Field.Number({
			model: this.model,
			label: l10n.max_categories,
			label_style: 'inline',
			property: "categories_limit"
		});
	}
});

Parts.Part_Tags = Parts.Part.extend({
	set_options: function () {
		this.field = new Upfront.Views.Editor.Field.Number({
			model: this.model,
			label: l10n.max_tags,
			label_style: 'inline',
			property: "tags_limit"
		});
	}
});

Parts.Part_Comment_count = Parts.Part.extend({
	set_options: function () {
		this.field = new Upfront.Views.Editor.Field.Checkboxes({
			model: this.model,
			property: "comment_count_hide",
			values: [
				{label: l10n.hide_comments, value: '1'}
			]
		});
	}
});

Parts.Part_Content = Parts.Part.extend({
	set_options: function () {
		this.field = new Upfront.Views.Editor.Field.Number({
			model: this.model,
			label: l10n.limit_words,
			label_style: 'inline',
			property: "content_length"
		});
	}
});

Parts.Part_Featured_image = Parts.Part.extend({
	set_options: function () {
		this.field = new Upfront.Views.Editor.Field.Checkboxes({
			model: this.model,
			property: "resize_featured",
			values: [
				{label: l10n.resize_to_fit, value: '1'}
			]
		});
	}
});

Parts.Part_Gravatar = Parts.Part.extend({
	set_options: function () {
		this.field = new Upfront.Views.Editor.Field.Number({
			model: this.model,
			label: l10n.size_px,
			label_style: 'inline',
			property: "gravatar_size"
		});
	}
});


return {
	get_part: function (pt, model) {
		pt = pt || 'Part';
		var part = false,
			class_name = 'Part_' + pt.substr(0,1).toUpperCase() + pt.substr(1),
			pt_view = Parts[class_name] ? Parts[class_name] : Parts.Part
		;
		part = new pt_view({model: model, part: pt});
		return part;
	}
};

});
})(jQuery);

(function ($) {
define('elements/upfront-posts/js/post-list-settings-panels',[
	'text!elements/upfront-posts/tpl/views.html',
	'elements/upfront-posts/js/post-list-settings-parts',
	'scripts/upfront/element-settings/root-settings-panel'
], function(tpl, Parts, RootSettingsPanel) {

var l10n = Upfront.Settings.l10n.posts_element;
var $template = $(tpl);

Upfront.Util.post({
	"action": "upfront_posts-data"
}).success(function (initialData) {
	Panels._initial = initialData.data;
}); // End response wrap


var Panels = {
	_initial: {}
};

RootSettingsPanel = RootSettingsPanel.extend({
	is_active: function () {
		return this.$el.find(".uf-settings-panel__body").is(":visible");
	}
});

Panels.General = RootSettingsPanel.extend({	
	initialize: function (opts) {
		this.options = opts;
		var me = this,
			query = new QuerySettings({
				model: this.model,
			}),
			autorefresh = function (value) {
				this.model.set_property(this.options.property, value);
				if ('list_type' === this.options.property) {
					query.dispatch_settings();
				}
				me.trigger("settings:dispatched");
			},
			display_type = new Upfront.Views.Editor.Field.Radios({
				model: this.model,
				property: 'display_type',
				label: l10n.display_type_label,
				layout: 'horizontal-inline',
				icon_class: 'upfront-posts-display_type',
				values: [
					{label: l10n.single_post, value: 'single', icon: 'upfront-posts-single'},
					{label: l10n.post_list, value: 'list', icon: 'upfront-posts-list'}
				]
			}),
			list_type = new Upfront.Views.Editor.Field.Radios({
				model: this.model,
				property: 'list_type',
				label: l10n.list_type_label,
				layout: 'horizontal',
				values: [
					{label: l10n.post_list_custom, value: 'custom'},
					{label: l10n.post_list_tax, value: 'taxonomy'},
					{label: l10n.post_list_generic, value: 'generic'}
				]
			})
		;
		display_type.on("changed", autorefresh);
		list_type.on("changed", autorefresh);
		query.on("post:added", function () {
			this.trigger("post:added");
		}, this);
		query.on("post:removed", function () {
			this.trigger("post:removed");
		}, this);
		this.settings = _([
			new Upfront.Views.Editor.Settings.Item({
				model: this.model,
				title: l10n.query_settings,
				fields: [display_type, list_type]
			}),
			query
		]);
	},
	
	title: l10n.general_settings
});

var CustomSelectorField =  Upfront.Views.Editor.Field.Hidden.extend({
	events: function () {
		return _.extend({},
			Upfront.Views.Editor.Field.Hidden.prototype.events,
			{"click a[href=#add]": "select_posts"},
			{"click ol li a[href=#rmv]": "remove_post"}
		);
	},
	get_field_html: function () {
		var field = Upfront.Views.Editor.Field.Hidden.prototype.get_field_html.apply(this),
			values = this.get_decoded_values(this.options.property),
			is_single = 'single' === this.model.get_property_value_by_name('display_type'),
			string = values.length ? l10n.add_custom_post : l10n.select_custom_post
		;
		if (is_single) {
			string = l10n.select_custom_post;
			if (values) values = [_(values).first()];
		}
		field += '<i class="upfront-posts-custom-add_post"></i> <a href="#add">' + string + '</a>';
		if (_.isArray(values) && values.length > 0) {
			field += '<ol>';
			_.each(values, function (value) {
				if (!value) return false;
				field += '<li><span class="permalink">' + value.permalink + '</span><a href="#rmv" data-id="' + value.id + '"><i>&times;</i></a></li>';
			});
			field += '</ol>';
		}

		return '<div class="custom_posts">' + field + '</div>';
	},
	select_posts: function (e) {
		e.preventDefault();
		e.stopPropagation();
		var me = this;
		Upfront.Views.Editor.PostSelector
			.open()
			.done(function (post) {
				if (!post) return false;
				var id = post.get("ID"),
					link = post.get("permalink"),
					is_single = 'single' === me.model.get_property_value_by_name('display_type'),
					values = me.get_decoded_values(me.options.property)
				;
				if (is_single) {
					values = [{id: id, permalink: link}];
				} else {
					values.push({id: id, permalink: link});
					me.select_posts(e);
				}
				me.model.set_property(me.options.property, me.encode_values(values));
				me.trigger("post:added");
			})
		;
	},
	remove_post: function (e) {
		e.preventDefault();
		e.stopPropagation();
		var id = $(e.target).closest("a").attr("data-id"),
			values = this.get_decoded_values(this.options.property)
		;
		values = _(values).reject(function (value) {
			return value.id == id;
		});
		this.model.set_property(this.options.property, this.encode_values(values));
		this.trigger("post:removed");
	},
	get_decoded_values: function (property) {
		if (!property) return [];
		var val = this.model.get_property_value_by_name(property);
		return this.decode_values(val);
	},
	decode_values: function (raw) {
		if (!raw) return [];
		var values = raw && raw.length ? JSON.parse(decodeURIComponent(raw)) : [];
		return values;
	},
	encode_values: function (values) {
		return encodeURIComponent(JSON.stringify(values));
	}
});

var QuerySettings = Upfront.Views.Editor.Settings.Item.extend({
	group: false,
	_terms_cache: {},

	events: function () {
		return _.extend({},
			Upfront.Views.Editor.Settings.Item.prototype.events,
			{"click [id*=taxonomy] .upfront-field-select-option": "update_terms"}
		);
	},

	initialize: function (opts) {
		this.options = opts;
		this.dispatch_settings();
	},

	render: function () {
		Upfront.Views.Editor.Settings.Item.prototype.render.call(this);
		$('.upfront-chosen-select', this.$el).chosen({
			width: '230px'
		});
	},

	dispatch_settings: function () {
		var type = this.model.get_property_value_by_name('list_type');
		this.fields = _([]); // Pre-initialize the fields

		if ('custom' === type) this.populate_custom_items();
		else if ('taxonomy' === type) this.populate_tax_items();
		else this.populate_generic_items();
	},

	populate_custom_items: function () {
		var fld = new CustomSelectorField({
			model: this.model,
			property: 'posts_list',
		});
		fld.on("post:added", function () {
			this.trigger("post:added");
		}, this);
		fld.on("post:removed", function () {
			this.trigger("post:removed");
		}, this);
		this.fields = _([fld]);
	},

	populate_generic_items: function () {
		this.populate_shared_tax_generic_items();
		this.populate_pagination_items();
	},

	populate_tax_items: function () {
		var taxs = [], types = [];
		var display_type = this.model.get_property_value_by_name("display_type");
		_(Panels._initial.taxonomies).each(function (label, type) {
			taxs.push({label: label, value: type});
		});
		_(Panels._initial.post_types).each(function (label, type) {
			types.push({label: label, value: type});
		});

		this.fields = _([]);

		if ("list" === display_type) {
			this.populate_pagination_items();
			this.fields.push(new Upfront.Views.Editor.Field.Number({
				model: this.model,
				label: l10n.offset,
				property: "offset",
				min: 1,
				max: 20
			}));
		}
		this.fields.push(new Upfront.Views.Editor.Field.Select({
			model: this.model,
			label: l10n.post_type,
			property: "post_type",
			values: types
		}));
		this.fields.push(new Upfront.Views.Editor.Field.Select({
			model: this.model,
			label: l10n.taxonomy,
			property: "taxonomy",
			values: taxs
		}));
		this.fields.push(new Upfront.Views.Editor.Field.Chosen_Select({
			model: this.model,
			label: l10n.term,
			compact: true,
			property: "term",
			values: [{label:l10n.select_tax, value:"", disabled: true}]
		}));
		this.populate_shared_tax_generic_items();
		this.once("rendered", this.update_terms, this);
		this.once("rendered", function () {
			this.toggle_offset_based_on_pagination_value(this.model.get_property_value_by_name("pagination"));
		}, this);
	},

	populate_pagination_items: function () {
		var display_type = this.model.get_property_value_by_name("display_type"),
			me = this
		;
		if ("list" === display_type) {
			this.fields.push(new Upfront.Views.Editor.Field.Radios({
				model: this.model,
				label: l10n.pagination,
				property: "pagination",
				layout: "horizontal-inline",
				values: [
					{label:l10n.none, value:""},
					{label:l10n.numeric, value:"numeric"},
					{label:l10n.prev_next, value:"arrows"}
				],
				change: function (value) {
					me.toggle_offset_based_on_pagination_value(value);
				}
			}));
		}
	},

	toggle_offset_based_on_pagination_value: function (pagination) {
		if ("taxonomy" !== this.model.get_property_value_by_name("list_type")) return false;
		if ("numeric" === pagination || "arrows" === pagination) {
			this.model.set_property("offset", 1, true); // This is always 1 if we're paginating
			this.hide_offset_field();
		} else {
			this.show_offset_field();
		}
	},

	show_offset_field: function () {
		var $field = this.$el.find('input[name="offset"]').closest(".upfront-field-wrap-number");
		$field.show();
	},

	hide_offset_field: function () {
		var $field = this.$el.find('input[name="offset"]').closest(".upfront-field-wrap-number");
		$field.hide();
	},

	populate_shared_tax_generic_items: function () {
		var display_type = this.model.get_property_value_by_name("display_type");
		if ("list" === display_type) {
			this.fields.push(new Upfront.Views.Editor.Field.Number({
				model: this.model,
				label: l10n.limit,
				property: "limit",
				min: 1,
				max: 20
			}));
			this.fields.push(new Upfront.Views.Editor.Field.Radios({
				model: this.model,
				property: "sticky",
				label: l10n.sticky_posts,
				values: [
					{label: l10n.sticky_ignore, value: ""},
					{label: l10n.sticky_prepend, value: "prepend"},
					{label: l10n.sticky_exclude, value: "exclude"},
				]
			}));
		}
		this.fields.push(new Upfront.Views.Editor.Field.Radios({
			model: this.model,
			label: l10n.result_length,
			property: "content",
			layout: "horizontal-inline",
			values: [
				{label:l10n.excerpt, value:"excerpt"},
				{label:l10n.full_post, value:"content"}
			]
		}));
	},

	update_terms: function () {
		var me = this, taxonomy;

		this.fields.each(function (field) {
			if ("term" === field.property_name) return true;
			field.property.set({'value': field.get_value()}, {'silent': false});
		});

		taxonomy = this.model.get_property_value_by_name("taxonomy");
		if (!taxonomy) return false;

		if (this._terms_cache[taxonomy]) {
			var terms = this._terms_cache[taxonomy];
			return this._spawn_terms_element(terms);
		}

		Upfront.Util.post({
			"action": "upfront_posts-terms",
			"taxonomy": taxonomy}
		).success(function (terms) {
			var term_values = [];
			_(terms.data).each(function (label, id) {
				term_values.push({label: label, value: id});
			});
			me._terms_cache[taxonomy] = term_values;
			me._spawn_terms_element(term_values);
		});
	},

	_spawn_terms_element: function (terms) {
		var field = new Upfront.Views.Editor.Field.Chosen_Select({
			model: this.model,
			label: l10n.term,
			compact: true,
			property: "term",
			values: terms,
			default_value: this.model.get_property_value_by_name('term')
		});
		this.fields._wrapped[4] = field;
		this.$el.empty();
		this.render();
	}

});






Panels.PostParts = RootSettingsPanel.extend({
	title: l10n.post_part_settings,
	
	initialize: function (opts) {
		this.options = opts;
		var me = this,
			parts = _.map(Upfront.data.upfront_posts.default_parts, function (part) {
				return {label: l10n['part_' + part], value: part}
			}),
			sorter = new SortSettings({
				model: this.model
			}),
			autorefresh = function (value) {
				this.model.set_property(this.options.property, this.get_value());
				this.model.set_property("post_parts", this.get_value(), false);
				me.trigger("settings:dispatched");
			},
			post_parts = new Upfront.Views.Editor.Field.Checkboxes({
				model: this.model,
				property: 'enabled_post_parts',
				layout: 'horizontal-inline',
				values: parts
			})
		;
		post_parts.on("changed", autorefresh, post_parts);
		this.settings = _([
			new PostPartsPickerSettings({
				model: this.model,
				title: l10n.post_parts_picker,
				fields: [post_parts]
			}),
			sorter
		]);
	},
});

var PostPartsPickerSettings = Upfront.Views.Editor.Settings.Item.extend({
	className: 'uposts-parts-picker-setting'
});

var SortSettings = Upfront.Views.Editor.Settings.Item.extend({
	group: false,
	initialize: function (opts) {
		this.options = opts;
		this.fields = _([
			new SortSettings_Sorter({
				model: this.model,
				property: "post_parts",
				label: l10n.post_parts_sorter
			})
		]);
	}
});

var SortSettings_Sorter = Upfront.Views.Editor.Field.Hidden.extend({
	render: function () {
		Upfront.Views.Editor.Field.Hidden.prototype.render.apply(this);
		this.$el.append('<ul class="post_parts"></ul>');
		var me = this,
			enabled_parts = this.model.get_property_value_by_name("enabled_post_parts"),
			saved_parts = this.model.get_property_value_by_name(this.options.property),
			parts = [],
			$sortable = this.$el.find("ul")
		;

		parts = saved_parts && saved_parts.length
			? saved_parts
			: enabled_parts
		;

		_.each(parts, function (part, idx) {
			if (enabled_parts.indexOf(part) < 0) return true; // This one is disabled, move on
			var pt = Parts.get_part(part, me.model);
			pt.render();
			$sortable.append(pt.$el);
		});
		$sortable.sortable({
			stop: function (e, ui) {
				var parts = $sortable.sortable('toArray', {attribute: 'data-part'});
				me.model.set_property(me.options.property, parts, false);
			}
		});
		$sortable.disableSelection();
	},
	get_value: function () {
		return this.model.get_property_value_by_name(this.options.property);
	}
});

return Panels;

});
})(jQuery);


define('text!elements/upfront-widget/tpl/preset-style.html',[],function () { return '<?php if(!empty($properties[\'preset_style\'])) { ?><?php echo $properties[\'preset_style\'] ?><?php } ?>\r\n';});

(function ($) {
define('elements/upfront-posts/js/post-list-settings',[
	'elements/upfront-posts/js/post-list-settings-panels',
	'scripts/upfront/element-settings/settings',
	'scripts/upfront/element-settings/advanced-settings',
	'scripts/upfront/preset-settings/util',
	'text!elements/upfront-widget/tpl/preset-style.html'
], function(Panels, ElementSettings, AdvancedSettings, Util, styleTpl) {

var l10n = Upfront.Settings.l10n.posts_element;

var PostsSettings = ElementSettings.extend({
	panels: {
		Appearance: {
			mainDataCollection: 'postsPresets',
			styleElementPrefix: 'posts-preset',
			ajaxActionSlug: 'posts',
			panelTitle: l10n.settings,
			presetDefaults: Upfront.mainData.presetDefaults.posts,
			styleTpl: styleTpl,
			
			migrateElementStyle: function(styles) {
				//replace posts container which is one line with preset
				styles = styles.replace(/.uposts-object/, '');
				
				return styles;
			},
		},
	},

	initialize: function (opts) {
		// Call the super constructor here, so that the appearance panel is instantiated
		this.constructor.__super__.initialize.call(this, opts);
		
		this.options = opts;
		var me = this,
			general = new Panels.General({model: this.model}),
			post_parts = new Panels.PostParts({model: this.model})
		;
		general.on("settings:dispatched", this.rerender, this);
		general.on("post:removed", this.rerender, this);
		general.on("post:added", this.rerender, this);
		post_parts.on("settings:dispatched", this.rerender, this);

		this.panels = _.extend({ General: general, PostParts: post_parts }, this.panels);
	},

	rerender: function () {
		var active_panel = -1,
			panels = _(this.panels);
			me = this,
			general = new Panels.General({model: this.model}),
			post_parts = new Panels.PostParts({model: this.model})
		;
		
		panels.each(function (pl, idx) {
			if (pl && pl.is_active && pl.is_active()) active_panel = idx;
		});

		this.$el.empty();
		
		this.initialize(this.options);

		this.render();

		if (active_panel.length >= 0 && this.toggle_panel) this.toggle_panel(active_panel);		
	},

	/**
	 * Toggles the active panel on
	 *
	 * @param {Int} panel_idx Panel index to toggle on
	 */
	toggle_panel: function (panel_idx) {
		if (panel_idx < 0) return false;
		_.each(this.panels, function (panel, idx) {
			if (panel_idx === idx && (panel || {}).showBody) panel.showBody();
			else if ((panel || {}).hideBody) panel.hideBody();
		});
	},
	
	title: l10n.posts_settings,

	get_title: function () {
		return l10n.settings;
	}
});

// Generate presets styles to page
Util.generatePresetsToPage('posts', styleTpl);

return PostsSettings;

});
})(jQuery);

(function ($) {
define('uposts',[
	'text!elements/upfront-posts/tpl/views.html',
	'elements/upfront-posts/js/post-list-views',
	'elements/upfront-posts/js/post-list-settings'
], function(tpl, Views, PostsSettings) {

var l10n = Upfront.Settings.l10n.posts_element;
var $template = $(tpl);


var PostsModel = Upfront.Models.ObjectModel.extend({
	init: function () {
		var properties = Upfront.data.upfront_posts
			? _.clone(Upfront.data.upfront_posts)
			: {}
		;
		properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + '-object');
		this.init_properties(properties);
	}
});


var PostsView = Upfront.Views.ObjectView.extend({

	init: function () {
		this.listenTo(Upfront.Events, 'csseditor:open', this.on_csseditor_open);
		this.listenTo(Upfront.Events, 'csseditor:closed', this.on_csseditor_closed);
	},

	on_render: function () {
		var type = this.model.get_property_value_by_name("display_type");
		this.render_type_view(type);
		// Let's not render min-height (remove it)
		this.$el.find('> .upfront-object').css('min-height', '');
		this.parent_module_view.$el.find('> .upfront-module').css('min-height', '');
		this.add_region_class('upfront-region-container-has-posts', true);
	},

	render_type_view: function (type) {
		type = type || Views.DEFAULT;
		var me = this,
			view = Views[type]
			? new Views[type]({model: this.model})
			: new Views[Views.DEFAULT]({model: this.model})
		;
		view.element = this;
		view.render();
		this.$el.find(".upfront-object-content").empty().append(view.$el);
		if ( view._posts_load ){
			view._posts_load.success(function(){
				me.adjust_featured_images();
			});
		}
	},

	on_csseditor_open: function (id) {
		if ( id != this.model.get_element_id() ) return;
		this.listenTo(Upfront.Application.cssEditor, 'updateStyles', this.adjust_featured_images);
	},

	on_csseditor_closed: function (id) {
		if ( id != this.model.get_element_id() ) return;
		this.stopListening(Upfront.Application.cssEditor, 'updateStyles');
	},

	adjust_featured_images: function () {
		this.$el.find('.thumbnail').each(function(){
			var height = $(this).height(),
				width = $(this).width(),
				$img = $(this).find('img'),
				img_h, img_w;
			if ( $(this).attr('data-resize') == "1" ) {
				$img.css({ height: "", width: "" });
				img_h = $img.height();
				img_w = $img.width();
				if ( height/width > img_h/img_w )
					$img.css({ height: '100%', width: 'auto', marginLeft: (width-Math.round(height/img_h*img_w))/2, marginTop: "" });
				else
					$img.css({ height: 'auto', width: '100%', marginLeft: "", marginTop: (height-Math.round(width/img_w*img_h))/2 });
			}
			else {
				img_h = $img.height();
				if ( height != img_h )
					$img.css('margin-top', (height-img_h)/2);
			}
		});
	},
	
	cleanup: function () {
		this.remove_region_class('upfront-region-container-has-posts', true);
	}
});


var PostsElement = Upfront.Views.Editor.Sidebar.Element.extend({

	render: function () {
		this.$el.addClass('upfront-icon-element upfront-icon-element-posts');
		this.$el.html(l10n.element_name);
	},

	add_element: function () {

		var object = new PostsModel(),
			module = new Upfront.Models.Module({
				name: "",
				properties: [
					{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
					{"name": "class", "value": "c24 upfront-posts_module"},
					{"name": "has_settings", "value": 0},
					{"name": "row", "value": Upfront.Util.height_to_row(210)}
				],
				objects: [object]
			})
		;
		this.add_module(module);
	}
});


Upfront.Application.LayoutEditor.add_object("Uposts", {
	"Model": PostsModel,
	"View": PostsView,
	"Element": PostsElement,
	"Settings": PostsSettings,
	cssSelectors: {
		'.uposts-object ul': {label: l10n.css.container_label, info: l10n.css.container_info},
		'.uposts-object li': {label: l10n.css.post_label, info: l10n.css.post_info},
		'.uposts-object li .date_posted': {label: l10n.css.date_label, info: l10n.css.date_info},
		'.uposts-object li .author': {label: l10n.css.author_label, info: l10n.css.author_info},
		'.uposts-object li .post_categories': {label: l10n.css.categories_label, info: l10n.css.categories_info},
		'.uposts-object li .comment_count': {label: l10n.css.comment_count_label, info: l10n.css.comment_count_info},
		'.uposts-object li .content': {label: l10n.css.content_label, info: l10n.css.content_info},
		'.uposts-object li .gravatar': {label: l10n.css.gravatar_label, info: l10n.css.gravatar_info},
		'.uposts-object li .read_more': {label: l10n.css.read_more_label, info: l10n.css.read_more_info},
		'.uposts-object li .post_tags': {label: l10n.css.post_tags_label, info: l10n.css.post_tags_info},
		'.uposts-object li .thumbnail': {label: l10n.css.thumbnail_label, info: l10n.css.thumbnail_info},
		'.uposts-object li .title': {label: l10n.css.title_label, info: l10n.css.title_info},
	},
	cssSelectorsId: Upfront.data.upfront_posts.type
});
Upfront.Models.PostsModel = PostsModel;
Upfront.Views.PostsView = PostsView;


});
}(jQuery));


define('text!elements/upfront-search/tpl/usearch.html',[],function () { return '<div class="upfront-search">\r\n\t<form action="<?php echo $action ?>" method="GET">\r\n\t\t<input type="search" class="search-field search-<?php echo $iconClass ?>" name="s" value="" placeholder="<?php echo $placeholder ?>"/>\r\n\t\t<?php if($label == \'__image__\') { ?>\r\n\t\t\t<i class="icon-search"></i>\r\n\t\t<?php } ?>\r\n\t\t<?php if($label && $label != \'__image__\') { ?>\r\n\t\t\t<button class="search-button search-<?php echo $iconClass ?>"><?php echo $label ?></button>\r\n\t\t<?php } ?>\r\n    </form>\r\n\r\n</div>';});

(function ($) {
define('usearch',['text!elements/upfront-search/tpl/usearch.html'], function(tplSource) {

var l10n = Upfront.Settings.l10n.search_element;

/**
 * Define the model - initialize properties to their default values.
 * @type {Upfront.Models.ObjectModel}
 */
var UsearchModel = Upfront.Models.ObjectModel.extend({
	/**
	 * A quasi-constructor, called after actual constructor *and* the built-in `initialize()` method.
	 * Used for setting up instance defaults, initialization and the like.
	 */
	init: function () {
		var properties = _.clone(Upfront.data.usearch.defaults);
		properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + "-object");
		this.init_properties(properties);
	}
});

/**
 * View instance - what the element looks like.
 * @type {Upfront.Views.ObjectView}
 */
var UsearchView = Upfront.Views.ObjectView.extend({

	tpl: Upfront.Util.template(tplSource),
	initialize: function(options){
		if(! (this.model instanceof UsearchModel)){
			this.model = new UsearchModel({properties: this.model.get('properties')});
		}

		this.constructor.__super__.initialize.call(this, [options]);
	},
	/**
	 * Element contents markup.
	 * @return {string} Markup to be shown.
	 */
	get_content_markup: function() {
		var label = this.model.get_property_value_by_name("label"),
			data = {
				placeholder: this.model.get_property_value_by_name("placeholder"),
				label: label,
				action: '/',
				iconClass: label == '__image__' ? 'icon' : 'text',
				element_id: this.model.get_property_value_by_name("element_id")
			}
		;

		return this.tpl(data);
	},

	on_render: function () {
		var rounded = this.model.get_property_value_by_name("is_rounded"),
			color = this.model.get_property_value_by_name("color"),
			$me = this.$el.find('.upfront-editable_entity:first');
		if ( rounded == 1 )
			$me.addClass('rounded');
		else
			$me.removeClass('rounded');
		if ( color )
			$me.css('background-color', color);
		else
			$me.css('background-color', '');
	}
});

/**
 * Sidebar element class - this let you inject element into
 * sidebar elements panel and allow drag and drop element adding
 * @type {Upfront.Views.Editor.Sidebar.Element}
 */
var UsearchElement = Upfront.Views.Editor.Sidebar.Element.extend({
    priority: 200,
    draggable: false,
	/**
	 * Set up element appearance that will be displayed on sidebar panel.
	 */
	render: function () {
		this.$el.addClass('upfront-icon-element upfront-icon-element-search');
		this.$el.html(l10n.element_name);
	},

	/**
	 * This will be called by editor to request module instantiation, set
	 * the default module appearance here
	 */
	add_element: function () {
		var object = new UsearchModel(), // Instantiate the model
			// Since search entity is an object,
			// we don't need a specific module instance -
			// we're wrapping the search entity in
			// an anonymous general-purpose module
			module = new Upfront.Models.Module({
				"name": "",
				"properties": [
					{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
					{"name": "class", "value": "c6 upfront-search_module"},
					{"name": "has_settings", "value": 0},
					{"name": "row", "value": Upfront.Util.height_to_row(75)}
				],
				"objects": [
					object // The anonymous module will contain our search object model
				]
			})
		;
		// We instantiated the module, add it to the workspace
		this.add_module(module);
	}
});

// ----- Settings API -----
// We'll be working from the bottom up here.
// We will first define settings panels, and items for each panel.
// Then we'll slot in the panels in a settings instance.

// --- Field settings ---

/**
 * Field settings panel.
 * @type {Upfront.Views.Editor.Settings.Panel}
 */
var UsearchSettingsPanel = Upfront.Views.Editor.Settings.Panel.extend({
	/**
	 * Initialize the view, and populate the internal
	 * setting items array with Item instances.
	 */
	initialize: function (opts) {
		this.options = opts;
		this.settings = _([
      new Upfront.Views.Editor.Settings.Item({
        model: this.model,
				title: l10n.settings,
				fields: [
					new Upfront.Views.Editor.Field.Text({
						model: this.model,
						property: 'placeholder',
						label: l10n.placeholder_label
					})
				]
			}),
			new UsearchButtonSetting_Label({model: this.model})
		]);
	},
	/**
	 * Get the label (what will be shown in the settings overview)
	 * @return {string} Label.
	 */
	get_label: function () {
		return l10n.field;
	},
	/**
	 * Get the title (goes into settings title area)
	 * @return {string} Title
	 */
	get_title: function () {
		return l10n.field_settings;
	}
});

// --- Button settings ---

/**
 * Button settings - Label item
 * @type {Upfront.Views.Editor.Settings.Item}
 */
var UsearchButtonSetting_Label = Upfront.Views.Editor.Settings.Item.extend({
	/**
	 * Set up setting item appearance.
	 */
	render: function () {
		var me = this;
		var value = this.model.get_property_value_by_name("label"),
			value_text = '__image__' == value || '' == value || !value ? 'Custom text' : value,
			image = '<label for="search_type-image"><i class="icon-search"></i></label>',
			text = '<span class="search-search_text' + ((value !='' && value != '__image__') ? ' active' : '') + '" contenteditable="true">' + value_text + '</span>'
		;
		// Wrap method accepts an object, with defined "title" and "markup" properties.
		// The "markup" one holds the actual Item markup.
		this.wrap({
			"title": l10n.btn_content,
			"markup": '<input type="radio" id="search_type-image" name="search_type" value="__image__" ' + (value == '__image__' ? 'checked="checked"' : '') + ' /> ' + image +
				'<input type="radio" id="search_type-text" name="search_type" value="' + value_text + '" ' + ((value !='' && value != '__image__') ? 'checked="checked"' : '') + ' /> ' + text
		});

		this.$el.find(".search-search_placeholder").on('click', function() {
			$(this).trigger('input');
		});

		this.$el.find(".search-search_text").on("input", function () {
			$("#search_type-text").val($(this).text()).attr("checked", true);
			$(this).addClass('active');
		});

		this.$el.on("change", '#search_type-image, #search_type-text, #search_type-none', function() {

			if($(this).attr('id') == 'search_type-text' && $(this).prop('checked'))
				me.$el.find(".search-search_text").addClass('active');
			else
				me.$el.find(".search-search_text").removeClass('active');
		});

	},
	/**
	 * Defines under which Property name the value will be saved.
	 * @return {string} Property name
	 */
	get_name: function () {
		return "label";
	},
	/**
	 * Extracts the finalized value from the setting markup.
	 * @return {mixed} Value.
	 */
	get_value: function () {
		var $image = this.$el.find(':radio[name="search_type"]:checked');
		return $image.length ? $image.val() : '__image__';
	}

});

// --- Tie the settings together ---

/**
 * Search settings hub, populated with the panels we'll be showing.
 * @type {Upfront.Views.Editor.Settings.Settings}
 */
var UsearchSettings = Upfront.Views.Editor.Settings.Settings.extend({
	/**
	 * Bootstrap the object - populate the internal
	 * panels array with the panel instances we'll be showing.
	 */
	initialize: function (opts) {
    this.has_tabs = false;
		this.options = opts;
		this.panels = _([
			new UsearchSettingsPanel({model: this.model})
		]);
	},
	/**
	 * Get the title (goes into settings title area)
	 * @return {string} Title
	 */
	get_title: function () {
		return l10n.settings;
	}
});



// ----- Bringing everything together -----
// The definitions part is over.
// Now, to tie it all up and expose to the Subapplication.

Upfront.Application.LayoutEditor.add_object("Usearch", {
	"Model": UsearchModel,
	"View": UsearchView,
	"Element": UsearchElement,
	"Settings": UsearchSettings,
	cssSelectors: {
		'.upfront-search': {label: l10n.css.container_label, info: l10n.css.container_info},
		'input.search-field': {label: l10n.css.field_label, info: l10n.css.field_info},
		'button.search-button': {label: l10n.css.button_label, info: l10n.css.button_info}
	},
	cssSelectorsId: Upfront.data.usearch.defaults.type
});
Upfront.Models.UsearchModel = UsearchModel;
Upfront.Views.UsearchView = UsearchView;


});
})(jQuery);


define('text!elements/upfront-slider/tpl/uslider.html',[],function () { return '<div class="uslider slider-preset-<?php echo $preset ?> uslider-<?php echo $controlsWhen ?> uslider-<?php echo $style ?> uslider-<?php echo $transition ?> <?php echo !empty($captionBackground) ? \'uslider-caption-background\' : \'\' ?>"\r\n  id="uslider-<?php echo $element_id ?>"\r\n  data-item=".uslide"\r\n  data-auto="<?php echo $rotate ?>"\r\n  data-auto_height="<?php echo $production ?>"\r\n  data-adjust_slide_size="<?php echo $production ?>"\r\n  data-effect="<?php echo $transition ?>"\r\n  data-interval="<?php echo $rotateTime * 1000 ?>"\r\n  data-show_control="<?php echo $controlsWhen ?>"\r\n  data-control_num="<?php echo $dots /* && $production */ ? 1 : 0 ?>"\r\n  data-control_next_prev="<?php echo $arrows /* && $production */ ? 1 : 0 ?>"\r\n  data-starting_slide="<?php echo $startingSlide ?>"\r\n  data-caption_height="<?php echo $primaryStyle == \'below\' ? 1 : 0 ?>"\r\n>\r\n\t<?php if($slidesLength){ ?>\r\n\t<div class="uslides">\r\n\t\t<?php for($i=0; $i<$slidesLength; $i++) { ?>\r\n\t\t<div class="uslide uslide-<?php echo $slides[$i][\'style\'] ?>"\r\n\t\t\t<?php if($primaryStyle != \'notext\'){ ?>\r\n\t\t\t\tdata-caption-selector="#uslider-<?php echo $element_id ?> .caption-<?php echo $slides[$i][\'id\'] ?>"\r\n\t\t\t<?php } ?>\r\n\t\t\trel="<?php echo $slides[$i][\'id\'] ?>">\r\n\r\n\t\t\t<?php if($slides[$i][\'url\']){ ?>\r\n\t\t\t<a href="<?php echo $slides[$i][\'url\'] ?>" target="<?php echo $slides[$i][\'linkTarget\'] ?>" class="uslider-link uslide-image <?php echo $slides[$i][\'urlType\'] == \'image\' ? \' uslider_lightbox_link\' : \'\' ?>">\r\n\t\t\t<?php } else { ?>\r\n\t\t\t<div class="uslide-image">\r\n\t\t\t<?php } ?>\r\n\t\t\t\t<img src="<?php echo $slides[$i][\'src\'] ?>" style="min-width:100%, min-height:100%">\r\n\t\t\t<?php if($slides[$i][\'url\']){ ?>\r\n\t\t\t</a>\r\n\t\t\t<?php } else { ?>\r\n\t\t\t</div>\r\n\t\t\t<?php } ?>\r\n\r\n\t\t</div>\r\n\t\t<?php } ?>\r\n\t</div>\r\n\t<?php if($primaryStyle != \'notext\'){ ?>\r\n\t<div class="uslider-texts">\r\n\t\t<?php for($i=0; $i<$slidesLength; $i++) { ?>\r\n\t\t<div class="uslide-text caption-<?php echo $slides[$i][\'id\'] ?>" rel="<?php echo $slides[$i][\'id\'] ?>" style="background-color:<?php echo !empty($slides[$i][\'captionBackground\']) ? $slides[$i][\'captionBackground\'] : \'transparent\' ?>;color:<?php echo $slides[$i][\'captionColor\'] ?>">\r\n\t\t\t<div class="uslide-editable-text" placeholder="Slider description">\r\n\t\t\t\t<?php echo $slides[$i][\'text\'] ?>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<?php } ?>\r\n\t</div>\r\n\t<?php } ?>\r\n\t<?php } else { ?>\r\n\t<!-- No images in this slider -->\r\n\t<?php } ?>\r\n</div>\r\n\r\n<style type="text/css">\r\n\t/*<?php if($captionUseBackground) { ?>\r\n\t.uslide .uslide-caption {\r\n\t\tpadding: 5px 15px;\r\n\t}\r\n\t<?php } ?>*/\r\n\t#uslider-<?php echo $element_id ?> {\r\n\t\twidth: 100%;\r\n\t}\r\n\t#uslider-<?php echo $element_id ?> .uslide-caption {\r\n\t\twidth: <?php echo $textWidth ?>;\r\n\t}\r\n\t#uslider-<?php echo $element_id ?> .uslide-right .uslide-caption {\r\n\t\tmargin-left: <?php echo $imageWidth ?>;\r\n\t}\r\n\r\n\t#uslider-<?php echo $element_id ?> .uslide-right .uslide-image {\r\n\t\tfloat: left;\r\n\t}\r\n\r\n\t#uslider-<?php echo $element_id ?> .uslide-left .uslide-caption {\r\n\t\tfloat: left;\r\n\t}\r\n\r\n\t#uslider-<?php echo $element_id ?> .uslide-left .uslide-image {\r\n\t\tmargin-left: <?php echo $textWidth ?>\r\n\t}\r\n\t#uslider-<?php echo $element_id ?> .uslide-left .uslide-caption,\r\n\t#uslider-<?php echo $element_id ?> .uslide-right .uslide-caption {\r\n\t\theight: <?php echo $imageHeight ?>px;\r\n\t}\r\n\r\n\t#uslider-<?php echo $element_id ?> .uslide-left .uslide-image,\r\n\t#uslider-<?php echo $element_id ?> .uslide-right .uslide-image {\r\n\t\twidth: <?php echo $imageWidth ?>;\r\n\t}\r\n\r\n\t#uslider-<?php echo $element_id ?> .uslide-image {\r\n\t\theight: <?php echo $imageHeight ?>px;\r\n\t\tposition: relative;\r\n\t\toverflow: hidden;\r\n\t}\r\n\r\n\t<?php if ($usingNewAppearance === false) { ?>\r\n\t#uslider-<?php echo $element_id ?> .uslide-caption {\r\n\t\tbackground-color:<?php echo !empty($captionBackground) ? $captionBackground : \'transparent\' ?>;\r\n\t}\r\n\t<?php } ?>\r\n</style>\r\n';});


define('text!elements/upfront-slider/tpl/preset-style.html',[],function () { return '.slider-preset-<?php echo $properties[\'id\'] ?> .uslide-caption {\r\n\t<?php if(!empty($properties[\'captionBackground\'])) { ?>\r\n\tbackground: <?php echo $properties[\'captionBackground\'] ?>;\r\n\t<?php } ?>\r\n}\r\n\r\n/* Custom CSS */\r\n<?php if(!empty($properties[\'preset_style\'])) { ?><?php echo $properties[\'preset_style\'] ?><?php } ?>\r\n';});

define('elements/upfront-slider/js/settings',[
	'scripts/upfront/element-settings/settings',
	'scripts/upfront/element-settings/root-settings-panel',
	'scripts/upfront/preset-settings/util',
	'text!elements/upfront-slider/tpl/preset-style.html'
], function(ElementSettings, RootSettingsPanel, Util, styleTpl) {
	var l10n = Upfront.Settings.l10n.slider_element;

	var AppearancePanelConfig = {
		mainDataCollection: 'sliderPresets',
		styleElementPrefix: 'slider-preset',
		ajaxActionSlug: 'slider',
		panelTitle: l10n.settings,
		presetDefaults: Upfront.mainData.presetDefaults.slider,
		styleTpl: styleTpl,
		stateModules: {
			Global: [
				{
					moduleType: 'Selectbox',
					options: {
						state: 'global',
						default_value: 'notext',
						title: l10n.slider_styles,
						custom_class: 'slide_style',
						label: l10n.image_caption_position,
						fields: {
							name: 'primaryStyle'
						},
						values: [
							{ label: l10n.notxt, value: 'notext', icon: 'nocaption' },
							{ label: l10n.txtb, value: 'below', icon: 'below' },
							{ label: l10n.txto, value: 'over', icon: 'bottomOver' },
							{ label: l10n.txts, value: 'side', icon: 'right' }
						]
					}
				},
				{
					moduleType: 'Colors',
					options: {
						title: 'Colors',
						multiple: false,
						single: true,
						abccolors: [
							{
								name: 'captionBackground',
								label: l10n.caption_bg
							},
						]
					}
				},
			]
		},
		migratePresetProperties: function(newPreset) {
			var props = {};

			this.model.get('properties').each( function(prop) {
				props[prop.get('name')] = prop.get('value');
			});

			newPreset.set({
				'captionBackground': props.captionBackground,
				'primaryStyle' : props.primaryStyle
			});
		}
	};

	var LayoutPanel =  RootSettingsPanel.extend({
		className: 'uf-settings-panel upfront-settings_panel upfront-settings_panel_wrap uslider-settings',
		settings: [
			{
				type: 'SettingsItem',
				triggerChange: true,
				title: l10n.slider_behaviour,
				group: true,
				className: 'general_settings_item uslider-rotate-settings',
				fields: [
					{
						type: 'Checkboxes',
						property: 'rotate',
						layout: 'horizontal-inline',
						className: 'rotate',
						multiple: true,
						default_value: 0,
						values: [ { label: l10n.rotate_every, value: 'true' } ],
						change: function(value, parent) {
							if(value[0] === 'true') {
								parent.$el.find('.rotate-time').css('opacity', '1');
							} else {
								parent.$el.find('.rotate-time').css('opacity', '0.5');
							}
						},
					},
					{
						type: 'Number',
						className: 'rotate-time',
						property: 'rotateTime',
						min: 1,
						max: 60,
						step: 1,
						suffix: 'sec.'
					},
					{
						type: 'Select',
						property: 'transition',
						label: l10n.slider_transition,
						layout: 'horizontal-inline',
						icon_class: 'upfront-region-field-icon',
						className: 'uslider-transition-setting rotate-effect',
						default_value: 'crossfade',
						values: [
							{ label: l10n.slide_down, value: 'slide-down', icon: 'bg-slider-slide-down' },
							{ label: l10n.slide_up, value: 'slide-up', icon: 'bg-slider-slide-up' },
							{ label: l10n.slide_right, value: 'slide-right', icon: 'bg-slider-slide-right' },
							{ label: l10n.slide_left, value: 'slide-left', icon: 'bg-slider-slide-left' },
							{ label: l10n.crossfade, value: 'crossfade', icon: 'bg-slider-crossfade' }
						]
					}
				]
			},
			{
				type: 'SettingsItem',
				triggerChange: true,
				title: l10n.slider_controls,
				className: 'general_settings_item',
				fields: [
					{
						type: 'Select',
						label: l10n.slider_controls_style,
						className: 'slider-contrls-style',
						property: 'controls',
						default_value: 'arrows',
						values: [
							{label: l10n.dots, value: 'dots'},
							{label: l10n.arrows, value: 'arrows'},
							{label: l10n.both, value: 'both'}
						]
					},
					{
						type: 'Radios',
						property: 'controlsWhen',
						layout: 'horizontal-inline',
						default_value: 'hover',
						className: 'uslider-controlswhen-setting upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios',
						values: [
							{ label: l10n.on_hover, value: 'hover' },
							{ label: l10n.always, value: 'always' }
						]
					}
				]
			}
		],

		initialize: function(options) {
			this.constructor.__super__.initialize.call(this, options);

			this.on('rendered', function(){
				me.toggleColorSetting();
				var spectrum = false,
					currentColor = me.model.get_property_value_by_name('captionBackground'),
					// input = $('<input type="text" value="' + currentColor + '">'),
					$picker_place = $("<span></span>");
					setting = me.$('.ugallery-colorpicker-setting')
				;

				// setting.find('.upfront-field-wrap').append(input);
				setting.find('.upfront-field-wrap').append($picker_place);
				setting.find('input[name="captionUseBackground"]').on('change', function(){
					me.toggleColorPicker();
				});

				var color_picker = new Upfront.Views.Editor.Field.Color({
							blank_alpha : 0,
							model: me.model,
							property: 'captionBackground',
							default_value: '#ffffff',
							spectrum: {
								maxSelectionSize: 9,
								localStorageKey: "spectrum.recent_bgs",
								preferredFormat: "hex",
								chooseText: l10n.ok,
								showInput: true,
									allowEmpty:true,
									show: function(){
									spectrum = $('.sp-container:visible');
									},
								change: function(color) {
									var rgba = color.toRgbString();
									me.model.set_property('captionBackground', rgba, true);
									currentColor = rgba;
									me.model.trigger('background', rgba);
								},
								move: function(color) {
									var rgba = color.toRgbString();
									spectrum.find('.sp-dragger').css('border-top-color', rgba);
									spectrum.parent().find('.sp-dragger').css('border-right-color', rgba);
									me.parent_view.for_view.$el.find('.uslide-caption').css('background-color', rgba);
								},
								hide: function(){
									me.parent_view.for_view.$el.find('.uslide-caption').css('background-color', currentColor);
								}
							}
					});
				color_picker.render();
				$picker_place.html(color_picker.el);
				setting.find('.sp-replacer').css('display', 'inline-block');
				me.toggleColorPicker();
			});

			this.$el.on('change', 'input[name="primaryStyle"]', function(e){
				me.toggleColorSetting();
			});
		},

		toggleColorSetting: function(){
			var style = this.$('.uslider-style-setting').find('input:checked').val();
			if(style == 'notext')
				this.$('.ugallery-colorpicker-setting').hide();
			else
				this.$('.ugallery-colorpicker-setting').show();
		},

		toggleColorPicker: function(){
			var setting = this.$('.ugallery-colorpicker-setting'),
				color = setting.find('input:checked').val(),
				picker = setting.find('.sp-replacer')
			;
			if(color == "1"){
				picker.show();
			}
			else{
				picker.hide();
			}
		},

		title: l10n.general
	});


	var SlidesPanel =  RootSettingsPanel.extend({
		className: 'uf-settings-panel upfront-settings_panel upfront-settings_panel_wrap uslider-slides',
		settings: [
			{
				type: 'SettingsItem',
				group: false,
				fields: [
					{
						type: 'SlidesField'
					}
				]
			}
		],
		title: l10n.slides_order
	});

	var SliderSettings = ElementSettings.extend({
		panels: {
			Layout: LayoutPanel,
			Slides: SlidesPanel,
			Appearance: AppearancePanelConfig
		},
		title: l10n.settings
	});

	// Generate presets styles to page
	Util.generatePresetsToPage('slider', styleTpl);

	return SliderSettings;
});

(function ($) {

define('upfront_slider',[
	'text!elements/upfront-slider/tpl/uslider.html',
	'text!elements/upfront-slider/tpl/backend.html',
	'elements/upfront-slider/js/settings',
	'scripts/upfront/preset-settings/util',
	"scripts/upfront/link-model",
	'text!elements/upfront-slider/tpl/preset-style.html',
], function(sliderTpl, editorTpl, SliderSettings, PresetUtil, LinkModel, settingsStyleTpl){

var l10n = Upfront.Settings.l10n.slider_element;

//Slide Model
var Uslider_Slide = Backbone.Model.extend({
	//See library to know the defaults
	defaults: Upfront.data.uslider.slideDefaults
});

//Slide Collection
var Uslider_Slides = Backbone.Collection.extend({
	model: Uslider_Slide
});

/**
 * Define the model - initialize properties to their default values.
 * @type {Upfront.Models.ObjectModel}
 */
var USliderModel = Upfront.Models.ObjectModel.extend({
	/**
	 * A quasi-constructor, called after actual constructor *and* the built-in `initialize()` method.
	 * Used for setting up instance defaults, initialization and the like.
	 */
	init: function () {
		var properties = _.clone(Upfront.data.uslider.defaults);
		properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + "-object");
		this.init_properties(properties);
	}
});

/**
 * View instance - what the element looks like.
 * @type {Upfront.Views.ObjectView}
 */
var USliderView = Upfront.Views.ObjectView.extend({
	self: {},
	module_settings: {},
	tpl: Upfront.Util.template(sliderTpl),
	startingTpl: _.template($(editorTpl).find('#startingTpl').html()),

	initialize: function(options){
		var me = this;
		if(! (this.model instanceof USliderModel)){
			this.model = new USliderModel({properties: this.model.get('properties')});
		}

		this.model.view = this;

		this.constructor.__super__.initialize.call(this, [options]);

		this.events = _.extend({}, this.events, {
			'click .upfront-image-select': 'firstImageSelection',
			'click .upfront-icon-next': 'nextSlide',
			'click .upfront-icon-prev': 'prevSlide',
			'click .uslider-starting-options': 'checkStartingInputClick'
		});

		this.model.slideCollection = new Uslider_Slides(this.property('slides'));

		this.listenTo(this.model.slideCollection, 'add remove reset change', this.onSlidesCollectionChange);
		this.listenTo(this.model, 'change', this.onModelChange);

		this.listenTo(this.model, 'addRequest', this.openImageSelector);

		this.lastStyle = this.get_preset_properties().primaryStyle;

		this.listenTo(this.model, 'background', function(rgba){
			me.model.slideCollection.each(function(slide){
				slide.set('captionBackground', rgba);
			});
		});

		this.listenTo(Upfront.Events, "theme_colors:update", this.update_colors, this);

		this.listenTo(this.model, "preset:updated", this.preset_updated);

		this.listenTo(Upfront.Events, 'command:layout:save', this.saveResizing);
		this.listenTo(Upfront.Events, 'command:layout:save_as', this.saveResizing);

		//Temporary props for image resizing and cropping
		this.imageProps = {};
		this.cropHeight =  false;
		this.cropTimer =  false;
		this.cropTimeAfterResize = 500;

		//Current Slide index
		this.setCurrentSlide(0);
	},

	get_preset_properties: function() {
		var preset = this.model.get_property_value_by_name("preset"),
			props = PresetUtil.getPresetProperties('slider', preset) || {};

		return props;
	},

	/**
	 * Returns preset propery value
	 * @param key
	 * @returns {boolean}
     */
	get_preset_property: function(key){
		var preset_props = this.get_preset_properties();
		return preset_props[key] ? preset_props[key] : false;
	},

	preset_updated: function() {
		this.render();
	},

	update_colors: function () {

		var props = this.get_preset_properties();

		if (_.size(props) <= 0) return false; // No properties, carry on

		PresetUtil.updatePresetStyle('slider', props, settingsStyleTpl);

	},

	on_edit: function(){
		return false;
	},

	get_content_markup: function() {
		var me = this,
			props,
			rendered = {};

		this.checkStyles();

		props = this.extract_properties();

		if(!this.model.slideCollection.length){
			this.startingHeight = this.startingHeight || 225;
			return this.startingTpl({startingHeight: this.startingHeight, l10n: l10n});
		}

		props.properties = this.get_preset_properties();

		// Overwrite properties with preset properties
		if (props.properties.primaryStyle) {
			props.primaryStyle = props.properties.primaryStyle;
		}
		if (props.properties.captionBackground) {
			props.captionBackground = props.properties.captionBackground;
		}

		//Stop autorotate
		props.rotate = false;

		props.dots = _.indexOf(['dots', 'both'], props.controls) != -1;
		props.arrows = _.indexOf(['arrows', 'both'], props.controls) != -1;

		props.slides = this.model.slideCollection.toJSON();

		props.slidesLength = props.slides.length;

		props.imageWidth = props.primaryStyle == 'side' ?  Math.round(props.rightImageWidth / props.rightWidth * 100) + '%' : '100%';
		props.textWidth =  props.primaryStyle == 'side' ? Math.round((props.rightWidth - props.rightImageWidth) / props.rightWidth * 100) + '%' : '100%';

		props.imageHeight = '100%';
		if (props.slides.length) {
			var imageProps = me.imageProps[props.slides[0].id];
			if (imageProps) {
				props.imageHeight = imageProps.cropSize.height;
			} else {
				props.imageHeight = props.slides[0].cropSize.height;
			}
		}

		props.production = false;
		props.startingSlide = this.getCurrentSlide();

		props.l10 = l10n;

		props.usingNewAppearance = props.usingNewAppearance || false;

		rendered = this.tpl(props);

		var $rendered = $('<div></div>').append(rendered);

		this.model.slideCollection.each(function(slide){
			if(!me.imageProps[slide.id]){
				me.imageProps[slide.id] = {
					size: slide.get('size'),
					cropOffset: slide.get('cropOffset'),
					cropSize: slide.get('cropSize')
				};
			}

			var props = me.imageProps[slide.id],
				img = $rendered.find('.uslide[rel=' + slide.id + ']').height(props.size.height).find('img')
			;

			img.attr('src', slide.get('srcFull'))
				.css({
					position: 'absolute',
					width: props.size.width,
					height: props.size.height,
					top: 0-props.cropOffset.top,
					left: 0-props.cropOffset.left,
					'max-width': 'none',
					'max-height': 'none'
				})
				.parent().css({
					position: 'relative',
					height: me.cropHeight || slide.get('cropSize').height,
					overflow: 'hidden'
				})
			;
		});

		return $rendered.html();
	},

	on_render: function() {
		var me = this;

		setTimeout( function() {
			var slider = me.$el.find('.upfront-output-uslider'),
			options = slider.find('.uslider').data();

			slider.find('.uslides').on('rendered', function(){
				Upfront.Events.trigger('entity:object:refresh', me);
			});
			slider.find('.uslides').upfront_default_slider(options);

			slider.find('.uslide-above').each(function(){
				var slide = $(this);
				slide.find('.uslide-caption').remove().prependTo(slide);
			});
			slider.find('.uslide-left').each(function(){
				var slide = $(this);
				slide.find('.uslide-caption').remove().prependTo(slide);
			});
			slider.find('.uslide-bottomOver, .uslide-middleCover, .uslide-bottomCover, .uslide-topCover').each(function() {
				var slide = $(this);
				slide.find('.uslide-caption').remove().prependTo(slide.find('.uslide-image'));
			});
			me.prepareSlider();
		}, 100);

		if(!me.parent_module_view)
			return;

		//Bind resizing events
		if(!me.parent_module_view.$el.data('resizeHandling')){
			me.parent_module_view.$el
				.on('resizestart', $.proxy(me.onElementResizeStart, me))
				.on('resize', $.proxy(me.onElementResizing, me))
				.on('resizestop', $.proxy(me.onElementResize, me))
				.data('resizeHandling', true)
			;
		}

		if(!this.model.slideCollection.length)
			return;

		if(!this.$el.parent().length) {
			setTimeout(function(){
				me.on_render();
			}, 100);
		}


		this.update_caption_controls();
	},

	update_caption_controls: function(){
		var me = this,
			panel = new Upfront.Views.Editor.InlinePanels.Panel()
			;

		panel.items = this.getControlItems();
		panel.render();
		_.delay( function(){
			me.controls.$el.html( panel.$el )
			me.controls.$el.css("width", "auto");
		}, 400);
	},
	hideSliderNavigation: function(){
		this.$('.upfront-default-slider-nav').hide();
		this.$('.upfront-default-slider-nav-prev').hide();
		this.$('.upfront-default-slider-nav-next').hide();

		this
			.listenTo(Upfront.Events, 'csseditor:open', function(elementId){
				if(elementId == this.property('element_id')){
					this.$('.upfront-default-slider-nav').show();
					this.$('.upfront-default-slider-nav-prev').show();
					this.$('.upfront-default-slider-nav-next').show();
				}
			})
			.listenTo(Upfront.Events, 'csseditor:closed', function(elementId){
				if(elementId == this.property('element_id')){
					this.$('.upfront-default-slider-nav').hide();
					this.$('.upfront-default-slider-nav-prev').hide();
					this.$('.upfront-default-slider-nav-next').hide();
				}
			})
		;
	},

	prepareSlider: function(){
		var me = this,
			wrapper = me.$('.uslide-image'),
			//controls = me.createSlideControls(),
			text = me.$('.uslide-editable-text'),
			currentSlide = this.model.slideCollection.at(this.getCurrentSlide())
		;

		// controls.setWidth(wrapper.width());
		// controls.render();
		// if(typeof(currentSlide) != 'undefined') {
		// 	me.$('.uslides').append(
		// 		$('<div class="uimage-controls upfront-ui" rel="' + currentSlide.id + '"></div>').append(controls.$el)
		// 	);
		// }
		me.onSlideShow();

		// this.controls = controls;

		me.$('.uslide').css({height: 'auto'});

		//Enable text editors
		text.each(function () {
			var text = $(this); // Re-bind to local
			if (text.data('ueditor')) return true; // If ueditor is already up, carry on

			text.ueditor({
					autostart: false,
					upfrontMedia: false,
					upfrontImages: false,
					placeholder: l10n.slide_desc,
					linebreaks: false,
				})
				.on('start', function() {
					var id = $(this).closest('.uslide').attr('rel'),
						slide = me.model.slideCollection.get(id)
					;

					me.$el.addClass('upfront-editing');
					Upfront.Events.trigger('upfront:element:edit:start', 'text');

					$(this).on('syncAfter', function(){
						slide.set('text', $(this).html(), {silent: true});
					})
					.on('stop', function(){
						slide.set('text', $(this).html());
						me.property('slides', me.model.slideCollection.toJSON());
						me.$el.removeClass('upfront-editing');

						Upfront.Events.trigger('upfront:element:edit:stop');

						// Trigger cleanup if possible
						var ed = $(this).data('ueditor');
						if (ed.redactor) ed.redactor.events.trigger('cleanUpListeners');

						me.render();
					});
				})
			;
		});

		if(me.get_preset_properties().primaryStyle == 'side'){
			me.setImageResizable();
		}

		//Adapt slider height to the image crop
		if(typeof(currentSlide) != 'undefined') {
			var textHeight = this.get_preset_properties().primaryStyle == 'below' ? this.$('.uslide[rel=' + currentSlide.id + ']').find('.uslide-caption').outerHeight() : 0;
			me.$('.uslides').css({ 'padding-top' : wrapper.height() + textHeight});
		}
	},

	updateSlideControls: function(){
		// if(typeof(this.controls) !== 'undefined') {
		// 	this.controls.remove();
		// }

		// var controls = this.createSlideControls();
		// controls.render();

		// this.$('.uimage-controls').append(controls.$el);

		// if(typeof(this.model.slideCollection.at(this.getCurrentSlide())) !== 'undefined') {
		// 	this.$('.uimage-controls').attr('rel', this.model.slideCollection.at(this.getCurrentSlide()).id);
		// }

		// this.controls = controls;

		if(typeof(this.$control_el) !== 'undefined') {
			this.$control_el.find('.upfront-element-controls').remove();
		}

		if(typeof(this.controls) !== 'undefined') {
			this.controls = undefined;
		}

		this.updateControls();
	},

	nextSlide: function(e){
		e.preventDefault();
		this.$('.uslides').upfront_default_slider('next');
	},

	prevSlide: function(e){
		e.preventDefault();
		this.$('.uslides').upfront_default_slider('prev');
	},

	checkStyles: function() {
		var me = this,
			primary = this.get_preset_properties().primaryStyle,
			defaults = {
				below: 'below',
				over: 'bottomOver',
				side: 'right'
			}
		;

		if(primary != this.lastStyle){
			this.model.slideCollection.each(function(slide){
				var style = slide.get('style');
				if(primary == 'below' && _.indexOf(['below', 'above'], style) == -1 ||
					primary == 'over' && _.indexOf(['topOver', 'bottomOver', 'topCover', 'middleCover', 'bottomCover'], style) == -1 ||
					primary == 'side' && _.indexOf(['right', 'left'], style) == -1)
						slide.set('style', defaults[primary]);

				if(primary == 'side' || me.lastStyle == 'side'){
					var wrap = me.$('.uslide[rel=' + slide.id + ']').find('.uslide-image');
					me.imageProps[slide.id] = me.calculateImageResize({width: wrap.width(), height:wrap.height()}, slide);
				}
			});
			if(primary == 'side' || this.lastStyle == 'side')
				this.setTimer();
			this.lastStyle = primary;
			this.onSlidesCollectionChange();
		}

	},
	checkStartingInputClick: function(e){
		//Hack to make the radio buttons work in the starting layout
		e.stopPropagation(); //This is not a good practice
	},
	firstImageSelection: function(e){
		e.preventDefault();
		var primaryStyle = this.get_preset_properties().primaryStyle,
			style = 'nocaption'
		;
		if(primaryStyle == 'over')
			style = 'bottomOver';
		else if(primaryStyle == 'below')
			style = 'below';
		else if(primaryStyle == 'side')
			style = 'right';

		this.property('style', style);

		return this.openImageSelector();
	},

	setImageResizable: function(){
		var me = this,
			current = this.$('.upfront-default-slider-item-current'),
			$slide = current.find('.uslide-image'),
			elementWidth = me.$('.upfront-object').outerWidth(),
			elementCols, colWidth,
			text = current.find('.uslide-caption'),
			id = current.attr('rel'),
			slide = this.model.slideCollection.get(id) || this.model.slideCollection.at(this.getCurrentSlide()),
			height = false,
			style = slide.get('style')
		;

		//Stop any other resizable slide
		this.$('.ui-resizable').resizable('destroy');

		if(style == 'nocaption')
			return;

		$slide.resizable({
			handles: style == 'right' ? 'e' : 'w',
			helper: 'uslider-resize-handler',
			start: function(e, ui){
				if(!ui.element.hasClass('uslide-image'))
					return;
				elementWidth = me.$('.upfront-object').outerWidth();
				elementCols = me.get_element_columns();
				colWidth = me.get_element_max_columns_px() / me.get_element_max_columns();
				height = $slide.height();

				ui.element.parent().closest('.ui-resizable').resizable('disable');

				$slide.resizable('option', {
					minWidth: colWidth * 3,
					maxWidth: (elementCols - 3) * colWidth,
					grid: [colWidth, 100], //Second number is never used (fixed height)
					handles: style == 'right' ? 'e' : 'w',
					helper: 'uslider-resize-handler',
					minHeigth: height,
					maxHeight: height
				});
			},
			resize: function(e, ui){
				if(!ui.element.hasClass('uslide-image'))
					return;
				var imageWidth = ui.helper.width(),
					textWidth = elementWidth - imageWidth - 30,
					textCss = {width: textWidth},
					imgCss = {width: imageWidth}
				;
				me.calculateImageResize({width: imageWidth, height: ui.element.height()}, slide);

				if(style == 'right')
					textCss['margin-left'] = imageWidth;
				else
					imgCss['margin-left'] = textWidth;

				text.css(textCss);
				$slide.css(imgCss);
			},
			stop: function(e, ui){
				if(!ui.element.hasClass('uslide-image'))
					return;
				var helperWidth = ui.helper.width(),
					imageWidth = helperWidth > (elementCols - 3) * colWidth ? (elementCols - 3) * colWidth : (helperWidth < 3 * colWidth ? 3 * colWidth : helperWidth),
					imageCols = Math.round((imageWidth - (colWidth - 15))/ colWidth) + 1,
					percentage = Math.floor(imageCols / elementCols * 100)
				;

				$slide.css({width: percentage + '%'});

				me.model.slideCollection.each(function(slide){
					if(slide.get('style') != 'nocaption')
						me.imageProps[slide.id] = me.calculateImageResize({width: $slide.width(), height: ui.element.height()}, slide);
				});

				me.cropHeight = ui.element.height();

				me.property('rightWidth', elementCols, true);
				me.property('rightImageWidth', imageCols, false);

				me.setTimer();
				me.parent_module_view.$el.children('.upfront-module').resizable('enable');
			}
		});
	},

	setTimer: function(){
		var me = this;
		if(me.cropTimer){
			clearTimeout(me.cropTimer);
			me.cropTimer = false;
		}
		me.cropTimer = setTimeout(function() {
			var slide = me.model.slideCollection.at(me.getCurrentSlide()),
				editor = me.$('.uslide[rel=' + slide.id + ']').find('.uslide-editable-text');

			if (editor.length && editor.data('redactor')) {
				editor.on('stop', function(){
					me.saveTemporaryResizing();
				});
			} else {
				me.saveTemporaryResizing();
			}
		}, me.cropTimeAfterResize);
	},

	onSlideShow: function(){
		var me = this;
		this.$('.uslides').on('slidein', function(e, slide, index){
			if(slide){
				me.setCurrentSlide(index);
				me.updateSlideControls();
				me.$('.uimage-controls').attr('rel', slide.attr('rel'));
				if(me.get_preset_properties().primaryStyle == 'side')
					me.setImageResizable();

				if(me.get_preset_properties().primaryStyle == 'below'){
					//Adapt the height to take care of the caption
					me.$('.uslides').css({ 'padding-top' : slide.find('.uslide-image').outerHeight() + slide.find('.uslide-caption').outerHeight()});
				}
			}
		});
	},

	// createSlideControls: function() {
	// 	var me = this,
	// 		panel = new Upfront.Views.Editor.InlinePanels.ControlPanel(),
	// 		multiBelow = {
	// 			above: ['above', l10n.above_img],
	// 			below: ['below', l10n.below_img],
	// 			nocaption: ['nocaption', l10n.no_text]
	// 		},
	// 		multiOver = {
	// 			topOver: ['topOver', l10n.over_top],
	// 			bottomOver: ['bottomOver', l10n.over_bottom],
	// 			topCover: ['topCover', l10n.cover_top],
	// 			middleCover: ['middleCover', l10n.cover_mid],
	// 			bottomCover: ['bottomCover', l10n.cover_bottom],
	// 			nocaption: ['nocaption', l10n.no_text]
	// 		},
	// 		multiSide = {
	// 			right: ['right', l10n.at_right],
	// 			left: ['left', l10n.at_left],
	// 			nocaption: ['nocaption', l10n.no_text]
	// 		},
	// 		primaryStyle = this.get_preset_properties().primaryStyle,
	// 		multiControls = {},
	// 		captionControl = new Upfront.Views.Editor.InlinePanels.TooltipControl(),
	// 		panelItems = [],
	// 		slide = this.model.slideCollection.at(this.getCurrentSlide())
	// 	;

	// 	captionControl.sub_items = {};
	// 	if(primaryStyle == 'below')
	// 		multiControls = multiBelow;
	// 	else if(primaryStyle == 'over')
	// 		multiControls = multiOver;
	// 	else if(primaryStyle == 'side')
	// 		multiControls = multiSide;
	// 	else
	// 		multiControls = false;
	// 	if(multiControls){
	// 		_.each(multiControls, function(opts, key){
	// 			captionControl.sub_items[key] = me.createControl(opts[0], opts[1]);
	// 		});

	// 		captionControl.icon = 'caption';
	// 		captionControl.tooltip = l10n.cap_position;
	// 		captionControl.selected = multiControls[slide.get('style')] ? slide.get('style') : 'nocaption';
	// 		this.listenTo(captionControl, 'select', function(item){
	// 			var previousStyle = slide.get('style');
	// 			slide.set('style', item);
	// 			me.onSlidesCollectionChange();
	// 			if(primaryStyle == 'side' && previousStyle == 'nocaption' || item == 'nocaption'){
	// 				//give time to the element to render
	// 				setTimeout(function(){
	// 					var wrap = me.$('.upfront-default-slider-item-current').find('.uslide-image');
	// 					me.imageProps[slide.id] = me.calculateImageResize({width: wrap.width(), height: wrap.height()}, slide);
	// 					me.setTimer();
	// 				}, 100);
	// 			}
	// 		});
	// 	}

	// 	panelItems.push(this.createControl('crop', l10n.edit_img, 'imageEditMask'));

 	//    	// panelItems.push(this.createLinkControl(slide));

	// 	panelItems.push(this.createControl('remove', l10n.remove_slide, 'onRemoveSlide'));

	// 	panel.items = _(panelItems);

	// 	return panel;
	// },

	createControl: function(icon, tooltip, click){
		var me = this,
			item = new Upfront.Views.Editor.InlinePanels.Control();
		item.icon = icon;
		item.tooltip = tooltip;
		if(click){
			item.on('click', function(e){
				me[click](e);
			});
		}

		return item;
	},

	createLinkControl: function() {
		var me = this,
			slide = this.model.slideCollection.at(this.getCurrentSlide()),
			control = new Upfront.Views.Editor.InlinePanels.DialogControl(),
			link;

		if (this.currentSlideLink) {
			this.stopListening(this.currentSlideLink);
		}

		if (typeof(slide) !== 'undefined' && typeof(slide.get('link')) !== 'undefined') {
			link = new LinkModel(slide.get('link'));
		} else {
			link = new LinkModel({
				type: slide?slide.get('urlType'):'',
				url: slide?slide.get('url'):'',
				target: slide?slide.get('linkTarget'):''
			});
		}
		control.view = linkPanel = new Upfront.Views.Editor.LinkPanel({
			model: link,
			linkTypes: { image: true },
			imageUrl: slide?slide.get('srcFull'):''
		});

		this.listenTo(control, 'panel:ok', function(){
			control.close();
		});

		me.listenTo(control, 'panel:open', function(){
			control.$el
				.closest('.uimage-controls')
					.addClass('upfront-control-visible').end()
				.closest('.uslider-link')
					.removeAttr('href') //Deactivate link when the panel is open
			;

			me.$el.closest('.ui-draggable').draggable('disable');
			me.$('.uimage').sortable('disable');
		});

		me.listenTo(control, 'panel:close', function(){
			control.$el
				.closest('.uimage-controls')
					.removeClass('upfront-control-visible').end()
				.closest('.uslider-link')
					.attr('href', typeof(slide) !== 'undefined' ? slide.get('url') : '')
			;

			me.$el.closest('.ui-draggable').draggable('enable');
		});

		me.listenTo(link, 'change', function(data) {
			slide.set({link: data.toJSON()}, {silent:true});
			// Rather than changing template rendering set properties that tempalte uses also
			slide.set({
				urlType: data.get('type'),
				url: data.get('url'),
				linkTarget: data.get('target')
			}, {silent:true});

			me.property('slides', me.model.slideCollection.toJSON(), true);
		});

		me.listenTo(link, 'change:target', function(data) {
			slide.set({link: data.toJSON()}, {silent:true});
			// Rather than changing template rendering set properties that tempalte uses also
			slide.set({
				urlType: data.get('type'),
				url: data.get('url'),
				linkTarget: data.get('target')
			}, {silent:true});

			me.property('slides', me.model.slideCollection.toJSON(), true);

			me.$el.find('.upfront-default-slider-item-current a')
				.attr('target', data.get('target'));
		});
		this.currentSlideLink = link;

		control.icon = 'link';
		control.tooltip = l10n.img_link;
		control.id = 'link';


		return control;
	},

	getElementColumns: function(){
		var module = this.$el.closest('.upfront-module'),
			classes,
			found = false
		;

		if(!module.length)
			return -1;

		classes = module.attr('class').split(' ');

		_.each(classes, function(c){
			if(c.match(/^c\d+$/))
				found = c.replace('c', '');
		});
		return found || -1;
	},

	onSlidesCollectionChange: function(){
		this.property('slides', this.model.slideCollection.toJSON(), false);
	},

	onModelChange: function() {
		if (this.stopListeningTo) {
			this.stopListeningTo(this.model.slideCollection);
			this.model.slideCollection = new Uslider_Slides(this.property('slides'));
			this.listenTo(this.model.slideCollection, 'add remove reset change', this.onSlidesCollectionChange);
		}
		this.render();
	},

	openImageSelector: function(e, replaceId){
		var me = this,
			sizer = this.model.slideCollection.length ? this.$('.upfront-default-slider-item-current').find('.uslide-image') : this.$('.upfront-object-content'),
			selectorOptions = {
				multiple: true,
				preparingText: l10n.preparing_img,
				element_id: this.model.get_property_value_by_name("element_id"),
				customImageSize: {
					width: sizer.width(),
					height: sizer.height()
				}
			}
		;

		if(e)
			e.preventDefault();

		Upfront.Views.Editor.ImageSelector.open(selectorOptions).done(function(images, response){
			me.addSlides(images, replaceId);
			Upfront.Views.Editor.ImageSelector.close();
		});
	},

	addSlides: function(images, replaceId){
		var slides = [];
		_.each(images, function(image, id){
			var data = {sizes: image, id: id, srcFull: image.full[0], status: 'ok'};
			if(image.custom && !image.custom.error){
				data.src = image.custom.url;
				data.size = image.custom.editdata.resize;
				data.cropSize = image.custom.crop;
				data.cropOffset = image.custom.editdata.crop;
			}
			else{
				data.src = image.full[0];
				data.size = {width: image.full[1], height: image.full[2]};
			}
			slides.push(data);
		});

		if(replaceId){
			this.model.slideCollection.get(replaceId).set(slides[0]);
			this.onSlidesCollectionChange();
		}
		else
			this.model.slideCollection.add(slides);
	},

	onElementResizeStart: function(e, ui){
		if(ui.element.hasClass('uslide-image') || this.$('.upfront-image-starting-select').length)
			return;

		var style = this.property('style'),
			me = this
		;

		this.calculateColumnWidth();

		if(_.indexOf(['nocaption', 'below', 'above', 'right', 'left'], style) == -1)
			this.$('.uslider-caption').fadeOut('fast');
		else if(style == 'right' || style == 'left'){
			ui.element.resizable('option', {
				minWidth: me.colWidth * 6
			});
			this.$('.uslide').css({height: '100%'});
		}
	},

	calculateColumnWidth: function(){
		return (this.colWidth = Upfront.Behaviors.GridEditor.col_size);
	},

	onElementResize: function(e, ui){
		if (ui.element.hasClass('uslide-image')) return;

		var starting = this.$('.upfront-image-starting-select');
		if (starting.length) {
			this.startingHeight = $('.upfront-resize').height() - 30;
			return;
		}

		var me = this,
			mask = this.$('.upfront-default-slider-item-current').find('.uslide-image'),
			currentSlide = this.model.slideCollection.at(this.getCurrentSlide()),
			style = this.get_preset_properties().primaryStyle,
			resizer = $('.upfront-resize'),
			text = style == 'below' ? this.$('.uslide-caption') : [],
			textHeight = text.length ? text.outerHeight() : 0,
			newElementSize = {width: resizer.outerWidth() - 30, height: resizer.outerHeight() - 30 - textHeight},
			elementColumns = Upfront.Util.width_to_col(resizer.outerWidth()),
			imageColumns = Math.max(3, Math.round(this.property('rightImageWidth') * elementColumns / this.property('rightWidth'))),
			sideImageWidth = imageColumns * this.calculateColumnWidth()
		;

		this.model.slideCollection.each(function (slide) {
			var imageSize = {height: newElementSize.height};
			imageSize.width = style == 'side' && slide.get('style') != 'nocaption' ? sideImageWidth : newElementSize.width;
			me.imageProps[slide.id] = me.calculateImageResize(imageSize, slide);
		});

		me.cropHeight = newElementSize.height;

		if (style == 'side') {
			this.property('rightImageWidth', imageColumns);
		}
		this.property('rightWidth', elementColumns);

		me.setTimer();
	},

	onElementResizing: function(e, ui){
		if (ui.element.hasClass('uslide-image')) return;

		var starting = this.$('.upfront-image-starting-select');
		if (starting.length) return starting.outerHeight($('.upfront-resize').height() - 30);

		var resizer = $('.upfront-resize'),
			current = this.$('.upfront-default-slider-item-current'),
			text = this.get_preset_properties().primaryStyle == 'below' ? current.find('.uslide-caption') : [],
			textHeight = text.length ? text.outerHeight() : 0,
			newElementSize = {width: resizer.outerWidth() - 30, height: resizer.outerHeight() - 30 - textHeight},
			id = current.attr('rel'),
			slide = this.model.slideCollection.get(id),
			imageWrapper= current.find('.uslide-image'),
			style = this.get_preset_properties().primaryStyle,
			wrapperSize = {width: style == 'side' ? imageWrapper.width() : newElementSize.width, height: newElementSize.height},
			wrapperCss = {height: wrapperSize.height}
		;

		if (style == 'side') {
			current.find('.uslide-caption').height(newElementSize.height);
		} else {
			wrapperCss.width = wrapperSize.width;
		}

		//newElementSize.width = current.width();
		imageWrapper.css(wrapperCss)
			.closest('.uslide').height(newElementSize.height)
			.closest('.uslides').css({'padding-top' : newElementSize.height})
		;

		this.calculateImageResize(wrapperSize, slide);
	},

	calculateImageResize: function(wrapperSize, slide){
		var img = this.$('.uslide[rel=' + slide.id + ']').find('img'),
			currentPosition = img.position(),
			imgSize = slide.get('size'),
			imgMargins = slide.get('cropOffset'),
			imgPosition = {top: - imgMargins.top, left: - imgMargins.left},
			imgRatio = imgSize.width / imgSize.height,
			wrapperRatio = wrapperSize.width / wrapperSize.height,
			pivot = imgSize.width / imgSize.height > wrapperSize.width / wrapperSize.height ? 'height' : 'width',
			other = pivot == 'height' ? 'width' : 'height'
		;

		if (pivot == 'height' && wrapperSize.height > imgSize.height) {
// Old style, using CSS
//img.css({width: 'auto', height: '100%', top: 0, left: Math.min(0, Math.max(imgPosition.left, wrapperSize.width - imgSize.width))});
			var final_width = wrapperSize.height / imgSize.height * imgSize.width;
			img.css({width: final_width, height: wrapperSize.height, top: 0, left: Math.min(0, Math.max(imgPosition.left, wrapperSize.width - imgSize.width))});
		} else if (pivot == 'width' && wrapperSize.width > imgSize.width) {
// Old style, using CSS
//img.css({width: '100%',	height: 'auto',	left: 0, top: Math.min(0, Math.max(imgPosition.top, wrapperSize.height - imgSize.height))});
			var final_height = wrapperSize.width / imgSize.width * imgSize.height;
			img.css({width: wrapperSize.width,	height: final_height,	left: 0, top: Math.min(0, Math.max(imgPosition.top, wrapperSize.height - imgSize.height))});
		} else {
			img.css({
				height: imgSize.height,
				width: imgSize.width,
				top: Math.max(imgPosition.top, wrapperSize.height - imgSize.height),
				left: Math.max(imgPosition.left, wrapperSize.width - imgSize.width)
			});
		}

		// Re-adjust wrappers! They're only being adjusted for the currently active slide
		img.closest(".uslide-image")
			.width(Math.min(img.width(), wrapperSize.width))
			.height(Math.min(img.height(), wrapperSize.height))
		;

		return {
			size: {width: img.width(), height: img.height()},
			cropOffset: {left: 0-img.position().left, top: 0-img.position().top},
			cropSize: wrapperSize
		};
	},

	saveTemporaryResizing: function(){
		var me = this,
			imagesData = [],
			editOptions = {action: 'upfront-media-image-create-size'},
			sentData = {},
			element_id = this.model.get_property_value_by_name("element_id")
		;
		this.model.slideCollection.each(function(slide){
			var imageProps =  me.imageProps[slide.id],
				crop = imageProps.cropOffset,
				data
			;
			crop.width = imageProps.cropSize.width;
			crop.height = imageProps.cropSize.height;

			data = {
				id: slide.id,
				element_id: element_id,
				rotate: slide.get('rotation'),
				resize: imageProps.size,
				crop: crop
			};
			imagesData.push(data);
			sentData[slide.id] = data;
		});

		editOptions.images = imagesData;

		return Upfront.Util.post(editOptions).done(function(response){
			var images = response.data.images;
			_.each(images, function(data, id){
				var slide = me.model.slideCollection.get(id),
					imageData = sentData[id]
				;
				slide.set({
					src: data.url,
					srcFull: data.urlOriginal,
					size: imageData.resize,
					cropSize: {width: imageData.crop.width, height: imageData.crop.height},
					cropOffset: {left: imageData.crop.left, top: imageData.crop.top}
				}, {silent: true});
			});

			//Clear the timeout
			clearTimeout(me.cropTimer);
			me.cropTimer = false;

			me.imageProps = {};
			me.onSlidesCollectionChange();
		});
	},

	saveResizing: function(){
		var me = this;
		if (this.cropTimer) {
			this.saveTemporaryResizing().done(function(){
				var saveData = {
					element: JSON.stringify(Upfront.Util.model_to_json(me.model)),
					action: 'upfront_update_layout_element'
				};
				Upfront.Util.post(saveData).done();
			});
		}
	},

	onRemoveSlide: function(e) {
		// var item = $(e.target).closest('.uimage-controls');
		this.removeSlide(/*item*/);
	},

	// removeSlide: function(item) {
	removeSlide: function() {
		this.startingHeight = this.$('.upfront-slider').height();

		if (confirm(l10n.delete_slide_confirm)) {
			// It's very important that next line goes before removing slide from collection
			var currentSlide = this.getCurrentSlide();
			this.setCurrentSlide( currentSlide > 0 ? currentSlide - 1 : 0 );
			this.model.slideCollection.remove(this.model.slideCollection.at(currentSlide).id);
		}
	},

	getCurrentSlide: function() {
		return this.currentSlide;
	},

	setCurrentSlide: function(number) {
		this.currentSlide = number;
	},

	imageEditMask: function(e) {
		var me = this,
			item = $(e.target).closest('.uimage-controls'),
			currentSlide = this.model.slideCollection.at(this.getCurrentSlide()),
			slide = this.model.slideCollection.get(currentSlide.id),
			editorOpts = this.getEditorOptions(slide)
		;

		if(slide.get('status') != 'ok'){
			var selectorOptions = {
				multiple: false,
				preparingText: l10n.preparing_slides,
				element_id: me.model.get_property_value_by_name("element_id")
			};
			return Upfront.Views.Editor.ImageSelector.open(selectorOptions).done(function(images, response){
				me.addSlides(images);

				var index = me.model.slideCollection.indexOf(slide);
				me.model.slideCollection.remove(slide, {silent:true});

				var newSlide = me.model.slideCollection.at(me.model.slideCollection.length -1);
				me.model.slideCollection.remove(newSlide, {silent:true});
				me.model.slideCollection.add(newSlide, {at: index});

				Upfront.Views.Editor.ImageSelector.close();
			});
		}

		e.preventDefault();
		Upfront.Views.Editor.ImageEditor.open(editorOpts)
			.done(function(result){
				slide.set({
					src: result.src,
					srcFull: result.srcFull,
					cropSize: result.cropSize,
					size: result.imageSize,
					cropOffset: result.imageOffset,
					margin: {left: Math.max(0-result.imageOffset.left, 0), top: Math.max(0-result.imageOffset.top, 0)},
					rotation: result.rotation,
					id: result.imageId
				});
				me.imageProps[slide.id] = {
					cropOffset: result.imageOffset,
					size: result.imageSize,
					cropSize: result.cropSize
				};
				me.render();
			})
			.fail(function(data){
				if(data && data.reason == 'changeImage')
					me.openImageSelector(null, data.id);
			})
		;
	},

	getEditorOptions: function(image){
		var me = this,
			mask = this.$('.uslide[rel=' + image.id + ']').find('.uslide-image'),
			img = mask.find('img'),
			full = image.get('sizes').full,
			size = {width: img.width(), height: img.height()},
			position = {left: 0 - img.position().left, top: 0 - img.position().top},
			element_id = this.model.get_property_value_by_name("element_id")
		;

		return {
			id: image.id,
			element_id: element_id,
			maskSize: {width: mask.width(), height: mask.height()},
			maskOffset: mask.offset(),
			position: position,
			size: size,
			fullSize: {width: full[1], height: full[2]},
			src: image.get('src'),
			srcOriginal: full[0],
			rotation: image.get('rotation')
		};
	},

	postTypes: function(){
		var types = [];
		_.each(Upfront.data.ugallery.postTypes, function(type){
			if(type.name != 'attachment')
				types.push({name: type.name, label: type.label});
		});
		return types;
	},

	cleanup: function(){
		if(this.controls){
			this.controls.remove();
			this.controls = false;
		}
	},

	/*
	Returns an object with the properties of the model in the form {name:value}
	*/
	extract_properties: function() {
		var model = this.model.get('properties').toJSON(),
			props = {}
		;
		_.each(model, function(prop){
			props[prop.name] = prop.value;
		});

		props.preset = props.preset || 'default';

		return props;
	},

	/*
	Shorcut to set and get model's properties.
	*/
	property: function(name, value, silent) {
		if(typeof value != "undefined"){
			if(typeof silent == "undefined")
				silent = true;
			return this.model.set_property(name, value, silent);
		}
		return this.model.get_property_value_by_name(name);
	},

	getControlItems: function(){
		if( !this.model.slideCollection.length ) return _([]); // We need no controls when there is no slide
		var me = this,
			captionControl = new Upfront.Views.Editor.InlinePanels.TooltipControl(),
			slideCollection = this.model.slideCollection;
			multiBelow = {
				above: ['above', l10n.above_img],
				below: ['below', l10n.below_img],
				nocaption: ['nocaption', l10n.no_text]
			},
				multiOver = {
					topOver: ['topOver', l10n.over_top],
					bottomOver: ['bottomOver', l10n.over_bottom],
					topCover: ['topCover', l10n.cover_top],
					middleCover: ['middleCover', l10n.cover_mid],
					bottomCover: ['bottomCover', l10n.cover_bottom],
					nocaption: ['nocaption', l10n.no_text]
				},
				multiSide = {
					right: ['right', l10n.at_right],
					left: ['left', l10n.at_left],
					nocaption: ['nocaption', l10n.no_text]
				},
				primaryStyle = this.get_preset_property('primaryStyle'),
				multiControls = {},
				captionControl = new Upfront.Views.Editor.InlinePanels.TooltipControl(),
				slide = slideCollection.at(this.getCurrentSlide())
			;


		captionControl.sub_items = {};
		if(primaryStyle == 'below')
			multiControls = multiBelow;
		else if(primaryStyle == 'over')
			multiControls = multiOver;
		else if(primaryStyle == 'side')
			multiControls = multiSide;
		else
			multiControls = false;
		if(multiControls){
			_.each(multiControls, function(opts, key){
				captionControl.sub_items[key] = me.createControl(opts[0], opts[1]);
			});

			captionControl.icon = 'caption';
			captionControl.tooltip = l10n.cap_position;
			captionControl.selected = multiControls[slide.get('style')] ? slide.get('style') : 'nocaption';
			this.listenTo(captionControl, 'select', function(item){
				var previousStyle = slide.get('style');
				slide.set('style', item);
				me.onSlidesCollectionChange();
				if(primaryStyle == 'side' && previousStyle == 'nocaption' || item == 'nocaption'){
					//give time to the element to render
					setTimeout(function(){
						var wrap = me.$('.upfront-default-slider-item-current').find('.uslide-image');
						me.imageProps[slide.id] = me.calculateImageResize({width: wrap.width(), height: wrap.height()}, slide);
						me.setTimer();
					}, 100);
				}
			});
		}

		var controls = _([
			//this.createControl('next', l10n.css.next_label, 'nextSlide'),
			//this.createControl('prev', l10n.css.prev_label, 'prevSlide'),
			this.createControl('add', l10n.add_slide, 'openImageSelector'),
			this.createControl('crop', l10n.edit_img, 'imageEditMask'),
			this.createLinkControl(),
			this.createControl('remove', l10n.remove_slide, 'onRemoveSlide'),
			captionControl,
			this.createPaddingControl(),
			this.createControl('settings', l10n.settings, 'on_settings_click')
		]);

		if( !multiControls ){
			controls = _( controls.without( captionControl ) );
		}

		return controls;
	}
});



/***********************************************************************************************************************************************
* Add Slider Menu Option
/**********************************************************************************************************************************************/

/**
 * Editor command class - this will be injected into commands
 * and allow adding the new entity instance to the work area.
 * @type {Upfront.Views.Editor.Command}
 */
var USliderElement = Upfront.Views.Editor.Sidebar.Element.extend({
	priority: 40,
	draggable: true,
	/**
	 * Set up command appearance.
	 */
	render: function () {
		//this.$el.html(uslider_i18n['menu-add-slider']);
		this.$el.addClass('upfront-icon-element upfront-icon-element-slider');
		this.$el.html(l10n.element_name);
	},

	/**
	 * What happens when user clicks the command?
	 * We're instantiating a module with slider entity (object), and add it to the workspace.
	 */
	add_element: function () {
		var object = new USliderModel(),
			module = new Upfront.Models.Module({
				"name": "",
				"properties": [
					{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
					{"name": "class", "value": "c10 upfront-slider_module"},
					{"name": "has_settings", "value": 0},
					{"name": "row", "value": Upfront.Util.height_to_row(255)}
				],
				"objects": [
					object
				]
			})
		;
		// We instantiated the module, add it to the workspace
		this.add_module(module);
	}
});

// ----- Bringing everything together -----
// The definitions part is over.
// Now, to tie it all up and expose to the Subapplication.

Upfront.Application.LayoutEditor.add_object("USlider", {
	"Model": USliderModel,
	"View": USliderView,
	"Element": USliderElement,
	"Settings": SliderSettings,
	cssSelectors: {
		'.uslide-image img': {label: l10n.css.images_label, info: l10n.css.images_info},
		'.uslide-image': {label: l10n.css.img_containers_label, info: l10n.css.img_containers_info},
		'.uslide-caption': {label: l10n.css.captions_label, info: l10n.css.captions_info},
		'.wp-caption': {label: l10n.css.caption_label, info: l10n.css.caption_info},
		'.upfront-default-slider-nav': {label: l10n.css.dots_wrapper_label, info: l10n.css.dots_wrapper_info},
		'.upfront-default-slider-nav-item': {label: l10n.css.dots_label, info: l10n.css.dots_info},
		'.uslider-dotnav-current': {label: l10n.css.dot_current_label, info: l10n.css.dot_current_info},
		'.upfront-default-slider-nav-prev': {label: l10n.css.prev_label, info: l10n.css.prev_info},
		'.upfront-default-slider-nav-next': {label: l10n.css.next_label, info: l10n.css.next_info},
	},
	cssSelectorsId: Upfront.data.uslider.defaults.type
});
Upfront.Models.USliderModel = USliderModel;
Upfront.Views.USliderView = USliderView;

}); //End require

})(jQuery);


define('text!elements/upfront-social-media/tpl/social-back.html',[],function () { return '<div>\r\n\r\n<script type="text/template" id="service-tpl">\r\n\t<li class="upfront-field-multiple">\r\n\t\t{[ if(expandable){ ]}\r\n\t\t\t<i class="usocial-global-triangle"></i>\r\n\t\t{[ } ]}\r\n\t\t<i class="upfront-field-icon upfront-field-icon-social-sort"></i>\r\n\t\t<input type="checkbox" id="service-{{service.id}}" name="" value="{{service.id}}" class="upfront-field-checkbox"{{service.active ? \' checked="checked"\' : \'\' }}>\r\n\t\t<label for="service-{{service.id}}">\r\n\t\t\t<span class="upfront-field-label-text">{{service.name}}</span>\r\n\t\t</label>\r\n\t\t{[ if(expandable){ ]}\r\n\t\t<div class="upfront-field-wrap upfront-field-wrap-text" title="link address" style="display:none">\r\n\t\t\t<input type="text" class="upfront-field upfront-field-text usocial_text usocial_url" id="service-url-{{service.id}}" name="{{service.id}}_url" value="{{service.url}}" placeholder="{{service.name}} url" data-field="url" data-service="{{service.id}}">\r\n\t\t\t{[if(service.meta){_.each(service.meta, function(meta){ ]}\r\n\t\t\t<input type="text" class="upfront-field upfront-field-text usocial_text usocial_{{meta.id}} usocial_service_meta" id="service-{{meta.id}}-{{service.id}}" name="{{meta.id}}" value="{{meta.value}}" placeholder="{{service.name}} {{meta.name}}" data-field="{{meta.id}}" data-service="{{service.id}}">\r\n\t\t\t{[ });} ]}\r\n\t\t</div>\r\n\t\t{[ } ]}\r\n\t</li>\r\n</script>\r\n\r\n<script type="text/template" id="add-service-tpl">\r\n\t{[ if(services.length){ ]}\r\n\t<div class="upfront-field-wrap upfront-field-wrap-select">\r\n\t\t<label class="usocial-select-label">{{ l10n.add_new }}</label>\r\n\t\t<div class="usocial-select upfront-field-select upfront-field-select-single usocial-select-closed" id="">\r\n\t\t\t<ul class="usocial-select-list">\r\n\t\t\t\t{[ _.each(services, function(service){  ]}\r\n\t\t\t\t<li class="upfront-field-select-option">\r\n\t\t\t\t\t<label for="service-{{service.id}}">\r\n\t\t\t\t\t\t<span class="upfront-field-label-text">{{service.name}}</span>\r\n\t\t\t\t\t</label>\r\n\t\t\t\t\t<input type="radio" id="service-{{service.id}}" name="select" class="upfront-field-radio" value="{{service.id}}"{{services[0].name == service.name ? \' checked="checked"\' : \'\'}} >\r\n\t\t\t\t</li>\r\n\t\t\t\t{[ }) ]}\r\n\t\t\t</ul>\r\n\t\t</div>\r\n\t\t<i class="upfront-field-icon upfront-field-icon-social-add usocial-add"></i>\r\n\t</div>\r\n\t{[ } ]}\r\n</script>\r\n\r\n<script type="text/template" id="global-tpl">\r\n\t<div class="upfront-global-social-settings">\r\n\t\t<div class="upfront-settings-item">\r\n      <div class="upfront-settings-item-title"><span>{{ l10n.set_accounts }}</span></div>\r\n\t\t\t<div class="upfront-settings-item-content">\r\n\t\t\t\t<ul class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes social_media_services_list ui-sortable">\r\n\t\t\t\t\t{[ _.each(services, function(service){ ]}\r\n\t\t\t\t\t<li class="upfront-field-multiple upfront-field-multiple-selected">\r\n\t\t\t\t\t\t<i class="usocial-global-triangle"></i>\r\n\t\t\t\t\t\t<i class="upfront-field-icon upfront-field-icon-social-sort"></i>\r\n\t\t\t\t\t\t<input type="checkbox" id="social_global_{{service.id}}" name="services" value="{{service.id}}" class="upfront-field-checkbox" {{service.active ? \'checked="checked"\' : \'\'}}>\r\n\t\t\t\t\t\t<label for="social_global_{{service.id}}">\r\n\t\t\t\t\t\t\t<span class="upfront-field-label-text">{{service.name}}</span>\r\n\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t<div class="upfront-field-wrap upfront-field-wrap-text" title="link address" style="display:none">\r\n\t\t\t\t\t\t\t<input type="text" class="upfront-field upfront-field-text" id="{{service.id}}-url" name="{{service.id}}-url" value="{{service.url}}" placeholder="{{service.name}} url">\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t{[ }) ]}\r\n\t\t\t\t</ul>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<div class="upfront-settings-item">\r\n      <div class="upfront-settings-item-title"><span>{{ l10n.in_post }}</span></div>\r\n\t\t\t<div class="upfront-settings-item-content">\r\n\t\t\t\t<div class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes">\r\n\t\t\t\t\t<span class="upfront-field-multiple upfront-field-multiple-selected">\r\n\t\t\t\t\t\t<input type="checkbox" id="usocial-global-add_to_post" name="inpost" value="yes" class="upfront-field-checkbox" {{inpost.length ? \'checked="checked"\' : \'\'}}>\r\n\t\t\t\t\t\t<label for="usocial-global-add_to_post">\r\n\t\t\t\t\t\t\t<span class="upfront-field-label-text">{{ l10n.counter_to_all }}</span>\r\n\t\t\t\t\t\t</label>\r\n\t\t\t\t\t</span>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="">\r\n\t\t\t\t<label for="usocial-global_after_title" class="upfront-field-label upfront-field-label-block">{{ l10n.location }}</label>\r\n\t\t\t\t<div class="usocial-global-add-post">\r\n\t\t\t\t\t<div class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes">\r\n\r\n\t\t\t\t\t\t<span class="upfront-field-multiple {{after_title.length ? \'upfront-field-multiple-selected\' : \'\' }}">\r\n\t\t\t\t\t\t\t<input type="checkbox" id="usocial-global-after_title" name="after_title" value="yes" class="upfront-field-checkbox usocial_post_location" {{after_title.length ? \'checked="checked"\' : \'\'}}>\r\n\t\t\t\t\t\t\t<label for="usocial-global-after_title">\r\n\t\t\t\t\t\t\t\t<span class="upfront-field-label-text">{{ l10n.after_title }}</span>\r\n\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t</span>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios">\r\n\t\t\t\t\t\t<i class="usocial-align-icon upfront-field-icon upfront-field-icon-social-title-align"></i>\r\n\t\t\t\t\t\t<div class="usocial-global-align {{after_title.length ? \'align-active\' : \'\'}}">\r\n\t\t\t\t\t\t\t<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\r\n\t\t\t\t\t\t\t\t<input type="radio" id="usocial-global-align-0" name="after_title_align" value="left" class="upfront-field-radio" {{after_title_align == \'left\' ? \'checked="checked"\' : \'\'}} {{after_title.length ? \'\' : \'disabled="disabled"\'}}>\r\n\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\r\n\t\t\t\t\t\t\t\t<input type="radio" id="usocial-global-align-1" name="after_title_align" value="center" class="upfront-field-radio" {{after_title_align == \'center\' ? \'checked="checked"\' : \'\'}} {{after_title.length ? \'\' : \'disabled="disabled"\'}}>\r\n\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\r\n\t\t\t\t\t\t\t\t<input type="radio" id="usocial-global-align-2" name="after_title_align" value="right" class="upfront-field-radio" {{after_title_align == \'right\' ? \'checked="checked"\' : \'\'}} {{after_title.length ? \'\' : \'disabled="disabled"\'}}>\r\n\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<label class="usocial-global-align-label" for="after_content_align">{{ l10n.aligned }} {{after_title_align}}</label>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class="usocial-global-add-post">\r\n\t\t\t\t\t<div class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes">\r\n\t\t\t\t\t\t<span class="upfront-field-multiple {{after_content.length ? \'upfront-field-multiple-selected\' : \'\' }}">\r\n\t\t\t\t\t\t\t<input type="checkbox" id="usocial-global-after_content" name="after_content" value="yes" class="upfront-field-checkbox usocial_post_location" {{after_content.length ? \'checked="checked"\' : \'\'}}>\r\n\t\t\t\t\t\t\t<label for="usocial-global-after_content">\r\n\t\t\t\t\t\t\t\t<span class="upfront-field-label-text">{{ l10n.after_content }}</span>\r\n\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t</span>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios">\r\n\t\t\t\t\t\t<i class="usocial-align-icon upfront-field-icon upfront-field-icon-social-content-align"></i>\r\n\t\t\t\t\t\t<div class="usocial-global-align {{after_content.length ? \'align-active\' : \'\'}}">\r\n\t\t\t\t\t\t\t<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\r\n\t\t\t\t\t\t\t\t<input type="radio" id="usocial-global-align-0" name="after_content_align" value="left" class="upfront-field-radio" {{after_content_align == \'left\' ? \'checked="checked"\' : \'\'}} {{after_content.length ? \'\' : \'disabled="disabled"\'}}>\r\n\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\r\n\t\t\t\t\t\t\t\t<input type="radio" id="usocial-global-align-1" name="after_content_align" value="center" class="upfront-field-radio" {{after_content_align == \'center\' ? \'checked="checked"\' : \'\'}} {{after_content.length ? \'\' : \'disabled="disabled"\'}}>\r\n\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\r\n\t\t\t\t\t\t\t\t<input type="radio" id="usocial-global-align-2" name="after_content_align" value="right" class="upfront-field-radio" {{after_content_align == \'right\' ? \'checked="checked"\' : \'\'}} {{after_content.length ? \'\' : \'disabled="disabled"\'}}>\r\n\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<label class="usocial-global-align-label" for="after_content_align">{{ l10n.aligned }} {{after_content_align}}</label>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios">\r\n\t\t\t\t<label for="usocial-global-counter_style" class="upfront-field-label upfront-field-label-block">{{ l10n.counter_style }}</label>\r\n\t\t\t\t<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline">\r\n\t\t\t\t\t<input type="radio" id="usocial-global-counter_style-0" name="counter_style" value="horizontal" class="upfront-field-radio" {{counter_style == \'horizontal\' ? \'checked="checked"\' : \'\'}}>\r\n\t\t\t\t\t<label for="usocial-global-counter_style-0">\r\n\t\t\t\t\t\t<i class="upfront-field-icon upfront-field-icon-social-count-horizontal"></i>\r\n\t\t\t\t\t\t<span class="upfront-field-label-text"></span>\r\n\t\t\t\t\t</label>\r\n\t\t\t\t</span>\r\n\t\t\t\t<span class="upfront-field-multiple upfront-field-multiple-horizontal-inline upfront-field-multiple-selected">\r\n\t\t\t\t\t<input type="radio" id="usocial-global-counter_style-1" name="counter_style" value="vertical" class="upfront-field-radio" {{counter_style == \'vertical\' ? \'checked="checked"\' : \'\'}}>\r\n\t\t\t\t\t<label for="usocial-global-counter_style-1">\r\n\t\t\t\t\t\t<i class="upfront-field-icon upfront-field-icon-social-count-vertical"></i>\r\n\t\t\t\t\t\t<span class="upfront-field-label-text"></span>\r\n\t\t\t\t\t</label>\r\n\t\t\t\t</span>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</script>\r\n\r\n<script type="text/template" id="fb_like-tpl">\r\n<div data-id="upfront-icon-facebook" class="upfront-social-icon upfront-social-icon-facebook">\r\n\t<iframe class="social-frame usocial-fb {{style}} like" src="//www.facebook.com/plugins/like.php?href={{url}}&amp;send=false&amp;layout={{layout}}&amp;width={{width}}px&amp;show_faces=true&amp;font&amp;colorscheme=light&amp;action=like&amp;height={{height}}px" scrolling="no" frameborder="0" style="border:none; overflow:hidden;" allowTransparency="true"></iframe>\r\n</div>\r\n</script>\r\n<script type="text/template" id="tweet-tpl">\r\n<div data-id="upfront-icon-twitter" class="upfront-social-icon upfront-social-icon-twitter">\r\n\t<iframe class="social-frame usocial-twitter {{style}} like" allowtransparency="true" frameborder="0" scrolling="no" src="//platform.twitter.com/widgets/tweet_button.html?text={{text}}&amp;url={{url}}&amp;original_referer={{url}}&amp;count={{style}}&amp;size=medium" style=""></iframe>\r\n</div>\r\n</script>\r\n<script type="text/template" id="plusone-tpl">\r\n<div data-id="upfront-icon-google" class="upfront-social-icon social-frame usocial-google {{style}} like upfront-social-icon-google">\r\n\t<script type="text/javascript" src="//apis.google.com/js/plusone.js"></{{\'s\'}}cript>\r\n\t<div class="g-plusone" data-size="{{size}}"></div>\r\n</div>\r\n</script>\r\n\r\n\r\n</div>\r\n';});

(function ($) {


    define('upfront-social_media',[
            'text!elements/upfront-social-media/tpl/social-back.html'
        ], function(backTpl) {

    var l10n = Upfront.Settings.l10n.social_element;
    var GlobalSettingsPanel = Backbone.View.extend({
        popup: false,
        deferred: false,
        model: false,
        tpl: _.template($(backTpl).find('#global-tpl').html()),

        events: {
            'click .use': 'store',
            'click li': 'revealUrl',
            'change input[name=services]': 'toggleService',
            //'click .usocial-global-triangle': 'revealUrl',
            'change .usocial_post_location': 'changePostLocation',
            'change input[name=after_title_align]': 'changeAlign',
            'change input[name=after_content_align]': 'changeAlign'
        },

        popupFunc: function(){
            return this.open();
        },

        isOpen: function(){
            return $('.upfront-global-social-settings').length;
        },

        open: function(){
            var me = this,
                bindEvents = false
            ;

            console.log('Global social settings');

            this.popup = Upfront.Popup.open(function(){});
            this.deferred = $.Deferred();
            this.setElement($('#upfront-popup'));

            settings = _.clone(Upfront.data.usocial.globals ? Upfront.data.usocial.globals : Upfront.data.usocial.global_defaults);
            settings.l10n = l10n.template

            this.$('#upfront-popup-top').html('<ul class="upfront-tabs">' +
                    '<li class="active upfront-social-popup-hd">' + l10n.global_settings + '</li>' +
                    '</ul>'
            );

            this.$('#upfront-popup-bottom')
                .html('<div class="use_selection_container"><a href="#use" class="use">' + l10n.ok + '</a></div>');

            this.$('#upfront-popup-content').html(this.tpl(settings));

            this.setDraggableUp();

            return this.deferred.promise();
        },
        setDraggableUp: function(){
            this.$('ul').sortable({
                handle: '.upfront-field-icon-social-sort'
            });
        },
        store: function(e){
            e.preventDefault();
            var me = this,
                setData = {
                    inpost: this.$('input[name="inpost"]:checked').length ? ['yes'] : [],
                    after_title: this.$('input[name="after_title"]:checked').length ? ['yes'] : [],
                    after_title_align: this.$('input[name="after_title_align"]:checked').val(),
                    after_content: this.$('input[name="after_content"]:checked').length ? ['yes'] : [],
                    after_content_align: this.$('input[name="after_content_align"]:checked').val(),
                    counter_style: this.$('input[name="counter_style"]:checked').val()
                },
                services = [],
                setDataProperties = false
            ;

            this.$('.social_media_services_list').find('input[type=checkbox]').each(function(idx, cb){
                var $cb = $(cb),
                    service = {
                        id: $cb.val(),
                        active: $cb.is(':checked'),
                        meta: Upfront.data.usocial.global_defaults.services[$cb.val()].meta
                    }
                ;

                service.name = Upfront.data.usocial.global_defaults.services[service.id].name;
                service.url = me.$('input[name="' + service.id + '-url"]').val();

                services.push(service);
            });

            setData.services = services;

            setDataProperties = this.arrayToProperties(setData);

            var loading = new Upfront.Views.Editor.Loading({
                loading: l10n.saving,
                fixed: false
            });

            loading.render();
            this.$('#upfront-popup-content').css('position', 'relative').append(loading.$el);
            Upfront.Util.post({"action": "usocial_save_globals", "data": JSON.stringify(setDataProperties)})
                .success(function (ret) {
                    loading.cancel();
                    Upfront.Popup.close();
                    Upfront.Views.Editor.notify(l10n.updated);
                    Upfront.data.usocial.globals = setData;
                    me.deferred.resolve(setData);
                })
                .error(function (ret) {
                    Upfront.Util.log("Error Saving settings");
                })
            ;
        },

        revealUrl: function(e){
            //e.preventDefault();
            var li = $(e.target).hasClass('usocial-global-triangle') ? $(e.target).closest('li') : $(e.target),
                open = li.parent().find('.open')
            ;
            open.removeClass('open').find('.upfront-field-wrap-text').slideUp('fast');
            if(open[0] != li[0])
                li.addClass('open').find('.upfront-field-wrap-text').slideDown('fast');
        },

        toggleService: function(e){
            e.preventDefault();
            var check = $(e.target),
                li = $(e.target).closest('li')
                input = li.find('input[type=text]')
            ;

            if(check.is(':checked') && !input.val() && !input.is(':visible')){
                e.target = li[0];
                this.revealUrl(e);
                input.focus();
            }
        },

        changePostLocation: function(e){
            var check = $(e.target),
                checked = check.is(':checked'),
                wrapper = check.closest('.usocial-global-add-post')
            ;

            if(checked){
                check.parent().addClass('upfront-field-multiple-selected');
                wrapper.find('.usocial-global-align')
                    .addClass('align-active')
                    .find('input[type=radio]')
                        .attr('disabled', false)
                ;
            }
            else {
                check.parent().removeClass('upfront-field-multiple-selected');
                wrapper.find('.usocial-global-align')
                    .removeClass('align-active')
                    .find('input[type=radio]')
                        .attr('disabled', true)
                ;
            }
        },

        changeAlign: function(e){
            var check = $(e.target),
                checked = check.is(':checked')
            ;

            if(checked){
                check.closest('.upfront-field-wrap')
                    .find('.usocial-global-align-label')
                        .text(l10n.aligned + ' ' + check.val())
                ;
            }
        },

        arrayToProperties: function(arr){
            var props = [];
            _.each(arr, function(value, name){
                props.push({name: name, value: value});
            });
            return props;
        }
    });

    //Upfront.data.social.panel = new SocialMediaGlobalSettingsPanel();
    Upfront.data.social.panel = new GlobalSettingsPanel();

    /**
     * Define the model - initialize properties to their default values.
     * @type {Upfront.Models.ObjectModel}
     */
    var SocialMediaModel = Upfront.Models.ObjectModel.extend({
        /**
         * A quasi-constructor, called after actual constructor *and* the built-in `initialize()` method.
         * Used for setting up instance defaults, initialization and the like.
         */
        init: function () {
            var properties = _.clone(this.getDefaults());//Upfront.data.usocial.defaults);
            properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + '-object');
            this.init_properties(properties);
        },

        /**
         * Create the defaults from the global settings.
         */
        getDefaults: function() {
            var globals = Upfront.data.usocial.globals,
                defaults = Upfront.data.usocial.defaults,
                order = [],
                active = [],
                urls = {}
            ;

            if(!globals){
                return defaults;
            }

            _.each(globals.services, function(service){
                order.push(service.id);
                if(service.active)
                    active.push(service.id);

                urls[service.id] = service.url;
            });

            //Button type services
            var bs = _.clone(globals.services);

            bs.push({id: 'linked-in', name: 'Linked in', active: false, url: '', meta:{}});
            bs.push({id: 'pinterest', name: 'Pinterest', active: false, url: '', meta:{}});
            bs.push({id: 'youtube', name: 'Youtube', active: false, url: '', meta:{}});

            return _.extend({}, defaults, {
                services: globals.services,
                button_services: bs,
                counter_options: globals.counter_style
            });
        }
    });

    /**
     * View instance - what the element looks like.
     * @type {Upfront.Views.ObjectView}
     */
    var SocialMediaView = Upfront.Views.ObjectView.extend({
        settings: false,
        counts: false,
        initialize: function(){
            if(! (this.model instanceof SocialMediaModel)){
                this.model = new SocialMediaModel({properties: this.model.get('properties')});
            }
            Upfront.Views.ObjectView.prototype.initialize.call(this);
            Upfront.Events.on("entity:drag_stop", this.dragStop, this);
        },

        dragStop: function(view, model){
            var me = this;
            if(this.parent_module_view == view && !Upfront.data.usocial.globals && !Upfront.data.social.panel.isOpen()){
                Upfront.data.social.panel.open().done(function(globals){
                    var defaults = me.model.getDefaults();
                    _.each(defaults, function(value, key){
                        me.model.set_property(key, value, true);
                    });
                    me.model.trigger('change');
                });
                console.log('No globals');
            }
        },

        property: function(name, value) {
            if(typeof value != "undefined")
                return this.model.set_property(name, value);
            return this.model.get_property_value_by_name(name);
        },

        buttons: function() {
            var services = this.property('button_services'),
                buttonStyle = this.property('button_style'),
                buttonSize = this.property('button_size'),
                markup = ''
            ;

            if(!services.length)
                return '<span class="upfront-general-notice">' + l10n.add_some_services + '</span>';

            _.each(services, function(s){
                var alert = s.url ? '' : '<span class="alert-url">!</span>';
                if(s.active)
                    markup += '<div class="upfront-' + s.id + '-link-box upfront-social-icon upfront-'+buttonStyle+' usocial-button-'+buttonSize+'">' +
                            '<a class="usocial-button '+ s.id +'-link" href="'+ s.url +'"></a>'+ alert +
                            '</div>';
            });

            return markup;
        },

        fans: function(){
            var me = this,
                services = this.property('services'),
                markup = '',
                buttonStyle = this.property('button_style'),
                buttonSize = this.property('button_size'),
                words = {
                    'facebook': l10n.fans,
                    'twitter': l10n.followers,
                    'google': l10n.subscribers
                }
            ;

            _(services).each( function( s ) {
              if(s.active){
                var alert = s.url ? '' : '<span class="alert-url">!</span>',
                    count = me.getCount(s)
                ;

                markup += '<div data-id="upfront-icon-' + s.id + '" class="ufront-' + s.id + '-count-box upfront-social-icon usocial_count_wrapper">' +
                            '<a class="upfront-fan-counts ' + s.id + '-count" href="'+ s.url +'">'+
                            alert +
                            ' <span class="upfront-fan-count"><strong class="usocial_count">'+ count +'</strong> ' + words[s.id] + '</span></a>' +
                            '</div>';
              }
            });

            if(!markup)
                return '<span class="upfront-general-notice">' + l10n.add_some_services + '</span>';

            this.refreshCount();

            return markup;
        },

        getCount: function(service){
            var me = this,
                s = service.id,
                count = false,
                fetchCount = false,
                id = this.property('element_id')
            ;

            if(typeof usocial == 'undefined' || !usocial.counts || !usocial.counts[id] || !usocial.counts[id][service.id])
                fetchCount = true;

            if(!fetchCount)
                return usocial.counts[id][service.id];

            if(!this.counts)
                this.refreshCount();
            else
                this.counts.done(function(response){
                    var count = response.data[s];
                    me.$el.find('div[data-id="upfront-icon-'+ s +'"]').find('strong.usocial_count').html(count);
                });

            return 'Loading';
        },

        refreshCount: function(){
            var me = this;
            this.counts = Upfront.Util.post({
                    action: "usocial_get_counts",
                    element_id: this.property('element_id'),
                    services: me.property('services')
                })
                .done(function(response){
                    _.each(response.data, function(count, s){
                        me.$el.find('div[data-id="upfront-icon-'+ s +'"]').find('strong.usocial_count').html(count);
                    });
                })
            ;
        },

        rawUrlEncode: function (str) {
            str = (str + '').toString();
            return encodeURIComponent(str).replace(/!/g, '%21').replace(/'/g, '%27').replace(/\(/g, '%28').
                replace(/\)/g, '%29').replace(/\*/g, '%2A');
        },

        likes: function(){
            var counterOptions = this.property('counter_options'),
                services = this.property('services'),
                me = this,
                markup = ''
            ;

            if(services.length){
                var hor = counterOptions == 'horizontal',
                    data = {
                        url: this.rawUrlEncode(location.href),
                        style: counterOptions,
                        width: hor ? 90 : 70,
                        height: hor ? 20 : 60,
                        size: hor ? 'medium' : 'tall',
                        layout: hor ? 'button_count' : 'box_count',
                        text: document.title ? document.title : l10n.awesome_stuff,
                        l10n: l10n.template
                    },
                    tpls = {
                        facebook: 'fb_like-tpl',
                        twitter: 'tweet-tpl',
                        google:'plusone-tpl'
                    }
                ;
                _.each(services, function(s){
                    if(s.active){
                        var tpl = _.template($(backTpl).find('#' + tpls[s.id]).html());
                        markup += tpl(data);
                    }
                });
            }

            return markup ? markup : '<span class="upfront-general-notice">' + l10n.select_some + '</span>';
        },

        /**
         * Element contents markup.
         * @return {string} Markup to be shown.
         */
        get_content_markup: function () {
            if(!Upfront.data.usocial.globals) {
                return '<span class="upfront-general-notice">' + l10n.no_global_settings_nag + '</span>';
						}

            var me = this,
                layoutStyle = this.property("social_type"),
                markup = ''
            ;

            switch (layoutStyle)
            {
                case 'likes':
                    markup = me.likes();
                    break;
                case 'fans':
                    markup = me.fans();
                    break;
                case 'buttons':
                    markup = me.buttons();
                    break;
            }

            this.$el.html(markup);
            return markup;
        }
    });
    /**
     * Sidebar element class - this let you inject element into
     * sidebar elements panel and allow drag and drop element adding
     * @type {Upfront.Views.Editor.Sidebar.Element}
     */
    var SocialMediaElement = Upfront.Views.Editor.Sidebar.Element.extend({
        priority: 60,
        draggable: false,
        render: function () {
            this.$el.addClass('upfront-icon-element upfront-icon-element-social');
            this.$el.html(l10n.element_name);
        },
        add_element: function () {
            var object = new SocialMediaModel(),
                module = new Upfront.Models.Module({
                    "name": "",
                    "properties": [
                        {"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
                        {"name": "class", "value": "c8 upfront-social-media_module"},
                        {"name": "has_settings", "value": 0},
						{"name": "row", "value": Upfront.Util.height_to_row(60)}
                    ],
                    "objects": [
                        object // The anonymous module will contain our search object model
                    ]
                });
            // We instantiated the module, add it to the workspace
            this.add_module(module);
        }
    });


// ----- Settings API -----
// We'll be working from the bottom up here.
// We will first define settings panels, and items for each panel.
// Then we'll slot in the panels in a settings instance.

    var SocialServicesItem = Upfront.Views.Editor.Settings.Item.extend({
        events: function(){
            return _.extend({},SocialServicesItem.prototype.events,{
                "click .social-toggle": "social_toggle"
            });
        },
        social_toggle: function(){
            this.fields._wrapped[0].$el.toggle();
        },
        render: function () {
            this.$el.empty();
            if(this.group){
                this.$el.append(
                    '<div class="upfront-settings-item">' +
                        '<div class="upfront-settings-item-title"><span>' + this.get_title() + '</span></div>' +
                        '<div class="upfront-settings-item-content">' +
                        '<span class="social-toggle">' + l10n.drag_reorder + '</span>' +
                        '<span class="social-sort"></span>' +
                        '</div>' +
                        '</div>'
                );
            }
            else
                this.$el.append('<div class="upfront-settings-item-content"></div>');

            var $content = this.$el.find('.upfront-settings-item-content');
            this.fields.each(function(field){
                field.render();
                $content.append(field.el);
            });

            this.trigger('rendered');
        },
    });

    var Field_Button = Upfront.Views.Editor.Field.Field.extend({
        events: {
            'click a': 'buttonClicked'
        },
        render: function() {
            this.$el.html(this.get_field_html());
        },
        get_field_html: function() {
            return '<i class="upfront-field-icon upfront-field-icon-social-back"></i><span class="upfront-back-global-settings-info">' + this.options.info + ' <a href="#">' + this.options.label + '</a></span>';
        },
        buttonClicked: function(e) {
            if(this.options.on_click)
                this.options.on_click(e);
        },
        isProperty: false
    });

    var SocialSorter = Upfront.Views.Editor.Field.Field.extend({
        className: '',
        tpl: _.template($(backTpl).find('#service-tpl').html()),
        variableTpl: _.template($(backTpl).find('#add-service-tpl').html()),
        events: {
            'click .usocial-global-triangle': 'toggleService',
            'click .usocial-select': 'showServiceList',
            'blur .usocial-select': 'hideServiceList',
            'click .upfront-field-select-option': 'selectService',
            'click .usocial-add': 'addService',
            'change input[type=checkbox]': 'changeService',
            'blur input.usocial_text': 'updateServiceMeta'
        },

        initialize: function(options){
            var me = this;
            me.options = options;
            SocialSorter.__super__.initialize.apply(this, arguments);
            //Upfront.Events.on("social:sorting:fields:save", this.save_c_fields, this);
            this.$el.on('click', function(e){
                me.hideServiceList(e);
            })
        },

        render: function(){
            var me = this,
                nonActive = [],
                services = this.prop(this.options.prop)
            ;
            this.$el.html('<ul class="upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-checkboxes social_media_services_list"></ul>');
            _.each(services, function(service){
                if(!me.options.variable || service.active){
                    me.$('ul').append(me.tpl({
                        service: service,
                        expandable: me.options.expandable,
                        meta: me.options.meta,
                        l10n: l10n.template
                    }));
                }

                if(!service.active)
                    nonActive.push(service);
            });

            this.initSortable();

            if(this.options.variable){
                this.$el.append(this.variableTpl({services: nonActive, l10n: l10n.template}));
            }

            this.trigger('rendered');
        },

        toggleService: function(e){
            var meta = $(e.target).siblings('.upfront-field-wrap-text');
            if(meta.is(':visible'))
                meta.slideUp('fast');
            else
                meta.slideDown('fast');
        },

        showServiceList: function(e){
            console.log('Show');
            e.preventDefault();
            e.stopPropagation();
            $(e.currentTarget).removeClass('usocial-select-closed').focus();
        },

        hideServiceList: function(e){
            this.$('.usocial-select').addClass('usocial-select-closed');
        },

        selectService: function(e){
            if(!this.$('.usocial-select').hasClass('usocial-select-closed')){
                e.preventDefault();
                e.stopPropagation();
                var option = $(e.currentTarget).detach();
                this.$('.usocial-select-list').prepend(option);
                this.$('.usocial-select').addClass('usocial-select-closed');
            }
        },

        addService: function(e) {
            e.preventDefault();
            var serviceToAdd = this.$('.usocial-select-list').find('input').first().val(),
                all = this.prop(this.options.prop),
                serviceData = {}
            ;

            _.each(all, function(service){
                if(service.id == serviceToAdd){
                    service.active = true;
                    serviceData = service;
                }
            });
            //Update services
            this.prop(this.options.prop, all, true);
            //Animate all
            var $service = $(this.tpl({service: serviceData, expandable: this.options.expandable, l10n: l10n.template}))
                            .hide()
                            .find('.upfront-field-wrap-text')
                                .show().end()
            ;
            this.$('.social_media_services_list').append($service);
            $service.slideDown('fast').find('input[type=text]').focus();

            this.$('.usocial-select-list').find('li').first().remove();
        },

        changeService: function(e){
            var check = $(e.target),
                currentService = check.val(),
                services = this.prop(this.options.prop)
            ;

            _.each(services, function(s){
                if(s.id == currentService)
                    s.active = check.is(':checked');
            });

            this.prop(this.options.prop, services, false);

            if(check.is(':checked') && this.options.expandable){
                var input = check.parent().find('input[type=text]');
                if(! input.val()){
                    check.siblings('.upfront-field-wrap-text').slideDown();
                    input.focus();
                }
            }

            this.model.trigger('change');
        },

        initSortable: function(){
            var me = this;
            this.$('ul').sortable({
                start: function( event, ui ) {
                },
                stop: function( event, ui ) {
                },
                update: function(event, ui) {
                    me.updateOrder();
                }
            });
        },

        updateOrder: function(){
            this.save(true);
        },

        updateServiceMeta: function(e){
            var input = $(e.target),
                type = input.data('field'),
                value = input.val(),
                service = this.serv(input.data('service'))
            ;

            if(!value)
                input.closest('li').find('input[type=checkbox]').attr('checked', false);

            if(!service)
                return console.log('Unknown service couldn\'t be saved');

            if(type == 'url')
                service.url = value;
            else {
                var meta = service.meta;
                for(var m in meta){
                    if(meta[m].id == type)
                        meta[m].value = value;
                }
                service.meta = meta;
            }

            this.serv(input.data('service'), service, false);
        },
        /*
        Called when the save button is pressed and the SocialSorter is visible
         */
        save: function(onlyOrder){
            var me = this,
                services = this.prop(this.options.prop),
                hash = {},
                order = this.$('.ui-sortable').find('input[type=checkbox]'),
                added = [],
                newServices = []
            ;
            _.each(services, function(s){
                hash[s.id] = s;
            })

            if(typeof onlyOrder == 'undefined')
                onlyOrder = false;

            order.each(function(idx, input){
                var $input = $(input),
                    service = hash[$input.val()]
                ;
                if(service){
                    if(!onlyOrder){
                        service.active = $input.is(':checked');
                        if(me.options.expandable){
                            var wrap = $input.closest('li');
                            service.url = wrap.find('input[name=' + service.id + '_url]').val();
                            if(service.meta.length){
                                _.each(service.meta, function(m){
                                    m.value = wrap.find('input[name=' + m.id + ']' ).val()
                                });
                            }
                        }
                    }
                    newServices.push(service);
                    added.push(service.id);
                }
            });

            _.each(services,function(s){
                if(added.indexOf(s.id) == -1)
                    newServices.push(s);
            })

            this.prop(this.options.prop, newServices, false);
        },
        /*
        Shorcut to get/update a service
         */
        serv: function(id, value, silent){
            var services = this.prop(this.options.prop);
            if(typeof value == 'undefined'){
                for(var s in services){
                    if(services[s].id == id)
                        return services[s];
                }
                return false;
            }

            var added = false;
            for(var s in services){
                if(services[s].id == id){
                    services[s] = value;
                    added = true;
                }
            }
            if(!added)
                services.push(value);

            if(typeof silent == 'undefined')
                silent = true;

            this.prop(this.options.prop, services, silent);
        },

        /*
        Shorcut to set and get model's properties.
        */
        prop: function(name, value, silent) {
            if(typeof value != "undefined"){
                if(typeof silent == "undefined")
                    silent = true;
                return this.model.set_property(name, value, silent);
            }
            return this.model.get_property_value_by_name(name);
        }
    });

    var SocialSettings = Upfront.Views.Editor.Settings.Settings.extend({
        panel: false,
        servicesItems: [],
        events: {
            'change input[type=radio]': 'changeRadio'
        },
        initialize: function(opts){
            this.options = opts;
            this.panel = new Upfront.Views.Editor.Settings.Panel({
                model: this.model,
                label: l10n.opts.layout_label,
                title: l10n.opts.layout_title,
                tabbed: true,
                settings: [
                    new Upfront.Views.Editor.Settings.ItemTabbed({
                        model: this.model,
                        title: l10n.opts.action,
                        radio: true,
                        icon: "social-like",
                        property: 'social_type', // property value must be the same between radio tab
                        value: 'likes', // value means the value stored to property when this tab is selected
                        is_default: true, // set this tab as default (required)
                        settings: this.getLikesSettings()
                    }),
                    new Upfront.Views.Editor.Settings.ItemTabbed({
                        model: this.model,
                        title: l10n.opts.counts,
                        radio: true,
                        icon: "social-count",
                        property: 'social_type',
                        value: 'fans',
                        settings: this.getFansSettings()
                    }),
                    new Upfront.Views.Editor.Settings.ItemTabbed({
                        model: this.model,
                        title: l10n.opts.cta,
                        radio: true,
                        icon: "social-button",
                        property: 'social_type',
                        value: 'buttons',
                        settings: this.getButtonsSettings()
                    })
                ]
            });
            this.panels = _([
				new Upfront.Views.Editor.Settings.Panel({
                        model: this.model,
                        label: l10n.opts.general_label,
                        title: l10n.opts.general_title,
                        settings: []
						}),
				this.panel
			]);
            this.panel.on('upfront:settings:panel:saved', this.saveServices, this);
        },

        getLikesSettings: function(){
            var services = new SocialSorter({
                model: this.model,
                prop: 'services',
                expandable: false
            });

            this.servicesItems.push(services);

            return [
                new Upfront.Views.Editor.Settings.Item({
                    model: this.model,
                    title: l10n.opts.counter,
                    fields: [
                        new Upfront.Views.Editor.Field.Radios({
                            model: this.model,
                            property: 'counter_options',
                            layout: "horizontal-inline",
                            label: "",
                            values: [
                                { label: "", value: 'horizontal', icon: 'social-count-horizontal' },
                                { label: "", value: 'vertical', icon: 'social-count-vertical' }
                            ]
                        })
                    ]
                }),
                new SocialServicesItem({
                    className: 'upfront-social-services-item',
                    model: this.model,
                    title: l10n.opts.services,
                    fields: [services]
                }),
                this.getGlobalsButton()
            ];
        },
        getFansSettings: function(){
            var services =  new SocialSorter({
                model: this.model,
                prop: 'services',
                meta: true,
                expandable: true
            });

            this.servicesItems.push(services);
            return [
                new SocialServicesItem({
                    className: 'upfront-social-services-item',
                    model: this.model,
                    title: l10n.opts.services,
                    fields: [services]
                }),
                this.getGlobalsButton()
            ];
        },
        getButtonsSettings: function(){
            var services = new SocialSorter({
                model: this.model,
                prop: 'button_services',
                expandable: true,
                variable: true
            });

            this.servicesItems.push(services);
            return [
                new Upfront.Views.Editor.Settings.Item({

                    model: this.model,
                    title: l10n.opts.button_size,
                    fields: [
                        new Upfront.Views.Editor.Field.Radios({
                            model: this.model,
                            property: 'button_size',
                            layout: "vertical",
                            label: "",
                            values: [
                                { label: l10n.opts.small, value: 'small' },
                                { label: l10n.opts.medium, value: 'medium' },
                                { label: l10n.opts.large, value: 'large' }
                            ]
                        })
                    ]
                }),
                new Upfront.Views.Editor.Settings.Item({
                    model: this.model,
                    title: l10n.opts.button_style,
                    fields: [
                        new Upfront.Views.Editor.Field.Radios({
                            model: this.model,
                            property: 'button_style',
                            layout: "horizontal-inline",
                            label: "",
                            values: [
                                { label: "", value: 'button-style-1', icon: 'social-button-style-1' },
                                { label: "", value: 'button-style-2', icon: 'social-button-style-2' },
                                { label: "", value: 'button-style-3', icon: 'social-button-style-3' }
                            ]
                        })
                    ]
                }),
                new SocialServicesItem({
                    className: 'upfront-social-services-item',
                    model: this.model,
                    title: l10n.opts.services,
                    fields: [services]
                }),
                this.getGlobalsButton()
            ]
        },

        getGlobalsButton: function() {
            return new Upfront.Views.Editor.Settings.Item({
                className: 'upfront-social-back',
                group: false,
                fields: [
                    new Field_Button({
                        model: this.model,
                        info: l10n.opts.back_to,
                        label: l10n.global_settings,
                        on_click: function(e){
                            e.preventDefault();
                            Upfront.Events.trigger("entity:settings:deactivate");
                            Upfront.data.social.panel.popupFunc();
                        }
                    })
                ]
            });
        },

        changeRadio: function(e) {
            var input = $(e.target),
                name = input.attr('name'),
                value = this.$el.find('input[name=' + name + ']:checked').val()
            ;

            this.model.set_property(name, value);
        },

        get_title: function () {
            return l10n.opts.social_settings;
        },

        render: function() {
            var me = this;
            if(!Upfront.data.usocial.globals)
                Upfront.data.social.panel.open().done(function(globals){
                    _.each(globals, function(val, name){
                        me.model.set_property(name, val, true);
                    })
                    me.model.trigger('change');
                });
            else
                this.constructor.__super__.render.call(this);
        },

        saveServices: function(){
            console.log('Saving services');
            _.each(this.servicesItems, function(s){
                if(s.$el.is(':visible'))
                    s.save();
            });
            this.model.trigger('change');
        }
    });

// ----- Bringing everything together -----
// The definitions part is over.
// Now, to tie it all up and expose to the Subapplication.

    //Upfront.Application.LayoutEditor.add_object("SocialMedia", { Removing social element for now
    //    "Model": SocialMediaModel,
    //    "View": SocialMediaView,
    //    "Element": SocialMediaElement,
    //    "Settings": SocialSettings,
	// cssSelectors: {
			// '.upfront-object-content': {label: l10n.css.container_label, info: l10n.css.container_info},
			// '.upfront-social-icon ': {label: l10n.css.box_label, info: l10n.box_info},
			// '.upfront-linked-in-link-box': {label: l10n.css.linked_label, info: l10n.css.linked_info},
			// '.upfront-twitter-link-box, .ufront-twitter-count-box, .upfront-social-icon-twitter': {label: l10n.css.twitter_label, info: l10n.css.twitter_info},
			// '.upfront-google-link-box, .ufront-google-count-box, .upfront-social-icon-google': {label: l10n.css.google_label, info: l10n.css.google_info},
			// '.upfront-facebook-link-box, .ufront-facebook-count-box, .upfront-social-icon-facebook': {label: l10n.css.fb_label, info: l10n.css.fb_info},
			// '.upfront-pinterest-link-box': {label: l10n.css.pin_label, info: l10n.css.pin_info},
			// '.upfront-youtube-link-box': {label: l10n.css.yt_label, info: l10n.css.yt_info},
	// },
		// cssSelectorsId: Upfront.data.usocial.defaults.type
		///*,
    //    'anchor': {
    //      is_target: false
    //    }*/
    //});

    Upfront.Models.SocialMediaModel = SocialMediaModel;
    Upfront.Views.SocialMediaView = SocialMediaView;

    }); //End require

})(jQuery);

define('elements/upfront-tabs/js/model',[],function() {
	var Model = Upfront.Models.ObjectModel.extend({
		init: function () {
			var properties = _.clone(Upfront.data.utabs.defaults);
			var defaults = Upfront.data.utabs.defaults;

			//copy the default tabs data by value, so that the source does not get updated if passed by reference

			properties.tabs = [];
			properties.tabs[0] = {};
			properties.tabs[0].content = _.clone(defaults.tabs[0].content);
			properties.tabs[0].title = _.clone(defaults.tabs[0].title);

			properties.tabs[1] = {};
			properties.tabs[1].content = _.clone(defaults.tabs[1].content);
			properties.tabs[1].title = _.clone(defaults.tabs[1].title);

			properties.element_id = Upfront.Util.get_unique_id('utabs-object');
			this.init_properties(properties);
		}
	});

	return Model;
});

define('elements/upfront-tabs/js/element',[
	'elements/upfront-tabs/js/model'
], function(Model) {
	var l10n = Upfront.Settings.l10n.utabs_element;

	var Element = Upfront.Views.Editor.Sidebar.Element.extend({
		priority: 130,
		render: function () {
			this.$el.addClass('upfront-icon-element upfront-icon-element-tabs');
			this.$el.html(l10n.element_name);
		},
		add_element: function () {
			var object = new Model(),
			module = new Upfront.Models.Module({
				'name': '',
				'properties': [
					{'name': 'element_id', 'value': Upfront.Util.get_unique_id('module')},
					{'name': 'class', 'value': 'c9 upfront-tabs_module'},
					{'name': 'has_settings', 'value': 0},
					{'name': 'row', 'value': Upfront.Util.height_to_row(225)}
				],
				'objects': [
					object
				]
			})
			;
			this.add_module(module);
		}
	});

	return Element;
});


define('text!elements/upfront-tabs/tpl/preset-style.html',[],function () { return '#page .upfront-tabs-container.tab-preset-<?php echo $properties[\'id\']  ?> .tabs-tab:hover, \r\n#page .upfront-tabs-container.tab-preset-<?php echo $properties[\'id\']  ?> .tabs-tab:hover .inner-box,\r\n#page .upfront-tabs.<?php echo $properties[\'id\']  ?>.live-preview-hover .tabs-tab,\r\n#page .upfront-tabs.<?php echo $properties[\'id\']  ?>.live-preview-hover .tabs-tab .inner-box\r\n{\r\n\t<?php if(!empty($properties[\'hover-use-color\'])) { ?>\r\n\t\t<?php if(!empty($properties[\'hover-tab-bg\'])) { ?>background: <?php echo $properties[\'hover-tab-bg\'] ?>; <?php } ?>\r\n\t<?php } ?>\r\n\t<?php if(!empty($properties[\'hover-use-typography\'])) { ?>\r\n\t\t<?php if(!empty($properties[\'hover-font-color\'])) { ?>color: <?php echo $properties[\'hover-font-color\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-font-family\'])) { ?>font-family: <?php echo $properties[\'hover-font-family\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-font-size\'])) { ?>font-size: <?php echo $properties[\'hover-font-size\']  ?>px; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-weight\'])) { ?>font-weight: <?php echo $properties[\'hover-weight\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-style\'])) { ?>font-style: <?php echo $properties[\'hover-style\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'hover-line-height\'])) { ?>line-height: <?php echo $properties[\'hover-line-height\']  ?>;<?php } ?>\r\n\t<?php } else { ?>\r\n\t\t<?php if(!empty($properties[\'static-font-color\'])) { ?>color: <?php echo $properties[\'static-font-color\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-font-family\'])) { ?>font-family: <?php echo $properties[\'static-font-family\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-font-size\'])) { ?>font-size: <?php echo $properties[\'static-font-size\']  ?>px; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-weight\'])) { ?>font-weight: <?php echo $properties[\'static-weight\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-style\'])) { ?>font-style: <?php echo $properties[\'static-style\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-line-height\'])) { ?>line-height: <?php echo $properties[\'static-line-height\']  ?>;<?php } ?>\r\n\t<?php } ?>\r\n}\r\n#page .upfront-tabs-container.tab-preset-<?php echo $properties[\'id\']  ?> .tabs-tab:hover,\r\n#page .upfront-tabs.<?php echo $properties[\'id\']  ?>.live-preview-hover .tabs-tab {\r\n\t<?php if(!empty($properties[\'hover-useborder\'])) { ?>\r\n        <?php if(!empty($properties[\'hover-borderwidth\']) && !empty($properties[\'hover-bordertype\']) && !empty($properties[\'hover-bordercolor\'])) { ?>border: <?php echo $properties[\'hover-borderwidth\'] ?>px <?php echo $properties[\'hover-bordertype\'] ?> <?php echo $properties[\'hover-bordercolor\'] ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        border: none;\r\n    <?php } ?>\r\n}\r\n#page .upfront-tabs-container.tab-preset-<?php echo $properties[\'id\']  ?> .tabs-tab.tabs-tab-active, \r\n#page .upfront-tabs-container.tab-preset-<?php echo $properties[\'id\']  ?> .tabs-tab.tabs-tab-active .inner-box,\r\n#page .upfront-tabs.<?php echo $properties[\'id\']  ?>.live-preview-active .tabs-tab,\r\n#page .upfront-tabs.<?php echo $properties[\'id\']  ?>.live-preview-active .tabs-tab .inner-box {\r\n\t<?php if(!empty($properties[\'active-use-color\'])) { ?>\r\n\t\t<?php if(!empty($properties[\'active-tab-bg\'])) { ?>background: <?php echo $properties[\'active-tab-bg\'] ?>; <?php } ?>\r\n\t<?php } ?>\r\n\t<?php if(!empty($properties[\'active-use-typography\'])) { ?>\r\n\t\t<?php if(!empty($properties[\'active-font-color\'])) { ?>color: <?php echo $properties[\'active-font-color\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'active-font-family\'])) { ?>font-family: <?php echo $properties[\'active-font-family\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'active-font-size\'])) { ?>font-size: <?php echo $properties[\'active-font-size\']  ?>px; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'active-weight\'])) { ?>font-weight: <?php echo $properties[\'active-weight\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'active-style\'])) { ?>font-style: <?php echo $properties[\'active-style\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'active-line-height\'])) { ?>line-height: <?php echo $properties[\'active-line-height\']  ?>;<?php } ?>\r\n\t<?php } else { ?>\r\n\t\t<?php if(!empty($properties[\'static-font-color\'])) { ?>color: <?php echo $properties[\'static-font-color\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-font-family\'])) { ?>font-family: <?php echo $properties[\'static-font-family\']  ?>; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-font-size\'])) { ?>font-size: <?php echo $properties[\'static-font-size\']  ?>px; <?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-weight\'])) { ?>font-weight: <?php echo $properties[\'static-weight\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-style\'])) { ?>font-style: <?php echo $properties[\'static-style\']  ?>;<?php } ?>\r\n\t\t<?php if(!empty($properties[\'static-line-height\'])) { ?>line-height: <?php echo $properties[\'static-line-height\']  ?>;<?php } ?>\r\n\t<?php } ?>\r\n\ttransition: none;\r\n}\r\n#page .upfront-tabs-container.tab-preset-<?php echo $properties[\'id\']  ?> .tabs-tab.tabs-tab-active,\r\n#page .upfront-tabs.<?php echo $properties[\'id\']  ?>.live-preview-active .tabs-tab {\r\n\t<?php if(!empty($properties[\'active-useborder\'])) { ?>\r\n        <?php if(!empty($properties[\'active-borderwidth\']) && !empty($properties[\'active-bordertype\']) && !empty($properties[\'active-bordercolor\'])) { ?>border: <?php echo $properties[\'active-borderwidth\'] ?>px <?php echo $properties[\'active-bordertype\'] ?> <?php echo $properties[\'active-bordercolor\'] ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        border: none;\r\n    <?php } ?>\r\n}\r\n#page .upfront-tabs-container.tab-preset-<?php echo $properties[\'id\']  ?> .tabs-tab, #page .upfront-tabs-container.tab-preset-<?php echo $properties[\'id\']  ?> .tabs-tab .inner-box {\r\n\t<?php if(!empty($properties[\'static-tab-bg\'])) { ?>background: <?php echo $properties[\'static-tab-bg\'] ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'static-font-color\'])) { ?>color: <?php echo $properties[\'static-font-color\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'static-font-family\'])) { ?>font-family: <?php echo $properties[\'static-font-family\']  ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'static-font-size\'])) { ?>font-size: <?php echo $properties[\'static-font-size\']  ?>px; <?php } ?>\r\n\t<?php if(!empty($properties[\'static-weight\'])) { ?>font-weight: <?php echo $properties[\'static-weight\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'static-style\'])) { ?>font-style: <?php echo $properties[\'static-style\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'static-line-height\'])) { ?>line-height: <?php echo $properties[\'static-line-height\']  ?>;<?php } ?>\r\n\t<?php if(!empty($properties[\'hover-use-transition\'])) { ?>\r\n\t\ttransition: all <?php echo $properties[\'hover-transition-duration\']  ?>s <?php echo $properties[\'hover-transition-easing\']  ?>;\r\n\t<?php } else { ?>\r\n\t\ttransition: none;\r\n\t<?php } ?>\r\n}\r\n#page .upfront-tabs-container.tab-preset-<?php echo $properties[\'id\']  ?> .tabs-tab{\r\n\t<?php if(!empty($properties[\'static-useborder\'])) { ?>\r\n        <?php if(!empty($properties[\'static-borderwidth\']) && !empty($properties[\'static-bordertype\']) && !empty($properties[\'static-bordercolor\'])) { ?>border: <?php echo $properties[\'static-borderwidth\'] ?>px <?php echo $properties[\'static-bordertype\'] ?> <?php echo $properties[\'static-bordercolor\'] ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        border: none;\r\n    <?php } ?>\r\n}\r\n\r\n.tab-preset-<?php echo $properties[\'id\']  ?> .utabs-content {\r\n\t<?php if(!empty($properties[\'global-content-bg\'])) { ?>background: <?php echo $properties[\'global-content-bg\'] ?>; <?php } ?>\r\n\t<?php if(!empty($properties[\'global-useborder\'])) { ?>\r\n        <?php if(!empty($properties[\'global-borderwidth\']) && !empty($properties[\'global-bordertype\']) && !empty($properties[\'global-bordercolor\'])) { ?>border: <?php echo $properties[\'global-borderwidth\'] ?>px <?php echo $properties[\'global-bordertype\'] ?> <?php echo $properties[\'global-bordercolor\'] ?>;<?php } ?>\r\n    <?php } else { ?>\r\n        border: none;\r\n    <?php } ?>\r\n}\r\n\r\n<?php if(!empty($properties[\'preset_style\'])) { ?><?php echo $properties[\'preset_style\'] ?><?php } ?>\r\n';});

define('elements/upfront-tabs/js/settings',[
	'scripts/upfront/element-settings/settings',
	'scripts/upfront/preset-settings/util',
	'text!elements/upfront-tabs/tpl/preset-style.html'
], function(ElementSettings, Util, styleTpl) {
	var l10n = Upfront.Settings.l10n.utabs_element;

	var TabsSettings = ElementSettings.extend({
		panels: {
			Appearance: {
				mainDataCollection: 'tabPresets',
				styleElementPrefix: 'tab-preset',
				ajaxActionSlug: 'tab',
				panelTitle: l10n.settings,
				presetDefaults: Upfront.mainData.presetDefaults.tab,
				styleTpl: styleTpl,
				stateModules: {
					Global: [
						{
							moduleType: 'Colors',
							options: {
								title: l10n.content_area_colors_label,
								multiple: false,
								single: true,
								abccolors: [
									{
										name: 'global-content-bg',
										label: l10n.content_area_bg_label
									},
								]
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'static',
								title: '',
								fields: {
									use: 'global-useborder',
									width: 'global-borderwidth',
									type: 'global-bordertype',
									color: 'global-bordercolor',
								}
							}
						}
					],
					Static: [
						{
							moduleType: 'Colors',
							options: {
								title: l10n.colors_label,
								multiple: false,
								single: true,
								abccolors: [
									{
										name: 'static-tab-bg',
										label: l10n.tab_bg_label
									},
								]
							}
						},
						{
							moduleType: 'Typography',
							options: {
								title: l10n.tab_typography_label,
								state: 'static',
								toggle: false,
								fields: {
									typeface: 'static-font-family',
									fontstyle: 'static-font-style',
									weight: 'static-weight',
									style: 'static-style',
									size: 'static-font-size',
									line_height: 'static-line-height',
									color: 'static-font-color',
								}
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'static',
								title: '',
								fields: {
									use: 'static-useborder',
									width: 'static-borderwidth',
									type: 'static-bordertype',
									color: 'static-bordercolor',
								}
							}
						}
					],

					Hover: [
						{
							moduleType: 'Colors',
							options: {
								title: l10n.colors_label,
								multiple: false,
								single: true,
								toggle: true,
								prepend: 'hover-',
								prefix: 'static',
								fields: {
									use: 'hover-use-color',
								},
								abccolors: [
									{
										name: 'hover-tab-bg',
										label: l10n.tab_bg_label
									},
								]
							}
						},
						{
							moduleType: 'Typography',
							options: {
								title: l10n.tab_typography_label,
								state: 'hover',
								toggle: true,
								prepend: 'hover-',
								prefix: 'static',
								fields: {
									use: 'hover-use-typography',
									typeface: 'hover-font-family',
									fontstyle: 'hover-font-style',
									weight: 'hover-weight',
									style: 'hover-style',
									size: 'hover-font-size',
									line_height: 'hover-line-height',
									color: 'hover-font-color',
								}
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'hover',
								title: '',
								prepend: 'hover-',
								prefix: 'static',
								fields: {
									use: 'hover-useborder',
									width: 'hover-borderwidth',
									type: 'hover-bordertype',
									color: 'hover-bordercolor',
								}
							}
						},
						{
							moduleType: 'HovAnimation',
							options: {
								state: 'hover',
								title: '',
								toggle: true,
								fields: {
									use: 'hover-use-transition',
									duration: 'hover-transition-duration',
									easing: 'hover-transition-easing',
								}
							}
						}
					],

					Active: [
						{
							moduleType: 'Colors',
							options: {
								title: l10n.colors_label,
								multiple: false,
								single: true,
								toggle: true,
								prepend: 'active-',
								prefix: 'static',
								fields: {
									use: 'active-use-color',
							},
							abccolors: [
							{
								name: 'active-tab-bg',
								label: l10n.tab_bg_label
							},
						]
					}
				},
						{
							moduleType: 'Typography',
							options: {
								title: l10n.tab_typography_label,
								state: 'active',
								toggle: true,
								prepend: 'active-',
								prefix: 'static',
								fields: {
									use: 'active-use-typography',
									typeface: 'active-font-family',
									fontstyle: 'active-font-style',
									weight: 'active-weight',
									style: 'active-style',
									size: 'active-font-size',
									line_height: 'active-line-height',
									color: 'active-font-color',
								}
							}
						},
						{
							moduleType: 'Border',
							options: {
								state: 'active',
								title: '',
								prepend: 'active-',
								prefix: 'static',
								fields: {
									use: 'active-useborder',
									width: 'active-borderwidth',
									type: 'active-bordertype',
									color: 'active-bordercolor',
								}
							}
						}
					]
				},
				
				migrateElementStyle: function(styles) {
					//replace tab container which is one line with preset
					styles = styles.replace(/.upfront-tabs-container/, '');
					
					return styles;
				},
				
				migratePresetProperties: function(newPreset) {
					
					var preset = this.property('preset') ? this.clear_preset_name(this.property('preset')) : 'default',
						props = this.presets.findWhere({id: preset}),
						obj = {};

					_.each(props.attributes, function(preset_value, index) {
						
						if(index === 'id' || index === 'name' || index === 'theme_preset') {
							return;
						}
						
						obj[index] = preset_value;
					});

					//Migrate properties from existing preset
					newPreset.set(obj);
					
					
					newPreset.set({
						'active-tab-bg': 'rgba(255,255,255, 0)',
						'static-tab-bg': 'rgba(255,255,255, 0)',
						'hover-tab-bg': 'rgba(255,255,255, 0)',
						'static-useborder': '',
						'hover-useborder': '',
						'active-useborder': '',
						'global-content-bg': 'rgba(255,255,255, 0)',
						'global-useborder': '',
						'static-line-height': '1',
						'active-line-height': '1',
						'hover-line-height': '1',
					});
				},
			}
		},
		title: l10n.settings
	});

	// Generate presets styles to page
	Util.generatePresetsToPage('tab', styleTpl);

	return TabsSettings;
});


define('text!elements/upfront-tabs/tpl/utabs.html',[],function () { return '<div class="upfront-tabs-container tab-preset-<?php echo $preset ?>">\r\n  <div class="tabs-menu-wrapper">\r\n    <div class="tabs-menu">\r\n      <?php for ($i = 0; $i < $tabs_count; $i++) { ?>\r\n      <div class="tabs-tab  <?php if($i === 0) { ?>tabs-tab-active<?php } ?>" data-content-id="<?php echo $element_id ?>-<?php echo $i ?>">\r\n        <div class="inner-box">\r\n          <?php echo $tabs[$i][\'title\'] ?>\r\n        </div>\r\n        <?php if (!empty($show_remove)) { ?>\r\n        <i></i>\r\n        <?php } ?>\r\n      </div>\r\n      <?php } ?>\r\n    </div>\r\n  </div>\r\n  <div class="utabs-content" >\r\n    <?php for ($i = 0; $i < $tabs_count; $i++) { ?>\r\n    <div id="<?php echo $element_id ?>-<?php echo $i ?>" class="utab-content <?php if($i === 0) { ?>utab-content-active<?php } ?>"><?php echo $tabs[$i][\'content\'] ?></div>\r\n    <?php } ?>\r\n  </div>\r\n</div>\r\n';});

(function ($) {
define('utabs',[
	'elements/upfront-tabs/js/model',
	'elements/upfront-tabs/js/element',
	'elements/upfront-tabs/js/settings',
	'scripts/upfront/preset-settings/util',
	'text!elements/upfront-tabs/tpl/utabs.html',
	'text!elements/upfront-tabs/tpl/preset-style.html'
], function(UtabsModel, TabsElement, TabsSettings, PresetUtil, tabsTpl, settingsStyleTpl) {
	var l10n = Upfront.Settings.l10n.utabs_element;

	// Kill live site tab handling
	$('body').off('touchstart click', '.tabs-tab');

	var UtabsView = Upfront.Views.ObjectView.extend({
		model: UtabsModel,
		currentTabId: false,
		tabsTpl: Upfront.Util.template(tabsTpl),
		elementSize: {width: 0, height: 0},

		initialize: function(){
			if(! (this.model instanceof UtabsModel)){
				this.model = new UtabsModel({properties: this.model.get('properties')});
			}

			// Setup default tab titles, ditch placeholder stuff
			var tabs = this.property('tabs');
			_.each(tabs, function(tab, index) {
				if (tab.title.trim() === '') {
					tabs[index].title = l10n.tab_label + ' ' + (index + 1);
				}
			});
			this.property('tabs', tabs);

			this.events = _.extend({}, this.events, {
				// 'click .add-item': 'addTab',
				'click .tabs-tab': 'onTabClick',
				'keydown .tabs-tab[contenteditable=true]': 'onTabKeydown',
				'click .utab-content-active': 'onContentClick',
				'click i': 'deleteTab',
				'dblclick .utab-content:not(.redactor-editor)': 'startContentEditor'
			});
			this.delegateEvents();

			this.model.get('properties').bind('change', this.render, this);
			this.model.get('properties').bind('change', this.handle_visual_padding_hint, this);
			this.model.get('properties').bind('add', this.render, this);
			this.model.get('properties').bind('remove', this.render, this);

			this.listenTo(Upfront.Events, "theme_colors:update", this.update_colors, this);
		},

		update_colors: function () {
			var me = this,
				preset = this.model.get_property_value_by_name("preset"),
				props = PresetUtil.getPresetProperties('tab', preset) || {}
			;

			if (_.size(props) <= 0) return false; // No properties, carry on

			PresetUtil.updatePresetStyle('tab', props, settingsStyleTpl);

		},

		onContentClick: function() {
			this.$el.find('.tabs-tab-active .inner-box').trigger('blur');
		},

		addTab: function(e) {
			e.preventDefault();
			this.property('tabs').push({
				title: l10n.tab_label + ' ' + (1 + this.property('tabs_count')),
				content: l10n.content_label + ' ' + (1 + this.property('tabs_count'))
			});
			this.property('tabs_count', this.property('tabs').length, false);
			this.render();
		},

		deleteTab: function(event) {
			var element = $(event.currentTarget);
			var tab = element.parents('.tabs-tab');
			var id = $(tab).data('content-id').split('-').pop();
			this.property('tabs').splice(id, 1);
			this.property('tabs_count', this.property('tabs_count') - 1, false);
		},

		onTabClick: function(event) {
			var $tab = $(event.currentTarget);
			var contentId;

			// Stop tab content editor on switching tabs, always
			this.$el.find('.utab-content').each(function () {
				var ed = $(this).data('ueditor');
				if(ed && ed.active) {
					ed.stop();
				}
			});

			// If tab is already active start editor if not started already
			if ($tab.hasClass('tabs-tab-active')) {
				var ed = $tab.find('.inner-box').data('ueditor');
				if(ed && !ed.active) {
					ed.start();
				}

				return;
			}

			// Otherwise stop all tab editors just in case
			this.$el.find('.tabs-tab .inner-box').each(function() {
				var ed = $(this).data('ueditor');
				if(ed && ed.active) {
					$(this).trigger('blur');
				}
			});

			// And make tab active
			$tab
				.siblings().removeClass('tabs-tab-active').end()
				.addClass('tabs-tab-active');
			$('#' + $tab.data('content-id'))
				.siblings().removeClass('utab-content-active').end()
				.addClass('utab-content-active');
		},

		saveTabContent: function($content) {
			var
				tabId = $content.attr('id').split('-').pop(),
				ed = $content.data('ueditor'),
				text = '';

			try {
				text = ed.getValue(true);
			} catch (e) {
				text = $content.html();
			}
			this.currentTabId = $content.attr('id');
			this.property('tabs')[tabId].content = text;
			this.render();
		},

		stopEdit: function(event) {
			var $content = this.$el.find('.utab-content-active'),
				ed = $content.data('ueditor');

			if (ed && ed.active) {
				ed.stop();
			}

			if(typeof event !== 'undefined' && $(event.target).hasClass('inner-box')) {
				return;
			}


			var $tab = this.$el.find('.tabs-tab-active .inner-box:not(.ueditor-placeholder)');
			$tab.trigger('blur');
		},

		onTabKeydown: function(event) {
			var id;
			if (event.keyCode === 13) {
				event.preventDefault();
				$(event.currentTarget).removeAttr('contenteditable');
				id = $(event.currentTarget).data('content-id').split('-').pop();
				this.property('tabs')[id].title = $(event.currentTarget).text();
				this.addTooltips();
				if ($(event.currentTarget).find('i').size() < 1) {
					$(event.currentTarget).append('<i></i>');
				}
			}
		},

		get_content_markup: function () {
			var props = this.extract_properties();

			props.show_add = true;
			props.show_remove = this.property('tabs_count') > 1 ? true : false;
			props.preset = props.preset || 'default';

			return this.tabsTpl(props);
		},

		extract_properties: function() {
			var props = {};
			this.model.get('properties').each(function(prop){
				props[prop.get('name')] = prop.get('value');
			});
			return props;
		},

		on_render: function() {
			// Tabs won't be rendered in time if no delay.
			_.delay(function(self) {
				self.addTooltips();
			}, 10, this);

			var me = this,
				$tabtitles = this.$el.find('.tabs-tab .inner-box'),
				count = 0,
				$tabs;

			$tabtitles.each(function () {
				var $content = $(this);
				count++;

				$content.ueditor({
					linebreaks: true,
					disableLineBreak: true,
					airButtons: false,
					autostart: false,
					allowedTags: ['h5'],
					placeholder: false
			 }).on('start', function() {
				 Upfront.Events.trigger('upfront:element:edit:start', 'text');
				 $(this).focus();
			 }).on('stop', function () {
				 var id = $content.parent().parent().data('content-id').split('-').pop();
				 var editor = $content.data('ueditor');
				 if (editor.getValue(true).trim() === '') {
					 me.property('tabs')[id].title =  l10n.tab_label + ' ' + count;
					 setTimeout( function() {
						 $content.text(l10n.tab_label + ' ' + count);
					 }, 50);
				 } else {
					 me.property('tabs')[id].title =  editor.getValue(true).trim();
				 }
				 Upfront.Events.trigger('upfront:element:edit:stop');
			 });


			});

			$tabs = this.$el.find('.utab-content');

			$tabs.each(function () {
				me.initializeContentEditor($(this));
			});

			var $upfrontObjectContent = this.$el.find('.upfront-object-content');
			// if(this.$el.find('a.add-item').length < 1) {
			// 	$('<b class="upfront-entity_meta upfront-ui add_item"><a href="" class="upfront-icon-button add-item"></a></b>').insertBefore($upfrontObjectContent);
			// }

			this.$el.find('div#'+ this.currentTabId).addClass('utab-content-active').siblings().removeClass('utab-content-active');

			this.$el.find('.tabs-tab').removeClass('tabs-tab-active');
			this.$el.find('div.tabs-tab[data-content-id="' + this.$el.find('div.utab-content-active').attr('id')+'"]').addClass('tabs-tab-active');
		},

		startContentEditor: function(event) {
			$(event.currentTarget).data('ueditor').start();
		},

		initializeContentEditor: function($content) {
			var me = this;

			$content.ueditor({
				linebreaks: false,
				autostart: false,
				inserts:["image", "embed"],
				placeholder: false
			})
				.on('start', function () {
					Upfront.Events.trigger('upfront:element:edit:start', 'text');
				})
				.on('stop', function () {
					me.stopContentEdit($content);
				});
		},

		stopContentEdit: function($content) {
			if($content.text().trim() === '') {
				$content.html(l10n.tab_placeholder);
			}
			this.saveTabContent($content);
			Upfront.Events.trigger('upfront:element:edit:stop');
		},

		addTooltips: function() {
			$('.tabs-tab').each(function() {
				var span = $(this).find('span')[0];
				if ( !_.isUndefined(span) && ( span.offsetWidth < span.scrollWidth ) ) {
					$(this).attr('title', $(span).text().trim());
				}
			});
		},

		property: function(name, value, silent) {
			if(typeof value !== 'undefined'){
				if(typeof silent === 'undefined') {
					silent = true;
				}
				return this.model.set_property(name, value, silent);
			}
			return this.model.get_property_value_by_name(name);
		},

		getControlItems: function(){
			return _([
				this.createControl('add', l10n.add_tab, 'addTab'),
				this.createPaddingControl(),
				this.createControl('settings', l10n.settings, 'on_settings_click')
			]);
		}
	});

	Upfront.Application.LayoutEditor.add_object('Utabs', {
		'Model': UtabsModel,
		'View': UtabsView,
		'Element': TabsElement,
		'Settings': TabsSettings,
		'anchor': {
			is_target: false
		},
		cssSelectors: {
			'.upfront-tabs-container': {label: l10n.css.container_label, info: l10n.css.container_info},
			'.upfront-tabs-container .tabs-menu-wrapper': {label: l10n.css.menu_label, info: l10n.css.menu_info},
			'.upfront-tabs-container .tabs-tab .inner-box': {label: l10n.css.tabs_label, info: l10n.css.tabs_info},
			'.upfront-tabs-container .tabs-tab-active .inner-box' : {label: l10n.css.active_tab_label, info: l10n.css.active_tab_info},
			'.upfront-tabs-container .utabs-content': {label: l10n.css.tab_content_label, info: l10n.css.tab_content_info},
			'.upfront-tabs-container .utabs-content p': {label: l10n.css.tab_p_label, info: l10n.css.tab_p_info},
			'.upfront-tabs-container .utab-content-active': {label: l10n.css.active_content_label, info: l10n.css.active_content_info},
			'.upfront-tabs-container .utab-content-active p': {label: l10n.css.active_p_label, info: l10n.css.active_p_info}
		},
		cssSelectorsId: Upfront.data.utabs.defaults.type
	});

	Upfront.Models.UtabsModel = UtabsModel;
	Upfront.Views.UtabsView = UtabsView;

});
})(jQuery);


define('text!elements/upfront-this-post/tpl/preset-style.html',[],function () { return '<?php if(!empty($properties[\'preset_style\'])) { ?><?php echo $properties[\'preset_style\'] ?><?php } ?>\r\n';});

(function ($) {
define('this_post',[
	'scripts/upfront/element-settings/settings',
	'scripts/upfront/element-settings/root-settings-panel',
	'scripts/upfront/preset-settings/util',
	'text!elements/upfront-this-post/tpl/preset-style.html'
], function(ElementSettings, RootSettingsPanel, Util, styleTpl) {

var l10n = Upfront.Settings.l10n.this_post_element;

/**
 * Define the model - initialize properties to their default values.
 * @type {Upfront.Models.ObjectModel}
 */
var ThisPostModel = Upfront.Models.ObjectModel.extend({
	/**
	 * The init function is called after the contructor and Model intialize.
	 * Here the default values for the model properties are set.
	 */
	init: function () {
		var properties = _.clone(Upfront.data.thisPost.defaults);
		properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + '-object');
		this.init_properties(properties);
	}
});

var ThisPostView = Upfront.Views.ObjectView.extend({
	changed: false,
	markup: false,
	loading: false,
	postId: false,
	editor: false,

	initialize: function(options){
		var me = this;
		if(! (this.model instanceof ThisPostModel)){
			this.model = new ThisPostModel({properties: this.model.get('properties')});
		}
		this.listenTo(this.model.get('properties'), 'change', this.reset_markup);
		this.constructor.__super__.initialize.call(this, [options]);

		if (Upfront.Application.mode.current === Upfront.Application.MODE.THEME) {
			// Only extend events with post layout editing in theme editing mode
			_.extend(this.events, {
				'click .upfront-post-layout-trigger': 'editPostLayout'
			});
		}
		this.delegateEvents();

		this.postId = _upfront_post_data.post_id ? _upfront_post_data.post_id : Upfront.Settings.LayoutEditor.newpostType ? 0 : false;

		if(this.postId){
			this.refreshMarkup().then(function(){
				if(me.postId)
					me.prepareEditor();
			});
			//let's also start the editor before getting the markup
			//so its load will be faster
			me.prepareEditor();
		} else if ("themeExporter" in Upfront && Upfront.Application.mode.current === Upfront.Application.MODE.THEME) {
			// We're dealing with a theme exporter request
			// Okay, so let's fake a post
			this.postId = "fake_post";
			this.refreshMarkup();
			me.prepareEditor();
		}else if("themeExporter" in Upfront && Upfront.Application.mode.current === Upfront.Application.MODE.CONTENT_STYLE ){
            this.postId = "fake_styled_post";
            this.refreshMarkup();
            me.prepareEditor();
        }

		this.listenToOnce(this, 'rendered', function(){
			if( window.location.pathname.indexOf('/edit/') !== -1 )
			me.editor.loadingLayout.done(function() {
				setTimeout(function() {
					//Upfront.Events.trigger('post:layout:edit', me, 'archive');
					me.editor.editContents();
				}, 200);

			});


            if( Upfront.Application.is_builder() ){
                me.editor.loadingLayout.done(function() {
                    setTimeout(function() {
                        Upfront.Events.trigger('post:layout:edit', me, 'single');
                    }, 200);

                });
            }

		});

		Upfront.Events.trigger('post:initialized', this);
	},

	/**
	 * Element contents markup.
	 * @return {string} Markup to be shown.
	 */
	get_content_markup: function () {
		if(!this.markup){
			this.refreshMarkup();
			return 'loading';
		}
		return this.markup;
	},

	reset_markup: function () {
		var me = this,
			props = ['hide_featured_image', 'full_featured_image'];
		if ( ! this.markup )
			return;
		_.find(props, function(prop){
			var value = me.property(prop),
				prev_value = me._properties[prop];
			if ( !value && !prev_value ) // nothing change
				return false;
			if ( prev_value != value ){
				me.markup = false;
				return true;
			}
			return false;
		});
		if ( this.markup === false && this.editor ){ // Markup refreshed, let's also fetchPostLayout
			this.editor.fetchPostLayout();
		}
	},

	prepareEditor: function(){
		var node = this.$('.upfront-object-content').children();

		//If we don't have the node rendered yet,
		//start the editor in a separated div
		if(!node.length)
			node = [$('<div>')];

		if(!this.editor){
			this.editor = new Upfront.Content.PostEditor({
				editor_id: 'this_post_' + this.postId,
				post_id: this.postId,
				preload: true,
				node: node[0],
				content_mode: 'post_content',
				view: this,
				layout: this.property('layout')
			});
			this.editor.render();
		}
		else
			this.editor.setElement(node[0]);
	},

	on_render: function(){
		if(!this.editor)
			return;

		var me = this,
			contents = this.$('.upfront-object-content').children()
		;

		// Make sure we have an element to swap with, first up
		if(contents[0] && contents[0] != this.editor.el){
			this.editor.setElement( contents[0] );
			this.editor.render(); // ... and don't forget to re-render when swapping els
		}

		// Let's not render min-height (remove it)
		this.$el.find('> .upfront-object').css('min-height', '');
		this.parent_module_view.$el.find('> .upfront-module').css('min-height', '');
		this.add_region_class('upfront-region-container-has-this_post', true);

		//this.editor.render();
		this.trigger('rendered');
	},

	//get_buttons: function(){
	//	return '<a href="#" class="upfront-icon-button upfront-icon-button-nav upfront-post-layout-trigger"></a>';
	//},
    get_extra_buttons: function(){
        return Upfront.Application.mode.current === Upfront.Application.MODE.THEME
        	? '<a href="#" title="Edit post layout" class="upfront-icon-button upfront-icon-button-nav upfront-post-layout-trigger"></a>'
        	: ''
        ;
    },
	on_edit: function (e) {
		if(!this.editor){
			this.prepareEditor();
		}
	},

	editPostLayout: function(){
		this.markup = false;
		Upfront.Events.trigger('post:layout:edit', this, 'single');
	},

    editPostContent: function(){
        this.editor.editContents();
        Upfront.Events.trigger('upfront:element:edit:start', 'write', this);
    },

	refreshMarkup: function () {
		var me = this;

		if(this.loadingMarkup)
			return this.loadingMarkup;

		if(this.postId === false)
			return new $.Deferred().resolve({data:{filtered: 'Error'}});

		var node = $('#' + me.property('element_id')).find(".upfront-object-content"),
			loading = !node.length ? false : new Upfront.Views.Editor.Loading({
				loading: l10n.refreshing,
				done: l10n.here_we_are,
				fixed: false
			})
		;

		if(loading){
			loading.render();
			node.append(loading.$el);
		}

		this._properties = {
			post_data: this.property("post_data"),
			element_id: this.property('element_id'),
			hide_featured_image: this.property('hide_featured_image'),
			full_featured_image: this.property('full_featured_image')
		};

		this.loadingMarkup = Upfront.Util.post({
				action: "this_post-get_markup",
				data: JSON.stringify({
					post_id: this.postId,
					post_type: Upfront.Settings.LayoutEditor.newpostType,
					properties: this._properties
				})
			}).success(function(response){
				if(loading){
					loading.done();
					loading = false;
				}
				var node = node || $('#' + me.property('element_id')).find(".upfront-object-content");
				me.markup = response.data.filtered;
				node.html(me.get_content_markup());

				me.on_render();

				me.loadingMarkup = false;
			})
		;

		return this.loadingMarkup;
	},

	redirectPostEdit: function (post) {
		//window.location = Upfront.Settings.Content.edit.post + post.id;
		var path = '/edit/' + post.get('post_type') + '/' + post.id;
		Upfront.Application.navigate(path, {trigger: true});
		if ( Upfront.Settings.Application.MODE.ALLOW.indexOf(Upfront.Settings.Application.MODE.LAYOUT) != -1 )
			Upfront.Application.set_current(Upfront.Settings.Application.MODE.LAYOUT);
	},

	createEditor: function(node){
		var me = this;

		if(this.editor)
			return;

		this.editor = new Upfront.Content.editor({
			editor_id: 'this_post_' + this.postId,
			post_id: this.postId,
			preload: true,
			node: node,
			content_mode: 'post_content',
			view: me,
			autostart: this.autostart,
			onUpdated: function(post){
				me.autostart = false;
				me.editor.autostart = false;
				me.refreshMarkup(post);
				me.trigger('post:updated', post);
			}
		});

		this.listenTo(this.editor, 'editor:cancel', function(){
			me.editor.autostart = false;
			me.editor.initEditAreas();
		});
	},

	on_element_edit_start: function (edit, post) {
		if ( edit == 'write' && this.parent_module_view){
			if ( post.id != this.postId )
				this.parent_module_view.disable_interaction(false);
			else
				this.parent_module_view.$el.find('.upfront-module').addClass('upfront-module-editing');
		}
	},

	on_element_edit_stop: function (edit, post, saving_draft) {
		if(this.parent_module_view && saving_draft !== true){
			this.parent_module_view.$el.find('.upfront-module').removeClass('upfront-module-editing');
			this.parent_module_view.enable_interaction(false);
		}
	},

	/*
	Shorcut to set and get model's properties.
	*/
	property: function(name, value, silent) {
		if(typeof value != "undefined"){
			if(typeof silent == "undefined")
				silent = true;
			return this.model.set_property(name, value, silent);
		}
		return this.model.get_property_value_by_name(name);
	},

	cleanup: function(){
		if(this.editor){
			this.editor.remove();
			this.editor = false;
		}
		this.remove_region_class('upfront-region-container-has-this_post', true);
	}
});

/**
 * Editor command class - this will be injected into commands
 * and allow adding the new entity instance to the work area.
 * @type {Upfront.Views.Editor.Command}
 */
var ThisPostElement = Upfront.Views.Editor.Sidebar.Element.extend({

	draggable: false,

	/**
	 * Set up command appearance.
	 */
	render: function () {
		this.$el.html(l10n.element_name);
	},

	/**
	 * What happens when user clicks the command?
	 * We're instantiating a module with search entity (object), and add it to the workspace.
	 */
	add_element: function () {
		var object = new ThisPostModel(), // Instantiate the model
			// Since search entity is an object,
			// we don't need a specific module instance -
			// we're wrapping the search entity in
			// an anonymous general-purpose module
			module = new Upfront.Models.Module({
				"name": "",
				"properties": [
					{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
					{"name": "class", "value": "c6 upfront-this_post_module"},
					{"name": "has_settings", "value": 0},
					{"name": "row", "value": 20}
				],
				"objects": [
					object // The anonymous module will contain our search object model
				]
			})
		;
		// We instantiated the module, add it to the workspace
		this.add_module(module);
	}
});

var Settings_PostPanel_PostData = Upfront.Views.Editor.Settings.Item.extend({
	initialize: function (opts) {
		this.options = opts;
		var data = [
			{label: l10n.post_author, value: "author"},
			{label: l10n.post_date, value: "date"},
			{label: l10n.categories, value: "categories"},
			{label: l10n.tags, value: "tags"},
			{label: l10n.comments_count, value: "comments_count"},
			{label: l10n.featured_image, value: "featured_image"}
		];
		this.fields = _([
			new Upfront.Views.Editor.Field.Checkboxes({
				model: this.model,
				label: l10n.show_post_data,
				property: "post_data",
				values: data
			})
		]);
	},
	get_title: function () {
		return l10n.post_data;
	}
});

var Settings_PostPanel = RootSettingsPanel.extend({
	label: l10n.element_name,
	settings: [
		{
			type: 'SettingsItem',
			title: l10n.featured_image_option,
			fields: [
				{
					type: 'Checkboxes',
					property: "hide_featured_image",
					multiple: false,
					values: [{ label: l10n.hide_featured_image, value: '1' }],
					change: function (value, me) {
						if (value === '1')
							me.model.set_property('hide_featured_image', 1);
						else
							me.model.set_property('hide_featured_image', false);
					}
				},
				{
					type: 'Checkboxes',
					property: "full_featured_image",
					multiple: false,
					values: [{ label: l10n.full_featured_image, value: '1' }],
					change: function (value, me) {
						if (value === '1')
							me.model.set_property('full_featured_image', 1);
						else
							me.model.set_property('full_featured_image', false);
					}
				}
			]
		}
	],
	title: l10n.post_settings
});

var Settings = ElementSettings.extend({
	panels: {
		General: Settings_PostPanel,
		Appearance: {
			mainDataCollection: 'thispostPresets',
			styleElementPrefix: 'thispost-preset',
			ajaxActionSlug: 'thispost',
			panelTitle: l10n.settings,
			presetDefaults: Upfront.mainData.presetDefaults.thispost,
			styleTpl: styleTpl,
		},
	},
	
	initialize: function (opts) {
		//If editor show only general preset
		if( Upfront.Application.get_current() !== Upfront.Application.MODE.THEME ) {
			this.panels = { General: Settings_PostPanel };
		}
		
		// Call the super constructor here, so that the appearance panel is instantiated
		this.constructor.__super__.initialize.call(this, opts);
	},

	title: l10n.post_settings
});

// Generate presets styles to page
Util.generatePresetsToPage('thispost', styleTpl);

// ----- Bringing everything together -----
// The definitions part is over.
// Now, to tie it all up and expose to the Subapplication.
Upfront.Application.LayoutEditor.add_object("ThisPost", {
	Model: ThisPostModel,
	View: ThisPostView,
	Element: ThisPostElement,
	Settings: Settings
});
Upfront.Models.ThisPostModel = ThisPostModel;
Upfront.Views.ThisPostView = ThisPostView;

Upfront.data.thisPost.PostDataPanel = Settings_PostPanel;


});
})(jQuery);

(function ($) {
define('this_page',[],function() {

var l10n = Upfront.Settings.l10n.this_page_element;
/**
 * Define the model - initialize properties to their default values.
 * @type {Upfront.Models.ObjectModel}
 */
var ThisPageModel = Upfront.Models.ObjectModel.extend({
	/**
	 * The init function is called after the contructor and Model intialize.
	 * Here the default values for the model properties are set.
	 */
	init: function () {
		var properties = _.clone(Upfront.data.thisPage.defaults);
		properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + '-object');
		this.init_properties(properties);
	}
});

var ThisPageView = (function(){
	// static variables
	var page_id = false,
		changed = false,
		requesting = false,
		saving = false,
		instances = [],
		markups = {},
		queues = {};
			
	return Upfront.Views.ObjectView.extend({
		markup: false,
		loading: false,
		display: 'title',
		deferred: false,
		is_new: false,
		is_started: false,
	
		initialize: function(options){
			var me = this;
			if(! (this.model instanceof ThisPageModel)){
				this.model = new ThisPageModel({properties: this.model.get('properties')});
			}
			this.constructor.__super__.initialize.call(this, [options]);
			this.display = this.model.get_property_value_by_name('display');
			instances.push(this);
			page_id = _upfront_post_data.post_id ? _upfront_post_data.post_id : Upfront.Settings.LayoutEditor.newpostType ? 0 : false;
			
			this.listenTo(Upfront.Events, "command:layout:save_start", this.on_save);
		},
	
		/**
		 * Element contents markup.
		 * @return {string} Markup to be shown.
		 */
		get_content_markup: function () {
			if(changed || !this.markup){
				this.get_markup().done($.proxy(this.refresh_markup, this));
				return 'Loading';
			}
	
			return this.markup;
		},
		
		on_render: function () {
			this.update_editor(this.$el.find(".upfront-object-content"));
		},
		
		on_edit: function () {
			this.update_editor(this.$el.find(".upfront-object-content"), true, true);
		},
		
		get_markup: function () {
			var me = this;
			me.deferred = new $.Deferred();
	
			if ( page_id === false )
				return me.deferred.resolve('error');
				
			if(requesting)
				return me.deferred.promise();
				
			if(!changed && markups.length > 0 && markups[me.display]){
				return me.deferred.resolve(markups[me.display]);
			}
			
	
			var node = me.$el.find(".upfront-object-content"),
				loading = !node.length ? false : new Upfront.Views.Editor.Loading({
					loading: l10n.refreshing,
					done: l10n.here_we_are,
					fixed: false
				});
			;
	
			if(loading){
				loading.render();
				node.append(loading.$el);
			}
			
			requesting = true;
	
			Upfront.Util.post({
				action: "this_page-get_markup",
				data: JSON.stringify({
					post_id: page_id,
					post_type: Upfront.Settings.LayoutEditor.newpostType
				})
			}).success(function(response){
				if(loading){
					loading.done();
					loading = false;
				}
				var node = node || me.$el.find(".upfront-object-content");
				var page = Upfront.data.posts[page_id];
				markups = response.data.filtered;
				// resolving all instances
				_.each(instances, function(ins){
					ins.is_new = page && page.is_new;
					ins.deferred.resolve(markups[ins.display]);
				});
				if (page)
					page.is_new = false;
			}).done(function(){
				requesting = false;
			});
			;
			return me.deferred.promise();
		},
		
		get_page: function () {
			var page,
				_deferred = new $.Deferred();
			if ( Upfront.data.posts[page_id] ){
				page = Upfront.data.posts[page_id];
				return _deferred.resolve(page);
			}
			else {
				page = new Upfront.Models.Post({ID: page_id});
				page.fetch({withMeta: true, filterContent: true}).done(function(response){
					if(!Upfront.data.posts)
						Upfront.data.posts = {};
					Upfront.data.posts[page_id] = page;
					_deferred.resolve(page);
				});
			}
			return _deferred.promise();
		},
		
	
		refresh_markup: function (markup) {
			var me= this,
				node = this.$el.find(".upfront-object-content"),
				selector = _.findWhere(Upfront.data.ueditor.selectors, {type: this.display}).selector,
				content = '';
			this.get_page().done(function(page){
				node.html(markup);
				if ( me.display == 'title' )
					content = page.get('post_title');
				else if ( me.display == 'content' )
					content = page.get('post_content');
				node.find(selector).html(content);
				me.markup = node.html();
				me.update_editor(node);
			});
		},
		
		update_editor: function (node, start, focus) {
			var me = this,
				focus = typeof focus == 'undefined' ? true : focus,
				selector = _.findWhere(Upfront.data.ueditor.selectors, {type: this.display}).selector,
				element = node.find(selector),
				ueditor = element.data('ueditor'),
				params = {},
				edit_started = false;
			if ( ueditor ){
				if ( start === true && !me.is_started )
					element.trigger('dblclick');
				return;
			}
			if ( me.display == 'title' ){
				params = {
					airButtons: {},
					observeLinks: false,
					tabFocus: false,
					disableLineBreak: true,
					pastePlainText: true,
					autostart: start === true,
					placeholder: l10n.title_placeholder,
					focus: focus
				};
			}
			else if ( me.display == 'content' ) {
				params = {
					linebreaks: false,
					autostart: start === true,
					placeholder: l10n.content_placeholder,
					focus: focus,
					upfrontMedia: true,
					upfrontImages: true
				};
			}
			element
				.on('start', function(){
					edit_started = true;
					me.is_started = true;
					_.each(instances, function(ins){
						if ( ins == me )
							return;
						ins.update_editor(ins.$el.find(".upfront-object-content"), true, false);
					});
					setTimeout(function(){element.ueditor('focus');}, 100);
					Upfront.Events.trigger('upfront:element:edit:start', 'text');	
				})
				.on('stop', function(){
					edit_started = false;
					me.is_started = false;
					Upfront.Events.trigger('upfront:element:edit:stop');
				})
				.on('syncAfter', function(){
					if ( edit_started ){
						queues[me.display] = element.ueditor('get');
						me.markup = $(me.markup).html(queues[me.display]).get(0).outerHTML;
					}
				})
				.ueditor(params);
			;
		},
		
		on_save: function () {
			if ( saving )
				return;
			saving = true;
			var me = this;
			this.get_page().done(function(page){
				page.set('post_status', 'publish');
				page.set('post_title', queues['title']);
				page.set('post_content', queues['content']);
				page.save().done(function(){
					if ( !me.is_new )
						return;
					var path = '/edit/page/' + page_id;
					//Upfront.Application.load_layout(path);
					Upfront.Application.navigate(path);
					saving = false;
				});
			});
		},
		
		cleanup: function(){
			var me = this;
			_.each(instances, function(ins, index){
				if ( ins == me )
					instances.splice(index);
			});
		}
		
	});
})();

/**
 * Editor command class - this will be injected into commands
 * and allow adding the new entity instance to the work area.
 * @type {Upfront.Views.Editor.Command}
 */
var ThisPageTitleElement = Upfront.Views.Editor.Sidebar.Element.extend({

	draggable: false,

	/**
	 * Set up command appearance.
	 */
	render: function () {
		this.$el.html(l10n.page_title);
	},

	/**
	 * What happens when user clicks the command?
	 * We're instantiating a module with search entity (object), and add it to the workspace.
	 */
	add_element: function () {
		var object = new ThisPageModel({ view: 'ThisPageTitle' }), // Instantiate the model
			// Since search entity is an object,
			// we don't need a specific module instance -
			// we're wrapping the search entity in
			// an anonymous general-purpose module
			module = new Upfront.Models.Module({
				"name": "",
				"properties": [
					{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
					{"name": "class", "value": "c6 upfront-this_page_title_module"},
					{"name": "has_settings", "value": 0}
				],
				"objects": [
					object // The anonymous module will contain our search object model
				]
			})
		;
		// We instantiated the module, add it to the workspace
		this.add_module(module);
	}
});

var ThisPageContentElement = Upfront.Views.Editor.Sidebar.Element.extend({

	draggable: false,

	/**
	 * Set up command appearance.
	 */
	render: function () {
		this.$el.html(l10n.page_content);
	},

	/**
	 * What happens when user clicks the command?
	 * We're instantiating a module with search entity (object), and add it to the workspace.
	 */
	add_element: function () {
		var object = new ThisPageModel({ view: 'ThisPageContent' }), // Instantiate the model
			// Since search entity is an object,
			// we don't need a specific module instance -
			// we're wrapping the search entity in
			// an anonymous general-purpose module
			module = new Upfront.Models.Module({
				"name": "",
				"properties": [
					{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
					{"name": "class", "value": "c6 upfront-this_page_content_module"},
					{"name": "has_settings", "value": 0}
				],
				"objects": [
					object // The anonymous module will contain our search object model
				]
			})
		;
		// We instantiated the module, add it to the workspace
		this.add_module(module);
	}
});

// ----- Bringing everything together -----
// The definitions part is over.
// Now, to tie it all up and expose to the Subapplication.
/*Upfront.Application.LayoutEditor.add_object("ThisPageTitle", {
	Model: ThisPageModel,
	View: ThisPageTitleView,
	Element: ThisPageTitleElement,
});*/
/*Upfront.Application.LayoutEditor.add_object("ThisPageTitle", {
	Model: ThisPageModel,
	View: ThisPageContentView,
	Element: ThisPageContentElement,
});*/
Upfront.Models.ThisPageModel = ThisPageModel;
Upfront.Views.ThisPageView = ThisPageView;


});
})(jQuery);

(function ($) {
define('elements/upfront-widget/js/settings',[
	'scripts/upfront/element-settings/settings',
	'scripts/upfront/element-settings/root-settings-panel',
	'scripts/upfront/preset-settings/util',
	'text!elements/upfront-widget/tpl/preset-style.html'
], function (ElementSettings, RootSettingsPanel, Util, styleTpl) {
	var l10n = Upfront.Settings.l10n.widget_element;

	var current_widget = false, 
		selected_widget = false;

	// Widget element's settings consist of a static settings block and a dynamic one
	// Static settings consist of a dropdown that lets you choose a specific widget to be rendered
	// Dynamic settings is an instance of UwidgetSpecific_Settings defined following this comments block
	// Dynamic settings loads widget specific settings (based on the selection made in the dropdown) into the panel


	/**
	 * Widget Specific Settings contain the logic to load widget settings for the current selected widget type.
	 */
	var UwidgetSpecific_Settings = Upfront.Views.Editor.Settings.Item.extend({

		get_title: function(){
			for(i in Upfront.data.uwidget.widgets) {
				
				if(Upfront.data.uwidget.widgets[i].key === selected_widget || Upfront.data.uwidget.widgets[i].key === this.model.get_property_value_by_name('current_widget'))
					return Upfront.data.uwidget.widgets[i].name
			}
			
			if(current_widget)
				return current_widget;
			else
				return '';
		},
		update_settings: function(widget, parent) {
			var self = this,
				data = {"action": "uwidget_get_widget_admin_form", "data": JSON.stringify({"widget": widget})}
			;
			Upfront.Util.post(data)
				.success(function (ret) {
					self.model.set_property('current_widget_specific_fields', ret.data);
								
					self.$el.html('');
				
					selected_widget = widget;
					current_widget = widget;

					self.udpate_fields();
					
					self.render();

					/** To enable for_view's re-rendering on widget selection from the drop down
						This is set after the widget specific settings are available to provide their 
						parameters to the rendering of the widget **/
					parent.model.set_property('current_widget', widget);

				})
				.error(function (ret) {
					console.log("error receiving widget specific settings");
				})
			;
		},
		initialize: function() {
			selected_widget = current_widget;
			this.udpate_fields();
		},
		udpate_fields: function() {
			var self = this;
			this.fields=_([]);
			var specific_fields = this.model.get_property_value_by_name('current_widget_specific_fields');

			for( key in specific_fields) {
				if(specific_fields[key]['type'] == 'select') {
					this.fields._wrapped[this.fields._wrapped.length] = new Upfront.Views.Editor.Field.Select({
						model: this.model,
						property: specific_fields[key]['name'],
						label: specific_fields[key]['label'],
						values: _.map(specific_fields[key]['options'], function(option, key){ return { label: option, value: key }; }),
						change: this.clear_cache

					});
				}
				else if(specific_fields[key]['type'] == 'text') {
					this.fields._wrapped[this.fields._wrapped.length] = new Upfront.Views.Editor.Field.Text({
						model: this.model,
						property: specific_fields[key]['name'],
						label: specific_fields[key]['label'],
						value: specific_fields[key]['value'],
						change: this.clear_cache
					});
				}
				else if(specific_fields[key]['type'] == 'textarea') {
					this.fields._wrapped[this.fields._wrapped.length] = new Upfront.Views.Editor.Field.Textarea({
						model: this.model,
						property: specific_fields[key]['name'],
						label: specific_fields[key]['label'],
						value: specific_fields[key]['value'],
						change: this.clear_cache
					});
				}
				else if(specific_fields[key]['type'] == 'checkbox') {
					this.fields._wrapped[this.fields._wrapped.length] = new Upfront.Views.Editor.Field.Checkboxes({
						model: this.model,
						property: specific_fields[key]['name'],
						label: '',
						values: [{ label: specific_fields[key]['label'], value: specific_fields[key]['value'] }],
						change: this.clear_cache
					});
				}
				else if(specific_fields[key]['type'] == 'radio') {
					this.fields._wrapped[this.fields._wrapped.length] = new Upfront.Views.Editor.Field.Radios({
						model: this.model,
						property: specific_fields[key]['name'],
						label: '',
						values: [{ label: specific_fields[key]['label'], value: specific_fields[key]['value'] }],
						change: this.clear_cache
					});

				}
			}
		},
		clear_cache: function (value) {
			Upfront.data.uwidget.widgets_cache = {};
			var property = (this.options || {}).property,
				current = this.model.get_property_value_by_name('current_widget_specific_fields')
			;
			_.each(current, function (prop, idx) {
				if (property === (prop || {}).name) {
					this.model.set_property(property, value);
				}
			}, this);
		}
	});


	/**
	 * Widget settings to be returned. Contains logic to populate widget types dropdown list
	 * and triggers the instance dynamic_settings to re-render with new settings for the specific widget type selected.
	 */
	var UwidgetSettings = ElementSettings.extend({
		panels: {
			// only this one will be instantiated the API way
			Appearance: {
				mainDataCollection: 'widgetPresets',
				styleElementPrefix: 'widget-preset',
				ajaxActionSlug: 'widget',
				panelTitle: l10n.settings,
				presetDefaults: {
					'id': 'default',
					'name': l10n.default_preset,
				},
				styleTpl: styleTpl,
			}
		},

		initialize: function (opts) {

			// Call the super constructor here, so that the appearance panel is instantiated
			this.constructor.__super__.initialize.call(this, opts);
			
			var widget_values = _(_.filter(Upfront.data.uwidget.widgets, function (each) {
				return each.admin;
			})).map(function (each) {
				return { label: each.name, value: each.key };
			});

			// Add a default 'select' value
			widget_values.unshift({label: l10n.widget_select, value: ''});

			var panel = new RootSettingsPanel({
				model: this.model,
				className: 'upfront-settings_panel_wrap widget-settings',
				title: l10n.settings,
			});

			var dynamic_settings = new UwidgetSpecific_Settings({model: this.model});

			var static_settings = new Upfront.Views.Editor.Settings.Item({
				model: this.model,
				title: l10n.widget_select,
				fields: [
					new Upfront.Views.Editor.Field.Select({
						model: this.model,
						property: 'widget',
						values: widget_values,
						change: function(value) {
							
							current_widget = value;

							if( selected_widget !== value ) {
								//To load widget specific settings
								dynamic_settings.update_settings(value, this);
								
							}

						}
					})
				]
			});

			panel.settings = _([static_settings, dynamic_settings]);
			
			this.panels = _.extend({General: panel}, this.panels);
			

			// save widget specific fields when settings are saved, no one else will do that for you
			// clear previous subscription to events, that could be left over when 'saved' was cliked instead of 'cancel'
			var saveWidgetSpecificFields = function() {
				this.model.set_property('widget_specific_fields', this.model.get_property_value_by_name('current_widget_specific_fields'));
			}
			// clear previous subscription to events, that could be left over when 'cancelled' was cliked instead of 'save'
			Upfront.Events.off('element:settings:saved', saveWidgetSpecificFields);
			// then subscribe
			Upfront.Events.once('element:settings:saved', saveWidgetSpecificFields, this);

			// so, if settings are cancelled, all live rendering settings should revert
			var revertSettings = function() {
				current_widget = selected_widget = this.model.get_property_value_by_name('widget');
				this.model.set_property('current_widget_specific_fields', this.model.get_property_value_by_name('widget_specific_fields'), true);
				this.model.set_property('current_widget', this.model.get_property_value_by_name('widget'));
			};
			// clear previous subscription to events, that could be left over when 'saved' was cliked instead of 'cancel'
			Upfront.Events.off('element:settings:canceled', revertSettings);
			// then subscribe
			Upfront.Events.once('element:settings:canceled', revertSettings, this);


		},
		
		title: l10n.settings
		
	});

	// Generate presets styles to page
	Util.generatePresetsToPage('widget', styleTpl);
	return UwidgetSettings;
});
})(jQuery);

(function ($) {
define('uwidget',[
		'elements/upfront-widget/js/settings',
	], function(UwidgetSettings) {

	var l10n = Upfront.Settings.l10n.widget_element;

	var UwidgetModel = Upfront.Models.ObjectModel.extend({
		init: function () {
			var properties = _.clone(Upfront.data.uwidget.defaults);
			properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + '-object');
			this.init_properties(properties);
		}
	});

	var UwidgetView = Upfront.Views.ObjectView.extend({

		loading: null,
		content_loaded: false,
		initialize: function(options){
			if(! (this.model instanceof UwidgetModel)){
				this.model = new UwidgetModel({properties: this.model.get('properties')});
			}
			
			// copy values from saved ones to the realtime rendering ones in the editor
			this.model.set_property('current_widget', this.model.get_property_value_by_name('widget'), true);
			this.model.set_property('current_widget_specific_settings', this.model.get_property_value_by_name('widget_specific_fields'), true);

			this.constructor.__super__.initialize.call(this, [options]);

		},

		init: function () {

			if ( !Upfront.data.uwidget.widgets_cache ) {
				Upfront.data.uwidget.widgets_cache = {};
			}

			Upfront.Events.on('entity:settings:activate', this.clear_cache, this);

		},

		clear_cache: function() {
			Upfront.data.uwidget.widgets_cache[this.model.get_property_value_by_name('current_widget')+this.cid] = null;
		},

		get_content_markup: function () {
			
			var widget = this.model.get_property_value_by_name('current_widget');
				me = this;

				if ( !widget || widget === '') {
					return '<span class="no-widget-notice">' + l10n.select_widget + '</span>';
				}

				var widget_data =  Upfront.data.uwidget.widgets_cache[widget+this.cid] || '';

				if ( widget_data ) {
					this.content_loaded = true;
				}

				return widget_data;
		},

		on_render: function () {

			var widget = this.model.get_property_value_by_name('current_widget');
			if ( !widget ) {
				return;
			}

			if ( typeof Upfront.data.uwidget.widgets_cache[widget+this.cid] == 'undefined' || Upfront.data.uwidget.widgets_cache[widget+this.cid] == null){

				if ( this.content_loaded ){ // only display loading if there's already content
					this.loading = new Upfront.Views.Editor.Loading({
						loading: l10n.loading,
						done: l10n.done
					});
					this.loading.render();
					this.$el.append(this.loading.el);
				}
				this._get_widget_markup(widget);
				//this.get_widget_settings(widget);
			}

		},
		_get_widget_markup: function (widget) {
			var me = this;
			//prepare instance

			var specific_fields = this.model.get_property_value_by_name('current_widget_specific_fields')

			var instance = {};


			for( key in specific_fields) {
					instance[specific_fields[key]['name']] =  this.model.get_property_value_by_name(specific_fields[key]['name']);
			}

			Upfront.Util.post({"action": "uwidget_get_widget_markup", "data": JSON.stringify({"widget": widget, "instance": instance})})
				.success(function (ret) {

					Upfront.data.uwidget.widgets_cache[widget+me.cid] = ret.data;
					if ( me.loading ){
						me.loading.done(function(){
							me.render();
						});
					}
					else {
						me.render();
					}
				})
				.error(function (ret) {
					Upfront.Util.log("Error loading widget");

			});
		},



	});

	var UwidgetElement = Upfront.Views.Editor.Sidebar.Element.extend({
		priority: 80,

		render: function () {
			this.$el.addClass('upfront-icon-element upfront-icon-element-widget');
			this.$el.html(l10n.element_name);
		},

		add_element: function () {
			var object = new UwidgetModel(),
				module = new Upfront.Models.Module({
					"name": "",
					"properties": [
						{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
						{"name": "class", "value": "c6 upfront-widget_module"},
						{"name": "has_settings", "value": 0},
						{"name": "row", "value": Upfront.Util.height_to_row(150)}
					],
					"objects": [
						object
					]
				})
			;
			this.add_module(module);
		}
	});




	Upfront.Application.LayoutEditor.add_object("Uwidget", {
		"Model": UwidgetModel,
		"View": UwidgetView,
		"Element": UwidgetElement,
		"Settings": UwidgetSettings,
		cssSelectors: {
			'.widget': {label: l10n.css.container_label, info: l10n.css.container_info},
			'.widget a': {label: l10n.css.links_label, info: l10n.css.links_info}
		},
		cssSelectorsId: Upfront.data.uwidget.defaults.type
	});
	Upfront.Models.UwidgetModel = UwidgetModel;
	Upfront.Views.UwidgetView = UwidgetView;


});

})(jQuery);


define('text!elements/upfront-youtube/tpl/youtube.html',[],function () { return '<div class="upfront-youtube-container <?php if ($multiple_videos && count($multiple_videos) < 2) { ?>uyoutube-single<?php } else { ?>uyoutube-multiple-<?php echo $display_style ?><?php } ?>">\r\n    <?php if ($multiple_videos && count($multiple_videos) == 1) { ?>\r\n\t\t<?php if(!empty($multiple_videos[0][\'id\'])) { ?>\r\n\t\t\t<iframe src="http://www.youtube.com/embed/<?php echo $multiple_videos[0][\'id\'] ?>?modestbranding=1" height="<?php echo $player_height ?>" width="<?php echo $player_width ?>"></iframe>\r\n\t\t\t<?php if(!empty($multiple_show_title[0])){ ?>\r\n\t\t\t\t<h3><?php echo $multiple_videos[0][\'title\'] ?></h3>\r\n\t\t\t<?php } ?>\r\n\t\t<?php } else { ?>\r\n\t\t\t<div class="uyoutube-player" style="width: <?php echo $player_width ?>px; height: <?php echo $player_height ?>px;"></div>\r\n\t\t<?php } ?>\r\n\t<?php } ?>\r\n\t\r\n\t<?php if (count($multiple_videos) > 1) { ?>\r\n    <div class="uyoutube-main-video">\r\n      <?php if ( !empty($multiple_videos[0] ) ) { ?>\r\n        <iframe src="http://www.youtube.com/embed/<?php echo $multiple_videos[0][\'id\'] ?>?modestbranding=1" height="<?php echo $player_height ?>" width="<?php echo $player_width ?>"></iframe>\r\n\t\t<h3><?php echo $multiple_videos[0][\'title\'] ?></h3>\r\n\t  <?php } else { ?>\r\n        <div class="uyoutube-player" style="height:<?php echo $player_height ?>px; width:<?php echo $player_width ?>px;"></div>\r\n      <?php } ?>\r\n    </div>\r\n\t<div class="uyoutube-thumbnails">\r\n    <?php if ($display_style == \'gallery\') { ?>\r\n      <?php if ($multiple_videos && count( $multiple_videos )  ) {  ?>\r\n        <?php for ($i = 0; $i < count( $multiple_videos ); $i++) {  ?>\r\n\t\t<?php if(empty($first_to_thumbnails[0]) && $i == 0) { continue; } ?>\r\n          <div class="uyoutube-thumbnail uyoutube-gallery-item <?php if(empty($first_to_thumbnails[0])) { ?>firstHidden<?php } ?>" data-video-id="<?php echo $multiple_videos[$i][\'id\'] ?>" style="width:<?php echo $thumbWidth ?>px;">\r\n            <div class="uyoutube-thumb-mask" style="width:<?php echo $thumbWidth ?>px;height:<?php echo $thumbHeight ?>px"><!-- add width height dynamicly -->\r\n\t\t\t\t<img class="uyoutube-thumb" src="http://img.youtube.com/vi/<?php echo $multiple_videos[$i][\'id\'] ?>/hqdefault.jpg" style="width:<?php echo $thumbWidth ?>px; margin-top: -<?php echo $thumbOffset ?>px;">\r\n            </div>\r\n            <?php if(!empty($multiple_show_title[0])){ ?>\r\n            <h4 class="uyoutube-title"><?php echo $multiple_videos[$i][\'title\'] ?></h4>\r\n            <?php } ?>\r\n          </div>\r\n        <?php } ?>\r\n      <?php } ?>\r\n    <?php } ?>\r\n    <?php if ($display_style == \'list\') { ?>\r\n      <?php if ($multiple_videos) { ?>\r\n        <?php for ($i = 0; $i < count( $multiple_videos ); $i++) { ?>\r\n\t\t<?php if(empty($first_to_thumbnails[0]) && $i == 0) { continue; } ?>\r\n        <div class="uyoutube-thumbnail uyoutube-list-item <?php if(empty($first_to_thumbnails[0])) { ?>firstHidden<?php } ?>" data-video-id="<?php echo $multiple_videos[$i][\'id\'] ?>">\r\n            <div class="uyoutube-thumb-holder" style="width:<?php echo $thumbWidth ?>px;">\r\n              <div class="uyoutube-thumb-mask" style="width:<?php echo $thumbWidth ?>px;height:<?php echo $thumbHeight ?>px">\r\n                <img class="uyoutube-thumb" style="width:<?php echo $thumbWidth ?>px; margin-top: -<?php echo $thumbOffset ?>px" src="http://img.youtube.com/vi/<?php echo $multiple_videos[$i][\'id\'] ?>/hqdefault.jpg" width="80">\r\n              </div>\r\n            </div>\r\n            <div class="uyoutube-content-holder">\r\n              <?php if ($multiple_show_title[0]) { ?>\r\n                <h4 class="uyoutube-title"><?php echo $multiple_videos[$i][\'title\'] ?></h4>\r\n              <?php } ?>\r\n            </div>\r\n          </div>\r\n        <?php } ?>\r\n      <?php }  ?>\r\n    <?php } ?>\r\n\t</div>\r\n  <?php } ?>\r\n</div>\r\n';});


define('text!elements/upfront-youtube/tpl/clonevideo.html',[],function () { return '<div class="upfront-settings-item">\r\n\t<div class="upfront-settings-item-content">\r\n\t\t<div class="multiple_sources">\r\n\t\t\t<label class="upfront-field-label upfront-field-label-block" for="view3296-multiple_source_{{cloneId}}">{{l10n.video_label}} {{cloneId}} {{l10n.url_label}}</label>\r\n\t\t\t<input id="view3296-multiple_source_{{cloneId}}" class="upfront-field upfront-field-text" type="text" placeholder="{{l10n.url_placeholder}}" value="{{videoUrl}}" name="multiple_source_{{cloneId}}">\r\n\t\t</div>\r\n\t</div>\r\n</div>';});

(function ($) {
define('uyoutube',[
	'scripts/upfront/element-settings/settings',
	'scripts/upfront/element-settings/root-settings-panel',
	'text!elements/upfront-youtube/tpl/youtube.html',
	'text!elements/upfront-youtube/tpl/clonevideo.html'
], function(ElementSettings, RootSettingsPanel, youtubeTpl, cloneTpl) {

var l10n = Upfront.Settings.l10n.youtube_element;

var UyoutubeModel = Upfront.Models.ObjectModel.extend({
	init: function () {
		var properties = _.clone(Upfront.data.uyoutube.defaults);
		properties.element_id = Upfront.Util.get_unique_id("youtube-object");
		this.init_properties(properties);
	}
});

var UyoutubeView = Upfront.Views.ObjectView.extend({
	model: UyoutubeModel,
	youtubeTpl: Upfront.Util.template(youtubeTpl),
	elementSize: {width: 0, height: 0},

	initialize: function(){
		var me = this;
		if(! (this.model instanceof UyoutubeModel)){
			this.model = new UyoutubeModel({properties: this.model.get('properties')});
		}

		var parent = this.parent_module_view, me = this;

		this.delegateEvents();

		this.model.get("properties").bind("change", this.render, this);
		this.model.get('properties').bind('change', this.handle_visual_padding_hint, this);
		this.model.get("properties").bind("add", this.render, this);
		this.model.get("properties").bind("remove", this.render, this);

		this.listenTo(Upfront.Events, "upfront:layout_size:change_breakpoint", this.onResizeStop);

	},
	
	on_element_resize_start: function (attr) {
		//Append overlay div to prevent Iframe hijack drag event
		this.$el.find('.upfront-object-content').append('<div class="object-view-overlay" />');
	},
	
	on_element_resize: function (attr) {
		//Remove overlay div
		this.$el.find('.object-view-overlay').remove();
		
		//Update player size on resize
		this.onResizeStop(this);
	},
	
	get_content_markup: function () {
		var rendered,
		props = this.extract_properties();

		this.trimListTitle();

		rendered = this.youtubeTpl(this.extract_properties());

		if(this.property('youtube_status') === 'starting' && !props.multiple_videos){
		rendered += '<div class="upfront-youtube-starting-select upfront-initial-overlay-wrapper">' +
			'<div class="upfront-youtube-starting-wrapper upfront-initial-overlay-wrapper" style="height: 110px;">' +
			'<div class="upfront-youtube-starting-text">'+ l10n.enter_url +'</div>'+
			'<div class="upfront-youtube-box-wrapper"><input type="text" class="upfront-youtube-url" placeholder="'+ l10n.url_placeholder +'" /></div>' +
			'<div class="upfront-youtube-button-wrapper"><button type="button" class="upfront-youtube-button">'+ l10n.submit_button +'</button></div>'+
			'</div></div>';
		}

		return rendered;
	},

	trimListTitle: function() {
		var me = this;
		var props = this.extract_properties();

		if(props.multiple_videos !== null && typeof props.multiple_videos === 'object') {
			$.each(props.multiple_videos, function(index, video) {
				if (video.title && !video.original_title) video.original_title = video.title;
				if (video.title && video.original_title) {
					video.title = video.original_title.substring(0, me.property('multiple_title_length'));
				}
			});
		}
	},

	extract_properties: function() {
		var props = {};
		this.model.get('properties').each(function(prop){
			props[prop.get('name')] = prop.get('value');
		});
		return props;
	},

	onResizeStop: function(view, model, ui) {
		var width;
		if(this.property('youtube_status') !== 'starting'){
			width = this.$el.find('.upfront-object-content').width();
			this.property('player_height', parseInt(width/1.641, 10));
			this.property('player_width', width, false);
		}
	},
	
	addVideo: function(videoInput) {
		me.property('youtube_status', 'ok');
		//Add first video
		me.property('multiple_source_1', videoInput);

		Upfront.Events.trigger("entity:settings:activate", me);

		//Call resize function to match player width with object width
		me.onResizeStop();

		//Delay events else values are empty
		setTimeout(function(){
			me.on_settings_click();
			//Trigger event for adding videos to array
			Upfront.Events.trigger("upfront:youtube:added");

		}, 50);
	},

	on_render: function() {
		me = this;

		this.$el.find('.upfront-youtube-button').on('click', function(e) {

			var videoInput = $(this).parents().find('input.upfront-youtube-url').val();
			
			//Check if video is valid
			if(videoInput) {
				if (videoInput.match(/youtu\.be/)) {
					videoMatch = videoInput.match(/^(https?:\/\/)?youtu.be\/([0-9a-zA-Z\-_]{11})/);
					if(videoMatch !== null && videoMatch.length > 0) {
						me.addVideo(videoInput);
					} else {
						Upfront.Views.Editor.notify(l10n.validMessage, 'error');
					}
				} else {
					videoMatch = videoInput.match(/^(https?:\/\/(www\.)?)?youtube\.com\/watch\?v=([0-9a-zA-Z\-_]{11}).*/);
					if(videoMatch !== null && videoMatch.length > 0) {
						me.addVideo(videoInput);
					} else {
						Upfront.Views.Editor.notify(l10n.validMessage, 'error');
					}
				}
			}

		});

		this.$el.find('.upfront-youtube-url').on('keydown', function(e) {
			if(e.which == 13) {
				me.$el.find('.upfront-youtube-button').click();
				Upfront.Events.trigger("upfront:element:edit:stop");
			}
		});
	},

	property: function(name, value, silent) {
		if(typeof value != "undefined") {
			if(typeof silent == "undefined")
				silent = true;
			return this.model.set_property(name, value, silent);
		}
		return this.model.get_property_value_by_name(name);
	}
});

var YoutubeElement = Upfront.Views.Editor.Sidebar.Element.extend({
	priority: 110,
	render: function () {
		this.$el.addClass('upfront-icon-element upfront-icon-element-youtube');
		this.$el.html('YouTube');
	},
	add_element: function () {
		var object = new UyoutubeModel(),
		module = new Upfront.Models.Module({
			"name": "",
			"properties": [
				{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
				{"name": "class", "value": "c11 upfront-youtube_module"},
				{"name": "has_settings", "value": 0},
				{"name": "row", "value": Upfront.Util.height_to_row(225)}
			],
			"objects": [
				object
			]
		});
		this.add_module(module);
	}
});

var Disablable_Field_Number = Upfront.Views.Editor.Field.Text.extend({
	on_render: function(){
		var className = 'upfront-field-wrap upfront-field-wrap-number';
		if (!this.options.disabled)
			className += ' upfront-field-wrap-disabled';
			this.el.className = className;
	},

	get_field_html: function () {
		var attr = {
		'type': 'number',
		'class': 'upfront-field upfront-field-number',
		'id': this.get_field_id(),
		'name': this.get_field_name(),
		'value': this.get_saved_value(),
		'min': this.options.min,
		'max': this.options.max,
		'step': this.options.step
		};

		if (this.options.disabled) attr.disabled = 'disabled';
		return ' <input ' + this.get_field_attr_html(attr) + ' /> ' + (this.options.suffix ? this.options.suffix : '');
	}
});

var BehaviorPanel = RootSettingsPanel.extend({
	className: 'uyoutube-settings',
	tabbed: false,
	title: l10n.general_settings,
	initialize: function (opts) {
		this.options = opts;
		var render_all = function(){
			this.settings.invoke('render');
		},
		me = this,
		SettingsItem =  Upfront.Views.Editor.Settings.Item,
		Fields = Upfront.Views.Editor.Field
		;

		this.model.on('doit', render_all, this);

		this.settings = _([
		new SettingsItem({
			className: 'optional-field align-center general_settings_item',
			title: l10n.apperance_title,
			fields: [
				new Fields.Radios({
					model: this.model,
					property: 'display_style',
					layout: "horizontal",
					label: l10n.display_style,
					className: 'field-display_style upfront-field-wrap upfront-field-wrap-multiple upfront-field-wrap-radios',
					values: [
						{
							label: l10n.gallery_label,
							value: 'gallery',
						},
						{
							label: l10n.list_label,
							value: 'list',
						}
					]
				}),

				new Fields.Checkboxes({
					model: this.model,
					property: 'first_to_thumbnails',
					className: 'first-video-to-thumbnails',
					default_value: ['1'],
					values: [
						{ label: l10n.first_to_thumbnails, value: '1' },
					],
					change: function(value) {
						this.model.set_property('first_to_thumbnails', value);
					}
				}),

				new Fields.Checkboxes({
					model: this.model,
					property: 'multiple_show_title',
					label: "",
					values: [
						{ label: "", value: 'multiple_show_title' },
					],
					change: function(value) {
						this.model.set_property('multiple_show_title', value);
					}
				}),
				new Fields.Number({
					model: this.model,
					property: 'multiple_title_length',
					label: l10n.title_limit,
					label_style: 'inline',
					suffix: l10n.characters_label,
					min: 50,
					max: 100,
					step: 1,
					default_value: 100,
					change: function(value) {
						this.model.set_property('multiple_title_length', value);
					}
				}),

				new Fields.Slider({
					model: this.model,
					property: 'thumbWidth',
					className: 'thumbnails-width',
					min: 100,
					max: 250,
					step: 5,
					label: l10n.thumbnail_size,
					valueTextFilter: function(value){
						return '(' + value + 'px x ' + me.model.get_property_value_by_name('thumbHeight') + 'px)';
					}
				}),
				new Fields.Hidden({
					model: this.model,
					property: 'thumbHeight'
				})
			]
		}),
		new SettingsItem({
			model: this.model,
			title: l10n.videos_title,
			className: 'multiple_video_section general_settings_item',
			fields: [
				new Fields.Text({
					model: this.model,
					label: l10n.default_video,
					className: 'multiple_sources yt_first_video',
					property: 'multiple_source_1',
					placeholder: l10n.video_placeholder
				}),
			],
		}),
		new SettingsItem({
			model: this.model,
			className: 'upfront-add-another-wrapper',
			fields: [
			new Fields.Button({
				className: 'upfront-add-another',
				label: l10n.add_video,
				compact: true,
				on_click: function(){
					me.cloneMultipleVideo();
				}
			}),
			]
		}),
		new Upfront.Views.Editor.Settings.Settings_CSS({model: this.model }),
		]);

		this.$el
		.on('change', 'input[name=display_style]', function(e){
			me.changeDisplayStyle(e);
		})
		.on('change', 'input[name=thumbWidth]', function(e) {
			me.onThumbChangeSize(e);
		})
		;
		this.on('concealed', this.setFieldEvents, this);
	},

	get_label: function () {
		return l10n.settings;
	},

	get_title: function () {
		return l10n.settings;
	},

	render: function() {
		var me = this;
		RootSettingsPanel.prototype.render.call(this);

		this.listMultipleVideos();
		setTimeout(function(){
			me.toggleMultipleSettings();
		}, 50);

		// Inline checkboxes
		this.$el.find('[name^=multiple_show_title], [name^=show_title], [name^=show_description]').parent().css({
		'float': 'left',
		'margin-top': '22px'
		});
	},

	toggleMultipleSettings: function() {
		//If multiple videos added show multiple videos settings
		var videosCount = this.$el.find('[name^="multiple_source_"]').length;
		if(videosCount > 1) {
			this.$el.find('.field-display_style, .first-video-to-thumbnails, .thumbnails-width').show();
		} else {
			this.$el.find('.field-display_style, .first-video-to-thumbnails, .thumbnails-width').hide();
		}
	},

	onThumbChangeSize: function(e){
		var me = this,
		factor = 1.8, // Got to this value by trail and error
		offsetFactor = 10.4,
		width = $(e.target).val(),
		height = Math.round($(e.target).val() / factor),
		thumbOffset = Math.round($(e.target).val() / offsetFactor)
		;
		this.$('input[name=thumbHeight]').val(height);

		this.property('thumbWidth', width);
		this.property('thumbOffset', thumbOffset);
		this.property('thumbHeight', height, false);

		return height;
	},

	changeDisplayStyle: function(e) {
		this.property('display_style', $(e.currentTarget).val(), false);
		this.toggleDescriptionEnabled();
	},

	toggleDescriptionEnabled: function() {
		if (this.property('display_style') === 'gallery') {
		this.$el.find('[name=multiple_description_length]')
			.attr('disabled', 'disabled')
			.parent()
			.addClass('upfront-field-wrap-disabled')
		;

		return;
		}

		this.$el.find('[name=multiple_description_length]')
			.removeAttr('disabled')
			.parent()
			.removeClass('upfront-field-wrap-disabled')
		;

		this.$el.find('[name=multiple_show_description]')
			.removeAttr('disabled')
			.parent()
			.removeClass('upfront-field-multiple-disabled')
		;
	},

	property: function(name, value, silent) {
		if(typeof value != "undefined"){
			if(typeof silent == "undefined")
				silent = true;
				return this.model.set_property(name, value, silent);
		}

		return this.model.get_property_value_by_name(name);
	},

	//Listing all videos fields when settings panel is opened
	listMultipleVideos: function() {
		var videos = this.model.get_property_value_by_name('multiple_videos');
		var me = this;
		if(videos.length > 0) {
			//Empty the container to prevent field duplicate
			me.$el.find('.multiple_video_section').html('<div class="upfront-settings-item-title"><span>'+ l10n.videos_title +'</span></div>');
			$(videos).each(function( index, element ) {
				me.$el.find('.multiple_video_section').append(_.template(cloneTpl, {
					cloneId: index + 1,
					videoUrl: element.video_url,
					l10n: l10n.template
				}));
			});
		}

	},

	//Adding new set of fields from template
	cloneMultipleVideo: function() {
		var panel_count = this.$el.find('.multiple_video_section .upfront-settings-item').length;
		this.$el.find('.multiple_video_section').append(_.template(cloneTpl, {
			cloneId: panel_count + 1,
			videoUrl: '',
			l10n: l10n.template
		}));
		this.toggleMultipleSettings();
	}
});

var YoutubeSettings = ElementSettings.extend({
	panels: {
		'Behavior': BehaviorPanel
	},
	events: {
		'click .upfront-save_settings' : 'saveSettings',
		'click .upfront-cancel_settings' : 'cancelSettings',
		'change .multiple_sources': 'multipleVideos',
	},

	initialize: function (options) {
		this.constructor.__super__.initialize.call(this, options);

		this.listenTo(Upfront.Events, "upfront:youtube:added", this.multipleVideos);
	},

	actions: {
		'single': 'upfront_youtube_single',
	},

	multipleVideos: function(event) {
		var me = this;
		var multiple_videos_array = [];
		var videoCounter = 0;
		var videoFields = this.$el.find('[name^="multiple_source_"]');

		//Get all videos urls
		videoFields.each(function( index, element ) {
			var videoUrl = $(element).val();
			var elementId = index + 1;
			//Get video settings
			var videoId;
			var videoMatch;
			if(videoUrl) {
				if (videoUrl.match(/youtu\.be/)) {
					videoMatch = videoUrl.match(/^(https?:\/\/)?youtu.be\/([0-9a-zA-Z\-_]{11})/);
					if(videoMatch !== null && videoMatch.length > 0) {
						videoId = videoMatch[2];
					} else {
						Upfront.Views.Editor.notify(l10n.validMessage, 'error');
					}
				} else {
					videoMatch = videoUrl.match(/^(https?:\/\/(www\.)?)?youtube\.com\/watch\?v=([0-9a-zA-Z\-_]{11}).*/);
					if(videoMatch !== null && videoMatch.length > 0) {
						videoId = videoMatch[3];
					} else {
						Upfront.Views.Editor.notify(l10n.validMessage, 'error');
					}
				}
				var data = {'video_id': videoUrl};

				Upfront.Util.post({"action": me.actions.single, "data": data})
					.success(function (response) {
						multiple_videos_array.push({
							order: elementId,
							title: response.data.video.title,
							id: videoId,
							video_url: videoUrl,
							thumbnail: response.data.video.thumbnail_url
						});
						videoCounter++;
					})
					.error(function () {
						Upfront.Util.log("error single video");
					})
					.done(function () {
						if(videoCounter == videoFields.length) {
							multiple_videos_array.sort(function(a,b) { return a.order - b.order; });
							me.for_view.model.set_property('multiple_videos', multiple_videos_array, false);
						}
					})
					;
			}
			else {
				videoCounter++;
			}
		});
	},
	title: l10n.element_settings,
	get_title: function () {
		return l10n.element_settings;
	}
});

Upfront.Application.LayoutEditor.add_object("Uyoutube", {
	"Model": UyoutubeModel,
	"View": UyoutubeView,
	"Element": YoutubeElement,
	"Settings": YoutubeSettings,
	'anchor': {
		is_target: false
	},
	cssSelectors: {
		'.upfront-youtube-container': { label: l10n.css.global_wrapper_label, info: l10n.css.global_wrapper_info },
		'.uyoutube-thumbnails': { label: l10n.css.thumbnails_wrapper_label, info: l10n.css.thumbnails_wrapper_info},
		'.uyoutube-thumbnail': { label: l10n.css.thumbnail_label, info: l10n.css.thumbnail_info }
	},
	cssSelectorsId: 'UyoutubeModel'
});

Upfront.Models.UyoutubeModel = UyoutubeModel;
Upfront.Views.UyoutubeView = UyoutubeView;

}); //End require

})(jQuery);


define('text!elements/upfront-code/css/editor.css',[],function () { return '/* Common */\r\n\r\n.upfront_code-editor {\r\n\tposition: fixed;\r\n\twidth: 100%;\r\n\tcursor: auto;\r\n\tright: 0;\r\n\tbottom: 0;\r\n\tz-index: 99;\r\n\tmin-height: 200px;\r\n\tdisplay: none\r\n}\r\n\r\n.upfront_code-editor button {\r\n\tbackground: #2ecc90;\r\n\tcolor: #fff;\r\n\tposition: absolute;\r\n\tbottom: 10px;\r\n\tright: 25px;\r\n\tpadding: 5px 10px;\r\n\tborder: 0;\r\n\tborder-radius: 0;\r\n\tfont-size: 14px;\r\n\tz-index: 2;\r\n}\r\n.upfront_code-editor button:hover {\r\n\tbackground: #3ea;\r\n}\r\n\r\n.upfront-icon-button.re-edit:before {\r\n\t/*\r\n\tbackground-position: -701px -710px;\r\n\t*/\r\n\tdisplay: none;\r\n}\r\n.upfront-icon-button.re-edit {\r\n\tbackground: #515b65; /* Old browsers */\r\n\tbackground: -moz-linear-gradient(-45deg,  #515b65 47%, #454e56 49%); /* FF3.6+ */\r\n\tbackground: -webkit-gradient(linear, left top, right bottom, color-stop(47%,#515b65), color-stop(49%,#454e56)); /* Chrome,Safari4+ */\r\n\tbackground: -webkit-linear-gradient(-45deg,  #515b65 47%,#454e56 49%); /* Chrome10+,Safari5.1+ */\r\n\tbackground: -o-linear-gradient(-45deg,  #515b65 47%,#454e56 49%); /* Opera 11.10+ */\r\n\tbackground: -ms-linear-gradient(-45deg,  #515b65 47%,#454e56 49%); /* IE10+ */\r\n\tbackground: linear-gradient(135deg,  #515b65 47%,#454e56 49%); /* W3C */\r\n\r\n\tcolor: #97b8da;\r\n\tfont-size: 14px;\r\n\tline-height: 20px;\r\n\ttext-align: center;\r\n}\r\n\r\n/* Simple */\r\n.upfront_code-editor.upfront_code-editor-simple {\r\n\tpadding: 10px;\r\n}\r\n.upfront_code-editor.upfront_code-editor-simple h3 {\r\n\tmargin: 0;\r\n\ttext-transform: none;\r\n}\r\n\r\n.upfront_code-editor-simple textarea {\r\n\tmin-height: 80px;\r\n}\r\n\r\n/* Complex */\r\n.upfront_code-editor.upfront_code-editor-complex textarea {\r\n\tcolor: white;\r\n\tbackground: #454e58;\r\n\tborder: none;\r\n\toutline: none;\r\n}\r\n.upfront_code-editor .upfront_code-editor-complex-wrapper {\r\n\tposition: absolute;\r\n\twidth: 100%;\r\n\tbottom: 0;\r\n\tleft: 0;\r\n\tbackground: #3d5266;\r\n\tmin-height: 200px;\r\n}\r\n\r\n.upfront_code-switches {\r\n\tmargin: 2px 15px 0 20px;\r\n\tfloat: left;\r\n}\r\n\r\n\r\n.upfront_code-switch {\r\n\tcolor: #cbe5ff;\r\n\tfloat: left;\r\n\tpadding: 2px 10px;\r\n\tmargin: 2px 5px 0 0;\r\n\tcursor: pointer;\r\n}\r\n\r\n.upfront_code-switch:hover {\r\n\tcolor: #dae6f2;\r\n\tbackground: #2E3D4C;\r\n}\r\n\r\n.upfront_code-switch.active {\r\n\tbackground: #26333F ;\r\n}\r\n\r\n.upfront_code-jsalert {\r\n\tdisplay: inline-block;\r\n\tmargin: 0 5px 0;\r\n\tpadding: 0 5px;\r\n\tcolor: #444d56;\r\n\tdisplay: none;\r\n\tfloat: left;\r\n}\r\n\r\n.upfront_code-jsalert .upfront-icon-button:before {\r\n\tbackground-position: -480px -205px;\r\n\tmargin-top: 7px;\r\n}\r\n\r\n.upfront_code-editor-section {\r\n\theight: 100%;\r\n}\r\n\r\n.upfront_code-editor.upfront_code-editor-complex .upfront_code-editor-complex-wrapper .upfront_code-editor-section {\r\n\tdisplay: none;\r\n}\r\n.upfront_code-editor.upfront_code-editor-complex .upfront_code-editor-complex-wrapper .upfront_code-editor-section.active {\r\n\tdisplay: block;\r\n}\r\n.upfront_code-editor.upfront_code-editor-complex .handle.ui-resizable-handle.ui-resizable-s {\r\n\ttext-align: center;\r\n\tfont-size: 18px;\r\n\tline-height: 7px;\r\n\tbottom: 5px;\r\n}\r\n\r\n.ace_editor.upfront_code-ace {\r\n\theight: 100%;\r\n\twidth: 100%;\r\n}\r\n\r\n\r\n/* Missing defaults */\r\n.upfront-code_element-module button.embed,\r\n.upfront-code_element-module button.create,\r\n.upfront_code-editor-simple button\r\n{\r\n\tborder: 0;\r\n\tborder-radius: 2px;\r\n\tpadding: 10px 30px;\r\n\tcursor: pointer;\r\n}\r\n.upfront_code-editor-simple textarea {\r\n\twidth: 98%;\r\n}\r\n\r\n/* Image editable */\r\n.upfront-code-editable-image {\r\n\tposition: absolute;\r\n\tdisplay: none;\r\n\tbackground: white;\r\n\tz-index: 999999999999999;\r\n\topacity: 0.75;\r\n\ttext-align: center;\r\n}\r\n\r\n/* Color picker */\r\n.upfront_code-editor .upfront-css-color {\r\n\tdisplay: inline-block;\r\n}\r\n.upfront_code-editor .upfront-css-color .upfront-field-wrap, \r\n.upfront_code-editor .upfront-css-color .upfront-field-wrap label\r\n{\r\n\tmargin: 0;\r\n}\r\n.upfront_code-editor .upfront-css-color .upfront-field-wrap .sp-button-container.sp-cf {\r\n\tposition: absolute;\r\n\tbottom: -48px;\r\n\tright: -15px;\r\n}';});


define('text!elements/upfront-code/tpl/editor.html',[],function () { return '<div>\r\n<!-- Div to select elements inside -->\r\n\r\n<div id="editorTpl">\r\n\t\t<div class="upfront_code-editor-complex-wrapper">\r\n\t\t\t<div class="upfront-css-top">\r\n\t\t\t\t<div class="upfront_code-switches">\r\n\t\t\t\t\t<div class="upfront_code-switch active" data-for="markup">{{ l10n.html }}</div>\r\n\t\t\t\t\t<div class="upfront_code-switch" data-for="style">{{ l10n.css }}</div>\r\n\t\t\t\t\t<div class="upfront_code-switch" data-for="script">{{ l10n.js }}</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<a class="upfront-css-theme_image upfront-css-image" href="#">{{ l10n.link_theme_image }}</a>\r\n\t\t\t\t<a class="upfront-css-media_image upfront-css-image" href="#">{{ l10n.link_image }}</a>\r\n\t\t\t\t<div class="upfront-css-color"></div>\r\n\t\t\t\t<div class="upfront_code-jsalert error javascript"><i class="upfront-icon-button" title="{{ l10n.code_error }}"></i></div>\r\n\t\t\t\t<a class="upfront-css-close" href="#">{{ l10n.close }}</a>\r\n\t\t\t</div>\r\n\t\t\t<div class="upfront-css-body">\r\n\t\t\t\t<div class="upfront_code-editor-section upfront_code-markup active">\r\n\t\t\t\t\t<div class="upfront_code-ace" data-type="markup" >{{markup}}</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class="upfront_code-editor-section upfront_code-style">\r\n\t\t\t\t\t<div class="upfront_code-ace" data-type="style" >{{style}}</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class="upfront_code-editor-section upfront_code-script">\r\n\t\t\t\t\t<div class="upfront_code-ace" data-type="script" >{{script}}</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<button>{{ l10n.save }}</button>\r\n\t\t\t</div>\r\n\t\t</div>\r\n</div>\r\n\r\n<div id="embedTpl">\r\n\t<section class="upfront_code-editor-simple">\r\n\t\t<h3>{{ l10n.paste_your_code }}</h3>\r\n\t\t<textarea class="upfront_code-markup" data-type="markup">{{ markup }}</textarea>\r\n\t\t<button>{{ l10n.save }}</button>\r\n\t</section>\r\n</div>\r\n\r\n</div>';});

(function ($, undefined) {
define('elements/upfront-code/js/syntax',[],function () {

var l10n = Upfront.Settings.l10n.code_element;

var Checker = {

	_promise: false,
	_value: false,
	_message: false,

	set: function (value) {
		this._promise = new $.Deferred();
		this._value = value;
		this._message = false;

		return this._promise.promise();
	},
	reset: function () {
		this.set(false);
	},

	test: function () {
		this._message = false;
		this._promise.notify();
		if (this.validate()) {
			this._promise.resolve();
		} else {
			this._promise.reject(this._message);
		}
	},
	check: function (value) {
		this.set(value);
		var ret = this.validate();
		this.reset();
		return ret;
	},
	validate: function () {
		return true;
	}
};

var Checker_Js = _.extend({}, Checker, {
	validate: function () {
		var ret = true;
		try {
			eval(this._value);
		} catch (e) {
			this._message = e.message;
			ret = false;
		}
		return ret;
	}
});

var Checker_Html = _.extend({}, Checker, {
	validate: function () {
		var ret = true,
			test = this._value.replace(/\r|\n/g, "\n"), // Normalize newlines
			$div = $("<div />")
		;
		$div.html(test);
		
		if ($div.html().length != test.length) {
			this._message = l10n.errors.error_markup;
			ret = false;
		}

		return ret;
	}
});

var Syntax = function () {
	var _types = {
		"markup": "html",
		"style": "css",
		"script": "javascript"
	};
	var _checkers = {
		"markup": _.extend(Checker_Html, {}),
		"script": _.extend(Checker_Js, {})
	};

	var _get_checker = function (syntax) {
		var checker = syntax in _checkers
			? _checkers[syntax]
			: _.extend(Checker, {})
		;
		checker.reset();
		return checker;
	};

	return {
		TYPES: _types,
		checker: _get_checker,
	};
};

return new Syntax();

});
})(jQuery);
;(function ($) {
define('elements/upfront-code/js/views',[
	'text!elements/upfront-code/tpl/editor.html',
	'elements/upfront-code/js/syntax'
], function (tplSource, Syntax) {

	var tpls = $(tplSource);
	var l10n = Upfront.Settings.l10n.code_element;

	var Views = {

		Start: Backbone.View.extend({
			events: {
				"click .embed": "embed_code",
				"click .create": "create_code"
			},
			render: function () {
				this.$el.empty()
					.append(
						'<p class="code-element-choose"><button type="button" class="embed">' + l10n.intro.embed + '</button>' +
						'&nbsp;or&nbsp;' +
						'<button type="button" class="create">' + l10n.intro.code + '</button></p>'
					)
				;
			},
			embed_code: function () {
				this.model.set_property("code_selection_type", "Embed", true);
				this.trigger("code:selection:selected");
			},
			create_code: function () {
				this.model.set_property("code_selection_type", "Create", true);
				this.trigger("code:selection:selected");
			}
		}),

		Create: Upfront.Views.ObjectView.extend({

			is_editing: false,

			MIN_HEIGHT: 200,

			editorTpl: _.template(tpls.find('#editorTpl').html()),

			content_editable_selector: ".editable",

			initialize: function() {
				//var script = this.fallback('script');
				//this.checkJS(script);
			},

			get_content_markup: function () {
				var markup = this.fallback('markup'),
					raw_style = this.fallback('style'),
					script = '(function($){' + this.fallback('script') + '})(jQuery)',
					element_id = this.property('element_id'),
					style = ''
				;

				// Scope the styles!
				if (raw_style) _(raw_style.split("}")).each(function (el, idx) {
					if (!el.length) return true;
					style += '#' + element_id + ' .upfront_code-element ' + el + '}';
				});
				style = Upfront.Util.colors.convert_string_ufc_to_color(style); // Allow for theme colors.

				// Check initial scripts
				if (!Syntax.checker("script").check(script)) {
					script = '';
				}

				return '<div class="upfront_code-element clearfix">' + markup +
					'<style>' + style + '</style>' +
					'<script>' + script + '</script>' +
				'</div>';
			},

			on_render: function () {
				// this.$el.find(".upfront-entity_meta").append('<a href="#" class="upfront-icon-button re-edit">...</a>');
				var me = this;
				// this.$el.find(".upfront-entity_meta .re-edit").on("click", function (e) {
				// 	e.preventDefault();
				// 	me.start_markup_editor();
				// });
				if (
					!this.property('markup') &&
					!this.property('style') &&
					!this.property('script')
				) {
					setTimeout(function () {
						me.start_markup_editor();
					}, 10); // Start in edit mode
				} else {
				// Boot all image editables
					var $editables = this.$el.find('.upfront_code-element ' + this.content_editable_selector);
					if ($editables.length) $editables.each(function (idx) {
						var $me = $(this);
						if ($me.is("img")) me.bootImageEditable($me, idx);
					});

					// Compensate for dead element double-click event
					this.$el.off("dblclick").on("dblclick", function () {
						me.on_edit();
					});
				}
			},

			start_markup_editor: function () {
				if (this.is_editing) return false;

				this.is_editing = true;
				var $editor = $('#upfront_code-editor');

				if(!$editor.length){
					$editor = $('<section id="upfront_code-editor" class="upfront-ui upfront_code-editor upfront_code-editor-complex"></section>');
					$('body').append($editor);
				}

				this.createEditor($editor);

			},

			on_edit: function(){
				if (this.is_editing) return false;

				// Since we're doing double duty here, let's first check if content editing mode is to boot
				var $contenteditables = this.$el.find('.upfront_code-element ' + this.content_editable_selector);
				if ($contenteditables.length) {
					// Yes? go for it
					return this.bootContentEditors($contenteditables);
				}
				// Oh well, let's just go ahead and boot code editing mode.
				this.is_editing = true;
				var $editor = $('#upfront_code-editor');

				if(!$editor.length){
					$editor = $('<section id="upfront_code-editor" class="upfront-ui upfront_code-editor upfront_code-editor-complex"></section>');
					$('body').append($editor);
				}

				this.createEditor($editor);
			},

			bootContentEditors: function ($editables) {
				if (!$editables || !$editables.length) return false;
				var $markup = $(this.fallback("markup")),
					me = this
				;
				$editables.each(function (idx) {
					var $me = $(this),
						start = idx <= 0
					;
					// The editable is an image editable. Deal with that
					if ($me.is("img")) {
						//me.bootImageEditable($me, idx);
						return true;
					}
					if ($me.data('ueditor')) return true;
					$me
						.ueditor({
							autostart: start,
							placeholder: "",
							disableLineBreak: true
						})
						.on("start", function () {
							me.is_editing = true;
						})
						.on("stop", function () {
							me.is_editing = false;
						})
						.on('syncAfter', function(){
							var $existing = $($markup.find(me.content_editable_selector)[idx]);
							if (!$existing.length) return false;
							$existing.html($me.html());
							me.property(
								"markup",
								$("<div />").append($markup).html()
							);
						})
					;
				});
			},

			bootImageEditable: function ($img, idx) {
				var src = $img.attr("src"),
					me = this,
					$markup = $(this.fallback("markup")),
					id_prefix = this.model.get_property_value_by_name("element_id"),
					id = "upfront-editable-" + id_prefix + "-" + idx,
					$root = $('#' + id),
					$all
				;
				if ($root.length) {
					$root.remove();
				}

				$("body").append("<div class='upfront-code-editable-image' id='" + id + "'>" + l10n.create.change + "</div>");
				$root = $('#' + id);

				$all = $img.add($root);
				$all
					.on("mouseenter", function () {
						var offset = $img.offset(),
							width = $img.width(),
							height = $img.height()
						;
						$root
							.width(width)
							.height(height)
							.css({
								top: offset.top,
								left: offset.left,
								"line-height": height + "px"
							})
							.show()
						;
					})
					.on("mouseleave", function (e) {
						if (!$(this).is("img")) $root.hide();
					})
					.on("click", function () {
						$root.hide();
						Upfront.Media.Manager.open({
							multiple_selection: false,
						}).done(function (popup, results) {
							if (results && results.at) {
								var selected = results.at(0).get("image").src,
									$existing = $($markup.find(me.content_editable_selector)[idx])
								;
								$img.attr("src", selected);
								$existing.attr("src", selected);
								me.property(
									"markup",
									$("<div />").append($markup).html()
								);
								Upfront.Events.trigger("upfront:element:edit:stop");
							}
						});
					})
				;
			},

			createEditor: function($editor){
				var me = this;
				$editor.html(this.editorTpl({
					markup: this.fallback('markup'),
					style: this.fallback('style'),
					script: this.fallback('script'),
					l10n: l10n.template
				}));

				$('#page').css('padding-bottom', '200px');
				$editor.show();

				this.resizeHandler = this.resizeHandler || function(){
					$editor.width($(window).width() - $('#sidebar-ui').width() -1);
				};
				$(window).on('resize', this.resizeHandler);
				this.resizeHandler();

				//Start the editors
				this.editors = {};
				this.timers = {};

				$editor.find('.upfront_code-ace').each(function(){
					var $this = $(this),
						html = $this.html(),
						editor = ace.edit(this),
						syntax = $this.data('type'),
						check = Syntax.checker(syntax)
					;

					editor.getSession().setUseWorker(false);
					editor.setTheme("ace/theme/monokai");
					editor.getSession().setMode("ace/mode/" + Syntax.TYPES[syntax]);
					editor.setShowPrintMargin(false);

					if ("markup" === syntax && html)
							editor.getSession().setValue(html);

					// Live update
					editor.on('change', function(){
						if (me.timers[syntax]) clearTimeout(me.timers[syntax]);
						me.timers[syntax] = setTimeout(function(){
							var value = editor.getValue();
							check.set(value)
								.done(function () {
									$editor.find('.upfront_code-jsalert').hide();
									me.property(syntax, value, false); // Only update the property if this is actually decent
								})
								.fail(function (error) {
									$editor.find('.upfront_code-jsalert').show().find('i').attr('title', l10n.errors[syntax] + ' ' + error);
								})
							;
							check.test();

						}, 1000);
					});

					// Set up the proper vscroller width to go along with new change.
					editor.renderer.scrollBar.width = 5;
					editor.renderer.scroller.style.right = "5px";

					me.editors[syntax] = editor;
				});
				this.currentEditor = this.editors['markup'];

				var editorTop = $editor.find('.upfront-css-top'),
					editorBody = $editor.find('.upfront-css-body')
				;
				
				//Enable only height resize
				editorTop
					.removeClass("ui-resizable-handle").addClass("ui-resizable-handle")
					.removeClass("ui-resizable-n").addClass("ui-resizable-n")
				;

				//Start resizable
				editorBody.height(this.MIN_HEIGHT - editorTop.outerHeight());
				$editor.find(".upfront_code-editor-complex-wrapper").resizable({
					handles: {
						n: ".upfront-css-top"
					},
					resize: function(e, ui){
						editorBody.height(ui.size.height - editorTop.outerHeight());
						_.each(me.editors, function(editor){
							editor.resize();
						});
					},
					minHeight: me.MIN_HEIGHT,
					delay:  100
				});

				//switch tabs
				$editor.find(".upfront_code-switch").on('click', function(e){
					var tab = $(e.target),
						syntax = tab.data('for')
					;
					$editor.find('.active').removeClass('active');
					tab.addClass('active');
					$editor.find('.upfront_code-' + syntax).addClass('active');
					me.editors[syntax].resize();
					me.currentEditor = me.editors[syntax];

					if(syntax == 'script')
						$editor.find('upfront-css-image').hide();
					else
						$editor.find('upfront-css-image').show();

				});

				//save edition
				$editor.find('button').on('click', function(e){
					_.each(me.editors, function(editor, type){
						var value = editor.getValue();
						if (Syntax.checker(type).check(value)) me.property(type, value);
						else me.property(type, me.fallback(type));
					});

					me.$("section.upfront_code-element").replaceWith(me.get_content_markup()).end();
					me.is_editing = false;
					me.destroyEditor();
				});

				//Highlight element
				$editor
					.on('click', '.upfront-css-type', function(e){
						me.hiliteElement(e);
					}) // Close editor
					.on('click', '.upfront-css-close', function(e){
						e.preventDefault();
						me.destroyEditor();
						$('#page').css('padding-bottom', 0);
					})
				;

				this.prepareSpectrum($editor);

				//Prepare image picker
				$editor
					.on('click', '.upfront-css-theme_image', _.bind(this.open_theme_image_picker, this))
					.on('click', '.upfront-css-media_image', _.bind(this.open_media_image_picker, this))
				;
			},

			prepareSpectrum: function ($editor) {
				var me = this,
					fld = new Upfront.Views.Editor.Field.Color({
						blank_alpha: 0,
						default_value: '#ffffff',
						flat: true,
						showAlpha: true,
						appendTo: "parent",
						showPalette: true,
						maxSelectionSize: 10,
						preferredFormat: "hex",
						chooseText: l10n.create.ok,
						showInput: true,
						allowEmpty: true,
						spectrum: {
							choose: function(color) {
								var colorString = color.get_is_theme_color()
									? color.theme_color
									: (color.alpha < 1 ? color.toRgbString() : color.toHexString())
								;
								me.currentEditor.insert(colorString);
								me.currentEditor.focus();
							}
						}
					})
				;
				fld.render();
				$editor.find(".upfront-css-color").empty().append(fld.$el);
			},

			open_theme_image_picker: function () {
				return this._open_image_picker({themeImages: true});
			},
			open_media_image_picker: function () {
				return this._open_image_picker();
			},

			_open_image_picker: function (opts) {
				opts = _.isObject(opts) ? opts : {};
				var me = this,
					options = _.extend({
						multiple_selection: false,
						media_type:['images']
					}, opts),
					currentSyntax = $('#upfront_code-editor').find('.upfront_code-switch.active').data('for')
				;

				Upfront.Media.Manager.open(options).done(function(popup, result){
					Upfront.Events.trigger('upfront:element:edit:stop');
					if (!result) return false;

					var imageModel = result.models[0],
						img = imageModel.get('image') ? imageModel.get('image') : result.models[0],
						url = 'src' in img ? img.src : ('get' in img ? img.get('original_url') : false)
					;
					if (!url) return false;

					//url = url.replace(document.location.origin, ''); // Let's not do this

					if('style' === currentSyntax) {
						me.currentEditor.insert('url("' + url + '")');
					} else if ('markup' === currentSyntax) {
						//Add the selected size
						var urlParts = url.split('.'),
							ext = urlParts[urlParts.length - 1],
							size = imageModel.get('selected_size')
						;
						if (size && size != 'full') {
							url = url.replace(new RegExp('.' + ext + '$'), '-' + size + '.' + ext);
						}

						me.currentEditor.insert('<img src="' + url + '">');
					}

					me.currentEditor.focus();
				});

			},

			destroyEditor: function(){
				var me = this;
				if(this.editors && this.editors.length){
					_.each(this.editors, function(ed){
						ed.destroy();
					});
					me.editors = false;
				}
				this.currentEditor = false;
				$('#upfront_code-editor').html('').hide();
				$(window).off('resize', this.resizeHandler);
				this.is_editing = false;
			},

			hiliteElement: function(e){
				e.preventDefault();
				var element = this.$el.find('.upfront-object-content');
				var offset = element.offset().top - 50;
				$(document).scrollTop(offset > 0 ? offset : 0);
				this.blink(element, 4);
			},

			blink: function(element, times) {
				var me = this;
				element.css('outline', '3px solid #3ea');
				setTimeout(function(){
					element.css('outline', 'none');

					times--;
					if(times > 0){
						setTimeout(function(){
							me.blink(element, times - 1);
						}, 100);
					}

				}, 100);
			},

			fallback: function(attribute){
				return this.model.get_property_value_by_name(attribute) || Upfront.data.upfront_code.defaults.fallbacks[attribute];
			},

			property: function(name, value, silent) {
				if ("undefined" != typeof value) {
					if ("undefined" == typeof silent) silent = true;
					return this.model.set_property(name, value, silent);
				}
				return this.model.get_property_value_by_name(name);
			},

			getControlItems: function(){
				return _([
					this.createPaddingControl(),
					this.createControl('edit', l10n.edit, 'start_markup_editor')
				]);
			}
		}),

		Embed: Upfront.Views.ObjectView.extend({

			is_editing: false,
			tpl: _.template(tpls.find('#embedTpl').html()),

			get_content_markup: function () {
				var markup = this.fallback('markup'),
					element_id = this.model.get_property_value_by_name('element_id')
				;
				return '<section class="upfront_code-element clearfix">' + markup + '</section>';
			},

			update_property: function (model) {
				var $area = $(this),
					type = $area.attr("data-type"),
					value = $area.val()
				;
				model.set_property(type, value, true);
			},

			on_render: function () {
				// this.$el.find(".upfront-entity_meta").append('<a href="#" class="upfront-icon-button re-edit">...</a>');
				var me = this;
				// this.$el.find(".upfront-entity_meta .re-edit").on("click", function (e) {
				// 	e.preventDefault();
				// 	me.on_edit();
				// });
				if (!this.model.get_property_value_by_name('markup')) {
					setTimeout(function () {
						me.on_edit();
					}, 10); // Start in edit mode
				}
			},

			on_edit: function () {
				if (this.is_editing)
					return false;

				this.is_editing = true;

				var me = this,
					$module = this.$el.parents(".upfront-module")
				;
				this.$el
					.find("section.upfront_code-element").hide().end()
					.append(this.tpl({markup: this.fallback('markup'), l10n: l10n.template}))
				;

				this.$el
					.find("textarea")
						.on("keyup change", function () {
							me.update_property.apply(this, [me.model]);
						})
						.on("focus click", function () {
							$module.draggable("disable")
						})
						.focus()
					.end()
					.find("button").on("click", function () {
						me.$el.find("pre code").each(function () {
							me.update_property.apply(this, [me.model]);
						});
						me.$el
							.find("section.upfront_code-element").replaceWith(me.get_content_markup()).end()
							.find("section.upfront_code-editor-simple").remove()
						;
						me.is_editing = false;
						me.trigger("code:model:updated");
					})
				;
			},
			fallback: function(attribute){
				return this.model.get_property_value_by_name(attribute) || Upfront.data.upfront_code.defaults.fallbacks[attribute];
			},

			getControlItems: function(){
				return _([
					this.createPaddingControl(),
					this.createControl('edit', l10n.edit, 'on_edit')
				]);
			}
		})
	};

	return Views;
});
})(jQuery);
define('elements/upfront-code/js/model',[],function () {
	var Model = Upfront.Models.ObjectModel.extend({
		init: function () {
			var properties = _.clone(Upfront.data.upfront_code.defaults);
			properties.element_id = Upfront.Util.get_unique_id(properties.id_slug + '-object');
			this.init_properties(properties);
		}
	});
	return Model;
});
define('elements/upfront-code/js/element',[
	'elements/upfront-code/js/model',
], function (CodeModel) {
	var l10n = Upfront.Settings.l10n.code_element;
	var Element = Upfront.Views.Editor.Sidebar.Element.extend({
		priority: 120,

		render: function () {
			this.$el.addClass('upfront-icon-element upfront-icon-element-code');
			this.$el.html(l10n.element_name);
		},

		add_element: function () {

			var object = new CodeModel(),
				module = new Upfront.Models.Module({
					name: "",
					properties: [
						{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
						{"name": "class", "value": "c24 upfront-code_element-module"},
						{"name": "has_settings", "value": 0},
						{"name": "row", "value": Upfront.Util.height_to_row(210)}
					],
					objects: [object]
				})
			;
			this.add_module(module);
		}
	});

	return Element;
});
;(function ($, undefined) {
define('upfront_code',[
	'text!elements/upfront-code/css/editor.css',
	'elements/upfront-code/js/views',
	'elements/upfront-code/js/model',
	'elements/upfront-code/js/element'
], function (style, Views, CodeModel, CodeElement) {

$("head").append('<style>' + style + '</style>');

var l10n = Upfront.Settings.l10n.code_element;

var CodeView = Upfront.Views.ObjectView.extend({

	on_render: function () {
		var type = this.model.get_property_value_by_name("code_selection_type"),
			me = this,
			view = false
		;
		this.$el.empty().append("Loading...");
		require([
			Upfront.Settings.ace_url
		], function () {
			if (!type) view = me.render_initial_view();
			else view = me.render_code_view();
		});
		if (!this.parent_module_view.$el.data("dragHandler")) {
			this.parent_module_view.$el.on('dragstart', this.cover_iframes);
			this.parent_module_view.$el.data("dragHandler", true);
		}
	},

	cover_iframes: function (e, ui) {
		ui.helper.append('<div class="upfront-iframe-draggable" style="width:100%;height:100%;position:absolute;top:0;left:0:z-index:1"></div>');
	},

	render_initial_view: function () {
		var view = new Views.Start({
			model: this.model
		});
		view.render();

		view.parent_view = this.parent_view;
		view.parent_module_view = this.parent_module_view;

		view.on("code:selection:selected", this.render_code_view, this);
		this.$el.empty().append(view.$el);
		return view;
	},

	render_code_view: function () {
		var type = this.model.get_property_value_by_name("code_selection_type");
		if (!type) {
			Upfront.Util.log("Missing type");
			return this.render_initial_view();
		}
		var view = new Views[type]({
			model: this.model
		});

		view.parent_view = this.parent_view;
		view.parent_module_view = this.parent_module_view;
		view.render();

		view.on("code:model:updated", this.propagate_model_update, this);
		this.$el.empty().append(view.$el);

		// Dynamically bind settings click to view editing action
		if (view.on_edit) {
			this.on_settings_click = function () {
				return view.on_edit();
			}
		}

		return view;
	},

	/**
	 * Override and intercept settings click.
	 *
	 * See CodeView::render_code_view() for how it's manipulated when a view is instantiated.
	 */
	on_settings_click: function () {
		// noop
	},

	propagate_model_update: function () {
		Upfront.Events.trigger("upfront:element:edit:stop");
	}
});


Upfront.Application.LayoutEditor.add_object("Code", {
	"Model": CodeModel,
	"View": CodeView,
	"Element": CodeElement,
	//"Settings": CodeSettings
});
Upfront.Models.CodeModel = CodeModel;
Upfront.Views.CodeView = CodeView;

});
})(jQuery);

(function ($) {

define('uspacer',[
	"text!upfront/templates/object.html"
], function (object_template) {
	var l10n = Upfront.Settings.l10n.spacer_element;

	var UspacerModel = Upfront.Models.ObjectModel.extend({
		init: function () {
			this.init_property("type", "UspacerModel");
			this.init_property("view_class", "UspacerView");
			this.init_property("element_id", Upfront.Util.get_unique_id("spacer-object"));
			this.init_property("class", "c24");
			this.init_property("has_settings", 0);
			this.init_property("id_slug", "uspacer");
		}
	});

	var UspacerView = Upfront.Views.ObjectView.extend({
		className: 'upfront-spacer',
		display_size_hint: false,
		get_content_markup: function () {
			return "";
		},
		init: function () {
			this.listenTo(Upfront.Events, 'upfront:wrappers:before_fix_height', this.before_apply_height_from_wrapper);
			this.listenTo(Upfront.Events, 'upfront:wrappers:after_fix_height', this.apply_height_from_wrapper);
		},
		render: function () {
			var props = {},
				me = this,
				column_padding = Upfront.Settings.LayoutEditor.Grid.column_padding,
				model, template
			;
			// Force add upfront-object-view class as element object can override the view and left without this class
			this.$el.addClass('upfront-object-view');

			this.model.get("properties").each(function (prop) {
				props[prop.get("name")] = prop.get("value");
			});

			props.preset = props.preset || '';

			model = _.extend(this.model.toJSON(), {
				"properties": props,
				"buttons": "",
				"content": "",
				"height": 0,
				"extra_buttons": ""
			});
			template = _.template(object_template, model);

			Upfront.Events.trigger("entity:object:before_render", this, this.model);
			// Listen to module resize and drop event
			if (this.parent_module_view) {
				this.stopListening((this._previous_parent_module_view || this.parent_module_view), 'entity:resize_start');
				this.listenTo(this.parent_module_view, 'entity:resize_start', this.on_element_resize_start);
				this.stopListening((this._previous_parent_module_view || this.parent_module_view), 'entity:resizing');
				this.listenTo(this.parent_module_view, 'entity:resizing', this.on_element_resizing);
				this.stopListening((this._previous_parent_module_view || this.parent_module_view), 'entity:resize_stop');
				this.listenTo(this.parent_module_view, 'entity:resize_stop', this.on_element_resize);

				this.stopListening((this._previous_parent_module_view || this.parent_module_view), 'entity:drop');
				this.listenTo(this.parent_module_view, 'entity:drop', this.on_element_drop);

				// Make sure module class is added
				this.parent_module_view.$el.find('> .upfront-module').addClass('upfront-module-spacer');
				this.parent_module_view.model.add_class('upfront-module-spacer');
			}

			this.$el.html(template);

			Upfront.Events.trigger("entity:object:after_render", this, this.model);
		},
		// Don't have any controls
		getControlItems: function () {
			return _([]);
		},
		createControls: function () {
			return false;
		},
		apply_paddings: function () {
			return false;
		},
		before_apply_height_from_wrapper: function (from_view) {
			if (!this.parent_module_view || !this.parent_module_view.parent_view || this.parent_module_view.parent_view != from_view) return;
			if (!this.$el.is(':visible')) return;
			var $wrap = this.$el.closest('.upfront-wrapper');
			$wrap.addClass('upfront-wrapper-spacer');
			this.$el.find('>.upfront-object').css('min-height', '');
		},
		apply_height_from_wrapper: function (from_view) {
			if (!this.parent_module_view || !this.parent_module_view.parent_view || this.parent_module_view.parent_view != from_view) return;
			if (!this.$el.is(':visible')) return;
			var $wrap = this.$el.closest('.upfront-wrapper');
			this.$el.find('>.upfront-object').css('min-height', $wrap.height());
		}
	});

	Upfront.Models.UspacerModel = UspacerModel;
	Upfront.Views.UspacerView = UspacerView;
});

})(jQuery);

(function ($) {

define('application',['models', 'views', 'editor_views', 'behaviors', 'upfront-data', 'jquery-df', 'jquery-simulate', 'scripts/backbone-query-parameters/backbone-query-parameters', 'responsive', 'findandreplace'], function (models, views, editor, behaviors, data, findandreplace) {
  _.extend(Upfront, data);
  Upfront.Events.trigger('data:ready');
  _.extend(Upfront, models);
  _.extend(Upfront, views);
  _.extend(Upfront.Views, editor);
  _.extend(Upfront, behaviors);

var Subapplication = Backbone.Router.extend({
	start: function () {
		Upfront.Util.log("Implement runner method");
	},

	go: function (frag) {
		Upfront.Events.trigger("subapplication:navigate:" + frag);
		return this.navigate(frag);
	},

	get_layout_data: function() {
		var data = Upfront.Util.model_to_json(this.layout);
		data.layout = _upfront_post_data.layout;
		return data;
	}
});

var LayoutEditorSubapplication = Subapplication.extend({
	save_layout_as: function () {
		Upfront.Behaviors.LayoutEditor.save_dialog(this._save_layout, this);
	},

	save_layout: function () {
		this._save_layout(this.layout.get("current_layout"));
	},

	publish_layout: function () {
		this._save_layout(this.layout.get("current_layout"), true);
	},

	_save_layout: function (preferred_layout, publish) {
		var data = Upfront.Util.model_to_json(this.layout),
			storage_key = publish === true ? _upfront_storage_key : _upfront_save_storage_key;
		data.layout = _upfront_post_data.layout;
		data.preferred_layout = preferred_layout;
		data = JSON.stringify(data, undefined, 2);

		Upfront.Events.trigger("command:layout:save_start");

		if (Upfront.Settings.Application.NO_SAVE) {
			Upfront.Events.trigger("command:layout:save_success");
			return false;
		}
		data = Upfront.Util.colors.update_colors_to_match_ufc(data);
		Upfront.Util.post({"action": Upfront.Application.actions.save, "data": data, "storage_key": storage_key})
			.success(function () {
				Upfront.Util.log("layout saved");
				Upfront.Events.trigger("command:layout:save_success");
			})
			.error(function () {
				Upfront.Util.log("error saving layout");
				Upfront.Events.trigger("command:layout:save_error");
			})
		;
	},

	preview_layout: function () {
		var preview = false,
			url = false
		;
		url = Upfront.PreviewUpdate.preview_url();
		if (!url) {
			Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.application.preview_not_ready);
			return false;
		}
		preview = window.open(url, "_blank");
	},

	list_revisions: function () {
		var data = {
			action: "upfront_list_revisions",
			cascade:  _upfront_post_data.layout,
			current_url: window.location.href
		};
		Upfront.Util.post(data)
			.done(function (resp) {
				Upfront.Popup.open(function () {
					var tpl = _.template(
						'<h3>' + Upfront.Settings.l10n.global.application.revisions + '</h3><ul>{[ _.each(data, function (item) { ]}' +
							'<li><a target="_blank" href="{{item.preview_url}}">{{item.date_created}}</a><br /><small>' +  Upfront.Settings.l10n.global.application.created_by + ' {{item.created_by.display_name}}</small></li>' +
						'{[ }); ]}</ul>'
					);
					$(this).html(tpl(resp));
				});
			})
			.error(function (resp) {
				console.log(resp);
			})
		;
	},

	destroy_editor: function () {
		this.navigate("");
		window.location.reload();
		return false;
	},

	set_up_editor_interface: function () {
		if (!this.layout) return false;
		var app = this;

		var _set_up_draggables = function () {
			var elements = [];
			_(app.Objects).each(function (obj, idx) {
				if ( obj.Element ) {
					var el = new obj.Element({"model": app.layout});
					el.element_type = idx;
					elements.push(el);
				}
				if ( obj.Command )
					app.sidebar.get_commands("control").commands.push(new obj.Command({"model": app.layout}));
			});
			Upfront.Application.sidebar.get_panel("elements").elements = _(_.sortBy(elements, function(element){
				return element.priority;
			}));
			Upfront.Application.sidebar.render();
		};
		_set_up_draggables();
		//this.listenTo(Upfront.Events, "elements:requirements:async:added", _set_up_draggables); // Deprecated
	},

	add_object: function (name, data) {
		this.Objects[name] = _.extend({}, Upfront.Mixins.Anchorable, data);
	},


	set_up_event_plumbing_before_render: function () {
		// Set up behavior
		this.listenTo(Upfront.Events, "entity:module:after_render", Upfront.Behaviors.GridEditor.create_resizable);
		this.listenTo(Upfront.Events, "entity:module:after_render", Upfront.Behaviors.GridEditor.create_draggable);
		this.listenTo(Upfront.Events, "entity:module_group:after_render", Upfront.Behaviors.GridEditor.create_resizable);
		this.listenTo(Upfront.Events, "entity:module_group:after_render", Upfront.Behaviors.GridEditor.create_draggable);
		this.listenTo(Upfront.Events, "entity:wrapper:after_render", Upfront.Behaviors.GridEditor.create_wrapper_resizable);
		// Enable resizables and draggables
		//Upfront.Behaviors.GridEditor.toggle_resizables(true);
		//Upfront.Behaviors.GridEditor.toggle_draggables(true);

		this.listenTo(Upfront.Events, "entity:region:after_render", Upfront.Behaviors.GridEditor.create_region_resizable);
		this.listenTo(Upfront.Events, "entity:region:after_render", Upfront.Behaviors.GridEditor.create_region_draggable);
		this.listenTo(Upfront.Events, "entity:region_container:after_render", Upfront.Behaviors.LayoutEditor.create_mergeable);
		this.listenTo(Upfront.Events, "entity:region_container:after_render", Upfront.Behaviors.GridEditor.create_region_container_resizable);
		this.listenTo(Upfront.Events, "entity:region_sub_container:after_render", Upfront.Behaviors.GridEditor.create_region_container_resizable);

		if ( !Upfront.Behaviors.GridEditor.grid ) {
			Upfront.Behaviors.GridEditor.init();
		}
		this.listenTo(Upfront.Events, "layout:after_render", Upfront.Behaviors.GridEditor.init);
	},

	set_up_event_plumbing_after_render: function () {
		// Set up properties
		//this.listenTo(Upfront.Events, "entity:activated", this.create_properties);
		//this.listenTo(Upfront.Events, "entity:deactivated", this.destroy_properties);

		// Layout manipulation
		this.listenTo(Upfront.Events, "command:exit", this.destroy_editor);
		this.listenTo(Upfront.Events, "command:layout:save", this.save_layout);
		this.listenTo(Upfront.Events, "command:layout:save_as", this.save_layout_as);
		this.listenTo(Upfront.Events, "command:layout:preview", this.preview_layout);
		this.listenTo(Upfront.Events, "command:layout:publish", this.publish_layout);

		// Region
		this.listenTo(Upfront.Events, "command:region:edit_toggle", Upfront.Behaviors.GridEditor.toggle_region_resizable);
		this.listenTo(Upfront.Events, "command:region:fixed_edit_toggle", Upfront.Behaviors.GridEditor.toggle_region_resizable);
		this.listenTo(Upfront.Events, "command:region:fixed_edit_toggle", Upfront.Behaviors.GridEditor.toggle_region_draggable);

		// Selection
		this.listenTo(Upfront.Events, "command:selection:remove", Upfront.Behaviors.LayoutEditor.remove_selections);

		// Undo / Redo
		this.listenTo(Upfront.Events, "entity:activated", Upfront.Behaviors.LayoutEditor.create_undo);
		this.listenTo(Upfront.Events, "entity:resize_start", Upfront.Behaviors.LayoutEditor.create_undo);
		this.listenTo(Upfront.Events, "entity:drag_start", Upfront.Behaviors.LayoutEditor.create_undo);
		this.listenTo(Upfront.Events, "entity:removed:before", Upfront.Behaviors.LayoutEditor.create_undo);
		this.listenTo(Upfront.Events, "entity:region:activated", Upfront.Behaviors.LayoutEditor.create_undo);

		this.listenTo(Upfront.Events, "command:undo", Upfront.Behaviors.LayoutEditor.apply_history_change);
		this.listenTo(Upfront.Events, "command:redo", Upfront.Behaviors.LayoutEditor.apply_history_change);

		// Set up entity settings (modules, for now)
		this.listenTo(Upfront.Events, "entity:settings:activate", this.create_settings);
		this.listenTo(Upfront.Events, "entity:settings:deactivate", this.destroy_settings);
		this.listenTo(Upfront.Events, "entity:removed:after", this.destroy_settings);

		// Set up entity context menu
		this.listenTo(Upfront.Events, "entity:contextmenu:activate", this.create_menu);
		this.listenTo(Upfront.Events, "entity:contextmenu:deactivate", this.destroy_menu);
		//this.listenTo(Upfront.Events, "entity:removed:after", this.destroy_settings);

		//this.layout_views.listenTo(Upfront.Events, "upfront:posts:post:post_updated", this.layout_view.render);

		// Showing the "busy" overlay on saving.
		var loading = false,
			start = function () {
				loading = new Upfront.Views.Editor.Loading({
					loading: Upfront.Settings.l10n.global.application.saving,
					done: Upfront.Settings.l10n.global.application.saving_success,
					fixed: true
				});
				loading.render();
				$('body').append(loading.$el);
			},
			stop = function (success) {
				if (!success) {
					loading.update_loading_text(Upfront.Settings.l10n.global.application.saving_error);
				}
				loading.on_finish(function(){
					Upfront.Events.trigger("command:layout:save_done", success);
				});
				if (!success) {
					loading.done(false, Upfront.Settings.l10n.global.application.saving_error);
				} else {
					loading.done();
				}
			}
		;
		this.listenTo(Upfront.Events, "command:layout:save_start", start);
		this.listenTo(Upfront.Events, "command:layout:save_success", function(){ stop(true); });
		this.listenTo(Upfront.Events, "command:layout:save_error", function(){ stop(false); });
		this.listenTo(Upfront.Events, "command:themefontsmanager:open", Upfront.Behaviors.LayoutEditor.open_theme_fonts_manager);
		this.listenTo(Upfront.Events, "command:layout:edit_global_regions", Upfront.Behaviors.LayoutEditor.open_global_region_manager);

		this.listenTo(Upfront.Events, "command:layout:save_success", Upfront.Behaviors.LayoutEditor.clean_region_css);
		this.listenTo(Upfront.Events, "command:layout:save_success", Upfront.Behaviors.LayoutEditor.clean_global_regions);
	},

	create_properties: function (view, model) {
		this.property_view = new Upfront.Views.Editor.Properties({
			"model": model,
			"el": $(Upfront.Settings.LayoutEditor.Selectors.properties)
		});
		this.property_view.render();
	},

	destroy_properties: function () {
		$(Upfront.Settings.LayoutEditor.Selectors.properties).html('');
	},

	create_menu: function( view ) {

		var current_object = _(this.Objects).reduce(function (obj, current) {
				return (view instanceof current.View) ? current : obj;
			}, false),
			current_object = (current_object && current_object.ContextMenu ? current_object : Upfront.Views.ContextMenu);
			if(current_object.ContextMenu === false)
				return false;
			else if (typeof current_object.ContextMenu == 'undefined')
				current_object.ContextMenu = Upfront.Views.ContextMenu;

        var context_menu_view = new current_object.ContextMenu({
            model: view.model,
            for_view: view,
            el: $(Upfront.Settings.LayoutEditor.Selectors.contextmenu)
        })
		;

		context_menu_view.for_view = view;
		context_menu_view.render();
		this.context_menu_view = context_menu_view;

	},
	destroy_menu: function () {
		if (!this.context_menu_view) return false;
		$(Upfront.Settings.LayoutEditor.Selectors.contextmenu).html('').hide();
		this.context_menu_view = false;

		//context_menu_view.trigger('closed');
	},
	create_settings: function (view, settings_obj_view) {
		var current_object, settings_view;

		if (this.settings_view) return this.destroy_settings();

		if (!parseInt(view.model.get_property_value_by_name("has_settings"), 10)) return false;

		if ( !settings_obj_view ) {
			current_object = _(this.Objects).reduce(function (obj, current) {
				if(view instanceof current.View){
					return current;
				}
				return obj;
			}, false);
			current_object = (current_object && current_object.Settings ? current_object : Upfront.Views.Editor.Settings);
			settings_obj_view = current_object.Settings;
		}

		settings_view = new settings_obj_view({
			model: view.model,
			anchor: ( current_object ? current_object.anchor : false ),
			el: $(Upfront.Settings.LayoutEditor.Selectors.settings)
		});
		settings_view.for_view = view;
		settings_view.render();
		this.settings_view = settings_view;
		settings_view.trigger('rendered');
	},

	destroy_settings: function () {
		if (!this.settings_view) return false;

		this.settings_view.trigger('closed');

		this.settings_view.remove();
		this.settings_view = false;

		//Restore the settings div
		$('body').append('<div id="settings"/>');
	},

	create_post: function(postType){
		Upfront.Settings.LayoutEditor.newpostType = postType;
		this.load_layout({item: 'single-' + postType, type: 'single'});
	},

	openLightboxRegion: function(regionName){
		var regions = Upfront.Application.layout.get('regions'),
			region = regions.get_by_name(regionName)
		;

		if(!region)
			return;

		//hide other lightboxes
		_.each(regions.models, function(model) {
			if(model.attributes.sub == 'lightbox')
				Upfront.data.region_views[model.cid].hide();
		});

		Upfront.data.region_views[region.cid].show();
	},
	getLightboxSafeName: function(regionName) {
		var regions = (this.layout && this.layout.get ? this.layout.get('regions') : Upfront.Application.current_subapplication.layout.get('regions')),
			region = regions ? regions.get_by_name('lightbox') : false;

		if ( ! region ){
			region = new Upfront.Models.Region({
				"name": "lightbox",
				"container": "lightbox",
				"title": "lightbox Region"
			});
			region.add_to(regions, regions.length-1);
		}

		return 'ltb-' + regionName.toLowerCase().replace(/\s/g, '-') + (regions.length+1);
	},
	createLightboxRegion: function(regionName){

		var regions = (this.layout && this.layout.get ? this.layout.get('regions') : Upfront.Application.current_subapplication.layout.get('regions'));
		//	region = regions ? regions.get_by_name('lightbox') : false;

		/*if ( ! region ){
			region = new Upfront.Models.Region({
				"name": "lightbox",
				"container": "lightbox",
				"title": "lightbox Region"
			});
			region.add_to(regions, regions.length-1);
		}*/

		var	safeName = this.getLightboxSafeName(regionName),
			lightbox = new Upfront.Models.Region(_.extend({}, Upfront.data.region_default_args, {
				name: safeName,
				container: 'lightbox',
				title: regionName,
				type: 'lightbox',
				sub: 'lightbox'
			}))
		;

		lightbox.init_properties({
			col: 10,
			height: 400,
			click_out_close: 'yes',
			show_close: 'yes',
			overlay_color: 'rgba(38,58,77,0.75)',
			lightbox_color: 'rgba(248,254,255,0.9)'
		});

		//Wait for the region view to be added and open it
		this.listenToOnce(Upfront.Events, 'entity:region:added', this.openNewRegion);
		lightbox.add_to(regions, regions.length-1, {sub: 'lightbox'});

		return safeName;
	},

	openNewRegion: function(region){
		if(region.show){
			region.show();
			region.on_settings_click();
		}
	}
});

var LayoutEditor = new (LayoutEditorSubapplication.extend({
	Objects: {},

	boot: function () {

	},

	start: function () {
		this.stop();
		this.set_up_event_plumbing_before_render();
		this.set_up_editor_interface();

		this.set_up_event_plumbing_after_render();
		$("html").removeClass("upfront-edit-content upfront-edit-theme upfront-edit-postlayout upfront-edit-responsive").addClass("upfront-edit-layout");
	},

	stop: function () {
		return this.stopListening(Upfront.Events);
	}

}))();

var PostLayoutEditor = new (LayoutEditorSubapplication.extend({
	initialize: function(){
		this.listenTo(Upfront.Events, 'post:layout:edit', this.togglePostLayoutEditorMode);
	},
	boot: function () {
		Upfront.Util.log("Preparing postlayout mode for execution");
		this.started = 0;
	},

	start: function () {
		if(this.started)
			return;

		this.started = 1;

		this.Objects = Upfront.Application.LayoutEditor.Objects;

		Upfront.Util.log("Starting the postlayout edit mode");

		this.set_up_event_plumbing_before_render();

		this.prepareSidebar();

		this.listenTo(Upfront.Events, "post:layout:cancel", this.cancelEdition);
		this.listenTo(Upfront.Events, "post:layout:save", this.saveEdition);
		this.listenTo(Upfront.Events, "post:edit:templatepart", this.editTemplatePart);

		$("html").removeClass("upfront-edit-layout upfront-edit-theme upfront-edit-content").addClass("upfront-edit-postlayout");

		this.prepareViews();

		this.set_up_event_plumbing_after_render();
	},

	stop: function () {
		var sidebar = Application.sidebar;
		//Upfront.Util.log("Stopping the postlayout edit mode");

		this.restoreSidebar();
		this.restoreViews();

		this.started = 0;

		this.stopListening(Upfront.Events);
		this.listenTo(Upfront.Events, 'post:layout:edit', this.togglePostLayoutEditorMode);
	},

	cancelEdition: function(){
        if( Upfront.Application.is_post_content_style() ) return;

		//Gagan: The code inside the following if, is to accomodate the posts element
		var me = this;
		if(typeof(this.postwrapperclone) != 'undefined' && this.postwrapperclone) {
			this.postWrapper.find('.post_editor_container').css('display', '');
			this.postwrapperclone.find('.post_editor_container').each(function() {
				me.postWrapper.find('.upfront-object-content').append($(this));
			});

			this.postwrapperclone.remove();

		}

		if(Application.current_subapplication != PostLayoutEditor)
			return;
		Application.start(Application.mode.last);
	},

	saveEdition: function(){
		if(Application.current_subapplication != PostLayoutEditor)
			return;
		var me = this,
			saveDialog = new Upfront.Views.Editor.SaveDialog({
				question: Upfront.Settings.l10n.global.application.save_layout_pop,
				thisPostButton: Upfront.Settings.l10n.global.application.this_post_only,
				allPostsButton: Upfront.Settings.l10n.global.application.all_posts_of_this_type
			})
		;

		saveDialog
			.render()
			.on('closed', function(){
				saveDialog.remove();
				saveDialog = false;
			})
		;

		saveDialog.on('save', function(type){

			var elementType = me.postView.property('type');
			var specificity;
					elementSlug = elementType == 'ThisPostModel' ? 'single' : 'archive',
					loading = new Upfront.Views.Editor.Loading({
						loading: Upfront.Settings.l10n.global.application.saving_post_layout,
						done: Upfront.Settings.l10n.global.application.thank_you_for_waiting,
						fixed: false
					})

				;
				if(elementSlug == 'single')
					specificity = type == 'this-post' ? me.postView.postId : me.postView.editor.post.get('post_type');
				else
					specificity = type == 'this-post' ? me.postView.property('element_id').replace('uposts-object-','') : me.postView.property('post_type');


				console.log(type);

				var layoutData = {
					postLayout: me.exportPostLayout(),
					partOptions: me.postView.partOptions || {}
				}

				loading.render();
				saveDialog.$('#upfront-save-dialog').append(loading.$el);

				Upfront.Util.post({
					action: 'upfront_save_postlayout',
					layoutData: layoutData,
					cascade: elementSlug + '-' + specificity
				}).done(function(response){
					loading.done();
					console.log(response);
					saveDialog.close();

					me.postView.postLayout = layoutData.postLayout;

					me.postView.render();

					Application.start(Application.mode.last);
				});

		});


	},

	exportPostLayout: function(){
		var me = this,
			regionLayout = Upfront.Util.model_to_json(this.regionView.model),
			wrappers = regionLayout.wrappers,
			modules = regionLayout.modules,
			wrapperIds = {},
			layout = []
		;

		_.each(modules, function(m){
			var props = me.propertiesToObject(m.properties),
				object = {classes: props['class']},
				wrapper = wrapperIds[props.wrapper_id]
			;

			_.each(m.objects, function(o){
				object.slug = me.propertiesToObject(o.properties).postPart;
			});

			if (wrapper) {
				wrapper.objects.push(object);
				//wrapper.objects = [object];
			} else {
				wrapper = {objects: [object]};
				layout.push(wrapper);
				wrapperIds[props.wrapper_id] = wrapper;
			}
		});

		_.each(wrappers, function(w){
			var props = me.propertiesToObject(w.properties),
				wrapper = wrapperIds[props.wrapper_id]
			;
			if(wrapper)
				wrapper['classes'] = props['class'];

		});

		return layout;
	},

	importPostLayout: function(layout){
		var me = this,
			region = this.getPostRegionData(),
			options = this.postView.property('partOptions')
		;

		if (!layout) {
			return region;
		}

		_.each(layout, function(w){
			var wrapperId =	Upfront.Util.get_unique_id("wrapper"),
				wrapper = new Upfront.Models.Wrapper({
					name: "",
					properties: [
						{name: "wrapper_id", value: wrapperId},
						{name: "class", value: w['classes']}
					]
				})
			;
			region.get('wrappers').add(wrapper);

			_.each(w.objects, function(o){
				var properties = {
					type: 'PostPart_' + o.slug + 'Model',
					view_class: 'PostPart_' + o.slug + 'View',
					has_settings: 1,
					id_slug: 'PostPart_' + o.slug,
					postPart: o.slug
				};
				if(options[o.slug])
					_.extend(properties, options[o.slug]);

				var object = new Upfront.Content.PostPart({
						properties: properties,
						options: o.options
					}),
					module = new Upfront.Models.Module({
						name: '',
						properties: [
							{"name": "element_id", "value": Upfront.Util.get_unique_id("module")},
							{"name": "class", "value": o['classes']},
							{"name": "has_settings", "value": 0},
							{"name": "row", "value": 1},
							{"name": "wrapper_id", "value": wrapperId}
						],
						objects: [object]
					})
				;
				object.postModel = me.postView.model;
				region.get('modules').add(module);
			})
		});

		return region;
	},

	editTemplatePart: function(tpl, part){
		if(this.templateEditor)
			this.templateEditor.close();

		this.destroy_settings();
		this.templateEditor.open({tpl: tpl, postPart: part});
		Upfront.Events.trigger('post:parttemplates:edit');
	},

	togglePostLayoutEditorMode: function(postView, elementType){
		if(Application.current_subapplication != PostLayoutEditor){
			this.postView = postView;
			this.elementType = elementType;
			this.partMarkup = postView.editor.parts.replacements;
			Application.start(Application.MODE.POST);
		}
		else
			Application.start(Application.mode.last);
	},

	prepareViews: function(){
		var me = this,
			postView = this.postView,
			region = this.importPostLayout(postView.postLayout),
			layoutRegions = Application.layout.get('regions')
		;

		this.templateEditor = new Upfront.Content.TemplateEditor();
		this.listenTo(this.templateEditor, 'save', function(tpl, postPart){
			me.savePartTemplate(tpl, postPart);
		});

		this.listenTo(this.templateEditor, 'cancel', function(){
			me.templateEditor.close();
		});

		this.listenToOnce(Upfront.Events, 'entity:region:added', this.preparePostRegion);
		region.add_to(layoutRegions, layoutRegions.length - 1);
		$('.upfront-region-postlayouteditor').addClass(postView.editor.$el.attr('class'));
	},

	destroy_settings: function(){
		if (!this.settings_view) return false;

		this.settings_view.trigger('closed');

		this.settings_view.remove();
		this.settings_view = false;

		//Restore the settings div
		$('body').append('<div id="settings"/>');
	},

	savePartTemplate: function(tpl, postPart){
		var me = this,
			saveDialog = new Upfront.Views.Editor.SaveDialog({
				question: Upfront.Settings.l10n.global.application.save_part_pop,
				thisPostButton: Upfront.Settings.l10n.global.application.this_element_only,
				allPostsButton: Upfront.Settings.l10n.global.application.all_elements
			})
		;

        var id = me.postView.editor.post.get('post_type'),
            element = me.postView.property('type');

        Upfront.Util.post({
            action: 'upfront_save_postparttemplate',
            part: postPart,
            tpl: tpl,
            type: element,
            id: id
        })
            .done(function(response){
                me.postView.partTemplates[postPart] = tpl;
                me.postView.model.trigger('template:' + postPart);
                me.templateEditor.close();
                //saveDialog.close();
                Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.application.saved_template.replace(/%s/, postPart));
            })
        ;
        return;
		saveDialog
			.render()
			.on('closed', function(){
				saveDialog.remove();
				saveDialog = false;
			})
			.on('save', function(type){
				var id, element = me.postView.property('type');

				if(type == 'this-post'){
					if(element == 'UpostsModel')
						id = me.postView.property('element_id').replace('uposts-object-', '');
					else
						id = me.postView.editor.postId;
				}
				else
					id = me.postView.editor.post.get('post_type');

				Upfront.Util.post({
						action: 'upfront_save_postparttemplate',
						part: postPart,
						tpl: tpl,
						type: element,
						id: id
					})
					.done(function(response){
						me.postView.partTemplates[postPart] = tpl;
						me.postView.model.trigger('template:' + postPart);
						me.templateEditor.close();
						saveDialog.close();
						Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.application.saved_template.replace(/%s/, postPart));
					})
				;
			})
		;

/*
		var templates = me.postView.property('templates');
		if(!templates)
			templates = {};
		templates[postPart] = tpl;
		me.postView.property('templates', templates, false);*/
	},

	getPostRegionData: function(postView){
		var container = this.postView.parent_module_view.region,
			elementSize =  this.postView.get_element_size(),
			region = {
				title: Upfront.Settings.l10n.global.application.post_layout_editor,
				name: 'postLayoutEditor',
				container: 'postLayoutEditor',
				allow_sidebar: false,
				type: 'clip',
				modules: [],
				position: container.get('position') - 1,
				properties: [
					{name: 'col', value: elementSize.col}
				],
				scope: 'local'
            },
			regionModel = new Upfront.Models.Region(region);
		;

		return regionModel;
	},

	preparePostRegion: function(region){
		var max_col = region.model.get_property_value_by_name('col'),
			grid = Upfront.Settings.LayoutEditor.Grid
		;
		this.regionView = region;
		this.regionContainerView = region.parent_view.get_container_view(region.model);
		this.regionContainer = this.regionContainerView.$el.detach();
		this.postWrapper = this.postView.$el.closest('.upfront-wrapper');

		if(this.elementType == 'archive'){
			this.postView.editor.$el.hide();
			this.postWrapper.before(this.regionContainer);
		} else {
			this.postWrapper.hide().after(this.regionContainer);
		}

		// Hack into region container columns to render correctly
		this.regionContainerView.$layout.removeClass(grid.class + this.regionContainerView.max_col);
		this.regionContainerView.max_col = max_col;
		this.regionContainerView.$layout.addClass(grid.class + max_col);
		this.regionView.update();

		if(!this.postRegionClass) {
			this.postRegionClass = this.regionContainer.attr('class');
		}
		this.regionContainer.attr('class', this.postRegionClass + ' ' + this.postView.parent_module_view.model.get_property_value_by_name('class'));

		//The post region should be the only available for dropping
		$('#page').find('.upfront-region')
			.not('.upfront-region-postlayouteditor')
			.not('.upfront-region-shadow')
			.addClass('upfront-region-locked')
			//Stop interaction with the rest of the page
			.find('.upfront-module').each(function(){
				if ( $(this).is('.ui-draggable') )
					$(this).draggable('disable');
				if ( $(this).is('.ui-resizable') )
					$(this).resizable('disable');
			})
		;
		$('#page').find('.upfront-region-postlayouteditor').find('.upfront-module').each(function(){
			if ( $(this).is('.ui-draggable') )
				$(this).draggable('enable');
			if ( $(this).is('.ui-resizable') )
				$(this).resizable('enable');
		});
	},

	restoreViews: function(){
		this.regionContainer.remove();
		this.regionContainer = false;

		//Gagan: The code inside the following if, is to accomodate the posts element
		if(typeof(this.postwrapperclone) != 'undefined' && this.postwrapperclone)
			this.postwrapperclone.remove();

		if(this.elementType == 'archive'){
			this.postView.editor.$el.show();
		} else {
			this.postWrapper.show();
		}

		this.postWrapper = false;

		this.regionView.remove();
		var regions = Application.layout.get('regions').filter(function(r){
			return r.get('name') != 'postLayoutEditor';
		});
		Application.layout.get('regions').reset(regions, {silent:true});
		this.regionView = false;

		this.postView = false;

		$('#page').find('.upfront-region-locked').removeClass('upfront-region-locked')
			.find('.upfront-module').each(function(){
				if ( $(this).is('.ui-draggable') )
					$(this).draggable('enable');
				if ( $(this).is('.ui-resizable') )
					$(this).resizable('enable');
			})
		;
	},

	prepareSidebar: function(){
		var commands = {},
			sidebar = Application.sidebar
		;

		this.sidebarCommands = sidebar.sidebar_commands.control.commands;

		//Show post components panel
		sidebar.get_panel('posts').loadElements().active = true;
		sidebar.get_panel('elements').active = false;

		this.sidebarCommands.each(function(command){
			var el = command.$el;
			if(el.hasClass('command-undo'))
				commands.undo = command;
			else if(el.hasClass('command-redo'))
				commands.redo = command;
			else if(el.hasClass('command-grid'))
				commands.grid = command;
		});

        sidebar.sidebar_commands.control._commands = [
            commands.undo,
            commands.redo,
            commands.grid,
            new Upfront.Views.Editor.Command_CancelPostLayout(this.sidebarCommands.model)
        ];

        if( Upfront.Application.is_editor() ){
            sidebar.sidebar_commands.control._commands.push( new Upfront.Views.Editor.Command_SavePostLayout(this.sidebarCommands.model) );
        }

		sidebar.sidebar_commands.control.commands = _( sidebar.sidebar_commands.control._commands );

		Upfront.Events.trigger('post:layout:sidebarcommands');

		//Hide not necessary parts
		sidebar.sidebar_commands.primary.$el.hide();
		sidebar.sidebar_profile.$el.hide();


		this.listenToOnce(Upfront.Events, 'sidebar:rendered', function(){
			sidebar.get_panel('posts').$('h3.sidebar-panel-title').click();
		});
	},

	restoreSidebar: function(){
		var sidebar = Application.sidebar;

		//Show hidden parts
		sidebar.sidebar_commands.primary.$el.show();
		sidebar.sidebar_profile.$el.show();

		//Restore commands
		sidebar.sidebar_commands.control.commands = this.sidebarCommands;
		this.sidebarCommands = false;

		//Hide post component panel
		sidebar.get_panel('posts').unloadElements().active = false;
		sidebar.get_panel('elements').active = true;
	},

	create_settings: function (view) {
		if (this.settings_view) return this.destroy_settings();
		if (!parseInt(view.model.get_property_value_by_name("has_settings"), 10)) return false;
		var slug = 'PostPart_' + view.postPart,
			current_object = this.Objects[slug] ? this.Objects[slug] : Upfront.Views.Editor.Settings,
			settings_view = new current_object.Settings({
				model: view.model,
				anchor: current_object.anchor,
				el: $(Upfront.Settings.LayoutEditor.Selectors.settings)
			})
		;
		settings_view.for_view = view;
		settings_view.render();
		this.settings_view = settings_view;
		settings_view.trigger('rendered');
	},

	objectToProperties: function(ob){
		var props = [];
		_.each(ob, function(value, key){
			props.push({name: key, value: value});
		});
		return props;
	},
	propertiesToObject: function(properties){
		var ob = {};
		_.each(properties, function(p){
			ob[p.name] = p.value;
		});
		return ob;
	}
}))();

var PostContentEditor = new (Subapplication.extend({
	initialize: function(){
		this.listenTo(Upfront.Events, 'post:content:edit:start', this.startContentEditorMode);
		this.listenTo(Upfront.Events, 'post:content:edit:stop', this.stopContentEditorMode);
	},

	boot: function () {
		Upfront.Util.log("Preparing post content mode for execution");
        Upfront.Events.trigger('upfront:post:edit:booted', this);
    },

	start: function () {
		Upfront.Util.log("Starting post the content edit mode");
	},

	stop: function () {
		var $page = $('#page');
		Upfront.Util.log("Stopping post the content edit mode");
		$page.find('.upfront-module').each(function(){
			if ( $(this).is('.ui-draggable') )
				$(this).draggable('enable');
			if ( $(this).is('.ui-resizable') )
				$(this).resizable('enable');
		});
		Upfront.Events.trigger('upfront:element:edit:stop');
		$page.find('.upfront-region-edit-trigger').show();
		this.contentEditor = false;
	},

	startContentEditorMode: function(contentEditor){
		if(Application.current_subapplication == PostContentEditor)
			return;

		this.contentEditor = contentEditor;

		var $page = $('#page');

		//There is no need of start the application, just set the current one
		Application.set_current(Application.MODE.POSTCONTENT);
		$page.find('.upfront-module').each(function(){
			if ( $(this).is('.ui-draggable') )
				$(this).draggable('disable');
			if ( $(this).is('.ui-resizable') )
				$(this).resizable('disable');
		});
		Upfront.Events.trigger('upfront:element:edit:start', 'write', contentEditor.post);
		$page.find('.upfront-region-edit-trigger').hide();

		Upfront.Events.on('content:insertcount:updated', this.updateInsertCount);
	},

	stopContentEditorMode: function(){
		Upfront.Events.off('content:insertcount:updated', this.updateInsertCount);
		if(Application.current_subapplication == PostContentEditor)
			Application.start(Application.mode.last);
	},
	updateInsertCount: function(){
		console.log('update insertcount');
		Upfront.Util.post({
			action: 'upfront_update_insertcount'
		});
	}
}));



var ContentEditor = new (Subapplication.extend({
	boot: function () {
		Upfront.Util.log("Preparing content mode for execution")
	},

	start: function () {
		Upfront.Util.log("Starting the content edit mode");

		$("html").removeClass("upfront-edit-layout upfront-edit-theme upfront-edit-postlayout upfront-edit-responsive").addClass("upfront-edit-content");
	},

	stop: function () {
		Upfront.Util.log("Stopping the content edit mode");
	}
}))();

var ThemeEditor = new (LayoutEditorSubapplication.extend({
	boot: function () {

	},

	start: function () {
		this.stop();
		this.set_up_event_plumbing_before_render();
		// @TODO hack to implement LayoutEditor objects
		this.Objects = Upfront.Application.LayoutEditor.Objects;
		this.set_up_editor_interface();

		this.set_up_event_plumbing_after_render();
		$("html").removeClass("upfront-edit-layout upfront-edit-content upfront-edit-postlayout upfront-edit-responsive").addClass("upfront-edit-theme");
		if ( Upfront.themeExporter.currentTheme === 'upfront') {
			this.listenToOnce(Upfront.Events, 'layout:render', function() {
				Upfront.Events.trigger("command:layout:edit_structure");
			});
		}
		this.listenToOnce(Upfront.Events, 'layout:render', Upfront.Behaviors.GridEditor.apply_grid);
		this.listenToOnce(Upfront.Events, 'command:layout:save_done', Upfront.Behaviors.LayoutEditor.first_save_dialog);
		this.listenTo(Upfront.Events, "command:layout:create", Upfront.Behaviors.LayoutEditor.create_layout_dialog); // DEPRECATED
		this.listenTo(Upfront.Events, "command:themefontsmanager:open", Upfront.Behaviors.LayoutEditor.open_theme_fonts_manager);
		this.listenTo(Upfront.Events, "command:layout:browse", Upfront.Behaviors.LayoutEditor.browse_layout_dialog); // DEPRECATED
		this.listenTo(Upfront.Events, "command:layout:edit_structure", Upfront.Behaviors.GridEditor.edit_structure);
		this.listenTo(Upfront.Events, "command:layout:export_theme", Upfront.Behaviors.LayoutEditor.export_dialog);
		this.listenTo(Upfront.Events, "builder:load_theme", Upfront.Behaviors.LayoutEditor.load_theme);
	},

	stop: function () {
		return this.stopListening(Upfront.Events);
	}

}))();

var ResponsiveEditor = new (LayoutEditorSubapplication.extend({
	Objects: {},

	boot: function () {
	},

	start: function () {
		this.stop();
		this.Objects = Upfront.Application.LayoutEditor.Objects;
		this.set_up_event_plumbing_before_render();
    	Upfront.Application.sidebar.render();
    	this.topbar = new Upfront.Views.Editor.Topbar.Topbar();
    	this.topbar.start();
		this.set_up_event_plumbing_after_render();
		this.listenTo(Upfront.Events, "command:layout:browse", Upfront.Behaviors.LayoutEditor.browse_layout_dialog); // DEPRECATED

		$("html").removeClass("upfront-edit-content upfront-edit-theme upfront-edit-postlayout upfront-edit-layout").addClass("upfront-edit-responsive");
	},

	stop: function () {
		if ( this.topbar )
		    this.topbar.stop();
		return this.stopListening(Upfront.Events);
	}

}))();

var Application = new (Backbone.Router.extend({
	LayoutEditor: LayoutEditor,
	ContentEditor: ContentEditor,
	ThemeEditor: ThemeEditor,
	PostLayoutEditor: PostLayoutEditor,
	PostContentEditor: PostContentEditor,
	ResponsiveEditor: ResponsiveEditor,

	actions: {
		"save": "upfront_save_layout",
		"load": "upfront_load_layout"
	},

	routes: {
		"done": "destroy_editor",
		"new-layout": "dispatch_layout_creation",
		"create_new(/:postType)": "create_new_entry",
		"*otherRoutes": "fetchLayout"
	},

	MODE: {
		CONTENT: "content",
		LAYOUT: "layout",
		THEME: "theme",
		POST: 'post layout',
		POSTCONTENT: "post content",
		RESPONSIVE: "responsive"
	},

	mode: {
		last: false,
		current: false
	},
	set_post_content_style: function(mode){
		mode = typeof mode === "undefined" ? true : mode;
		this.MODE.POSTCONTENT_STYLE = mode;
		return true;
	},
	is_post_content_style: function(){
		return this.MODE.POSTCONTENT_STYLE === this.mode.current;
	},
	is_builder: function(){
		return this.mode.current === this.MODE.THEME || this.mode.last === this.MODE.THEME;
	},
	is_editor: function(){
		return !this.is_builder();
	},
	urlCache: {},

	current_subapplication: false,
	sidebar: false,
	layout: false,

	layout_ready: false,

	responsiveMode: false,

	boot: function () {
		this.MODE = Upfront.Settings.Application.MODE;
		var me = this;
		$("body .upfront-edit_layout a").addClass('active');
		$("body").off("click", ".upfront-edit_layout").on("click", ".upfront-edit_layout", function () {
			//$(".upfront-editable_trigger").hide();
			//app.go("layout");

			me.start();
			return false;
		});
		$(document).trigger("upfront-load");
	},

	start: function (mode) {
		// Main stylesheet needs to be loaded without element styles
		// which will be edited in upfront.
		Upfront.Util.post({
			action: 'upfront_load_styles',
			layout: {
				item: 'archive-home',
				type: 'archive'
			},
			base_only: true // flag for w/o element styles
		})
			.success(function(response) {
				// Switch styles
				$('#upfront-main-css').after('<style id="upfront-main-base-css">' + response.data.styles + '</style>');
				$('#upfront-main-css').remove();
			});

		if (!mode) mode = this.MODE.DEFAULT;
		if (this.mode.current == mode) return false;

		$('#wpadminbar').hide();
		$('html').attr('style', 'margin-top: 0 !important;');

		this.set_current(mode);
		if (!(this.current_subapplication && this.current_subapplication.start)) {
			Upfront.Util.log("Can't boot invalid subapplication");
		}
		Upfront.Events.trigger("application:mode:before_switch");

		this.listenToResponsiveModes();

		if (!!this.layout) {
			var regions = this.layout.get("regions"),
				region = regions.get_by_name("shadow")
			;
			if (regions && region) regions.remove(region);
			this.create_sidebar();
			this.current_subapplication.layout = this.layout;
			if (this.current_subapplication && this.current_subapplication.start) this.current_subapplication.start();
			else Upfront.Util.log("No current subapplication");
			Upfront.Events.trigger("application:mode:after_switch");
			return false;
		}

		var app = this;
		// Start loading animation
		app.loading = new Upfront.Views.Editor.Loading({
			loading: Upfront.Settings.l10n.global.application.loading,
			loading_type: 'upfront-boot',
			done: Upfront.Settings.l10n.global.application.thank_you_for_waiting,
			fixed: true
		});
		app.loading.on_finish(function(){
			$(Upfront.Settings.LayoutEditor.Selectors.sidebar).show();
			$(".upfront-editable_trigger").hide();
		});
		app.loading.render();
		$('body').append(app.loading.$el);

		app.create_sidebar();

		require(
			[
				"objects",
				'media',
				'content',
				'bg-settings',
				'spectrum',
				'responsive',
				"uaccordion",
				'redactor',
				'ueditor',
				'utext',
				"ucomment",
				"ucontact",
				"ugallery",
				"uimage",
				"upfront-like-box",
				"upfront_login",
				"upfront_maps",
				"unewnavigation",
				"ubutton",
				"uposts",
				"usearch",
				"upfront_slider",
				"upfront-social_media",
				"utabs",
				"this_post",
				"this_page",
				"uwidget",
				"uyoutube",
				"upfront_code",
				"uspacer"
			],
			function (objects) {
				app.currentUrl = window.location.pathname + window.location.search;
				app.saveCache = true;
				app.load_layout(_upfront_post_data.layout);
				//app.load_layout(window.location.pathname + window.location.search);
				app.start_navigation();

				app.create_cssEditor();

                $(document).trigger('Upfront:loaded');
				Upfront.Events.trigger('Upfront:loaded');
			}
		);
	},

	stop: function () {

	},

	restart: function () {
		var last = this.mode.last || this.MODE.DEFAULT;
		this.start(last);
	},

	load_layout: function (layout_ids, additional) {
		var app = this,
			request_data = {
				action: this.actions.load,
				data: layout_ids,
				load_dev: ( _upfront_storage_key != _upfront_save_storage_key ? 1 : 0 )
			}
		;
		if (additional)
			request_data = _.extend(request_data, additional);

		if(_upfront_post_data)
			request_data.post_id = _upfront_post_data.post_id;

		$("body").removeClass(Upfront.Settings.LayoutEditor.Grid.scope);

		//If we are already loading a layout, abort the load
		if(this.loadingLayout)
			this.loadingLayout.abort();

		this.loadingLayout = Upfront.Util.post(request_data)
			.success(function (response) {
				app.set_layout_up(response);
				if(app.saveCache){
					app.urlCache[app.currentUrl] = $.extend(true, {}, response);
					app.saveCache = false;
				}
			})
			.error(function (xhr) {
				if(xhr.statusText == 'abort') //we are ok
					return;

				Upfront.Util.log("Error loading layout " + layout_ids);
				app.loading.cancel(function(){
					$(Upfront.Settings.LayoutEditor.Selectors.sidebar).hide();
					//$(".upfront-editable_trigger").show();
					$('#wpadminbar').show();
					$('html').removeAttr('style');
				});
			})
		;
		return this.loadingLayout;
	},

	create_layout: function (layout_ids, additional) {
		var app = this,
			request_data = {
				action: 'upfront_create_layout',
				data: layout_ids,
				load_dev: ( _upfront_storage_key != _upfront_save_storage_key ? 1 : 0 )
			}
		;
		if (additional)
			request_data = _.extend(request_data, additional);

		if(_upfront_post_data)
			request_data.post_id = _upfront_post_data.post_id;

		$("body").removeClass(Upfront.Settings.LayoutEditor.Grid.scope);

		//If we are already loading a layout, abort the load
		if(this.loadingLayout)
			this.loadingLayout.abort();

		this.loadingLayout = Upfront.Util.post(request_data)
			.success(function (response) {
				app.set_layout_up(response);
				if(app.saveCache){
					app.urlCache[app.currentUrl] = $.extend(true, {}, response);
					app.saveCache = false;
				}
			})
			.error(function (xhr) {
				if(xhr.statusText == 'abort') //we are ok
					return;

				Upfront.Util.log("Error creating layout " + layout_ids);
				app.loading.cancel(function(){
					$(Upfront.Settings.LayoutEditor.Selectors.sidebar).hide();
					//$(".upfront-editable_trigger").show();
					$('#wpadminbar').show();
					$('html').removeAttr('style');
				});
			})
		;
		return this.loadingLayout;
	},
	set_layout_up: function(layoutData){
		var me = this,
			data = $.extend(true, {}, layoutData.data.layout) || {} //Deep cloning
		;

		if (layoutData.data.post)
			this.post_set_up(layoutData.data.post);

		//Set the query for the posts
		var query = layoutData.data.query || {};

		if(this.layout){
			this.unset_layout();
			//We only set the query if there is already a layout.
			//In the first loading, upfront does it for us
			window._upfront_get_current_query = function(){ return query; };
		}

		this.layout = new Upfront.Models.Layout(data);
		this.current_subapplication.layout = this.layout;
		this.sidebar.model.set(this.layout.toJSON());

		var shadow = this.layout.get('regions').get_by_name("shadow");
		if(shadow)
			this.layout.get('regions').remove(shadow);

		window._upfront_post_data.layout = layoutData.data.cascade;

		Upfront.Events.trigger("upfront:layout:loaded");
		if (me.current_subapplication && me.current_subapplication.start)
			me.current_subapplication.start();

		else Upfront.Util.log("No current subapplication");

		//if (!me.layout_view) {
		me.layout_view = new Upfront.Views.Layout({
			"model": me.layout,
			"el": $(Upfront.Settings.LayoutEditor.Selectors.main)
		});
		Upfront.Events.trigger("layout:render", me.current_subapplication);
		me.layout_ready = true;
		//}

		Upfront.Application.loading.done(function () {

			Upfront.PreviewUpdate.run(me.layout);

			Upfront.Events.trigger("application:mode:after_switch");
		});
	},

	unset_layout: function(){
		var layoutTag, layoutElement, newElement;

		Upfront.data.currentEntity = false;

		if(Upfront.data.Ueditor){
			_.each(Upfront.data.Ueditor.instances, function(ueditor){
				ueditor.stop();
			});
		}

		if(this.layout){
			this.layout.trigger('destroy');
			this.layout = false;
		}
		if(this.current_subapplication.layout)
			this.current_subapplication.layout = false;

		if(this.layout_view){
			//Create a new layout element, because it will be destroyed
			layoutElement = this.layout_view.el;
			layoutTag = {
				name: layoutElement.tagName,
				id: layoutElement.id,
				className: layoutElement.className
			};
			newElement = $('<' + layoutTag.name + '>');
			this.layout_view.$el.after(newElement);

			//Destroy
			this.layout_view.remove();
			this.layout_view = false;
			this.layout_ready = false;

			//Restore tag attributes
			newElement.attr({
				'class': layoutTag.className,
				'id': layoutTag.id
			});

			//Free region/object events
			Upfront.Events.off('upfront:editor:init'); // Link dispatcher, upfront-content.php
			Upfront.Events.off('upfront:post:taxonomy_changed'); // Link dispatcher, upfront-content.php
		}
		if(!$(Upfront.Settings.LayoutEditor.Selectors.main).length)
			$('body').prepend('<div id="page" />');

	},

	create_new_entry: function(post_type){
		var me= this,
			layoutOps = {
				item: 'single-' + post_type,
				type: 'single',
				specificity: 'single-' + post_type + '-1000000' //Big number to assure default layout
			},
			deferred = new $.Deferred(),
			postData = {},
			loading = this.set_loading(Upfront.Settings.l10n.global.application.preparing_new_post_type.replace(/%s/, post_type), Upfront.Settings.l10n.global.application.here_we_are)
		;

		// @TODO is this correct to call stop before load_layout? fixed double event assignment
		if (this.current_subapplication && this.current_subapplication.stop) {
			this.current_subapplication.stop();
		}


        Upfront.Events.once('upfront:post:edit:stop', function(action, post){
            me.navigate('/edit/' + post.post_type + '/' + post.ID + location.search, {trigger: false, replace: true});
        });

		//Set some listener for the new post view
		Upfront.Events.once('post:initialized', function(postView){
			postView
				.once('post:updated', function(post){
					//Update the url on save
					Upfront.Settings.LayoutEditor.newpostType = false;
					me.navigate('/edit/' + post.post_type + '/' + post.ID, {trigger: false, replace: true});
				})
			;
			me.listenToOnce(postView.editor, 'rendered', function(){
				setTimeout(function(){
					postView.editor.editContents(false, postView.$('.upfront-content-marker-title'));
				}, 200);
			});
		});

		//Load the new layout
		this.load_layout(layoutOps, {new_post: post_type}).done(function(response){
			Upfront.Settings.LayoutEditor.newpostType = post_type;
			postData = response.data.post;
            Upfront.data.posts[postData.ID].is_new = true;
			deferred.resolve(Upfront.data.posts[postData.ID]);
			loading.done();
		});

		return deferred.promise();
	},

	post_set_up: function(postData){
		//Create the post with meta
		postData.meta = [];
		var post = new Upfront.Models.Post(postData);

		post.is_new = postData.post_status == 'auto-draft' && postData.post_content === '';

		//Set global variables
		Upfront.data.posts[post.id] = post;
		_upfront_post_data.post_id = post.id;


		//Load body classes
		//var bodyClasses = 'logged-in admin-bar upfront customize-support flex-support'; // NOPE! Don't re-add the .upfront, it should have been removed:
		var bodyClasses = 'logged-in admin-bar customize-support flex-support';

		if(postData.post_type == 'page')
			bodyClasses += ' page page-id-' + post.id + ' page-template-default';
		else
			bodyClasses += ' single single-' + postData.post_type + ' postid-' + post.id;

		$('body')
			.removeClass()
			.addClass(bodyClasses)
		;
	},
	set_gridstate: function( state ) {
		this.gridstate = state;
	},
	get_gridstate: function() {
		return this.gridstate;
	},

	get_current: function () {
		return this.mode.current || this.MODE.DEFAULT;
	},

	set_current: function (mode) {
		if (this.current_subapplication && this.current_subapplication.stop) {
			this.current_subapplication.stop();
		}
		if (!mode) mode = this.MODE.DEFAULT;
		if (this.mode.current == mode) return false;

		this.mode.last = this.mode.current;

		if (mode && this.MODE.CONTENT == mode) {
			this.mode.current = this.MODE.CONTENT;
			this.current_subapplication = this.ContentEditor;
		} else if(mode && this.MODE.THEME == mode) {
			this.mode.current = this.MODE.THEME;
			this.current_subapplication = this.ThemeEditor;
		} else if(mode && this.MODE.POST == mode) {
			this.mode.current = this.MODE.POST;
			this.current_subapplication = this.PostLayoutEditor;
		} else if(mode && this.MODE.POSTCONTENT == mode) {
			this.mode.current = this.MODE.POSTCONTENT;
			this.current_subapplication = this.PostContentEditor;
            if ( this.sidebar.visible && this.is_editor())
                this.sidebar.toggleSidebar();
		} else if(mode && this.MODE.RESPONSIVE == mode) {
			this.mode.current = this.MODE.RESPONSIVE;
			this.current_subapplication = this.ResponsiveEditor;
		} else {
			this.mode.current = this.MODE.LAYOUT;
			this.current_subapplication = this.LayoutEditor;
		}
		this.current_subapplication.boot();
	},

	create_sidebar: function () {
		if (!this.sidebar) {
			this.sidebar = new Upfront.Views.Editor.Sidebar.Sidebar({
				"model": new Upfront.Models.Layout({}),
				"el": $(Upfront.Settings.LayoutEditor.Selectors.sidebar)
			});
		}
		//this.sidebar.render(); <-- Subapplications do this
	},
	
	recursiveExistenceMigration: function(selector, clean_selector) {
		var splitted = clean_selector.split(' ');
		var me = this;
		while(splitted.length > 0) {
			try{
				if(!!$(selector + splitted.join(' ')).closest('#' + me.element_id).length)
					return true;
			}
			catch (err) {

			}
			splitted.pop();
		}

		return false;
	},

	stylesAddSelectorMigration: function(contents, selector) {
		if (this.is_global_stylesheet && empty(selector)) return contents;

		var me = this,
			rules = contents.split('}'),
			processed = ''
		;

		_.each(rules, function (rl) {
			var src = $.trim(rl).split('{');

			if (src.length != 2) return true; // wtf

			var individual_selectors = src[0].split(','),
				processed_selectors = []
			;
			_.each(individual_selectors, function (sel) {
				sel = $.trim(sel);
				var clean_selector = sel.replace(/:[^\s]+/, ''); // Clean up states states such as :hover, so as to not mess up the matching
				var	is_container = clean_selector[0] === '@' || me.recursiveExistenceMigration(selector, clean_selector),
					spacer = is_container
						? '' // This is not a descentent selector - used for containers
						: ' ' // This is a descentent selector
				;

				processed_selectors.push('' +
					selector + spacer + sel +
				'');
			});
			processed += processed_selectors.join(', ') + ' {' +
				src[1] + // Actual rule
			'\n}\n';
		});
		return processed;
	},

	create_cssEditor: function(){
		var me = this,
			cssEditor = new Upfront.Views.Editor.CSSEditor(),
			icon_font_style,
			longSrc = '';

		cssEditor.fetchThemeStyles(true).done(function(styles){
			Upfront.data.styles = {};
			_.each(styles, function(elementStyles, elementType){

				Upfront.data.styles[elementType] = [];
				_.each(elementStyles, function(style, name){
					style = Upfront.Util.colors.convert_string_ufc_to_color(style);
					Upfront.data.styles[elementType].push(name);
					var styleNode = $('#'+name);
					// Increase element style priority over preset styles
					var styleOutput = style.replace(/#page/g, 'div#page.upfront-layout-view .upfront-editable_entity.upfront-module');
					if(!styleNode.length){
						styleNode = $('<style id="' + name + '">' + styleOutput + '</style>');
						$('body').append(styleNode);
					}
					else {
						styleNode.html(styleOutput);
					}
				});
			});

			// Good place to add active icon font style
			_.each(Upfront.mainData.iconFonts, function(font) {
				if (font.active === true) {
					_.each(font.files, function(file, type) {
						longSrc += "url('" + Upfront.mainData.currentThemeUrl + '/icon-fonts/' + file + "') format('";
						switch(type) {
							case 'eot':
								longSrc += 'embedded-opentype';
								break;
							case 'woff':
								longSrc += 'woff';
								break;
							case 'ttf':
								longSrc += 'truetype';
								break;
							case 'svg':
								longSrc += 'svg';
								break;
						}
						longSrc += "'),";
					});

					icon_font_style = "@font-face {" +
						"font-family: '" + font.family + "';";
					if (font.files.eot) {
						icon_font_style += "src: url('" + Upfront.mainData.currentThemeUrl + '/icon-fonts/' + font.files.eot + "');";
					}
					icon_font_style += "	src:" + longSrc.substring(0, longSrc.length - 1) + ';';

					icon_font_style +=
						"	font-weight: normal;" +
						"	font-style: normal;" +
						"}" +
						".uf_font_icon, .uf_font_icon * {" +
						"	font-family: '" + font.family + "'!important;" +
						"}";

					$('body').append('<style id="active-icon-font">' + icon_font_style + '</style>');
				}
			});

			if (_upfront_post_data.layout) me.apply_region_css();
			Upfront.Events.trigger("upfront:csseditor:ready");
		});

		cssEditor.createSelectors(Upfront.Application.LayoutEditor.Objects);

		// Group selectors
		cssEditor.createSelector(Upfront.Models.ModuleGroup, Upfront.Views.ModuleGroup, 'ModuleGroup');

		// Region selectors
		cssEditor.createSelector(Upfront.Models.Region, Upfront.Views.RegionContainerView, 'RegionContainer');
		cssEditor.createSelector(Upfront.Models.Region, Upfront.Views.RegionView, 'Region');
		cssEditor.createSelector(Upfront.Models.Region, Upfront.Views.RegionLightboxView, 'RegionLightbox');

		Upfront.Events.on("upfront:layout:loaded", me.apply_region_css, me);
		Upfront.Events.on("upfront:layout:loaded", me.ensure_layout_style, me);
		this.cssEditor = cssEditor;
	},

	ensure_layout_style: function() {
		var style;

		if (Upfront.Application.current_subapplication.layout && !$('style#layout-style').length) {
			style = Upfront.Application.current_subapplication.layout.get('properties').findWhere({name: 'layout_style'}) ?  Upfront.Application.current_subapplication.layout.get('properties').findWhere({name: 'layout_style'}).get('value') : "";
			// Make sure we also properly pre-process the layout styles:
			if (style && style.length) style = Upfront.Util.colors.convert_string_ufc_to_color(style);
			$('body').append('<style id="layout-style">' + style + '</style>');
		}
	},

	apply_region_css: function () {
		var me = this,
			layout_id = _upfront_post_data.layout.specificity || _upfront_post_data.layout.item || _upfront_post_data.layout.type;

		_.each(Upfront.data.styles, function(elementStyles, elementType){

			if ( elementType != me.cssEditor.elementTypes.RegionContainer.id && elementType != me.cssEditor.elementTypes.Region.id )
				return;
			if ( !_.isArray(elementStyles) )
				return;
			_.each(elementStyles, function(name){
				var styleNode = $('#'+name);
				if ( styleNode.length && ( name.match(new RegExp('^' + layout_id)) || name.match(new RegExp('^' + elementType)) ) )
					styleNode.prop('disabled', false);
				else
					styleNode.prop('disabled', true);
			});
		});
	},

	adjust_grid_padding_settings: function(region) {
		//Handle region top/bottom padding and move grid rulers
		$region = $(region).parent(),
			padding_top = parseInt($region.css('padding-top')),
			padding_bottom = parseInt($region.css('padding-bottom'));

		if(padding_top > 0) {
			$region.find('.upfront-overlay-grid').css("top", padding_top * -1);
		}

		if(padding_bottom > 0) {
			$region.find('.upfront-overlay-grid').css("bottom", padding_bottom * -1);
		}
	},

	fetchLayout: function(path, urlParams){
		if(this.mode.current != this.MODE.LAYOUT)
			this.start(this.MODE.LAYOUT);

		var me = this,
			urlQueryParts = urlParams ? [] : false,
			fullPath = path ? '/' + path : '/',
			loading
		;

		if(urlQueryParts){
			_.each(urlParams, function(value, key){
				urlQueryParts.push(key + '=' + value);
			});
			fullPath += '?' + urlQueryParts.join('&');
		}

		loading = this.set_loading(Upfront.Settings.l10n.global.application.loading_path.replace(/%s/, fullPath), Upfront.Settings.l10n.global.application.here_we_are);

		if(this.urlCache[fullPath]){
			//Wait a bit to let the loading screen render
			setTimeout(function(){
				Upfront.Settings.LayoutEditor.newpostType = false;
				me.set_layout_up(me.urlCache[fullPath]);
				me.currentUrl = fullPath;
				loading.done();
			}, 150);
		}
		else{
			// First unload layout without any delay, since on fast environments load_layout
			// could be done instantly which would lead to mix of layouts in page.
			me.unset_layout();
			this.load_layout(fullPath).done(function(response){
				Upfront.Settings.LayoutEditor.newpostType = false;
				loading.done();
				Upfront.Settings.LayoutEditor.newpostType = false;
				me.urlCache[fullPath] = response;
				this.currentUrl = fullPath;
			});
		}
	},

	start_navigation: function(){
		var me = this,
			site_url =  document.createElement('a')
		;

		site_url.href = Upfront.Settings.site_url;
		Backbone.history.start({pushState: true, root: site_url.pathname, silent:true});
	},

	set_loading: function(message, done){
		var me = this,
			loading = this.loadingLayer
		;
		if(loading){
			document.querySelector('.upfront-loading-text').innerText = message;
			loading.options.done = done;
		}
		else {
			loading = new Upfront.Views.Editor.Loading({
				loading: message,
				done: done,
				fixed: true
			});
			loading.render();
			$('body').append(loading.$el);
			loading.on_finish(function(){
				me.loadingLayer = false;
			});
		}

		this.loadingLayer = loading;

		return loading;
	},

	listenToResponsiveModes: function(){
		// If a responsive mode is set we already are listening
		if(this.responsiveMode)
			return;

		var me = this;

		// Initial mode is desktop
		this.responsiveMode = 'desktop';

		this.listenTo(Upfront.Events, 'upfront:layout_size:change_breakpoint', function(newMode, previousMode){
			me.responsiveMode = newMode.id;
		});
	},

}))();

return {
	"Application": Application
};
});

$(function () {
	$("body").on("click", ".upfront-edit_layout", function (e) {
		e.preventDefault();
		// alert(_upfront_please_hold_on);
	});
});

})(jQuery);
//@ sourceURL=upfront-application.js
;
(function ($) {

window.empty = function (what) { return "undefined" === typeof what ? true : !what; };
window.count = function (what) { return "undefined" === typeof what ? 0 : (what && what.length ? what.length : 0); };
_.mixin({
	isTrue: function( val ) {
		if( typeof val === "undefined")
			return false;

		if( _.isString( val ) )
			return val.toLowerCase() === "true";

		if(_.isNumber( val ) )
			return 0 !== val;
	}
});

//requestFrameAnimation polyfill
var rAFPollyfill = function(callback){
		var currTime = new Date().getTime(),
			timeToCall = Math.max(0, 16 - (currTime - lastTime)),
			id = setTimeout(function() { callback(currTime + timeToCall); }, timeToCall)
		;
		lastTime = currTime + timeToCall;
		return id;
};



define('util',[],function() {
	var guessLinkType = function(url) {
		if(!$.trim(url) || $.trim(url) == '#' || $.trim(url) == '') {
			return 'unlink';
		}

		if(url.length && url[0] == '#') {
			return url.indexOf('#ltb-') > -1 ? 'lightbox' : 'anchor';
		}
		
		if(typeof window.location.origin !== "undefined") {
			if(url.substring(0, window.location.origin.length) == window.location.origin) {
				if(
					typeof window.location.pathname !== "undefined"
					&&
					url.substring(window.location.origin.length, window.location.origin.length+window.location.pathname.length) == window.location.pathname
					&&
					url.substring(window.location.origin.length+window.location.pathname.length)[0] == '#'
				) {
					return 'anchor';
				}
				return 'entry';
			}
		}

		if (url.match(/^mailto/)) {
			return 'email';
		}

		return 'external';
	};

	var Util = {
		model_to_json: function (model) {
			if (!model) return {};
			var raw = (model && model.toJSON ? model.toJSON() : model),
				data_str = JSON.stringify(raw),
				json = JSON.parse(data_str)
			;

			return json;
		},

		get_unique_id: function (pfx) {
			return _.template("{{prefix}}-{{stamp}}-{{numeric}}", {
				prefix: pfx || "entity",
				stamp: (new Date).getTime(),
				numeric: Math.floor((Math.random()*999)+1000)
			});
		},

		log: function () {
			var args = ["[UPFRONT]: "].concat(arguments);
			console.log.apply(console, args);
		},

		dbg: function () {
			Upfront.Util.log(JSON.stringify(arguments[0]));
		},

		/**
		 * Perform deep copy of an object
		 */
		clone: function (obj) {
			return jQuery.extend(true, {}, obj);
		},

		/**
		 * Check CSS support
		 */
		css_support: function ( property ) {
			var div = document.createElement('div'),
				reg = new RegExp("(khtml|moz|ms|webkit|)"+property, "i")
			;
			for ( s in div.style ) {
				if ( s.match(reg) ) return true;
			}
			return false;
		},

		post: function (data, data_type) {
			var request = (_.isObject(data) && data.action) ? data : {"action": "upfront_request", "data": data};

			// @TODO need a better way to attach upfront layout data on request?
			if ( Upfront.Application.current_subapplication.layout ) {
				//request.upfront_layout = Upfront.Application.layout.get('layout');
				request.layout = Upfront.Application.current_subapplication.layout.get('layout');
			}
			if ( !request.storage_key ) request.storage_key = _upfront_storage_key;
			request.stylesheet = _upfront_stylesheet;

			// Some stuff depends if in builder or editor mode so lets make that
			// available for convenient server side check.
			request.mode = Upfront.Application.get_current();

			// Was request made from dev mode
			request.dev = location.search.indexOf('dev=true') > -1;

			return $.post(Upfront.Settings.ajax_url, request, function () {}, data_type ? data_type : "json");
		},

		reset_layout: function () {
			var request = {
				action: "upfront_reset_layout"
			};
			return this.post(request);
		},

		reset_cache: function () {
			var request = {
				action: "upfront_reset_cache"
			};
			return this.post(request);
		},

		reset_all: function () {
			var request = {
				action: "upfront_reset_all_from_db"
			};
			return this.post(request);
		},

		format_date: function(date, show_time, show_seconds){
				if (!date || !date.getFullYear) {
					if (date && date.length) {
						// Attempt to convert to proper object
						var old_date = date;
						date = new Date(Date.parse(date));
						if (!date) return old_date;
					}
					// If we're still here, and still have no date... bad luck
					if (!date|| !date.getFullYear) return date;
				}
				var output = date.getFullYear() + '/',
					day = date.getDate(),
					month = (date.getMonth()+1)
				;
				if(day < 10) day = '0' + day;
				if(month < 10) month = '0' + month;

				output += month + '/' + day;

				if(show_time){
					var hours = date.getHours(),
						minutes = date.getMinutes()
					;
					output += ' ' +
						(hours < 10 ? '0' : '') +
						hours + ':' +
						(minutes < 10 ? '0' : '') +
						minutes
					;
					if(show_seconds){
						var seconds = date.getSeconds();
							output += ':' +
								(seconds < 10 ? '0' : '') +
								seconds
						;
					}
				}
				return output;
		},
		get_avatar: function(obj, size){
			var protocolParts = window.location.href.split('//'),
				url = protocolParts[0] + '//www.gravatar.com/avatar/',
				hash = ''
			;

			size = size && parseInt(size, 10) == size ? size : 32;

			if(_.isString(obj)) hash = obj;
			else if(obj instanceof Upfront.Models.User || obj instanceof Upfront.Models.Comment) hash = obj.get('gravatar');
			else return false;

			return url + hash + '?d=mm&s=' + size;
		},
        grid : {
            /**
             * Sets proper class to passed in jquery object of the element
             *
             * @param jQuery object $el
             * @param string class_prefix|class_name either a class prefix like 'c' or a class name like c12
             * @param string|int|null class_size either a string of the class size like 12 or '12'
             */
            update_class :  function ($el, class_prefix, class_size) {
                if(  _.isUndefined( class_size ) ){
                    var class_size = class_prefix.replace( /[^\d.]/g, ''),
                        class_name = class_prefix.replace(class_size, "");
                }else{
                    class_name = class_prefix;
                }
                var rx = new RegExp('\\b' + class_name + '\\d+');
                if ( ! $el.hasClass( class_name + class_size) ){
                    if ( $el.attr('class').match(rx) )
                        $el.attr('class', $el.attr('class').replace(rx, class_name + class_size));
                    else
                        $el.addClass( class_name + class_size );
                }
            },
            col_to_width: function (col_cls) {
            	if(!col_cls) return 0;

                 var column_width = Upfront.Settings.LayoutEditor.Grid.column_width,
                	col_class = Upfront.Settings.LayoutEditor.Grid.class;
                return parseInt(col_cls.replace(col_class, ""), 10) * column_width;
            },
            width_to_col: function (width, ceil) {
                ceil = typeof  ceil === "undefined" ? false : ceil;
				width = parseInt( width, 10 );
				if( width < 0 ) return 0;
                var column_width = Upfront.Settings.LayoutEditor.Grid.column_width;
                return Math[ ceil ? "ceil" : "floor" ](width/column_width);
            },
            height_to_row: function (height) {
                var baseline = Upfront.Settings.LayoutEditor.Grid.baseline;
                return Math.ceil(height/baseline);
            },
            normalize_width: function(width){
                return this.width_to_col( width ) * Upfront.Settings.LayoutEditor.Grid.column_width;
            },
            normalize_height: function( height ){
                return this.height_to_row( height ) * Upfront.Settings.LayoutEditor.Grid.baseline;
            },
			derive_from_classes: function( classes, haystack ){
				if( !classes || classes.length < 2 || !haystack ) return false;
				var regex = new RegExp("(" + haystack +"\\d+(d)*)", "g"),
					res = classes.match(regex);
				return _.isEmpty(res) ? false : res[0] ;
			},
			derive_column_class: function( classes ){
				return this.derive_from_classes( classes, "c" );
			},
			derive_margintop_class: function( classes ){
				return this.derive_from_classes( classes, "mt" );
			},
			derive_marginleft_class: function( classes ){
				return this.derive_from_classes( classes, "ml" );
			}
        },
		width_to_col: function (width) {
			return this.grid.width_to_col(width);
		},

		height_to_row: function (height) {
			return this.grid.height_to_row(height);
		},

		openLightboxRegion: function(regionName){
			var regions = Upfront.Application.layout.get('regions'),
				region = regions.get_by_name(regionName)
			;

			if(!region) return;

			//hide other lightboxes
			_.each(regions.models, function(model) {
				if(model.attributes.sub == 'lightbox')
					Upfront.data.region_views[model.cid].hide();
			});

			Upfront.data.region_views[region.cid].show();
		},
		
		/**
		 * Sorted find 
		 */
		find_sorted: function ($el, selector) {
			return $el.find(selector)
				.each(Upfront.Util.normalize_sort_elements_cb)
				.sort(Upfront.Util.sort_elements_cb)
			;
		},

		/**
		 * Callback to sort jQuery elements
		 */
		sort_elements_cb: function (a, b) {
			var cmp_a = $(a).data('breakpoint_order'),
				cmp_b = $(b).data('breakpoint_order');
			if ( ! _.isNumber(cmp_a) )
				cmp_a = $(a).data('dom_order');
			if ( ! _.isNumber(cmp_b) )
				cmp_b = $(b).data('dom_order');
			if ( cmp_a > cmp_b)
				return 1;
			else
				return -1;
			return 0;
		},

		/**
		 * Callback before sort jQuery element, to store DOM position, pass on $.each
		 */
		normalize_sort_elements_cb: function (index) {
			$(this).data('dom_order', index);
		},

		/**
		 * For sorted elements, we use this function to perform traversing search (replacement for next, prev, nextAll, prevAll, nextUntil, prevUntil)
		 */
		find_from_elements: function ($els, from, filter, reverse, until) {
			var index = $els.index($(from)),
				find_from = reverse ? _.first($els, index).reverse() : _.rest($els, index+1),
				finish = false,
				is_filter_cb = filter && _.isFunction(filter),
				is_until_cb = until && _.isFunction(until)
			;
			return $(_.filter(find_from, function(el){
				if ( finish ) return false;
				if ( ( is_filter_cb && filter($(el), $els) ) || ( !is_filter_cb && $(el).is(filter) ) ){
						if ( until && ( ( is_until_cb && until($(el), $els) ) || ( !is_until_cb && $(el).is(until) ) ) ){
								finish = true;
								return false;
						}
						return true;
				}
				return false;
			}));
		},

		// Crossbrowser requestAnimationFrame
		requestAnimationFrame:
			$.proxy(window.requestAnimationFrame, window) ||
			$.proxy(window.webkitRequestAnimationFrame, window) ||
			$.proxy(window.mozRequestAnimationFrame, window) ||
			$.proxy(window.oRequestAnimationFrame, window) ||
			$.proxy(window.msRequestAnimationFrame, window) ||
			rAFPollyfill,

		/* JS - PHP compatible templates */
		template: function(markup){
			var oldSettings = _.templateSettings,
				tpl = false;

			_.templateSettings = {
				interpolate : /<\?php echo (.+?) \?>/g,
				evaluate: /<\?php (.+?) \?>/g
			};

			tpl = _.template(markup);

			_.templateSettings = oldSettings;

			return function(data){
				_.each(data, function(value, key){
					data['$' + key] = value;
				});

				return tpl(data);
			};
		},

		Transient: {

			// Local storage object, or the in-memory queue
			_memory_queue: {},

			_key: window.location.path + window.location.search,

			initialize: function () {
				/*try {
					if ('sessionStorage' in window && window['sessionStorage'] !== null) this._memory_queue = sessionStorage;
				} catch (e) {
					Util.log("No local storage available, working off memory");
				}*/
				if (!Upfront.Settings.Debug.transients) this._memory_queue[this._key] = JSON.stringify({});
			},

			get_current: function () {
				return (this._memory_queue[this._key] ? JSON.parse(this._memory_queue[this._key]) : {});
			},

			length: function (key) {
				var data = this.get(key);
				return data.length;
			},

			set: function (key, value) {
				var current = this.get_current();
				current[key] = Util.model_to_json(value);
				this._memory_queue[this._key] = JSON.stringify(current);
			},

			get: function (key) {
				var current = this.get_current(),
					raw = current[key] || false
				;
				return raw;// ? JSON.parse(raw) : false;
			},

			get_all: function (prefix) {
				var key_rx = (prefix ? new RegExp(prefix) : false),
					data = [],
					history = (this._memory_queue[this._key] ? JSON.parse(this._memory_queue[this._key]) : false)
				;
				if (history) _(history).each(function (obj, key) {
					if (key_rx && !key.match(key_rx)) return true;
					data = obj;
				});
				return data;
			},

	// ----- Stack-like interface (for history) -----

			push: function (key, value) {
				var items = this.get(key) || [];
				items.push(value);
				return this.set(key, items);
			},

			pop: function (key) {
				var items = this.get(key) || [],
					item = items && items.pop ? items.pop() : false
				;
				this.set(key, items);
				return item;

			}
		},
		date : {
			php_format_to_jquery :  function(php_format)
			{
				var SYMBOLS_MATCHING = {
					// Day
					'd': 'dd',
					'D': 'D',
					'j': 'd',
					'l': 'DD',
					'N': '',
					'S': '',
					'w': '',
					'z': 'o',
					// Week
					'W': '',
					// Month
					'F': 'MM',
					'm': 'mm',
					'M': 'M',
					'n': 'm',
					't': '',
					// Year
					'L': '',
					'o': '',
					'Y': 'yy',
					'y': 'y',
					// Time
					'a': '',
					'A': '',
					'B': '',
					'g': '',
					'G': '',
					'h': '',
					'H': '',
					'i': '',
					's': '',
					'u': ''
				};
				jqueryui_format = "";
				escaping = false;
				for( var i = 0; i < php_format.length; i++)
				{
					char = php_format[i];
					if(char === '\\') // PHP date format escaping character
					{
						i++;
						if(escaping) jqueryui_format += php_format[i];
						else jqueryui_format += '\'' + php_format[i];
						escaping = true;
					}
					else
					{
						if(escaping) { jqueryui_format += "'"; escaping = false; }
						if( _.isUndefined(SYMBOLS_MATCHING[char])){
								jqueryui_format += char;
						}else{
								jqueryui_format += SYMBOLS_MATCHING[char];
						}

					}
				}
				return jqueryui_format;

			},
			php_format_to_js :  function(php_format)
			{
				var SYMBOLS_MATCHING = {
					// Day
					'd': 'dd',
					'D': 'D',
					'j': 'd',
					'l': 'DD',
					'N': '',
					'S': '',
					'w': '',
					'z': 'o',
					// Week
					'W': '',
					// Month
					'F': 'MMMM',
					'm': 'mmmm',
					'M': 'M',
					'n': 'm',
					't': '',
					// Year
					'L': '',
					'o': '',
					'Y': 'yyyy',
					'y': 'y',
					// Time
					'a': '',
					'A': '',
					'B': '',
					'g': '',
					'G': '',
					'h': '',
					'H': '',
					'i': '',
					's': '',
					'u': ''
				};
				jqueryui_format = "";
				escaping = false;
				for( var i = 0; i < php_format.length; i++)
				{
					char = php_format[i];
					if(char === '\\') // PHP date format escaping character
					{
						i++;
						if(escaping) jqueryui_format += php_format[i];
						else jqueryui_format += '\'' + php_format[i];
						escaping = true;
					}
					else
					{
						if(escaping) { jqueryui_format += "'"; escaping = false; }
						if( _.isUndefined(SYMBOLS_MATCHING[char])){
								jqueryui_format += char;
						}else{
								jqueryui_format += SYMBOLS_MATCHING[char];
						}

					}
				}
				return jqueryui_format;
			}
		},
		colors: {
			to_color_value: function (str) {
				if (Upfront.Util.colors.is_theme_color(str)) return Upfront.Util.colors.get_color(str);
				return str;
			},
			is_theme_color: function (str) {
				if (!str || !str.match) return false;
				return !!str.match(/^#?ufc\d+$/);
			},
			get_ufc: function(color){
				if(_.isEmpty(color)) return false;
				color = tinycolor(color);
				var	theme_colors = Upfront.Views.Theme_Colors.colors.pluck("color"),
					this_ufc;

				for(var _i in theme_colors){
					if( theme_colors[_i].replace("#", "") === color.toHex() ){
						this_ufc = "ufc" + _i;
					}
				}
				return this_ufc;
			},

			get_color: function(ufc){
				if(_.isEmpty(ufc)) return false;

                var theme_colors = Upfront.Views.Theme_Colors.colors.pluck("color"),
                    theme_alphas = Upfront.Views.Theme_Colors.colors.pluck("alpha"),
                    color_index = parseInt(ufc.replace("ufc", "").replace("#", ""), 10),
                    theme_color = theme_colors[color_index] === '#000000' && theme_alphas[color_index] === 0 ? 'inherit' : theme_colors[color_index];

                return theme_color;
			},
			/**
			 * Looks for ufc instances in a string and replaces them with actual color
			 *
			 * */
			convert_string_ufc_to_color: function( string, include_ufc_as_comment ){
				if(_.isEmpty(string)) return string;
				include_ufc_as_comment = typeof include_ufc_as_comment === "undefined" ? true : include_ufc_as_comment;
                var theme_colors = Upfront.Views.Theme_Colors.colors.pluck("color"),
                    theme_alphas = Upfront.Views.Theme_Colors.colors.pluck("alpha");
				for(var _i in theme_colors){
					var pattern = new RegExp("#ufc" + _i,"g"),
                        theme_color;
                    theme_color = theme_colors[_i] === '#000000' && theme_alphas[_i] === 0 ? 'inherit' : theme_colors[_i];
                    theme_color = include_ufc_as_comment ? "/*" + "#ufc" + _i + "*/" + theme_color : theme_color;
					string = string.replace(pattern, theme_color );
				}
				return string;
			},
			/**
			 * Removes #ufc{x} from given string
			 * */
			remove_ufcs: function( string ){
				var	theme_colors = Upfront.Views.Theme_Colors.colors.pluck("color");
				for(var _i in theme_colors){
					var pattern = new RegExp( "/\\*#ufc" + _i + "\\*/" + theme_colors[_i],"g"),
						theme_color = theme_colors[_i];
					string = string.replace(pattern, theme_color );
				}
				return string;
			},
			/**
			 * Converts all theme color codes to ufc in the given string
			 * */
			convert_string_color_to_ufc: function( string ){
				var	theme_colors = Upfront.Views.Theme_Colors.colors.pluck("color");
				for(var _i in theme_colors){
					var pattern = new RegExp("/\\*#ufc" + _i + "\\*/" + theme_colors[_i],"gi"),
						ufc = "#ufc" + _i;
					string = string.replace(pattern, ufc );
				}
				return string;
			},
			/**
			 * Updates all the theme colors in the DOM according to the given color and color_index
			 *
			 * @var prev_color string color hex
			 * @var color string color hex
			 * @var color_index theme color index
			 * */
			update_colors_in_dom: function(prev_color, color, color_index){
				var regex = new RegExp("/\\*#ufc" + color_index + "\\*/#(?:[0-9a-fA-F]{3}){1,2}","gi"),
					container = document.getElementsByTagName("html")[0],
					replacement = "/*#ufc" + color_index +"*/" + color,
				finder = findAndReplaceDOMText(container , {
					find:  regex,
					replace: function(portion, match){
						return replacement;
					}
				} );
				$(".upfront-plain_txt > p").each(function(){
					var $this = $(this),
						html = $this.html();
					$this.html(  html.replace( regex,  replacement) );
				});

				var elements_with_ufc_data = $("*").filter(function(){
					return $(this).data("ufc");
				});

				$(elements_with_ufc_data).each(function(){
					var $this = $(this),
						ufc = $this.data("ufc"),
						ufc_rule = $this.data("ufc_rule");
						$this.css(ufc_rule, ufc);

				});
				return finder;
			},
			/**
			 * Updates wrong combinations of ufc and hex color so that the ufc and hex match
			 *
			 * It may be times where ufc is correct but the hex value is expired, this function updates the string
			 * so that these two match
			 *
			 * */
			update_colors_to_match_ufc: function(color_string){
				var	theme_colors = Upfront.Views.Theme_Colors.colors.pluck("color");
				for(var _i in theme_colors){
					var pattern = new RegExp("/\\*#ufc" + _i + "\\*/#(?:[0-9a-fA-F]{3}){1,2}","gi"),
						theme_color = "/*" + "#ufc" + _i + "*/" + theme_colors[_i];
					color_string = color_string.replace(pattern, theme_color );
				}
				return color_string;
			}
		},
		guessLinkType: guessLinkType,
		visitLink: function(url) {
			var linktype = guessLinkType(url),
				regions,
				lightbox,
				regionview,
				selector;

			if (linktype === 'lightbox') {
				regions = Upfront.Application.layout.get('regions');
				lightbox = regions ? regions.get_by_name(url.substring(1)) : false;
				if (lightbox) {
					// Hide other lightboxes
					_.each(regions.models, function(model) {
						if(model.attributes.sub == 'lightbox')
						Upfront.data.region_views[model.cid].hide();
					});

					regionview = Upfront.data.region_views[lightbox.cid];
					regionview.show();
				}
			} else if (linktype == 'anchor') {
				selector = url.replace(/^.*?#/, '#');
				if ($(selector).length > 0) {
					$('html,body').animate({scrollTop: $(selector).offset().top},'slow');
				} else {
					console.log('obselete anchor');
				}
			}
			else if (linktype == 'entry') {
				window.location.href = url.replace('&editmode=true', '').replace('editmode=true', '')+((url.indexOf('?')>0)?'&editmode=true':'?editmode=true');
			} else {
				window.open(url);
			}
		},
		checkLightbox: function(url) {
			regions = Upfront.Application.layout.get('regions');
				lightbox = regions ? regions.get_by_name(url.substring(1)) : false;
				if (lightbox) {
					return true;
				}
				else
					return false;
		}
	};

	var Popup = {

		$popup: {},
		$background: {},
		_deferred: {},

		init: function () {
			if (!$("#upfront-popup").length) {
				$("#page")
					.append('<div id="upfront-popup" class="upfront-ui" style="display:none">' +
						'<div id="upfront-popup-close" class="upfront-icon upfront-icon-popup-close">&times;</div>' +
						'<div class="upfront-popup-meta" id="upfront-popup-top">' +
						'</div>' +
						'<div id="upfront-popup-content"></div>' +
						'<div class="upfront-popup-meta" id="upfront-popup-bottom">' +
						'</div>' +
					'</div>')
					.append("<div id='upfront-popup-background' style='display:none' />")
				;
			} else {
				this.close();
			}
			this.$popup = $("#upfront-popup");
			this.$background = $("#upfront-popup-background");

			this.$popup.find("#upfront-popup-content").empty();
		},

		open: function (callback, data, classname) {
				data = data || {};
				this.data = data;
				classname = classname || 'default-popup';
				this.init();
				var me = this,
						sidebarWidth = $('#sidebar-ui').width(),
						$win = $(window),
						width = data.width || 630,
						left_pos = ($win.width() - width) / 2 + sidebarWidth / 2,
						height = ($win.height() / 3) * 2,
						close_func = function () {
							$("#upfront-popup").attr('class', 'upfront-ui');
							me.close();
							return false;
						}
				;
				
				$('body').bind( 'keyup', function( event ) {
					if ( event.keyCode === 27 )
						me.close();
				});

				// data.width = width, data.height = height;
				this.$background
					// .css({
					// 	'height': $win.height(),
					// 	'width': $win.width() - sidebarWidth,
					// 	'left': sidebarWidth
					// })
					.on("click", close_func)
					.show()
				;
				this.$popup
					// .css({
					// 	'width': width,
					// 	'height': height,
					// 	'left': sidebarWidth
					// })
					.show()
					.find("#upfront-popup-close").on("click", close_func).end()
				;
				if ( classname ) {
					this.$popup
						.addClass(classname)
						.data("classname", classname)
					;
				}

				$('body').addClass('upfront-popup-open');
				/*
				$win.off("resize.upfront-popup").on("resize.upfront-popup", function () {
						if (me.$background.is(":visible")) {
							me.$background
								.css({
									'height': $win.height(),
									'width': $win.width() - sidebarWidth,
									'left': sidebarWidth
								})
							;
						}
						if (me.$popup.is(":visible")) {
							var left_pos = ($win.width() - width) / 2 + sidebarWidth / 2,
								height = ($win.height() / 3) * 2
							;
							me.$popup
								.css({
									'width': width,
									'height': height,
									'left': left_pos
								})
							;
						}
				});
			*/

				callback.apply(this.$popup.find("#upfront-popup-content").get(), [data, this.$popup.find("#upfront-popup-top"), this.$popup.find("#upfront-popup-bottom")]);
				this._deferred = new $.Deferred();
				return this._deferred.promise();
		},

		close: function (result) {
			if(this.data.hold_editor)
				this._deferred.notify('dont_close');
			else
				this._deferred.notify('before_close');

			this.$background.hide();
			this.$popup.hide().find("#upfront-popup-content").empty();

			this.$popup.find("#upfront-popup-top").empty();
			this.$popup.find("#upfront-popup-bottom").empty();

			$('body').removeClass('upfront-popup-open');

			// Clean up the passed classname
			var classname = this.$popup.data("classname");
			if (classname) {
				this.$popup.removeClass(classname);
			}

			Upfront.Events.trigger('popup:closed');
			
			this._deferred.resolve(this.$popup, result);
		}

	};

	var PreviewUpdate = function () {
		var _layout_data = false,
			_layout = false,
			_saving_flag = false,
			_is_dirty = false,
			_preview_url = false,
			_revision_idx = false,
			run = function (layout) {
				if (!!Upfront.Settings.Application.PERMS.REVISIONS) { // Only rebind stuff when revisions listening is enabled.
					if (Upfront.Application.mode.current === Upfront.Application.MODE.THEME) {
						// Exporter mode
						rebind_exporter_events();
					} else {
						// Normal mode
						_layout = layout;
						rebind_events();
					}
				}
				// Bind beforeunload event listener
				window.onbeforeunload = warn;
			},
			/**
			 * Exporter events don't send out the preview saves, just manipulate flag directly.
			 */
			rebind_exporter_events = function () {
				Upfront.Events.off("entity:region:deactivated", exporter_set_dirty);
				Upfront.Events.off("entity:settings:deactivate", exporter_set_dirty);
				Upfront.Events.off("entity:removed:after", exporter_set_dirty);
				Upfront.Events.off("entity:resize_start", exporter_set_dirty);
				Upfront.Events.off("entity:drag_stop", exporter_set_dirty);
				Upfront.Events.off("entity:module:after_render", exporter_set_dirty);
				Upfront.Events.off("upfront:element:edit:stop", exporter_set_dirty);

				Upfront.Events.on("entity:region:deactivated", exporter_set_dirty, this);
				Upfront.Events.on("entity:settings:deactivate", exporter_set_dirty, this);
				Upfront.Events.on("entity:removed:after", exporter_set_dirty, this);
				Upfront.Events.on("entity:resize_start", exporter_set_dirty, this);
				Upfront.Events.on("entity:drag_stop", exporter_set_dirty, this);
				Upfront.Events.on("entity:module:after_render", exporter_set_dirty, this);
				Upfront.Events.on("upfront:element:edit:stop", exporter_set_dirty, this);

				Upfront.Events.off("command:layout:export_theme", clear);
				Upfront.Events.on("command:layout:export_theme", clear);
			},
			exporter_set_dirty = function () {
				_is_dirty = true;
			}
			rebind_events = function(){
				var me = this;
				Upfront.PreviewUpdate.__deferred_save_callback = Upfront.PreviewUpdate.__deferred_save_callback || _.debounce(save, 200);

				//Upfront.Events.off("entity:region:deactivated", save);
				//Upfront.Events.off("entity:settings:saved", save);
				//Upfront.Events.off("entity:module:after_render", save);

				//Upfront.Events.on("entity:region:deactivated", save, this);
				//Upfront.Events.on("entity:settings:saved", save, this);
				//Upfront.Events.on("entity:module:after_render", save, this);

				Upfront.Events.off("entity:removed:after", Upfront.PreviewUpdate.__deferred_save_callback);
				Upfront.Events.off("entity:resize_start", Upfront.PreviewUpdate.__deferred_save_callback);
				Upfront.Events.off("entity:drag_stop", Upfront.PreviewUpdate.__deferred_save_callback);
				Upfront.Events.off("upfront:element:edit:stop", Upfront.PreviewUpdate.__deferred_save_callback);

				Upfront.Events.on("entity:removed:after", Upfront.PreviewUpdate.__deferred_save_callback, this);
				Upfront.Events.on("entity:resize_start", Upfront.PreviewUpdate.__deferred_save_callback, this);
				Upfront.Events.on("entity:drag_stop", Upfront.PreviewUpdate.__deferred_save_callback, this);
				Upfront.Events.on("upfront:element:edit:stop", Upfront.PreviewUpdate.__deferred_save_callback, this);

				Upfront.Events.off("model:property:add", Upfront.PreviewUpdate.__deferred_save_callback);
				Upfront.Events.off("model:property:set", Upfront.PreviewUpdate.__deferred_save_callback);

				Upfront.Events.on("model:property:add", Upfront.PreviewUpdate.__deferred_save_callback, this);
				Upfront.Events.on("model:property:set", Upfront.PreviewUpdate.__deferred_save_callback, this);

				Upfront.Events.off("entity:region:deactivated", Upfront.PreviewUpdate.__deferred_save_callback, this);
				Upfront.Events.on("entity:region:deactivated", Upfront.PreviewUpdate.__deferred_save_callback, this);
				
				//Upfront.Events.off("model:property:remove", save);
				//Upfront.Events.on("model:property:remove", save, this);

				Upfront.Events.off("command:layout:save_success", clear);
				Upfront.Events.on("command:layout:save_success", clear);
			},
			set_data = function () {
				_layout_data = Upfront.Util.model_to_json(_layout);
				if (_layout_data && _layout_data.regions) _layout_data.regions = _(_layout_data.regions).reject(function (reg) { return reg.name === "shadow"; });
				_layout_data.layout = _upfront_post_data.layout;
				_layout_data.preferred_layout = _layout.get("current_layout");

				//_layout_data = JSON.stringify(_layout_data, undefined, 2);
				_layout_data = JSON.stringify(_layout_data);
			},
			save = function () {
				if (_saving_flag) return false;

				_saving_flag = true;
				_is_dirty = true;
				set_data();

				Upfront.Events.trigger("preview:build:start");
				Upfront.Util.post({action: "upfront_build_preview", "data": _layout_data, "current_url": window.location.href})
					.success(function (response) {
						var data = response.data || {};
						if ("html" in data && data.html) {
							_preview_url = data.html;
							_revision_idx = data.idx;
						} else {
							Upfront.Util.log("Invalid response");
						}
						_saving_flag = false;
						Upfront.Events.trigger("preview:build:stop");
						//Upfront.Util.log("we're good here");

						// Notify about concurrent edits
						if ("concurrent_users" in data && data.concurrent_users && _.size(data.concurrent_users)) {
							var users = _.values(data.concurrent_users).join(', ');
							Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.views.already_edited_nag.replace(/%s/, users), 'error');
						}
					})
					.error(function () {
						Upfront.Util.log("error building layout preview");
					})
				;

				run(_layout);
			},
			clear = function () {
				_is_dirty = false; // Clear dirty flag, we just saved changes
			},
			warn = function (e) {
				var e = e || window.event,
					going = Upfront.Settings.l10n.global.views.unsaved_changes_nag
				;
				if (!_saving_flag && !_is_dirty) return; // No changes
				if (e) e.returnValue = going;
				return going;
			},
			get_preview_url = function () {
				return _preview_url;
			},
			get_revision = function () {
				return _revision_idx;
			}
		;
		return {
			run: run,
			preview_url: get_preview_url,
			get_revision: get_revision,
			rebind_events: rebind_events
		}

	};

	return {
		Util: Util,
		Popup: Popup,
		PreviewUpdate: new PreviewUpdate()
	};
});
})(jQuery);

// Set up the global namespace
var Upfront = window.Upfront || {};
Upfront.mainData = Upfront.mainData || {};
Upfront.Events = {};

// Fix to use the already loaded jquery as dependency
define('jquery', [], function(){
	return jQuery;
});

require.config(Upfront.mainData.requireConfig);

require(['backbone'], function (Backbone) {
	// Fix Underscore templating to Mustache style
	_.templateSettings = {
		evaluate : /\{\[([\s\S]+?)\]\}/g,
		interpolate : /\{\{([\s\S]+?)\}\}/g
	};
	require(['application', 'util'], function (application, util) {
		// Shims and stubs
		_.extend(Upfront.Events, Backbone.Events);
		Upfront.Settings = {
			"ace_url": "//cdnjs.cloudflare.com/ajax/libs/ace/1.1.01/ace.js",
			"root_url": Upfront.mainData.root,
			"ajax_url": Upfront.mainData.ajax,
			"admin_url": Upfront.mainData.admin,
			"site_url": Upfront.mainData.site,
			"Debug": Upfront.mainData.debug,
			"ContentEditor": {
			"Requirements": Upfront.mainData.layoutEditorRequirements,
			"Selectors": {
				"sidebar": "#sidebar-ui"
				}
			},
			"Application": {
				"MODE": Upfront.mainData.applicationModes,
				"NO_SAVE": Upfront.mainData.readOnly,
				"DEBUG": false,
				"PERMS": Upfront.mainData.PERMS
			},
			"LayoutEditor": {
				"Requirements": Upfront.mainData.layoutEditorRequirements,
				"Selectors": {
					"sidebar": "#sidebar-ui",
					"commands": "#commands",
					"properties": "#properties",
					"layouts": "#layouts",
					"settings": "#settings",
					"contextmenu": "#contextmenu",
					//"main": "#upfront-output"
					"main": "#page"
				},
				"Specificity": Upfront.mainData.specificity,
				"Grid": Upfront.mainData.gridInfo,
				'Theme': Upfront.mainData.themeInfo
			},
			"Content": Upfront.mainData.content,
			"l10n": Upfront.mainData.l10n
		};

		if (window._upfront_debug_mode) {
			Upfront.Settings.Application.DEBUG = true;
			Upfront.Settings.Application.NO_SAVE = true;
		}

		// Populate basics
		_.extend(Upfront, application);
		_.extend(Upfront, util);
		Upfront.Util.Transient.initialize();

		// Set up deferreds
		Upfront.LoadedObjectsDeferreds = {};
		Upfront.Events.trigger("application:loaded:layout_editor");

		if (Upfront.Application && Upfront.Application.boot) Upfront.Application.boot();
		else Upfront.Util.log('something went wrong');

	}); // Upfront
});

define("main", function(){});

