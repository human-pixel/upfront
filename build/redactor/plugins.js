(function(e){var t=["text!scripts/redactor/ueditor-templates.html"];define("redactor_plugins",t,function(t){var n=_.extend({},Backbone.Events),r=Backbone.View.extend({initialize:function(e){var t=this;t.redactor=e.redactor,t.button=e.button,t.panel=e.panel,this.on("open",function(e){console.log("Panel open"),t.$el.trigger("open",e)}),this.on("closed",function(e){console.log("Panel closed"),t.$el.trigger("closed",e)}),typeof this.init=="function"&&this.init(),this.render()},openToolbar:function(e){var t=this},closeToolbar:function(){this.redactor.$air.fadeOut(100),this.redactor.dropdown.hideAll(),this.$el.trigger("toolbarClosed",this.redactor)},closePanel:function(){this.panel.is(":visible")&&this.button.click()},disableEditorStop:function(){this.redactor.ueditor.disableStop=!0},enableEditorStop:function(){var e=this;setTimeout(function(){e.redactor.ueditor.disableStop=!1},300)},appendOkButton:function(t){var n=this;if(!n.$el.siblings(".ueditor-ok").length){t=t||"Ok";var r=e('<a class="ueditor-ok">'+t+"</a>").on("click",function(e){n.$el.trigger("ok")});r.insertAfter(n.$el)}}});if(!i)var i={};return i.stateButtons=function(){return{init:function(){this.$air=this.$toolbar.closest(".redactor_air"),this.stateButtons.addStateButtons(),this.stateButtons.startStateObserver()},addStateButtons:function(){var t=this;e.each(this.opts.stateButtons,function(n,r){if(e.inArray(n,t.opts.airButtons)!==-1){var i=new t.stateButtons.StateButton(n,r),s=t.button.add(n,r.title);t.button.addCallback(s,function(){t.stateButtons.stateCallback(n,i)}),t.$air.on("show",function(){i.guessState(t)})}})},stateCallback:function(e,t){t.guessState(this),t.callback(e,this.button.get(e),t)},startStateObserver:function(){var t=e.proxy(this.stateObserver,this);this.$element.on("mouseup.redactor keyup.redactor",t)},stateObserver:function(){var t=this;e.each(this.stateButtons.stateButtons,function(e,n){n.guessState(t)}),t.waitForMouseUp=!1},StateButton:function(t,n){var r=this,i={},s=!1;return firstState=!1,r.id=t,r.currentState=n.defaultState,r.states=n.states,r.iconClasses="",r.defaultState=n.defaultState,e.each(r.states,function(e,t){s?i[s]=e:firstState=e,r.iconClasses+=" "+t.iconClass,s=e}),i[s]=firstState,r.nextStates=i,r.nextState=function(e){this.setState(r.nextStates[this.currentState],e)},r.setState=function(e,t){this.currentState=e,t.removeClass(this.iconClasses).addClass(this.states[this.currentState].iconClass)},r.triggerState=function(t,n,r,i){var s=e.proxy(this.states[this.currentState].callback,t);s(n,r,i)},r.guessState=function(t){var n=!1;e.each(this.states,function(e,r){n=r.isActive(t)?e:n}),n||(n=this.defaultState),this.setState(n,t.button.get(this.id))},r.getElement=function(e){return e.button.get(this.id)},{id:t,title:n.title,callback:function(e,t,n){n.nextState(t),n.triggerState(this,e,t,n)},nextState:e.proxy(r.nextState,r),setState:e.proxy(r.setState,r),triggerState:e.proxy(r.triggerState,r),guessState:e.proxy(r.guessState,r)}}}},i.stateAlignment=function(){return{init:function(){var t=this;this.opts.stateButtons.stateAlign={title:"Text alignment",defaultState:"left",states:{left:{iconClass:"ueditor-left",isActive:function(t){var n=e(t.selection.getBlock());return n.length&&n[0].nodeType==3&&(n=n.parent()),n.length&&n.css("text-align")=="left"},callback:function(e,n,r){t.alignment.left()}},center:{iconClass:"ueditor-center",isActive:function(t){var n=e(t.selection.getBlock());return n.length&&n[0].nodeType==3&&(n=n.parent()),n.length&&n.css("text-align")=="center"},callback:function(e,n,r){t.alignment.center()}},right:{iconClass:"ueditor-right",isActive:function(t){var n=e(t.selection.getBlock());return n.length&&n[0].nodeType==3&&(n=n.parent()),n.length&&n.css("text-align")=="right"},callback:function(e,n,r){t.alignment.right()}},justify:{iconClass:"ueditor-justify",isActive:function(t){var n=e(t.selection.getBlock());return n.length&&n[0].nodeType==3&&(n=n.parent()),n.length&&n.css("text-align")=="justify"},callback:function(e,n,r){t.alignment.justify()}}}}}}},i.stateAlignmentCTA={beforeInit:function(){var e=this;this.opts.stateButtons.stateAlignCTA={title:"Text alignment",defaultState:"left",states:{left:{iconClass:"ueditor-left",isActive:function(t){return e.$element.length&&e.$element.css("text-align")=="left"},callback:function(t,n,r){e.$element.css("text-align","left")}},center:{iconClass:"ueditor-center",isActive:function(t){return e.$element.length&&e.$element.css("text-align")=="center"},callback:function(t,n,r){e.$element.css("text-align","center")}},right:{iconClass:"ueditor-right",isActive:function(t){return e.$element.length&&e.$element.css("text-align")=="right"},callback:function(t,n,r){e.$element.css("text-align","right")}},justify:{iconClass:"ueditor-justify",isActive:function(t){return e.$element.length&&e.$element.css("text-align")=="justify"},callback:function(t,n,r){e.$element.css("text-align","justify")}}}}}},i.stateLists=function(){return{init:function(){var t=this;this.opts.stateButtons.stateLists={title:"List style",defaultState:"none",states:{none:{iconClass:"ueditor-nolist",isActive:function(t){var n=e(t.selection.getParent());return n.length&&n.css("text-align")=="left"},callback:function(e,n,r){t.list.toggle("orderedlist")}},unordered:{iconClass:"ueditor-unorderedlist",isActive:function(t){var n=e(t.selection.getParent());if(n.length){var r=n.closest("ul");if(r.length)return r.closest(".ueditable").length}return!1},callback:function(e,n,r){t.list.toggle("unorderedlist")}},ordered:{iconClass:"ueditor-orderedlist",isActive:function(t){var n=e(t.selection.getParent());if(n.length){var r=n.closest("ol");if(r.length)return r.closest(".ueditable").length}return!1},callback:function(e,n,r){t.list.toggle("orderedlist")}}}}}}},i.upfrontImages={beforeInit:function(){var t=this;t.events.on("ueditor:stop",function(){ImagesHelper.Image.unbind_events()}),t.events.on("ueditor:insert:media",function(){ImagesHelper.Gallery.to_html(t),ImagesHelper.Slider.to_html(t)}),ImagesHelper.Image.redactor=t,ImagesHelper.Image.create_dialog(),ImagesHelper.Image.bind_events(),Upfront.Media.Transformations.add(ImagesHelper.Image.cleanup),Upfront.Media.Transformations.add(ImagesHelper.Gallery.from_html),Upfront.Media.Transformations.add(ImagesHelper.Slider.from_html),Upfront.Events.on("upfront:editor:image_align",function(t,n){var r=!1;"left"===n?r="margin-right":"right"===n&&(r="margin-left");if(!r)return!1;e(t).css(r,"15px")})}},i.upfrontSink={beforeInit:function(){var e=this;Upfront.data.ueditor||(Upfront.data.ueditor={sink:!1}),this.opts.buttonsCustom.upfrontSink={title:"More tools"}},init:function(){var t=this,n=this.$toolbar.find(".redactor_btn_upfrontSink").parent().addClass("upfront-sink-button"),r=this.$toolbar.find(".upfront-sink-button ~ li"),i=e('<div class="ueditor-sink"></div>');n.on("click",function(){Upfront.data.ueditor.sink?t.closeSink():t.openSink()}),r.detach().appendTo(i),this.$toolbar.append(i),Upfront.data.ueditor.sink&&this.$toolbar.addClass("ueditor-sink-open"),r.each(function(){var n=e(this).find("a").attr("class").match(/redactor_btn_[^\s]*/g),r=!1,i=!1;n.length&&(r=n[0].replace("redactor_btn_","")),i=t.$toolbar.find(".redactor-dropdown-box-"+r),i.length&&i.css({"margin-top":"40px"})}),this.$air.on("show",function(){Upfront.data.ueditor.sink&&t.$air.css({top:t.$air.offset().top-40})})},openSink:function(){Upfront.data.ueditor.sink=!0,this.$toolbar.addClass("ueditor-sink-open"),this.$air.css({top:this.$air.offset().top-40})},closeSink:function(){Upfront.data.ueditor.sink=!1,this.$toolbar.removeClass("ueditor-sink-open"),this.$air.css({top:this.$air.offset().top+40})}},i.upfrontPlaceholder={init:function(){var t=this.placeholderText;this.$element.attr("placeholder")&&(t=this.$element.attr("placeholder")),t===""&&(t=!1);if(t!==!1){this.placeholderRemoveFromEditor(),this.$placeholder=this.$editor.clone(!1),this.$placeholder.attr("contenteditable",!1).removeClass("ueditable redactor_editor").addClass("ueditor-placeholder").html(this.opts.linebreaks?t:this.cleanParagraphy(t)),this.$editor.after(this.$placeholder),this.$editor.css("position")=="static"&&this.$editor.css("position","relative"),this.$editor.css("z-index",1);var n=this.$editor.position();this.$placeholder.css({position:"absolute","z-index":"0",top:n.top,left:n.left,right:this.$box.outerWidth()-(n.left+this.$editor.outerWidth())}),this.opts.placeholder=t,this.$editor.on("focus keyup",e.proxy(this.placeholderUpdate,this)),this.placeholderUpdate()}},placeholderUpdate:function(){this.code.sync();var e=this.get();e==""?this.$placeholder.show():this.$placeholder.hide()}},i.panelButtons=function(){return{init:function(){var t=this;e.each(this.opts.buttonsCustom,function(n,r){if(r.panel){var i=e('<div class="redactor-dropdown ueditor_panel redactor-dropdown-box-'+n+'" style="display: none;">'),s=t.button.get(n);r.panel=new r.panel({redactor:t,button:s,panel:i}),i.html(r.panel.$el),i.appendTo(t.$toolbar),r.dropdown=!0,s.on("click",function(){s.hasClass("dropact")?(t.selection.removeMarkers(),r.panel.trigger("open",t)):r.panel.trigger("closed",t)}),t.$editor.on("mouseup.redactor keyup.redactor",function(){s.hasClass("dropact")&&(t.dropdownHideAll(),r.panel.trigger("closed",t))}),i.on("click keydown keyup",function(e){e.stopPropagation()});if(e.inArray(n,t.opts.airButtons)===-1)return;var o=t.button.add(n,r.title);t.button.addCallback(o,function(){var s=t.button.get(n),o=s.position().left;e(".re-icon").removeClass("redactor_act dropact"),s.addClass("redactor_act dropact"),e(".redactor-dropdown").not(i).hide(),i.css("left",o+"px").toggle(),i.is(":visible")&&typeof r.panel.open=="function"?r.panel.open.apply(r.panel,[jQuery.Event("open"),t]):typeof r.panel.close=="function"&&r.panel.close.apply(jQuery.Event("close"),[e.Event,t]);var u=e(".redactor-dropdown.ueditor_panel").last(),a=o-u.innerWidth()+s.width();u.css("left",a+"px")})}})}}},i.upfrontIcons=function(){return{$sel:!1,init:function(){this.opts.buttonsCustom.upfrontIcons={title:"Icons",panel:this.upfrontIcons.panel},n.on("ueditor:key:down",function(t,n){if(e(t.selection.getParent()).hasClass("uf_font_icon")||e(t.selection.getCurrent()).hasClass("uf_font_icon"))n.keyCode<48||n.keyCode>90||n.preventDefault()})},panel:r.extend(_.extend({},Upfront.Views.Mixins.Upfront_Scroll_Mixin,{$sel:!1,tpl:_.template(e(t).find("#font-icons").html()),events:{"click .ueditor-font-icon":"insert_icon",open:"open",toolbarClosed:"close","change .upfront-font-icons-controlls input":"input_change"},render:function(e){this.$el.html(this.tpl()),this.stop_scroll_propagation(this.$el)},open:function(e,t){this.redactor=t,this.redactor.selection.restore(),this.redactor.buffer.set(),this.redactor.selection.save(),this.set_current_icon(),this.$el.parent().css({left:193})},close:function(){console.log("closing close panel"),this.redactor&&(this.redactor.selection.restore(),this.$sel=!1)},insert_icon:function(t){var n=e(e(t.target).hasClass("ueditor-font-icon")?e(t.target).html():e(t.target).closest(".ueditor-font-icon").html()),r=this.$(".font-icons-size").val(),i=this.$(".font-icons-top").val();n.css({"font-size":r+"px",top:i+"px"}),this.redactor.insert.html(n[0].outerHTML,!0),this.redactor.code.sync(),this.redactor.selection.restore(),this.closeToolbar()},input_change:function(t){var n=this.$sel;t.stopPropagation(),t.preventDefault();var r=e(t.target),i=r.val()+"px";r.hasClass("font-icons-size")&&n.css("font-size",i),r.hasClass("font-icons-top")&&n.css("top",i),self.redactor.code.sync()},set_current_icon:function(){var t=e(this.redactor.selection.getCurrent()).last(),n=this;t.hasClass("uf_font_icon")||(t=e(this.redactor.selection.getInlines()).filter(".uf_font_icon").last()),t.hasClass("uf_font_icon")&&(this.$sel=t,this.$(".font-icons-size").val(parseFloat(t.css("font-size"))),this.$(".font-icons-top").val(parseFloat(t.css("top"))))}}))}},i.upfrontLink=function(){return{init:function(){this.opts.buttonsCustom.upfrontLink={title:"Link",panel:this.upfrontLink.panel}},openPanel:function(){var t=this.button.get("link").position().left;e(".redactor-dropdown-box-upfrontLink").css("left",t+"px").toggle()},panel:r.extend({tpl:_.template(e(t).find("#link-tpl").html()),events:{open:"open"},initialize:function(){this.linkPanel=new Upfront.Views.Editor.LinkPanel({button:!0}),this.bindEvents(),r.prototype.initialize.apply(this,arguments)},render:function(e){e=e||{},this.linkPanel.model.set({url:e.url,type:e.link||this.guessLinkType(e.url)}),this.linkPanel.render(),this.$el.html(this.linkPanel.el),this.linkPanel.delegateEvents()},open:function(t,n){this.redactor=n,n.selection.save();var r=!1;n.$element.hasClass("upfront_cta")?r=n.$element:r=n.utils.isCurrentOrParent("A"),r?this.render({url:e(r).attr("href"),link:this.guessLinkType(e(r).attr("href"))}):this.render()},close:function(e,t){t.selection.restore()},unlink:function(t){t&&t.preventDefault();if(this.redactor.$element.hasClass("upfront_cta"))this.redactor.$element.attr("href","#");else{var n=this.redactor.selection.getHtml();e.parseHTML(n).length>1?this.redactor.insert.html(n,!0):this.redactor.link.unlink()}},link:function(t,n){this.redactor.selection.restore();if(t)if(this.redactor.$element.hasClass("upfront_cta"))this.redactor.$element.attr("href",t);else{var r=this.redactor.selection.getHtml(),i=this.redactor.utils.isCurrentOrParent("A");i?e(i).attr("href",t).attr("rel",n):this.redactor.link.set(r,t)}},bindEvents:function(){this.listenTo(this.linkPanel,"link:ok",function(e){e.type=="unlink"?this.unlink():this.link(e.url,e.type),this.closeToolbar()}),this.listenTo(this.linkPanel,"link:postselector",this.disableEditorStop),this.listenTo(this.linkPanel,"link:postselected",function(e){this.enableEditorStop(),this.link(e.url,e.type)})},guessLinkType:function(t){return e.trim(t)?t.length&&t[0]=="#"?t.indexOf("#ltb-")>-1?"lightbox":"anchor":t.substring(0,location.origin.length)==location.origin?"entry":"external":"unlink"}})}},i.upfrontColor=function(){return{init:function(){this.opts.buttonsCustom.upfrontColor={title:"Color",panel:this.upfrontColor.panel}},panel:r.extend({current_color:!1,current_bg:!1,events:{open:"open"},init:function(){this.listenTo(n,"ueditor:air:show",this.on_air_show)},on_air_show:function(e){this.redactor.selection.save(),this.updateIcon()},close:function(e,t){t.selection.restore()},setCurrentColors:function(){var t=this.redactor.selection.getCurrent();t=e(t).prop("tagName")?t:e(t).parent();if(t&&(["SPAN","DIV","INLINE"].indexOf(e(t).prop("tagName"))!==-1||e(t).hasClass(".upfront_theme_colors"))){var n=tinycolor(e(t).css("background-color"));this.current_color=e(t).css("color"),n.getAlpha()>0&&(this.current_bg=e(t).css("background-color"))}else this.current_color=this.current_bg=!1},open:function(e,t){this.updateIcon(),this.redactor.selection.save();var n=this,r=new Upfront.Views.Editor.Field.Color({spectrum:{flat:!0,showAlpha:!0,appendTo:"parent",showPalette:!0,localStorageKey:"spectrum.recent_colors",maxSelectionSize:10,preferredFormat:"hex",chooseText:"Ok",showInput:!0,allowEmpty:!0,change:function(e){n.current_color=e},move:function(e){n.current_color=e}}}),i=new Upfront.Views.Editor.Field.Color({blank_alpha:0,spectrum:{flat:!0,showAlpha:!0,appendTo:"parent",showPalette:!0,localStorageKey:"spectrum.recent_bgs",maxSelectionSize:10,preferredFormat:"hex",chooseText:"Ok",showInput:!0,allowEmpty:!0,change:function(e){n.current_bg=e},move:function(e){n.current_bg=e}}});r.render(),this.$("#tabforeground-content").html(r.el),i.render(),this.$("#tabbackground-content").html(i.el);if(this.current_color){var s=tinycolor(n.current_color);r.$(".upfront-field-color").spectrum("option","color",n.current_color),r.$(".upfront-field-color").spectrum("set",s),r.$(".sp-input").css({"border-left-color":n.current_color}),r.render_sidebar_rgba(s.toRgb()),r.update_input_val(s.toHexString())}else{var s=tinycolor("#000000");r.$(".upfront-field-color").spectrum("option","color","#000000"),r.$(".upfront-field-color").spectrum("set",s),i.$(".sp-input").css({"border-left-color":"#000000"}),r.render_sidebar_rgba(s.toRgb()),r.update_input_val(s.toHexString())}if(this.current_bg){var s=tinycolor(n.current_bg);i.$(".upfront-field-color").spectrum("option","color",n.current_bg),i.$(".upfront-field-color").spectrum("set",s),i.$(".sp-input").css({"border-left-color":n.current_bg}),i.render_sidebar_rgba(s.toRgb()),i.update_input_val(s.toHexString())}else{var s=tinycolor("rgba(0, 0, 0, 0)");i.$(".upfront-field-color").spectrum("option","color","rgba(0, 0, 0, 0)"),i.$(".upfront-field-color").spectrum("set",s),i.$(".sp-input").css({"border-left-color":"rgba(0, 0, 0, 0)"}),i.render_sidebar_rgba(s.toRgb()),i.update_input_val(s.toHexString())}this.$(".sp-choose").on("click",function(e){e.preventDefault(),n.updateColors(),n.closePanel(),n.closeToolbar(),n.redactor.dropdown.hideAll()})},render:function(){var t=e('<li id="tabforeground" class="active">').html("Text Color"),n=e('<li id="tabbackground">').html("Text Background"),r=e('<ul class="tablist">').append(t).append(n),i=e('<ul class="tabs">').append(e('<li id="tabforeground-content" class="active">').html('<input class="foreground" type="text">')).append(e('<li id="tabbackground-content">').html('<input class="background" type="text">')),s=this.redactor,o=this;r.children("li").on("click",function(t){t.preventDefault(),t.stopPropagation(),r.children("li").removeClass("active"),e(this).addClass("active"),i.children("li").removeClass("active"),i.children("li#"+e(this).attr("id")+"-content").addClass("active"),o.$("input.foreground").spectrum("option","color",typeof o.current_color=="object"?o.current_color.toRgbString():o.current_color),o.$("input.background").spectrum("option","color",typeof o.current_bg=="object"?o.current_bg.toRgbString():o.current_bg)}),this.$el.html(r).append(i)},updateIcon:function(){var e=this;e.setCurrentColors();if(e.current_bg){var t=tinycolor(e.current_bg);t.getAlpha()===0?this.redactor.$toolbar.find(".re-icon.re-upfrontColor").addClass("transparent").css("border-color",""):this.redactor.$toolbar.find(".re-icon.re-upfrontColor").removeClass("transparent").css("border-color",t.toRgbString())}else this.redactor.$toolbar.find(".re-icon.re-upfrontColor").addClass("transparent").css("border-color","");e.current_color?this.redactor.$toolbar.find(".re-icon.re-upfrontColor").css("color",e.current_color):this.redactor.$toolbar.find(".re-icon.re-upfrontColor").css("color","")},updateColors:function(){this.redactor.buffer.set(),this.redactor.selection.save();var t=this,n=t.redactor.selection.getText(),r="color",i="color",s=function(e){t.redactor.inline.format("div","class",e)},o=function(e,n){t.redactor.inline.format("div","style",e+": "+n+";")},u=function(e){t.redactor.inline.removeStyleRule(e)};if(t.current_bg&&typeof t.current_bg=="object"){var a=Upfront.Views.Theme_Colors.colors.get_css_class(t.current_bg.toHexString(),!0);u("background-color"),a?(s(a),r="theme_color"):o("background-color",t.current_bg.toRgbString())}if(t.current_color&&typeof t.current_color=="object"){var f=Upfront.Views.Theme_Colors.colors.get_css_class(t.current_color.toHexString());u("color"),f?s(f):o("color",t.current_color.toRgbString())}var l=this.redactor.$editor;e(l.find("[class^='upfront_theme_bg_color_']")).parents("[class^='upfront_theme_bg_color_']").each(function(){var t=e(this);t.contents().unwrap()}),e(l.find("[class^='upfront_theme_color_']")).parents("[class^='upfront_theme_color_']").each(function(){var t=e(this);t.contents().unwrap()}),t.updateIcon(),t.redactor.selection.restore()}})}},i.upfrontFormatting=function(){return{init:function(){var t=this,r={},i={p:"P",h1:"H1",h2:"H2",h3:"H3",h4:"H4",h5:"H5",h6:"H6",pre:"&lt;/&gt;",blockquote:'"'};e.each(i,function(e,n){r[e]={title:n,func:t.upfrontFormatting.applyTag}});if(e.inArray("upfrontFormatting",this.opts.airButtons)!==-1){var s=this.button.add("upfrontFormatting","Formatting");this.button.addDropdown(s,r)}n.on("ueditor:dropdownShow",function(){var n=e(t.selection.getBlock()).length?e(t.selection.getBlock())[0].tagName:!1;n&&(n=n.toLowerCase(),e(".redactor-dropdown-box-upfrontFormatting a").removeClass("active"),e(".redactor-dropdown-"+n).addClass("active"))})},applyTag:function(t){this.selection.restore(!0,!0),this.buffer.set(),this.$editor.focus();var n=e(this.selection.getCurrent()).css("text-align");this.block.format(t),this.dropdown.hideAll()}}},i.blockquote=function(){return{init:function(){var t=this;this.opts.stateButtons.blockquote={title:"Set a quote",defaultState:"noquote",states:{noquote:{iconClass:"ueditor-noquote",isActive:function(e){var t=e.blockquote.getQuote();return!t},callback:function(e,n,r){t.utils.isCurrentOrParent(["BLOCKQUOTE"])&&t.utils.replaceToTag(t.selection.getBlock(),"p")}},quote:{iconClass:"ueditor-quote",isActive:function(t){var n=t.blockquote.getQuote();return n&&!e(n).hasClass("upfront-quote-alternative")},callback:function(e,n,r){t.block.formatBlockquote("blockquote")}},alternative:{iconClass:"ueditor-quote-alternative",isActive:function(t){var n=t.blockquote.getQuote();return n&&e(n).hasClass("upfront-quote-alternative")},callback:function(e,n,r){t.blockquote.getQuote().addClass("upfront-quote-alternative")}}}}},getQuote:function(){var t=e(this.selection.getParent());return t.prop("tagName")=="BLOCKQUOTE"?t:(t=t.closest("blockquote"),t.closest(".redactor-box").length?t:!1)}}},window.RedactorPlugins=i,{UeditorEvents:n}})})(jQuery);