!function(t){define(["scripts/redactor/ueditor-insert","scripts/redactor/ueditor-image-insert-base","text!scripts/redactor/ueditor-templates.html","scripts/redactor/ueditor-insert-utils"],function(e,i,n,s){var o=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.ueditor:Upfront.mainData.l10n.global.ueditor,a=i.ImageInsertBase.extend({className:"ueditor-insert upfront-inserted_image-wrapper ueditor-insert-variant ueditor-post-image-insert",tpl:_.template(t(n).find("#post-image-insert-tpl").html()),shortcode_tpl:_.template(t(n).find("#post-image-insert-shortcode-tpl").html().replace(/\s+/g," ")),init:function(t){return this.$editor=t.$editor,this.controlsData=[{id:"style",type:"dialog",icon:"style",tooltip:o.style,view:this.getStyleView()},{id:"change_image",type:"simple",icon:"change_image",tooltip:o.change_image},{id:"link",type:"dialog",icon:"link",tooltip:o.link_image,view:this.getLinkView()},{id:"toggle_caption",type:"simple",icon:"caption",tooltip:o.toggle_caption,active:_.bind(this.get_caption_state,this)}],this.createControls(),t.start?this.start(t.start):void 0},start:function(t){var e=this.getImageData(t);return e.id=this.data.id,e.style=this.data.get("style")||Upfront.Content.ImageVariants.first().toJSON(),e.variant_id=e.style.vid,this.data.clear({silent:!0}),this.data.set(e,{silent:!0}),this.set_selected_style(),this.render(),this},set_selected_style:function(){_.findWhere(this.controlsData,{id:"style"}).view.data.set("selected",this.data.get("variant_id"))},render:function(){var t=this.prepare_data();this.$el.html(this.tpl(t)),this.$shortcode_el=this.$(".post-images-shortcode"),this.render_shortcode(t),this.createControls(),this.controls.render();var e=this.$(".ueditor-insert-variant-group");e.append(this.controls.$el),this.make_caption_editable(),this.updateControlsPosition(),e.append('<a href="#" contenteditable="false" class="upfront-icon-button upfront-icon-button-delete ueditor-insert-remove"></a>')},prepare_data:function(){var e=_.extend({},this.defaultData,this.data.toJSON()),i=e.style;if(i){e.style.label_id=e.style.label&&""!==e.style.label.trim()?"ueditor-image-style-"+e.style.label.toLowerCase().trim().replace(" ","-"):e.style.vid,e.image=this.get_proper_image(),"show_larger_image"==e.linkType&&(e.linkUrl=e.image.src),0==e.show_caption&&(e.style.image.width_cls=Upfront.Settings.LayoutEditor.Grid["class"]+24);var n=(this.$el.find(".ueditor-insert-variant-group"),Upfront.Behaviors.GridEditor),s=t(".upfront-content-marker-contents"),o=parseFloat(t(".upfront-content-marker-contents>*").css("padding-left"))/n.col_size,a=parseFloat(t(".upfront-content-marker-contents>*").css("padding-right"))/n.col_size,r=Upfront.Util.grid.width_to_col(s.width(),!0),l=r-o-a,d=t(".upfront-content-marker-contents>*").width()/l,p=this.$editor.closest(".upfront-object"),c=parseInt(p.css("padding-left"),10),g=parseInt(p.css("padding-right"),10);return this.$editor.hasClass("upfront-indented_content")&&(s=this.$editor,o=parseFloat(s.css("padding-left"))/n.col_size,a=parseFloat(s.css("padding-right"))/n.col_size,r=Upfront.Util.grid.width_to_col(s.width(),!0),l=r-o-a,d=n.col_size,this.$el.attr("style","margin-left: "+(o*d*-1-c)+"px; margin-right: "+(a*d*-1-g)+"px;")),o=o?parseInt(o,10):0,a=a?parseInt(a,10):0,i&&i.group&&i.group["float"]&&("left"==i.group["float"]&&o>0?(e.style.group.marginLeft=(o-Math.abs(i.group.margin_left))*d,e.style.group.marginRight=0):"right"==i.group["float"]&&a>0?(e.style.group.marginRight=(a-Math.abs(i.group.margin_right))*d,e.style.group.marginLeft=0):"none"==i.group["float"]&&o>0&&(e.style.group.marginLeft=(o-Math.abs(i.group.margin_left)+Math.abs(i.group.left))*d,e.style.group.marginRight=0)),e}},control_events:function(){this.listenTo(this.controls,"control:ok:style",function(t,e){if(t._style){var i=t._style.toJSON();this.data.set("variant_id",i.vid),this.data.set("style",i),t.data.set("selected",i.vid)}e.close()})}}),r=i.ImageInsertBase.extend({className:"ueditor-insert upfront-inserted_image-wrapper upfront-wp-inserted_image-wrapper",tpl:_.template(t(n).find("#post-image-insert-wp-tpl").html()),shortcode_tpl:_.template(t(n).find("#post-image-insert-shortcode-wp-tpl").html()),generate_new_id:function(){return"wpinsert-"+ ++Upfront.data.ueditor.insertCount},init:function(t){return this.$editor=t.$editor,t.start?this.start(t.start):void 0},prepare_controls:function(){this.controlsData=[{id:"wp_style",type:"dialog",icon:_.bind(this.get_style_icon,this),tooltip:"Style",view:this.getStyleView(),hideOkButton:!0},{id:"change_image",type:"simple",icon:"change_image",tooltip:o.change_image},{id:"link",type:"dialog",icon:"link",tooltip:"Link image",view:this.getLinkView()},{id:"toggle_caption",type:"simple",icon:"caption",tooltip:"Toggle Caption",active:_.bind(this.get_caption_state,this)}]},start:function(t){var e=this,i=e.getImageData(t);return i.id=e.data.id,i.variant_id=e.data.get("variant_id")||"alignnone",e.data.clear({silent:!0}),e.data.set(i,{silent:!0}),this.prepare_controls(),this.createControls(),this.render(),this},getImageData:function(t){if(!t)return!1;var e=t.at(0).toJSON(),i=this.getSelectedImage(e),n=_.extend({},this.wp_defaults,{attachment_id:e.ID,caption:e.post_excerpt?e.post_excerpt:"",link_url:"",image:i,style:{caption:{show:!0},wrapper:{alignment:"alignnone",width:i.width},image:{size_class:"size-"+i.selected_size}}});return n},render:function(){var t=this.data.toJSON();t.variant_id&&(t.style.wrapper.alignment=t.variant_id),this.$el.html(this.tpl(t)),this.$shortcode_el=this.$(".post-images-shortcode-wp"),this.render_shortcode(t),this.prepare_controls(),this.createControls(),this.controls.render();var e=this.$(".wp-caption");e.append(this.controls.$el),this.make_caption_editable(),this.updateControlsPosition(),e.append('<a href="#" contenteditable="false" class="upfront-icon-button upfront-icon-button-delete ueditor-insert-remove"></a>')},getStyleView:function(){if(this.styleView)return this.styleView;var t=new s.WP_PostImageStylesView({model:this.data});return this.styleView=t,t},get_caption_state:function(){return this.data.get("style").caption.show?0:1},get_style_icon:function(){var t="wp-style";return this.data&&this.data.get("style")&&(t+=" "+this.data.get("style").wrapper.alignment),t},controlEvents:function(){this.listenTo(this.controls,"control:click:toggle_caption",function(t){var e=1,i=Upfront.Util.clone(this.data.toJSON().style);this.get_caption_state()||(e=0),i.caption.show=e,this.data.set("style",i)}),this.listenTo(this.controls,"control:ok:link",function(t,e){var i=t.$("input[type=radio]:checked").val()||"do_nothing",n="do_nothing"===i?"":t.$("input[type=text]").val();"show_larger_image"==i&&(n=this.data.get("image").src),this.data.set("link_url",n),e.close()}),this.listenTo(this.controls,"control:click:change_image",this.change_image)},get_url_type:function(t,e){var i="",n=document.createElement("a");return n.href=t,n.origin!=window.location.origin&&(i="external"),n.origin==window.location.origin&&e!=t&&(i="post"),n.origin==window.location.origin&&e==t&&(i="show_larger_image"),i}});return{PostImageInsert:a,WP_PostImageInsert:r}})}(jQuery);