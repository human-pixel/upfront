(function(e){define(["scripts/redactor/ueditor-insert","scripts/redactor/ueditor-insert-utils","scripts/redactor/ueditor-image-insert-base","text!scripts/redactor/ueditor-templates.html"],function(t,n,r,i){var s=r.ImageInsertBase.extend({className:"ueditor-insert upfront-inserted_image-wrapper upfront-inserted_image-basic-wrapper",create_controlls:function(e){this.controlsData=[{id:"link",type:"dialog",icon:"link",tooltip:"Link image",view:this.getLinkView()},{id:"toggle_caption",type:"simple",icon:"caption",tooltip:"Toggle Caption",active:_.bind(this.get_caption_state,this)}],this.allow_alignment(e)&&this.controlsData.unshift({id:"style",type:"dialog",icon:"style",tooltip:"Alignment",view:this.getStyleView()}),this.createControls()},start:function(e){var t=this,n=Upfront.Media.Manager.open({multiple_selection:!1});return n.done(function(n,r){var i=t.getImageData(r);i.id=t.data.id,t.data.clear({silent:!0}),i.style=t.defaultData.style,i.variant_id="basic-image",t.$editor=e.closest(".redactor-box"),t.data.set(i)}),n},render:function(){var t=_.extend({},this.defaultData,this.data.toJSON()),n=t.style,r=this.data.get("alignment");if(!n)return;t.style.label_id="ueditor-image-style-center",r&&(t.style.label_id="ueditor-image-style-"+r.vid,t.style.group.float=r.vid),t.image=this.get_proper_image(),t.style.group.width_cls=this.get_group_width_cls(t.image),t.show_caption==0&&(t.style.image.width_cls=Upfront.Settings.LayoutEditor.Grid.class+24);var i=this.$el.find(".ueditor-insert-variant-group"),s=Upfront.Behaviors.GridEditor,o=e(".upfront-content-marker-contents"),u=parseFloat(e(".upfront-content-marker-contents>*").css("padding-left"))/s.col_size,a=parseFloat(e(".upfront-content-marker-contents>*").css("padding-right"))/s.col_size,f=Upfront.Util.grid.width_to_col(o.width(),!0),l=f-u-a,c=e(".upfront-content-marker-contents>*").width()/l;u=u?parseInt(u):0,a=a?parseInt(a):0,n&&n.group&&n.group.float&&(n.group.float=="left"&&u>0?(t.style.group.marginLeft=(u-Math.abs(n.group.margin_left))*c,t.style.group.marginRight=0):n.group.float=="right"&&a>0?(t.style.group.marginRight=(a-Math.abs(n.group.margin_right))*c,t.style.group.marginLeft=0):n.group.float=="none"&&u>0&&(t.style.group.marginLeft=(u-Math.abs(n.group.margin_left)+Math.abs(n.group.left))*c,t.style.group.marginRight=0)),this.$el.html(this.tpl(t)),this.create_controlls(t.style.group.width_cls),this.controls.render(),this.$(".ueditor-insert-variant-group").append(this.controls.$el),this.make_caption_editable(),this.updateControlsPosition(),this.$(".ueditor-insert-variant-group").append('<a href="#" contenteditable="false" class="upfront-icon-button upfront-icon-button-delete ueditor-insert-remove"></a>')},allow_alignment:function(e){if(typeof e=="undefined")return!1;var t=parseInt(e.replace("c",""),10),n=Upfront.Util.grid.width_to_col(this.$editor.width());return t+2<=n},control_events:function(){var e=this;this.listenTo(this.controls,"control:ok:style",function(e,t){e._style&&(this.data.set("variant_id",e.variant_id),this.data.set("alignment",e._style),e.data.set("selected",e.variant_id)),t.close()})},get_group_width_cls:function(e){var t=Upfront.Util.grid.width_to_col(e.width),n=Upfront.Util.grid.width_to_col(this.$editor.width());return t+1<=n?Upfront.Settings.LayoutEditor.Grid.class+t:Upfront.Settings.LayoutEditor.Grid.class+n},get_proper_image:function(){var e=this.data.toJSON(),t=e.imageFull,n=Upfront.Settings.LayoutEditor.Grid,r=Upfront.Util.grid.width_to_col(this.$editor.width());return _.isEmpty(e.selectedImage.src)?t:e.selectedImage},importFromImage:function(t){var n=_.extend({},this.defaultData),r={src:t.attr("src"),width:t.width(),height:t.height()},i=e("<a>").attr("href",r.src)[0],o=this.calculateRealSize(r.src),u=t.closest(".ueditor-insert-variant-group"),a=u.attr("class"),f=u.find(".wp-caption-text"),l=f.attr("class"),c=u.find(".uinsert-image-wrapper"),h=c.attr("class"),p=1;i.origin!=window.location.origin&&(n.isLocal=0),n.imageThumb=r,n.imageFull={width:o.width,height:o.height,src:r.src};var d=t.parent();d.is("a")&&(n.linkUrl=d.attr("href"),n.linkType="external");var v=t.attr("class");v?(v=v.match(/wp-image-(\d+)/),v?n.attachmentId=v[1]:n.attachmentId=!1):n.attachmentId=!1,n.title=t.attr("title"),_.isEmpty(f.text())||(n.caption=f.html()),p=f.prev(c).length?1:0,n.show_caption=f.length,u.length?(n.style={caption:{order:1,height:f.css("minHeight")?f.css("minHeight").replace("px",""):f.height(),width_cls:Upfront.Util.grid.derive_column_class(l),left_cls:Upfront.Util.grid.derive_marginleft_class(l),top_cls:Upfront.Util.grid.derive_margintop_class(l),show:f.length},group:{"float":u.css("float"),width_cls:Upfront.Util.grid.derive_column_class(a),left_cls:Upfront.Util.grid.derive_marginleft_class(a),height:u&&u.css("minHeight")?u.css("minHeight").replace("px",""):r.height+f.height(),marginRight:0,marginLeft:0},image:{width_cls:Upfront.Util.grid.derive_column_class(h),left_cls:Upfront.Util.grid.derive_marginleft_class(h),top_cls:Upfront.Util.grid.derive_margintop_class(h),src:"",height:0}},n.variant_id=u.data("variant"),n.variant_id&&(n.alignment=BasicImageVariants.findWhere({vid:u.data("variant")}))):(n.alignment=BasicImageVariants.first(),n.variant_id=n.alignment.vid);var m=new s({data:n});return m.render(),t.replaceWith(m.$el),m},getStyleView:function(){if(this.styleView)return this.styleView;var e=new n.ImageStylesView(this.data);return this.styleView=e,e}});return{ImageInsert:s}})})(jQuery);